0001   0000             ; Projeto MSX SD Mapper
0002   0000             
0003   0000             ; Copyright (c) 2014 Fabio Belavenuto
0004   0000             ; Enhanced by FRS
0005   0000             
0006   0000             ; This documentation describes Open Hardware and is licensed under the CERN OHL v. 1.1.
0007   0000             ; You may redistribute and modify this documentation under the terms of the
0008   0000             ; CERN OHL v.1.1. (http://ohwr.org/cernohl). This documentation is distributed
0009   0000             ; WITHOUT ANY EXPRESS OR IMPLIED WARRANTY, INCLUDING OF MERCHANTABILITY,
0010   0000             ; SATISFACTORY QUALITY AND FITNESS FOR A PARTICULAR PURPOSE.
0011   0000             ; Please see the CERN OHL v.1.1 for applicable conditions
0012   0000             
0013   0000             ; Technical info:
0014   0000             ; 4000h~47FFh	: SPI data transfer window (read/write)
0015   0000             ; 4800h		: Interface status and card select register (read/write)
0016   0000             ;	<read>
0017   0000             ;	b0	: 0=SD card present on slot-0
0018   0000             ;	b1	: 0=SD card present on slot-1
0019   0000             ;	b2	: 0=Write protecton enabled for SD card slot-0
0020   0000             ;	b3	: 0=Write protecton enabled for SD card slot-1
0021   0000             ;	b4	: SW0 status. 0=RAM enabled, 1=RAM disabled
0022   0000             ;	b5	: SW1 status. 0=RAM mode: MegaRAM, 1=RAM mode: Memory Mapper
0023   0000             ;	b6	: Reserved for future use. Must be masked out from readings.
0024   0000             ;	b7	: 1=SPI transfer busy. 0=No ongoing SPI transfer
0025   0000             ;	<write>
0026   0000             ;	b0	: SD card slot-0 chip-select (0=selected)
0027   0000             ;	b1	: SD card slot-1 chip-select (0=selected)
0028   0000             
0029   0000             ; 6001h		: Mode configuration register (write only)
0030   0000             ;	b0	: 0=ROM mode, SPI interface disabled, 1=SPI interface enabled
0031   0000             
0032   0000             
0033   0000             
0034   0000             	output	"driver.bin"
0035   0000             
0036   0000             ;-----------------------------------------------------------------------------
0037   0000             ;
0038   0000             ; Driver configuration constants
0039   0000             ;
0040   0000             
0041   0000             ;Driver type:
0042   0000             ;   0 for drive-based
0043   0000             ;   1 for device-based
0044   0000             
0045   0000             DRV_TYPE	equ	1
0046   0000             
0047   0000             ;Hot-plug devices support (device-based drivers only):
0048   0000             ;   0 for no hot-plug support
0049   0000             ;   1 for hot-plug support
0050   0000             
0051   0000             DRV_HOTPLUG	equ	1
0052   0000             
0053   0000             DEBUG	equ	0	;Set to 1 for debugging, 0 to normal operation
0054   0000             
0055   0000             ;Driver version
0056   0000             
0057   0000             VER_MAIN	equ	1
0058   0000             VER_SEC		equ	0
0059   0000             VER_REV		equ	6
0060   0000             
0061   0000             ;-----------------------------------------------------------------------------
0062   0000             ; SPI addresses. Check the Technical info above for the bit contents
0063   0000             
0064   0000             CHAVEIASPI	= $6001 ; Mode config register
0065   0000             PORTCFG		= $4800	; Interface status and card select register 
0066   0000             PORTSPI		= $4000	; SPI data port
0067   0000             
0068   0000             ; Comandos SPI:
0069   0000             CMD0	= 0  | $40
0070   0000             CMD1	= 1  | $40
0071   0000             CMD8	= 8  | $40
0072   0000             CMD9	= 9  | $40
0073   0000             CMD10	= 10 | $40
0074   0000             CMD12	= 12 | $40
0075   0000             CMD16	= 16 | $40
0076   0000             CMD17	= 17 | $40
0077   0000             CMD18	= 18 | $40
0078   0000             CMD24	= 24 | $40
0079   0000             CMD25	= 25 | $40
0080   0000             CMD55	= 55 | $40
0081   0000             CMD58	= 58 | $40
0082   0000             ACMD23	= 23 | $40
0083   0000             ACMD41	= 41 | $40
0084   0000             
0085   0000             ; Work area variables 
0086   0000              STRUCT WRKAREA
0087   0000~            BCSD 		ds 16	; Card Specific Data
0088   0000~            BCID1		ds 16	; Card-ID of card1
0089   0000~            BCID2		ds 16	; Card-ID of card2
0090   0000~            NUMSD		db 	; Currently selected card: 1 or 2 
0091   0000~            CARDFLAGS	db 	; Flags that indicate card-change or card error 
0092   0000~            NUMBLOCKS	db 	; Number of blocks in multi-block operations 
0093   0000~            BLOCKS1		ds 3	; 3 bytes. Size of card1, in blocks.
0094   0000~            BLOCKS2		ds 3	; 3 bytes. Size of card2, in blocks.
0095   0000~            TEMP		db	; Temporary data
0096   0000~            TRLDIR		ds 8	; R800 data transfer helper 
0097   0000              ENDS
0098   0000             
0099   0000             
0100   0000             ;-----------------------------------------------------------------------------
0101   0000             ;
0102   0000             ; Standard BIOS and work area entries
0103   0000             INITXT	= $006C		; Inicializa SCREEN0
0104   0000             CHSNS	= $009C		; Sense keyboard buffer for character
0105   0000             CHGET	= $009F		; Get character from keyboard buffer
0106   0000             CHPUT	= $00A2		; A=char
0107   0000             CLS	= $00C3		; Chamar com A=0
0108   0000             ERAFNK	= $00CC		; Erase function key display
0109   0000             SNSMAT	= $0141		; Read row of keyboard matrix
0110   0000             KILBUF	= $0156		; Clear keyboard buffer
0111   0000             EXTROM	= $015F
0112   0000             
0113   0000             ; subROM functions
0114   0000             SDFSCR	= $0185
0115   0000             REDCLK	= $01F5
0116   0000             
0117   0000             
0118   0000             ; System variables
0119   0000             MSXVER	= $002D
0120   0000             LINL40	= $F3AE		; Width
0121   0000             LINLEN	= $F3B0
0122   0000             INTFLG	= $FC9B
0123   0000             SCRMOD	= $FCAF
0124   0000             
0125   0000             
0126   0000             ;-----------------------------------------------------------------------------
0127   0000             
0128   0000             
0129   0000             	org		$4000
0130   4000             
0131   4000 FF          	ds		256, $FF		; 256 dummy bytes
0132   4100             
0133   4100             DRV_START: 
0134   4100             
0135   4100             ;-----------------------------------------------------------------------------
0136   4100             ;
0137   4100             ; Miscellaneous constants
0138   4100             ;
0139   4100             
0140   4100             ;This is a 2 byte buffer to store the address of code to be executed.
0141   4100             ;It is used by some of the kernel page 0 routines.
0142   4100             
0143   4100             CODE_ADD: 	equ	0F84Ch
0144   4100             
0145   4100             
0146   4100             ;-----------------------------------------------------------------------------
0147   4100             ;
0148   4100             ; Error codes for DEV_RW
0149   4100             ;
0150   4100             
0151   4100             ENCOMP	equ	0FFh
0152   4100             EWRERR	equ	0FEh
0153   4100             EDISK	equ	0FDh
0154   4100             ENRDY	equ	0FCh
0155   4100             EDATA	equ	0FAh
0156   4100             ERNF	equ	0F9h
0157   4100             EWPROT	equ	0F8h
0158   4100             EUFORM	equ	0F7h
0159   4100             ESEEK	equ	0F3h
0160   4100             EIFORM	equ	0F0h
0161   4100             EIDEVL	equ	0B5h
0162   4100             EIPARM	equ	08Bh
0163   4100             
0164   4100             ;-----------------------------------------------------------------------------
0165   4100             ;
0166   4100             ; Routines and information available on kernel page 0
0167   4100             ;
0168   4100             
0169   4100             ;* Get in A the current slot for page 1. Corrupts F.
0170   4100             ;  Must be called by using CALBNK to bank 0:
0171   4100             ;    xor a
0172   4100             ;    ld ix,GSLOT1
0173   4100             ;    call CALBNK
0174   4100             
0175   4100             GSLOT1	equ	402Dh
0176   4100             
0177   4100             
0178   4100             ;* This routine reads a byte from another bank.
0179   4100             ;  Must be called by using CALBNK to the desired bank,
0180   4100             ;  passing the address to be read in HL:
0181   4100             ;    ld a,<bank number>
0182   4100             ;    ld hl,<byte address>
0183   4100             ;    ld ix,RDBANK
0184   4100             ;    call CALBNK
0185   4100             
0186   4100             RDBANK	equ	403Ch
0187   4100             
0188   4100             
0189   4100             ;* This routine temporarily switches kernel main bank
0190   4100             ;  (usually bank 0, but will be 3 when running in MSX-DOS 1 mode),
0191   4100             ;  then invokes the routine whose address is at (CODE_ADD).
0192   4100             ;  It is necessary to use this routine to invoke CALBAS
0193   4100             ;  (so that kernel bank is correct in case of BASIC error)
0194   4100             ;  and to invoke DOS functions via F37Dh hook.
0195   4100             ;
0196   4100             ;  Input:  Address of code to invoke in (CODE_ADD).
0197   4100             ;          AF, BC, DE, HL, IX, IY passed to the called routine.
0198   4100             ;  Output: AF, BC, DE, HL, IX, IY returned from the called routine.
0199   4100             
0200   4100             CALLB0	equ	403Fh
0201   4100             
0202   4100             
0203   4100             ;* Call a routine in another bank.
0204   4100             ;  Must be used if the driver spawns across more than one bank.
0205   4100             ;
0206   4100             ;  Input:  A = bank number
0207   4100             ;          IX = routine address
0208   4100             ;          AF' = AF for the routine
0209   4100             ;          HL' = Ix for the routine
0210   4100             ;          BC, DE, HL, IY = input for the routine
0211   4100             ;  Output: AF, BC, DE, HL, IX, IY returned from the called routine.
0212   4100             
0213   4100             CALBNK	equ	4042h
0214   4100             
0215   4100             
0216   4100             ;* Get in IX the address of the SLTWRK entry for the slot passed in A,
0217   4100             ;  which will in turn contain a pointer to the allocated page 3
0218   4100             ;  work area for that slot (0 if no work area was allocated).
0219   4100             ;  If A=0, then it uses the slot currently switched in page 1.
0220   4100             ;  Returns A=current slot for page 1, if A=0 was passed.
0221   4100             ;  Corrupts F.
0222   4100             ;  Must be called by using CALBNK to bank 0:
0223   4100             ;    ld a,<slot number> (xor a for current page 1 slot)
0224   4100             ;    ex af,af'
0225   4100             ;    xor a
0226   4100             ;    ld ix,GWORK
0227   4100             ;    call CALBNK
0228   4100             
0229   4100             GWORK	equ	4045h
0230   4100             
0231   4100             
0232   4100             ;* This address contains one byte that tells how many banks
0233   4100             ;  form the Nextor kernel (or alternatively, the first bank
0234   4100             ;  number of the driver).
0235   4100             
0236   4100             K_SIZE	equ	40FEh
0237   4100             
0238   4100             
0239   4100             ;* This address contains one byte with the current bank number.
0240   4100             
0241   4100             CUR_BANK	equ	40FFh
0242   4100             
0243   4100             
0244   4100             ;-----------------------------------------------------------------------------
0245   4100             ;
0246   4100             ; Built-in format choice strings
0247   4100             ;
0248   4100             
0249   4100             NULL_MSG  equ     781Fh	;Null string (disk can't be formatted)
0250   4100             SING_DBL  equ     7820h ;"1-Single side / 2-Double side"
0251   4100             
0252   4100             
0253   4100             ;-----------------------------------------------------------------------------
0254   4100             ;
0255   4100             ; Driver signature
0256   4100             ;
0257   4100             	db	"NEXTOR_DRIVER",0
0257   4100 4E4558544F525F44524956455200
0258   410E             
0259   410E             
0260   410E             ;-----------------------------------------------------------------------------
0261   410E             ;
0262   410E             ; Driver flags:
0263   410E             ;    bit 0: 0 for drive-based, 1 for device-based
0264   410E             ;    bit 1: 1 for hot-plug devices supported (device-based drivers only)
0265   410E             
0266   410E 03          	db 1+(2*DRV_HOTPLUG)
0267   410F             
0268   410F             ;-----------------------------------------------------------------------------
0269   410F             ;
0270   410F             ; Reserved byte
0271   410F             ;
0272   410F 00          	db	0
0273   4110             
0274   4110             ;-----------------------------------------------------------------------------
0275   4110             ;
0276   4110             ; Driver name
0277   4110             ;
0278   4110             
0279   4110             DRV_NAME: 
0280   4110             	db	"SDMapper Driver"
0280   4110 53444D617070657220447269766572
0281   411F 20          	ds	32-($-DRV_NAME)," "
0282   4130             
0283   4130             
0284   4130             ;-----------------------------------------------------------------------------
0285   4130             ;
0286   4130             ; Jump table for the driver public routines
0287   4130             ;
0288   4130             
0289   4130             	; These routines are mandatory for all drivers
0290   4130                     ; (but probably you need to implement only DRV_INIT)
0291   4130             
0292   4130 C3 6C 41    	jp	DRV_TIMI
0293   4133 C3 DD 48    	jp	DRV_VERSION
0294   4136 C3 00 48    	jp	DRV_INIT
0295   4139 C3 E4 48    	jp	DRV_BASSTAT
0296   413C C3 E6 48    	jp	DRV_BASDEV
0297   413F C3 E8 48    	jp	DRV_EXTBIO
0298   4142 C3 E9 48    	jp	DRV_DIRECT0
0299   4145 C3 E9 48    	jp	DRV_DIRECT1
0300   4148 C3 E9 48    	jp	DRV_DIRECT2
0301   414B C3 E9 48    	jp	DRV_DIRECT3
0302   414E C3 E9 48    	jp	DRV_DIRECT4
0303   4151             
0304   4151 00          	ds	15
0305   4160             
0306   4160             	; These routines are mandatory for device-based drivers
0307   4160             
0308   4160 C3 EA 48    	jp	DEV_RW
0309   4163 C3 7B 49    	jp	DEV_INFO
0310   4166 C3 FE 49    	jp	DEV_STATUS
0311   4169 C3 32 4A    	jp	LUN_INFO
0312   416C             
0313   416C             
0314   416C             ;=====
0315   416C             ;=====  END of data that must be at fixed addresses
0316   416C             ;=====
0317   416C             
0318   416C             
0319   416C             ;-----------------------------------------------------------------------------
0320   416C             ;
0321   416C             ; Timer interrupt routine, it will be called on each timer interrupt
0322   416C             ; (at 50 or 60Hz), but only if DRV_INIT returns Cy=1 on its first execution.
0323   416C             
0324   416C             DRV_TIMI: 
0325   416C C9          	ret
0326   416D             
0327   416D             
0328   416D             ; Skips the interface r/w registers 
0329   416D FF          	ds	$4800-$, $FF
0330   4800             
0331   4800             
0332   4800             ;-----------------------------------------------------------------------------
0333   4800             ;
0334   4800             ; Driver initialization routine, it is called twice:
0335   4800             ;
0336   4800             ; 1) First execution, for information gathering.
0337   4800             ;    Input:
0338   4800             ;      A = 0
0339   4800             ;      B = number of available drives
0340   4800             ;      HL = maximum size of allocatable work area in page 3
0341   4800             ;    Output:
0342   4800             ;      A = number of required drives (for drive-based driver only)
0343   4800             ;      HL = size of required work area in page 3
0344   4800             ;      Cy = 1 if DRV_TIMI must be hooked to the timer interrupt, 0 otherwise
0345   4800             ;
0346   4800             ; 2) Second execution, for work area and hardware initialization.
0347   4800             ;    Input:
0348   4800             ;      A = 1
0349   4800             ;      B = number of allocated drives for this controller
0350   4800             ;
0351   4800             ;    The work area address can be obtained by using GWORK.
0352   4800             ;
0353   4800             ;    If first execution requests more work area than available,
0354   4800             ;    second execution will not be done and DRV_TIMI will not be hooked
0355   4800             ;    to the timer interrupt.
0356   4800             ;
0357   4800             ;    If first execution requests more drives than available,
0358   4800             ;    as many drives as possible will be allocated, and the initialization
0359   4800             ;    procedure will continue the normal way
0360   4800             ;    (for drive-based drivers only. Device-based drivers always
0361   4800             ;     get two allocated drives.)
0362   4800             
0363   4800             DRV_INIT: 
0364   4800 B7          	or	a		; Is this the 1st call? 
0365   4801 20 0F       	jr	nz,.call2
0366   4803             ; 1st call:
0367   4803 21 3A 00    	ld	hl,WRKAREA.TRLDIR ; size of work area are needed for Z80
0368   4806 3A 2D 00    	ld	a,(MSXVER)
0369   4809 FE 03       	cp	3		; MSX Turbo-R?
0370   480B 3F          	ccf
0371   480C D0          	ret	nc		; No, return with Cy off
0372   480D 21 42 00    	ld	hl,WRKAREA	; size of work area are needed for TR
0373   4810 B7          	or	a		; Clear Cy
0374   4811 C9          	ret
0375   4812             
0376   4812             
0377   4812             .call2: 
0378   4812             ; 2nd call: 
0379   4812 CD E0 5F    	call	MYSETSCR		; Set the screen mode
0380   4815 CD 78 4A    	call	pegaWorkArea		; HL=IY=Work area pointer
0381   4818             
0382   4818 11 8E 60    	ld	de,strTitle		; prints the title 
0383   481B CD 9A 5E    	call	printString
0384   481E             
0385   481E CD B9 48    	call	SDMAPPERINIT		; SD-Mapper exclusive init
0386   4821             
0387   4821             .sdhcinit: 	; FBLabs SDHC Interface initialization
0388   4821 AF          	xor	a			; zera flags do cartao
0389   4822 FD 77 31    	ld	(iy+WRKAREA.CARDFLAGS), a
0390   4825             
0391   4825 3E 01       	ld	a, 1			; detectar cartao 1
0392   4827 CD 43 48    	call	.detecta
0393   482A 3E 02       	ld	a, 2			; detectar cartao 2
0394   482C CD 43 48    	call	.detecta
0395   482F 01 00 00    	ld	bc, 0
0396   4832 1E 05       	ld	e, 5
0397   4834 CD 92 5E    	call	modoROM
0398   4837             
0399   4837 CD 6C 60    	call	INSTR800HLP		; Install R800 data copy on workarea
0400   483A             
0401   483A CD 1D 60    	call	INICHKSTOP		; Check if the STOP key was pressed
0402   483D             
0403   483D 11 5B 61    	ld	de, strCrLf
0404   4840 C3 9A 5E    	jp	printString
0405   4843             
0406   4843             .detecta: 
0407   4843 FD 77 30    	ld	(iy+WRKAREA.NUMSD), a		; processo de deteccao dos cartoes
0408   4846 11 5E 61    	ld	de, strCartao
0409   4849 CD 9A 5E    	call	printString
0410   484C FD 7E 30    	ld	a, (iy+WRKAREA.NUMSD)
0411   484F C6 30       	add	'0'
0412   4851 CD A2 00    	call	CHPUT
0413   4854 3E 3A       	ld	a, ':'
0414   4856 CD A2 00    	call	CHPUT
0415   4859 3E 20       	ld	a, ' '
0416   485B CD A2 00    	call	CHPUT
0417   485E FD 4E 30    	ld	c, (iy+WRKAREA.NUMSD)
0418   4861 3A 00 48    	ld	a, (PORTCFG)		; testar se cartao esta inserido
0419   4864 A1          	and	c			; C contem 1 se cartao 1, 2 se cartao 2
0420   4865 28 09       	jr	z,.naoVazio
0421   4867 11 64 61    	ld	de, strVazio		; nao tem cartao no slot
0422   486A CD 9A 5E    	call	printString
0423   486D C3 7E 48    	jp	.marcaErro
0424   4870             .naoVazio: 
0425   4870 CD EF 4A    	call	detectaCartao		; tem cartao no slot, inicializar e detectar
0426   4873 30 0C       	jr	nc,.detectou
0427   4875 CD 30 4C    	call	desabilitaSDs
0428   4878 11 6C 61    	ld	de, strNaoIdentificado
0429   487B CD 9A 5E    	call	printString
0430   487E             .marcaErro: 
0431   487E C3 BC 4A    	jp	marcaErroCartao		; slot vazio ou erro de deteccao, marcar nas flags
0432   4881             .detectou: 
0433   4881 CD C7 4A    	call	calculaCIDoffset	; calculamos em IX a posicao correta do offset CID dependendo do cartao atual
0434   4884 DD 7E 0F    	ld	a,(ix+15)	; pegar byte SDV1 ou SDV2
0435   4887 11 C3 61    	ld	de, strSDV1	; e imprimir
0436   488A B7          	or	a
0437   488B 28 03       	jr	z,.pula1
0438   488D 11 CB 61    	ld	de, strSDV2
0439   4890             .pula1: 
0440   4890 CD 9A 5E    	call	printString
0441   4893 3E 28       	ld	a,'('
0442   4895 CD A2 00    	call	CHPUT
0443   4898 DD 7E 00    	ld	a,(ix)		; pegar byte do fabricante
0444   489B CD E7 5E    	call	printDecToAscii	; Imprimir Manufacturer ID
0445   489E 3E 29       	ld	a,')'
0446   48A0 CD A2 00    	call	CHPUT
0447   48A3 3E 20       	ld	a,' '
0448   48A5 CD A2 00    	call	CHPUT
0449   48A8 DD 7E 00    	ld	a,(ix)		; pegar byte do fabricante
0450   48AB CD 13 5F    	call	pegaFabricante	; achar nome do fabricante
0451   48AE EB          	ex	de,hl
0452   48AF CD 9A 5E    	call	printString	; e imprimir
0453   48B2 11 5B 61    	ld	de,strCrLf
0454   48B5 CD 9A 5E    	call	printString
0455   48B8 C9          	ret
0456   48B9             
0457   48B9             
0458   48B9             SDMAPPERINIT: 		; This block is exclusive for the SD-Mapper
0459   48B9 11 77 61    	ld	de, strMemSS0
0460   48BC CD 8A 5E    	call	modoSPI
0461   48BF 3A 00 48    	ld	a, (PORTCFG)
0462   48C2 E6 10       	and	$10
0463   48C4 28 03       	jr	z,.print1
0464   48C6 11 8A 61    	ld	de, strSDSS0
0465   48C9             .print1: 
0466   48C9 CD 9A 5E    	call	printString
0467   48CC 11 99 61    	ld	de, strMapper
0468   48CF 3A 00 48    	ld	a, (PORTCFG)		; ativa, testar se eh mapper ou megaram
0469   48D2 E6 20       	and	$20
0470   48D4 C2 9A 5E    	jp	nz,printString
0471   48D7 11 B1 61    	ld	de, strMegaram		; Megaram ativa
0472   48DA             .print: 
0473   48DA C3 9A 5E    	jp	printString
0474   48DD             
0475   48DD             ;-----------------------------------------------------------------------------
0476   48DD             ;
0477   48DD             ; Obtain driver version
0478   48DD             ;
0479   48DD             ; Input:  -
0480   48DD             ; Output: A = Main version number
0481   48DD             ;         B = Secondary version number
0482   48DD             ;         C = Revision number
0483   48DD             
0484   48DD             DRV_VERSION: 
0485   48DD 3E 01       	ld	a, VER_MAIN
0486   48DF 06 00       	ld	b, VER_SEC
0487   48E1 0E 06       	ld	c, VER_REV
0488   48E3 C9          	ret
0489   48E4             
0490   48E4             
0491   48E4             ;-----------------------------------------------------------------------------
0492   48E4             ;
0493   48E4             ; BASIC expanded statement ("CALL") handler.
0494   48E4             ; Works the expected way, except that if invoking CALBAS is needed,
0495   48E4             ; it must be done via the CALLB0 routine in kernel page 0.
0496   48E4             
0497   48E4             DRV_BASSTAT: 
0498   48E4 37          	scf
0499   48E5 C9          	ret
0500   48E6             
0501   48E6             
0502   48E6             ;-----------------------------------------------------------------------------
0503   48E6             ;
0504   48E6             ; BASIC expanded device handler.
0505   48E6             ; Works the expected way, except that if invoking CALBAS is needed,
0506   48E6             ; it must be done via the CALLB0 routine in kernel page 0.
0507   48E6             
0508   48E6             DRV_BASDEV: 
0509   48E6 37          	scf
0510   48E7 C9          	ret
0511   48E8             
0512   48E8             ;-----------------------------------------------------------------------------
0513   48E8             ;
0514   48E8             ; Extended BIOS hook.
0515   48E8             ; Works the expected way, except that it must return
0516   48E8             ; D'=1 if the old hook must be called, D'=0 otherwise.
0517   48E8             ; It is entered with D'=1.
0518   48E8             
0519   48E8             DRV_EXTBIO: 
0520   48E8 C9          	ret
0521   48E9             
0522   48E9             ;-----------------------------------------------------------------------------
0523   48E9             ;
0524   48E9             ; Direct calls entry points.
0525   48E9             ; Calls to addresses 7850h, 7853h, 7856h, 7859h and 785Ch
0526   48E9             ; in kernel banks 0 and 3 will be redirected
0527   48E9             ; to DIRECT0/1/2/3/4 respectively.
0528   48E9             ; Receives all register data from the caller except IX and AF'.
0529   48E9             
0530   48E9             DRV_DIRECT0: 
0531   48E9             DRV_DIRECT1: 
0532   48E9             DRV_DIRECT2: 
0533   48E9             DRV_DIRECT3: 
0534   48E9             DRV_DIRECT4: 
0535   48E9 C9          	ret
0536   48EA             
0537   48EA             
0538   48EA             ;=====
0539   48EA             ;=====  BEGIN of DEVICE-BASED specific routines
0540   48EA             ;=====
0541   48EA             
0542   48EA             ;-----------------------------------------------------------------------------
0543   48EA             ;
0544   48EA             ; Read or write logical sectors from/to a logical unit
0545   48EA             ;
0546   48EA             ;Input:    Cy=0 to read, 1 to write
0547   48EA             ;          A = Device number, 1 to 7
0548   48EA             ;          B = Number of sectors to read or write
0549   48EA             ;          C = Logical unit number, 1 to 7
0550   48EA             ;          HL = Source or destination memory address for the transfer
0551   48EA             ;          DE = Address where the 4 byte sector number is stored.
0552   48EA             ;Output:   A = Error code (the same codes of MSX-DOS are used):
0553   48EA             ;              0: Ok
0554   48EA             ;              .IDEVL: Invalid device or LUN
0555   48EA             ;              .NRDY: Not ready
0556   48EA             ;              .DISK: General unknown disk error
0557   48EA             ;              .DATA: CRC error when reading
0558   48EA             ;              .RNF: Sector not found
0559   48EA             ;              .UFORM: Unformatted disk
0560   48EA             ;              .WPROT: Write protected media, or read-only logical unit
0561   48EA             ;              .WRERR: Write error
0562   48EA             ;              .NCOMP: Incompatible disk.
0563   48EA             ;              .SEEK: Seek error.
0564   48EA             ;          B = Number of sectors actually read (in case of error only)
0565   48EA             
0566   48EA             DEV_RW: 
0567   48EA F5          	push	af
0568   48EC BF FE 03    	cp	a, 3		; somente 2 dispositivos
0569   48EE 30 10       	jr	nc,.saicomerroidl
0570   48F0 0D          	dec	c		; somente 1 logical unit
0571   48F1 20 0D       	jr	nz,.saicomerroidl
0572   48F3 E5          	push	hl
0573   48F4 CD 91 4A    	call	testaCartao	; verificar se cartao esta OK
0574   48F7 E1          	pop	hl
0575   48F8 30 0C       	jr	nc,.ok
0576   48FA F1          	pop	af
0577   48FB 3E FC       	ld	a, ENRDY	; Not ready
0578   48FD             ;	ld	a, EDISK	; General unknown disk error
0579   48FD 06 00       	ld	b, 0
0580   48FF C9          	ret
0581   4900             .saicomerroidl: 
0582   4900 F1          	pop	af
0583   4901 3E B5       	ld	a, EIDEVL	; error: Invalid device or LUN 
0584   4903 06 00       	ld	b, 0
0585   4905 C9          	ret
0586   4906             .ok: 
0587   4906 FD 70 32    	ld	(iy+WRKAREA.NUMBLOCKS), b	; save the number of blocks to transfer 
0588   4909 D9          	exx
0589   490A CD C7 4A    	call	calculaCIDoffset	; ix=CID offset 
0590   490D DD 7E 0F    	ld	a,(ix+15)	; verificar se eh SDV1 ou SDV2
0591   4910 DD 6F       	ld	ixl,a		; ixl=SDcard version
0592   4912 F1          	pop	af		; a=Device number, f=read/write flag 
0593   4913 D9          	exx			; hl=Source/dest Address, de=Pointer to sect#
0594   4914 DD 60       	ld	ixh, b 		; ixh=Number of blocks to transfer
0595   4916 38 28       	jr	c,escrita	; Skip if it's a write operation 
0596   4918             leitura: 
0597   4918 1A          	ld	a, (de)		; 1. n. bloco
0598   4919 F5          	push	af
0599   491A 13          	inc	de
0600   491B 1A          	ld	a, (de)		; 2. n. bloco
0601   491C F5          	push	af
0602   491D 13          	inc	de
0603   491E 1A          	ld	a, (de)		; 3. n. bloco
0604   491F 4F          	ld	c, a
0605   4920 13          	inc	de
0606   4921 1A          	ld	a, (de)		; 4. n. bloco
0607   4922 13          	inc	de
0608   4923 47          	ld	b, a
0609   4924 F1          	pop	af
0610   4925 57          	ld	d, a
0611   4926 F1          	pop	af		; HL = ponteiro destino
0612   4927 5F          	ld	e, a		; BC DE = 32 bits numero do bloco
0613   4928 CD 8A 5E    	call	modoSPI
0614   492B CD DA 55    	call	LerBloco	; chamar rotina de leitura de dados
0615   492E CD 92 5E    	call	modoROM
0616   4931 30 0B       	jr	nc,.ok
0617   4933 CD BC 4A    	call	marcaErroCartao		; ocorreu erro na leitura, marcar erro
0618   4936 FD 7E 32    	ld	a,(iy+WRKAREA.NUMBLOCKS) ; Get the number of requested blocks
0619   4939 DD 94       	sub	ixh		; subtract the number of remaining blocks
0620   493B 47          	ld	b,a		; b=number of blocks read
0621   493C             ;	ld	a, ENRDY	; Not ready
0622   493C 3E FD       	ld	a, EDISK	; General unknown disk error
0623   493E             .ok: 
0624   493E AF          	xor	a		; tudo OK, informar ao Nextor
0625   493F C9          	ret
0626   4940             
0627   4940             escrita: 
0628   4940 CD 8A 5E    	call	modoSPI
0629   4943             	; Test if the card is write protected
0630   4943 FD 4E 30    	ld	c,(iy+WRKAREA.NUMSD)	; cartao atual (1 ou 2)
0631   4946 CB 21       	sla	c		; desloca para apontar para bits 2 ou 3 para cartoes 1 ou 2 respectivamente
0632   4948 CB 21       	sla	c
0633   494A 3A 00 48    	ld	a,(PORTCFG)	; testar se cartao esta protegido
0634   494D A1          	and	c
0635   494E 28 05       	jr	z,.ok
0636   4950 3E F8       	ld	a, EWPROT	; disco protegido
0637   4952 06 00       	ld	b,0		; 0 blocks were written
0638   4954 C9          	ret
0639   4955             .ok: 
0640   4955 1A          	ld	a, (de)		; 1. n. bloco
0641   4956 F5          	push	af
0642   4957 13          	inc	de
0643   4958 1A          	ld	a, (de)		; 2. n. bloco
0644   4959 F5          	push	af
0645   495A 13          	inc	de
0646   495B 1A          	ld	a, (de)		; 3. n. bloco
0647   495C 13          	inc	de
0648   495D 4F          	ld	c, a
0649   495E 1A          	ld	a, (de)		; 4. n. bloco
0650   495F 13          	inc	de
0651   4960 47          	ld	b, a
0652   4961 F1          	pop	af
0653   4962 57          	ld	d, a
0654   4963 F1          	pop	af		; HL = ponteiro destino
0655   4964 5F          	ld	e, a		; BC DE = 32 bits numero do bloco
0656   4965 CD DE 4C    	call	GravarBloco	; chamar rotina de gravacao de dados
0657   4968 CD 92 5E    	call	modoROM
0658   496B 30 0C       	jr	nc,.ok2
0659   496D CD BC 4A    	call	marcaErroCartao		; ocorreu erro, marcar nas flags
0660   4970 FD 7E 32    	ld	a,(iy+WRKAREA.NUMBLOCKS) ; Get the number of requested blocks
0661   4973 DD 94       	sub	ixh		; subtract the number of remaining blocks
0662   4975 47          	ld	b,a		; b=number of blocks written
0663   4976 3E FE       	ld	a,EWRERR	; Write error
0664   4978 C9          	ret
0665   4979             .ok2: 
0666   4979 AF          	xor	a			; gravacao sem erros!
0667   497A C9          	ret
0668   497B             
0669   497B             ;-----------------------------------------------------------------------------
0670   497B             ;
0671   497B             ; Device information gathering
0672   497B             ;
0673   497B             ;Input:   A = Device index, 1 to 7
0674   497B             ;         B = Information to return:
0675   497B             ;             0: Basic information
0676   497B             ;             1: Manufacturer name string
0677   497B             ;             2: Device name string
0678   497B             ;             3: Serial number string
0679   497B             ;         HL = Pointer to a buffer in RAM
0680   497B             ;Output:  A = Error code:
0681   497B             ;             0: Ok
0682   497B             ;             1: Device not available or invalid device index
0683   497B             ;             2: Information not available, or invalid information index
0684   497B             ;         When basic information is requested,
0685   497B             ;         buffer filled with the following information:
0686   497B             ;
0687   497B             ;+0 (1): Numer of logical units, from 1 to 7. 1 if the device has no logical
0688   497B             ;        units (which is functionally equivalent to having only one).
0689   497B             ;+1 (1): Device flags, always zero in Beta 2.
0690   497B             ;
0691   497B             ; The strings must be printable ASCII string (ASCII codes 32 to 126),
0692   497B             ; left justified and padded with spaces. All the strings are optional,
0693   497B             ; if not available, an error must be returned.
0694   497B             ; If a string is provided by the device in binary format, it must be reported
0695   497B             ; as an hexadecimal, upper-cased string, preceded by the prefix "0x".
0696   497B             ; The maximum length for a string is 64 characters;
0697   497B             ; if the string is actually longer, the leftmost 64 characters
0698   497B             ; should be provided.
0699   497B             ;
0700   497B             ; In the case of the serial number string, the same rules for the strings
0701   497B             ; apply, except that it must be provided right-justified,
0702   497B             ; and if it is too long, the rightmost characters must be
0703   497B             ; provided, not the leftmost.
0704   497B             
0705   497B             DEV_INFO: 
0706   497B 04          	inc	b
0707   497D BF FE 03    	cp	a,3		; somente 2 dispositivos
0708   497F 30 07       	jr	nc,.saicomerro
0709   4981 E5          	push	hl
0710   4982 CD 91 4A    	call	testaCartao	; verificar se cartao esta OK
0711   4985 E1          	pop	hl
0712   4986 30 03       	jr	nc,.ok		; nao houve erro
0713   4988             .saicomerro: 
0714   4988 3E 02       	ld	a,2		; informar erro
0715   498A C9          	ret
0716   498B             
0717   498B             .ok: 
0718   498B 10 06       	djnz	.naoBasic
0719   498D             
0720   498D             ; Basic information:
0721   498D 36 01       	ld	(hl), 1		; 1 logical unit somente
0722   498F 23          	inc	hl
0723   4990 36 00       	ld	(hl), 0		; reservado, deve ser 0
0724   4992 C9          	ret			; retorna com A=0 (OK)
0725   4993             
0726   4993             .naoBasic: 
0727   4993 E5          	push	hl
0728   4994 CD C7 4A    	call	calculaCIDoffset	; calculamos em IX a posicao correta do offset CID dependendo do cartao atual
0729   4997 E1          	pop	hl
0730   4998             
0731   4998 10 25       	djnz	.naoManuf
0732   499A             ; Manufacturer Name:
0733   499A E5          	push	hl		; salva ponteiro do buffer
0734   499B 06 40       	ld	b, 64		; preenche buffer com espaco
0735   499D 3E 20       	ld	a, ' '
0736   499F             .loop1: 
0737   499F 77          	ld	(hl), a
0738   49A0 23          	inc	hl
0739   49A1 10 FC       	djnz	.loop1
0740   49A3 D1          	pop	de		; recuperamos ponteiro do buffer em DE
0741   49A4 3E 28       	ld	a, '('		; colocamos (xx) xxx no buffer
0742   49A6 12          	ld	(de), a
0743   49A7 13          	inc	de
0744   49A8 DD 7E 00    	ld	a, (ix)		; byte do fabricante
0745   49AB CD A3 5E    	call	DecToAscii
0746   49AE 3E 29       	ld	a, ')'
0747   49B0 12          	ld	(de), a
0748   49B1 13          	inc	de
0749   49B2 3E 20       	ld	a, ' '
0750   49B4 12          	ld	(de), a
0751   49B5 13          	inc	de
0752   49B6 DD 7E 00    	ld	a, (ix)		; byte do fabricante
0753   49B9 CD 13 5F    	call	pegaFabricante	; pegar nome do fabricante em HL
0754   49BC ED B0       	ldir			; e colocar no buffer
0755   49BE C9          	ret
0756   49BF             
0757   49BF             .naoManuf: 
0758   49BF 10 1A       	djnz	.naoProduct
0759   49C1             ; Product Name:
0760   49C1 E5          	push	hl		; guarda HL que aponta para buffer do Nextor
0761   49C2 DD E5       	push	ix
0762   49C4 E1          	pop	hl		; joga IX para HL
0763   49C5 16 00       	ld	d, 0
0764   49C7 1E 03       	ld	e, 3		; adiciona offset do productname em HL
0765   49C9 19          	add	hl, de
0766   49CA D1          	pop	de		; recupera buffer do Nextor em DE
0767   49CB 01 05 00    	ld	bc, 5		; 5 caracteres
0768   49CE ED B0       	ldir			; copia nome do produto
0769   49D0 EB          	ex	de,hl		; troca DE com HL, agora HL aponta para Buffer do nextor atualizado
0770   49D1 06 3B       	ld	b, 59		; Coloca espaco no restante do buffer
0771   49D3 3E 20       	ld	a, ' '
0772   49D5             .loop2: 
0773   49D5 77          	ld	(hl), a
0774   49D6 23          	inc	hl
0775   49D7 10 FC       	djnz	.loop2
0776   49D9 AF          	xor	a		; informar sem erros
0777   49DA C9          	ret
0778   49DB             
0779   49DB             .naoProduct: 
0780   49DB             ; Serial Number:
0781   49DB 36 30       	ld	(hl),'0'	; Coloca prefixo "0x"
0782   49DD 23          	inc	hl
0783   49DE 36 78       	ld	(hl), 'x'
0784   49E0 23          	inc	hl
0785   49E1 E5          	push	hl		; guarda HL que aponta para buffer do Nextor
0786   49E2 DD E5       	push	ix
0787   49E4 E1          	pop	hl		; joga IX para HL
0788   49E5 16 00       	ld	d, 0
0789   49E7 1E 09       	ld	e, 9		; adiciona offset do productname em HL
0790   49E9 19          	add	hl, de
0791   49EA D1          	pop	de		; recupera buffer do nextor em DE
0792   49EB 06 04       	ld	b, 4		; 4 bytes do serial
0793   49ED             .loop3: 
0794   49ED 7E          	ld	a, (hl)
0795   49EE CD D3 5E    	call	HexToAscii	; converter HEXA para ASCII
0796   49F1 23          	inc	hl
0797   49F2 10 F9       	djnz	.loop3
0798   49F4 06 36       	ld	b, 54		; Coloca espaco no restante
0799   49F6 3E 20       	ld	a, ' '
0800   49F8             .loop4: 
0801   49F8 12          	ld	(de), a
0802   49F9 13          	inc	de
0803   49FA 10 FC       	djnz	.loop4
0804   49FC AF          	xor	a		; informar sem erros
0805   49FD C9          	ret
0806   49FE             
0807   49FE             ;-----------------------------------------------------------------------------
0808   49FE             ;
0809   49FE             ; Obtain device status
0810   49FE             ;
0811   49FE             ;Input:   A = Device index, 1 to 7
0812   49FE             ;         B = Logical unit number, 1 to 7
0813   49FE             ;             0 to return the status of the device itself.
0814   49FE             ;Output:  A = Status for the specified logical unit,
0815   49FE             ;             or for the whole device if 0 was specified:
0816   49FE             ;                0: The device or logical unit is not available, or the
0817   49FE             ;                   device or logical unit number supplied is invalid.
0818   49FE             ;                1: The device or logical unit is available and has not
0819   49FE             ;                   changed since the last status request.
0820   49FE             ;                2: The device or logical unit is available and has changed
0821   49FE             ;                   since the last status request
0822   49FE             ;                   (for devices, the device has been unplugged and a
0823   49FE             ;                    different device has been plugged which has been
0824   49FE             ;                    assigned the same device index; for logical units,
0825   49FE             ;                    the media has been changed).
0826   49FE             ;                3: The device or logical unit is available, but it is not
0827   49FE             ;                   possible to determine whether it has been changed
0828   49FE             ;                   or not since the last status request.
0829   49FE             ;
0830   49FE             ; Devices not supporting hot-plugging must always return status value 1.
0831   49FE             ; Non removable logical units may return values 0 and 1.
0832   49FE             ;
0833   49FE             ; The returned status is always relative to the previous invokation of
0834   49FE             ; DEV_STATUS itself. Please read the Driver Developer Guide for more info.
0835   49FE             
0836   49FE             DEV_STATUS: 
0837   49FF BF FE 03    	cp	a,3		; 2 dispositivos somente
0838   4A01 30 2C       	jr	nc,.saicomerro
0839   4A03 05          	dec	b		; 1 logical unit somente
0840   4A04 20 29       	jr	nz,.saicomerro
0841   4A06 F5          	push	af
0842   4A07 CD 78 4A    	call	pegaWorkArea	; HL=IY=Work area pointer
0843   4A0A F1          	pop	af
0844   4A0B FD 77 30    	ld	(iy+WRKAREA.NUMSD),a	; salva numero do device atual (1 ou 2)
0845   4A0E 4F          	ld	c,a		; c=device number
0846   4A0F CD 8A 5E    	call	modoSPI
0847   4A12 3A 00 48    	ld	a, (PORTCFG)	; testar se cartao esta inserido
0848   4A15 CD 92 5E    	call	modoROM
0849   4A18 A1          	and	c		; C contem 1 se cartao 1, 2 se cartao 2
0850   4A19 20 11       	jr	nz,.cartaoAusente	; se slot do cartao estiver vazio, marcamos o erro nas flags
0851   4A1B             	;***FixMe: Disk change detection doesn't work
0852   4A1B             	; Will have to check both the hardware disk-change and the software
0853   4A1B             	; disk-change reported by LUN_NFO
0854   4A1B CD 8A 5E    	call	modoSPI
0855   4A1E CD EF 4A    	call	detectaCartao	; erro na deteccao do cartao, tentar re-detectar
0856   4A21 CD 92 5E    	call	modoROM
0857   4A24 38 06       	jr	c,.cartaoComErro	; nao conseguimos detectar, sai com erro
0858   4A26             
0859   4A26             .semMudanca: 
0860   4A26 3E 01       	ld	a, 1		; informa ao Nextor que cartao esta OK e nao mudou
0861   4A28 C9          	ret
0862   4A29             .comMudanca: 
0863   4A29 3E 02       	ld	a, 2		; informa ao Nextor que cartao esta OK e mudou
0864   4A2B C9          	ret
0865   4A2C             .cartaoComErro: 
0866   4A2C             .cartaoAusente: 
0867   4A2C CD BC 4A    	call	marcaErroCartao	; marcar erro do cartao nas flags
0868   4A2F             .saicomerro: 
0869   4A2F 3E 00       	ld	a, 0		; informa erro
0870   4A31 C9          	ret
0871   4A32             
0872   4A32             ;-----------------------------------------------------------------------------
0873   4A32             ;
0874   4A32             ; Obtain logical unit information
0875   4A32             ;
0876   4A32             ;Input:   A  = Device index, 1 to 7
0877   4A32             ;         B  = Logical unit number, 1 to 7
0878   4A32             ;         HL = Pointer to buffer in RAM.
0879   4A32             ;Output:  A = 0: Ok, buffer filled with information.
0880   4A32             ;             1: Error, device or logical unit not available,
0881   4A32             ;                or device index or logical unit number invalid.
0882   4A32             ;         On success, buffer filled with the following information:
0883   4A32             ;
0884   4A32             ;+0 (1): Medium type:
0885   4A32             ;        0: Block device
0886   4A32             ;        1: CD or DVD reader or recorder
0887   4A32             ;        2-254: Unused. Additional codes may be defined in the future.
0888   4A32             ;        255: Other
0889   4A32             ;+1 (2): Sector size, 0 if this information does not apply or is
0890   4A32             ;        not available.
0891   4A32             ;+3 (4): Total number of available sectors.
0892   4A32             ;        0 if this information does not apply or is not available.
0893   4A32             ;+7 (1): Flags:
0894   4A32             ;        bit 0: 1 if the medium is removable.
0895   4A32             ;        bit 1: 1 if the medium is read only. A medium that can dinamically
0896   4A32             ;               be write protected or write enabled is not considered
0897   4A32             ;               to be read-only.
0898   4A32             ;        bit 2: 1 if the LUN is a floppy disk drive.
0899   4A32             ;+8 (2): Number of cylinders
0900   4A32             ;+10 (1): Number of heads
0901   4A32             ;+11 (1): Number of sectors per track
0902   4A32             ;
0903   4A32             ; Number of cylinders, heads and sectors apply to hard disks only.
0904   4A32             ; For other types of device, these fields must be zero.
0905   4A32             
0906   4A32             LUN_INFO: 
0907   4A33 BF FE 03    	cp	a, 3		; somente 2 dispositivo
0908   4A35 30 0A       	jr	nc,.saicomerro
0909   4A37 05          	dec	b		; somente 1 logical unit
0910   4A38 20 07       	jr	nz,.saicomerro
0911   4A3A E5          	push	hl
0912   4A3B CD 91 4A    	call	testaCartao
0913   4A3E E1          	pop	hl
0914   4A3F 30 03       	jr	nc,.ok		; nao tem erro com o cartao
0915   4A41             .saicomerro: 
0916   4A41 3E 01       	ld	a, 1		; informar erro
0917   4A43 C9          	ret
0918   4A44             .ok: 
0919   4A44 D9          	exx	
0920   4A45             	; ***FixMe: Will have to check disk-change, and daisy chain this as a
0921   4A45             	; software flag so DEV_STATUS can also be notified
0922   4A45 CD 8A 5E    	call	modoSPI
0923   4A48 CD EF 4A    	call	detectaCartao	; erro na deteccao do cartao, tentar re-detectar
0924   4A4B CD 92 5E    	call	modoROM
0925   4A4E 38 F1       	jr	c,.saicomerro
0926   4A50 CD DB 4A    	call	calculaBLOCOSoffset	; calcular em IX e HL o offset correto do buffer que armazena total de blocos
0927   4A53 D9          	exx			; do cartao dependendo do cartao atual solicitado
0928   4A54 AF          	xor	a
0929   4A55 77          	ld	(hl),a		; Informar que o dispositivo eh do tipo block device
0930   4A56 23          	inc	hl
0931   4A57 77          	ld	(hl),a		; block size: 512 bytes (0200h)
0932   4A58 23          	inc	hl
0933   4A59 36 02       	ld	(hl),2
0934   4A5B 23          	inc	hl
0935   4A5C DD 7E 00    	ld	a, (ix)		; copia numero de blocos total
0936   4A5F 77          	ld	(hl), a
0937   4A60 23          	inc	hl
0938   4A61 DD 7E 01    	ld	a, (ix+1)
0939   4A64 77          	ld	(hl), a
0940   4A65 23          	inc	hl
0941   4A66 DD 7E 02    	ld	a, (ix+2)
0942   4A69 77          	ld	(hl), a
0943   4A6A 23          	inc	hl
0944   4A6B 36 00       	ld	(hl),0		; The highest byte must be set to 0, as SDcards
0945   4A6D             				; have 24bit total block numbers, and Nextor
0946   4A6D             				; requires 32bits. 
0947   4A6D 23          	inc	hl
0948   4A6E 36 01       	ld	(hl),1		; flags: dispositivo R/W removivel
0949   4A70 23          	inc	hl
0950   4A71 AF          	xor	a		; CHS = 0
0951   4A72 77          	ld	(hl), a
0952   4A73 23          	inc	hl
0953   4A74 77          	ld	(hl), a
0954   4A75 23          	inc	hl
0955   4A76 77          	ld	(hl), a
0956   4A77             ;	xor	a		; informar que dados foram preenchidos
0957   4A77 C9          	ret
0958   4A78             
0959   4A78             ;=====
0960   4A78             ;=====  END of DEVICE-BASED specific routines
0961   4A78             ;=====
0962   4A78             
0963   4A78             ;------------------------------------------------
0964   4A78             ; Rotinas auxiliares
0965   4A78             ;------------------------------------------------
0966   4A78             
0967   4A78             ;------------------------------------------------
0968   4A78             ; Pedir ao Nextor o ponteiro de dados de trabalho
0969   4A78             ; na RAM e colocar em HL e IY
0970   4A78             ; Destroi HL e IY
0971   4A78             ;------------------------------------------------
0972   4A78             pegaWorkArea: 
0973   4A78 F5          	push	af
0974   4A79 AF          	xor	a		; Pegar endereco da area de trabalho
0975   4A7A 08          	ex	af,af'
0976   4A7B AF          	xor	a
0977   4A7C DD 21 45 40 	ld	ix, GWORK
0978   4A80 CD 92 5E    	call	modoROM
0979   4A83 CD 42 40    	call	CALBNK
0980   4A86 DD 6E 00    	ld	l,(ix)		; em HL tem o ponteiro da nossa area da RAM
0981   4A89 DD 66 01    	ld	h,(ix+1)
0982   4A8C E5          	push	hl
0983   4A8D FD E1       	pop	iy		; em IY temos o mesmo ponteiro
0984   4A8F F1          	pop	af
0985   4A90 C9          	ret
0986   4A91             
0987   4A91             ;------------------------------------------------
0988   4A91             ; Testa se cartao esta inserido e/ou houve erro
0989   4A91             ; na ultima vez que foi acessado. Carry indica
0990   4A91             ; erro
0991   4A91             ; Destroi AF, HL, IX, C
0992   4A91             ;------------------------------------------------
0993   4A91             testaCartao: 
0994   4A91 F5          	push	af
0995   4A92 CD 78 4A    	call	pegaWorkArea	; HL=IY=Work area pointer
0996   4A95 F1          	pop	af
0997   4A96 FD 77 30    	ld	(iy+WRKAREA.NUMSD), a	; salva numero do device atual (1 ou 2)
0998   4A99 4F          	ld	c, a
0999   4A9A CD 8A 5E    	call	modoSPI
1000   4A9D 3A 00 48    	ld	a, (PORTCFG)	; testar se cartao esta inserido
1001   4AA0 CD 92 5E    	call	modoROM
1002   4AA3 A1          	and	c		; C contem 1 se cartao 1, 2 se cartao 2
1003   4AA4 20 0D       	jr	nz,.saicomerro				
1004   4AA6 FD 7E 30    	ld	a, (iy+WRKAREA.NUMSD)		; conseguimos detectar, tira erro nas flags
1005   4AA9 2F          	cpl			; inverte bits para fazer o AND
1006   4AAA 4F          	ld	c, a
1007   4AAB FD 7E 31    	ld	a, (iy+WRKAREA.CARDFLAGS)
1008   4AAE A1          	and	c			; limpa bit
1009   4AAF FD 77 31    	ld	(iy+WRKAREA.CARDFLAGS), a
1010   4AB2 C9          	ret
1011   4AB3             .saicomerro: 
1012   4AB3 FD 7E 31    	ld	a, (iy+WRKAREA.CARDFLAGS)	; marca bit de erro nas flags
1013   4AB6 B1          	or	c
1014   4AB7 FD 77 31    	ld	(iy+WRKAREA.CARDFLAGS), a
1015   4ABA 37          	scf
1016   4ABB C9          	ret
1017   4ABC             
1018   4ABC             ;------------------------------------------------
1019   4ABC             ; Marcar bit de erro nas flags
1020   4ABC             ; Destroi AF, C
1021   4ABC             ;------------------------------------------------
1022   4ABC             marcaErroCartao: 
1023   4ABC FD 4E 30    	ld	c, (iy+WRKAREA.NUMSD)		; cartao atual (1 ou 2)
1024   4ABF FD 7E 31    	ld	a, (iy+WRKAREA.CARDFLAGS)	; marcar erro
1025   4AC2 B1          	or	c
1026   4AC3 FD 77 31    	ld	(iy+WRKAREA.CARDFLAGS), a
1027   4AC6 C9          	ret
1028   4AC7             
1029   4AC7             ;------------------------------------------------
1030   4AC7             ; Calcula offset do buffer na RAM em HL e IX para
1031   4AC7             ; os dados do CID dependendo do tipo do cartao atual
1032   4AC7             ; Destroi AF, DE, HL e IX
1033   4AC7             ;------------------------------------------------
1034   4AC7             calculaCIDoffset: 
1035   4AC7 FD E5       	push	iy		; copiamos IY para HL
1036   4AC9 E1          	pop	hl
1037   4ACA 16 00       	ld	d, 0
1038   4ACC 1E 10       	ld	e, WRKAREA.BCID1	; DE aponta para buffer BCID1
1039   4ACE FD 7E 30    	ld	a, (iy+WRKAREA.NUMSD)	; vamos fazer IX apontar para o buffer correto
1040   4AD1 3D          	dec	a		; dependendo do cartao: BCID1 ou BCID2
1041   4AD2 28 02       	jr	z,.c1
1042   4AD4 1E 20       	ld	e, WRKAREA.BCID2	; DE aponta para buffer BCID2
1043   4AD6             .c1: 
1044   4AD6 19          	add	hl, de		; HL aponta para buffer correto
1045   4AD7 E5          	push	hl		
1046   4AD8 DD E1       	pop	ix		; vamos colocar HL em IX
1047   4ADA C9          	ret
1048   4ADB             
1049   4ADB             ;------------------------------------------------
1050   4ADB             ; Calcula offset do buffer na RAM para os dados
1051   4ADB             ; do total de blocos dependendo do cartao atual
1052   4ADB             ; Offset fica em HL e IX
1053   4ADB             ; Destroi AF, DE, HL e IX
1054   4ADB             ;------------------------------------------------
1055   4ADB             calculaBLOCOSoffset: 
1056   4ADB FD E5       	push	iy		; copiamos IY para HL
1057   4ADD E1          	pop	hl
1058   4ADE 16 00       	ld	d, 0
1059   4AE0 1E 33       	ld	e, WRKAREA.BLOCKS1	; DE aponta para buffer BLOCKS1
1060   4AE2 FD 7E 30    	ld	a, (iy+WRKAREA.NUMSD)	; Vamos fazer IX apontar para o buffer correto
1061   4AE5 3D          	dec	a		; dependendo do cartao: BLOCKS1 ou BLOCKS2
1062   4AE6 28 02       	jr	z,.c1
1063   4AE8 1E 36       	ld	e, WRKAREA.BLOCKS2	; DE aponta para buffer BLOCKS2
1064   4AEA             .c1: 
1065   4AEA 19          	add	hl, de		; HL aponta para buffer correto
1066   4AEB E5          	push	hl		
1067   4AEC DD E1       	pop	ix		; Vamos colocar HL em IX
1068   4AEE C9          	ret
1069   4AEF             
1070   4AEF             
1071   4AEF             ;------------------------------------------------
1072   4AEF             ; Minhas funcoes para cartao SD
1073   4AEF             ;------------------------------------------------
1074   4AEF             
1075   4AEF             ;------------------------------------------------
1076   4AEF             ; Processo de inicializacao e deteccao do cartao.
1077   4AEF             ; Detecta se cartao responde, qual versao (SDV1
1078   4AEF             ; ou SDV2), faz a leitura do CSD e CID e calcula
1079   4AEF             ; o numero de blocos do cartao, colocando o CID
1080   4AEF             ; e total de blocos no buffer correto dependendo
1081   4AEF             ; do cartao 1 ou 2.
1082   4AEF             ; Retorna erro no carry. Se for 0 indica deteccao
1083   4AEF             ; com sucesso.
1084   4AEF             ; Destroi todos os registradores
1085   4AEF             ;------------------------------------------------
1086   4AEF             detectaCartao: 
1087   4AEF CD 11 4C    	call	iniciaSD	; manda pulsos de clock e comandos iniciais
1088   4AF2 D8          	ret	c			; retorna se erro
1089   4AF3 CD BE 4B    	call	testaSDCV2	; tenta inicializar um cartao SDV2
1090   4AF6 D8          	ret	c
1091   4AF7 FD E5       	push	iy		; colocar em HL buffer da RAM de trabalho
1092   4AF9 E1          	pop	hl		; CSD esta no offset 0, nao precisamos somar
1093   4AFA 3E 49       	ld	a, CMD9		; ler CSD
1094   4AFC CD DF 4B    	call	lerBlocoCxD
1095   4AFF D8          	ret	c
1096   4B00 CD C7 4A    	call	calculaCIDoffset	; calculamos em IX e HL a posicao correta do offset CID dependendo do cartao atual
1097   4B03 3E 4A       	ld	a, CMD10	; ler CID
1098   4B05 CD DF 4B    	call	lerBlocoCxD
1099   4B08 D8          	ret	c
1100   4B09 3E 7A       	ld	a, CMD58	; ler OCR
1101   4B0B 11 00 00    	ld	de, 0
1102   4B0E CD 62 4C    	call	SD_SEND_CMD_2_ARGS_GET_R3	; enviar comando e receber resposta tipo R3
1103   4B11 D8          	ret	c
1104   4B12 78          	ld	a, b		; testa bit CCS do OCR que informa se cartao eh SDV1 ou SDV2
1105   4B13 E6 40       	and	$40
1106   4B15 DD 77 0F    	ld	(ix+15), a	; salva informacao da versao do SD (V1 ou V2) no byte 15 do CID
1107   4B18 CC B3 4B    	call	z,mudarTamanhoBlocoPara512	; se bit CCS do OCR for 1, eh cartao SDV2 (Block address - SDHC ou SDXD)
1108   4B1B D8          	ret	c		; e nao precisamos mudar tamanho do bloco para 512
1109   4B1C CD 30 4C    	call	desabilitaSDs
1110   4B1F             				; agora vamos calcular o total de blocos dependendo dos dados do CSD
1111   4B1F CD DB 4A    	call	calculaBLOCOSoffset	; calcular em IX e HL o offset correto do buffer que armazena total de blocos
1112   4B22 FD E5       	push	iy		; copiamos IY para HL
1113   4B24 E1          	pop	hl
1114   4B25 16 00       	ld	d, 0
1115   4B27 1E 05       	ld	e, WRKAREA.BCSD+5
1116   4B29 19          	add	hl, de		; HL aponta para buffer BCSD+5
1117   4B2A FD 7E 00    	ld	a, (iy+WRKAREA.BCSD)
1118   4B2D E6 C0       	and	$C0		; testa versao do registro CSD
1119   4B2F 28 06       	jr	z,.calculaCSD1
1120   4B31 FE 40       	cp	$40
1121   4B33 28 54       	jr	z,.calculaCSD2
1122   4B35 37          	scf			; versao do registro CSD nao reconhecida, informa erro na deteccao
1123   4B36 C9          	ret
1124   4B37             
1125   4B37             ; -----------------------------------
1126   4B37             ; Registro CSD versao 1, calcular da
1127   4B37             ; maneira correta para a versao 1
1128   4B37             ; -----------------------------------
1129   4B37             .calculaCSD1: 
1130   4B37 7E          	ld	a, (hl)
1131   4B38 E6 0F       	and	$0F		; isola READ_BL_LEN
1132   4B3A F5          	push	af
1133   4B3B 23          	inc	hl
1134   4B3C 7E          	ld	a, (hl)		; 2 primeiros bits de C_SIZE
1135   4B3D E6 03       	and	3
1136   4B3F 57          	ld	d, a
1137   4B40 23          	inc	hl
1138   4B41 5E          	ld	e, (hl)		; 8 bits de C_SIZE (DE contem os primeiros 10 bits de C_SIZE)
1139   4B42 23          	inc	hl
1140   4B43 7E          	ld	a, (hl)
1141   4B44 E6 C0       	and	$C0		; 2 ultimos bits de C_SIZE
1142   4B46 87          	add	a, a		; rotaciona a esquerda
1143   4B47 CB 13       	rl	e		; rotaciona para DE
1144   4B49 CB 12       	rl	d
1145   4B4B 87          	add	a, a		; mais uma rotacao
1146   4B4C CB 13       	rl	e		; rotaciona para DE
1147   4B4E CB 12       	rl	d
1148   4B50 13          	inc	de		; agora DE contem todos os 12 bits de C_SIZE, incrementa 1
1149   4B51 23          	inc	hl
1150   4B52 7E          	ld	a, (hl)		; proximo byte
1151   4B53 E6 03       	and	3		; 2 bits de C_SIZE_MUL
1152   4B55 47          	ld	b, a		; B contem os 2 bits de C_SIZE_MUL
1153   4B56 23          	inc	hl						
1154   4B57 7E          	ld	a, (hl)		; proximo byte
1155   4B58 E6 80       	and	$80		; 1 bit de C_SIZE_MUL
1156   4B5A 87          	add	a, a		; rotaciona para esquerda jogando no carry
1157   4B5B CB 10       	rl	b		; rotaciona para B
1158   4B5D 04          	inc	b		; agora B contem os 3 bits de C_SIZE_MUL
1159   4B5E 04          	inc	b		; faz B = C_SIZE_MUL + 2
1160   4B5F F1          	pop	af		; volta em A o READ_BL_LEN
1161   4B60 80          	add	a, b		; A = READ_BL_LEN + (C_SIZE_MUL+2)
1162   4B61 01 00 00    	ld	bc, 0
1163   4B64 CD 7D 4B    	call	.eleva2
1164   4B67 5A          	ld	e, d		; aqui temos 32 bits (BC DE) com o tamanho do cartao
1165   4B68 51          	ld	d, c		; ignoramos os 8 ultimos bits em E, fazemos BC DE => 0B CD (divide por 256)
1166   4B69 48          	ld	c, b
1167   4B6A 06 00       	ld	b, 0
1168   4B6C CB 39       	srl	c		; rotacionamos a direita o C, carry = LSB (divide por 2)
1169   4B6E CB 1A       	rr	d		; rotacionamos D e E
1170   4B70 CB 1B       	rr	e		; no final BC DE contem tamanho do cartao / 512 = numero de blocos
1171   4B72             .salvaBlocos: 
1172   4B72 DD 71 02    	ld	(ix+2), c	; colocar no buffer BLOCOS correto a quantidade de blocos
1173   4B75 DD 72 01    	ld	(ix+1), d	; que o cartao (1 ou 2) tem
1174   4B78 DD 73 00    	ld	(ix), e
1175   4B7B AF          	xor	a		; limpa carry
1176   4B7C C9          	ret
1177   4B7D             
1178   4B7D             .eleva2: 			; aqui temos: A = (READ_BL_LEN + (C_SIZE_MUL+2))
1179   4B7D             				; BC = 0
1180   4B7D             				; DE = C_SIZE
1181   4B7D CB 23       	sla	e		; rotacionamos C_SIZE por 'A' vezes
1182   4B7F CB 12       	rl	d
1183   4B81 CB 11       	rl	c
1184   4B83 CB 10       	rl	b
1185   4B85 3D          	dec	a		; subtraimos 1
1186   4B86 20 F5       	jr	nz,.eleva2
1187   4B88 C9          	ret			; em BC DE temos o tamanho do cartao (bytes) em 32 bits
1188   4B89             
1189   4B89             ; -----------------------------------
1190   4B89             ; Registro CSD versao 2, calcular da
1191   4B89             ; maneira correta para a versao 2
1192   4B89             ; -----------------------------------
1193   4B89             .calculaCSD2: 
1194   4B89 23          	inc	hl		; HL ja aponta para BCSD+5, fazer HL apontar para BCSD+7
1195   4B8A 23          	inc	hl
1196   4B8B 7E          	ld	a, (hl)
1197   4B8C E6 3F       	and	$3F
1198   4B8E 4F          	ld	c, a
1199   4B8F 23          	inc	hl
1200   4B90 56          	ld	d, (hl)
1201   4B91 23          	inc	hl
1202   4B92 5E          	ld	e, (hl)
1203   4B93 CD 9F 4B    	call	.inc32		; soma 1
1204   4B96 CD A7 4B    	call	.desloca32	; multiplica por 512
1205   4B99 CD AC 4B    	call	.rotaciona24	; multiplica por 2
1206   4B9C C3 72 4B    	jp		.salvaBlocos
1207   4B9F             
1208   4B9F             .inc32: 
1209   4B9F 1C          	inc	e
1210   4BA0 C0          	ret	nz
1211   4BA1 14          	inc	d
1212   4BA2 C0          	ret	nz
1213   4BA3 0C          	inc	c
1214   4BA4 C0          	ret	nz
1215   4BA5 04          	inc	b
1216   4BA6 C9          	ret
1217   4BA7             
1218   4BA7             .desloca32: 
1219   4BA7 41          	ld	b, c
1220   4BA8 4A          	ld	c, d
1221   4BA9 53          	ld	d, e
1222   4BAA 1E 00       	ld	e, 0
1223   4BAC             .rotaciona24: 
1224   4BAC CB 22       	sla	d
1225   4BAE CB 11       	rl	c
1226   4BB0 CB 10       	rl	b
1227   4BB2 C9          	ret
1228   4BB3             
1229   4BB3             ; ------------------------------------------------
1230   4BB3             ; Setar o tamanho do bloco para 512 se o cartao
1231   4BB3             ; for SDV1
1232   4BB3             ; ------------------------------------------------
1233   4BB3             mudarTamanhoBlocoPara512: 
1234   4BB3 3E 50       	ld	a, CMD16
1235   4BB5 01 00 00    	ld	bc, 0
1236   4BB8 11 00 02    	ld	de, 512
1237   4BBB C3 4D 4C    	jp	SD_SEND_CMD_GET_ERROR
1238   4BBE             
1239   4BBE             ; ------------------------------------------------
1240   4BBE             ; Tenta inicializar um cartao SDV2, se houver erro
1241   4BBE             ; o cartao deve ser SDV1
1242   4BBE             ; ------------------------------------------------
1243   4BBE             testaSDCV2: 
1244   4BBE 3E 48       	ld	a, CMD8
1245   4BC0 11 AA 01    	ld	de, $1AA
1246   4BC3 CD 62 4C    	call	SD_SEND_CMD_2_ARGS_GET_R3
1247   4BC6 21 46 4C    	ld	hl, SD_SEND_CMD1	; HL aponta para rotina correta
1248   4BC9 38 03       	jr	c,.pula		; cartao recusou CMD8, enviar comando CMD1
1249   4BCB 21 38 4C    	ld	hl, SD_SEND_ACMD41	; cartao aceitou CMD8, enviar comando ACMD41
1250   4BCE             .pula: 
1251   4BCE 01 14 00    	ld	bc, 20		; B = 0, C = 20: 5120 tentativas
1252   4BD1             .loop: 
1253   4BD1 C5          	push	bc
1254   4BD2 CD DE 4B    	call	.jumpHL		; chamar rotina correta em HL
1255   4BD5 C1          	pop	bc
1256   4BD6 D0          	ret	nc
1257   4BD7 10 F8       	djnz	.loop
1258   4BD9 0D          	dec	c
1259   4BDA 20 F5       	jr	nz,.loop
1260   4BDC 37          	scf
1261   4BDD C9          	ret
1262   4BDE             .jumpHL: 
1263   4BDE E9          	jp	(hl)		; chamar rotina correta em HL
1264   4BDF             
1265   4BDF             ; ------------------------------------------------
1266   4BDF             ; Ler registro CID ou CSD, o comando vem em A
1267   4BDF             ; ------------------------------------------------
1268   4BDF             lerBlocoCxD: 
1269   4BDF CD 48 4C    	call	SD_SEND_CMD_NO_ARGS
1270   4BE2 D8          	ret	c
1271   4BE3 CD B6 4C    	call	WAIT_RESP_FE
1272   4BE6 D8          	ret	c
1273   4BE7 EB          	ex	de,hl
1274   4BE8             
1275   4BE8 21 00 40    	ld	hl, PORTSPI
1276   4BEB ED A0       > ldi		
1276   4BED ED A0       > ldi		
1276   4BEF ED A0       > ldi		
1276   4BF1 ED A0       > ldi		
1276   4BF3 ED A0       > ldi		
1276   4BF5 ED A0       > ldi		
1276   4BF7 ED A0       > ldi		
1276   4BF9 ED A0       > ldi		
1276   4BFB ED A0       > ldi		
1276   4BFD ED A0       > ldi		
1276   4BFF ED A0       > ldi		
1276   4C01 ED A0       > ldi		
1276   4C03 ED A0       > ldi		
1276   4C05 ED A0       > ldi		
1276   4C07 ED A0       > ldi		
1276   4C09 ED A0       > ldi		
1277   4C0B 7E          	ld	a, (hl)
1278   4C0C 7E          	ld	a, (hl)		; byte de resposta
1279   4C0D B7          	or	a
1280   4C0E EB          	ex	de,hl
1281   4C0F 18 1F       	jr	desabilitaSDs
1282   4C11             
1283   4C11             ; ------------------------------------------------
1284   4C11             ; Algoritmo para inicializar um cartao SD
1285   4C11             ; Destroi AF, B, DE
1286   4C11             ; ------------------------------------------------
1287   4C11             iniciaSD: 
1288   4C11 CD 30 4C    	call	desabilitaSDs
1289   4C14             
1290   4C14 06 0A       	ld	b, 10		; enviar 80 pulsos de clock com cartao desabilitado
1291   4C16             enviaClocksInicio: 
1292   4C16 3E FF       	ld	a, $FF		; manter MOSI em 1
1293   4C18 32 00 40    	ld	(PORTSPI), a
1294   4C1B 10 F9       	djnz	enviaClocksInicio
1295   4C1D CD D3 4C    	call	setaSDAtual	; ativar cartao atual
1296   4C20 06 08       	ld	b, 8		; 8 tentativas para CMD0
1297   4C22             SD_SEND_CMD0: 
1298   4C22 3E 40       	ld	a, CMD0		; primeiro comando: CMD0
1299   4C24 11 00 00    	ld	de, 0
1300   4C27 C5          	push	bc
1301   4C28 CD 55 4C    	call	SD_SEND_CMD_2_ARGS_TEST_BUSY
1302   4C2B C1          	pop	bc
1303   4C2C D0          	ret	nc			; retorna se cartao respondeu ao CMD0
1304   4C2D 10 F3       	djnz	SD_SEND_CMD0
1305   4C2F 37          	scf			; cartao nao respondeu ao CMD0, informar erro
1306   4C30             	; fall throw
1307   4C30             
1308   4C30             ; ------------------------------------------------
1309   4C30             ; Desabilitar (de-selecionar) todos os cartoes
1310   4C30             ; Nao destroi registradores
1311   4C30             ; ------------------------------------------------
1312   4C30             desabilitaSDs: 
1313   4C30 F5          	push	af
1314   4C31 3E FF       	ld	a, $FF		; todos os /CS em 1
1315   4C33 32 00 48    	ld	(PORTCFG), a
1316   4C36 F1          	pop	af
1317   4C37 C9          	ret
1318   4C38             
1319   4C38             ; ------------------------------------------------
1320   4C38             ; Enviar comando ACMD41
1321   4C38             ; ------------------------------------------------
1322   4C38             SD_SEND_ACMD41: 
1323   4C38 3E 77       	ld	a, CMD55
1324   4C3A CD 48 4C    	call	SD_SEND_CMD_NO_ARGS
1325   4C3D 3E 69       	ld	a, ACMD41
1326   4C3F 01 00 40    	ld	bc, $4000
1327   4C42 51          	ld	d, c
1328   4C43 59          	ld	e, c
1329   4C44 18 07       	jr		SD_SEND_CMD_GET_ERROR
1330   4C46             
1331   4C46             ; ------------------------------------------------
1332   4C46             ; Enviar CMD1 para cartao. Carry indica erro
1333   4C46             ; Destroi AF, BC, DE
1334   4C46             ; ------------------------------------------------
1335   4C46             SD_SEND_CMD1: 
1336   4C46 3E 41       	ld	a, CMD1
1337   4C48             SD_SEND_CMD_NO_ARGS: 
1338   4C48 01 00 00    	ld	bc, 0
1339   4C4B 50          	ld	d, b
1340   4C4C 59          	ld	e, c
1341   4C4D             SD_SEND_CMD_GET_ERROR: 
1342   4C4D CD 7B 4C    	call	SD_SEND_CMD
1343   4C50 B7          	or	a
1344   4C51 C8          	ret	z			; se A=0 nao houve erro, retornar
1345   4C52             	; fall throw
1346   4C52             
1347   4C52             ; ------------------------------------------------
1348   4C52             ; Informar erro
1349   4C52             ; Nao destroi registradores
1350   4C52             ; ------------------------------------------------
1351   4C52             setaErro: 
1352   4C52 37          	scf
1353   4C53 18 DB       	jr		desabilitaSDs
1354   4C55             
1355   4C55             ; ------------------------------------------------
1356   4C55             ; Enviar comando em A com 2 bytes de parametros
1357   4C55             ; em DE e testar retorno BUSY
1358   4C55             ; Retorna em A a resposta do cartao
1359   4C55             ; Destroi AF, BC
1360   4C55             ; ------------------------------------------------
1361   4C55             SD_SEND_CMD_2_ARGS_TEST_BUSY: 
1362   4C55 01 00 00    	ld	bc, 0
1363   4C58 CD 7B 4C    	call	SD_SEND_CMD
1364   4C5B 47          	ld	b, a
1365   4C5C E6 FE       	and	$FE		; testar bit 0 (flag BUSY)
1366   4C5E 78          	ld	a, b
1367   4C5F 20 F1       	jr	nz,setaErro	; BUSY em 1, informar erro
1368   4C61 C9          	ret			; sem erros
1369   4C62             
1370   4C62             ; ------------------------------------------------
1371   4C62             ; Enviar comando em A com 2 bytes de parametros
1372   4C62             ; em DE e ler resposta do tipo R3 em BC DE
1373   4C62             ; Retorna em A a resposta do cartao
1374   4C62             ; Destroi AF, BC, DE, HL
1375   4C62             ; ------------------------------------------------
1376   4C62             SD_SEND_CMD_2_ARGS_GET_R3: 
1377   4C62 CD 55 4C    	call	SD_SEND_CMD_2_ARGS_TEST_BUSY
1378   4C65 D8          	ret	c
1379   4C66 F5          	push	af
1380   4C67 CD A7 4C    	call	WAIT_RESP_NO_FF
1381   4C6A 67          	ld	h, a
1382   4C6B CD A7 4C    	call	WAIT_RESP_NO_FF
1383   4C6E 6F          	ld	l, a
1384   4C6F CD A7 4C    	call	WAIT_RESP_NO_FF
1385   4C72 57          	ld	d, a
1386   4C73 CD A7 4C    	call	WAIT_RESP_NO_FF
1387   4C76 5F          	ld	e, a
1388   4C77 44          	ld	b, h
1389   4C78 4D          	ld	c, l
1390   4C79 F1          	pop	af
1391   4C7A C9          	ret
1392   4C7B             
1393   4C7B             ; ------------------------------------------------
1394   4C7B             ; Enviar comando em A com 4 bytes de parametros
1395   4C7B             ; em BC DE e enviar CRC correto se for CMD0 ou 
1396   4C7B             ; CMD8 e aguardar processamento do cartao
1397   4C7B             ; Output  : A=0 if there was no error
1398   4C7B             ; Modifies:  AF, B, AF'
1399   4C7B             ; ------------------------------------------------
1400   4C7B             SD_SEND_CMD: 
1401   4C7B 08          	ex	af,af'
1402   4C7C CD D3 4C    	call	setaSDAtual
1403   4C7F 08          	ex	af,af'
1404   4C80 32 00 40    	ld	(PORTSPI), a
1405   4C83 08          	ex	af,af'
1406   4C84 78          	ld	a, b
1407   4C85 32 00 40    	ld	(PORTSPI), a
1408   4C88 79          	ld	a, c
1409   4C89 32 00 40    	ld	(PORTSPI), a
1410   4C8C 7A          	ld	a, d
1411   4C8D 32 00 40    	ld	(PORTSPI), a
1412   4C90 7B          	ld	a, e
1413   4C91 32 00 40    	ld	(PORTSPI), a
1414   4C94 08          	ex	af,af'
1415   4C95 FE 40       	cp	CMD0
1416   4C97 06 95       	ld	b, $95		; CRC para CMD0
1417   4C99 28 08       	jr	z,enviaCRC
1418   4C9B FE 48       	cp	CMD8
1419   4C9D 06 87       	ld	b, $87		; CRC para CMD8
1420   4C9F 28 02       	jr	z,enviaCRC
1421   4CA1 06 FF       	ld	b, $FF		; CRC dummy
1422   4CA3             enviaCRC: 
1423   4CA3 78          	ld	a, b
1424   4CA4 32 00 40    	ld	(PORTSPI), a
1425   4CA7             ;	jr	WAIT_RESP_NO_FF
1426   4CA7             
1427   4CA7             ; ------------------------------------------------
1428   4CA7             ; Esperar que resposta do cartao seja diferente
1429   4CA7             ; de $FF
1430   4CA7             ; Destroi AF, BC
1431   4CA7             ; ------------------------------------------------
1432   4CA7             WAIT_RESP_NO_FF: 
1433   4CA7 01 01 00    	ld	bc, 1		; 256 tentativas
1434   4CAA             .loop: 
1435   4CAA 3A 00 40    	ld	a, (PORTSPI)
1436   4CAD FE FF       	cp	$FF		; testa $FF
1437   4CAF C0          	ret	nz		; sai se nao for $FF
1438   4CB0 10 F8       	djnz	.loop
1439   4CB2 0D          	dec	c
1440   4CB3 20 F5       	jr	nz,.loop
1441   4CB5 C9          	ret
1442   4CB6             
1443   4CB6             ; ------------------------------------------------
1444   4CB6             ; Esperar que resposta do cartao seja $FE
1445   4CB6             ; Destroi AF, B
1446   4CB6             ; ------------------------------------------------
1447   4CB6             WAIT_RESP_FE: 
1448   4CB6 06 0A       	ld	b, 10		; 10 tentativas
1449   4CB8             .loop: 
1450   4CB8 C5          	push	bc
1451   4CB9 CD A7 4C    	call	WAIT_RESP_NO_FF	; esperar resposta diferente de $FF
1452   4CBC C1          	pop	bc
1453   4CBD FE FE       	cp	$FE		; resposta  $FE ?
1454   4CBF C8          	ret	z		; sim, retornamos com carry=0
1455   4CC0 10 F6       	djnz	.loop
1456   4CC2 37          	scf			; erro, carry=1
1457   4CC3 C9          	ret
1458   4CC4             
1459   4CC4             ; ------------------------------------------------
1460   4CC4             ; Esperar que resposta do cartao seja diferente
1461   4CC4             ; de $00
1462   4CC4             ; Destroi A, BC
1463   4CC4             ; ------------------------------------------------
1464   4CC4             WAIT_RESP_NO_00: 
1465   4CC4 01 80 00    	ld	bc, 128		; 32768 tentativas
1466   4CC7             .loop: 
1467   4CC7 3A 00 40    	ld	a, (PORTSPI)
1468   4CCA B7          	or	a
1469   4CCB C0          	ret	nz			; se resposta for <> $00, sai
1470   4CCC 10 F9       	djnz	.loop
1471   4CCE 0D          	dec	c
1472   4CCF 20 F6       	jr	nz,.loop
1473   4CD1 37          	scf			; erro
1474   4CD2 C9          	ret
1475   4CD3             
1476   4CD3             ; ------------------------------------------------
1477   4CD3             ; Ativa (seleciona) cartao atual baixando seu /CS
1478   4CD3             ; Modify: AF 
1479   4CD3             ; ------------------------------------------------
1480   4CD3             setaSDAtual: 
1481   4CD3 3A 00 40    	ld	a, (PORTSPI)	; dummy read
1482   4CD6 FD 7E 30    	ld	a, (iy+WRKAREA.NUMSD)
1483   4CD9 2F          	cpl			; inverte bits
1484   4CDA 32 00 48    	ld	(PORTCFG), a
1485   4CDD C9          	ret
1486   4CDE             
1487   4CDE             ; ------------------------------------------------
1488   4CDE             ; Grava um bloco de 512 bytes no cartao
1489   4CDE             ; HL aponta para o inicio dos dados
1490   4CDE             ; BC e DE contem o numero do bloco (BCDE = 32 bits)
1491   4CDE             ; Modifies:  AF, BC, DE, HL, IXL
1492   4CDE             ; ------------------------------------------------
1493   4CDE             GravarBloco: 
1494   4CDE DD 2D       	dec	ixl		; SDcard V1?
1495   4CE0 FC 7C 5E    	call	m,blocoParaByte	; Yes, convert blocks to bytes 
1496   4CE3 CD D3 4C    	call	setaSDAtual	; selecionar cartao atual
1497   4CE6 DD 7C       	ld	a,ixh		; get Number of blocks to write
1498   4CE8 3D          	dec	a
1499   4CE9 CA A5 51    	jp	z,.umBloco	; somente um bloco, gravar usando CMD24
1500   4CEC             
1501   4CEC             ; multiplos blocos
1502   4CEC D9          	exx
1503   4CED 3E 77       	ld	a, CMD55	; Multiplos blocos, mandar ACMD23 com total de blocos
1504   4CEF CD 48 4C    	call	SD_SEND_CMD_NO_ARGS
1505   4CF2 3E 57       	ld	a, ACMD23
1506   4CF4 01 00 00    	ld	bc, 0
1507   4CF7 51          	ld	d, c
1508   4CF8 DD 5C       	ld	e,ixh		; e=Number of blocks to write
1509   4CFA CD 7B 4C    	call	SD_SEND_CMD
1510   4CFD B7          	or	a
1511   4CFE 20 55       	jr	nz,.erroEscritaBlocoR	; erro no ACMD23
1512   4D00 D9          	exx
1513   4D01 3E 59       	ld	a, CMD25	; CMD25 = write multiple blocks
1514   4D03 CD 7B 4C    	call	SD_SEND_CMD
1515   4D06 B7          	or	a
1516   4D07 20 4C       	jr	nz,.erroEscritaBlocoR	; erro
1517   4D09             
1518   4D09             	; Check for a Z80 or R800
1519   4D09 EB          	ex	de,hl
1520   4D0A             ;	ld	a,20
1521   4D0A 3D          	dec	a		; a=#FF
1522   4D0B ED F9       	db	#ED,#F9		; mulub a,a
1523   4D0D EB          	ex	de,hl
1524   4D0E 30 50       	jr	nc,.loopZ80	; Use the Z80 optimized loop
1525   4D10             
1526   4D10 D9          	exx
1527   4D11 CD 7F 60    	call	GTR800LDIR
1528   4D14 D9          	exx			; hl'=Pointer to R800LDIR helper routine
1529   4D15             .loopR800: 	; R800 optimized loop
1530   4D15 11 00 40    	ld	de,PORTSPI
1531   4D18 3E FC       	ld	a, $FC		; mandar $FC para indicar que os proximos dados
1532   4D1A 12          	ld	(de),a		; sao para gravacao
1533   4D1B CD 88 5E    	call	R800LDIR
1534   4D1E 32 00 40    	ld	(PORTSPI),a	; Send a dummy 16bit CRC
1535   4D21 32 00 40    	ld	(PORTSPI),a
1536   4D24             ; Wait for !FFh
1537   4D24 06 05       	ld	b,5		; 5*5ms = 250ms
1538   4D26             .rwaitnoFFext: 
1539   4D26 DB E7       	in	a,(#E7)
1540   4D28 4F          	ld	c,a
1541   4D29             .rwaitnoFF: 
1542   4D29 3A 00 40    	ld	a,(PORTSPI)
1543   4D2C FE FF       	cp	$FF		; a=FF?
1544   4D2E 20 0B       	jr	nz,.rnoFFok
1545   4D30 DB E7       	in	a,(#E7)
1546   4D32 91          	sub	c
1547   4D33 FE 32       	cp	50		; 50mS?
1548   4D35 38 F2       	jr	c,.rwaitnoFF	; wait 50ms
1549   4D37 10 F0       	djnz	.rwaitnoFF	; x50ms wait
1550   4D39 18 1A       	jr	.erroEscritaBlocoR	; error: timeout
1551   4D3B             .rnoFFok: 
1552   4D3B E6 1F       	and	$1F		; testa bits erro
1553   4D3D FE 05       	cp	5
1554   4D3F 20 14       	jr	nz,.erroEscritaBlocoR	; resposta errada, informar erro
1555   4D41             ; Wait for !00h
1556   4D41 06 05       	ld	b,5		; 5*50ms = 250ms
1557   4D43             .rwaitno00ext: 
1558   4D43 DB E7       	in	a,(#E7)
1559   4D45 4F          	ld	c,a
1560   4D46             .rwaitno00: 
1561   4D46 3A 00 40    	ld	a,(PORTSPI)
1562   4D49 B7          	or	a
1563   4D4A 20 0D       	jr	nz,.rno00ok
1564   4D4C DB E7       	in	a,(#E7)
1565   4D4E 91          	sub	c
1566   4D4F FE 32       	cp	50		; 50ms
1567   4D51 38 F3       	jr	c,.rwaitno00	; wait 50ms
1568   4D53 10 EE       	djnz	.rwaitno00ext	; x50 ms wait
1569   4D55             .erroEscritaBlocoR:  ; Trick to save some cycles inside the block transfer loop
1570   4D55 37          	scf
1571   4D56 C3 D4 55    	jp	terminaLeituraEscritaBloco
1572   4D59             .rno00ok: 
1573   4D59 DD 25       	dec	ixh		; nblocks=nblocks-1
1574   4D5B 20 B8       	jr	nz,.loopR800
1575   4D5D C3 7F 51    	jp	.loopend
1576   4D60             
1577   4D60             
1578   4D60             .loopZ80: 	; Z80 optimized loop
1579   4D60 11 00 40    	ld	de,PORTSPI
1580   4D63 3E FC       	ld	a, $FC		; mandar $FC para indicar que os proximos dados
1581   4D65 12          	ld	(de),a		; sao para gravacao
1582   4D66 ED A0       > ldi		
1582   4D68 ED A0       > ldi		
1582   4D6A ED A0       > ldi		
1582   4D6C ED A0       > ldi		
1582   4D6E ED A0       > ldi		
1582   4D70 ED A0       > ldi		
1582   4D72 ED A0       > ldi		
1582   4D74 ED A0       > ldi		
1582   4D76 ED A0       > ldi		
1582   4D78 ED A0       > ldi		
1582   4D7A ED A0       > ldi		
1582   4D7C ED A0       > ldi		
1582   4D7E ED A0       > ldi		
1582   4D80 ED A0       > ldi		
1582   4D82 ED A0       > ldi		
1582   4D84 ED A0       > ldi		
1582   4D86 ED A0       > ldi		
1582   4D88 ED A0       > ldi		
1582   4D8A ED A0       > ldi		
1582   4D8C ED A0       > ldi		
1582   4D8E ED A0       > ldi		
1582   4D90 ED A0       > ldi		
1582   4D92 ED A0       > ldi		
1582   4D94 ED A0       > ldi		
1582   4D96 ED A0       > ldi		
1582   4D98 ED A0       > ldi		
1582   4D9A ED A0       > ldi		
1582   4D9C ED A0       > ldi		
1582   4D9E ED A0       > ldi		
1582   4DA0 ED A0       > ldi		
1582   4DA2 ED A0       > ldi		
1582   4DA4 ED A0       > ldi		
1582   4DA6 ED A0       > ldi		
1582   4DA8 ED A0       > ldi		
1582   4DAA ED A0       > ldi		
1582   4DAC ED A0       > ldi		
1582   4DAE ED A0       > ldi		
1582   4DB0 ED A0       > ldi		
1582   4DB2 ED A0       > ldi		
1582   4DB4 ED A0       > ldi		
1582   4DB6 ED A0       > ldi		
1582   4DB8 ED A0       > ldi		
1582   4DBA ED A0       > ldi		
1582   4DBC ED A0       > ldi		
1582   4DBE ED A0       > ldi		
1582   4DC0 ED A0       > ldi		
1582   4DC2 ED A0       > ldi		
1582   4DC4 ED A0       > ldi		
1582   4DC6 ED A0       > ldi		
1582   4DC8 ED A0       > ldi		
1582   4DCA ED A0       > ldi		
1582   4DCC ED A0       > ldi		
1582   4DCE ED A0       > ldi		
1582   4DD0 ED A0       > ldi		
1582   4DD2 ED A0       > ldi		
1582   4DD4 ED A0       > ldi		
1582   4DD6 ED A0       > ldi		
1582   4DD8 ED A0       > ldi		
1582   4DDA ED A0       > ldi		
1582   4DDC ED A0       > ldi		
1582   4DDE ED A0       > ldi		
1582   4DE0 ED A0       > ldi		
1582   4DE2 ED A0       > ldi		
1582   4DE4 ED A0       > ldi		
1582   4DE6 ED A0       > ldi		
1582   4DE8 ED A0       > ldi		
1582   4DEA ED A0       > ldi		
1582   4DEC ED A0       > ldi		
1582   4DEE ED A0       > ldi		
1582   4DF0 ED A0       > ldi		
1582   4DF2 ED A0       > ldi		
1582   4DF4 ED A0       > ldi		
1582   4DF6 ED A0       > ldi		
1582   4DF8 ED A0       > ldi		
1582   4DFA ED A0       > ldi		
1582   4DFC ED A0       > ldi		
1582   4DFE ED A0       > ldi		
1582   4E00 ED A0       > ldi		
1582   4E02 ED A0       > ldi		
1582   4E04 ED A0       > ldi		
1582   4E06 ED A0       > ldi		
1582   4E08 ED A0       > ldi		
1582   4E0A ED A0       > ldi		
1582   4E0C ED A0       > ldi		
1582   4E0E ED A0       > ldi		
1582   4E10 ED A0       > ldi		
1582   4E12 ED A0       > ldi		
1582   4E14 ED A0       > ldi		
1582   4E16 ED A0       > ldi		
1582   4E18 ED A0       > ldi		
1582   4E1A ED A0       > ldi		
1582   4E1C ED A0       > ldi		
1582   4E1E ED A0       > ldi		
1582   4E20 ED A0       > ldi		
1582   4E22 ED A0       > ldi		
1582   4E24 ED A0       > ldi		
1582   4E26 ED A0       > ldi		
1582   4E28 ED A0       > ldi		
1582   4E2A ED A0       > ldi		
1582   4E2C ED A0       > ldi		
1582   4E2E ED A0       > ldi		
1582   4E30 ED A0       > ldi		
1582   4E32 ED A0       > ldi		
1582   4E34 ED A0       > ldi		
1582   4E36 ED A0       > ldi		
1582   4E38 ED A0       > ldi		
1582   4E3A ED A0       > ldi		
1582   4E3C ED A0       > ldi		
1582   4E3E ED A0       > ldi		
1582   4E40 ED A0       > ldi		
1582   4E42 ED A0       > ldi		
1582   4E44 ED A0       > ldi		
1582   4E46 ED A0       > ldi		
1582   4E48 ED A0       > ldi		
1582   4E4A ED A0       > ldi		
1582   4E4C ED A0       > ldi		
1582   4E4E ED A0       > ldi		
1582   4E50 ED A0       > ldi		
1582   4E52 ED A0       > ldi		
1582   4E54 ED A0       > ldi		
1582   4E56 ED A0       > ldi		
1582   4E58 ED A0       > ldi		
1582   4E5A ED A0       > ldi		
1582   4E5C ED A0       > ldi		
1582   4E5E ED A0       > ldi		
1582   4E60 ED A0       > ldi		
1582   4E62 ED A0       > ldi		
1582   4E64 ED A0       > ldi		
1582   4E66 ED A0       > ldi		
1582   4E68 ED A0       > ldi		
1582   4E6A ED A0       > ldi		
1582   4E6C ED A0       > ldi		
1582   4E6E ED A0       > ldi		
1582   4E70 ED A0       > ldi		
1582   4E72 ED A0       > ldi		
1582   4E74 ED A0       > ldi		
1582   4E76 ED A0       > ldi		
1582   4E78 ED A0       > ldi		
1582   4E7A ED A0       > ldi		
1582   4E7C ED A0       > ldi		
1582   4E7E ED A0       > ldi		
1582   4E80 ED A0       > ldi		
1582   4E82 ED A0       > ldi		
1582   4E84 ED A0       > ldi		
1582   4E86 ED A0       > ldi		
1582   4E88 ED A0       > ldi		
1582   4E8A ED A0       > ldi		
1582   4E8C ED A0       > ldi		
1582   4E8E ED A0       > ldi		
1582   4E90 ED A0       > ldi		
1582   4E92 ED A0       > ldi		
1582   4E94 ED A0       > ldi		
1582   4E96 ED A0       > ldi		
1582   4E98 ED A0       > ldi		
1582   4E9A ED A0       > ldi		
1582   4E9C ED A0       > ldi		
1582   4E9E ED A0       > ldi		
1582   4EA0 ED A0       > ldi		
1582   4EA2 ED A0       > ldi		
1582   4EA4 ED A0       > ldi		
1582   4EA6 ED A0       > ldi		
1582   4EA8 ED A0       > ldi		
1582   4EAA ED A0       > ldi		
1582   4EAC ED A0       > ldi		
1582   4EAE ED A0       > ldi		
1582   4EB0 ED A0       > ldi		
1582   4EB2 ED A0       > ldi		
1582   4EB4 ED A0       > ldi		
1582   4EB6 ED A0       > ldi		
1582   4EB8 ED A0       > ldi		
1582   4EBA ED A0       > ldi		
1582   4EBC ED A0       > ldi		
1582   4EBE ED A0       > ldi		
1582   4EC0 ED A0       > ldi		
1582   4EC2 ED A0       > ldi		
1582   4EC4 ED A0       > ldi		
1582   4EC6 ED A0       > ldi		
1582   4EC8 ED A0       > ldi		
1582   4ECA ED A0       > ldi		
1582   4ECC ED A0       > ldi		
1582   4ECE ED A0       > ldi		
1582   4ED0 ED A0       > ldi		
1582   4ED2 ED A0       > ldi		
1582   4ED4 ED A0       > ldi		
1582   4ED6 ED A0       > ldi		
1582   4ED8 ED A0       > ldi		
1582   4EDA ED A0       > ldi		
1582   4EDC ED A0       > ldi		
1582   4EDE ED A0       > ldi		
1582   4EE0 ED A0       > ldi		
1582   4EE2 ED A0       > ldi		
1582   4EE4 ED A0       > ldi		
1582   4EE6 ED A0       > ldi		
1582   4EE8 ED A0       > ldi		
1582   4EEA ED A0       > ldi		
1582   4EEC ED A0       > ldi		
1582   4EEE ED A0       > ldi		
1582   4EF0 ED A0       > ldi		
1582   4EF2 ED A0       > ldi		
1582   4EF4 ED A0       > ldi		
1582   4EF6 ED A0       > ldi		
1582   4EF8 ED A0       > ldi		
1582   4EFA ED A0       > ldi		
1582   4EFC ED A0       > ldi		
1582   4EFE ED A0       > ldi		
1582   4F00 ED A0       > ldi		
1582   4F02 ED A0       > ldi		
1582   4F04 ED A0       > ldi		
1582   4F06 ED A0       > ldi		
1582   4F08 ED A0       > ldi		
1582   4F0A ED A0       > ldi		
1582   4F0C ED A0       > ldi		
1582   4F0E ED A0       > ldi		
1582   4F10 ED A0       > ldi		
1582   4F12 ED A0       > ldi		
1582   4F14 ED A0       > ldi		
1582   4F16 ED A0       > ldi		
1582   4F18 ED A0       > ldi		
1582   4F1A ED A0       > ldi		
1582   4F1C ED A0       > ldi		
1582   4F1E ED A0       > ldi		
1582   4F20 ED A0       > ldi		
1582   4F22 ED A0       > ldi		
1582   4F24 ED A0       > ldi		
1582   4F26 ED A0       > ldi		
1582   4F28 ED A0       > ldi		
1582   4F2A ED A0       > ldi		
1582   4F2C ED A0       > ldi		
1582   4F2E ED A0       > ldi		
1582   4F30 ED A0       > ldi		
1582   4F32 ED A0       > ldi		
1582   4F34 ED A0       > ldi		
1582   4F36 ED A0       > ldi		
1582   4F38 ED A0       > ldi		
1582   4F3A ED A0       > ldi		
1582   4F3C ED A0       > ldi		
1582   4F3E ED A0       > ldi		
1582   4F40 ED A0       > ldi		
1582   4F42 ED A0       > ldi		
1582   4F44 ED A0       > ldi		
1582   4F46 ED A0       > ldi		
1582   4F48 ED A0       > ldi		
1582   4F4A ED A0       > ldi		
1582   4F4C ED A0       > ldi		
1582   4F4E ED A0       > ldi		
1582   4F50 ED A0       > ldi		
1582   4F52 ED A0       > ldi		
1582   4F54 ED A0       > ldi		
1582   4F56 ED A0       > ldi		
1582   4F58 ED A0       > ldi		
1582   4F5A ED A0       > ldi		
1582   4F5C ED A0       > ldi		
1582   4F5E ED A0       > ldi		
1582   4F60 ED A0       > ldi		
1582   4F62 ED A0       > ldi		
1582   4F64 ED A0       > ldi		
1582   4F66 ED A0       > ldi		
1582   4F68 ED A0       > ldi		
1582   4F6A ED A0       > ldi		
1582   4F6C ED A0       > ldi		
1582   4F6E ED A0       > ldi		
1582   4F70 ED A0       > ldi		
1582   4F72 ED A0       > ldi		
1582   4F74 ED A0       > ldi		
1582   4F76 ED A0       > ldi		
1582   4F78 ED A0       > ldi		
1582   4F7A ED A0       > ldi		
1582   4F7C ED A0       > ldi		
1582   4F7E ED A0       > ldi		
1582   4F80 ED A0       > ldi		
1582   4F82 ED A0       > ldi		
1582   4F84 ED A0       > ldi		
1582   4F86 ED A0       > ldi		
1582   4F88 ED A0       > ldi		
1582   4F8A ED A0       > ldi		
1582   4F8C ED A0       > ldi		
1582   4F8E ED A0       > ldi		
1582   4F90 ED A0       > ldi		
1582   4F92 ED A0       > ldi		
1582   4F94 ED A0       > ldi		
1582   4F96 ED A0       > ldi		
1582   4F98 ED A0       > ldi		
1582   4F9A ED A0       > ldi		
1582   4F9C ED A0       > ldi		
1582   4F9E ED A0       > ldi		
1582   4FA0 ED A0       > ldi		
1582   4FA2 ED A0       > ldi		
1582   4FA4 ED A0       > ldi		
1582   4FA6 ED A0       > ldi		
1582   4FA8 ED A0       > ldi		
1582   4FAA ED A0       > ldi		
1582   4FAC ED A0       > ldi		
1582   4FAE ED A0       > ldi		
1582   4FB0 ED A0       > ldi		
1582   4FB2 ED A0       > ldi		
1582   4FB4 ED A0       > ldi		
1582   4FB6 ED A0       > ldi		
1582   4FB8 ED A0       > ldi		
1582   4FBA ED A0       > ldi		
1582   4FBC ED A0       > ldi		
1582   4FBE ED A0       > ldi		
1582   4FC0 ED A0       > ldi		
1582   4FC2 ED A0       > ldi		
1582   4FC4 ED A0       > ldi		
1582   4FC6 ED A0       > ldi		
1582   4FC8 ED A0       > ldi		
1582   4FCA ED A0       > ldi		
1582   4FCC ED A0       > ldi		
1582   4FCE ED A0       > ldi		
1582   4FD0 ED A0       > ldi		
1582   4FD2 ED A0       > ldi		
1582   4FD4 ED A0       > ldi		
1582   4FD6 ED A0       > ldi		
1582   4FD8 ED A0       > ldi		
1582   4FDA ED A0       > ldi		
1582   4FDC ED A0       > ldi		
1582   4FDE ED A0       > ldi		
1582   4FE0 ED A0       > ldi		
1582   4FE2 ED A0       > ldi		
1582   4FE4 ED A0       > ldi		
1582   4FE6 ED A0       > ldi		
1582   4FE8 ED A0       > ldi		
1582   4FEA ED A0       > ldi		
1582   4FEC ED A0       > ldi		
1582   4FEE ED A0       > ldi		
1582   4FF0 ED A0       > ldi		
1582   4FF2 ED A0       > ldi		
1582   4FF4 ED A0       > ldi		
1582   4FF6 ED A0       > ldi		
1582   4FF8 ED A0       > ldi		
1582   4FFA ED A0       > ldi		
1582   4FFC ED A0       > ldi		
1582   4FFE ED A0       > ldi		
1582   5000 ED A0       > ldi		
1582   5002 ED A0       > ldi		
1582   5004 ED A0       > ldi		
1582   5006 ED A0       > ldi		
1582   5008 ED A0       > ldi		
1582   500A ED A0       > ldi		
1582   500C ED A0       > ldi		
1582   500E ED A0       > ldi		
1582   5010 ED A0       > ldi		
1582   5012 ED A0       > ldi		
1582   5014 ED A0       > ldi		
1582   5016 ED A0       > ldi		
1582   5018 ED A0       > ldi		
1582   501A ED A0       > ldi		
1582   501C ED A0       > ldi		
1582   501E ED A0       > ldi		
1582   5020 ED A0       > ldi		
1582   5022 ED A0       > ldi		
1582   5024 ED A0       > ldi		
1582   5026 ED A0       > ldi		
1582   5028 ED A0       > ldi		
1582   502A ED A0       > ldi		
1582   502C ED A0       > ldi		
1582   502E ED A0       > ldi		
1582   5030 ED A0       > ldi		
1582   5032 ED A0       > ldi		
1582   5034 ED A0       > ldi		
1582   5036 ED A0       > ldi		
1582   5038 ED A0       > ldi		
1582   503A ED A0       > ldi		
1582   503C ED A0       > ldi		
1582   503E ED A0       > ldi		
1582   5040 ED A0       > ldi		
1582   5042 ED A0       > ldi		
1582   5044 ED A0       > ldi		
1582   5046 ED A0       > ldi		
1582   5048 ED A0       > ldi		
1582   504A ED A0       > ldi		
1582   504C ED A0       > ldi		
1582   504E ED A0       > ldi		
1582   5050 ED A0       > ldi		
1582   5052 ED A0       > ldi		
1582   5054 ED A0       > ldi		
1582   5056 ED A0       > ldi		
1582   5058 ED A0       > ldi		
1582   505A ED A0       > ldi		
1582   505C ED A0       > ldi		
1582   505E ED A0       > ldi		
1582   5060 ED A0       > ldi		
1582   5062 ED A0       > ldi		
1582   5064 ED A0       > ldi		
1582   5066 ED A0       > ldi		
1582   5068 ED A0       > ldi		
1582   506A ED A0       > ldi		
1582   506C ED A0       > ldi		
1582   506E ED A0       > ldi		
1582   5070 ED A0       > ldi		
1582   5072 ED A0       > ldi		
1582   5074 ED A0       > ldi		
1582   5076 ED A0       > ldi		
1582   5078 ED A0       > ldi		
1582   507A ED A0       > ldi		
1582   507C ED A0       > ldi		
1582   507E ED A0       > ldi		
1582   5080 ED A0       > ldi		
1582   5082 ED A0       > ldi		
1582   5084 ED A0       > ldi		
1582   5086 ED A0       > ldi		
1582   5088 ED A0       > ldi		
1582   508A ED A0       > ldi		
1582   508C ED A0       > ldi		
1582   508E ED A0       > ldi		
1582   5090 ED A0       > ldi		
1582   5092 ED A0       > ldi		
1582   5094 ED A0       > ldi		
1582   5096 ED A0       > ldi		
1582   5098 ED A0       > ldi		
1582   509A ED A0       > ldi		
1582   509C ED A0       > ldi		
1582   509E ED A0       > ldi		
1582   50A0 ED A0       > ldi		
1582   50A2 ED A0       > ldi		
1582   50A4 ED A0       > ldi		
1582   50A6 ED A0       > ldi		
1582   50A8 ED A0       > ldi		
1582   50AA ED A0       > ldi		
1582   50AC ED A0       > ldi		
1582   50AE ED A0       > ldi		
1582   50B0 ED A0       > ldi		
1582   50B2 ED A0       > ldi		
1582   50B4 ED A0       > ldi		
1582   50B6 ED A0       > ldi		
1582   50B8 ED A0       > ldi		
1582   50BA ED A0       > ldi		
1582   50BC ED A0       > ldi		
1582   50BE ED A0       > ldi		
1582   50C0 ED A0       > ldi		
1582   50C2 ED A0       > ldi		
1582   50C4 ED A0       > ldi		
1582   50C6 ED A0       > ldi		
1582   50C8 ED A0       > ldi		
1582   50CA ED A0       > ldi		
1582   50CC ED A0       > ldi		
1582   50CE ED A0       > ldi		
1582   50D0 ED A0       > ldi		
1582   50D2 ED A0       > ldi		
1582   50D4 ED A0       > ldi		
1582   50D6 ED A0       > ldi		
1582   50D8 ED A0       > ldi		
1582   50DA ED A0       > ldi		
1582   50DC ED A0       > ldi		
1582   50DE ED A0       > ldi		
1582   50E0 ED A0       > ldi		
1582   50E2 ED A0       > ldi		
1582   50E4 ED A0       > ldi		
1582   50E6 ED A0       > ldi		
1582   50E8 ED A0       > ldi		
1582   50EA ED A0       > ldi		
1582   50EC ED A0       > ldi		
1582   50EE ED A0       > ldi		
1582   50F0 ED A0       > ldi		
1582   50F2 ED A0       > ldi		
1582   50F4 ED A0       > ldi		
1582   50F6 ED A0       > ldi		
1582   50F8 ED A0       > ldi		
1582   50FA ED A0       > ldi		
1582   50FC ED A0       > ldi		
1582   50FE ED A0       > ldi		
1582   5100 ED A0       > ldi		
1582   5102 ED A0       > ldi		
1582   5104 ED A0       > ldi		
1582   5106 ED A0       > ldi		
1582   5108 ED A0       > ldi		
1582   510A ED A0       > ldi		
1582   510C ED A0       > ldi		
1582   510E ED A0       > ldi		
1582   5110 ED A0       > ldi		
1582   5112 ED A0       > ldi		
1582   5114 ED A0       > ldi		
1582   5116 ED A0       > ldi		
1582   5118 ED A0       > ldi		
1582   511A ED A0       > ldi		
1582   511C ED A0       > ldi		
1582   511E ED A0       > ldi		
1582   5120 ED A0       > ldi		
1582   5122 ED A0       > ldi		
1582   5124 ED A0       > ldi		
1582   5126 ED A0       > ldi		
1582   5128 ED A0       > ldi		
1582   512A ED A0       > ldi		
1582   512C ED A0       > ldi		
1582   512E ED A0       > ldi		
1582   5130 ED A0       > ldi		
1582   5132 ED A0       > ldi		
1582   5134 ED A0       > ldi		
1582   5136 ED A0       > ldi		
1582   5138 ED A0       > ldi		
1582   513A ED A0       > ldi		
1582   513C ED A0       > ldi		
1582   513E ED A0       > ldi		
1582   5140 ED A0       > ldi		
1582   5142 ED A0       > ldi		
1582   5144 ED A0       > ldi		
1582   5146 ED A0       > ldi		
1582   5148 ED A0       > ldi		
1582   514A ED A0       > ldi		
1582   514C ED A0       > ldi		
1582   514E ED A0       > ldi		
1582   5150 ED A0       > ldi		
1582   5152 ED A0       > ldi		
1582   5154 ED A0       > ldi		
1582   5156 ED A0       > ldi		
1582   5158 ED A0       > ldi		
1582   515A ED A0       > ldi		
1582   515C ED A0       > ldi		
1582   515E ED A0       > ldi		
1582   5160 ED A0       > ldi		
1582   5162 ED A0       > ldi		
1582   5164 ED A0       > ldi		
1583   5166 32 00 40    	ld	(PORTSPI),a	; Send a dummy 16bit CRC
1584   5169 32 00 40    	ld	(PORTSPI),a
1585   516C CD A7 4C    	call	WAIT_RESP_NO_FF	; esperar cartao
1586   516F E6 1F       	and	$1F		; testa bits erro
1587   5171 FE 05       	cp	5
1588   5173 20 2C       	jr	nz,.erroEscritaBlocoZ	; resposta errada, informar erro
1589   5175 CD C4 4C    	call	WAIT_RESP_NO_00	; esperar cartao
1590   5178 38 27       	jr	c,.erroEscritaBlocoZ
1591   517A DD 25       	dec	ixh		; nblocks=nblocks-1
1592   517C C2 60 4D    	jp	nz,.loopZ80
1593   517F             .loopend: 
1594   517F 3A 00 40    	ld	a, (PORTSPI)	; acabou os blocos, fazer 2 dummy reads
1595   5182 3A 00 40    	ld	a, (PORTSPI)
1596   5185 3E FD       	ld	a, $FD		; enviar $FD para informar ao cartao que acabou os dados
1597   5187 32 00 40    	ld	(PORTSPI),a
1598   518A 3A 00 40    	ld	a, (PORTSPI)	; dummy reads
1599   518D 3A 00 40    	ld	a, (PORTSPI)
1600   5190 CD C4 4C    	call	WAIT_RESP_NO_00	; esperar cartao
1601   5193 C3 D3 55    	jp	.fim		; CMD25 concluido, sair informando nenhum erro
1602   5196             
1603   5196             
1604   5196             
1605   5196             .r800s: 
1606   5196 D9          	exx
1607   5197 CD 7F 60    	call	GTR800LDIR
1608   519A D9          	exx			; hl'=Pointer to R800LDIR helper routine
1609   519B CD 88 5E    	call	R800LDIR
1610   519E C3 BA 55    	jp	.part2s
1611   51A1             
1612   51A1             .erroEscritaBlocoZ:  ; Trick to save some cycles inside the block transfer loop
1613   51A1 37          	scf
1614   51A2 C3 D4 55    	jp	terminaLeituraEscritaBloco
1615   51A5             
1616   51A5             .umBloco: 
1617   51A5 3E 58       	ld	a, CMD24	; CMD24 = Write Single Block
1618   51A7 CD 4D 4C    	call	SD_SEND_CMD_GET_ERROR
1619   51AA DA D4 55    	jp	c,terminaLeituraEscritaBloco	; erro
1620   51AD             
1621   51AD             
1622   51AD 3E FE       	ld	a, $FE		; mandar $FE para indicar que vamos mandar dados para gravacao
1623   51AF 32 00 40    	ld	(PORTSPI),a
1624   51B2             
1625   51B2             	; Check for a Z80 or R800
1626   51B2             ;	ld	a,20
1627   51B2 ED F9       	db	#ED,#F9		; mulub a,a
1628   51B4 D9          	exx
1629   51B5 11 00 40    	ld	de,PORTSPI
1630   51B8 38 DC       	jr	c,.r800s	; Use LDIR for R800
1631   51BA ED A0       > ldi
1631   51BC ED A0       > ldi
1631   51BE ED A0       > ldi
1631   51C0 ED A0       > ldi
1631   51C2 ED A0       > ldi
1631   51C4 ED A0       > ldi
1631   51C6 ED A0       > ldi
1631   51C8 ED A0       > ldi
1631   51CA ED A0       > ldi
1631   51CC ED A0       > ldi
1631   51CE ED A0       > ldi
1631   51D0 ED A0       > ldi
1631   51D2 ED A0       > ldi
1631   51D4 ED A0       > ldi
1631   51D6 ED A0       > ldi
1631   51D8 ED A0       > ldi
1631   51DA ED A0       > ldi
1631   51DC ED A0       > ldi
1631   51DE ED A0       > ldi
1631   51E0 ED A0       > ldi
1631   51E2 ED A0       > ldi
1631   51E4 ED A0       > ldi
1631   51E6 ED A0       > ldi
1631   51E8 ED A0       > ldi
1631   51EA ED A0       > ldi
1631   51EC ED A0       > ldi
1631   51EE ED A0       > ldi
1631   51F0 ED A0       > ldi
1631   51F2 ED A0       > ldi
1631   51F4 ED A0       > ldi
1631   51F6 ED A0       > ldi
1631   51F8 ED A0       > ldi
1631   51FA ED A0       > ldi
1631   51FC ED A0       > ldi
1631   51FE ED A0       > ldi
1631   5200 ED A0       > ldi
1631   5202 ED A0       > ldi
1631   5204 ED A0       > ldi
1631   5206 ED A0       > ldi
1631   5208 ED A0       > ldi
1631   520A ED A0       > ldi
1631   520C ED A0       > ldi
1631   520E ED A0       > ldi
1631   5210 ED A0       > ldi
1631   5212 ED A0       > ldi
1631   5214 ED A0       > ldi
1631   5216 ED A0       > ldi
1631   5218 ED A0       > ldi
1631   521A ED A0       > ldi
1631   521C ED A0       > ldi
1631   521E ED A0       > ldi
1631   5220 ED A0       > ldi
1631   5222 ED A0       > ldi
1631   5224 ED A0       > ldi
1631   5226 ED A0       > ldi
1631   5228 ED A0       > ldi
1631   522A ED A0       > ldi
1631   522C ED A0       > ldi
1631   522E ED A0       > ldi
1631   5230 ED A0       > ldi
1631   5232 ED A0       > ldi
1631   5234 ED A0       > ldi
1631   5236 ED A0       > ldi
1631   5238 ED A0       > ldi
1631   523A ED A0       > ldi
1631   523C ED A0       > ldi
1631   523E ED A0       > ldi
1631   5240 ED A0       > ldi
1631   5242 ED A0       > ldi
1631   5244 ED A0       > ldi
1631   5246 ED A0       > ldi
1631   5248 ED A0       > ldi
1631   524A ED A0       > ldi
1631   524C ED A0       > ldi
1631   524E ED A0       > ldi
1631   5250 ED A0       > ldi
1631   5252 ED A0       > ldi
1631   5254 ED A0       > ldi
1631   5256 ED A0       > ldi
1631   5258 ED A0       > ldi
1631   525A ED A0       > ldi
1631   525C ED A0       > ldi
1631   525E ED A0       > ldi
1631   5260 ED A0       > ldi
1631   5262 ED A0       > ldi
1631   5264 ED A0       > ldi
1631   5266 ED A0       > ldi
1631   5268 ED A0       > ldi
1631   526A ED A0       > ldi
1631   526C ED A0       > ldi
1631   526E ED A0       > ldi
1631   5270 ED A0       > ldi
1631   5272 ED A0       > ldi
1631   5274 ED A0       > ldi
1631   5276 ED A0       > ldi
1631   5278 ED A0       > ldi
1631   527A ED A0       > ldi
1631   527C ED A0       > ldi
1631   527E ED A0       > ldi
1631   5280 ED A0       > ldi
1631   5282 ED A0       > ldi
1631   5284 ED A0       > ldi
1631   5286 ED A0       > ldi
1631   5288 ED A0       > ldi
1631   528A ED A0       > ldi
1631   528C ED A0       > ldi
1631   528E ED A0       > ldi
1631   5290 ED A0       > ldi
1631   5292 ED A0       > ldi
1631   5294 ED A0       > ldi
1631   5296 ED A0       > ldi
1631   5298 ED A0       > ldi
1631   529A ED A0       > ldi
1631   529C ED A0       > ldi
1631   529E ED A0       > ldi
1631   52A0 ED A0       > ldi
1631   52A2 ED A0       > ldi
1631   52A4 ED A0       > ldi
1631   52A6 ED A0       > ldi
1631   52A8 ED A0       > ldi
1631   52AA ED A0       > ldi
1631   52AC ED A0       > ldi
1631   52AE ED A0       > ldi
1631   52B0 ED A0       > ldi
1631   52B2 ED A0       > ldi
1631   52B4 ED A0       > ldi
1631   52B6 ED A0       > ldi
1631   52B8 ED A0       > ldi
1631   52BA ED A0       > ldi
1631   52BC ED A0       > ldi
1631   52BE ED A0       > ldi
1631   52C0 ED A0       > ldi
1631   52C2 ED A0       > ldi
1631   52C4 ED A0       > ldi
1631   52C6 ED A0       > ldi
1631   52C8 ED A0       > ldi
1631   52CA ED A0       > ldi
1631   52CC ED A0       > ldi
1631   52CE ED A0       > ldi
1631   52D0 ED A0       > ldi
1631   52D2 ED A0       > ldi
1631   52D4 ED A0       > ldi
1631   52D6 ED A0       > ldi
1631   52D8 ED A0       > ldi
1631   52DA ED A0       > ldi
1631   52DC ED A0       > ldi
1631   52DE ED A0       > ldi
1631   52E0 ED A0       > ldi
1631   52E2 ED A0       > ldi
1631   52E4 ED A0       > ldi
1631   52E6 ED A0       > ldi
1631   52E8 ED A0       > ldi
1631   52EA ED A0       > ldi
1631   52EC ED A0       > ldi
1631   52EE ED A0       > ldi
1631   52F0 ED A0       > ldi
1631   52F2 ED A0       > ldi
1631   52F4 ED A0       > ldi
1631   52F6 ED A0       > ldi
1631   52F8 ED A0       > ldi
1631   52FA ED A0       > ldi
1631   52FC ED A0       > ldi
1631   52FE ED A0       > ldi
1631   5300 ED A0       > ldi
1631   5302 ED A0       > ldi
1631   5304 ED A0       > ldi
1631   5306 ED A0       > ldi
1631   5308 ED A0       > ldi
1631   530A ED A0       > ldi
1631   530C ED A0       > ldi
1631   530E ED A0       > ldi
1631   5310 ED A0       > ldi
1631   5312 ED A0       > ldi
1631   5314 ED A0       > ldi
1631   5316 ED A0       > ldi
1631   5318 ED A0       > ldi
1631   531A ED A0       > ldi
1631   531C ED A0       > ldi
1631   531E ED A0       > ldi
1631   5320 ED A0       > ldi
1631   5322 ED A0       > ldi
1631   5324 ED A0       > ldi
1631   5326 ED A0       > ldi
1631   5328 ED A0       > ldi
1631   532A ED A0       > ldi
1631   532C ED A0       > ldi
1631   532E ED A0       > ldi
1631   5330 ED A0       > ldi
1631   5332 ED A0       > ldi
1631   5334 ED A0       > ldi
1631   5336 ED A0       > ldi
1631   5338 ED A0       > ldi
1631   533A ED A0       > ldi
1631   533C ED A0       > ldi
1631   533E ED A0       > ldi
1631   5340 ED A0       > ldi
1631   5342 ED A0       > ldi
1631   5344 ED A0       > ldi
1631   5346 ED A0       > ldi
1631   5348 ED A0       > ldi
1631   534A ED A0       > ldi
1631   534C ED A0       > ldi
1631   534E ED A0       > ldi
1631   5350 ED A0       > ldi
1631   5352 ED A0       > ldi
1631   5354 ED A0       > ldi
1631   5356 ED A0       > ldi
1631   5358 ED A0       > ldi
1631   535A ED A0       > ldi
1631   535C ED A0       > ldi
1631   535E ED A0       > ldi
1631   5360 ED A0       > ldi
1631   5362 ED A0       > ldi
1631   5364 ED A0       > ldi
1631   5366 ED A0       > ldi
1631   5368 ED A0       > ldi
1631   536A ED A0       > ldi
1631   536C ED A0       > ldi
1631   536E ED A0       > ldi
1631   5370 ED A0       > ldi
1631   5372 ED A0       > ldi
1631   5374 ED A0       > ldi
1631   5376 ED A0       > ldi
1631   5378 ED A0       > ldi
1631   537A ED A0       > ldi
1631   537C ED A0       > ldi
1631   537E ED A0       > ldi
1631   5380 ED A0       > ldi
1631   5382 ED A0       > ldi
1631   5384 ED A0       > ldi
1631   5386 ED A0       > ldi
1631   5388 ED A0       > ldi
1631   538A ED A0       > ldi
1631   538C ED A0       > ldi
1631   538E ED A0       > ldi
1631   5390 ED A0       > ldi
1631   5392 ED A0       > ldi
1631   5394 ED A0       > ldi
1631   5396 ED A0       > ldi
1631   5398 ED A0       > ldi
1631   539A ED A0       > ldi
1631   539C ED A0       > ldi
1631   539E ED A0       > ldi
1631   53A0 ED A0       > ldi
1631   53A2 ED A0       > ldi
1631   53A4 ED A0       > ldi
1631   53A6 ED A0       > ldi
1631   53A8 ED A0       > ldi
1631   53AA ED A0       > ldi
1631   53AC ED A0       > ldi
1631   53AE ED A0       > ldi
1631   53B0 ED A0       > ldi
1631   53B2 ED A0       > ldi
1631   53B4 ED A0       > ldi
1631   53B6 ED A0       > ldi
1631   53B8 ED A0       > ldi
1631   53BA ED A0       > ldi
1631   53BC ED A0       > ldi
1631   53BE ED A0       > ldi
1631   53C0 ED A0       > ldi
1631   53C2 ED A0       > ldi
1631   53C4 ED A0       > ldi
1631   53C6 ED A0       > ldi
1631   53C8 ED A0       > ldi
1631   53CA ED A0       > ldi
1631   53CC ED A0       > ldi
1631   53CE ED A0       > ldi
1631   53D0 ED A0       > ldi
1631   53D2 ED A0       > ldi
1631   53D4 ED A0       > ldi
1631   53D6 ED A0       > ldi
1631   53D8 ED A0       > ldi
1631   53DA ED A0       > ldi
1631   53DC ED A0       > ldi
1631   53DE ED A0       > ldi
1631   53E0 ED A0       > ldi
1631   53E2 ED A0       > ldi
1631   53E4 ED A0       > ldi
1631   53E6 ED A0       > ldi
1631   53E8 ED A0       > ldi
1631   53EA ED A0       > ldi
1631   53EC ED A0       > ldi
1631   53EE ED A0       > ldi
1631   53F0 ED A0       > ldi
1631   53F2 ED A0       > ldi
1631   53F4 ED A0       > ldi
1631   53F6 ED A0       > ldi
1631   53F8 ED A0       > ldi
1631   53FA ED A0       > ldi
1631   53FC ED A0       > ldi
1631   53FE ED A0       > ldi
1631   5400 ED A0       > ldi
1631   5402 ED A0       > ldi
1631   5404 ED A0       > ldi
1631   5406 ED A0       > ldi
1631   5408 ED A0       > ldi
1631   540A ED A0       > ldi
1631   540C ED A0       > ldi
1631   540E ED A0       > ldi
1631   5410 ED A0       > ldi
1631   5412 ED A0       > ldi
1631   5414 ED A0       > ldi
1631   5416 ED A0       > ldi
1631   5418 ED A0       > ldi
1631   541A ED A0       > ldi
1631   541C ED A0       > ldi
1631   541E ED A0       > ldi
1631   5420 ED A0       > ldi
1631   5422 ED A0       > ldi
1631   5424 ED A0       > ldi
1631   5426 ED A0       > ldi
1631   5428 ED A0       > ldi
1631   542A ED A0       > ldi
1631   542C ED A0       > ldi
1631   542E ED A0       > ldi
1631   5430 ED A0       > ldi
1631   5432 ED A0       > ldi
1631   5434 ED A0       > ldi
1631   5436 ED A0       > ldi
1631   5438 ED A0       > ldi
1631   543A ED A0       > ldi
1631   543C ED A0       > ldi
1631   543E ED A0       > ldi
1631   5440 ED A0       > ldi
1631   5442 ED A0       > ldi
1631   5444 ED A0       > ldi
1631   5446 ED A0       > ldi
1631   5448 ED A0       > ldi
1631   544A ED A0       > ldi
1631   544C ED A0       > ldi
1631   544E ED A0       > ldi
1631   5450 ED A0       > ldi
1631   5452 ED A0       > ldi
1631   5454 ED A0       > ldi
1631   5456 ED A0       > ldi
1631   5458 ED A0       > ldi
1631   545A ED A0       > ldi
1631   545C ED A0       > ldi
1631   545E ED A0       > ldi
1631   5460 ED A0       > ldi
1631   5462 ED A0       > ldi
1631   5464 ED A0       > ldi
1631   5466 ED A0       > ldi
1631   5468 ED A0       > ldi
1631   546A ED A0       > ldi
1631   546C ED A0       > ldi
1631   546E ED A0       > ldi
1631   5470 ED A0       > ldi
1631   5472 ED A0       > ldi
1631   5474 ED A0       > ldi
1631   5476 ED A0       > ldi
1631   5478 ED A0       > ldi
1631   547A ED A0       > ldi
1631   547C ED A0       > ldi
1631   547E ED A0       > ldi
1631   5480 ED A0       > ldi
1631   5482 ED A0       > ldi
1631   5484 ED A0       > ldi
1631   5486 ED A0       > ldi
1631   5488 ED A0       > ldi
1631   548A ED A0       > ldi
1631   548C ED A0       > ldi
1631   548E ED A0       > ldi
1631   5490 ED A0       > ldi
1631   5492 ED A0       > ldi
1631   5494 ED A0       > ldi
1631   5496 ED A0       > ldi
1631   5498 ED A0       > ldi
1631   549A ED A0       > ldi
1631   549C ED A0       > ldi
1631   549E ED A0       > ldi
1631   54A0 ED A0       > ldi
1631   54A2 ED A0       > ldi
1631   54A4 ED A0       > ldi
1631   54A6 ED A0       > ldi
1631   54A8 ED A0       > ldi
1631   54AA ED A0       > ldi
1631   54AC ED A0       > ldi
1631   54AE ED A0       > ldi
1631   54B0 ED A0       > ldi
1631   54B2 ED A0       > ldi
1631   54B4 ED A0       > ldi
1631   54B6 ED A0       > ldi
1631   54B8 ED A0       > ldi
1631   54BA ED A0       > ldi
1631   54BC ED A0       > ldi
1631   54BE ED A0       > ldi
1631   54C0 ED A0       > ldi
1631   54C2 ED A0       > ldi
1631   54C4 ED A0       > ldi
1631   54C6 ED A0       > ldi
1631   54C8 ED A0       > ldi
1631   54CA ED A0       > ldi
1631   54CC ED A0       > ldi
1631   54CE ED A0       > ldi
1631   54D0 ED A0       > ldi
1631   54D2 ED A0       > ldi
1631   54D4 ED A0       > ldi
1631   54D6 ED A0       > ldi
1631   54D8 ED A0       > ldi
1631   54DA ED A0       > ldi
1631   54DC ED A0       > ldi
1631   54DE ED A0       > ldi
1631   54E0 ED A0       > ldi
1631   54E2 ED A0       > ldi
1631   54E4 ED A0       > ldi
1631   54E6 ED A0       > ldi
1631   54E8 ED A0       > ldi
1631   54EA ED A0       > ldi
1631   54EC ED A0       > ldi
1631   54EE ED A0       > ldi
1631   54F0 ED A0       > ldi
1631   54F2 ED A0       > ldi
1631   54F4 ED A0       > ldi
1631   54F6 ED A0       > ldi
1631   54F8 ED A0       > ldi
1631   54FA ED A0       > ldi
1631   54FC ED A0       > ldi
1631   54FE ED A0       > ldi
1631   5500 ED A0       > ldi
1631   5502 ED A0       > ldi
1631   5504 ED A0       > ldi
1631   5506 ED A0       > ldi
1631   5508 ED A0       > ldi
1631   550A ED A0       > ldi
1631   550C ED A0       > ldi
1631   550E ED A0       > ldi
1631   5510 ED A0       > ldi
1631   5512 ED A0       > ldi
1631   5514 ED A0       > ldi
1631   5516 ED A0       > ldi
1631   5518 ED A0       > ldi
1631   551A ED A0       > ldi
1631   551C ED A0       > ldi
1631   551E ED A0       > ldi
1631   5520 ED A0       > ldi
1631   5522 ED A0       > ldi
1631   5524 ED A0       > ldi
1631   5526 ED A0       > ldi
1631   5528 ED A0       > ldi
1631   552A ED A0       > ldi
1631   552C ED A0       > ldi
1631   552E ED A0       > ldi
1631   5530 ED A0       > ldi
1631   5532 ED A0       > ldi
1631   5534 ED A0       > ldi
1631   5536 ED A0       > ldi
1631   5538 ED A0       > ldi
1631   553A ED A0       > ldi
1631   553C ED A0       > ldi
1631   553E ED A0       > ldi
1631   5540 ED A0       > ldi
1631   5542 ED A0       > ldi
1631   5544 ED A0       > ldi
1631   5546 ED A0       > ldi
1631   5548 ED A0       > ldi
1631   554A ED A0       > ldi
1631   554C ED A0       > ldi
1631   554E ED A0       > ldi
1631   5550 ED A0       > ldi
1631   5552 ED A0       > ldi
1631   5554 ED A0       > ldi
1631   5556 ED A0       > ldi
1631   5558 ED A0       > ldi
1631   555A ED A0       > ldi
1631   555C ED A0       > ldi
1631   555E ED A0       > ldi
1631   5560 ED A0       > ldi
1631   5562 ED A0       > ldi
1631   5564 ED A0       > ldi
1631   5566 ED A0       > ldi
1631   5568 ED A0       > ldi
1631   556A ED A0       > ldi
1631   556C ED A0       > ldi
1631   556E ED A0       > ldi
1631   5570 ED A0       > ldi
1631   5572 ED A0       > ldi
1631   5574 ED A0       > ldi
1631   5576 ED A0       > ldi
1631   5578 ED A0       > ldi
1631   557A ED A0       > ldi
1631   557C ED A0       > ldi
1631   557E ED A0       > ldi
1631   5580 ED A0       > ldi
1631   5582 ED A0       > ldi
1631   5584 ED A0       > ldi
1631   5586 ED A0       > ldi
1631   5588 ED A0       > ldi
1631   558A ED A0       > ldi
1631   558C ED A0       > ldi
1631   558E ED A0       > ldi
1631   5590 ED A0       > ldi
1631   5592 ED A0       > ldi
1631   5594 ED A0       > ldi
1631   5596 ED A0       > ldi
1631   5598 ED A0       > ldi
1631   559A ED A0       > ldi
1631   559C ED A0       > ldi
1631   559E ED A0       > ldi
1631   55A0 ED A0       > ldi
1631   55A2 ED A0       > ldi
1631   55A4 ED A0       > ldi
1631   55A6 ED A0       > ldi
1631   55A8 ED A0       > ldi
1631   55AA ED A0       > ldi
1631   55AC ED A0       > ldi
1631   55AE ED A0       > ldi
1631   55B0 ED A0       > ldi
1631   55B2 ED A0       > ldi
1631   55B4 ED A0       > ldi
1631   55B6 ED A0       > ldi
1631   55B8 ED A0       > ldi
1632   55BA             .part2s: 
1633   55BA 3E FF       	ld	a, $FF		; envia dummy CRC
1634   55BC 32 00 40    	ld	(PORTSPI),a
1635   55BF 32 00 40    	ld	(PORTSPI),a
1636   55C2 CD A7 4C    	call	WAIT_RESP_NO_FF	; esperar cartao
1637   55C5 E6 1F       	and	$1F		; testa bits erro
1638   55C7 FE 05       	cp	5
1639   55C9 37          	scf
1640   55CA C2 D4 55    	jp	nz,terminaLeituraEscritaBloco	; resposta errada, informar erro
1641   55CD             .esp: 
1642   55CD CD A7 4C    	call	WAIT_RESP_NO_FF	; esperar cartao
1643   55D0 B7          	or	a
1644   55D1 28 FA       	jr	z,.esp
1645   55D3             .fim: 
1646   55D3 AF          	xor	a		; zera carry e informa nenhum erro
1647   55D4             terminaLeituraEscritaBloco: 
1648   55D4 F5          	push	af
1649   55D5 CD 30 4C    	call	desabilitaSDs	; desabilitar todos os cartoes
1650   55D8 F1          	pop	af
1651   55D9 C9          	ret
1652   55DA             
1653   55DA             
1654   55DA             ; ------------------------------------------------
1655   55DA             ; Ler um bloco de 512 bytes do cartao
1656   55DA             ; HL aponta para o inicio dos dados
1657   55DA             ; BC e DE contem o numero do bloco (BCDE = 32 bits)
1658   55DA             ; Destroi AF, BC, DE, HL, IXL
1659   55DA             ; ------------------------------------------------
1660   55DA             LerBloco: 
1661   55DA DD 2D       	dec	ixl		; SDcard V1?
1662   55DC FC 7C 5E    	call	m,blocoParaByte	; Yes, convert blocks to bytes 
1663   55DF CD D3 4C    	call	setaSDAtual
1664   55E2 DD 7C       	ld	a,ixh		; get Number of blocks to write
1665   55E4 3D          	dec	a
1666   55E5 CA 5C 5A    	jp	z,.umBloco	; somente um bloco, pular
1667   55E8             
1668   55E8             ; multiplos blocos
1669   55E8 3E 52       	ld	a, CMD18	; CMD18 = Read Multiple Blocks
1670   55EA CD 4D 4C    	call	SD_SEND_CMD_GET_ERROR
1671   55ED 38 E5       	jr	c,terminaLeituraEscritaBloco
1672   55EF             
1673   55EF EB          	ex	de,hl		; de=destination address
1674   55F0             	; Check for a Z80 or R800
1675   55F0             ;	ld	a,20
1676   55F0 3D          	dec	a		; a=FFh
1677   55F1 ED F9       	db	#ED,#F9		; mulub a,a
1678   55F3 30 32       	jr	nc,.loopZ80	; Use the Z80 optimized loop
1679   55F5             
1680   55F5 D9          	exx
1681   55F6 CD 7F 60    	call	GTR800LDIR
1682   55F9 D9          	exx			; hl'=Pointer to R800LDIR helper routine
1683   55FA             .loopR800: 
1684   55FA 06 00       	ld	b,0
1685   55FC 3A E7 00    	ld	a,(#E7)
1686   55FF 4F          	ld	c,a
1687   5600             .rwaitFE: 
1688   5600 3A 00 40    	ld	a,(PORTSPI)
1689   5603 FE FE       	cp	$FE
1690   5605 28 0D       	jr	z,.rFEok
1691   5607 10 F7       	djnz	.rwaitFE	; fast card wait
1692   5609 3A E7 00    	ld	a,(#E7)
1693   560C 91          	sub	c
1694   560D FE 64       	cp	100		; 100mS?
1695   560F 38 EF       	jr	c,.rwaitFE	; slow card wait
1696   5611 37          	scf
1697   5612 18 C0       	jr	terminaLeituraEscritaBloco
1698   5614             .rFEok: 
1699   5614 21 00 40    	ld	hl,PORTSPI
1700   5617 CD 88 5E    	call	R800LDIR
1701   561A 3A 00 40    	ld	a, (PORTSPI)	; discard 16bit CRC
1702   561D 3A 00 40    	ld	a, (PORTSPI)
1703   5620 DD 25       	dec	ixh		; nblocks=nblocks-1
1704   5622 20 D6       	jr	nz,.loopR800
1705   5624 C3 49 5A    	jp	.loopend
1706   5627             
1707   5627             .loopZ80: 
1708   5627 01 00 00    	ld	bc,0
1709   562A             .zwaitFE: 
1710   562A 3A 00 40    	ld	a,(PORTSPI)
1711   562D FE FE       	cp	$FE
1712   562F 28 0A       	jr	z,.zFEok
1713   5631 10 F7       	djnz	.zwaitFE	; fast card wait
1714   5633 E3          	ex	(sp),hl
1715   5634 E3          	ex	(sp),hl
1716   5635 0D          	dec	c
1717   5636 20 F2       	jr	nz,.zwaitFE	; slow card wait
1718   5638 37          	scf
1719   5639 18 99       	jr	terminaLeituraEscritaBloco
1720   563B             .zFEok: 
1721   563B 21 00 40    	ld	hl,PORTSPI
1722   563E ED A0       > ldi
1722   5640 ED A0       > ldi
1722   5642 ED A0       > ldi
1722   5644 ED A0       > ldi
1722   5646 ED A0       > ldi
1722   5648 ED A0       > ldi
1722   564A ED A0       > ldi
1722   564C ED A0       > ldi
1722   564E ED A0       > ldi
1722   5650 ED A0       > ldi
1722   5652 ED A0       > ldi
1722   5654 ED A0       > ldi
1722   5656 ED A0       > ldi
1722   5658 ED A0       > ldi
1722   565A ED A0       > ldi
1722   565C ED A0       > ldi
1722   565E ED A0       > ldi
1722   5660 ED A0       > ldi
1722   5662 ED A0       > ldi
1722   5664 ED A0       > ldi
1722   5666 ED A0       > ldi
1722   5668 ED A0       > ldi
1722   566A ED A0       > ldi
1722   566C ED A0       > ldi
1722   566E ED A0       > ldi
1722   5670 ED A0       > ldi
1722   5672 ED A0       > ldi
1722   5674 ED A0       > ldi
1722   5676 ED A0       > ldi
1722   5678 ED A0       > ldi
1722   567A ED A0       > ldi
1722   567C ED A0       > ldi
1722   567E ED A0       > ldi
1722   5680 ED A0       > ldi
1722   5682 ED A0       > ldi
1722   5684 ED A0       > ldi
1722   5686 ED A0       > ldi
1722   5688 ED A0       > ldi
1722   568A ED A0       > ldi
1722   568C ED A0       > ldi
1722   568E ED A0       > ldi
1722   5690 ED A0       > ldi
1722   5692 ED A0       > ldi
1722   5694 ED A0       > ldi
1722   5696 ED A0       > ldi
1722   5698 ED A0       > ldi
1722   569A ED A0       > ldi
1722   569C ED A0       > ldi
1722   569E ED A0       > ldi
1722   56A0 ED A0       > ldi
1722   56A2 ED A0       > ldi
1722   56A4 ED A0       > ldi
1722   56A6 ED A0       > ldi
1722   56A8 ED A0       > ldi
1722   56AA ED A0       > ldi
1722   56AC ED A0       > ldi
1722   56AE ED A0       > ldi
1722   56B0 ED A0       > ldi
1722   56B2 ED A0       > ldi
1722   56B4 ED A0       > ldi
1722   56B6 ED A0       > ldi
1722   56B8 ED A0       > ldi
1722   56BA ED A0       > ldi
1722   56BC ED A0       > ldi
1722   56BE ED A0       > ldi
1722   56C0 ED A0       > ldi
1722   56C2 ED A0       > ldi
1722   56C4 ED A0       > ldi
1722   56C6 ED A0       > ldi
1722   56C8 ED A0       > ldi
1722   56CA ED A0       > ldi
1722   56CC ED A0       > ldi
1722   56CE ED A0       > ldi
1722   56D0 ED A0       > ldi
1722   56D2 ED A0       > ldi
1722   56D4 ED A0       > ldi
1722   56D6 ED A0       > ldi
1722   56D8 ED A0       > ldi
1722   56DA ED A0       > ldi
1722   56DC ED A0       > ldi
1722   56DE ED A0       > ldi
1722   56E0 ED A0       > ldi
1722   56E2 ED A0       > ldi
1722   56E4 ED A0       > ldi
1722   56E6 ED A0       > ldi
1722   56E8 ED A0       > ldi
1722   56EA ED A0       > ldi
1722   56EC ED A0       > ldi
1722   56EE ED A0       > ldi
1722   56F0 ED A0       > ldi
1722   56F2 ED A0       > ldi
1722   56F4 ED A0       > ldi
1722   56F6 ED A0       > ldi
1722   56F8 ED A0       > ldi
1722   56FA ED A0       > ldi
1722   56FC ED A0       > ldi
1722   56FE ED A0       > ldi
1722   5700 ED A0       > ldi
1722   5702 ED A0       > ldi
1722   5704 ED A0       > ldi
1722   5706 ED A0       > ldi
1722   5708 ED A0       > ldi
1722   570A ED A0       > ldi
1722   570C ED A0       > ldi
1722   570E ED A0       > ldi
1722   5710 ED A0       > ldi
1722   5712 ED A0       > ldi
1722   5714 ED A0       > ldi
1722   5716 ED A0       > ldi
1722   5718 ED A0       > ldi
1722   571A ED A0       > ldi
1722   571C ED A0       > ldi
1722   571E ED A0       > ldi
1722   5720 ED A0       > ldi
1722   5722 ED A0       > ldi
1722   5724 ED A0       > ldi
1722   5726 ED A0       > ldi
1722   5728 ED A0       > ldi
1722   572A ED A0       > ldi
1722   572C ED A0       > ldi
1722   572E ED A0       > ldi
1722   5730 ED A0       > ldi
1722   5732 ED A0       > ldi
1722   5734 ED A0       > ldi
1722   5736 ED A0       > ldi
1722   5738 ED A0       > ldi
1722   573A ED A0       > ldi
1722   573C ED A0       > ldi
1722   573E ED A0       > ldi
1722   5740 ED A0       > ldi
1722   5742 ED A0       > ldi
1722   5744 ED A0       > ldi
1722   5746 ED A0       > ldi
1722   5748 ED A0       > ldi
1722   574A ED A0       > ldi
1722   574C ED A0       > ldi
1722   574E ED A0       > ldi
1722   5750 ED A0       > ldi
1722   5752 ED A0       > ldi
1722   5754 ED A0       > ldi
1722   5756 ED A0       > ldi
1722   5758 ED A0       > ldi
1722   575A ED A0       > ldi
1722   575C ED A0       > ldi
1722   575E ED A0       > ldi
1722   5760 ED A0       > ldi
1722   5762 ED A0       > ldi
1722   5764 ED A0       > ldi
1722   5766 ED A0       > ldi
1722   5768 ED A0       > ldi
1722   576A ED A0       > ldi
1722   576C ED A0       > ldi
1722   576E ED A0       > ldi
1722   5770 ED A0       > ldi
1722   5772 ED A0       > ldi
1722   5774 ED A0       > ldi
1722   5776 ED A0       > ldi
1722   5778 ED A0       > ldi
1722   577A ED A0       > ldi
1722   577C ED A0       > ldi
1722   577E ED A0       > ldi
1722   5780 ED A0       > ldi
1722   5782 ED A0       > ldi
1722   5784 ED A0       > ldi
1722   5786 ED A0       > ldi
1722   5788 ED A0       > ldi
1722   578A ED A0       > ldi
1722   578C ED A0       > ldi
1722   578E ED A0       > ldi
1722   5790 ED A0       > ldi
1722   5792 ED A0       > ldi
1722   5794 ED A0       > ldi
1722   5796 ED A0       > ldi
1722   5798 ED A0       > ldi
1722   579A ED A0       > ldi
1722   579C ED A0       > ldi
1722   579E ED A0       > ldi
1722   57A0 ED A0       > ldi
1722   57A2 ED A0       > ldi
1722   57A4 ED A0       > ldi
1722   57A6 ED A0       > ldi
1722   57A8 ED A0       > ldi
1722   57AA ED A0       > ldi
1722   57AC ED A0       > ldi
1722   57AE ED A0       > ldi
1722   57B0 ED A0       > ldi
1722   57B2 ED A0       > ldi
1722   57B4 ED A0       > ldi
1722   57B6 ED A0       > ldi
1722   57B8 ED A0       > ldi
1722   57BA ED A0       > ldi
1722   57BC ED A0       > ldi
1722   57BE ED A0       > ldi
1722   57C0 ED A0       > ldi
1722   57C2 ED A0       > ldi
1722   57C4 ED A0       > ldi
1722   57C6 ED A0       > ldi
1722   57C8 ED A0       > ldi
1722   57CA ED A0       > ldi
1722   57CC ED A0       > ldi
1722   57CE ED A0       > ldi
1722   57D0 ED A0       > ldi
1722   57D2 ED A0       > ldi
1722   57D4 ED A0       > ldi
1722   57D6 ED A0       > ldi
1722   57D8 ED A0       > ldi
1722   57DA ED A0       > ldi
1722   57DC ED A0       > ldi
1722   57DE ED A0       > ldi
1722   57E0 ED A0       > ldi
1722   57E2 ED A0       > ldi
1722   57E4 ED A0       > ldi
1722   57E6 ED A0       > ldi
1722   57E8 ED A0       > ldi
1722   57EA ED A0       > ldi
1722   57EC ED A0       > ldi
1722   57EE ED A0       > ldi
1722   57F0 ED A0       > ldi
1722   57F2 ED A0       > ldi
1722   57F4 ED A0       > ldi
1722   57F6 ED A0       > ldi
1722   57F8 ED A0       > ldi
1722   57FA ED A0       > ldi
1722   57FC ED A0       > ldi
1722   57FE ED A0       > ldi
1722   5800 ED A0       > ldi
1722   5802 ED A0       > ldi
1722   5804 ED A0       > ldi
1722   5806 ED A0       > ldi
1722   5808 ED A0       > ldi
1722   580A ED A0       > ldi
1722   580C ED A0       > ldi
1722   580E ED A0       > ldi
1722   5810 ED A0       > ldi
1722   5812 ED A0       > ldi
1722   5814 ED A0       > ldi
1722   5816 ED A0       > ldi
1722   5818 ED A0       > ldi
1722   581A ED A0       > ldi
1722   581C ED A0       > ldi
1722   581E ED A0       > ldi
1722   5820 ED A0       > ldi
1722   5822 ED A0       > ldi
1722   5824 ED A0       > ldi
1722   5826 ED A0       > ldi
1722   5828 ED A0       > ldi
1722   582A ED A0       > ldi
1722   582C ED A0       > ldi
1722   582E ED A0       > ldi
1722   5830 ED A0       > ldi
1722   5832 ED A0       > ldi
1722   5834 ED A0       > ldi
1722   5836 ED A0       > ldi
1722   5838 ED A0       > ldi
1722   583A ED A0       > ldi
1722   583C ED A0       > ldi
1722   583E ED A0       > ldi
1722   5840 ED A0       > ldi
1722   5842 ED A0       > ldi
1722   5844 ED A0       > ldi
1722   5846 ED A0       > ldi
1722   5848 ED A0       > ldi
1722   584A ED A0       > ldi
1722   584C ED A0       > ldi
1722   584E ED A0       > ldi
1722   5850 ED A0       > ldi
1722   5852 ED A0       > ldi
1722   5854 ED A0       > ldi
1722   5856 ED A0       > ldi
1722   5858 ED A0       > ldi
1722   585A ED A0       > ldi
1722   585C ED A0       > ldi
1722   585E ED A0       > ldi
1722   5860 ED A0       > ldi
1722   5862 ED A0       > ldi
1722   5864 ED A0       > ldi
1722   5866 ED A0       > ldi
1722   5868 ED A0       > ldi
1722   586A ED A0       > ldi
1722   586C ED A0       > ldi
1722   586E ED A0       > ldi
1722   5870 ED A0       > ldi
1722   5872 ED A0       > ldi
1722   5874 ED A0       > ldi
1722   5876 ED A0       > ldi
1722   5878 ED A0       > ldi
1722   587A ED A0       > ldi
1722   587C ED A0       > ldi
1722   587E ED A0       > ldi
1722   5880 ED A0       > ldi
1722   5882 ED A0       > ldi
1722   5884 ED A0       > ldi
1722   5886 ED A0       > ldi
1722   5888 ED A0       > ldi
1722   588A ED A0       > ldi
1722   588C ED A0       > ldi
1722   588E ED A0       > ldi
1722   5890 ED A0       > ldi
1722   5892 ED A0       > ldi
1722   5894 ED A0       > ldi
1722   5896 ED A0       > ldi
1722   5898 ED A0       > ldi
1722   589A ED A0       > ldi
1722   589C ED A0       > ldi
1722   589E ED A0       > ldi
1722   58A0 ED A0       > ldi
1722   58A2 ED A0       > ldi
1722   58A4 ED A0       > ldi
1722   58A6 ED A0       > ldi
1722   58A8 ED A0       > ldi
1722   58AA ED A0       > ldi
1722   58AC ED A0       > ldi
1722   58AE ED A0       > ldi
1722   58B0 ED A0       > ldi
1722   58B2 ED A0       > ldi
1722   58B4 ED A0       > ldi
1722   58B6 ED A0       > ldi
1722   58B8 ED A0       > ldi
1722   58BA ED A0       > ldi
1722   58BC ED A0       > ldi
1722   58BE ED A0       > ldi
1722   58C0 ED A0       > ldi
1722   58C2 ED A0       > ldi
1722   58C4 ED A0       > ldi
1722   58C6 ED A0       > ldi
1722   58C8 ED A0       > ldi
1722   58CA ED A0       > ldi
1722   58CC ED A0       > ldi
1722   58CE ED A0       > ldi
1722   58D0 ED A0       > ldi
1722   58D2 ED A0       > ldi
1722   58D4 ED A0       > ldi
1722   58D6 ED A0       > ldi
1722   58D8 ED A0       > ldi
1722   58DA ED A0       > ldi
1722   58DC ED A0       > ldi
1722   58DE ED A0       > ldi
1722   58E0 ED A0       > ldi
1722   58E2 ED A0       > ldi
1722   58E4 ED A0       > ldi
1722   58E6 ED A0       > ldi
1722   58E8 ED A0       > ldi
1722   58EA ED A0       > ldi
1722   58EC ED A0       > ldi
1722   58EE ED A0       > ldi
1722   58F0 ED A0       > ldi
1722   58F2 ED A0       > ldi
1722   58F4 ED A0       > ldi
1722   58F6 ED A0       > ldi
1722   58F8 ED A0       > ldi
1722   58FA ED A0       > ldi
1722   58FC ED A0       > ldi
1722   58FE ED A0       > ldi
1722   5900 ED A0       > ldi
1722   5902 ED A0       > ldi
1722   5904 ED A0       > ldi
1722   5906 ED A0       > ldi
1722   5908 ED A0       > ldi
1722   590A ED A0       > ldi
1722   590C ED A0       > ldi
1722   590E ED A0       > ldi
1722   5910 ED A0       > ldi
1722   5912 ED A0       > ldi
1722   5914 ED A0       > ldi
1722   5916 ED A0       > ldi
1722   5918 ED A0       > ldi
1722   591A ED A0       > ldi
1722   591C ED A0       > ldi
1722   591E ED A0       > ldi
1722   5920 ED A0       > ldi
1722   5922 ED A0       > ldi
1722   5924 ED A0       > ldi
1722   5926 ED A0       > ldi
1722   5928 ED A0       > ldi
1722   592A ED A0       > ldi
1722   592C ED A0       > ldi
1722   592E ED A0       > ldi
1722   5930 ED A0       > ldi
1722   5932 ED A0       > ldi
1722   5934 ED A0       > ldi
1722   5936 ED A0       > ldi
1722   5938 ED A0       > ldi
1722   593A ED A0       > ldi
1722   593C ED A0       > ldi
1722   593E ED A0       > ldi
1722   5940 ED A0       > ldi
1722   5942 ED A0       > ldi
1722   5944 ED A0       > ldi
1722   5946 ED A0       > ldi
1722   5948 ED A0       > ldi
1722   594A ED A0       > ldi
1722   594C ED A0       > ldi
1722   594E ED A0       > ldi
1722   5950 ED A0       > ldi
1722   5952 ED A0       > ldi
1722   5954 ED A0       > ldi
1722   5956 ED A0       > ldi
1722   5958 ED A0       > ldi
1722   595A ED A0       > ldi
1722   595C ED A0       > ldi
1722   595E ED A0       > ldi
1722   5960 ED A0       > ldi
1722   5962 ED A0       > ldi
1722   5964 ED A0       > ldi
1722   5966 ED A0       > ldi
1722   5968 ED A0       > ldi
1722   596A ED A0       > ldi
1722   596C ED A0       > ldi
1722   596E ED A0       > ldi
1722   5970 ED A0       > ldi
1722   5972 ED A0       > ldi
1722   5974 ED A0       > ldi
1722   5976 ED A0       > ldi
1722   5978 ED A0       > ldi
1722   597A ED A0       > ldi
1722   597C ED A0       > ldi
1722   597E ED A0       > ldi
1722   5980 ED A0       > ldi
1722   5982 ED A0       > ldi
1722   5984 ED A0       > ldi
1722   5986 ED A0       > ldi
1722   5988 ED A0       > ldi
1722   598A ED A0       > ldi
1722   598C ED A0       > ldi
1722   598E ED A0       > ldi
1722   5990 ED A0       > ldi
1722   5992 ED A0       > ldi
1722   5994 ED A0       > ldi
1722   5996 ED A0       > ldi
1722   5998 ED A0       > ldi
1722   599A ED A0       > ldi
1722   599C ED A0       > ldi
1722   599E ED A0       > ldi
1722   59A0 ED A0       > ldi
1722   59A2 ED A0       > ldi
1722   59A4 ED A0       > ldi
1722   59A6 ED A0       > ldi
1722   59A8 ED A0       > ldi
1722   59AA ED A0       > ldi
1722   59AC ED A0       > ldi
1722   59AE ED A0       > ldi
1722   59B0 ED A0       > ldi
1722   59B2 ED A0       > ldi
1722   59B4 ED A0       > ldi
1722   59B6 ED A0       > ldi
1722   59B8 ED A0       > ldi
1722   59BA ED A0       > ldi
1722   59BC ED A0       > ldi
1722   59BE ED A0       > ldi
1722   59C0 ED A0       > ldi
1722   59C2 ED A0       > ldi
1722   59C4 ED A0       > ldi
1722   59C6 ED A0       > ldi
1722   59C8 ED A0       > ldi
1722   59CA ED A0       > ldi
1722   59CC ED A0       > ldi
1722   59CE ED A0       > ldi
1722   59D0 ED A0       > ldi
1722   59D2 ED A0       > ldi
1722   59D4 ED A0       > ldi
1722   59D6 ED A0       > ldi
1722   59D8 ED A0       > ldi
1722   59DA ED A0       > ldi
1722   59DC ED A0       > ldi
1722   59DE ED A0       > ldi
1722   59E0 ED A0       > ldi
1722   59E2 ED A0       > ldi
1722   59E4 ED A0       > ldi
1722   59E6 ED A0       > ldi
1722   59E8 ED A0       > ldi
1722   59EA ED A0       > ldi
1722   59EC ED A0       > ldi
1722   59EE ED A0       > ldi
1722   59F0 ED A0       > ldi
1722   59F2 ED A0       > ldi
1722   59F4 ED A0       > ldi
1722   59F6 ED A0       > ldi
1722   59F8 ED A0       > ldi
1722   59FA ED A0       > ldi
1722   59FC ED A0       > ldi
1722   59FE ED A0       > ldi
1722   5A00 ED A0       > ldi
1722   5A02 ED A0       > ldi
1722   5A04 ED A0       > ldi
1722   5A06 ED A0       > ldi
1722   5A08 ED A0       > ldi
1722   5A0A ED A0       > ldi
1722   5A0C ED A0       > ldi
1722   5A0E ED A0       > ldi
1722   5A10 ED A0       > ldi
1722   5A12 ED A0       > ldi
1722   5A14 ED A0       > ldi
1722   5A16 ED A0       > ldi
1722   5A18 ED A0       > ldi
1722   5A1A ED A0       > ldi
1722   5A1C ED A0       > ldi
1722   5A1E ED A0       > ldi
1722   5A20 ED A0       > ldi
1722   5A22 ED A0       > ldi
1722   5A24 ED A0       > ldi
1722   5A26 ED A0       > ldi
1722   5A28 ED A0       > ldi
1722   5A2A ED A0       > ldi
1722   5A2C ED A0       > ldi
1722   5A2E ED A0       > ldi
1722   5A30 ED A0       > ldi
1722   5A32 ED A0       > ldi
1722   5A34 ED A0       > ldi
1722   5A36 ED A0       > ldi
1722   5A38 ED A0       > ldi
1722   5A3A ED A0       > ldi
1722   5A3C ED A0       > ldi
1723   5A3E 3A 00 40    	ld	a, (PORTSPI)	; discard 16bit CRC
1724   5A41 3A 00 40    	ld	a, (PORTSPI)
1725   5A44 DD 25       	dec	ixh		; nblocks=nblocks-1
1726   5A46 C2 27 56    	jp	nz,.loopZ80
1727   5A49             .loopend: 
1728   5A49 3E 4C       	ld	a, CMD12	; acabou os blocos, mandar CMD12 para cancelar leitura
1729   5A4B CD 48 4C    	call	SD_SEND_CMD_NO_ARGS
1730   5A4E C3 78 5E    	jp	.fim
1731   5A51             
1732   5A51             .r800s: 	
1733   5A51 D9          	exx
1734   5A52 CD 7F 60    	call	GTR800LDIR
1735   5A55 D9          	exx			; hl'=Pointer to R800LDIR helper routine
1736   5A56 CD 88 5E    	call	R800LDIR
1737   5A59 C3 72 5E    	jp	.part2s
1738   5A5C             
1739   5A5C             .umBloco: 
1740   5A5C 3E 51       	ld	a, CMD17	; CMD17 = Read Single Block
1741   5A5E CD 4D 4C    	call	SD_SEND_CMD_GET_ERROR
1742   5A61 DA D4 55    	jp	c,terminaLeituraEscritaBloco
1743   5A64             
1744   5A64 CD B6 4C    	call	WAIT_RESP_FE
1745   5A67 DA D4 55    	jp	c,terminaLeituraEscritaBloco
1746   5A6A EB          	ex	de,hl
1747   5A6B             
1748   5A6B             	; Check for a Z80 or R800
1749   5A6B             ;	ld	a,20
1750   5A6B ED F9       	db	#ED,#F9		; mulub a,a
1751   5A6D 21 00 40    	ld	hl,PORTSPI
1752   5A70 38 DF       	jr	c,.r800s	; Use LDIR for R800
1753   5A72 ED A0       > ldi
1753   5A74 ED A0       > ldi
1753   5A76 ED A0       > ldi
1753   5A78 ED A0       > ldi
1753   5A7A ED A0       > ldi
1753   5A7C ED A0       > ldi
1753   5A7E ED A0       > ldi
1753   5A80 ED A0       > ldi
1753   5A82 ED A0       > ldi
1753   5A84 ED A0       > ldi
1753   5A86 ED A0       > ldi
1753   5A88 ED A0       > ldi
1753   5A8A ED A0       > ldi
1753   5A8C ED A0       > ldi
1753   5A8E ED A0       > ldi
1753   5A90 ED A0       > ldi
1753   5A92 ED A0       > ldi
1753   5A94 ED A0       > ldi
1753   5A96 ED A0       > ldi
1753   5A98 ED A0       > ldi
1753   5A9A ED A0       > ldi
1753   5A9C ED A0       > ldi
1753   5A9E ED A0       > ldi
1753   5AA0 ED A0       > ldi
1753   5AA2 ED A0       > ldi
1753   5AA4 ED A0       > ldi
1753   5AA6 ED A0       > ldi
1753   5AA8 ED A0       > ldi
1753   5AAA ED A0       > ldi
1753   5AAC ED A0       > ldi
1753   5AAE ED A0       > ldi
1753   5AB0 ED A0       > ldi
1753   5AB2 ED A0       > ldi
1753   5AB4 ED A0       > ldi
1753   5AB6 ED A0       > ldi
1753   5AB8 ED A0       > ldi
1753   5ABA ED A0       > ldi
1753   5ABC ED A0       > ldi
1753   5ABE ED A0       > ldi
1753   5AC0 ED A0       > ldi
1753   5AC2 ED A0       > ldi
1753   5AC4 ED A0       > ldi
1753   5AC6 ED A0       > ldi
1753   5AC8 ED A0       > ldi
1753   5ACA ED A0       > ldi
1753   5ACC ED A0       > ldi
1753   5ACE ED A0       > ldi
1753   5AD0 ED A0       > ldi
1753   5AD2 ED A0       > ldi
1753   5AD4 ED A0       > ldi
1753   5AD6 ED A0       > ldi
1753   5AD8 ED A0       > ldi
1753   5ADA ED A0       > ldi
1753   5ADC ED A0       > ldi
1753   5ADE ED A0       > ldi
1753   5AE0 ED A0       > ldi
1753   5AE2 ED A0       > ldi
1753   5AE4 ED A0       > ldi
1753   5AE6 ED A0       > ldi
1753   5AE8 ED A0       > ldi
1753   5AEA ED A0       > ldi
1753   5AEC ED A0       > ldi
1753   5AEE ED A0       > ldi
1753   5AF0 ED A0       > ldi
1753   5AF2 ED A0       > ldi
1753   5AF4 ED A0       > ldi
1753   5AF6 ED A0       > ldi
1753   5AF8 ED A0       > ldi
1753   5AFA ED A0       > ldi
1753   5AFC ED A0       > ldi
1753   5AFE ED A0       > ldi
1753   5B00 ED A0       > ldi
1753   5B02 ED A0       > ldi
1753   5B04 ED A0       > ldi
1753   5B06 ED A0       > ldi
1753   5B08 ED A0       > ldi
1753   5B0A ED A0       > ldi
1753   5B0C ED A0       > ldi
1753   5B0E ED A0       > ldi
1753   5B10 ED A0       > ldi
1753   5B12 ED A0       > ldi
1753   5B14 ED A0       > ldi
1753   5B16 ED A0       > ldi
1753   5B18 ED A0       > ldi
1753   5B1A ED A0       > ldi
1753   5B1C ED A0       > ldi
1753   5B1E ED A0       > ldi
1753   5B20 ED A0       > ldi
1753   5B22 ED A0       > ldi
1753   5B24 ED A0       > ldi
1753   5B26 ED A0       > ldi
1753   5B28 ED A0       > ldi
1753   5B2A ED A0       > ldi
1753   5B2C ED A0       > ldi
1753   5B2E ED A0       > ldi
1753   5B30 ED A0       > ldi
1753   5B32 ED A0       > ldi
1753   5B34 ED A0       > ldi
1753   5B36 ED A0       > ldi
1753   5B38 ED A0       > ldi
1753   5B3A ED A0       > ldi
1753   5B3C ED A0       > ldi
1753   5B3E ED A0       > ldi
1753   5B40 ED A0       > ldi
1753   5B42 ED A0       > ldi
1753   5B44 ED A0       > ldi
1753   5B46 ED A0       > ldi
1753   5B48 ED A0       > ldi
1753   5B4A ED A0       > ldi
1753   5B4C ED A0       > ldi
1753   5B4E ED A0       > ldi
1753   5B50 ED A0       > ldi
1753   5B52 ED A0       > ldi
1753   5B54 ED A0       > ldi
1753   5B56 ED A0       > ldi
1753   5B58 ED A0       > ldi
1753   5B5A ED A0       > ldi
1753   5B5C ED A0       > ldi
1753   5B5E ED A0       > ldi
1753   5B60 ED A0       > ldi
1753   5B62 ED A0       > ldi
1753   5B64 ED A0       > ldi
1753   5B66 ED A0       > ldi
1753   5B68 ED A0       > ldi
1753   5B6A ED A0       > ldi
1753   5B6C ED A0       > ldi
1753   5B6E ED A0       > ldi
1753   5B70 ED A0       > ldi
1753   5B72 ED A0       > ldi
1753   5B74 ED A0       > ldi
1753   5B76 ED A0       > ldi
1753   5B78 ED A0       > ldi
1753   5B7A ED A0       > ldi
1753   5B7C ED A0       > ldi
1753   5B7E ED A0       > ldi
1753   5B80 ED A0       > ldi
1753   5B82 ED A0       > ldi
1753   5B84 ED A0       > ldi
1753   5B86 ED A0       > ldi
1753   5B88 ED A0       > ldi
1753   5B8A ED A0       > ldi
1753   5B8C ED A0       > ldi
1753   5B8E ED A0       > ldi
1753   5B90 ED A0       > ldi
1753   5B92 ED A0       > ldi
1753   5B94 ED A0       > ldi
1753   5B96 ED A0       > ldi
1753   5B98 ED A0       > ldi
1753   5B9A ED A0       > ldi
1753   5B9C ED A0       > ldi
1753   5B9E ED A0       > ldi
1753   5BA0 ED A0       > ldi
1753   5BA2 ED A0       > ldi
1753   5BA4 ED A0       > ldi
1753   5BA6 ED A0       > ldi
1753   5BA8 ED A0       > ldi
1753   5BAA ED A0       > ldi
1753   5BAC ED A0       > ldi
1753   5BAE ED A0       > ldi
1753   5BB0 ED A0       > ldi
1753   5BB2 ED A0       > ldi
1753   5BB4 ED A0       > ldi
1753   5BB6 ED A0       > ldi
1753   5BB8 ED A0       > ldi
1753   5BBA ED A0       > ldi
1753   5BBC ED A0       > ldi
1753   5BBE ED A0       > ldi
1753   5BC0 ED A0       > ldi
1753   5BC2 ED A0       > ldi
1753   5BC4 ED A0       > ldi
1753   5BC6 ED A0       > ldi
1753   5BC8 ED A0       > ldi
1753   5BCA ED A0       > ldi
1753   5BCC ED A0       > ldi
1753   5BCE ED A0       > ldi
1753   5BD0 ED A0       > ldi
1753   5BD2 ED A0       > ldi
1753   5BD4 ED A0       > ldi
1753   5BD6 ED A0       > ldi
1753   5BD8 ED A0       > ldi
1753   5BDA ED A0       > ldi
1753   5BDC ED A0       > ldi
1753   5BDE ED A0       > ldi
1753   5BE0 ED A0       > ldi
1753   5BE2 ED A0       > ldi
1753   5BE4 ED A0       > ldi
1753   5BE6 ED A0       > ldi
1753   5BE8 ED A0       > ldi
1753   5BEA ED A0       > ldi
1753   5BEC ED A0       > ldi
1753   5BEE ED A0       > ldi
1753   5BF0 ED A0       > ldi
1753   5BF2 ED A0       > ldi
1753   5BF4 ED A0       > ldi
1753   5BF6 ED A0       > ldi
1753   5BF8 ED A0       > ldi
1753   5BFA ED A0       > ldi
1753   5BFC ED A0       > ldi
1753   5BFE ED A0       > ldi
1753   5C00 ED A0       > ldi
1753   5C02 ED A0       > ldi
1753   5C04 ED A0       > ldi
1753   5C06 ED A0       > ldi
1753   5C08 ED A0       > ldi
1753   5C0A ED A0       > ldi
1753   5C0C ED A0       > ldi
1753   5C0E ED A0       > ldi
1753   5C10 ED A0       > ldi
1753   5C12 ED A0       > ldi
1753   5C14 ED A0       > ldi
1753   5C16 ED A0       > ldi
1753   5C18 ED A0       > ldi
1753   5C1A ED A0       > ldi
1753   5C1C ED A0       > ldi
1753   5C1E ED A0       > ldi
1753   5C20 ED A0       > ldi
1753   5C22 ED A0       > ldi
1753   5C24 ED A0       > ldi
1753   5C26 ED A0       > ldi
1753   5C28 ED A0       > ldi
1753   5C2A ED A0       > ldi
1753   5C2C ED A0       > ldi
1753   5C2E ED A0       > ldi
1753   5C30 ED A0       > ldi
1753   5C32 ED A0       > ldi
1753   5C34 ED A0       > ldi
1753   5C36 ED A0       > ldi
1753   5C38 ED A0       > ldi
1753   5C3A ED A0       > ldi
1753   5C3C ED A0       > ldi
1753   5C3E ED A0       > ldi
1753   5C40 ED A0       > ldi
1753   5C42 ED A0       > ldi
1753   5C44 ED A0       > ldi
1753   5C46 ED A0       > ldi
1753   5C48 ED A0       > ldi
1753   5C4A ED A0       > ldi
1753   5C4C ED A0       > ldi
1753   5C4E ED A0       > ldi
1753   5C50 ED A0       > ldi
1753   5C52 ED A0       > ldi
1753   5C54 ED A0       > ldi
1753   5C56 ED A0       > ldi
1753   5C58 ED A0       > ldi
1753   5C5A ED A0       > ldi
1753   5C5C ED A0       > ldi
1753   5C5E ED A0       > ldi
1753   5C60 ED A0       > ldi
1753   5C62 ED A0       > ldi
1753   5C64 ED A0       > ldi
1753   5C66 ED A0       > ldi
1753   5C68 ED A0       > ldi
1753   5C6A ED A0       > ldi
1753   5C6C ED A0       > ldi
1753   5C6E ED A0       > ldi
1753   5C70 ED A0       > ldi
1753   5C72 ED A0       > ldi
1753   5C74 ED A0       > ldi
1753   5C76 ED A0       > ldi
1753   5C78 ED A0       > ldi
1753   5C7A ED A0       > ldi
1753   5C7C ED A0       > ldi
1753   5C7E ED A0       > ldi
1753   5C80 ED A0       > ldi
1753   5C82 ED A0       > ldi
1753   5C84 ED A0       > ldi
1753   5C86 ED A0       > ldi
1753   5C88 ED A0       > ldi
1753   5C8A ED A0       > ldi
1753   5C8C ED A0       > ldi
1753   5C8E ED A0       > ldi
1753   5C90 ED A0       > ldi
1753   5C92 ED A0       > ldi
1753   5C94 ED A0       > ldi
1753   5C96 ED A0       > ldi
1753   5C98 ED A0       > ldi
1753   5C9A ED A0       > ldi
1753   5C9C ED A0       > ldi
1753   5C9E ED A0       > ldi
1753   5CA0 ED A0       > ldi
1753   5CA2 ED A0       > ldi
1753   5CA4 ED A0       > ldi
1753   5CA6 ED A0       > ldi
1753   5CA8 ED A0       > ldi
1753   5CAA ED A0       > ldi
1753   5CAC ED A0       > ldi
1753   5CAE ED A0       > ldi
1753   5CB0 ED A0       > ldi
1753   5CB2 ED A0       > ldi
1753   5CB4 ED A0       > ldi
1753   5CB6 ED A0       > ldi
1753   5CB8 ED A0       > ldi
1753   5CBA ED A0       > ldi
1753   5CBC ED A0       > ldi
1753   5CBE ED A0       > ldi
1753   5CC0 ED A0       > ldi
1753   5CC2 ED A0       > ldi
1753   5CC4 ED A0       > ldi
1753   5CC6 ED A0       > ldi
1753   5CC8 ED A0       > ldi
1753   5CCA ED A0       > ldi
1753   5CCC ED A0       > ldi
1753   5CCE ED A0       > ldi
1753   5CD0 ED A0       > ldi
1753   5CD2 ED A0       > ldi
1753   5CD4 ED A0       > ldi
1753   5CD6 ED A0       > ldi
1753   5CD8 ED A0       > ldi
1753   5CDA ED A0       > ldi
1753   5CDC ED A0       > ldi
1753   5CDE ED A0       > ldi
1753   5CE0 ED A0       > ldi
1753   5CE2 ED A0       > ldi
1753   5CE4 ED A0       > ldi
1753   5CE6 ED A0       > ldi
1753   5CE8 ED A0       > ldi
1753   5CEA ED A0       > ldi
1753   5CEC ED A0       > ldi
1753   5CEE ED A0       > ldi
1753   5CF0 ED A0       > ldi
1753   5CF2 ED A0       > ldi
1753   5CF4 ED A0       > ldi
1753   5CF6 ED A0       > ldi
1753   5CF8 ED A0       > ldi
1753   5CFA ED A0       > ldi
1753   5CFC ED A0       > ldi
1753   5CFE ED A0       > ldi
1753   5D00 ED A0       > ldi
1753   5D02 ED A0       > ldi
1753   5D04 ED A0       > ldi
1753   5D06 ED A0       > ldi
1753   5D08 ED A0       > ldi
1753   5D0A ED A0       > ldi
1753   5D0C ED A0       > ldi
1753   5D0E ED A0       > ldi
1753   5D10 ED A0       > ldi
1753   5D12 ED A0       > ldi
1753   5D14 ED A0       > ldi
1753   5D16 ED A0       > ldi
1753   5D18 ED A0       > ldi
1753   5D1A ED A0       > ldi
1753   5D1C ED A0       > ldi
1753   5D1E ED A0       > ldi
1753   5D20 ED A0       > ldi
1753   5D22 ED A0       > ldi
1753   5D24 ED A0       > ldi
1753   5D26 ED A0       > ldi
1753   5D28 ED A0       > ldi
1753   5D2A ED A0       > ldi
1753   5D2C ED A0       > ldi
1753   5D2E ED A0       > ldi
1753   5D30 ED A0       > ldi
1753   5D32 ED A0       > ldi
1753   5D34 ED A0       > ldi
1753   5D36 ED A0       > ldi
1753   5D38 ED A0       > ldi
1753   5D3A ED A0       > ldi
1753   5D3C ED A0       > ldi
1753   5D3E ED A0       > ldi
1753   5D40 ED A0       > ldi
1753   5D42 ED A0       > ldi
1753   5D44 ED A0       > ldi
1753   5D46 ED A0       > ldi
1753   5D48 ED A0       > ldi
1753   5D4A ED A0       > ldi
1753   5D4C ED A0       > ldi
1753   5D4E ED A0       > ldi
1753   5D50 ED A0       > ldi
1753   5D52 ED A0       > ldi
1753   5D54 ED A0       > ldi
1753   5D56 ED A0       > ldi
1753   5D58 ED A0       > ldi
1753   5D5A ED A0       > ldi
1753   5D5C ED A0       > ldi
1753   5D5E ED A0       > ldi
1753   5D60 ED A0       > ldi
1753   5D62 ED A0       > ldi
1753   5D64 ED A0       > ldi
1753   5D66 ED A0       > ldi
1753   5D68 ED A0       > ldi
1753   5D6A ED A0       > ldi
1753   5D6C ED A0       > ldi
1753   5D6E ED A0       > ldi
1753   5D70 ED A0       > ldi
1753   5D72 ED A0       > ldi
1753   5D74 ED A0       > ldi
1753   5D76 ED A0       > ldi
1753   5D78 ED A0       > ldi
1753   5D7A ED A0       > ldi
1753   5D7C ED A0       > ldi
1753   5D7E ED A0       > ldi
1753   5D80 ED A0       > ldi
1753   5D82 ED A0       > ldi
1753   5D84 ED A0       > ldi
1753   5D86 ED A0       > ldi
1753   5D88 ED A0       > ldi
1753   5D8A ED A0       > ldi
1753   5D8C ED A0       > ldi
1753   5D8E ED A0       > ldi
1753   5D90 ED A0       > ldi
1753   5D92 ED A0       > ldi
1753   5D94 ED A0       > ldi
1753   5D96 ED A0       > ldi
1753   5D98 ED A0       > ldi
1753   5D9A ED A0       > ldi
1753   5D9C ED A0       > ldi
1753   5D9E ED A0       > ldi
1753   5DA0 ED A0       > ldi
1753   5DA2 ED A0       > ldi
1753   5DA4 ED A0       > ldi
1753   5DA6 ED A0       > ldi
1753   5DA8 ED A0       > ldi
1753   5DAA ED A0       > ldi
1753   5DAC ED A0       > ldi
1753   5DAE ED A0       > ldi
1753   5DB0 ED A0       > ldi
1753   5DB2 ED A0       > ldi
1753   5DB4 ED A0       > ldi
1753   5DB6 ED A0       > ldi
1753   5DB8 ED A0       > ldi
1753   5DBA ED A0       > ldi
1753   5DBC ED A0       > ldi
1753   5DBE ED A0       > ldi
1753   5DC0 ED A0       > ldi
1753   5DC2 ED A0       > ldi
1753   5DC4 ED A0       > ldi
1753   5DC6 ED A0       > ldi
1753   5DC8 ED A0       > ldi
1753   5DCA ED A0       > ldi
1753   5DCC ED A0       > ldi
1753   5DCE ED A0       > ldi
1753   5DD0 ED A0       > ldi
1753   5DD2 ED A0       > ldi
1753   5DD4 ED A0       > ldi
1753   5DD6 ED A0       > ldi
1753   5DD8 ED A0       > ldi
1753   5DDA ED A0       > ldi
1753   5DDC ED A0       > ldi
1753   5DDE ED A0       > ldi
1753   5DE0 ED A0       > ldi
1753   5DE2 ED A0       > ldi
1753   5DE4 ED A0       > ldi
1753   5DE6 ED A0       > ldi
1753   5DE8 ED A0       > ldi
1753   5DEA ED A0       > ldi
1753   5DEC ED A0       > ldi
1753   5DEE ED A0       > ldi
1753   5DF0 ED A0       > ldi
1753   5DF2 ED A0       > ldi
1753   5DF4 ED A0       > ldi
1753   5DF6 ED A0       > ldi
1753   5DF8 ED A0       > ldi
1753   5DFA ED A0       > ldi
1753   5DFC ED A0       > ldi
1753   5DFE ED A0       > ldi
1753   5E00 ED A0       > ldi
1753   5E02 ED A0       > ldi
1753   5E04 ED A0       > ldi
1753   5E06 ED A0       > ldi
1753   5E08 ED A0       > ldi
1753   5E0A ED A0       > ldi
1753   5E0C ED A0       > ldi
1753   5E0E ED A0       > ldi
1753   5E10 ED A0       > ldi
1753   5E12 ED A0       > ldi
1753   5E14 ED A0       > ldi
1753   5E16 ED A0       > ldi
1753   5E18 ED A0       > ldi
1753   5E1A ED A0       > ldi
1753   5E1C ED A0       > ldi
1753   5E1E ED A0       > ldi
1753   5E20 ED A0       > ldi
1753   5E22 ED A0       > ldi
1753   5E24 ED A0       > ldi
1753   5E26 ED A0       > ldi
1753   5E28 ED A0       > ldi
1753   5E2A ED A0       > ldi
1753   5E2C ED A0       > ldi
1753   5E2E ED A0       > ldi
1753   5E30 ED A0       > ldi
1753   5E32 ED A0       > ldi
1753   5E34 ED A0       > ldi
1753   5E36 ED A0       > ldi
1753   5E38 ED A0       > ldi
1753   5E3A ED A0       > ldi
1753   5E3C ED A0       > ldi
1753   5E3E ED A0       > ldi
1753   5E40 ED A0       > ldi
1753   5E42 ED A0       > ldi
1753   5E44 ED A0       > ldi
1753   5E46 ED A0       > ldi
1753   5E48 ED A0       > ldi
1753   5E4A ED A0       > ldi
1753   5E4C ED A0       > ldi
1753   5E4E ED A0       > ldi
1753   5E50 ED A0       > ldi
1753   5E52 ED A0       > ldi
1753   5E54 ED A0       > ldi
1753   5E56 ED A0       > ldi
1753   5E58 ED A0       > ldi
1753   5E5A ED A0       > ldi
1753   5E5C ED A0       > ldi
1753   5E5E ED A0       > ldi
1753   5E60 ED A0       > ldi
1753   5E62 ED A0       > ldi
1753   5E64 ED A0       > ldi
1753   5E66 ED A0       > ldi
1753   5E68 ED A0       > ldi
1753   5E6A ED A0       > ldi
1753   5E6C ED A0       > ldi
1753   5E6E ED A0       > ldi
1753   5E70 ED A0       > ldi
1754   5E72             .part2s: 
1755   5E72 3A 00 40    	ld	a, (PORTSPI)	; discard 16bit CRC
1756   5E75 3A 00 40    	ld	a, (PORTSPI)
1757   5E78             .fim: 
1758   5E78 AF          	xor	a		; zera carry para informar leitura sem erros
1759   5E79 C3 D4 55    	jp	terminaLeituraEscritaBloco
1760   5E7C             
1761   5E7C             
1762   5E7C             ; ------------------------------------------------
1763   5E7C             ; Converte blocos para bytes. Na pratica faz
1764   5E7C             ; BC DE = (BC DE) * 512
1765   5E7C             ; ------------------------------------------------
1766   5E7C             blocoParaByte: 
1767   5E7C 41          	ld	b, c
1768   5E7D 4A          	ld	c, d
1769   5E7E 53          	ld	d, e
1770   5E7F 1E 00       	ld	e, 0
1771   5E81 CB 22       	sla	d
1772   5E83 CB 11       	rl	c
1773   5E85 CB 10       	rl	b
1774   5E87 C9          	ret
1775   5E88             
1776   5E88             ; ------------------------------------------------
1777   5E88             R800LDIR: 
1778   5E88 D9          	exx
1779   5E89 E9          	jp	(hl)
1780   5E8A             
1781   5E8A             ; ------------------------------------------------
1782   5E8A             
1783   5E8A             
1784   5E8A             ; ========================================================================== 
1785   5E8A             ; Funcoes utilitarias
1786   5E8A             ; ========================================================================== 
1787   5E8A             
1788   5E8A             ; ------------------------------------------------
1789   5E8A             ; Chaveia para modo SPI
1790   5E8A             ; ------------------------------------------------
1791   5E8A             modoSPI: 
1792   5E8A F5          	push	af
1793   5E8B 3E 01       	ld	a, 1
1794   5E8D 32 01 60    	ld	(CHAVEIASPI), a
1795   5E90 F1          	pop	af
1796   5E91 C9          	ret
1797   5E92             
1798   5E92             ; ------------------------------------------------
1799   5E92             ; Chaveia para modo ROM
1800   5E92             ; ------------------------------------------------
1801   5E92             modoROM: 
1802   5E92 F5          	push	af
1803   5E93 3E 00       	ld	a, 0
1804   5E95 32 01 60    	ld	(CHAVEIASPI), a
1805   5E98 F1          	pop	af
1806   5E99 C9          	ret
1807   5E9A             
1808   5E9A             ; ------------------------------------------------
1809   5E9A             ; Imprime string na tela apontada por DE
1810   5E9A             ; Destroi todos os registradores
1811   5E9A             ; ------------------------------------------------
1812   5E9A             printString: 
1813   5E9A 1A          	ld	a, (de)
1814   5E9B B7          	or	a
1815   5E9C C8          	ret	z
1816   5E9D CD A2 00    	call	CHPUT
1817   5EA0 13          	inc	de
1818   5EA1 18 F7       	jr	printString
1819   5EA3             
1820   5EA3             
1821   5EA3             ; ------------------------------------------------
1822   5EA3             ; Converte o byte em A para string em decimal no
1823   5EA3             ; buffer apontado por DE
1824   5EA3             ; Destroi AF, BC, HL, DE, IXL
1825   5EA3             ; ------------------------------------------------
1826   5EA3             DecToAscii: 
1827   5EA3 26 00       	ld	h, 0
1828   5EA5 6F          	ld	l, a		; copiar A para HL
1829   5EA6 FD 36 39 01 	ld	(iy+WRKAREA.TEMP),1	; flag para indicar que devemos cortar os zeros a esquerda
1830   5EAA 01 9C FF    	ld	bc, -100	; centenas
1831   5EAD CD BB 5E    	call	.num1
1832   5EB0 0E F6       	ld	c, -10		; dezenas
1833   5EB2 CD BB 5E    	call	.num1
1834   5EB5 FD 36 39 02 	ld	(iy+WRKAREA.TEMP),2	; unidade deve exibir 0 se for zero e nao corta-lo
1835   5EB9 0E FF       	ld	c, -1		; unidades
1836   5EBB             .num1: 
1837   5EBB 3E 2F       	ld	a, '0'-1
1838   5EBD             .num2: 
1839   5EBD 3C          	inc	a		; contar o valor em ascii de '0' a '9'
1840   5EBE 09          	add	hl, bc		; somar com negativo
1841   5EBF 38 FC       	jr	c,.num2		; ainda nao zeramos
1842   5EC1 ED 42       	sbc	hl, bc		; retoma valor original
1843   5EC3 FD 35 39    	dec	(iy+WRKAREA.TEMP)	; se flag do corte do zero indicar para nao cortar, pula
1844   5EC6 20 08       	jr	nz,.naozero
1845   5EC8 FE 30       	cp	'0'		; devemos cortar os zeros a esquerda. Eh zero?
1846   5ECA 20 04       	jr	nz,.naozero
1847   5ECC FD 34 39    	inc	(iy+WRKAREA.TEMP)	; se for zero, nao salvamos e voltamos a flag
1848   5ECF C9          	ret
1849   5ED0             .naozero: 
1850   5ED0 12          	ld	(de), a		; eh zero ou eh outro numero, salvar
1851   5ED1 13          	inc	de		; incrementa ponteiro de destino
1852   5ED2 C9          	ret
1853   5ED3             
1854   5ED3             ; ------------------------------------------------
1855   5ED3             ; Converte o byte em A para string em hexa no
1856   5ED3             ; buffer apontado por DE
1857   5ED3             ; Destroi AF, C, DE
1858   5ED3             ; ------------------------------------------------
1859   5ED3             HexToAscii: 
1860   5ED3 4F          	ld	c, a
1861   5ED4 1F          	rra
1862   5ED5 1F          	rra
1863   5ED6 1F          	rra
1864   5ED7 1F          	rra
1865   5ED8 CD DC 5E    	call	.conv
1866   5EDB 79          	ld  	a, c
1867   5EDC             .conv: 
1868   5EDC E6 0F       	and	$0F
1869   5EDE C6 90       	add	a, $90
1870   5EE0 27          	daa
1871   5EE1 CE 40       	adc	a, $40
1872   5EE3 27          	daa
1873   5EE4 12          	ld	(de), a
1874   5EE5 13          	inc	de
1875   5EE6 C9          	ret
1876   5EE7             
1877   5EE7             ; ------------------------------------------------
1878   5EE7             ; Converte o byte em A para string em decimal e
1879   5EE7             ; imprime na tela
1880   5EE7             ; Destroi AF, BC, HL, DE
1881   5EE7             ; ------------------------------------------------
1882   5EE7             printDecToAscii: 
1883   5EE7 26 00       	ld	h, 0
1884   5EE9 6F          	ld	l, a		; copiar A para HL
1885   5EEA 06 01       	ld	b, 1		; flag para indicar que devemos cortar os zeros a esquerda
1886   5EEC 11 9C FF    	ld	de, -100	; centenas
1887   5EEF CD FB 5E    	call	.num1
1888   5EF2 1E F6       	ld	e, -10		; dezenas
1889   5EF4 CD FB 5E    	call	.num1
1890   5EF7 06 02       	ld	b, 2		; unidade deve exibir 0 se for zero e nao corta-lo
1891   5EF9 1E FF       	ld	e, -1		; unidades
1892   5EFB             .num1: 
1893   5EFB 3E 2F       	ld	a, '0'-1
1894   5EFD             .num2: 
1895   5EFD 3C          	inc	a		; contar o valor em ascii de '0' a '9'
1896   5EFE 19          	add	hl, de		; somar com negativo
1897   5EFF 38 FC       	jr	c,.num2		; ainda nao zeramos
1898   5F01 ED 52       	sbc	hl, de		; retoma valor original
1899   5F03 10 06       	djnz	.naozero	; se flag do corte do zero indicar para nao cortar, pula
1900   5F05 FE 30       	cp	'0'		; devemos cortar os zeros a esquerda. Eh zero?
1901   5F07 20 02       	jr	nz,.naozero
1902   5F09 04          	inc	b		; se for zero, nao imprimimos e voltamos a flag
1903   5F0A C9          	ret
1904   5F0B             .naozero: 
1905   5F0B E5          	push	hl		; nao eh zero ou eh outro numero, imprimir
1906   5F0C C5          	push	bc
1907   5F0D CD A2 00    	call	CHPUT
1908   5F10 C1          	pop	bc
1909   5F11 E1          	pop	hl
1910   5F12 C9          	ret
1911   5F13             
1912   5F13             ; ------------------------------------------------
1913   5F13             ; Procura pelo nome do fabricante em uma tabela.
1914   5F13             ; A contem o byte do fabricante
1915   5F13             ; Devolve HL apontando para o buffer do fabricante
1916   5F13             ; e BC com o comprimento do texto
1917   5F13             ; Destroi AF, BC, HL
1918   5F13             ; ------------------------------------------------
1919   5F13             pegaFabricante: 
1920   5F13 4F          	ld	c, a
1921   5F14 21 35 5F    	ld	hl, tblFabricantes
1922   5F17             
1923   5F17             .loop: 
1924   5F17 7E          	ld	a, (hl)
1925   5F18 23          	inc	hl
1926   5F19 B9          	cp	c
1927   5F1A 28 0C       	jr	z,.achado
1928   5F1C B7          	or	a
1929   5F1D 28 09       	jr	z,.achado
1930   5F1F C5          	push	bc
1931   5F20 CD 28 5F    	call	.achado
1932   5F23 09          	add	hl, bc
1933   5F24 23          	inc	hl
1934   5F25 C1          	pop	bc
1935   5F26 18 EF       	jr	.loop
1936   5F28             
1937   5F28             .achado: 
1938   5F28 0E 00       	ld	c, 0
1939   5F2A E5          	push	hl
1940   5F2B AF          	xor	a
1941   5F2C             .loop2: 
1942   5F2C 0C          	inc	c
1943   5F2D 23          	inc	hl
1944   5F2E BE          	cp	(hl)
1945   5F2F 20 FB       	jr	nz,.loop2
1946   5F31 E1          	pop	hl
1947   5F32 06 00       	ld	b, 0
1948   5F34 C9          	ret
1949   5F35             
1950   5F35             tblFabricantes: 
1951   5F35 01          	db	1
1952   5F36             	db	"Panasonic",0
1952   5F36 50616E61736F6E696300
1953   5F40 02          	db	2
1954   5F41             	db	"Toshiba",0
1954   5F41 546F736869626100
1955   5F49 03          	db	3
1956   5F4A             	db	"SanDisk",0
1956   5F4A 53616E4469736B00
1957   5F52 04          	db	4
1958   5F53             	db	"SMI-S",0
1958   5F53 534D492D5300
1959   5F59 06          	db	6
1960   5F5A             	db	"Renesas",0
1960   5F5A 52656E6573617300
1961   5F62 11          	db	17
1962   5F63             	db	"Dane-Elec",0
1962   5F63 44616E652D456C656300
1963   5F6D 13          	db	19
1964   5F6E             	db	"KingMax",0
1964   5F6E 4B696E674D617800
1965   5F76 15          	db	21
1966   5F77             	db	"Samsung",0
1966   5F77 53616D73756E6700
1967   5F7F 18          	db	24
1968   5F80             	db	"Infineon",0
1968   5F80 496E66696E656F6E00
1969   5F89 1A          	db	26
1970   5F8A 50 51 49 00 	db	"PQI",0
1971   5F8E 1B          	db	27
1972   5F8F 536F6E7900  	db	"Sony",0
1973   5F94 1C          	db	28
1974   5F95             	db	"Transcend",0
1974   5F95 5472616E7363656E6400
1975   5F9F 1D          	db	29
1976   5FA0             	db	"A-DATA",0
1976   5FA0 412D4441544100
1977   5FA7 1F          	db	31
1978   5FA8             	db	"SiliconPower",0
1978   5FA8 53696C69636F6E506F77657200
1979   5FB5 27          	db	39
1980   5FB6             	db	"Verbatim",0
1980   5FB6 566572626174696D00
1981   5FBF 41          	db	65
1982   5FC0 4F 4B 49 00 	db	"OKI",0
1983   5FC4 73          	db	115
1984   5FC5             	db	"SilverHT",0
1984   5FC5 53696C766572485400
1985   5FCE 89          	db	137
1986   5FCF             	db	"L.Data",0
1986   5FCF 4C2E4461746100
1987   5FD6 00          	db	0
1988   5FD7             	db	"Generico",0
1988   5FD7 47656E657269636F00
1989   5FE0             
1990   5FE0             
1991   5FE0             ; ------------------------------------------------
1992   5FE0             ; Restore screen parameters on MSX>=2 if they're
1993   5FE0             ; not set yet
1994   5FE0             ; ------------------------------------------------
1995   5FE0             MYSETSCR: 
1996   5FE0 3A 2D 00    	ld	a,(MSXVER)
1997   5FE3 B7          	or	a			; MSX1?
1998   5FE4 CA 6C 00    	jp	z,INITXT		; Yes, change do screen-0
1999   5FE7             
2000   5FE7 0E 23       	ld	c,$23			; Block-2, R#3
2001   5FE9 DD 21 F5 01 	ld 	ix,REDCLK
2002   5FED CD 5F 01    	call	EXTROM
2003   5FF0 E6 01       	and	1
2004   5FF2 47          	ld	b,a
2005   5FF3 3A AF FC    	ld	a,(SCRMOD)
2006   5FF6 B8          	cp	b
2007   5FF7 20 1C       	jr	nz,.restore
2008   5FF9 0C          	inc	c
2009   5FFA DD 21 F5 01 	ld 	ix,REDCLK
2010   5FFE CD 5F 01    	call	EXTROM
2011   6001 47          	ld	b,a
2012   6002 0C          	inc	c
2013   6003 DD 21 F5 01 	ld 	ix,REDCLK
2014   6007 CD 5F 01    	call	EXTROM
2015   600A 87          	add	a,a
2016   600B 87          	add	a,a
2017   600C 87          	add	a,a
2018   600D 87          	add	a,a
2019   600E B0          	or	b
2020   600F 47          	ld	b,a
2021   6010 3A B0 F3    	ld	a,(LINLEN)
2022   6013 B8          	cp	b
2023   6014 C8          	ret	z
2024   6015             .restore: 
2025   6015 AF          	xor	a		; Don't displat the function keys
2026   6016 DD 21 85 01 	ld	ix,SDFSCR
2027   601A C3 5F 01    	jp	EXTROM
2028   601D             
2029   601D             ; ------------------------------------------------
2030   601D             ; Check if the STOP key was signaled on DRV_INIT
2031   601D             ; ------------------------------------------------
2032   601D             INICHKSTOP: 
2033   601D 3A 9B FC    	ld	a,(INTFLG)
2034   6020 FE 04       	cp	4			; Was STOP pressed?
2035   6022 C0          	ret	nz			; No, quit as fast as possible 
2036   6023             
2037   6023             	; Handle STOP to pause and read messages, and ask for the copyright info
2038   6023 11 AA 60    	ld	de,strBootpaused
2039   6026 CD 9A 5E    	call	printString
2040   6029 3E 07       .wait1: 	ld	a,7
2041   602B CD 41 01    	call	SNSMAT
2042   602E E6 10       	and	$10			; Is STOP still pressed?
2043   6030 28 F7       	jr	z,.wait1		; Wait for STOP to be released
2044   6032 AF          	xor	a
2045   6033 32 9B FC    	ld	(INTFLG),a		; Clear STOP flag
2046   6036 06 00       	ld	b,0			; b=inhibit 'i' key flag
2047   6038 CD 9C 00    .wait2:  call	CHSNS
2048   603B C4 58 60    	call	nz,.chkikey		; Wait until a key is pressed
2049   603E 3A 9B FC    	ld	a,(INTFLG)
2050   6041 FE 04       	cp	4			; Was STOP pressed?
2051   6043 20 F3       	jr	nz,.wait2		; No, return
2052   6045 AF          	xor	a
2053   6046 32 9B FC    	ld	(INTFLG),a		; Clear STOP flag
2054   6049 CD 56 01    	call	KILBUF
2055   604C 06 1E       	ld	b,30			; Since the user is trying pause the
2056   604E 76          .wait3: 	halt				; boot messages, this gives him enough
2057   604F             					; time to react and pause the next
2058   604F             					; driver
2059   604F 3A 9B FC    	ld	a,(INTFLG)
2060   6052 FE 04       	cp	4			; Was STOP pressed?
2061   6054 C8          	ret	z			; quit so the next driver can process it
2062   6055 10 F7       	djnz	.wait3			; The user will have the impression
2063   6057             					; that he has a perfect timing.   ;)
2064   6057 C9          	ret
2065   6058             
2066   6058             .chkikey: 
2067   6058 CB 40       	bit	0,b			; Was the copyright message shown?
2068   605A C0          	ret	nz			; Yes, return
2069   605B CD 9F 00    	call	CHGET
2070   605E FE 69       	cp	'i'
2071   6060 28 03       	jr	z,.showcopyright
2072   6062 FE 49       	cp	'I'
2073   6064 C0          	ret	nz
2074   6065             .showcopyright: 
2075   6065 04          	inc	b			; Inhibit further presses of the i key 
2076   6066 11 DA 60    	ld	de,strCopyright
2077   6069 C3 9A 5E    	jp	printString
2078   606C             
2079   606C             
2080   606C             
2081   606C             ; ------------------------------------------------
2082   606C             ; Install the R800 data transfer helper routine on WorkArea 
2083   606C             ; ------------------------------------------------
2084   606C             INSTR800HLP: 
2085   606C 3A 2D 00    	ld	a,(MSXVER)
2086   606F FE 03       	cp	3		; MSX Turbo-R?
2087   6071 D8          	ret	c		; No, return
2088   6072 CD 7F 60    	call	GTR800LDIR
2089   6075 EB          	ex	de,hl
2090   6076 21 87 60    	ld	hl,R800DATHLP
2091   6079 01 07 00    	ld	bc,R800DATHLP.end-R800DATHLP
2092   607C ED B0       	ldir
2093   607E C9          	ret
2094   607F             
2095   607F             ; ------------------------------------------------
2096   607F             ; Obtain the pointer to the R800 data transfer helper routine
2097   607F             ; Input   : IY=Pointer to the WorkArea
2098   607F             ; Output  : HL=pointer to R800 data transfer helper routine 
2099   607F             ; Modifies: DE
2100   607F             ; ------------------------------------------------
2101   607F             GTR800LDIR: 
2102   607F FD E5       	push	iy
2103   6081 E1          	pop	hl			; hl=WorkArea
2104   6082 11 3A 00    	ld	de,WRKAREA.TRLDIR
2105   6085 19          	add	hl,de
2106   6086 C9          	ret
2107   6087             
2108   6087             ; ------------------------------------------------
2109   6087             ; R800 data transfer routine, copied to the WorkArea
2110   6087             ; ------------------------------------------------
2111   6087             R800DATHLP: 
2112   6087 D9          	exx
2113   6088 01 00 02    	ld	bc,512
2114   608B ED B0       	ldir
2115   608D C9          	ret
2116   608E             .end
2117   608E              
2118   608E             
2119   608E             
2120   608E             ; ==========================================================================
2121   608E             strTitle: 
2122   608E             	db	"FBLabs SDHC driver "
2122   608E 46424C61627320534448432064726976657220
2123   60A1             	db	"v",VER_MAIN+$30,'.',VER_SEC+$30,'.',VER_REV+$30
2123   60A1 76312E302E36
2124   60A7 0D 0A 00    	db	13,10,0
2125   60AA             
2126   60AA             strBootpaused: 
2127   60AA             	db	"Paused. Press <i> to show the copyright info.",13,10,0
2127   60AA 5061757365642E205072657373203C693E20746F2073686F772074686520636F
2127   60CA 7079726967687420696E666F2E0D0A00
2128   60DA             
2129   60DA             strCopyright: 
2130   60DA             	db	"(c) 2014 Fabio Belavenuto",13,10
2130   60DA 286329203230313420466162696F2042656C6176656E75746F0D0A
2131   60F5             	db	"(c) 2016 FRS",13,10
2131   60F5 2863292032303136204652530D0A
2132   6103             	db	"Licensed under CERN OHL v1.1",13,10
2132   6103 4C6963656E73656420756E646572204345524E204F484C2076312E310D0A
2133   6121             	db	"http://ohwr.org/cernohl",13,10
2133   6121 687474703A2F2F6F6877722E6F72672F6365726E6F686C0D0A
2134   613A             	db	"PCB designed by Luciano Sturaro",13,10
2134   613A 5043422064657369676E6564206279204C756369616E6F205374757261726F0D
2134   615A 0A
2135   615B             	; fall throw
2136   615B             strCrLf: 
2137   615B 0D 0A 00    	db	13,10,0
2138   615E             strCartao: 
2139   615E             	db	"Slot ",0
2139   615E 536C6F742000
2140   6164             strVazio: 
2141   6164             	db	"Empty",13,10,0
2141   6164 456D7074790D0A00
2142   616C             strNaoIdentificado: 
2143   616C             	db	"Unknown!",13,10,0
2143   616C 556E6B6E6F776E210D0A00
2144   6177             			;----------------------------------------
2145   6177             strMemSS0: 
2146   6177             	db	"Memory subslot 0",13,10,0
2146   6177 4D656D6F727920737562736C6F7420300D0A00
2147   618A             strSDSS0: 
2148   618A             	db	"SD subslot 0",13,10,0
2148   618A 534420737562736C6F7420300D0A00
2149   6199             strMapper: 
2150   6199             	db	"Memory Mapper enabled",13,10,0
2150   6199 4D656D6F7279204D617070657220656E61626C65640D0A00
2151   61B1             strMegaram: 
2152   61B1             	db	"MegaRAM enabled",13,10,0
2152   61B1 4D65676152414D20656E61626C65640D0A00
2153   61C3             strSDV1: 
2154   61C3             	db	"SDV1 - ",0
2154   61C3 53445631202D2000
2155   61CB             strSDV2: 
2156   61CB             	db	"SDV2 - ",0
2156   61CB 53445632202D2000
2157   61D3             
2158   61D3             ;-----------------------------------------------------------------------------
2159   61D3             ;
2160   61D3             ; End of the driver code
2161   61D3             
2162   61D3             DRV_END: 
2163   61D3             
2164   61D3 FF          	ds	3ED0h-(DRV_END-DRV_START), $FF
2165   7FD0             
2166   7FD0             
