0001   0000             ; Projeto MSX SD Mapper
0002   0000             
0003   0000             ; Copyright (c) 2014 Fabio Belavenuto
0004   0000             ; Enhanced by FRS
0005   0000             
0006   0000             ; This documentation describes Open Hardware and is licensed under the CERN OHL v. 1.1.
0007   0000             ; You may redistribute and modify this documentation under the terms of the
0008   0000             ; CERN OHL v.1.1. (http://ohwr.org/cernohl). This documentation is distributed
0009   0000             ; WITHOUT ANY EXPRESS OR IMPLIED WARRANTY, INCLUDING OF MERCHANTABILITY,
0010   0000             ; SATISFACTORY QUALITY AND FITNESS FOR A PARTICULAR PURPOSE.
0011   0000             ; Please see the CERN OHL v.1.1 for applicable conditions
0012   0000             
0013   0000             ; Technical info:
0014   0000             ; 4000h~47FFh	: SPI data transfer window (read/write)
0015   0000             ; 4800h		: Interface status and card select register (read/write)
0016   0000             ;	<read>
0017   0000             ;	b0	: 0=SD card present on slot-0
0018   0000             ;	b1	: 0=SD card present on slot-1
0019   0000             ;	b2	: 0=Write protecton enabled for SD card slot-0
0020   0000             ;	b3	: 0=Write protecton enabled for SD card slot-1
0021   0000             ;	b4	: SW0 status. 0=RAM enabled, 1=RAM disabled
0022   0000             ;	b5	: SW1 status. 0=RAM mode: MegaRAM, 1=RAM mode: Memory Mapper
0023   0000             ;	b6	: Reserved for future use. Must be masked out from readings.
0024   0000             ;	b7	: 1=SPI transfer busy. 0=No ongoing SPI transfer
0025   0000             ;	<write>
0026   0000             ;	b0	: SD card slot-0 chip-select (0=selected)
0027   0000             ;	b1	: SD card slot-1 chip-select (0=selected)
0028   0000             
0029   0000             ; 6001h		: Mode configuration register (write only)
0030   0000             ;	b0	: 0=ROM mode, SPI interface disabled, 1=SPI interface enabled
0031   0000             
0032   0000             
0033   0000             
0034   0000             	output	"driver.bin"
0035   0000             
0036   0000             ;-----------------------------------------------------------------------------
0037   0000             ;
0038   0000             ; Driver configuration constants
0039   0000             ;
0040   0000             
0041   0000             ;Driver type:
0042   0000             ;   0 for drive-based
0043   0000             ;   1 for device-based
0044   0000             
0045   0000             DRV_TYPE	equ	1
0046   0000             
0047   0000             ;Hot-plug devices support (device-based drivers only):
0048   0000             ;   0 for no hot-plug support
0049   0000             ;   1 for hot-plug support
0050   0000             
0051   0000             DRV_HOTPLUG	equ	0
0052   0000             
0053   0000             DEBUG	equ	0	;Set to 1 for debugging, 0 to normal operation
0054   0000             
0055   0000             ;Driver version
0056   0000             
0057   0000             VER_MAIN	equ	1
0058   0000             VER_SEC		equ	0
0059   0000             VER_REV		equ	6
0060   0000             
0061   0000             ;-----------------------------------------------------------------------------
0062   0000             ; Enderecos SPI
0063   0000             
0064   0000             CHAVEIASPI	= $6001
0065   0000             PORTCFG		= $4800
0066   0000             PORTSPI		= $4000
0067   0000             
0068   0000             ; Comandos SPI:
0069   0000             CMD0	= 0  | $40
0070   0000             CMD1	= 1  | $40
0071   0000             CMD8	= 8  | $40
0072   0000             CMD9	= 9  | $40
0073   0000             CMD10	= 10 | $40
0074   0000             CMD12	= 12 | $40
0075   0000             CMD16	= 16 | $40
0076   0000             CMD17	= 17 | $40
0077   0000             CMD18	= 18 | $40
0078   0000             CMD24	= 24 | $40
0079   0000             CMD25	= 25 | $40
0080   0000             CMD55	= 55 | $40
0081   0000             CMD58	= 58 | $40
0082   0000             ACMD23	= 23 | $40
0083   0000             ACMD41	= 41 | $40
0084   0000             
0085   0000             ; Offsets da area de trabalho
0086   0000             
0087   0000             BCSD 		= 0
0088   0000             BCID1		= 16
0089   0000             BCID2		= 32
0090   0000             NUMSD		= 48	; 1 se cartao 1, 2 se cartao 2
0091   0000             FLAGSCARTAO	= 49	; Flag indicando se houve mudanca ou erro de cartao
0092   0000             NUMBLOCOS	= 50	; 1 byte
0093   0000             TEMP		= 52	; 1 byte
0094   0000             BLOCOS1		= 56	; 3 bytes
0095   0000             BLOCOS2		= 60	; 3 bytes
0096   0000             
0097   0000             
0098   0000             
0099   0000             ;-----------------------------------------------------------------------------
0100   0000             ;
0101   0000             ; Standard BIOS and work area entries
0102   0000             INITXT	= $006C		; Inicializa SCREEN0
0103   0000             CHSNS	= $009C		; Sense keyboard buffer for character
0104   0000             CHGET	= $009F		; Get character from keyboard buffer
0105   0000             CHPUT	= $00A2		; A=char
0106   0000             CLS	= $00C3		; Chamar com A=0
0107   0000             ERAFNK	= $00CC		; Erase function key display
0108   0000             SNSMAT	= $0141		; Read row of keyboard matrix
0109   0000             KILBUF	= $0156		; Clear keyboard buffer
0110   0000             EXTROM	= $015F
0111   0000             
0112   0000             ; subROM functions
0113   0000             SDFSCR	= $0185
0114   0000             REDCLK	= $01F5
0115   0000             
0116   0000             
0117   0000             ; System variables
0118   0000             MSXVER	= $002D
0119   0000             LINL40	= $F3AE		; Width
0120   0000             LINLEN	= $F3B0
0121   0000             INTFLG	= $FC9B
0122   0000             SCRMOD	= $FCAF
0123   0000             
0124   0000             
0125   0000             ;-----------------------------------------------------------------------------
0126   0000             
0127   0000             
0128   0000             	org		$4000
0129   4000             
0130   4000 FF          	ds		256, $FF		; 256 dummy bytes
0131   4100             
0132   4100             DRV_START: 
0133   4100             
0134   4100             ;-----------------------------------------------------------------------------
0135   4100             ;
0136   4100             ; Miscellaneous constants
0137   4100             ;
0138   4100             
0139   4100             ;This is a 2 byte buffer to store the address of code to be executed.
0140   4100             ;It is used by some of the kernel page 0 routines.
0141   4100             
0142   4100             CODE_ADD: 	equ	0F84Ch
0143   4100             
0144   4100             
0145   4100             ;-----------------------------------------------------------------------------
0146   4100             ;
0147   4100             ; Error codes for DEV_RW
0148   4100             ;
0149   4100             
0150   4100             ENCOMP	equ	0FFh
0151   4100             EWRERR	equ	0FEh
0152   4100             EDISK	equ	0FDh
0153   4100             ENRDY	equ	0FCh
0154   4100             EDATA	equ	0FAh
0155   4100             ERNF	equ	0F9h
0156   4100             EWPROT	equ	0F8h
0157   4100             EUFORM	equ	0F7h
0158   4100             ESEEK	equ	0F3h
0159   4100             EIFORM	equ	0F0h
0160   4100             EIDEVL	equ	0B5h
0161   4100             EIPARM	equ	08Bh
0162   4100             
0163   4100             ;-----------------------------------------------------------------------------
0164   4100             ;
0165   4100             ; Routines and information available on kernel page 0
0166   4100             ;
0167   4100             
0168   4100             ;* Get in A the current slot for page 1. Corrupts F.
0169   4100             ;  Must be called by using CALBNK to bank 0:
0170   4100             ;    xor a
0171   4100             ;    ld ix,GSLOT1
0172   4100             ;    call CALBNK
0173   4100             
0174   4100             GSLOT1	equ	402Dh
0175   4100             
0176   4100             
0177   4100             ;* This routine reads a byte from another bank.
0178   4100             ;  Must be called by using CALBNK to the desired bank,
0179   4100             ;  passing the address to be read in HL:
0180   4100             ;    ld a,<bank number>
0181   4100             ;    ld hl,<byte address>
0182   4100             ;    ld ix,RDBANK
0183   4100             ;    call CALBNK
0184   4100             
0185   4100             RDBANK	equ	403Ch
0186   4100             
0187   4100             
0188   4100             ;* This routine temporarily switches kernel main bank
0189   4100             ;  (usually bank 0, but will be 3 when running in MSX-DOS 1 mode),
0190   4100             ;  then invokes the routine whose address is at (CODE_ADD).
0191   4100             ;  It is necessary to use this routine to invoke CALBAS
0192   4100             ;  (so that kernel bank is correct in case of BASIC error)
0193   4100             ;  and to invoke DOS functions via F37Dh hook.
0194   4100             ;
0195   4100             ;  Input:  Address of code to invoke in (CODE_ADD).
0196   4100             ;          AF, BC, DE, HL, IX, IY passed to the called routine.
0197   4100             ;  Output: AF, BC, DE, HL, IX, IY returned from the called routine.
0198   4100             
0199   4100             CALLB0	equ	403Fh
0200   4100             
0201   4100             
0202   4100             ;* Call a routine in another bank.
0203   4100             ;  Must be used if the driver spawns across more than one bank.
0204   4100             ;
0205   4100             ;  Input:  A = bank number
0206   4100             ;          IX = routine address
0207   4100             ;          AF' = AF for the routine
0208   4100             ;          HL' = Ix for the routine
0209   4100             ;          BC, DE, HL, IY = input for the routine
0210   4100             ;  Output: AF, BC, DE, HL, IX, IY returned from the called routine.
0211   4100             
0212   4100             CALBNK	equ	4042h
0213   4100             
0214   4100             
0215   4100             ;* Get in IX the address of the SLTWRK entry for the slot passed in A,
0216   4100             ;  which will in turn contain a pointer to the allocated page 3
0217   4100             ;  work area for that slot (0 if no work area was allocated).
0218   4100             ;  If A=0, then it uses the slot currently switched in page 1.
0219   4100             ;  Returns A=current slot for page 1, if A=0 was passed.
0220   4100             ;  Corrupts F.
0221   4100             ;  Must be called by using CALBNK to bank 0:
0222   4100             ;    ld a,<slot number> (xor a for current page 1 slot)
0223   4100             ;    ex af,af'
0224   4100             ;    xor a
0225   4100             ;    ld ix,GWORK
0226   4100             ;    call CALBNK
0227   4100             
0228   4100             GWORK	equ	4045h
0229   4100             
0230   4100             
0231   4100             ;* This address contains one byte that tells how many banks
0232   4100             ;  form the Nextor kernel (or alternatively, the first bank
0233   4100             ;  number of the driver).
0234   4100             
0235   4100             K_SIZE	equ	40FEh
0236   4100             
0237   4100             
0238   4100             ;* This address contains one byte with the current bank number.
0239   4100             
0240   4100             CUR_BANK	equ	40FFh
0241   4100             
0242   4100             
0243   4100             ;-----------------------------------------------------------------------------
0244   4100             ;
0245   4100             ; Built-in format choice strings
0246   4100             ;
0247   4100             
0248   4100             NULL_MSG  equ     781Fh	;Null string (disk can't be formatted)
0249   4100             SING_DBL  equ     7820h ;"1-Single side / 2-Double side"
0250   4100             
0251   4100             
0252   4100             ;-----------------------------------------------------------------------------
0253   4100             ;
0254   4100             ; Driver signature
0255   4100             ;
0256   4100             	db	"NEXTOR_DRIVER",0
0256   4100 4E4558544F525F44524956455200
0257   410E             
0258   410E             
0259   410E             ;-----------------------------------------------------------------------------
0260   410E             ;
0261   410E             ; Driver flags:
0262   410E             ;    bit 0: 0 for drive-based, 1 for device-based
0263   410E             ;    bit 1: 1 for hot-plug devices supported (device-based drivers only)
0264   410E             
0265   410E 01          	db 1+(2*DRV_HOTPLUG)
0266   410F             
0267   410F             ;-----------------------------------------------------------------------------
0268   410F             ;
0269   410F             ; Reserved byte
0270   410F             ;
0271   410F 00          	db	0
0272   4110             
0273   4110             ;-----------------------------------------------------------------------------
0274   4110             ;
0275   4110             ; Driver name
0276   4110             ;
0277   4110             
0278   4110             DRV_NAME: 
0279   4110             	db	"SDMapper Driver"
0279   4110 53444D617070657220447269766572
0280   411F 20          	ds	32-($-DRV_NAME)," "
0281   4130             
0282   4130             
0283   4130             ;-----------------------------------------------------------------------------
0284   4130             ;
0285   4130             ; Jump table for the driver public routines
0286   4130             ;
0287   4130             
0288   4130             	; These routines are mandatory for all drivers
0289   4130                     ; (but probably you need to implement only DRV_INIT)
0290   4130             
0291   4130 C3 6C 41    	jp	DRV_TIMI
0292   4133 C3 14 49    	jp	DRV_VERSION
0293   4136 C3 00 48    	jp	DRV_INIT
0294   4139 C3 1B 49    	jp	DRV_BASSTAT
0295   413C C3 1D 49    	jp	DRV_BASDEV
0296   413F C3 1F 49    	jp	DRV_EXTBIO
0297   4142 C3 20 49    	jp	DRV_DIRECT0
0298   4145 C3 20 49    	jp	DRV_DIRECT1
0299   4148 C3 20 49    	jp	DRV_DIRECT2
0300   414B C3 20 49    	jp	DRV_DIRECT3
0301   414E C3 20 49    	jp	DRV_DIRECT4
0302   4151             
0303   4151 00          	ds	15
0304   4160             
0305   4160             	; These routines are mandatory for device-based drivers
0306   4160             
0307   4160 C3 21 49    	jp	DEV_RW
0308   4163 C3 9E 49    	jp	DEV_INFO
0309   4166 C3 24 4A    	jp	DEV_STATUS
0310   4169 C3 6A 4A    	jp	LUN_INFO
0311   416C             
0312   416C             
0313   416C             ;=====
0314   416C             ;=====  END of data that must be at fixed addresses
0315   416C             ;=====
0316   416C             
0317   416C             
0318   416C             ;-----------------------------------------------------------------------------
0319   416C             ;
0320   416C             ; Timer interrupt routine, it will be called on each timer interrupt
0321   416C             ; (at 50 or 60Hz), but only if DRV_INIT returns Cy=1 on its first execution.
0322   416C             
0323   416C             DRV_TIMI: 
0324   416C C9          	ret
0325   416D             
0326   416D             
0327   416D             ; Skips the interface r/w registers 
0328   416D FF          	ds	$4800-$, $FF
0329   4800             
0330   4800             
0331   4800             ;-----------------------------------------------------------------------------
0332   4800             ;
0333   4800             ; Driver initialization routine, it is called twice:
0334   4800             ;
0335   4800             ; 1) First execution, for information gathering.
0336   4800             ;    Input:
0337   4800             ;      A = 0
0338   4800             ;      B = number of available drives
0339   4800             ;      HL = maximum size of allocatable work area in page 3
0340   4800             ;    Output:
0341   4800             ;      A = number of required drives (for drive-based driver only)
0342   4800             ;      HL = size of required work area in page 3
0343   4800             ;      Cy = 1 if DRV_TIMI must be hooked to the timer interrupt, 0 otherwise
0344   4800             ;
0345   4800             ; 2) Second execution, for work area and hardware initialization.
0346   4800             ;    Input:
0347   4800             ;      A = 1
0348   4800             ;      B = number of allocated drives for this controller
0349   4800             ;
0350   4800             ;    The work area address can be obtained by using GWORK.
0351   4800             ;
0352   4800             ;    If first execution requests more work area than available,
0353   4800             ;    second execution will not be done and DRV_TIMI will not be hooked
0354   4800             ;    to the timer interrupt.
0355   4800             ;
0356   4800             ;    If first execution requests more drives than available,
0357   4800             ;    as many drives as possible will be allocated, and the initialization
0358   4800             ;    procedure will continue the normal way
0359   4800             ;    (for drive-based drivers only. Device-based drivers always
0360   4800             ;     get two allocated drives.)
0361   4800             
0362   4800             DRV_INIT: 
0363   4800 B7          	or	a		; Is this the 1st call? 
0364   4801 21 40 00    	ld	hl, 64		; 64 bytes of work area is needed 
0365   4804 C8          	ret	z		; Yes, return
0366   4805             
0367   4805             ; 2nd call: 
0368   4805 CD C9 5F    	call	MYSETSCR		; Set the screen mode
0369   4808 CD A9 4A    	call	pegaWorkArea		; HL=IY=Work area pointer
0370   480B             
0371   480B 11 06 60    	ld	de,strTitle		; prints the title 
0372   480E CD 83 5E    	call	printString
0373   4811             
0374   4811 CD F6 48    	call	SDMAPPERINIT		; SD-Mapper exclusive init
0375   4814             
0376   4814             SDHCDEVINIT: 	; FBLabs SDHC Interface initialization
0377   4814 AF          	xor	a			; zera flags do cartao
0378   4815 FD 77 31    	ld	(iy+FLAGSCARTAO), a
0379   4818 3E 01       	ld	a, 1			; detectar cartao 1
0380   481A CD 80 48    	call	.detecta
0381   481D 3E 02       	ld	a, 2			; detectar cartao 2
0382   481F CD 80 48    	call	.detecta
0383   4822 01 00 00    	ld	bc, 0
0384   4825 1E 05       	ld	e, 5
0385   4827 CD 7B 5E    	call	modoROM
0386   482A             
0387   482A             .chkStop:  ; Check if the STOP key was signaled
0388   482A 3A 9B FC    	ld	a,(INTFLG)
0389   482D FE 04       	cp	4			; Was STOP pressed?
0390   482F 20 35       	jr	nz,.end			; No, quit as fast as possible 
0391   4831             
0392   4831             	; Handle STOP to pause and read messages, and ask for the copyright info
0393   4831 11 22 60    	ld	de,strBootpaused
0394   4834 CD 83 5E    	call	printString
0395   4837 3E 07       .wait1: 	ld	a,7
0396   4839 CD 41 01    	call	SNSMAT
0397   483C E6 10       	and	$10			; Is STOP still pressed?
0398   483E 28 F7       	jr	z,.wait1		; Wait for STOP to be released
0399   4840 AF          	xor	a
0400   4841 32 9B FC    	ld	(INTFLG),a		; Clear STOP flag
0401   4844 06 00       	ld	b,0			; b=inhibit 'i' key flag
0402   4846 CD 9C 00    .wait2:  call	CHSNS
0403   4849 C4 6C 48    	call	nz,.chkikey		; Wait until a key is pressed
0404   484C 3A 9B FC    	ld	a,(INTFLG)
0405   484F FE 04       	cp	4			; Was STOP pressed?
0406   4851 20 F3       	jr	nz,.wait2		; No, return
0407   4853 AF          	xor	a
0408   4854 32 9B FC    	ld	(INTFLG),a		; Clear STOP flag
0409   4857 CD 56 01    	call	KILBUF
0410   485A 06 1E       	ld	b,30			; Since the user is trying pause the
0411   485C 76          .wait3: 	halt				; boot messages, this gives him enough
0412   485D             					; time to react and pause the next
0413   485D             					; driver
0414   485D 3A 9B FC    	ld	a,(INTFLG)
0415   4860 FE 04       	cp	4			; Was STOP pressed?
0416   4862 28 02       	jr	z,.end			; quit so the next driver can process it
0417   4864 10 F6       	djnz	.wait3			; The user will have the impression
0418   4866             					; that he has a perfect timing.   ;)
0419   4866             
0420   4866             
0421   4866             .end
0422   4866 11 CF 60     	ld	de, strCrLf
0423   4869 C3 83 5E    	jp	printString
0424   486C             
0425   486C             .chkikey: 
0426   486C CB 40       	bit	0,b			; Was the copyright message shown?
0427   486E C0          	ret	nz			; Yes, return
0428   486F CD 9F 00    	call	CHGET
0429   4872 FE 69       	cp	'i'
0430   4874 28 03       	jr	z,.showcopyright
0431   4876 FE 49       	cp	'I'
0432   4878 C0          	ret	nz
0433   4879             .showcopyright: 
0434   4879 04          	inc	b			; Inhibit further presses of the i key 
0435   487A 11 52 60    	ld	de,strCopyright
0436   487D C3 83 5E    	jp	printString
0437   4880             
0438   4880             .detecta: 
0439   4880 FD 77 30    	ld	(iy+NUMSD), a		; processo de deteccao dos cartoes
0440   4883 11 D2 60    	ld	de, strCartao
0441   4886 CD 83 5E    	call	printString
0442   4889 FD 7E 30    	ld	a, (iy+NUMSD)
0443   488C C6 30       	add	'0'
0444   488E CD A2 00    	call	CHPUT
0445   4891 3E 3A       	ld	a, ':'
0446   4893 CD A2 00    	call	CHPUT
0447   4896 3E 20       	ld	a, ' '
0448   4898 CD A2 00    	call	CHPUT
0449   489B FD 4E 30    	ld	c, (iy+NUMSD)
0450   489E 3A 00 48    	ld	a, (PORTCFG)		; testar se cartao esta inserido
0451   48A1 A1          	and	c			; C contem 1 se cartao 1, 2 se cartao 2
0452   48A2 28 09       	jr	z,.naoVazio
0453   48A4 11 D8 60    	ld	de, strVazio		; nao tem cartao no slot
0454   48A7 CD 83 5E    	call	printString
0455   48AA C3 BB 48    	jp	.marcaErro
0456   48AD             .naoVazio: 
0457   48AD CD 2F 4B    	call	detectaCartao		; tem cartao no slot, inicializar e detectar
0458   48B0 30 0C       	jr	nc,.detectou
0459   48B2 CD 7D 4C    	call	desabilitaSDs
0460   48B5 11 E0 60    	ld	de, strNaoIdentificado
0461   48B8 CD 83 5E    	call	printString
0462   48BB             .marcaErro: 
0463   48BB C3 EA 4A    	jp	marcaErroCartao		; slot vazio ou erro de deteccao, marcar nas flags
0464   48BE             .detectou: 
0465   48BE CD 07 4B    	call	calculaCIDoffset	; calculamos em IX a posicao correta do offset CID dependendo do cartao atual
0466   48C1 DD 7E 0F    	ld	a,(ix+15)	; pegar byte SDV1 ou SDV2
0467   48C4 11 61 61    	ld	de, strSDV1	; e imprimir
0468   48C7 B7          	or	a
0469   48C8 28 03       	jr	z,.pula1
0470   48CA 11 69 61    	ld	de, strSDV2
0471   48CD             .pula1: 
0472   48CD CD 83 5E    	call	printString
0473   48D0 3E 28       	ld	a,'('
0474   48D2 CD A2 00    	call	CHPUT
0475   48D5 DD 7E 00    	ld	a,(ix)		; pegar byte do fabricante
0476   48D8 CD D0 5E    	call	printDecToAscii	; Imprimir Manufacturer ID
0477   48DB 3E 29       	ld	a,')'
0478   48DD CD A2 00    	call	CHPUT
0479   48E0 3E 20       	ld	a,' '
0480   48E2 CD A2 00    	call	CHPUT
0481   48E5 DD 7E 00    	ld	a,(ix)		; pegar byte do fabricante
0482   48E8 CD FC 5E    	call	pegaFabricante	; achar nome do fabricante
0483   48EB EB          	ex	de,hl
0484   48EC CD 83 5E    	call	printString	; e imprimir
0485   48EF 11 CF 60    	ld	de,strCrLf
0486   48F2 CD 83 5E    	call	printString
0487   48F5 C9          	ret
0488   48F6             
0489   48F6             
0490   48F6             SDMAPPERINIT: 		; This block is exclusive for the SD-Mapper
0491   48F6 11 EB 60    	ld	de, strMr_mp_desativada
0492   48F9 CD 73 5E    	call	modoSPI
0493   48FC 3A 00 48    	ld	a, (PORTCFG)		; testar se mapper/megaram esta ativa
0494   48FF E6 10       	and	$10
0495   4901 28 0E       	jr	z,.print		; desativada, pula
0496   4903 11 13 61    	ld	de, strMapper
0497   4906 3A 00 48    	ld	a, (PORTCFG)		; ativa, testar se eh mapper ou megaram
0498   4909 E6 20       	and	$20
0499   490B C2 83 5E    	jp	nz,printString
0500   490E 11 3D 61    	ld	de, strMegaram		; Megaram ativa
0501   4911             .print: 
0502   4911 C3 83 5E    	jp	printString
0503   4914             
0504   4914             ;-----------------------------------------------------------------------------
0505   4914             ;
0506   4914             ; Obtain driver version
0507   4914             ;
0508   4914             ; Input:  -
0509   4914             ; Output: A = Main version number
0510   4914             ;         B = Secondary version number
0511   4914             ;         C = Revision number
0512   4914             
0513   4914             DRV_VERSION: 
0514   4914 3E 01       	ld	a, VER_MAIN
0515   4916 06 00       	ld	b, VER_SEC
0516   4918 0E 06       	ld	c, VER_REV
0517   491A C9          	ret
0518   491B             
0519   491B             
0520   491B             ;-----------------------------------------------------------------------------
0521   491B             ;
0522   491B             ; BASIC expanded statement ("CALL") handler.
0523   491B             ; Works the expected way, except that if invoking CALBAS is needed,
0524   491B             ; it must be done via the CALLB0 routine in kernel page 0.
0525   491B             
0526   491B             DRV_BASSTAT: 
0527   491B 37          	scf
0528   491C C9          	ret
0529   491D             
0530   491D             
0531   491D             ;-----------------------------------------------------------------------------
0532   491D             ;
0533   491D             ; BASIC expanded device handler.
0534   491D             ; Works the expected way, except that if invoking CALBAS is needed,
0535   491D             ; it must be done via the CALLB0 routine in kernel page 0.
0536   491D             
0537   491D             DRV_BASDEV: 
0538   491D 37          	scf
0539   491E C9          	ret
0540   491F             
0541   491F             ;-----------------------------------------------------------------------------
0542   491F             ;
0543   491F             ; Extended BIOS hook.
0544   491F             ; Works the expected way, except that it must return
0545   491F             ; D'=1 if the old hook must be called, D'=0 otherwise.
0546   491F             ; It is entered with D'=1.
0547   491F             
0548   491F             DRV_EXTBIO: 
0549   491F C9          	ret
0550   4920             
0551   4920             ;-----------------------------------------------------------------------------
0552   4920             ;
0553   4920             ; Direct calls entry points.
0554   4920             ; Calls to addresses 7850h, 7853h, 7856h, 7859h and 785Ch
0555   4920             ; in kernel banks 0 and 3 will be redirected
0556   4920             ; to DIRECT0/1/2/3/4 respectively.
0557   4920             ; Receives all register data from the caller except IX and AF'.
0558   4920             
0559   4920             DRV_DIRECT0: 
0560   4920             DRV_DIRECT1: 
0561   4920             DRV_DIRECT2: 
0562   4920             DRV_DIRECT3: 
0563   4920             DRV_DIRECT4: 
0564   4920 C9          	ret
0565   4921             
0566   4921             
0567   4921             ;=====
0568   4921             ;=====  BEGIN of DEVICE-BASED specific routines
0569   4921             ;=====
0570   4921             
0571   4921             ;-----------------------------------------------------------------------------
0572   4921             ;
0573   4921             ; Read or write logical sectors from/to a logical unit
0574   4921             ;
0575   4921             ;Input:    Cy=0 to read, 1 to write
0576   4921             ;          A = Device number, 1 to 7
0577   4921             ;          B = Number of sectors to read or write
0578   4921             ;          C = Logical unit number, 1 to 7
0579   4921             ;          HL = Source or destination memory address for the transfer
0580   4921             ;          DE = Address where the 4 byte sector number is stored.
0581   4921             ;Output:   A = Error code (the same codes of MSX-DOS are used):
0582   4921             ;              0: Ok
0583   4921             ;              .IDEVL: Invalid device or LUN
0584   4921             ;              .NRDY: Not ready
0585   4921             ;              .DISK: General unknown disk error
0586   4921             ;              .DATA: CRC error when reading
0587   4921             ;              .RNF: Sector not found
0588   4921             ;              .UFORM: Unformatted disk
0589   4921             ;              .WPROT: Write protected media, or read-only logical unit
0590   4921             ;              .WRERR: Write error
0591   4921             ;              .NCOMP: Incompatible disk.
0592   4921             ;              .SEEK: Seek error.
0593   4921             ;          B = Number of sectors actually read (in case of error only)
0594   4921             
0595   4921             DEV_RW: 
0596   4921 F5          	push	af
0597   4923 BF FE 03    	cp	a, 3		; somente 2 dispositivos
0598   4925 30 10       	jr	nc,.saicomerroidl
0599   4927 0D          	dec	c		; somente 1 logical unit
0600   4928 20 0D       	jr	nz,.saicomerroidl
0601   492A E5          	push	hl
0602   492B CD C2 4A    	call	testaCartao	; verificar se cartao esta OK
0603   492E E1          	pop	hl
0604   492F 30 0C       	jr	nc,.ok
0605   4931 F1          	pop	af		; retira AF guardado no inicio
0606   4932 3E FC       	ld	a, ENRDY	; Not ready
0607   4934             ;	ld	a, EDISK	; General unknown disk error
0608   4934 06 00       	ld	b, 0
0609   4936 C9          	ret
0610   4937             .saicomerroidl: 
0611   4937 F1          	pop	af		; retira AF guardado no inicio
0612   4938 3E B5       	ld	a, EIDEVL	; informar erro
0613   493A 06 00       	ld	b, 0
0614   493C C9          	ret
0615   493D             .ok: 
0616   493D FD 70 32    	ld	(iy+NUMBLOCOS), b	; guarda numero de blocos para ler/gravar
0617   4940 E5          	push	hl
0618   4941 D5          	push	de
0619   4942 CD 07 4B    	call	calculaCIDoffset	; calculamos em IX a posicao correta do offset CID dependendo do cartao atual
0620   4945 D1          	pop	de
0621   4946 E1          	pop	hl
0622   4947 F1          	pop	af		; retira AF guardado no inicio, para saber se eh leitura ou escrita
0623   4948 38 25       	jr	c,escrita	; se for escrita pulamos
0624   494A             leitura: 
0625   494A 1A          	ld	a, (de)		; 1. n. bloco
0626   494B F5          	push	af
0627   494C 13          	inc	de
0628   494D 1A          	ld	a, (de)		; 2. n. bloco
0629   494E F5          	push	af
0630   494F 13          	inc	de
0631   4950 1A          	ld	a, (de)		; 3. n. bloco
0632   4951 4F          	ld	c, a
0633   4952 13          	inc	de
0634   4953 1A          	ld	a, (de)		; 4. n. bloco
0635   4954 13          	inc	de
0636   4955 47          	ld	b, a
0637   4956 F1          	pop	af
0638   4957 57          	ld	d, a
0639   4958 F1          	pop	af		; HL = ponteiro destino
0640   4959 5F          	ld	e, a		; BC DE = 32 bits numero do bloco
0641   495A CD 73 5E    	call	modoSPI
0642   495D CD F5 55    	call	LerBloco	; chamar rotina de leitura de dados
0643   4960 CD 7B 5E    	call	modoROM
0644   4963 30 08       	jr	nc,.ok
0645   4965 CD EA 4A    	call	marcaErroCartao		; ocorreu erro na leitura, marcar erro
0646   4968             ;	ld	a, ENRDY	; Not ready
0647   4968 3E FD       	ld	a, EDISK	; General unknown disk error
0648   496A 06 00       	ld	b, 0		; informar que lemos 0 blocos
0649   496C C9          	ret
0650   496D             .ok: 
0651   496D AF          	xor	a		; tudo OK, informar ao Nextor
0652   496E C9          	ret
0653   496F             
0654   496F             escrita: 
0655   496F CD F5 4A    	call	testaWP		; testar se cartao esta protegido contra escrita
0656   4972 28 05       	jr	z,.ok
0657   4974 3E F8       	ld	a, EWPROT	; disco protegido
0658   4976 06 00       	ld	b, 0
0659   4978 C9          	ret
0660   4979             .ok: 
0661   4979 1A          	ld	a, (de)		; 1. n. bloco
0662   497A F5          	push	af
0663   497B 13          	inc	de
0664   497C 1A          	ld	a, (de)		; 2. n. bloco
0665   497D F5          	push	af
0666   497E 13          	inc	de
0667   497F 1A          	ld	a, (de)		; 3. n. bloco
0668   4980 13          	inc	de
0669   4981 4F          	ld	c, a
0670   4982 1A          	ld	a, (de)		; 4. n. bloco
0671   4983 13          	inc	de
0672   4984 47          	ld	b, a
0673   4985 F1          	pop	af
0674   4986 57          	ld	d, a
0675   4987 F1          	pop	af		; HL = ponteiro destino
0676   4988 5F          	ld	e, a		; BC DE = 32 bits numero do bloco
0677   4989 CD 73 5E    	call	modoSPI
0678   498C CD 2D 4D    	call	GravarBloco	; chamar rotina de gravacao de dados
0679   498F CD 7B 5E    	call	modoROM
0680   4992 30 08       	jr	nc,.ok2
0681   4994 CD EA 4A    	call	marcaErroCartao		; ocorreu erro, marcar nas flags
0682   4997 3E FE       	ld	a,EWRERR	; Write error
0683   4999 06 00       	ld	b,0
0684   499B C9          	ret
0685   499C             .ok2: 
0686   499C AF          	xor	a			; gravacao sem erros!
0687   499D C9          	ret
0688   499E             
0689   499E             ;-----------------------------------------------------------------------------
0690   499E             ;
0691   499E             ; Device information gathering
0692   499E             ;
0693   499E             ;Input:   A = Device index, 1 to 7
0694   499E             ;         B = Information to return:
0695   499E             ;             0: Basic information
0696   499E             ;             1: Manufacturer name string
0697   499E             ;             2: Device name string
0698   499E             ;             3: Serial number string
0699   499E             ;         HL = Pointer to a buffer in RAM
0700   499E             ;Output:  A = Error code:
0701   499E             ;             0: Ok
0702   499E             ;             1: Device not available or invalid device index
0703   499E             ;             2: Information not available, or invalid information index
0704   499E             ;         When basic information is requested,
0705   499E             ;         buffer filled with the following information:
0706   499E             ;
0707   499E             ;+0 (1): Numer of logical units, from 1 to 7. 1 if the device has no logical
0708   499E             ;        units (which is functionally equivalent to having only one).
0709   499E             ;+1 (1): Device flags, always zero in Beta 2.
0710   499E             ;
0711   499E             ; The strings must be printable ASCII string (ASCII codes 32 to 126),
0712   499E             ; left justified and padded with spaces. All the strings are optional,
0713   499E             ; if not available, an error must be returned.
0714   499E             ; If a string is provided by the device in binary format, it must be reported
0715   499E             ; as an hexadecimal, upper-cased string, preceded by the prefix "0x".
0716   499E             ; The maximum length for a string is 64 characters;
0717   499E             ; if the string is actually longer, the leftmost 64 characters
0718   499E             ; should be provided.
0719   499E             ;
0720   499E             ; In the case of the serial number string, the same rules for the strings
0721   499E             ; apply, except that it must be provided right-justified,
0722   499E             ; and if it is too long, the rightmost characters must be
0723   499E             ; provided, not the leftmost.
0724   499E             
0725   499E             DEV_INFO: 
0726   499E 04          	inc	b
0727   49A0 BF FE 03    	cp	a,3		; somente 2 dispositivos
0728   49A2 30 07       	jr	nc,.saicomerro
0729   49A4 E5          	push	hl
0730   49A5 CD C2 4A    	call	testaCartao	; verificar se cartao esta OK
0731   49A8 E1          	pop	hl
0732   49A9 30 03       	jr	nc,.ok		; nao houve erro
0733   49AB             .saicomerro: 
0734   49AB 3E 01       	ld	a, 1		; informar erro
0735   49AD C9          	ret
0736   49AE             
0737   49AE             .ok: 
0738   49AE 10 07       	djnz	.naoBasic
0739   49B0             ; Basic information:
0740   49B0 3E 01       	ld	a,1		; 1 logical unit somente
0741   49B2 77          	ld	(hl), a
0742   49B3 AF          	xor	a		; reservado, deve ser 0
0743   49B4 23          	inc	hl
0744   49B5 77          	ld	(hl), a
0745   49B6 C9          	ret			; retorna com A=0 (OK)
0746   49B7             
0747   49B7             .naoBasic: 
0748   49B7 E5          	push	hl
0749   49B8 CD 07 4B    	call	calculaCIDoffset	; calculamos em IX a posicao correta do offset CID dependendo do cartao atual
0750   49BB E1          	pop	hl
0751   49BC 10 25       	djnz	.naoManuf
0752   49BE             ; Manufacturer Name:
0753   49BE E5          	push	hl		; salva ponteiro do buffer
0754   49BF 06 40       	ld	b, 64		; preenche buffer com espaco
0755   49C1 3E 20       	ld	a, ' '
0756   49C3             .loop1: 
0757   49C3 77          	ld	(hl), a
0758   49C4 23          	inc	hl
0759   49C5 10 FC       	djnz	.loop1
0760   49C7 D1          	pop	de		; recuperamos ponteiro do buffer em DE
0761   49C8 3E 28       	ld	a, '('		; colocamos (xx) xxx no buffer
0762   49CA 12          	ld	(de), a
0763   49CB 13          	inc	de
0764   49CC DD 7E 00    	ld	a, (ix)		; byte do fabricante
0765   49CF CD 8C 5E    	call	DecToAscii
0766   49D2 3E 29       	ld	a, ')'
0767   49D4 12          	ld	(de), a
0768   49D5 13          	inc	de
0769   49D6 3E 20       	ld	a, ' '
0770   49D8 12          	ld	(de), a
0771   49D9 13          	inc	de
0772   49DA DD 7E 00    	ld	a, (ix)		; byte do fabricante
0773   49DD CD FC 5E    	call	pegaFabricante	; pegar nome do fabricante em HL
0774   49E0 ED B0       	ldir			; e colocar no buffer
0775   49E2 C9          	ret
0776   49E3             
0777   49E3             .naoManuf: 
0778   49E3 10 1A       	djnz	.naoProduct
0779   49E5             ; Product Name:
0780   49E5 E5          	push	hl		; guarda HL que aponta para buffer do Nextor
0781   49E6 DD E5       	push	ix
0782   49E8 E1          	pop	hl		; joga IX para HL
0783   49E9 16 00       	ld	d, 0
0784   49EB 1E 03       	ld	e, 3		; adiciona offset do productname em HL
0785   49ED 19          	add	hl, de
0786   49EE D1          	pop	de		; recupera buffer do Nextor em DE
0787   49EF 01 05 00    	ld	bc, 5		; 5 caracteres
0788   49F2 ED B0       	ldir			; copia nome do produto
0789   49F4 EB          	ex	de,hl		; troca DE com HL, agora HL aponta para Buffer do nextor atualizado
0790   49F5 06 3B       	ld	b, 59		; Coloca espaco no restante do buffer
0791   49F7 3E 20       	ld	a, ' '
0792   49F9             .loop2: 
0793   49F9 77          	ld	(hl), a
0794   49FA 23          	inc	hl
0795   49FB 10 FC       	djnz	.loop2
0796   49FD AF          	xor	a		; informar sem erros
0797   49FE C9          	ret
0798   49FF             
0799   49FF             .naoProduct: 
0800   49FF             ; Serial:
0801   49FF 3E 30       	ld	a, '0'		; Coloca prefixo "0x"
0802   4A01 77          	ld	(hl), a
0803   4A02 23          	inc	hl
0804   4A03 3E 78       	ld	a, 'x'
0805   4A05 77          	ld	(hl), a
0806   4A06 23          	inc	hl
0807   4A07 E5          	push	hl		; guarda HL que aponta para buffer do Nextor
0808   4A08 DD E5       	push	ix
0809   4A0A E1          	pop	hl		; joga IX para HL
0810   4A0B 16 00       	ld	d, 0
0811   4A0D 1E 09       	ld	e, 9		; adiciona offset do productname em HL
0812   4A0F 19          	add	hl, de
0813   4A10 D1          	pop	de		; recupera buffer do nextor em DE
0814   4A11 06 04       	ld	b, 4		; 4 bytes do serial
0815   4A13             .loop3: 
0816   4A13 7E          	ld	a, (hl)
0817   4A14 CD BC 5E    	call	HexToAscii	; converter HEXA para ASCII
0818   4A17 23          	inc	hl
0819   4A18 10 F9       	djnz	.loop3
0820   4A1A 06 36       	ld	b, 54		; Coloca espaco no restante
0821   4A1C 3E 20       	ld	a, ' '
0822   4A1E             .loop4: 
0823   4A1E 12          	ld	(de), a
0824   4A1F 13          	inc	de
0825   4A20 10 FC       	djnz	.loop4
0826   4A22 AF          	xor	a		; informar sem erros
0827   4A23 C9          	ret
0828   4A24             
0829   4A24             ;-----------------------------------------------------------------------------
0830   4A24             ;
0831   4A24             ; Obtain device status
0832   4A24             ;
0833   4A24             ;Input:   A = Device index, 1 to 7
0834   4A24             ;         B = Logical unit number, 1 to 7
0835   4A24             ;             0 to return the status of the device itself.
0836   4A24             ;Output:  A = Status for the specified logical unit,
0837   4A24             ;             or for the whole device if 0 was specified:
0838   4A24             ;                0: The device or logical unit is not available, or the
0839   4A24             ;                   device or logical unit number supplied is invalid.
0840   4A24             ;                1: The device or logical unit is available and has not
0841   4A24             ;                   changed since the last status request.
0842   4A24             ;                2: The device or logical unit is available and has changed
0843   4A24             ;                   since the last status request
0844   4A24             ;                   (for devices, the device has been unplugged and a
0845   4A24             ;                    different device has been plugged which has been
0846   4A24             ;                    assigned the same device index; for logical units,
0847   4A24             ;                    the media has been changed).
0848   4A24             ;                3: The device or logical unit is available, but it is not
0849   4A24             ;                   possible to determine whether it has been changed
0850   4A24             ;                   or not since the last status request.
0851   4A24             ;
0852   4A24             ; Devices not supporting hot-plugging must always return status value 1.
0853   4A24             ; Non removable logical units may return values 0 and 1.
0854   4A24             ;
0855   4A24             ; The returned status is always relative to the previous invokation of
0856   4A24             ; DEV_STATUS itself. Please read the Driver Developer Guide for more info.
0857   4A24             
0858   4A24             DEV_STATUS: 
0859   4A25 BF FE 03    	cp	a,3		; 2 dispositivos somente
0860   4A27 30 3E       	jr	nc,.saicomerro
0861   4A29 05          	dec	b		; 1 logical unit somente
0862   4A2A 20 3B       	jr	nz,.saicomerro
0863   4A2C             
0864   4A2C F5          	push	af
0865   4A2D CD A9 4A    	call	pegaWorkArea	; HL=IY=Work area pointer
0866   4A30 F1          	pop	af
0867   4A31 FD 77 30    	ld	(iy+NUMSD),a	; salva numero do device atual (1 ou 2)
0868   4A34 4F          	ld	c,a		; c=device number
0869   4A35 CD 73 5E    	call	modoSPI
0870   4A38 3A 00 48    	ld	a, (PORTCFG)	; testar se cartao esta inserido
0871   4A3B CD 7B 5E    	call	modoROM
0872   4A3E A1          	and	c		; C contem 1 se cartao 1, 2 se cartao 2
0873   4A3F 20 23       	jr	nz,.cartaoComErro	; se slot do cartao estiver vazio, marcamos o erro nas flags
0874   4A41 FD 7E 31    	ld	a, (iy+FLAGSCARTAO)	; testar bit de erro do cartao nas flags
0875   4A44 A1          	and	c
0876   4A45 28 1A       	jr	z,.semMudanca	; cartao nao marcado com erro, pula
0877   4A47 CD 73 5E    	call	modoSPI
0878   4A4A CD 2F 4B    	call	detectaCartao	; erro na deteccao do cartao, tentar re-detectar
0879   4A4D CD 7B 5E    	call	modoROM
0880   4A50 38 12       	jr	c,.cartaoComErro	; nao conseguimos detectar, sai com erro
0881   4A52 FD 7E 30    	ld	a, (iy+NUMSD)		; conseguimos detectar, tira erro nas flags
0882   4A55 2F          	cpl			; inverte bits para fazer o AND
0883   4A56 4F          	ld	c, a
0884   4A57 FD 7E 31    	ld	a, (iy+FLAGSCARTAO)
0885   4A5A A1          	and	c			; limpa bit
0886   4A5B FD 77 31    	ld	(iy+FLAGSCARTAO), a
0887   4A5E             .comMudanca: 
0888   4A5E 3E 02       	ld	a, 2		; informa ao Nextor que cartao esta OK e mudou
0889   4A60 C9          	ret
0890   4A61             .semMudanca: 
0891   4A61 3E 01       	ld	a, 1		; informa ao Nextor que cartao esta OK e nao mudou
0892   4A63 C9          	ret
0893   4A64             .cartaoComErro: 
0894   4A64 CD EA 4A    	call	marcaErroCartao	; marcar erro do cartao nas flags
0895   4A67             .saicomerro: 
0896   4A67 3E 00       	ld	a, 0		; informa erro
0897   4A69 C9          	ret
0898   4A6A             
0899   4A6A             ;-----------------------------------------------------------------------------
0900   4A6A             ;
0901   4A6A             ; Obtain logical unit information
0902   4A6A             ;
0903   4A6A             ;Input:   A  = Device index, 1 to 7
0904   4A6A             ;         B  = Logical unit number, 1 to 7
0905   4A6A             ;         HL = Pointer to buffer in RAM.
0906   4A6A             ;Output:  A = 0: Ok, buffer filled with information.
0907   4A6A             ;             1: Error, device or logical unit not available,
0908   4A6A             ;                or device index or logical unit number invalid.
0909   4A6A             ;         On success, buffer filled with the following information:
0910   4A6A             ;
0911   4A6A             ;+0 (1): Medium type:
0912   4A6A             ;        0: Block device
0913   4A6A             ;        1: CD or DVD reader or recorder
0914   4A6A             ;        2-254: Unused. Additional codes may be defined in the future.
0915   4A6A             ;        255: Other
0916   4A6A             ;+1 (2): Sector size, 0 if this information does not apply or is
0917   4A6A             ;        not available.
0918   4A6A             ;+3 (4): Total number of available sectors.
0919   4A6A             ;        0 if this information does not apply or is not available.
0920   4A6A             ;+7 (1): Flags:
0921   4A6A             ;        bit 0: 1 if the medium is removable.
0922   4A6A             ;        bit 1: 1 if the medium is read only. A medium that can dinamically
0923   4A6A             ;               be write protected or write enabled is not considered
0924   4A6A             ;               to be read-only.
0925   4A6A             ;        bit 2: 1 if the LUN is a floppy disk drive.
0926   4A6A             ;+8 (2): Number of cylinders
0927   4A6A             ;+10 (1): Number of heads
0928   4A6A             ;+11 (1): Number of sectors per track
0929   4A6A             ;
0930   4A6A             ; Number of cylinders, heads and sectors apply to hard disks only.
0931   4A6A             ; For other types of device, these fields must be zero.
0932   4A6A             
0933   4A6A             LUN_INFO: 
0934   4A6B BF FE 03    	cp	a, 3		; somente 2 dispositivo
0935   4A6D 30 0A       	jr	nc,.saicomerro
0936   4A6F 05          	dec	b		; somente 1 logical unit
0937   4A70 20 07       	jr	nz,.saicomerro
0938   4A72 E5          	push	hl
0939   4A73 CD C2 4A    	call	testaCartao
0940   4A76 E1          	pop	hl
0941   4A77 30 03       	jr	nc,.ok		; nao tem erro com o cartao
0942   4A79             .saicomerro: 
0943   4A79 3E 01       	ld	a, 1		; informar erro
0944   4A7B C9          	ret
0945   4A7C             .ok: 
0946   4A7C E5          	push	hl
0947   4A7D CD 1B 4B    	call	calculaBLOCOSoffset	; calcular em IX e HL o offset correto do buffer que armazena total de blocos
0948   4A80 E1          	pop	hl		; do cartao dependendo do cartao atual solicitado
0949   4A81 AF          	xor	a
0950   4A82 77          	ld	(hl), a		; Informar que o dispositivo eh do tipo block device
0951   4A83 23          	inc	hl
0952   4A84 77          	ld	(hl), a		; tamanho de um bloco = 512 bytes (coloca $00, $02 que é $200 = 512)
0953   4A85 23          	inc	hl
0954   4A86 3E 02       	ld	a, 2
0955   4A88 77          	ld	(hl), a
0956   4A89 23          	inc	hl
0957   4A8A DD 7E 00    	ld	a, (ix)		; copia numero de blocos total
0958   4A8D 77          	ld	(hl), a
0959   4A8E 23          	inc	hl
0960   4A8F DD 7E 01    	ld	a, (ix+1)
0961   4A92 77          	ld	(hl), a
0962   4A93 23          	inc	hl
0963   4A94 DD 7E 02    	ld	a, (ix+2)
0964   4A97 77          	ld	(hl), a
0965   4A98 23          	inc	hl
0966   4A99 AF          	xor	a		; cartoes SD tem total de blocos em 24 bits, mas o Nextor pede numero de
0967   4A9A 77          	ld	(hl), a 	; 32 bits, entao coloca 0 no MSB
0968   4A9B 23          	inc	hl
0969   4A9C 3E 01       	ld	a, 1		; flags: dispositivo R/W removivel
0970   4A9E 77          	ld	(hl), a
0971   4A9F 23          	inc	hl
0972   4AA0 AF          	xor	a		; CHS = 0
0973   4AA1 77          	ld	(hl), a
0974   4AA2 23          	inc	hl
0975   4AA3 77          	ld	(hl), a
0976   4AA4 23          	inc	hl
0977   4AA5 77          	ld	(hl), a
0978   4AA6 23          	inc	hl
0979   4AA7 AF          	xor	a		; informar que dados foram preenchidos
0980   4AA8 C9          	ret
0981   4AA9             
0982   4AA9             ;=====
0983   4AA9             ;=====  END of DEVICE-BASED specific routines
0984   4AA9             ;=====
0985   4AA9             
0986   4AA9             ;------------------------------------------------
0987   4AA9             ; Rotinas auxiliares
0988   4AA9             ;------------------------------------------------
0989   4AA9             
0990   4AA9             ;------------------------------------------------
0991   4AA9             ; Pedir ao Nextor o ponteiro de dados de trabalho
0992   4AA9             ; na RAM e colocar em HL e IY
0993   4AA9             ; Destroi HL e IY
0994   4AA9             ;------------------------------------------------
0995   4AA9             pegaWorkArea: 
0996   4AA9 F5          	push	af
0997   4AAA AF          	xor	a		; Pegar endereco da area de trabalho
0998   4AAB 08          	ex	af,af'
0999   4AAC AF          	xor	a
1000   4AAD DD 21 45 40 	ld	ix, GWORK
1001   4AB1 CD 7B 5E    	call	modoROM
1002   4AB4 CD 42 40    	call	CALBNK
1003   4AB7 DD 6E 00    	ld	l,(ix)		; em HL tem o ponteiro da nossa area da RAM
1004   4ABA DD 66 01    	ld	h,(ix+1)
1005   4ABD E5          	push	hl
1006   4ABE FD E1       	pop	iy		; em IY temos o mesmo ponteiro
1007   4AC0 F1          	pop	af
1008   4AC1 C9          	ret
1009   4AC2             
1010   4AC2             ;------------------------------------------------
1011   4AC2             ; Testa se cartao esta inserido e/ou houve erro
1012   4AC2             ; na ultima vez que foi acessado. Carry indica
1013   4AC2             ; erro
1014   4AC2             ; Destroi AF, HL, IX, C
1015   4AC2             ;------------------------------------------------
1016   4AC2             testaCartao: 
1017   4AC2 F5          	push	af
1018   4AC3 CD A9 4A    	call	pegaWorkArea	; HL=IY=Work area pointer
1019   4AC6 F1          	pop	af
1020   4AC7 FD 77 30    	ld	(iy+NUMSD), a	; salva numero do device atual (1 ou 2)
1021   4ACA 4F          	ld	c, a
1022   4ACB CD 73 5E    	call	modoSPI
1023   4ACE 3A 00 48    	ld	a, (PORTCFG)	; testar se cartao esta inserido
1024   4AD1 CD 7B 5E    	call	modoROM
1025   4AD4 A1          	and	c		; C contem 1 se cartao 1, 2 se cartao 2
1026   4AD5 20 0A       	jr	nz,.saicomerro				
1027   4AD7 FD 7E 31    	ld	a, (iy+FLAGSCARTAO)	; testar bit de erro do cartao nas flags
1028   4ADA A1          	and	c
1029   4ADB 28 02       	jr	z,.ok
1030   4ADD 37          	scf			; indica erro
1031   4ADE C9          	ret
1032   4ADF             .ok: 
1033   4ADF AF          	xor	a		; zera carry indicando sem erro
1034   4AE0 C9          	ret
1035   4AE1             .saicomerro: 
1036   4AE1 FD 7E 31    	ld	a, (iy+FLAGSCARTAO)	; marca bit de erro nas flags
1037   4AE4 B1          	or	c
1038   4AE5 FD 77 31    	ld	(iy+FLAGSCARTAO), a
1039   4AE8 37          	scf
1040   4AE9 C9          	ret
1041   4AEA             
1042   4AEA             ;------------------------------------------------
1043   4AEA             ; Marcar bit de erro nas flags
1044   4AEA             ; Destroi AF, C
1045   4AEA             ;------------------------------------------------
1046   4AEA             marcaErroCartao: 
1047   4AEA FD 4E 30    	ld	c, (iy+NUMSD)		; cartao atual (1 ou 2)
1048   4AED FD 7E 31    	ld	a, (iy+FLAGSCARTAO)	; marcar erro
1049   4AF0 B1          	or	c
1050   4AF1 FD 77 31    	ld	(iy+FLAGSCARTAO), a
1051   4AF4 C9          	ret
1052   4AF5             
1053   4AF5             ;------------------------------------------------
1054   4AF5             ; Testar se cartao atual esta protegido contra
1055   4AF5             ; gravacao, A=0 se protegido
1056   4AF5             ; Destroi AF, C
1057   4AF5             ;------------------------------------------------
1058   4AF5             testaWP: 
1059   4AF5 FD 4E 30    	ld	c, (iy+NUMSD)	; cartao atual (1 ou 2)
1060   4AF8 CB 01       	rlc	c		; desloca para apontar para bits 2 ou 3 para cartoes 1 ou 2 respectivamente
1061   4AFA CB 01       	rlc	c
1062   4AFC CD 73 5E    	call	modoSPI
1063   4AFF 3A 00 48    	ld	a, (PORTCFG)	; testar se cartao esta protegido
1064   4B02 CD 7B 5E    	call	modoROM
1065   4B05 A1          	and	c
1066   4B06 C9          	ret			; se A for 0 cartao esta protegido
1067   4B07             
1068   4B07             ;------------------------------------------------
1069   4B07             ; Calcula offset do buffer na RAM em HL e IX para
1070   4B07             ; os dados do CID dependendo do cartao atual
1071   4B07             ; Destroi AF, DE, HL e IX
1072   4B07             ;------------------------------------------------
1073   4B07             calculaCIDoffset: 
1074   4B07 FD E5       	push	iy		; copiamos IY para HL
1075   4B09 E1          	pop	hl
1076   4B0A 16 00       	ld	d, 0
1077   4B0C 1E 10       	ld	e, BCID1	; DE aponta para buffer BCID1
1078   4B0E FD 7E 30    	ld	a, (iy+NUMSD)	; vamos fazer IX apontar para o buffer correto
1079   4B11 3D          	dec	a		; dependendo do cartao: BCID1 ou BCID2
1080   4B12 28 02       	jr	z,.c1
1081   4B14 1E 20       	ld	e, BCID2	; DE aponta para buffer BCID2
1082   4B16             .c1: 
1083   4B16 19          	add	hl, de		; HL aponta para buffer correto
1084   4B17 E5          	push	hl		
1085   4B18 DD E1       	pop	ix		; vamos colocar HL em IX
1086   4B1A C9          	ret
1087   4B1B             
1088   4B1B             ;------------------------------------------------
1089   4B1B             ; Calcula offset do buffer na RAM para os dados
1090   4B1B             ; do total de blocos dependendo do cartao atual
1091   4B1B             ; Offset fica em HL e IX
1092   4B1B             ; Destroi AF, DE, HL e IX
1093   4B1B             ;------------------------------------------------
1094   4B1B             calculaBLOCOSoffset: 
1095   4B1B FD E5       	push	iy		; copiamos IY para HL
1096   4B1D E1          	pop	hl
1097   4B1E 16 00       	ld	d, 0
1098   4B20 1E 38       	ld	e, BLOCOS1	; DE aponta para buffer BLOCOS1
1099   4B22 FD 7E 30    	ld	a, (iy+NUMSD)	; Vamos fazer IX apontar para o buffer correto
1100   4B25 3D          	dec	a		; dependendo do cartao: BLOCOS1 ou BLOCOS2
1101   4B26 28 02       	jr	z,.c1
1102   4B28 1E 3C       	ld	e, BLOCOS2	; DE aponta para buffer BLOCOS2
1103   4B2A             .c1: 
1104   4B2A 19          	add	hl, de		; HL aponta para buffer correto
1105   4B2B E5          	push	hl		
1106   4B2C DD E1       	pop	ix		; Vamos colocar HL em IX
1107   4B2E C9          	ret
1108   4B2F             
1109   4B2F             
1110   4B2F             ;------------------------------------------------
1111   4B2F             ; Minhas funcoes para cartao SD
1112   4B2F             ;------------------------------------------------
1113   4B2F             
1114   4B2F             ;------------------------------------------------
1115   4B2F             ; Processo de inicializacao e deteccao do cartao.
1116   4B2F             ; Detecta se cartao responde, qual versao (SDV1
1117   4B2F             ; ou SDV2), faz a leitura do CSD e CID e calcula
1118   4B2F             ; o numero de blocos do cartao, colocando o CID
1119   4B2F             ; e total de blocos no buffer correto dependendo
1120   4B2F             ; do cartao 1 ou 2.
1121   4B2F             ; Retorna erro no carry. Se for 0 indica deteccao
1122   4B2F             ; com sucesso.
1123   4B2F             ; Destroi todos os registradores
1124   4B2F             ;------------------------------------------------
1125   4B2F             detectaCartao: 
1126   4B2F CD 5E 4C    	call	iniciaSD	; manda pulsos de clock e comandos iniciais
1127   4B32 D8          	ret	c			; retorna se erro
1128   4B33 CD FE 4B    	call	testaSDCV2	; tenta inicializar um cartao SDV2
1129   4B36 D8          	ret	c
1130   4B37 FD E5       	push	iy		; colocar em HL buffer da RAM de trabalho
1131   4B39 E1          	pop	hl		; CSD esta no offset 0, nao precisamos somar
1132   4B3A 3E 49       	ld	a, CMD9		; ler CSD
1133   4B3C CD 1F 4C    	call	lerBlocoCxD
1134   4B3F D8          	ret	c
1135   4B40 CD 07 4B    	call	calculaCIDoffset	; calculamos em IX e HL a posicao correta do offset CID dependendo do cartao atual
1136   4B43 3E 4A       	ld	a, CMD10	; ler CID
1137   4B45 CD 1F 4C    	call	lerBlocoCxD
1138   4B48 D8          	ret	c
1139   4B49 3E 7A       	ld	a, CMD58	; ler OCR
1140   4B4B 11 00 00    	ld	de, 0
1141   4B4E CD AF 4C    	call	SD_SEND_CMD_2_ARGS_GET_R3	; enviar comando e receber resposta tipo R3
1142   4B51 D8          	ret	c
1143   4B52 78          	ld	a, b		; testa bit CCS do OCR que informa se cartao eh SDV1 ou SDV2
1144   4B53 E6 40       	and	$40
1145   4B55 DD 77 0F    	ld	(ix+15), a	; salva informacao da versao do SD (V1 ou V2) no byte 15 do CID
1146   4B58 CC F3 4B    	call	z,mudarTamanhoBlocoPara512	; se bit CCS do OCR for 1, eh cartao SDV2 (Block address - SDHC ou SDXD)
1147   4B5B D8          	ret	c		; e nao precisamos mudar tamanho do bloco para 512
1148   4B5C CD 7D 4C    	call	desabilitaSDs
1149   4B5F             				; agora vamos calcular o total de blocos dependendo dos dados do CSD
1150   4B5F CD 1B 4B    	call	calculaBLOCOSoffset	; calcular em IX e HL o offset correto do buffer que armazena total de blocos
1151   4B62 FD E5       	push	iy		; copiamos IY para HL
1152   4B64 E1          	pop	hl
1153   4B65 16 00       	ld	d, 0
1154   4B67 1E 05       	ld	e, BCSD+5
1155   4B69 19          	add	hl, de		; HL aponta para buffer BCSD+5
1156   4B6A FD 7E 00    	ld	a, (iy+BCSD)
1157   4B6D E6 C0       	and	$C0		; testa versao do registro CSD
1158   4B6F 28 06       	jr	z,.calculaCSD1
1159   4B71 FE 40       	cp	$40
1160   4B73 28 54       	jr	z,.calculaCSD2
1161   4B75 37          	scf			; versao do registro CSD nao reconhecida, informa erro na deteccao
1162   4B76 C9          	ret
1163   4B77             
1164   4B77             ; -----------------------------------
1165   4B77             ; Registro CSD versao 1, calcular da
1166   4B77             ; maneira correta para a versao 1
1167   4B77             ; -----------------------------------
1168   4B77             .calculaCSD1: 
1169   4B77 7E          	ld	a, (hl)
1170   4B78 E6 0F       	and	$0F		; isola READ_BL_LEN
1171   4B7A F5          	push	af
1172   4B7B 23          	inc	hl
1173   4B7C 7E          	ld	a, (hl)		; 2 primeiros bits de C_SIZE
1174   4B7D E6 03       	and	3
1175   4B7F 57          	ld	d, a
1176   4B80 23          	inc	hl
1177   4B81 5E          	ld	e, (hl)		; 8 bits de C_SIZE (DE contem os primeiros 10 bits de C_SIZE)
1178   4B82 23          	inc	hl
1179   4B83 7E          	ld	a, (hl)
1180   4B84 E6 C0       	and	$C0		; 2 ultimos bits de C_SIZE
1181   4B86 87          	add	a, a		; rotaciona a esquerda
1182   4B87 CB 13       	rl	e		; rotaciona para DE
1183   4B89 CB 12       	rl	d
1184   4B8B 87          	add	a, a		; mais uma rotacao
1185   4B8C CB 13       	rl	e		; rotaciona para DE
1186   4B8E CB 12       	rl	d
1187   4B90 13          	inc	de		; agora DE contem todos os 12 bits de C_SIZE, incrementa 1
1188   4B91 23          	inc	hl
1189   4B92 7E          	ld	a, (hl)		; proximo byte
1190   4B93 E6 03       	and	3		; 2 bits de C_SIZE_MUL
1191   4B95 47          	ld	b, a		; B contem os 2 bits de C_SIZE_MUL
1192   4B96 23          	inc	hl						
1193   4B97 7E          	ld	a, (hl)		; proximo byte
1194   4B98 E6 80       	and	$80		; 1 bit de C_SIZE_MUL
1195   4B9A 87          	add	a, a		; rotaciona para esquerda jogando no carry
1196   4B9B CB 10       	rl	b		; rotaciona para B
1197   4B9D 04          	inc	b		; agora B contem os 3 bits de C_SIZE_MUL
1198   4B9E 04          	inc	b		; faz B = C_SIZE_MUL + 2
1199   4B9F F1          	pop	af		; volta em A o READ_BL_LEN
1200   4BA0 80          	add	a, b		; A = READ_BL_LEN + (C_SIZE_MUL+2)
1201   4BA1 01 00 00    	ld	bc, 0
1202   4BA4 CD BD 4B    	call	.eleva2
1203   4BA7 5A          	ld	e, d		; aqui temos 32 bits (BC DE) com o tamanho do cartao
1204   4BA8 51          	ld	d, c		; ignoramos os 8 ultimos bits em E, fazemos BC DE => 0B CD (divide por 256)
1205   4BA9 48          	ld	c, b
1206   4BAA 06 00       	ld	b, 0
1207   4BAC CB 39       	srl	c		; rotacionamos a direita o C, carry = LSB (divide por 2)
1208   4BAE CB 1A       	rr	d		; rotacionamos D e E
1209   4BB0 CB 1B       	rr	e		; no final BC DE contem tamanho do cartao / 512 = numero de blocos
1210   4BB2             .salvaBlocos: 
1211   4BB2 DD 71 02    	ld	(ix+2), c	; colocar no buffer BLOCOS correto a quantidade de blocos
1212   4BB5 DD 72 01    	ld	(ix+1), d	; que o cartao (1 ou 2) tem
1213   4BB8 DD 73 00    	ld	(ix), e
1214   4BBB AF          	xor	a		; limpa carry
1215   4BBC C9          	ret
1216   4BBD             
1217   4BBD             .eleva2: 			; aqui temos: A = (READ_BL_LEN + (C_SIZE_MUL+2))
1218   4BBD             				; BC = 0
1219   4BBD             				; DE = C_SIZE
1220   4BBD CB 23       	sla	e		; rotacionamos C_SIZE por 'A' vezes
1221   4BBF CB 12       	rl	d
1222   4BC1 CB 11       	rl	c
1223   4BC3 CB 10       	rl	b
1224   4BC5 3D          	dec	a		; subtraimos 1
1225   4BC6 20 F5       	jr	nz,.eleva2
1226   4BC8 C9          	ret			; em BC DE temos o tamanho do cartao (bytes) em 32 bits
1227   4BC9             
1228   4BC9             ; -----------------------------------
1229   4BC9             ; Registro CSD versao 2, calcular da
1230   4BC9             ; maneira correta para a versao 2
1231   4BC9             ; -----------------------------------
1232   4BC9             .calculaCSD2: 
1233   4BC9 23          	inc	hl		; HL ja aponta para BCSD+5, fazer HL apontar para BCSD+7
1234   4BCA 23          	inc	hl
1235   4BCB 7E          	ld	a, (hl)
1236   4BCC E6 3F       	and	$3F
1237   4BCE 4F          	ld	c, a
1238   4BCF 23          	inc	hl
1239   4BD0 56          	ld	d, (hl)
1240   4BD1 23          	inc	hl
1241   4BD2 5E          	ld	e, (hl)
1242   4BD3 CD DF 4B    	call	.inc32		; soma 1
1243   4BD6 CD E7 4B    	call	.desloca32	; multiplica por 512
1244   4BD9 CD EC 4B    	call	.rotaciona24	; multiplica por 2
1245   4BDC C3 B2 4B    	jp		.salvaBlocos
1246   4BDF             
1247   4BDF             .inc32: 
1248   4BDF 1C          	inc	e
1249   4BE0 C0          	ret	nz
1250   4BE1 14          	inc	d
1251   4BE2 C0          	ret	nz
1252   4BE3 0C          	inc	c
1253   4BE4 C0          	ret	nz
1254   4BE5 04          	inc	b
1255   4BE6 C9          	ret
1256   4BE7             
1257   4BE7             .desloca32: 
1258   4BE7 41          	ld	b, c
1259   4BE8 4A          	ld	c, d
1260   4BE9 53          	ld	d, e
1261   4BEA 1E 00       	ld	e, 0
1262   4BEC             .rotaciona24: 
1263   4BEC CB 22       	sla	d
1264   4BEE CB 11       	rl	c
1265   4BF0 CB 10       	rl	b
1266   4BF2 C9          	ret
1267   4BF3             
1268   4BF3             ; ------------------------------------------------
1269   4BF3             ; Setar o tamanho do bloco para 512 se o cartao
1270   4BF3             ; for SDV1
1271   4BF3             ; ------------------------------------------------
1272   4BF3             mudarTamanhoBlocoPara512: 
1273   4BF3 3E 50       	ld	a, CMD16
1274   4BF5 01 00 00    	ld	bc, 0
1275   4BF8 11 00 02    	ld	de, 512
1276   4BFB C3 9A 4C    	jp	SD_SEND_CMD_GET_ERROR
1277   4BFE             
1278   4BFE             ; ------------------------------------------------
1279   4BFE             ; Tenta inicializar um cartao SDV2, se houver erro
1280   4BFE             ; o cartao deve ser SDV1
1281   4BFE             ; ------------------------------------------------
1282   4BFE             testaSDCV2: 
1283   4BFE 3E 48       	ld	a, CMD8
1284   4C00 11 AA 01    	ld	de, $1AA
1285   4C03 CD AF 4C    	call	SD_SEND_CMD_2_ARGS_GET_R3
1286   4C06 21 93 4C    	ld	hl, SD_SEND_CMD1	; HL aponta para rotina correta
1287   4C09 38 03       	jr	c,.pula		; cartao recusou CMD8, enviar comando CMD1
1288   4C0B 21 85 4C    	ld	hl, SD_SEND_ACMD41	; cartao aceitou CMD8, enviar comando ACMD41
1289   4C0E             .pula: 
1290   4C0E 01 14 00    	ld	bc, 20		; B = 0, C = 20: 5120 tentativas
1291   4C11             .loop: 
1292   4C11 C5          	push	bc
1293   4C12 CD 1E 4C    	call	.jumpHL		; chamar rotina correta em HL
1294   4C15 C1          	pop	bc
1295   4C16 D0          	ret	nc
1296   4C17 10 F8       	djnz	.loop
1297   4C19 0D          	dec	c
1298   4C1A 20 F5       	jr	nz,.loop
1299   4C1C 37          	scf
1300   4C1D C9          	ret
1301   4C1E             .jumpHL: 
1302   4C1E E9          	jp	(hl)		; chamar rotina correta em HL
1303   4C1F             
1304   4C1F             ; ------------------------------------------------
1305   4C1F             ; Ler registro CID ou CSD, o comando vem em A
1306   4C1F             ; ------------------------------------------------
1307   4C1F             lerBlocoCxD: 
1308   4C1F CD 95 4C    	call	SD_SEND_CMD_NO_ARGS
1309   4C22 D8          	ret	c
1310   4C23 CD F4 4C    	call	WAIT_RESP_FE
1311   4C26 D8          	ret	c
1312   4C27 EB          	ex	de,hl
1313   4C28             
1314   4C28             	; Check for a Z80 or R800
1315   4C28             ;	or 	a		; Clear Cy
1316   4C28 3E 14       	ld	a,20
1317   4C2A ED F9       	db	#ED,#F9		; mulub a,a
1318   4C2C 21 00 40    	ld	hl, PORTSPI
1319   4C2F 38 26       	jr	c,.r800		; Use LDIR for R800
1320   4C31 ED A0       > ldi	
1320   4C33 ED A0       > ldi	
1320   4C35 ED A0       > ldi	
1320   4C37 ED A0       > ldi	
1320   4C39 ED A0       > ldi	
1320   4C3B ED A0       > ldi	
1320   4C3D ED A0       > ldi	
1320   4C3F ED A0       > ldi	
1320   4C41 ED A0       > ldi	
1320   4C43 ED A0       > ldi	
1320   4C45 ED A0       > ldi	
1320   4C47 ED A0       > ldi	
1320   4C49 ED A0       > ldi	
1320   4C4B ED A0       > ldi	
1320   4C4D ED A0       > ldi	
1320   4C4F ED A0       > ldi	
1321   4C51             .end
1322   4C51 7E           	ld	a, (hl)
1323   4C52 7E          	ld	a, (hl)		; byte de resposta
1324   4C53 B7          	or	a
1325   4C54 EB          	ex	de,hl
1326   4C55 18 26       	jr		desabilitaSDs
1327   4C57             
1328   4C57             .r800: 
1329   4C57 01 10 00    	ld	bc,16
1330   4C5A ED B0       	ldir
1331   4C5C 18 F3       	jr	.end
1332   4C5E             
1333   4C5E             ; ------------------------------------------------
1334   4C5E             ; Algoritmo para inicializar um cartao SD
1335   4C5E             ; Destroi AF, B, DE
1336   4C5E             ; ------------------------------------------------
1337   4C5E             iniciaSD: 
1338   4C5E CD 7D 4C    	call	desabilitaSDs
1339   4C61             
1340   4C61 06 0A       	ld	b, 10		; enviar 80 pulsos de clock com cartao desabilitado
1341   4C63             enviaClocksInicio: 
1342   4C63 3E FF       	ld	a, $FF		; manter MOSI em 1
1343   4C65 32 00 40    	ld	(PORTSPI), a
1344   4C68 10 F9       	djnz	enviaClocksInicio
1345   4C6A CD 20 4D    	call	setaSDAtual	; ativar cartao atual
1346   4C6D 06 08       	ld	b, 8		; 8 tentativas para CMD0
1347   4C6F             SD_SEND_CMD0: 
1348   4C6F 3E 40       	ld	a, CMD0		; primeiro comando: CMD0
1349   4C71 11 00 00    	ld	de, 0
1350   4C74 C5          	push	bc
1351   4C75 CD A2 4C    	call	SD_SEND_CMD_2_ARGS_TEST_BUSY
1352   4C78 C1          	pop	bc
1353   4C79 D0          	ret	nc			; retorna se cartao respondeu ao CMD0
1354   4C7A 10 F3       	djnz	SD_SEND_CMD0
1355   4C7C 37          	scf			; cartao nao respondeu ao CMD0, informar erro
1356   4C7D             	; fall throw
1357   4C7D             
1358   4C7D             ; ------------------------------------------------
1359   4C7D             ; Desabilitar (de-selecionar) todos os cartoes
1360   4C7D             ; Nao destroi registradores
1361   4C7D             ; ------------------------------------------------
1362   4C7D             desabilitaSDs: 
1363   4C7D F5          	push	af
1364   4C7E 3E FF       	ld	a, $FF		; todos os /CS em 1
1365   4C80 32 00 48    	ld	(PORTCFG), a
1366   4C83 F1          	pop	af
1367   4C84 C9          	ret
1368   4C85             
1369   4C85             ; ------------------------------------------------
1370   4C85             ; Enviar comando ACMD41
1371   4C85             ; ------------------------------------------------
1372   4C85             SD_SEND_ACMD41: 
1373   4C85 3E 77       	ld	a, CMD55
1374   4C87 CD 95 4C    	call	SD_SEND_CMD_NO_ARGS
1375   4C8A 3E 69       	ld	a, ACMD41
1376   4C8C 01 00 40    	ld	bc, $4000
1377   4C8F 51          	ld	d, c
1378   4C90 59          	ld	e, c
1379   4C91 18 07       	jr		SD_SEND_CMD_GET_ERROR
1380   4C93             
1381   4C93             ; ------------------------------------------------
1382   4C93             ; Enviar CMD1 para cartao. Carry indica erro
1383   4C93             ; Destroi AF, BC, DE
1384   4C93             ; ------------------------------------------------
1385   4C93             SD_SEND_CMD1: 
1386   4C93 3E 41       	ld	a, CMD1
1387   4C95             SD_SEND_CMD_NO_ARGS: 
1388   4C95 01 00 00    	ld	bc, 0
1389   4C98 50          	ld	d, b
1390   4C99 59          	ld	e, c
1391   4C9A             SD_SEND_CMD_GET_ERROR: 
1392   4C9A CD C8 4C    	call	SD_SEND_CMD
1393   4C9D B7          	or	a
1394   4C9E C8          	ret	z			; se A=0 nao houve erro, retornar
1395   4C9F             	; fall throw
1396   4C9F             
1397   4C9F             ; ------------------------------------------------
1398   4C9F             ; Informar erro
1399   4C9F             ; Nao destroi registradores
1400   4C9F             ; ------------------------------------------------
1401   4C9F             setaErro: 
1402   4C9F 37          	scf
1403   4CA0 18 DB       	jr		desabilitaSDs
1404   4CA2             
1405   4CA2             ; ------------------------------------------------
1406   4CA2             ; Enviar comando em A com 2 bytes de parametros
1407   4CA2             ; em DE e testar retorno BUSY
1408   4CA2             ; Retorna em A a resposta do cartao
1409   4CA2             ; Destroi AF, BC
1410   4CA2             ; ------------------------------------------------
1411   4CA2             SD_SEND_CMD_2_ARGS_TEST_BUSY: 
1412   4CA2 01 00 00    	ld	bc, 0
1413   4CA5 CD C8 4C    	call	SD_SEND_CMD
1414   4CA8 47          	ld	b, a
1415   4CA9 E6 FE       	and	$FE		; testar bit 0 (flag BUSY)
1416   4CAB 78          	ld	a, b
1417   4CAC 20 F1       	jr	nz,setaErro	; BUSY em 1, informar erro
1418   4CAE C9          	ret			; sem erros
1419   4CAF             
1420   4CAF             ; ------------------------------------------------
1421   4CAF             ; Enviar comando em A com 2 bytes de parametros
1422   4CAF             ; em DE e ler resposta do tipo R3 em BC DE
1423   4CAF             ; Retorna em A a resposta do cartao
1424   4CAF             ; Destroi AF, BC, DE, HL
1425   4CAF             ; ------------------------------------------------
1426   4CAF             SD_SEND_CMD_2_ARGS_GET_R3: 
1427   4CAF CD A2 4C    	call	SD_SEND_CMD_2_ARGS_TEST_BUSY
1428   4CB2 D8          	ret	c
1429   4CB3 F5          	push	af
1430   4CB4 CD 02 4D    	call	WAIT_RESP_NO_FF
1431   4CB7 67          	ld	h, a
1432   4CB8 CD 02 4D    	call	WAIT_RESP_NO_FF
1433   4CBB 6F          	ld	l, a
1434   4CBC CD 02 4D    	call	WAIT_RESP_NO_FF
1435   4CBF 57          	ld	d, a
1436   4CC0 CD 02 4D    	call	WAIT_RESP_NO_FF
1437   4CC3 5F          	ld	e, a
1438   4CC4 44          	ld	b, h
1439   4CC5 4D          	ld	c, l
1440   4CC6 F1          	pop	af
1441   4CC7 C9          	ret
1442   4CC8             
1443   4CC8             ; ------------------------------------------------
1444   4CC8             ; Enviar comando em A com 4 bytes de parametros
1445   4CC8             ; em BC DE e enviar CRC correto se for CMD0 ou 
1446   4CC8             ; CMD8 e aguardar processamento do cartao
1447   4CC8             ; Destroi AF, BC
1448   4CC8             ; ------------------------------------------------
1449   4CC8             SD_SEND_CMD: 
1450   4CC8 CD 20 4D    	call	setaSDAtual
1451   4CCB 32 00 40    	ld	(PORTSPI), a
1452   4CCE F5          	push	af
1453   4CCF 78          	ld	a, b
1454   4CD0 32 00 40    	ld	(PORTSPI), a
1455   4CD3 79          	ld	a, c
1456   4CD4 32 00 40    	ld	(PORTSPI), a
1457   4CD7 7A          	ld	a, d
1458   4CD8 32 00 40    	ld	(PORTSPI), a
1459   4CDB 7B          	ld	a, e
1460   4CDC 32 00 40    	ld	(PORTSPI), a
1461   4CDF F1          	pop	af
1462   4CE0 FE 40       	cp	CMD0
1463   4CE2 06 95       	ld	b, $95		; CRC para CMD0
1464   4CE4 28 08       	jr	z,enviaCRC
1465   4CE6 FE 48       	cp	CMD8
1466   4CE8 06 87       	ld	b, $87		; CRC para CMD8
1467   4CEA 28 02       	jr	z,enviaCRC
1468   4CEC 06 FF       	ld	b, $FF		; CRC dummy
1469   4CEE             enviaCRC: 
1470   4CEE 78          	ld	a, b
1471   4CEF 32 00 40    	ld	(PORTSPI), a
1472   4CF2 18 0E       	jr	WAIT_RESP_NO_FF
1473   4CF4             
1474   4CF4             ; ------------------------------------------------
1475   4CF4             ; Esperar que resposta do cartao seja $FE
1476   4CF4             ; Destroi AF, B
1477   4CF4             ; ------------------------------------------------
1478   4CF4             WAIT_RESP_FE: 
1479   4CF4 06 0A       	ld	b, 10		; 10 tentativas
1480   4CF6             .loop: 
1481   4CF6 C5          	push	bc
1482   4CF7 CD 02 4D    	call	WAIT_RESP_NO_FF	; esperar resposta diferente de $FF
1483   4CFA C1          	pop	bc
1484   4CFB FE FE       	cp	$FE		; resposta é $FE ?
1485   4CFD C8          	ret	z		; sim, retornamos com carry=0
1486   4CFE 10 F6       	djnz	.loop
1487   4D00 37          	scf			; erro, carry=1
1488   4D01 C9          	ret
1489   4D02             
1490   4D02             ; ------------------------------------------------
1491   4D02             ; Esperar que resposta do cartao seja diferente
1492   4D02             ; de $FF
1493   4D02             ; Destroi AF, BC
1494   4D02             ; ------------------------------------------------
1495   4D02             WAIT_RESP_NO_FF: 
1496   4D02 01 01 00    	ld	bc, 1		; 256 tentativas
1497   4D05             .loop: 
1498   4D05 3A 00 40    	ld	a, (PORTSPI)
1499   4D08 FE FF       	cp	$FF		; testa $FF
1500   4D0A C0          	ret		nz		; sai se nao for $FF
1501   4D0B 10 F8       	djnz	.loop
1502   4D0D 0D          	dec	c
1503   4D0E 20 F5       	jr	nz,.loop
1504   4D10 C9          	ret
1505   4D11             
1506   4D11             ; ------------------------------------------------
1507   4D11             ; Esperar que resposta do cartao seja diferente
1508   4D11             ; de $00
1509   4D11             ; Destroi A, BC
1510   4D11             ; ------------------------------------------------
1511   4D11             WAIT_RESP_NO_00: 
1512   4D11 01 80 00    	ld	bc, 128		; 32768 tentativas
1513   4D14             .loop: 
1514   4D14 3A 00 40    	ld	a, (PORTSPI)
1515   4D17 B7          	or	a
1516   4D18 C0          	ret	nz			; se resposta for <> $00, sai
1517   4D19 10 F9       	djnz	.loop
1518   4D1B 0D          	dec	c
1519   4D1C 20 F6       	jr	nz,.loop
1520   4D1E 37          	scf			; erro
1521   4D1F C9          	ret
1522   4D20             
1523   4D20             ; ------------------------------------------------
1524   4D20             ; Ativa (seleciona) cartao atual baixando seu /CS
1525   4D20             ; Nao destroi registradores
1526   4D20             ; ------------------------------------------------
1527   4D20             setaSDAtual: 
1528   4D20 F5          	push	af
1529   4D21 3A 00 40    	ld	a, (PORTSPI)	; dummy read
1530   4D24 FD 7E 30    	ld	a, (iy+NUMSD)
1531   4D27 2F          	cpl			; inverte bits
1532   4D28 32 00 48    	ld	(PORTCFG), a
1533   4D2B F1          	pop	af
1534   4D2C C9          	ret
1535   4D2D             
1536   4D2D             
1537   4D2D             ; ------------------------------------------------
1538   4D2D             ; Grava um bloco de 512 bytes no cartao
1539   4D2D             ; HL aponta para o inicio dos dados
1540   4D2D             ; BC e DE contem o numero do bloco (BCDE = 32 bits)
1541   4D2D             ; Destroi AF, BC, DE, HL
1542   4D2D             ; ------------------------------------------------
1543   4D2D             GravarBloco: 
1544   4D2D DD 7E 0F    	ld	a, (ix+15)	; verificar se eh SDV1 ou SDV2
1545   4D30 B7          	or	a
1546   4D31 CC 67 5E    	call	z,blocoParaByte		; se for SDV1 coverter blocos para bytes
1547   4D34 CD 20 4D    	call	setaSDAtual	; selecionar cartao atual
1548   4D37 FD 7E 32    	ld	a, (iy+NUMBLOCOS)	; testar se Nextor quer gravar 1 ou mais blocos
1549   4D3A 3D          	dec	a
1550   4D3B CA B8 51    	jp	z,.umBloco	; somente um bloco, gravar usando CMD24
1551   4D3E             
1552   4D3E             ; multiplos blocos
1553   4D3E C5          	push	bc
1554   4D3F D5          	push	de
1555   4D40 3E 77       	ld	a, CMD55	; Multiplos blocos, mandar ACMD23 com total de blocos
1556   4D42 CD 95 4C    	call	SD_SEND_CMD_NO_ARGS
1557   4D45 3E 57       	ld	a, ACMD23
1558   4D47 01 00 00    	ld	bc, 0
1559   4D4A 51          	ld	d, c
1560   4D4B FD 5E 32    	ld	e, (iy+NUMBLOCOS)	; parametro = total de blocos a gravar
1561   4D4E CD 9A 4C    	call	SD_SEND_CMD_GET_ERROR
1562   4D51 D1          	pop	de
1563   4D52 C1          	pop	bc
1564   4D53 DA EF 55    	jp	c,terminaLeituraEscritaBloco	; erro no ACMD23
1565   4D56 3E 59       	ld	a, CMD25	; comando CMD25 = write multiple blocks
1566   4D58 CD 9A 4C    	call	SD_SEND_CMD_GET_ERROR
1567   4D5B DA EF 55    	jp	c,terminaLeituraEscritaBloco	; erro
1568   4D5E             .loop: 
1569   4D5E 3E FC       	ld	a, $FC		; mandar $FC para indicar que os proximos dados sao
1570   4D60 32 00 40    	ld	(PORTSPI),a	; dados para gravacao
1571   4D63             	; Check for a Z80 or R800
1572   4D63 EB          	ex	de,hl
1573   4D64             ;	or 	a		; Clear Cy
1574   4D64 3E 14       	ld	a,20
1575   4D66 ED F9       	db	#ED,#F9		; mulub a,a
1576   4D68 EB          	ex	de,hl
1577   4D69 11 00 40    	ld	de, PORTSPI
1578   4D6C DA A9 51    	jp	c,.r800m	; Use LDIR for R800
1579   4D6F ED A0       > ldi		
1579   4D71 ED A0       > ldi		
1579   4D73 ED A0       > ldi		
1579   4D75 ED A0       > ldi		
1579   4D77 ED A0       > ldi		
1579   4D79 ED A0       > ldi		
1579   4D7B ED A0       > ldi		
1579   4D7D ED A0       > ldi		
1579   4D7F ED A0       > ldi		
1579   4D81 ED A0       > ldi		
1579   4D83 ED A0       > ldi		
1579   4D85 ED A0       > ldi		
1579   4D87 ED A0       > ldi		
1579   4D89 ED A0       > ldi		
1579   4D8B ED A0       > ldi		
1579   4D8D ED A0       > ldi		
1579   4D8F ED A0       > ldi		
1579   4D91 ED A0       > ldi		
1579   4D93 ED A0       > ldi		
1579   4D95 ED A0       > ldi		
1579   4D97 ED A0       > ldi		
1579   4D99 ED A0       > ldi		
1579   4D9B ED A0       > ldi		
1579   4D9D ED A0       > ldi		
1579   4D9F ED A0       > ldi		
1579   4DA1 ED A0       > ldi		
1579   4DA3 ED A0       > ldi		
1579   4DA5 ED A0       > ldi		
1579   4DA7 ED A0       > ldi		
1579   4DA9 ED A0       > ldi		
1579   4DAB ED A0       > ldi		
1579   4DAD ED A0       > ldi		
1579   4DAF ED A0       > ldi		
1579   4DB1 ED A0       > ldi		
1579   4DB3 ED A0       > ldi		
1579   4DB5 ED A0       > ldi		
1579   4DB7 ED A0       > ldi		
1579   4DB9 ED A0       > ldi		
1579   4DBB ED A0       > ldi		
1579   4DBD ED A0       > ldi		
1579   4DBF ED A0       > ldi		
1579   4DC1 ED A0       > ldi		
1579   4DC3 ED A0       > ldi		
1579   4DC5 ED A0       > ldi		
1579   4DC7 ED A0       > ldi		
1579   4DC9 ED A0       > ldi		
1579   4DCB ED A0       > ldi		
1579   4DCD ED A0       > ldi		
1579   4DCF ED A0       > ldi		
1579   4DD1 ED A0       > ldi		
1579   4DD3 ED A0       > ldi		
1579   4DD5 ED A0       > ldi		
1579   4DD7 ED A0       > ldi		
1579   4DD9 ED A0       > ldi		
1579   4DDB ED A0       > ldi		
1579   4DDD ED A0       > ldi		
1579   4DDF ED A0       > ldi		
1579   4DE1 ED A0       > ldi		
1579   4DE3 ED A0       > ldi		
1579   4DE5 ED A0       > ldi		
1579   4DE7 ED A0       > ldi		
1579   4DE9 ED A0       > ldi		
1579   4DEB ED A0       > ldi		
1579   4DED ED A0       > ldi		
1579   4DEF ED A0       > ldi		
1579   4DF1 ED A0       > ldi		
1579   4DF3 ED A0       > ldi		
1579   4DF5 ED A0       > ldi		
1579   4DF7 ED A0       > ldi		
1579   4DF9 ED A0       > ldi		
1579   4DFB ED A0       > ldi		
1579   4DFD ED A0       > ldi		
1579   4DFF ED A0       > ldi		
1579   4E01 ED A0       > ldi		
1579   4E03 ED A0       > ldi		
1579   4E05 ED A0       > ldi		
1579   4E07 ED A0       > ldi		
1579   4E09 ED A0       > ldi		
1579   4E0B ED A0       > ldi		
1579   4E0D ED A0       > ldi		
1579   4E0F ED A0       > ldi		
1579   4E11 ED A0       > ldi		
1579   4E13 ED A0       > ldi		
1579   4E15 ED A0       > ldi		
1579   4E17 ED A0       > ldi		
1579   4E19 ED A0       > ldi		
1579   4E1B ED A0       > ldi		
1579   4E1D ED A0       > ldi		
1579   4E1F ED A0       > ldi		
1579   4E21 ED A0       > ldi		
1579   4E23 ED A0       > ldi		
1579   4E25 ED A0       > ldi		
1579   4E27 ED A0       > ldi		
1579   4E29 ED A0       > ldi		
1579   4E2B ED A0       > ldi		
1579   4E2D ED A0       > ldi		
1579   4E2F ED A0       > ldi		
1579   4E31 ED A0       > ldi		
1579   4E33 ED A0       > ldi		
1579   4E35 ED A0       > ldi		
1579   4E37 ED A0       > ldi		
1579   4E39 ED A0       > ldi		
1579   4E3B ED A0       > ldi		
1579   4E3D ED A0       > ldi		
1579   4E3F ED A0       > ldi		
1579   4E41 ED A0       > ldi		
1579   4E43 ED A0       > ldi		
1579   4E45 ED A0       > ldi		
1579   4E47 ED A0       > ldi		
1579   4E49 ED A0       > ldi		
1579   4E4B ED A0       > ldi		
1579   4E4D ED A0       > ldi		
1579   4E4F ED A0       > ldi		
1579   4E51 ED A0       > ldi		
1579   4E53 ED A0       > ldi		
1579   4E55 ED A0       > ldi		
1579   4E57 ED A0       > ldi		
1579   4E59 ED A0       > ldi		
1579   4E5B ED A0       > ldi		
1579   4E5D ED A0       > ldi		
1579   4E5F ED A0       > ldi		
1579   4E61 ED A0       > ldi		
1579   4E63 ED A0       > ldi		
1579   4E65 ED A0       > ldi		
1579   4E67 ED A0       > ldi		
1579   4E69 ED A0       > ldi		
1579   4E6B ED A0       > ldi		
1579   4E6D ED A0       > ldi		
1579   4E6F ED A0       > ldi		
1579   4E71 ED A0       > ldi		
1579   4E73 ED A0       > ldi		
1579   4E75 ED A0       > ldi		
1579   4E77 ED A0       > ldi		
1579   4E79 ED A0       > ldi		
1579   4E7B ED A0       > ldi		
1579   4E7D ED A0       > ldi		
1579   4E7F ED A0       > ldi		
1579   4E81 ED A0       > ldi		
1579   4E83 ED A0       > ldi		
1579   4E85 ED A0       > ldi		
1579   4E87 ED A0       > ldi		
1579   4E89 ED A0       > ldi		
1579   4E8B ED A0       > ldi		
1579   4E8D ED A0       > ldi		
1579   4E8F ED A0       > ldi		
1579   4E91 ED A0       > ldi		
1579   4E93 ED A0       > ldi		
1579   4E95 ED A0       > ldi		
1579   4E97 ED A0       > ldi		
1579   4E99 ED A0       > ldi		
1579   4E9B ED A0       > ldi		
1579   4E9D ED A0       > ldi		
1579   4E9F ED A0       > ldi		
1579   4EA1 ED A0       > ldi		
1579   4EA3 ED A0       > ldi		
1579   4EA5 ED A0       > ldi		
1579   4EA7 ED A0       > ldi		
1579   4EA9 ED A0       > ldi		
1579   4EAB ED A0       > ldi		
1579   4EAD ED A0       > ldi		
1579   4EAF ED A0       > ldi		
1579   4EB1 ED A0       > ldi		
1579   4EB3 ED A0       > ldi		
1579   4EB5 ED A0       > ldi		
1579   4EB7 ED A0       > ldi		
1579   4EB9 ED A0       > ldi		
1579   4EBB ED A0       > ldi		
1579   4EBD ED A0       > ldi		
1579   4EBF ED A0       > ldi		
1579   4EC1 ED A0       > ldi		
1579   4EC3 ED A0       > ldi		
1579   4EC5 ED A0       > ldi		
1579   4EC7 ED A0       > ldi		
1579   4EC9 ED A0       > ldi		
1579   4ECB ED A0       > ldi		
1579   4ECD ED A0       > ldi		
1579   4ECF ED A0       > ldi		
1579   4ED1 ED A0       > ldi		
1579   4ED3 ED A0       > ldi		
1579   4ED5 ED A0       > ldi		
1579   4ED7 ED A0       > ldi		
1579   4ED9 ED A0       > ldi		
1579   4EDB ED A0       > ldi		
1579   4EDD ED A0       > ldi		
1579   4EDF ED A0       > ldi		
1579   4EE1 ED A0       > ldi		
1579   4EE3 ED A0       > ldi		
1579   4EE5 ED A0       > ldi		
1579   4EE7 ED A0       > ldi		
1579   4EE9 ED A0       > ldi		
1579   4EEB ED A0       > ldi		
1579   4EED ED A0       > ldi		
1579   4EEF ED A0       > ldi		
1579   4EF1 ED A0       > ldi		
1579   4EF3 ED A0       > ldi		
1579   4EF5 ED A0       > ldi		
1579   4EF7 ED A0       > ldi		
1579   4EF9 ED A0       > ldi		
1579   4EFB ED A0       > ldi		
1579   4EFD ED A0       > ldi		
1579   4EFF ED A0       > ldi		
1579   4F01 ED A0       > ldi		
1579   4F03 ED A0       > ldi		
1579   4F05 ED A0       > ldi		
1579   4F07 ED A0       > ldi		
1579   4F09 ED A0       > ldi		
1579   4F0B ED A0       > ldi		
1579   4F0D ED A0       > ldi		
1579   4F0F ED A0       > ldi		
1579   4F11 ED A0       > ldi		
1579   4F13 ED A0       > ldi		
1579   4F15 ED A0       > ldi		
1579   4F17 ED A0       > ldi		
1579   4F19 ED A0       > ldi		
1579   4F1B ED A0       > ldi		
1579   4F1D ED A0       > ldi		
1579   4F1F ED A0       > ldi		
1579   4F21 ED A0       > ldi		
1579   4F23 ED A0       > ldi		
1579   4F25 ED A0       > ldi		
1579   4F27 ED A0       > ldi		
1579   4F29 ED A0       > ldi		
1579   4F2B ED A0       > ldi		
1579   4F2D ED A0       > ldi		
1579   4F2F ED A0       > ldi		
1579   4F31 ED A0       > ldi		
1579   4F33 ED A0       > ldi		
1579   4F35 ED A0       > ldi		
1579   4F37 ED A0       > ldi		
1579   4F39 ED A0       > ldi		
1579   4F3B ED A0       > ldi		
1579   4F3D ED A0       > ldi		
1579   4F3F ED A0       > ldi		
1579   4F41 ED A0       > ldi		
1579   4F43 ED A0       > ldi		
1579   4F45 ED A0       > ldi		
1579   4F47 ED A0       > ldi		
1579   4F49 ED A0       > ldi		
1579   4F4B ED A0       > ldi		
1579   4F4D ED A0       > ldi		
1579   4F4F ED A0       > ldi		
1579   4F51 ED A0       > ldi		
1579   4F53 ED A0       > ldi		
1579   4F55 ED A0       > ldi		
1579   4F57 ED A0       > ldi		
1579   4F59 ED A0       > ldi		
1579   4F5B ED A0       > ldi		
1579   4F5D ED A0       > ldi		
1579   4F5F ED A0       > ldi		
1579   4F61 ED A0       > ldi		
1579   4F63 ED A0       > ldi		
1579   4F65 ED A0       > ldi		
1579   4F67 ED A0       > ldi		
1579   4F69 ED A0       > ldi		
1579   4F6B ED A0       > ldi		
1579   4F6D ED A0       > ldi		
1579   4F6F ED A0       > ldi		
1579   4F71 ED A0       > ldi		
1579   4F73 ED A0       > ldi		
1579   4F75 ED A0       > ldi		
1579   4F77 ED A0       > ldi		
1579   4F79 ED A0       > ldi		
1579   4F7B ED A0       > ldi		
1579   4F7D ED A0       > ldi		
1579   4F7F ED A0       > ldi		
1579   4F81 ED A0       > ldi		
1579   4F83 ED A0       > ldi		
1579   4F85 ED A0       > ldi		
1579   4F87 ED A0       > ldi		
1579   4F89 ED A0       > ldi		
1579   4F8B ED A0       > ldi		
1579   4F8D ED A0       > ldi		
1579   4F8F ED A0       > ldi		
1579   4F91 ED A0       > ldi		
1579   4F93 ED A0       > ldi		
1579   4F95 ED A0       > ldi		
1579   4F97 ED A0       > ldi		
1579   4F99 ED A0       > ldi		
1579   4F9B ED A0       > ldi		
1579   4F9D ED A0       > ldi		
1579   4F9F ED A0       > ldi		
1579   4FA1 ED A0       > ldi		
1579   4FA3 ED A0       > ldi		
1579   4FA5 ED A0       > ldi		
1579   4FA7 ED A0       > ldi		
1579   4FA9 ED A0       > ldi		
1579   4FAB ED A0       > ldi		
1579   4FAD ED A0       > ldi		
1579   4FAF ED A0       > ldi		
1579   4FB1 ED A0       > ldi		
1579   4FB3 ED A0       > ldi		
1579   4FB5 ED A0       > ldi		
1579   4FB7 ED A0       > ldi		
1579   4FB9 ED A0       > ldi		
1579   4FBB ED A0       > ldi		
1579   4FBD ED A0       > ldi		
1579   4FBF ED A0       > ldi		
1579   4FC1 ED A0       > ldi		
1579   4FC3 ED A0       > ldi		
1579   4FC5 ED A0       > ldi		
1579   4FC7 ED A0       > ldi		
1579   4FC9 ED A0       > ldi		
1579   4FCB ED A0       > ldi		
1579   4FCD ED A0       > ldi		
1579   4FCF ED A0       > ldi		
1579   4FD1 ED A0       > ldi		
1579   4FD3 ED A0       > ldi		
1579   4FD5 ED A0       > ldi		
1579   4FD7 ED A0       > ldi		
1579   4FD9 ED A0       > ldi		
1579   4FDB ED A0       > ldi		
1579   4FDD ED A0       > ldi		
1579   4FDF ED A0       > ldi		
1579   4FE1 ED A0       > ldi		
1579   4FE3 ED A0       > ldi		
1579   4FE5 ED A0       > ldi		
1579   4FE7 ED A0       > ldi		
1579   4FE9 ED A0       > ldi		
1579   4FEB ED A0       > ldi		
1579   4FED ED A0       > ldi		
1579   4FEF ED A0       > ldi		
1579   4FF1 ED A0       > ldi		
1579   4FF3 ED A0       > ldi		
1579   4FF5 ED A0       > ldi		
1579   4FF7 ED A0       > ldi		
1579   4FF9 ED A0       > ldi		
1579   4FFB ED A0       > ldi		
1579   4FFD ED A0       > ldi		
1579   4FFF ED A0       > ldi		
1579   5001 ED A0       > ldi		
1579   5003 ED A0       > ldi		
1579   5005 ED A0       > ldi		
1579   5007 ED A0       > ldi		
1579   5009 ED A0       > ldi		
1579   500B ED A0       > ldi		
1579   500D ED A0       > ldi		
1579   500F ED A0       > ldi		
1579   5011 ED A0       > ldi		
1579   5013 ED A0       > ldi		
1579   5015 ED A0       > ldi		
1579   5017 ED A0       > ldi		
1579   5019 ED A0       > ldi		
1579   501B ED A0       > ldi		
1579   501D ED A0       > ldi		
1579   501F ED A0       > ldi		
1579   5021 ED A0       > ldi		
1579   5023 ED A0       > ldi		
1579   5025 ED A0       > ldi		
1579   5027 ED A0       > ldi		
1579   5029 ED A0       > ldi		
1579   502B ED A0       > ldi		
1579   502D ED A0       > ldi		
1579   502F ED A0       > ldi		
1579   5031 ED A0       > ldi		
1579   5033 ED A0       > ldi		
1579   5035 ED A0       > ldi		
1579   5037 ED A0       > ldi		
1579   5039 ED A0       > ldi		
1579   503B ED A0       > ldi		
1579   503D ED A0       > ldi		
1579   503F ED A0       > ldi		
1579   5041 ED A0       > ldi		
1579   5043 ED A0       > ldi		
1579   5045 ED A0       > ldi		
1579   5047 ED A0       > ldi		
1579   5049 ED A0       > ldi		
1579   504B ED A0       > ldi		
1579   504D ED A0       > ldi		
1579   504F ED A0       > ldi		
1579   5051 ED A0       > ldi		
1579   5053 ED A0       > ldi		
1579   5055 ED A0       > ldi		
1579   5057 ED A0       > ldi		
1579   5059 ED A0       > ldi		
1579   505B ED A0       > ldi		
1579   505D ED A0       > ldi		
1579   505F ED A0       > ldi		
1579   5061 ED A0       > ldi		
1579   5063 ED A0       > ldi		
1579   5065 ED A0       > ldi		
1579   5067 ED A0       > ldi		
1579   5069 ED A0       > ldi		
1579   506B ED A0       > ldi		
1579   506D ED A0       > ldi		
1579   506F ED A0       > ldi		
1579   5071 ED A0       > ldi		
1579   5073 ED A0       > ldi		
1579   5075 ED A0       > ldi		
1579   5077 ED A0       > ldi		
1579   5079 ED A0       > ldi		
1579   507B ED A0       > ldi		
1579   507D ED A0       > ldi		
1579   507F ED A0       > ldi		
1579   5081 ED A0       > ldi		
1579   5083 ED A0       > ldi		
1579   5085 ED A0       > ldi		
1579   5087 ED A0       > ldi		
1579   5089 ED A0       > ldi		
1579   508B ED A0       > ldi		
1579   508D ED A0       > ldi		
1579   508F ED A0       > ldi		
1579   5091 ED A0       > ldi		
1579   5093 ED A0       > ldi		
1579   5095 ED A0       > ldi		
1579   5097 ED A0       > ldi		
1579   5099 ED A0       > ldi		
1579   509B ED A0       > ldi		
1579   509D ED A0       > ldi		
1579   509F ED A0       > ldi		
1579   50A1 ED A0       > ldi		
1579   50A3 ED A0       > ldi		
1579   50A5 ED A0       > ldi		
1579   50A7 ED A0       > ldi		
1579   50A9 ED A0       > ldi		
1579   50AB ED A0       > ldi		
1579   50AD ED A0       > ldi		
1579   50AF ED A0       > ldi		
1579   50B1 ED A0       > ldi		
1579   50B3 ED A0       > ldi		
1579   50B5 ED A0       > ldi		
1579   50B7 ED A0       > ldi		
1579   50B9 ED A0       > ldi		
1579   50BB ED A0       > ldi		
1579   50BD ED A0       > ldi		
1579   50BF ED A0       > ldi		
1579   50C1 ED A0       > ldi		
1579   50C3 ED A0       > ldi		
1579   50C5 ED A0       > ldi		
1579   50C7 ED A0       > ldi		
1579   50C9 ED A0       > ldi		
1579   50CB ED A0       > ldi		
1579   50CD ED A0       > ldi		
1579   50CF ED A0       > ldi		
1579   50D1 ED A0       > ldi		
1579   50D3 ED A0       > ldi		
1579   50D5 ED A0       > ldi		
1579   50D7 ED A0       > ldi		
1579   50D9 ED A0       > ldi		
1579   50DB ED A0       > ldi		
1579   50DD ED A0       > ldi		
1579   50DF ED A0       > ldi		
1579   50E1 ED A0       > ldi		
1579   50E3 ED A0       > ldi		
1579   50E5 ED A0       > ldi		
1579   50E7 ED A0       > ldi		
1579   50E9 ED A0       > ldi		
1579   50EB ED A0       > ldi		
1579   50ED ED A0       > ldi		
1579   50EF ED A0       > ldi		
1579   50F1 ED A0       > ldi		
1579   50F3 ED A0       > ldi		
1579   50F5 ED A0       > ldi		
1579   50F7 ED A0       > ldi		
1579   50F9 ED A0       > ldi		
1579   50FB ED A0       > ldi		
1579   50FD ED A0       > ldi		
1579   50FF ED A0       > ldi		
1579   5101 ED A0       > ldi		
1579   5103 ED A0       > ldi		
1579   5105 ED A0       > ldi		
1579   5107 ED A0       > ldi		
1579   5109 ED A0       > ldi		
1579   510B ED A0       > ldi		
1579   510D ED A0       > ldi		
1579   510F ED A0       > ldi		
1579   5111 ED A0       > ldi		
1579   5113 ED A0       > ldi		
1579   5115 ED A0       > ldi		
1579   5117 ED A0       > ldi		
1579   5119 ED A0       > ldi		
1579   511B ED A0       > ldi		
1579   511D ED A0       > ldi		
1579   511F ED A0       > ldi		
1579   5121 ED A0       > ldi		
1579   5123 ED A0       > ldi		
1579   5125 ED A0       > ldi		
1579   5127 ED A0       > ldi		
1579   5129 ED A0       > ldi		
1579   512B ED A0       > ldi		
1579   512D ED A0       > ldi		
1579   512F ED A0       > ldi		
1579   5131 ED A0       > ldi		
1579   5133 ED A0       > ldi		
1579   5135 ED A0       > ldi		
1579   5137 ED A0       > ldi		
1579   5139 ED A0       > ldi		
1579   513B ED A0       > ldi		
1579   513D ED A0       > ldi		
1579   513F ED A0       > ldi		
1579   5141 ED A0       > ldi		
1579   5143 ED A0       > ldi		
1579   5145 ED A0       > ldi		
1579   5147 ED A0       > ldi		
1579   5149 ED A0       > ldi		
1579   514B ED A0       > ldi		
1579   514D ED A0       > ldi		
1579   514F ED A0       > ldi		
1579   5151 ED A0       > ldi		
1579   5153 ED A0       > ldi		
1579   5155 ED A0       > ldi		
1579   5157 ED A0       > ldi		
1579   5159 ED A0       > ldi		
1579   515B ED A0       > ldi		
1579   515D ED A0       > ldi		
1579   515F ED A0       > ldi		
1579   5161 ED A0       > ldi		
1579   5163 ED A0       > ldi		
1579   5165 ED A0       > ldi		
1579   5167 ED A0       > ldi		
1579   5169 ED A0       > ldi		
1579   516B ED A0       > ldi		
1579   516D ED A0       > ldi		
1580   516F             .part2m: 
1581   516F 3E FF       	ld	a, $FF		; envia dummy CRC
1582   5171 32 00 40    	ld	(PORTSPI),a
1583   5174 32 00 40    	ld	(PORTSPI),a
1584   5177 CD 02 4D    	call	WAIT_RESP_NO_FF	; esperar cartao
1585   517A E6 1F       	and	$1F		; testa bits erro
1586   517C FE 05       	cp	5
1587   517E 37          	scf
1588   517F C2 EF 55    	jp	nz,terminaLeituraEscritaBloco	; resposta errada, informar erro
1589   5182 CD 11 4D    	call	WAIT_RESP_NO_00	; esperar cartao
1590   5185 DA EF 55    	jp	c,terminaLeituraEscritaBloco
1591   5188 FD 7E 32    	ld	a, (iy+NUMBLOCOS)	; testar se tem mais blocos para gravar
1592   518B 3D          	dec	a
1593   518C FD 77 32    	ld	(iy+NUMBLOCOS), a
1594   518F C2 5E 4D    	jp	nz,.loop
1595   5192 3A 00 40    	ld	a, (PORTSPI)	; acabou os blocos, fazer 2 dummy reads
1596   5195 3A 00 40    	ld	a, (PORTSPI)
1597   5198 3E FD       	ld	a, $FD		; enviar $FD para informar ao cartao que acabou os dados
1598   519A 32 00 40    	ld	(PORTSPI),a
1599   519D 3A 00 40    	ld	a, (PORTSPI)	; dummy reads
1600   51A0 3A 00 40    	ld	a, (PORTSPI)
1601   51A3 CD 11 4D    	call	WAIT_RESP_NO_00	; esperar cartao
1602   51A6 C3 EE 55    	jp	.fim		; CMD25 concluido, sair informando nenhum erro
1603   51A9             
1604   51A9 01 00 02    .r800m: 	ld	bc,512
1605   51AC ED B0       	ldir
1606   51AE 18 BF       	jr	.part2m
1607   51B0             
1608   51B0 01 00 02    .r800s: 	ld	bc,512
1609   51B3 ED B0       	ldir
1610   51B5 C3 D0 55    	jp	.part2s
1611   51B8             
1612   51B8             .umBloco: 
1613   51B8 3E 58       	ld	a, CMD24	; gravar somente um bloco com comando CMD24 = Write Single Block
1614   51BA CD 9A 4C    	call	SD_SEND_CMD_GET_ERROR
1615   51BD DA EF 55    	jp	c,terminaLeituraEscritaBloco	; erro
1616   51C0             
1617   51C0 3E FE       	ld	a, $FE		; mandar $FE para indicar que vamos mandar dados para gravacao
1618   51C2 32 00 40    	ld	(PORTSPI),a
1619   51C5             
1620   51C5             	; Check for a Z80 or R800
1621   51C5 EB          	ex	de,hl
1622   51C6             ;	or 	a		; Clear Cy
1623   51C6 3E 14       	ld	a,20
1624   51C8 ED F9       	db	#ED,#F9		; mulub a,a
1625   51CA EB          	ex	de,hl
1626   51CB 11 00 40    	ld	de, PORTSPI
1627   51CE 38 E0       	jr	c,.r800s	; Use LDIR for R800
1628   51D0 ED A0       > ldi
1628   51D2 ED A0       > ldi
1628   51D4 ED A0       > ldi
1628   51D6 ED A0       > ldi
1628   51D8 ED A0       > ldi
1628   51DA ED A0       > ldi
1628   51DC ED A0       > ldi
1628   51DE ED A0       > ldi
1628   51E0 ED A0       > ldi
1628   51E2 ED A0       > ldi
1628   51E4 ED A0       > ldi
1628   51E6 ED A0       > ldi
1628   51E8 ED A0       > ldi
1628   51EA ED A0       > ldi
1628   51EC ED A0       > ldi
1628   51EE ED A0       > ldi
1628   51F0 ED A0       > ldi
1628   51F2 ED A0       > ldi
1628   51F4 ED A0       > ldi
1628   51F6 ED A0       > ldi
1628   51F8 ED A0       > ldi
1628   51FA ED A0       > ldi
1628   51FC ED A0       > ldi
1628   51FE ED A0       > ldi
1628   5200 ED A0       > ldi
1628   5202 ED A0       > ldi
1628   5204 ED A0       > ldi
1628   5206 ED A0       > ldi
1628   5208 ED A0       > ldi
1628   520A ED A0       > ldi
1628   520C ED A0       > ldi
1628   520E ED A0       > ldi
1628   5210 ED A0       > ldi
1628   5212 ED A0       > ldi
1628   5214 ED A0       > ldi
1628   5216 ED A0       > ldi
1628   5218 ED A0       > ldi
1628   521A ED A0       > ldi
1628   521C ED A0       > ldi
1628   521E ED A0       > ldi
1628   5220 ED A0       > ldi
1628   5222 ED A0       > ldi
1628   5224 ED A0       > ldi
1628   5226 ED A0       > ldi
1628   5228 ED A0       > ldi
1628   522A ED A0       > ldi
1628   522C ED A0       > ldi
1628   522E ED A0       > ldi
1628   5230 ED A0       > ldi
1628   5232 ED A0       > ldi
1628   5234 ED A0       > ldi
1628   5236 ED A0       > ldi
1628   5238 ED A0       > ldi
1628   523A ED A0       > ldi
1628   523C ED A0       > ldi
1628   523E ED A0       > ldi
1628   5240 ED A0       > ldi
1628   5242 ED A0       > ldi
1628   5244 ED A0       > ldi
1628   5246 ED A0       > ldi
1628   5248 ED A0       > ldi
1628   524A ED A0       > ldi
1628   524C ED A0       > ldi
1628   524E ED A0       > ldi
1628   5250 ED A0       > ldi
1628   5252 ED A0       > ldi
1628   5254 ED A0       > ldi
1628   5256 ED A0       > ldi
1628   5258 ED A0       > ldi
1628   525A ED A0       > ldi
1628   525C ED A0       > ldi
1628   525E ED A0       > ldi
1628   5260 ED A0       > ldi
1628   5262 ED A0       > ldi
1628   5264 ED A0       > ldi
1628   5266 ED A0       > ldi
1628   5268 ED A0       > ldi
1628   526A ED A0       > ldi
1628   526C ED A0       > ldi
1628   526E ED A0       > ldi
1628   5270 ED A0       > ldi
1628   5272 ED A0       > ldi
1628   5274 ED A0       > ldi
1628   5276 ED A0       > ldi
1628   5278 ED A0       > ldi
1628   527A ED A0       > ldi
1628   527C ED A0       > ldi
1628   527E ED A0       > ldi
1628   5280 ED A0       > ldi
1628   5282 ED A0       > ldi
1628   5284 ED A0       > ldi
1628   5286 ED A0       > ldi
1628   5288 ED A0       > ldi
1628   528A ED A0       > ldi
1628   528C ED A0       > ldi
1628   528E ED A0       > ldi
1628   5290 ED A0       > ldi
1628   5292 ED A0       > ldi
1628   5294 ED A0       > ldi
1628   5296 ED A0       > ldi
1628   5298 ED A0       > ldi
1628   529A ED A0       > ldi
1628   529C ED A0       > ldi
1628   529E ED A0       > ldi
1628   52A0 ED A0       > ldi
1628   52A2 ED A0       > ldi
1628   52A4 ED A0       > ldi
1628   52A6 ED A0       > ldi
1628   52A8 ED A0       > ldi
1628   52AA ED A0       > ldi
1628   52AC ED A0       > ldi
1628   52AE ED A0       > ldi
1628   52B0 ED A0       > ldi
1628   52B2 ED A0       > ldi
1628   52B4 ED A0       > ldi
1628   52B6 ED A0       > ldi
1628   52B8 ED A0       > ldi
1628   52BA ED A0       > ldi
1628   52BC ED A0       > ldi
1628   52BE ED A0       > ldi
1628   52C0 ED A0       > ldi
1628   52C2 ED A0       > ldi
1628   52C4 ED A0       > ldi
1628   52C6 ED A0       > ldi
1628   52C8 ED A0       > ldi
1628   52CA ED A0       > ldi
1628   52CC ED A0       > ldi
1628   52CE ED A0       > ldi
1628   52D0 ED A0       > ldi
1628   52D2 ED A0       > ldi
1628   52D4 ED A0       > ldi
1628   52D6 ED A0       > ldi
1628   52D8 ED A0       > ldi
1628   52DA ED A0       > ldi
1628   52DC ED A0       > ldi
1628   52DE ED A0       > ldi
1628   52E0 ED A0       > ldi
1628   52E2 ED A0       > ldi
1628   52E4 ED A0       > ldi
1628   52E6 ED A0       > ldi
1628   52E8 ED A0       > ldi
1628   52EA ED A0       > ldi
1628   52EC ED A0       > ldi
1628   52EE ED A0       > ldi
1628   52F0 ED A0       > ldi
1628   52F2 ED A0       > ldi
1628   52F4 ED A0       > ldi
1628   52F6 ED A0       > ldi
1628   52F8 ED A0       > ldi
1628   52FA ED A0       > ldi
1628   52FC ED A0       > ldi
1628   52FE ED A0       > ldi
1628   5300 ED A0       > ldi
1628   5302 ED A0       > ldi
1628   5304 ED A0       > ldi
1628   5306 ED A0       > ldi
1628   5308 ED A0       > ldi
1628   530A ED A0       > ldi
1628   530C ED A0       > ldi
1628   530E ED A0       > ldi
1628   5310 ED A0       > ldi
1628   5312 ED A0       > ldi
1628   5314 ED A0       > ldi
1628   5316 ED A0       > ldi
1628   5318 ED A0       > ldi
1628   531A ED A0       > ldi
1628   531C ED A0       > ldi
1628   531E ED A0       > ldi
1628   5320 ED A0       > ldi
1628   5322 ED A0       > ldi
1628   5324 ED A0       > ldi
1628   5326 ED A0       > ldi
1628   5328 ED A0       > ldi
1628   532A ED A0       > ldi
1628   532C ED A0       > ldi
1628   532E ED A0       > ldi
1628   5330 ED A0       > ldi
1628   5332 ED A0       > ldi
1628   5334 ED A0       > ldi
1628   5336 ED A0       > ldi
1628   5338 ED A0       > ldi
1628   533A ED A0       > ldi
1628   533C ED A0       > ldi
1628   533E ED A0       > ldi
1628   5340 ED A0       > ldi
1628   5342 ED A0       > ldi
1628   5344 ED A0       > ldi
1628   5346 ED A0       > ldi
1628   5348 ED A0       > ldi
1628   534A ED A0       > ldi
1628   534C ED A0       > ldi
1628   534E ED A0       > ldi
1628   5350 ED A0       > ldi
1628   5352 ED A0       > ldi
1628   5354 ED A0       > ldi
1628   5356 ED A0       > ldi
1628   5358 ED A0       > ldi
1628   535A ED A0       > ldi
1628   535C ED A0       > ldi
1628   535E ED A0       > ldi
1628   5360 ED A0       > ldi
1628   5362 ED A0       > ldi
1628   5364 ED A0       > ldi
1628   5366 ED A0       > ldi
1628   5368 ED A0       > ldi
1628   536A ED A0       > ldi
1628   536C ED A0       > ldi
1628   536E ED A0       > ldi
1628   5370 ED A0       > ldi
1628   5372 ED A0       > ldi
1628   5374 ED A0       > ldi
1628   5376 ED A0       > ldi
1628   5378 ED A0       > ldi
1628   537A ED A0       > ldi
1628   537C ED A0       > ldi
1628   537E ED A0       > ldi
1628   5380 ED A0       > ldi
1628   5382 ED A0       > ldi
1628   5384 ED A0       > ldi
1628   5386 ED A0       > ldi
1628   5388 ED A0       > ldi
1628   538A ED A0       > ldi
1628   538C ED A0       > ldi
1628   538E ED A0       > ldi
1628   5390 ED A0       > ldi
1628   5392 ED A0       > ldi
1628   5394 ED A0       > ldi
1628   5396 ED A0       > ldi
1628   5398 ED A0       > ldi
1628   539A ED A0       > ldi
1628   539C ED A0       > ldi
1628   539E ED A0       > ldi
1628   53A0 ED A0       > ldi
1628   53A2 ED A0       > ldi
1628   53A4 ED A0       > ldi
1628   53A6 ED A0       > ldi
1628   53A8 ED A0       > ldi
1628   53AA ED A0       > ldi
1628   53AC ED A0       > ldi
1628   53AE ED A0       > ldi
1628   53B0 ED A0       > ldi
1628   53B2 ED A0       > ldi
1628   53B4 ED A0       > ldi
1628   53B6 ED A0       > ldi
1628   53B8 ED A0       > ldi
1628   53BA ED A0       > ldi
1628   53BC ED A0       > ldi
1628   53BE ED A0       > ldi
1628   53C0 ED A0       > ldi
1628   53C2 ED A0       > ldi
1628   53C4 ED A0       > ldi
1628   53C6 ED A0       > ldi
1628   53C8 ED A0       > ldi
1628   53CA ED A0       > ldi
1628   53CC ED A0       > ldi
1628   53CE ED A0       > ldi
1628   53D0 ED A0       > ldi
1628   53D2 ED A0       > ldi
1628   53D4 ED A0       > ldi
1628   53D6 ED A0       > ldi
1628   53D8 ED A0       > ldi
1628   53DA ED A0       > ldi
1628   53DC ED A0       > ldi
1628   53DE ED A0       > ldi
1628   53E0 ED A0       > ldi
1628   53E2 ED A0       > ldi
1628   53E4 ED A0       > ldi
1628   53E6 ED A0       > ldi
1628   53E8 ED A0       > ldi
1628   53EA ED A0       > ldi
1628   53EC ED A0       > ldi
1628   53EE ED A0       > ldi
1628   53F0 ED A0       > ldi
1628   53F2 ED A0       > ldi
1628   53F4 ED A0       > ldi
1628   53F6 ED A0       > ldi
1628   53F8 ED A0       > ldi
1628   53FA ED A0       > ldi
1628   53FC ED A0       > ldi
1628   53FE ED A0       > ldi
1628   5400 ED A0       > ldi
1628   5402 ED A0       > ldi
1628   5404 ED A0       > ldi
1628   5406 ED A0       > ldi
1628   5408 ED A0       > ldi
1628   540A ED A0       > ldi
1628   540C ED A0       > ldi
1628   540E ED A0       > ldi
1628   5410 ED A0       > ldi
1628   5412 ED A0       > ldi
1628   5414 ED A0       > ldi
1628   5416 ED A0       > ldi
1628   5418 ED A0       > ldi
1628   541A ED A0       > ldi
1628   541C ED A0       > ldi
1628   541E ED A0       > ldi
1628   5420 ED A0       > ldi
1628   5422 ED A0       > ldi
1628   5424 ED A0       > ldi
1628   5426 ED A0       > ldi
1628   5428 ED A0       > ldi
1628   542A ED A0       > ldi
1628   542C ED A0       > ldi
1628   542E ED A0       > ldi
1628   5430 ED A0       > ldi
1628   5432 ED A0       > ldi
1628   5434 ED A0       > ldi
1628   5436 ED A0       > ldi
1628   5438 ED A0       > ldi
1628   543A ED A0       > ldi
1628   543C ED A0       > ldi
1628   543E ED A0       > ldi
1628   5440 ED A0       > ldi
1628   5442 ED A0       > ldi
1628   5444 ED A0       > ldi
1628   5446 ED A0       > ldi
1628   5448 ED A0       > ldi
1628   544A ED A0       > ldi
1628   544C ED A0       > ldi
1628   544E ED A0       > ldi
1628   5450 ED A0       > ldi
1628   5452 ED A0       > ldi
1628   5454 ED A0       > ldi
1628   5456 ED A0       > ldi
1628   5458 ED A0       > ldi
1628   545A ED A0       > ldi
1628   545C ED A0       > ldi
1628   545E ED A0       > ldi
1628   5460 ED A0       > ldi
1628   5462 ED A0       > ldi
1628   5464 ED A0       > ldi
1628   5466 ED A0       > ldi
1628   5468 ED A0       > ldi
1628   546A ED A0       > ldi
1628   546C ED A0       > ldi
1628   546E ED A0       > ldi
1628   5470 ED A0       > ldi
1628   5472 ED A0       > ldi
1628   5474 ED A0       > ldi
1628   5476 ED A0       > ldi
1628   5478 ED A0       > ldi
1628   547A ED A0       > ldi
1628   547C ED A0       > ldi
1628   547E ED A0       > ldi
1628   5480 ED A0       > ldi
1628   5482 ED A0       > ldi
1628   5484 ED A0       > ldi
1628   5486 ED A0       > ldi
1628   5488 ED A0       > ldi
1628   548A ED A0       > ldi
1628   548C ED A0       > ldi
1628   548E ED A0       > ldi
1628   5490 ED A0       > ldi
1628   5492 ED A0       > ldi
1628   5494 ED A0       > ldi
1628   5496 ED A0       > ldi
1628   5498 ED A0       > ldi
1628   549A ED A0       > ldi
1628   549C ED A0       > ldi
1628   549E ED A0       > ldi
1628   54A0 ED A0       > ldi
1628   54A2 ED A0       > ldi
1628   54A4 ED A0       > ldi
1628   54A6 ED A0       > ldi
1628   54A8 ED A0       > ldi
1628   54AA ED A0       > ldi
1628   54AC ED A0       > ldi
1628   54AE ED A0       > ldi
1628   54B0 ED A0       > ldi
1628   54B2 ED A0       > ldi
1628   54B4 ED A0       > ldi
1628   54B6 ED A0       > ldi
1628   54B8 ED A0       > ldi
1628   54BA ED A0       > ldi
1628   54BC ED A0       > ldi
1628   54BE ED A0       > ldi
1628   54C0 ED A0       > ldi
1628   54C2 ED A0       > ldi
1628   54C4 ED A0       > ldi
1628   54C6 ED A0       > ldi
1628   54C8 ED A0       > ldi
1628   54CA ED A0       > ldi
1628   54CC ED A0       > ldi
1628   54CE ED A0       > ldi
1628   54D0 ED A0       > ldi
1628   54D2 ED A0       > ldi
1628   54D4 ED A0       > ldi
1628   54D6 ED A0       > ldi
1628   54D8 ED A0       > ldi
1628   54DA ED A0       > ldi
1628   54DC ED A0       > ldi
1628   54DE ED A0       > ldi
1628   54E0 ED A0       > ldi
1628   54E2 ED A0       > ldi
1628   54E4 ED A0       > ldi
1628   54E6 ED A0       > ldi
1628   54E8 ED A0       > ldi
1628   54EA ED A0       > ldi
1628   54EC ED A0       > ldi
1628   54EE ED A0       > ldi
1628   54F0 ED A0       > ldi
1628   54F2 ED A0       > ldi
1628   54F4 ED A0       > ldi
1628   54F6 ED A0       > ldi
1628   54F8 ED A0       > ldi
1628   54FA ED A0       > ldi
1628   54FC ED A0       > ldi
1628   54FE ED A0       > ldi
1628   5500 ED A0       > ldi
1628   5502 ED A0       > ldi
1628   5504 ED A0       > ldi
1628   5506 ED A0       > ldi
1628   5508 ED A0       > ldi
1628   550A ED A0       > ldi
1628   550C ED A0       > ldi
1628   550E ED A0       > ldi
1628   5510 ED A0       > ldi
1628   5512 ED A0       > ldi
1628   5514 ED A0       > ldi
1628   5516 ED A0       > ldi
1628   5518 ED A0       > ldi
1628   551A ED A0       > ldi
1628   551C ED A0       > ldi
1628   551E ED A0       > ldi
1628   5520 ED A0       > ldi
1628   5522 ED A0       > ldi
1628   5524 ED A0       > ldi
1628   5526 ED A0       > ldi
1628   5528 ED A0       > ldi
1628   552A ED A0       > ldi
1628   552C ED A0       > ldi
1628   552E ED A0       > ldi
1628   5530 ED A0       > ldi
1628   5532 ED A0       > ldi
1628   5534 ED A0       > ldi
1628   5536 ED A0       > ldi
1628   5538 ED A0       > ldi
1628   553A ED A0       > ldi
1628   553C ED A0       > ldi
1628   553E ED A0       > ldi
1628   5540 ED A0       > ldi
1628   5542 ED A0       > ldi
1628   5544 ED A0       > ldi
1628   5546 ED A0       > ldi
1628   5548 ED A0       > ldi
1628   554A ED A0       > ldi
1628   554C ED A0       > ldi
1628   554E ED A0       > ldi
1628   5550 ED A0       > ldi
1628   5552 ED A0       > ldi
1628   5554 ED A0       > ldi
1628   5556 ED A0       > ldi
1628   5558 ED A0       > ldi
1628   555A ED A0       > ldi
1628   555C ED A0       > ldi
1628   555E ED A0       > ldi
1628   5560 ED A0       > ldi
1628   5562 ED A0       > ldi
1628   5564 ED A0       > ldi
1628   5566 ED A0       > ldi
1628   5568 ED A0       > ldi
1628   556A ED A0       > ldi
1628   556C ED A0       > ldi
1628   556E ED A0       > ldi
1628   5570 ED A0       > ldi
1628   5572 ED A0       > ldi
1628   5574 ED A0       > ldi
1628   5576 ED A0       > ldi
1628   5578 ED A0       > ldi
1628   557A ED A0       > ldi
1628   557C ED A0       > ldi
1628   557E ED A0       > ldi
1628   5580 ED A0       > ldi
1628   5582 ED A0       > ldi
1628   5584 ED A0       > ldi
1628   5586 ED A0       > ldi
1628   5588 ED A0       > ldi
1628   558A ED A0       > ldi
1628   558C ED A0       > ldi
1628   558E ED A0       > ldi
1628   5590 ED A0       > ldi
1628   5592 ED A0       > ldi
1628   5594 ED A0       > ldi
1628   5596 ED A0       > ldi
1628   5598 ED A0       > ldi
1628   559A ED A0       > ldi
1628   559C ED A0       > ldi
1628   559E ED A0       > ldi
1628   55A0 ED A0       > ldi
1628   55A2 ED A0       > ldi
1628   55A4 ED A0       > ldi
1628   55A6 ED A0       > ldi
1628   55A8 ED A0       > ldi
1628   55AA ED A0       > ldi
1628   55AC ED A0       > ldi
1628   55AE ED A0       > ldi
1628   55B0 ED A0       > ldi
1628   55B2 ED A0       > ldi
1628   55B4 ED A0       > ldi
1628   55B6 ED A0       > ldi
1628   55B8 ED A0       > ldi
1628   55BA ED A0       > ldi
1628   55BC ED A0       > ldi
1628   55BE ED A0       > ldi
1628   55C0 ED A0       > ldi
1628   55C2 ED A0       > ldi
1628   55C4 ED A0       > ldi
1628   55C6 ED A0       > ldi
1628   55C8 ED A0       > ldi
1628   55CA ED A0       > ldi
1628   55CC ED A0       > ldi
1628   55CE ED A0       > ldi
1629   55D0             .part2s: 
1630   55D0 01 00 02    	ld	bc,512
1631   55D3 ED B0       	ldir
1632   55D5 3E FF       	ld	a, $FF		; envia dummy CRC
1633   55D7 32 00 40    	ld	(PORTSPI),a
1634   55DA 32 00 40    	ld	(PORTSPI),a
1635   55DD CD 02 4D    	call	WAIT_RESP_NO_FF	; esperar cartao
1636   55E0 E6 1F       	and	$1F		; testa bits erro
1637   55E2 FE 05       	cp	5
1638   55E4 37          	scf
1639   55E5 C2 EF 55    	jp	nz,terminaLeituraEscritaBloco	; resposta errada, informar erro
1640   55E8             .esp: 
1641   55E8 CD 02 4D    	call	WAIT_RESP_NO_FF	; esperar cartao
1642   55EB B7          	or	a
1643   55EC 28 FA       	jr	z,.esp
1644   55EE             .fim: 
1645   55EE AF          	xor	a		; zera carry e informa nenhum erro
1646   55EF             terminaLeituraEscritaBloco: 
1647   55EF F5          	push	af
1648   55F0 CD 7D 4C    	call	desabilitaSDs	; desabilitar todos os cartoes
1649   55F3 F1          	pop	af
1650   55F4 C9          	ret
1651   55F5             
1652   55F5             
1653   55F5             ; ------------------------------------------------
1654   55F5             ; Ler um bloco de 512 bytes do cartao
1655   55F5             ; HL aponta para o inicio dos dados
1656   55F5             ; BC e DE contem o numero do bloco (BCDE = 32 bits)
1657   55F5             ; Destroi AF, BC, DE, HL
1658   55F5             ; ------------------------------------------------
1659   55F5             LerBloco: 
1660   55F5 DD 7E 0F    	ld	a, (ix+15)	; verificar se eh SDV1 ou SDV2
1661   55F8 B7          	or	a
1662   55F9 CC 67 5E    	call	z,blocoParaByte	; se for SDV1 coverter blocos para bytes
1663   55FC CD 20 4D    	call	setaSDAtual
1664   55FF             
1665   55FF             
1666   55FF             
1667   55FF FD 7E 32    	ld	a, (iy+NUMBLOCOS)	; testar se Nextor quer ler um ou mais blocos
1668   5602 3D          	dec	a
1669   5603 CA 47 5A    	jp	z,.umBloco	; somente um bloco, pular
1670   5606             
1671   5606             ; multiplos blocos
1672   5606 3E 52       	ld	a, CMD18	; ler multiplos blocos com CMD18 = Read Multiple Blocks
1673   5608 CD 9A 4C    	call	SD_SEND_CMD_GET_ERROR
1674   560B DA EF 55    	jp	c,terminaLeituraEscritaBloco
1675   560E             .loop: 
1676   560E CD F4 4C    	call	WAIT_RESP_FE
1677   5611 DA EF 55    	jp	c,terminaLeituraEscritaBloco
1678   5614 EB          	ex	de,hl
1679   5615             	; Check for a Z80 or R800
1680   5615             ;	or 	a		; Clear Cy
1681   5615 3E 14       	ld	a,20
1682   5617 ED F9       	db	#ED,#F9		; mulub a,a
1683   5619 21 00 40    	ld	hl, PORTSPI
1684   561C DA 38 5A    	jp	c,.r800m	; Use LDIR for R800
1685   561F ED A0       > ldi
1685   5621 ED A0       > ldi
1685   5623 ED A0       > ldi
1685   5625 ED A0       > ldi
1685   5627 ED A0       > ldi
1685   5629 ED A0       > ldi
1685   562B ED A0       > ldi
1685   562D ED A0       > ldi
1685   562F ED A0       > ldi
1685   5631 ED A0       > ldi
1685   5633 ED A0       > ldi
1685   5635 ED A0       > ldi
1685   5637 ED A0       > ldi
1685   5639 ED A0       > ldi
1685   563B ED A0       > ldi
1685   563D ED A0       > ldi
1685   563F ED A0       > ldi
1685   5641 ED A0       > ldi
1685   5643 ED A0       > ldi
1685   5645 ED A0       > ldi
1685   5647 ED A0       > ldi
1685   5649 ED A0       > ldi
1685   564B ED A0       > ldi
1685   564D ED A0       > ldi
1685   564F ED A0       > ldi
1685   5651 ED A0       > ldi
1685   5653 ED A0       > ldi
1685   5655 ED A0       > ldi
1685   5657 ED A0       > ldi
1685   5659 ED A0       > ldi
1685   565B ED A0       > ldi
1685   565D ED A0       > ldi
1685   565F ED A0       > ldi
1685   5661 ED A0       > ldi
1685   5663 ED A0       > ldi
1685   5665 ED A0       > ldi
1685   5667 ED A0       > ldi
1685   5669 ED A0       > ldi
1685   566B ED A0       > ldi
1685   566D ED A0       > ldi
1685   566F ED A0       > ldi
1685   5671 ED A0       > ldi
1685   5673 ED A0       > ldi
1685   5675 ED A0       > ldi
1685   5677 ED A0       > ldi
1685   5679 ED A0       > ldi
1685   567B ED A0       > ldi
1685   567D ED A0       > ldi
1685   567F ED A0       > ldi
1685   5681 ED A0       > ldi
1685   5683 ED A0       > ldi
1685   5685 ED A0       > ldi
1685   5687 ED A0       > ldi
1685   5689 ED A0       > ldi
1685   568B ED A0       > ldi
1685   568D ED A0       > ldi
1685   568F ED A0       > ldi
1685   5691 ED A0       > ldi
1685   5693 ED A0       > ldi
1685   5695 ED A0       > ldi
1685   5697 ED A0       > ldi
1685   5699 ED A0       > ldi
1685   569B ED A0       > ldi
1685   569D ED A0       > ldi
1685   569F ED A0       > ldi
1685   56A1 ED A0       > ldi
1685   56A3 ED A0       > ldi
1685   56A5 ED A0       > ldi
1685   56A7 ED A0       > ldi
1685   56A9 ED A0       > ldi
1685   56AB ED A0       > ldi
1685   56AD ED A0       > ldi
1685   56AF ED A0       > ldi
1685   56B1 ED A0       > ldi
1685   56B3 ED A0       > ldi
1685   56B5 ED A0       > ldi
1685   56B7 ED A0       > ldi
1685   56B9 ED A0       > ldi
1685   56BB ED A0       > ldi
1685   56BD ED A0       > ldi
1685   56BF ED A0       > ldi
1685   56C1 ED A0       > ldi
1685   56C3 ED A0       > ldi
1685   56C5 ED A0       > ldi
1685   56C7 ED A0       > ldi
1685   56C9 ED A0       > ldi
1685   56CB ED A0       > ldi
1685   56CD ED A0       > ldi
1685   56CF ED A0       > ldi
1685   56D1 ED A0       > ldi
1685   56D3 ED A0       > ldi
1685   56D5 ED A0       > ldi
1685   56D7 ED A0       > ldi
1685   56D9 ED A0       > ldi
1685   56DB ED A0       > ldi
1685   56DD ED A0       > ldi
1685   56DF ED A0       > ldi
1685   56E1 ED A0       > ldi
1685   56E3 ED A0       > ldi
1685   56E5 ED A0       > ldi
1685   56E7 ED A0       > ldi
1685   56E9 ED A0       > ldi
1685   56EB ED A0       > ldi
1685   56ED ED A0       > ldi
1685   56EF ED A0       > ldi
1685   56F1 ED A0       > ldi
1685   56F3 ED A0       > ldi
1685   56F5 ED A0       > ldi
1685   56F7 ED A0       > ldi
1685   56F9 ED A0       > ldi
1685   56FB ED A0       > ldi
1685   56FD ED A0       > ldi
1685   56FF ED A0       > ldi
1685   5701 ED A0       > ldi
1685   5703 ED A0       > ldi
1685   5705 ED A0       > ldi
1685   5707 ED A0       > ldi
1685   5709 ED A0       > ldi
1685   570B ED A0       > ldi
1685   570D ED A0       > ldi
1685   570F ED A0       > ldi
1685   5711 ED A0       > ldi
1685   5713 ED A0       > ldi
1685   5715 ED A0       > ldi
1685   5717 ED A0       > ldi
1685   5719 ED A0       > ldi
1685   571B ED A0       > ldi
1685   571D ED A0       > ldi
1685   571F ED A0       > ldi
1685   5721 ED A0       > ldi
1685   5723 ED A0       > ldi
1685   5725 ED A0       > ldi
1685   5727 ED A0       > ldi
1685   5729 ED A0       > ldi
1685   572B ED A0       > ldi
1685   572D ED A0       > ldi
1685   572F ED A0       > ldi
1685   5731 ED A0       > ldi
1685   5733 ED A0       > ldi
1685   5735 ED A0       > ldi
1685   5737 ED A0       > ldi
1685   5739 ED A0       > ldi
1685   573B ED A0       > ldi
1685   573D ED A0       > ldi
1685   573F ED A0       > ldi
1685   5741 ED A0       > ldi
1685   5743 ED A0       > ldi
1685   5745 ED A0       > ldi
1685   5747 ED A0       > ldi
1685   5749 ED A0       > ldi
1685   574B ED A0       > ldi
1685   574D ED A0       > ldi
1685   574F ED A0       > ldi
1685   5751 ED A0       > ldi
1685   5753 ED A0       > ldi
1685   5755 ED A0       > ldi
1685   5757 ED A0       > ldi
1685   5759 ED A0       > ldi
1685   575B ED A0       > ldi
1685   575D ED A0       > ldi
1685   575F ED A0       > ldi
1685   5761 ED A0       > ldi
1685   5763 ED A0       > ldi
1685   5765 ED A0       > ldi
1685   5767 ED A0       > ldi
1685   5769 ED A0       > ldi
1685   576B ED A0       > ldi
1685   576D ED A0       > ldi
1685   576F ED A0       > ldi
1685   5771 ED A0       > ldi
1685   5773 ED A0       > ldi
1685   5775 ED A0       > ldi
1685   5777 ED A0       > ldi
1685   5779 ED A0       > ldi
1685   577B ED A0       > ldi
1685   577D ED A0       > ldi
1685   577F ED A0       > ldi
1685   5781 ED A0       > ldi
1685   5783 ED A0       > ldi
1685   5785 ED A0       > ldi
1685   5787 ED A0       > ldi
1685   5789 ED A0       > ldi
1685   578B ED A0       > ldi
1685   578D ED A0       > ldi
1685   578F ED A0       > ldi
1685   5791 ED A0       > ldi
1685   5793 ED A0       > ldi
1685   5795 ED A0       > ldi
1685   5797 ED A0       > ldi
1685   5799 ED A0       > ldi
1685   579B ED A0       > ldi
1685   579D ED A0       > ldi
1685   579F ED A0       > ldi
1685   57A1 ED A0       > ldi
1685   57A3 ED A0       > ldi
1685   57A5 ED A0       > ldi
1685   57A7 ED A0       > ldi
1685   57A9 ED A0       > ldi
1685   57AB ED A0       > ldi
1685   57AD ED A0       > ldi
1685   57AF ED A0       > ldi
1685   57B1 ED A0       > ldi
1685   57B3 ED A0       > ldi
1685   57B5 ED A0       > ldi
1685   57B7 ED A0       > ldi
1685   57B9 ED A0       > ldi
1685   57BB ED A0       > ldi
1685   57BD ED A0       > ldi
1685   57BF ED A0       > ldi
1685   57C1 ED A0       > ldi
1685   57C3 ED A0       > ldi
1685   57C5 ED A0       > ldi
1685   57C7 ED A0       > ldi
1685   57C9 ED A0       > ldi
1685   57CB ED A0       > ldi
1685   57CD ED A0       > ldi
1685   57CF ED A0       > ldi
1685   57D1 ED A0       > ldi
1685   57D3 ED A0       > ldi
1685   57D5 ED A0       > ldi
1685   57D7 ED A0       > ldi
1685   57D9 ED A0       > ldi
1685   57DB ED A0       > ldi
1685   57DD ED A0       > ldi
1685   57DF ED A0       > ldi
1685   57E1 ED A0       > ldi
1685   57E3 ED A0       > ldi
1685   57E5 ED A0       > ldi
1685   57E7 ED A0       > ldi
1685   57E9 ED A0       > ldi
1685   57EB ED A0       > ldi
1685   57ED ED A0       > ldi
1685   57EF ED A0       > ldi
1685   57F1 ED A0       > ldi
1685   57F3 ED A0       > ldi
1685   57F5 ED A0       > ldi
1685   57F7 ED A0       > ldi
1685   57F9 ED A0       > ldi
1685   57FB ED A0       > ldi
1685   57FD ED A0       > ldi
1685   57FF ED A0       > ldi
1685   5801 ED A0       > ldi
1685   5803 ED A0       > ldi
1685   5805 ED A0       > ldi
1685   5807 ED A0       > ldi
1685   5809 ED A0       > ldi
1685   580B ED A0       > ldi
1685   580D ED A0       > ldi
1685   580F ED A0       > ldi
1685   5811 ED A0       > ldi
1685   5813 ED A0       > ldi
1685   5815 ED A0       > ldi
1685   5817 ED A0       > ldi
1685   5819 ED A0       > ldi
1685   581B ED A0       > ldi
1685   581D ED A0       > ldi
1685   581F ED A0       > ldi
1685   5821 ED A0       > ldi
1685   5823 ED A0       > ldi
1685   5825 ED A0       > ldi
1685   5827 ED A0       > ldi
1685   5829 ED A0       > ldi
1685   582B ED A0       > ldi
1685   582D ED A0       > ldi
1685   582F ED A0       > ldi
1685   5831 ED A0       > ldi
1685   5833 ED A0       > ldi
1685   5835 ED A0       > ldi
1685   5837 ED A0       > ldi
1685   5839 ED A0       > ldi
1685   583B ED A0       > ldi
1685   583D ED A0       > ldi
1685   583F ED A0       > ldi
1685   5841 ED A0       > ldi
1685   5843 ED A0       > ldi
1685   5845 ED A0       > ldi
1685   5847 ED A0       > ldi
1685   5849 ED A0       > ldi
1685   584B ED A0       > ldi
1685   584D ED A0       > ldi
1685   584F ED A0       > ldi
1685   5851 ED A0       > ldi
1685   5853 ED A0       > ldi
1685   5855 ED A0       > ldi
1685   5857 ED A0       > ldi
1685   5859 ED A0       > ldi
1685   585B ED A0       > ldi
1685   585D ED A0       > ldi
1685   585F ED A0       > ldi
1685   5861 ED A0       > ldi
1685   5863 ED A0       > ldi
1685   5865 ED A0       > ldi
1685   5867 ED A0       > ldi
1685   5869 ED A0       > ldi
1685   586B ED A0       > ldi
1685   586D ED A0       > ldi
1685   586F ED A0       > ldi
1685   5871 ED A0       > ldi
1685   5873 ED A0       > ldi
1685   5875 ED A0       > ldi
1685   5877 ED A0       > ldi
1685   5879 ED A0       > ldi
1685   587B ED A0       > ldi
1685   587D ED A0       > ldi
1685   587F ED A0       > ldi
1685   5881 ED A0       > ldi
1685   5883 ED A0       > ldi
1685   5885 ED A0       > ldi
1685   5887 ED A0       > ldi
1685   5889 ED A0       > ldi
1685   588B ED A0       > ldi
1685   588D ED A0       > ldi
1685   588F ED A0       > ldi
1685   5891 ED A0       > ldi
1685   5893 ED A0       > ldi
1685   5895 ED A0       > ldi
1685   5897 ED A0       > ldi
1685   5899 ED A0       > ldi
1685   589B ED A0       > ldi
1685   589D ED A0       > ldi
1685   589F ED A0       > ldi
1685   58A1 ED A0       > ldi
1685   58A3 ED A0       > ldi
1685   58A5 ED A0       > ldi
1685   58A7 ED A0       > ldi
1685   58A9 ED A0       > ldi
1685   58AB ED A0       > ldi
1685   58AD ED A0       > ldi
1685   58AF ED A0       > ldi
1685   58B1 ED A0       > ldi
1685   58B3 ED A0       > ldi
1685   58B5 ED A0       > ldi
1685   58B7 ED A0       > ldi
1685   58B9 ED A0       > ldi
1685   58BB ED A0       > ldi
1685   58BD ED A0       > ldi
1685   58BF ED A0       > ldi
1685   58C1 ED A0       > ldi
1685   58C3 ED A0       > ldi
1685   58C5 ED A0       > ldi
1685   58C7 ED A0       > ldi
1685   58C9 ED A0       > ldi
1685   58CB ED A0       > ldi
1685   58CD ED A0       > ldi
1685   58CF ED A0       > ldi
1685   58D1 ED A0       > ldi
1685   58D3 ED A0       > ldi
1685   58D5 ED A0       > ldi
1685   58D7 ED A0       > ldi
1685   58D9 ED A0       > ldi
1685   58DB ED A0       > ldi
1685   58DD ED A0       > ldi
1685   58DF ED A0       > ldi
1685   58E1 ED A0       > ldi
1685   58E3 ED A0       > ldi
1685   58E5 ED A0       > ldi
1685   58E7 ED A0       > ldi
1685   58E9 ED A0       > ldi
1685   58EB ED A0       > ldi
1685   58ED ED A0       > ldi
1685   58EF ED A0       > ldi
1685   58F1 ED A0       > ldi
1685   58F3 ED A0       > ldi
1685   58F5 ED A0       > ldi
1685   58F7 ED A0       > ldi
1685   58F9 ED A0       > ldi
1685   58FB ED A0       > ldi
1685   58FD ED A0       > ldi
1685   58FF ED A0       > ldi
1685   5901 ED A0       > ldi
1685   5903 ED A0       > ldi
1685   5905 ED A0       > ldi
1685   5907 ED A0       > ldi
1685   5909 ED A0       > ldi
1685   590B ED A0       > ldi
1685   590D ED A0       > ldi
1685   590F ED A0       > ldi
1685   5911 ED A0       > ldi
1685   5913 ED A0       > ldi
1685   5915 ED A0       > ldi
1685   5917 ED A0       > ldi
1685   5919 ED A0       > ldi
1685   591B ED A0       > ldi
1685   591D ED A0       > ldi
1685   591F ED A0       > ldi
1685   5921 ED A0       > ldi
1685   5923 ED A0       > ldi
1685   5925 ED A0       > ldi
1685   5927 ED A0       > ldi
1685   5929 ED A0       > ldi
1685   592B ED A0       > ldi
1685   592D ED A0       > ldi
1685   592F ED A0       > ldi
1685   5931 ED A0       > ldi
1685   5933 ED A0       > ldi
1685   5935 ED A0       > ldi
1685   5937 ED A0       > ldi
1685   5939 ED A0       > ldi
1685   593B ED A0       > ldi
1685   593D ED A0       > ldi
1685   593F ED A0       > ldi
1685   5941 ED A0       > ldi
1685   5943 ED A0       > ldi
1685   5945 ED A0       > ldi
1685   5947 ED A0       > ldi
1685   5949 ED A0       > ldi
1685   594B ED A0       > ldi
1685   594D ED A0       > ldi
1685   594F ED A0       > ldi
1685   5951 ED A0       > ldi
1685   5953 ED A0       > ldi
1685   5955 ED A0       > ldi
1685   5957 ED A0       > ldi
1685   5959 ED A0       > ldi
1685   595B ED A0       > ldi
1685   595D ED A0       > ldi
1685   595F ED A0       > ldi
1685   5961 ED A0       > ldi
1685   5963 ED A0       > ldi
1685   5965 ED A0       > ldi
1685   5967 ED A0       > ldi
1685   5969 ED A0       > ldi
1685   596B ED A0       > ldi
1685   596D ED A0       > ldi
1685   596F ED A0       > ldi
1685   5971 ED A0       > ldi
1685   5973 ED A0       > ldi
1685   5975 ED A0       > ldi
1685   5977 ED A0       > ldi
1685   5979 ED A0       > ldi
1685   597B ED A0       > ldi
1685   597D ED A0       > ldi
1685   597F ED A0       > ldi
1685   5981 ED A0       > ldi
1685   5983 ED A0       > ldi
1685   5985 ED A0       > ldi
1685   5987 ED A0       > ldi
1685   5989 ED A0       > ldi
1685   598B ED A0       > ldi
1685   598D ED A0       > ldi
1685   598F ED A0       > ldi
1685   5991 ED A0       > ldi
1685   5993 ED A0       > ldi
1685   5995 ED A0       > ldi
1685   5997 ED A0       > ldi
1685   5999 ED A0       > ldi
1685   599B ED A0       > ldi
1685   599D ED A0       > ldi
1685   599F ED A0       > ldi
1685   59A1 ED A0       > ldi
1685   59A3 ED A0       > ldi
1685   59A5 ED A0       > ldi
1685   59A7 ED A0       > ldi
1685   59A9 ED A0       > ldi
1685   59AB ED A0       > ldi
1685   59AD ED A0       > ldi
1685   59AF ED A0       > ldi
1685   59B1 ED A0       > ldi
1685   59B3 ED A0       > ldi
1685   59B5 ED A0       > ldi
1685   59B7 ED A0       > ldi
1685   59B9 ED A0       > ldi
1685   59BB ED A0       > ldi
1685   59BD ED A0       > ldi
1685   59BF ED A0       > ldi
1685   59C1 ED A0       > ldi
1685   59C3 ED A0       > ldi
1685   59C5 ED A0       > ldi
1685   59C7 ED A0       > ldi
1685   59C9 ED A0       > ldi
1685   59CB ED A0       > ldi
1685   59CD ED A0       > ldi
1685   59CF ED A0       > ldi
1685   59D1 ED A0       > ldi
1685   59D3 ED A0       > ldi
1685   59D5 ED A0       > ldi
1685   59D7 ED A0       > ldi
1685   59D9 ED A0       > ldi
1685   59DB ED A0       > ldi
1685   59DD ED A0       > ldi
1685   59DF ED A0       > ldi
1685   59E1 ED A0       > ldi
1685   59E3 ED A0       > ldi
1685   59E5 ED A0       > ldi
1685   59E7 ED A0       > ldi
1685   59E9 ED A0       > ldi
1685   59EB ED A0       > ldi
1685   59ED ED A0       > ldi
1685   59EF ED A0       > ldi
1685   59F1 ED A0       > ldi
1685   59F3 ED A0       > ldi
1685   59F5 ED A0       > ldi
1685   59F7 ED A0       > ldi
1685   59F9 ED A0       > ldi
1685   59FB ED A0       > ldi
1685   59FD ED A0       > ldi
1685   59FF ED A0       > ldi
1685   5A01 ED A0       > ldi
1685   5A03 ED A0       > ldi
1685   5A05 ED A0       > ldi
1685   5A07 ED A0       > ldi
1685   5A09 ED A0       > ldi
1685   5A0B ED A0       > ldi
1685   5A0D ED A0       > ldi
1685   5A0F ED A0       > ldi
1685   5A11 ED A0       > ldi
1685   5A13 ED A0       > ldi
1685   5A15 ED A0       > ldi
1685   5A17 ED A0       > ldi
1685   5A19 ED A0       > ldi
1685   5A1B ED A0       > ldi
1685   5A1D ED A0       > ldi
1686   5A1F             .part2m: 
1687   5A1F EB          	ex	de,hl
1688   5A20 3A 00 40    	ld	a, (PORTSPI)	; descarta CRC
1689   5A23 3A 00 40    	ld	a, (PORTSPI)
1690   5A26 FD 7E 32    	ld	a, (iy+NUMBLOCOS)	; testar se tem mais blocos para ler
1691   5A29 3D          	dec	a
1692   5A2A FD 77 32    	ld	(iy+NUMBLOCOS), a
1693   5A2D C2 0E 56    	jp	nz,.loop
1694   5A30 3E 4C       	ld	a, CMD12	; acabou os blocos, mandar CMD12 para cancelar leitura
1695   5A32 CD 95 4C    	call	SD_SEND_CMD_NO_ARGS
1696   5A35 C3 63 5E    	jp	.fim
1697   5A38             
1698   5A38 01 00 02    .r800m:  ld	bc,512
1699   5A3B ED B0       	ldir
1700   5A3D 18 E0       	jr	.part2m
1701   5A3F             
1702   5A3F 01 00 02    .r800s: 	ld	bc,512
1703   5A42 ED B0       	ldir
1704   5A44 C3 5F 5E    	jp	.part2s
1705   5A47             
1706   5A47             .umBloco: 
1707   5A47 3E 51       	ld	a, CMD17	; ler somente um bloco com CMD17 = Read Single Block
1708   5A49 CD 9A 4C    	call	SD_SEND_CMD_GET_ERROR
1709   5A4C DA EF 55    	jp	c,terminaLeituraEscritaBloco
1710   5A4F             
1711   5A4F CD F4 4C    	call	WAIT_RESP_FE
1712   5A52 DA EF 55    	jp	c,terminaLeituraEscritaBloco
1713   5A55 EB          	ex	de,hl
1714   5A56             
1715   5A56             	; Check for a Z80 or R800
1716   5A56             ;	or 	a		; Clear Cy
1717   5A56 3E 14       	ld	a,20
1718   5A58 ED F9       	db	#ED,#F9		; mulub a,a
1719   5A5A 21 00 40    	ld	hl, PORTSPI
1720   5A5D 38 E0       	jr	c,.r800s	; Use LDIR for R800
1721   5A5F ED A0       > ldi
1721   5A61 ED A0       > ldi
1721   5A63 ED A0       > ldi
1721   5A65 ED A0       > ldi
1721   5A67 ED A0       > ldi
1721   5A69 ED A0       > ldi
1721   5A6B ED A0       > ldi
1721   5A6D ED A0       > ldi
1721   5A6F ED A0       > ldi
1721   5A71 ED A0       > ldi
1721   5A73 ED A0       > ldi
1721   5A75 ED A0       > ldi
1721   5A77 ED A0       > ldi
1721   5A79 ED A0       > ldi
1721   5A7B ED A0       > ldi
1721   5A7D ED A0       > ldi
1721   5A7F ED A0       > ldi
1721   5A81 ED A0       > ldi
1721   5A83 ED A0       > ldi
1721   5A85 ED A0       > ldi
1721   5A87 ED A0       > ldi
1721   5A89 ED A0       > ldi
1721   5A8B ED A0       > ldi
1721   5A8D ED A0       > ldi
1721   5A8F ED A0       > ldi
1721   5A91 ED A0       > ldi
1721   5A93 ED A0       > ldi
1721   5A95 ED A0       > ldi
1721   5A97 ED A0       > ldi
1721   5A99 ED A0       > ldi
1721   5A9B ED A0       > ldi
1721   5A9D ED A0       > ldi
1721   5A9F ED A0       > ldi
1721   5AA1 ED A0       > ldi
1721   5AA3 ED A0       > ldi
1721   5AA5 ED A0       > ldi
1721   5AA7 ED A0       > ldi
1721   5AA9 ED A0       > ldi
1721   5AAB ED A0       > ldi
1721   5AAD ED A0       > ldi
1721   5AAF ED A0       > ldi
1721   5AB1 ED A0       > ldi
1721   5AB3 ED A0       > ldi
1721   5AB5 ED A0       > ldi
1721   5AB7 ED A0       > ldi
1721   5AB9 ED A0       > ldi
1721   5ABB ED A0       > ldi
1721   5ABD ED A0       > ldi
1721   5ABF ED A0       > ldi
1721   5AC1 ED A0       > ldi
1721   5AC3 ED A0       > ldi
1721   5AC5 ED A0       > ldi
1721   5AC7 ED A0       > ldi
1721   5AC9 ED A0       > ldi
1721   5ACB ED A0       > ldi
1721   5ACD ED A0       > ldi
1721   5ACF ED A0       > ldi
1721   5AD1 ED A0       > ldi
1721   5AD3 ED A0       > ldi
1721   5AD5 ED A0       > ldi
1721   5AD7 ED A0       > ldi
1721   5AD9 ED A0       > ldi
1721   5ADB ED A0       > ldi
1721   5ADD ED A0       > ldi
1721   5ADF ED A0       > ldi
1721   5AE1 ED A0       > ldi
1721   5AE3 ED A0       > ldi
1721   5AE5 ED A0       > ldi
1721   5AE7 ED A0       > ldi
1721   5AE9 ED A0       > ldi
1721   5AEB ED A0       > ldi
1721   5AED ED A0       > ldi
1721   5AEF ED A0       > ldi
1721   5AF1 ED A0       > ldi
1721   5AF3 ED A0       > ldi
1721   5AF5 ED A0       > ldi
1721   5AF7 ED A0       > ldi
1721   5AF9 ED A0       > ldi
1721   5AFB ED A0       > ldi
1721   5AFD ED A0       > ldi
1721   5AFF ED A0       > ldi
1721   5B01 ED A0       > ldi
1721   5B03 ED A0       > ldi
1721   5B05 ED A0       > ldi
1721   5B07 ED A0       > ldi
1721   5B09 ED A0       > ldi
1721   5B0B ED A0       > ldi
1721   5B0D ED A0       > ldi
1721   5B0F ED A0       > ldi
1721   5B11 ED A0       > ldi
1721   5B13 ED A0       > ldi
1721   5B15 ED A0       > ldi
1721   5B17 ED A0       > ldi
1721   5B19 ED A0       > ldi
1721   5B1B ED A0       > ldi
1721   5B1D ED A0       > ldi
1721   5B1F ED A0       > ldi
1721   5B21 ED A0       > ldi
1721   5B23 ED A0       > ldi
1721   5B25 ED A0       > ldi
1721   5B27 ED A0       > ldi
1721   5B29 ED A0       > ldi
1721   5B2B ED A0       > ldi
1721   5B2D ED A0       > ldi
1721   5B2F ED A0       > ldi
1721   5B31 ED A0       > ldi
1721   5B33 ED A0       > ldi
1721   5B35 ED A0       > ldi
1721   5B37 ED A0       > ldi
1721   5B39 ED A0       > ldi
1721   5B3B ED A0       > ldi
1721   5B3D ED A0       > ldi
1721   5B3F ED A0       > ldi
1721   5B41 ED A0       > ldi
1721   5B43 ED A0       > ldi
1721   5B45 ED A0       > ldi
1721   5B47 ED A0       > ldi
1721   5B49 ED A0       > ldi
1721   5B4B ED A0       > ldi
1721   5B4D ED A0       > ldi
1721   5B4F ED A0       > ldi
1721   5B51 ED A0       > ldi
1721   5B53 ED A0       > ldi
1721   5B55 ED A0       > ldi
1721   5B57 ED A0       > ldi
1721   5B59 ED A0       > ldi
1721   5B5B ED A0       > ldi
1721   5B5D ED A0       > ldi
1721   5B5F ED A0       > ldi
1721   5B61 ED A0       > ldi
1721   5B63 ED A0       > ldi
1721   5B65 ED A0       > ldi
1721   5B67 ED A0       > ldi
1721   5B69 ED A0       > ldi
1721   5B6B ED A0       > ldi
1721   5B6D ED A0       > ldi
1721   5B6F ED A0       > ldi
1721   5B71 ED A0       > ldi
1721   5B73 ED A0       > ldi
1721   5B75 ED A0       > ldi
1721   5B77 ED A0       > ldi
1721   5B79 ED A0       > ldi
1721   5B7B ED A0       > ldi
1721   5B7D ED A0       > ldi
1721   5B7F ED A0       > ldi
1721   5B81 ED A0       > ldi
1721   5B83 ED A0       > ldi
1721   5B85 ED A0       > ldi
1721   5B87 ED A0       > ldi
1721   5B89 ED A0       > ldi
1721   5B8B ED A0       > ldi
1721   5B8D ED A0       > ldi
1721   5B8F ED A0       > ldi
1721   5B91 ED A0       > ldi
1721   5B93 ED A0       > ldi
1721   5B95 ED A0       > ldi
1721   5B97 ED A0       > ldi
1721   5B99 ED A0       > ldi
1721   5B9B ED A0       > ldi
1721   5B9D ED A0       > ldi
1721   5B9F ED A0       > ldi
1721   5BA1 ED A0       > ldi
1721   5BA3 ED A0       > ldi
1721   5BA5 ED A0       > ldi
1721   5BA7 ED A0       > ldi
1721   5BA9 ED A0       > ldi
1721   5BAB ED A0       > ldi
1721   5BAD ED A0       > ldi
1721   5BAF ED A0       > ldi
1721   5BB1 ED A0       > ldi
1721   5BB3 ED A0       > ldi
1721   5BB5 ED A0       > ldi
1721   5BB7 ED A0       > ldi
1721   5BB9 ED A0       > ldi
1721   5BBB ED A0       > ldi
1721   5BBD ED A0       > ldi
1721   5BBF ED A0       > ldi
1721   5BC1 ED A0       > ldi
1721   5BC3 ED A0       > ldi
1721   5BC5 ED A0       > ldi
1721   5BC7 ED A0       > ldi
1721   5BC9 ED A0       > ldi
1721   5BCB ED A0       > ldi
1721   5BCD ED A0       > ldi
1721   5BCF ED A0       > ldi
1721   5BD1 ED A0       > ldi
1721   5BD3 ED A0       > ldi
1721   5BD5 ED A0       > ldi
1721   5BD7 ED A0       > ldi
1721   5BD9 ED A0       > ldi
1721   5BDB ED A0       > ldi
1721   5BDD ED A0       > ldi
1721   5BDF ED A0       > ldi
1721   5BE1 ED A0       > ldi
1721   5BE3 ED A0       > ldi
1721   5BE5 ED A0       > ldi
1721   5BE7 ED A0       > ldi
1721   5BE9 ED A0       > ldi
1721   5BEB ED A0       > ldi
1721   5BED ED A0       > ldi
1721   5BEF ED A0       > ldi
1721   5BF1 ED A0       > ldi
1721   5BF3 ED A0       > ldi
1721   5BF5 ED A0       > ldi
1721   5BF7 ED A0       > ldi
1721   5BF9 ED A0       > ldi
1721   5BFB ED A0       > ldi
1721   5BFD ED A0       > ldi
1721   5BFF ED A0       > ldi
1721   5C01 ED A0       > ldi
1721   5C03 ED A0       > ldi
1721   5C05 ED A0       > ldi
1721   5C07 ED A0       > ldi
1721   5C09 ED A0       > ldi
1721   5C0B ED A0       > ldi
1721   5C0D ED A0       > ldi
1721   5C0F ED A0       > ldi
1721   5C11 ED A0       > ldi
1721   5C13 ED A0       > ldi
1721   5C15 ED A0       > ldi
1721   5C17 ED A0       > ldi
1721   5C19 ED A0       > ldi
1721   5C1B ED A0       > ldi
1721   5C1D ED A0       > ldi
1721   5C1F ED A0       > ldi
1721   5C21 ED A0       > ldi
1721   5C23 ED A0       > ldi
1721   5C25 ED A0       > ldi
1721   5C27 ED A0       > ldi
1721   5C29 ED A0       > ldi
1721   5C2B ED A0       > ldi
1721   5C2D ED A0       > ldi
1721   5C2F ED A0       > ldi
1721   5C31 ED A0       > ldi
1721   5C33 ED A0       > ldi
1721   5C35 ED A0       > ldi
1721   5C37 ED A0       > ldi
1721   5C39 ED A0       > ldi
1721   5C3B ED A0       > ldi
1721   5C3D ED A0       > ldi
1721   5C3F ED A0       > ldi
1721   5C41 ED A0       > ldi
1721   5C43 ED A0       > ldi
1721   5C45 ED A0       > ldi
1721   5C47 ED A0       > ldi
1721   5C49 ED A0       > ldi
1721   5C4B ED A0       > ldi
1721   5C4D ED A0       > ldi
1721   5C4F ED A0       > ldi
1721   5C51 ED A0       > ldi
1721   5C53 ED A0       > ldi
1721   5C55 ED A0       > ldi
1721   5C57 ED A0       > ldi
1721   5C59 ED A0       > ldi
1721   5C5B ED A0       > ldi
1721   5C5D ED A0       > ldi
1721   5C5F ED A0       > ldi
1721   5C61 ED A0       > ldi
1721   5C63 ED A0       > ldi
1721   5C65 ED A0       > ldi
1721   5C67 ED A0       > ldi
1721   5C69 ED A0       > ldi
1721   5C6B ED A0       > ldi
1721   5C6D ED A0       > ldi
1721   5C6F ED A0       > ldi
1721   5C71 ED A0       > ldi
1721   5C73 ED A0       > ldi
1721   5C75 ED A0       > ldi
1721   5C77 ED A0       > ldi
1721   5C79 ED A0       > ldi
1721   5C7B ED A0       > ldi
1721   5C7D ED A0       > ldi
1721   5C7F ED A0       > ldi
1721   5C81 ED A0       > ldi
1721   5C83 ED A0       > ldi
1721   5C85 ED A0       > ldi
1721   5C87 ED A0       > ldi
1721   5C89 ED A0       > ldi
1721   5C8B ED A0       > ldi
1721   5C8D ED A0       > ldi
1721   5C8F ED A0       > ldi
1721   5C91 ED A0       > ldi
1721   5C93 ED A0       > ldi
1721   5C95 ED A0       > ldi
1721   5C97 ED A0       > ldi
1721   5C99 ED A0       > ldi
1721   5C9B ED A0       > ldi
1721   5C9D ED A0       > ldi
1721   5C9F ED A0       > ldi
1721   5CA1 ED A0       > ldi
1721   5CA3 ED A0       > ldi
1721   5CA5 ED A0       > ldi
1721   5CA7 ED A0       > ldi
1721   5CA9 ED A0       > ldi
1721   5CAB ED A0       > ldi
1721   5CAD ED A0       > ldi
1721   5CAF ED A0       > ldi
1721   5CB1 ED A0       > ldi
1721   5CB3 ED A0       > ldi
1721   5CB5 ED A0       > ldi
1721   5CB7 ED A0       > ldi
1721   5CB9 ED A0       > ldi
1721   5CBB ED A0       > ldi
1721   5CBD ED A0       > ldi
1721   5CBF ED A0       > ldi
1721   5CC1 ED A0       > ldi
1721   5CC3 ED A0       > ldi
1721   5CC5 ED A0       > ldi
1721   5CC7 ED A0       > ldi
1721   5CC9 ED A0       > ldi
1721   5CCB ED A0       > ldi
1721   5CCD ED A0       > ldi
1721   5CCF ED A0       > ldi
1721   5CD1 ED A0       > ldi
1721   5CD3 ED A0       > ldi
1721   5CD5 ED A0       > ldi
1721   5CD7 ED A0       > ldi
1721   5CD9 ED A0       > ldi
1721   5CDB ED A0       > ldi
1721   5CDD ED A0       > ldi
1721   5CDF ED A0       > ldi
1721   5CE1 ED A0       > ldi
1721   5CE3 ED A0       > ldi
1721   5CE5 ED A0       > ldi
1721   5CE7 ED A0       > ldi
1721   5CE9 ED A0       > ldi
1721   5CEB ED A0       > ldi
1721   5CED ED A0       > ldi
1721   5CEF ED A0       > ldi
1721   5CF1 ED A0       > ldi
1721   5CF3 ED A0       > ldi
1721   5CF5 ED A0       > ldi
1721   5CF7 ED A0       > ldi
1721   5CF9 ED A0       > ldi
1721   5CFB ED A0       > ldi
1721   5CFD ED A0       > ldi
1721   5CFF ED A0       > ldi
1721   5D01 ED A0       > ldi
1721   5D03 ED A0       > ldi
1721   5D05 ED A0       > ldi
1721   5D07 ED A0       > ldi
1721   5D09 ED A0       > ldi
1721   5D0B ED A0       > ldi
1721   5D0D ED A0       > ldi
1721   5D0F ED A0       > ldi
1721   5D11 ED A0       > ldi
1721   5D13 ED A0       > ldi
1721   5D15 ED A0       > ldi
1721   5D17 ED A0       > ldi
1721   5D19 ED A0       > ldi
1721   5D1B ED A0       > ldi
1721   5D1D ED A0       > ldi
1721   5D1F ED A0       > ldi
1721   5D21 ED A0       > ldi
1721   5D23 ED A0       > ldi
1721   5D25 ED A0       > ldi
1721   5D27 ED A0       > ldi
1721   5D29 ED A0       > ldi
1721   5D2B ED A0       > ldi
1721   5D2D ED A0       > ldi
1721   5D2F ED A0       > ldi
1721   5D31 ED A0       > ldi
1721   5D33 ED A0       > ldi
1721   5D35 ED A0       > ldi
1721   5D37 ED A0       > ldi
1721   5D39 ED A0       > ldi
1721   5D3B ED A0       > ldi
1721   5D3D ED A0       > ldi
1721   5D3F ED A0       > ldi
1721   5D41 ED A0       > ldi
1721   5D43 ED A0       > ldi
1721   5D45 ED A0       > ldi
1721   5D47 ED A0       > ldi
1721   5D49 ED A0       > ldi
1721   5D4B ED A0       > ldi
1721   5D4D ED A0       > ldi
1721   5D4F ED A0       > ldi
1721   5D51 ED A0       > ldi
1721   5D53 ED A0       > ldi
1721   5D55 ED A0       > ldi
1721   5D57 ED A0       > ldi
1721   5D59 ED A0       > ldi
1721   5D5B ED A0       > ldi
1721   5D5D ED A0       > ldi
1721   5D5F ED A0       > ldi
1721   5D61 ED A0       > ldi
1721   5D63 ED A0       > ldi
1721   5D65 ED A0       > ldi
1721   5D67 ED A0       > ldi
1721   5D69 ED A0       > ldi
1721   5D6B ED A0       > ldi
1721   5D6D ED A0       > ldi
1721   5D6F ED A0       > ldi
1721   5D71 ED A0       > ldi
1721   5D73 ED A0       > ldi
1721   5D75 ED A0       > ldi
1721   5D77 ED A0       > ldi
1721   5D79 ED A0       > ldi
1721   5D7B ED A0       > ldi
1721   5D7D ED A0       > ldi
1721   5D7F ED A0       > ldi
1721   5D81 ED A0       > ldi
1721   5D83 ED A0       > ldi
1721   5D85 ED A0       > ldi
1721   5D87 ED A0       > ldi
1721   5D89 ED A0       > ldi
1721   5D8B ED A0       > ldi
1721   5D8D ED A0       > ldi
1721   5D8F ED A0       > ldi
1721   5D91 ED A0       > ldi
1721   5D93 ED A0       > ldi
1721   5D95 ED A0       > ldi
1721   5D97 ED A0       > ldi
1721   5D99 ED A0       > ldi
1721   5D9B ED A0       > ldi
1721   5D9D ED A0       > ldi
1721   5D9F ED A0       > ldi
1721   5DA1 ED A0       > ldi
1721   5DA3 ED A0       > ldi
1721   5DA5 ED A0       > ldi
1721   5DA7 ED A0       > ldi
1721   5DA9 ED A0       > ldi
1721   5DAB ED A0       > ldi
1721   5DAD ED A0       > ldi
1721   5DAF ED A0       > ldi
1721   5DB1 ED A0       > ldi
1721   5DB3 ED A0       > ldi
1721   5DB5 ED A0       > ldi
1721   5DB7 ED A0       > ldi
1721   5DB9 ED A0       > ldi
1721   5DBB ED A0       > ldi
1721   5DBD ED A0       > ldi
1721   5DBF ED A0       > ldi
1721   5DC1 ED A0       > ldi
1721   5DC3 ED A0       > ldi
1721   5DC5 ED A0       > ldi
1721   5DC7 ED A0       > ldi
1721   5DC9 ED A0       > ldi
1721   5DCB ED A0       > ldi
1721   5DCD ED A0       > ldi
1721   5DCF ED A0       > ldi
1721   5DD1 ED A0       > ldi
1721   5DD3 ED A0       > ldi
1721   5DD5 ED A0       > ldi
1721   5DD7 ED A0       > ldi
1721   5DD9 ED A0       > ldi
1721   5DDB ED A0       > ldi
1721   5DDD ED A0       > ldi
1721   5DDF ED A0       > ldi
1721   5DE1 ED A0       > ldi
1721   5DE3 ED A0       > ldi
1721   5DE5 ED A0       > ldi
1721   5DE7 ED A0       > ldi
1721   5DE9 ED A0       > ldi
1721   5DEB ED A0       > ldi
1721   5DED ED A0       > ldi
1721   5DEF ED A0       > ldi
1721   5DF1 ED A0       > ldi
1721   5DF3 ED A0       > ldi
1721   5DF5 ED A0       > ldi
1721   5DF7 ED A0       > ldi
1721   5DF9 ED A0       > ldi
1721   5DFB ED A0       > ldi
1721   5DFD ED A0       > ldi
1721   5DFF ED A0       > ldi
1721   5E01 ED A0       > ldi
1721   5E03 ED A0       > ldi
1721   5E05 ED A0       > ldi
1721   5E07 ED A0       > ldi
1721   5E09 ED A0       > ldi
1721   5E0B ED A0       > ldi
1721   5E0D ED A0       > ldi
1721   5E0F ED A0       > ldi
1721   5E11 ED A0       > ldi
1721   5E13 ED A0       > ldi
1721   5E15 ED A0       > ldi
1721   5E17 ED A0       > ldi
1721   5E19 ED A0       > ldi
1721   5E1B ED A0       > ldi
1721   5E1D ED A0       > ldi
1721   5E1F ED A0       > ldi
1721   5E21 ED A0       > ldi
1721   5E23 ED A0       > ldi
1721   5E25 ED A0       > ldi
1721   5E27 ED A0       > ldi
1721   5E29 ED A0       > ldi
1721   5E2B ED A0       > ldi
1721   5E2D ED A0       > ldi
1721   5E2F ED A0       > ldi
1721   5E31 ED A0       > ldi
1721   5E33 ED A0       > ldi
1721   5E35 ED A0       > ldi
1721   5E37 ED A0       > ldi
1721   5E39 ED A0       > ldi
1721   5E3B ED A0       > ldi
1721   5E3D ED A0       > ldi
1721   5E3F ED A0       > ldi
1721   5E41 ED A0       > ldi
1721   5E43 ED A0       > ldi
1721   5E45 ED A0       > ldi
1721   5E47 ED A0       > ldi
1721   5E49 ED A0       > ldi
1721   5E4B ED A0       > ldi
1721   5E4D ED A0       > ldi
1721   5E4F ED A0       > ldi
1721   5E51 ED A0       > ldi
1721   5E53 ED A0       > ldi
1721   5E55 ED A0       > ldi
1721   5E57 ED A0       > ldi
1721   5E59 ED A0       > ldi
1721   5E5B ED A0       > ldi
1721   5E5D ED A0       > ldi
1722   5E5F             .part2s: 
1723   5E5F EB          	ex	de,hl
1724   5E60 3A 00 40    	ld	a, (PORTSPI)	; descarta CRC
1725   5E63             .fim: 
1726   5E63 AF          	xor	a		; zera carry para informar leitura sem erros
1727   5E64 C3 EF 55    	jp	terminaLeituraEscritaBloco
1728   5E67             
1729   5E67             
1730   5E67             ; ------------------------------------------------
1731   5E67             ; Converte blocos para bytes. Na pratica faz
1732   5E67             ; BC DE = (BC DE) * 512
1733   5E67             ; ------------------------------------------------
1734   5E67             blocoParaByte: 
1735   5E67 41          	ld	b, c
1736   5E68 4A          	ld	c, d
1737   5E69 53          	ld	d, e
1738   5E6A 1E 00       	ld	e, 0
1739   5E6C CB 22       	sla	d
1740   5E6E CB 11       	rl	c
1741   5E70 CB 10       	rl	b
1742   5E72 C9          	ret
1743   5E73             
1744   5E73             ; ------------------------------------------------
1745   5E73             ; Funcoes utilitarias
1746   5E73             ; ------------------------------------------------
1747   5E73             
1748   5E73             ; ------------------------------------------------
1749   5E73             ; Chaveia para modo SPI
1750   5E73             ; ------------------------------------------------
1751   5E73             modoSPI: 
1752   5E73 F5          	push	af
1753   5E74 3E 01       	ld	a, 1
1754   5E76 32 01 60    	ld	(CHAVEIASPI), a
1755   5E79 F1          	pop	af
1756   5E7A C9          	ret
1757   5E7B             
1758   5E7B             ; ------------------------------------------------
1759   5E7B             ; Chaveia para modo ROM
1760   5E7B             ; ------------------------------------------------
1761   5E7B             modoROM: 
1762   5E7B F5          	push	af
1763   5E7C 3E 00       	ld	a, 0
1764   5E7E 32 01 60    	ld	(CHAVEIASPI), a
1765   5E81 F1          	pop	af
1766   5E82 C9          	ret
1767   5E83             
1768   5E83             ; ------------------------------------------------
1769   5E83             ; Imprime string na tela apontada por DE
1770   5E83             ; Destroi todos os registradores
1771   5E83             ; ------------------------------------------------
1772   5E83             printString: 
1773   5E83 1A          	ld	a, (de)
1774   5E84 B7          	or	a
1775   5E85 C8          	ret	z
1776   5E86 CD A2 00    	call	CHPUT
1777   5E89 13          	inc	de
1778   5E8A 18 F7       	jr	printString
1779   5E8C             
1780   5E8C             
1781   5E8C             ; ------------------------------------------------
1782   5E8C             ; Converte o byte em A para string em decimal no
1783   5E8C             ; buffer apontado por DE
1784   5E8C             ; Destroi AF, BC, HL, DE
1785   5E8C             ; ------------------------------------------------
1786   5E8C             DecToAscii: 
1787   5E8C 26 00       	ld	h, 0
1788   5E8E 6F          	ld	l, a		; copiar A para HL
1789   5E8F FD 36 34 01 	ld	(iy+TEMP), 1	; flag para indicar que devemos cortar os zeros a esquerda
1790   5E93 01 9C FF    	ld	bc, -100	; centenas
1791   5E96 CD A4 5E    	call	.num1
1792   5E99 0E F6       	ld	c, -10		; dezenas
1793   5E9B CD A4 5E    	call	.num1
1794   5E9E FD 36 34 02 	ld	(iy+TEMP), 2	; unidade deve exibir 0 se for zero e nao corta-lo
1795   5EA2 0E FF       	ld	c, -1		; unidades
1796   5EA4             .num1: 
1797   5EA4 3E 2F       	ld	a, '0'-1
1798   5EA6             .num2: 
1799   5EA6 3C          	inc	a		; contar o valor em ascii de '0' a '9'
1800   5EA7 09          	add	hl, bc		; somar com negativo
1801   5EA8 38 FC       	jr	c,.num2		; ainda nao zeramos
1802   5EAA ED 42       	sbc	hl, bc		; retoma valor original
1803   5EAC FD 35 34    	dec	(iy+TEMP)	; se flag do corte do zero indicar para nao cortar, pula
1804   5EAF 20 08       	jr	nz,.naozero
1805   5EB1 FE 30       	cp	'0'		; devemos cortar os zeros a esquerda. Eh zero?
1806   5EB3 20 04       	jr	nz,.naozero
1807   5EB5 FD 34 34    	inc	(iy+TEMP)	; se for zero, nao salvamos e voltamos a flag
1808   5EB8 C9          	ret
1809   5EB9             .naozero: 
1810   5EB9 12          	ld	(de), a		; eh zero ou eh outro numero, salvar
1811   5EBA 13          	inc	de		; incrementa ponteiro de destino
1812   5EBB C9          	ret
1813   5EBC             
1814   5EBC             ; ------------------------------------------------
1815   5EBC             ; Converte o byte em A para string em hexa no
1816   5EBC             ; buffer apontado por DE
1817   5EBC             ; Destroi AF, C, DE
1818   5EBC             ; ------------------------------------------------
1819   5EBC             HexToAscii: 
1820   5EBC 4F          	ld	c, a
1821   5EBD 1F          	rra
1822   5EBE 1F          	rra
1823   5EBF 1F          	rra
1824   5EC0 1F          	rra
1825   5EC1 CD C5 5E    	call	.conv
1826   5EC4 79          	ld  	a, c
1827   5EC5             .conv: 
1828   5EC5 E6 0F       	and	$0F
1829   5EC7 C6 90       	add	a, $90
1830   5EC9 27          	daa
1831   5ECA CE 40       	adc	a, $40
1832   5ECC 27          	daa
1833   5ECD 12          	ld	(de), a
1834   5ECE 13          	inc	de
1835   5ECF C9          	ret
1836   5ED0             
1837   5ED0             ; ------------------------------------------------
1838   5ED0             ; Converte o byte em A para string em decimal e
1839   5ED0             ; imprime na tela
1840   5ED0             ; Destroi AF, BC, HL, DE
1841   5ED0             ; ------------------------------------------------
1842   5ED0             printDecToAscii: 
1843   5ED0 26 00       	ld	h, 0
1844   5ED2 6F          	ld	l, a		; copiar A para HL
1845   5ED3 06 01       	ld	b, 1		; flag para indicar que devemos cortar os zeros a esquerda
1846   5ED5 11 9C FF    	ld	de, -100	; centenas
1847   5ED8 CD E4 5E    	call	.num1
1848   5EDB 1E F6       	ld	e, -10		; dezenas
1849   5EDD CD E4 5E    	call	.num1
1850   5EE0 06 02       	ld	b, 2		; unidade deve exibir 0 se for zero e nao corta-lo
1851   5EE2 1E FF       	ld	e, -1		; unidades
1852   5EE4             .num1: 
1853   5EE4 3E 2F       	ld	a, '0'-1
1854   5EE6             .num2: 
1855   5EE6 3C          	inc	a		; contar o valor em ascii de '0' a '9'
1856   5EE7 19          	add	hl, de		; somar com negativo
1857   5EE8 38 FC       	jr	c,.num2		; ainda nao zeramos
1858   5EEA ED 52       	sbc	hl, de		; retoma valor original
1859   5EEC 10 06       	djnz	.naozero	; se flag do corte do zero indicar para nao cortar, pula
1860   5EEE FE 30       	cp	'0'		; devemos cortar os zeros a esquerda. Eh zero?
1861   5EF0 20 02       	jr	nz,.naozero
1862   5EF2 04          	inc	b		; se for zero, nao imprimimos e voltamos a flag
1863   5EF3 C9          	ret
1864   5EF4             .naozero: 
1865   5EF4 E5          	push	hl		; nao eh zero ou eh outro numero, imprimir
1866   5EF5 C5          	push	bc
1867   5EF6 CD A2 00    	call	CHPUT
1868   5EF9 C1          	pop	bc
1869   5EFA E1          	pop	hl
1870   5EFB C9          	ret
1871   5EFC             
1872   5EFC             ; ------------------------------------------------
1873   5EFC             ; Procura pelo nome do fabricante em uma tabela.
1874   5EFC             ; A contem o byte do fabricante
1875   5EFC             ; Devolve HL apontando para o buffer do fabricante
1876   5EFC             ; e BC com o comprimento do texto
1877   5EFC             ; Destroi AF, BC, HL
1878   5EFC             ; ------------------------------------------------
1879   5EFC             pegaFabricante: 
1880   5EFC 4F          	ld	c, a
1881   5EFD 21 1E 5F    	ld	hl, tblFabricantes
1882   5F00             
1883   5F00             .loop: 
1884   5F00 7E          	ld	a, (hl)
1885   5F01 23          	inc	hl
1886   5F02 B9          	cp	c
1887   5F03 28 0C       	jr	z,.achado
1888   5F05 B7          	or	a
1889   5F06 28 09       	jr	z,.achado
1890   5F08 C5          	push	bc
1891   5F09 CD 11 5F    	call	.achado
1892   5F0C 09          	add	hl, bc
1893   5F0D 23          	inc	hl
1894   5F0E C1          	pop	bc
1895   5F0F 18 EF       	jr	.loop
1896   5F11             
1897   5F11             .achado: 
1898   5F11 0E 00       	ld	c, 0
1899   5F13 E5          	push	hl
1900   5F14 AF          	xor	a
1901   5F15             .loop2: 
1902   5F15 0C          	inc	c
1903   5F16 23          	inc	hl
1904   5F17 BE          	cp	(hl)
1905   5F18 20 FB       	jr	nz,.loop2
1906   5F1A E1          	pop	hl
1907   5F1B 06 00       	ld	b, 0
1908   5F1D C9          	ret
1909   5F1E             
1910   5F1E             tblFabricantes: 
1911   5F1E 01          	db	1
1912   5F1F             	db	"Panasonic",0
1912   5F1F 50616E61736F6E696300
1913   5F29 02          	db	2
1914   5F2A             	db	"Toshiba",0
1914   5F2A 546F736869626100
1915   5F32 03          	db	3
1916   5F33             	db	"SanDisk",0
1916   5F33 53616E4469736B00
1917   5F3B 04          	db	4
1918   5F3C             	db	"SMI-S",0
1918   5F3C 534D492D5300
1919   5F42 06          	db	6
1920   5F43             	db	"Renesas",0
1920   5F43 52656E6573617300
1921   5F4B 11          	db	17
1922   5F4C             	db	"Dane-Elec",0
1922   5F4C 44616E652D456C656300
1923   5F56 13          	db	19
1924   5F57             	db	"KingMax",0
1924   5F57 4B696E674D617800
1925   5F5F 15          	db	21
1926   5F60             	db	"Samsung",0
1926   5F60 53616D73756E6700
1927   5F68 18          	db	24
1928   5F69             	db	"Infineon",0
1928   5F69 496E66696E656F6E00
1929   5F72 1A          	db	26
1930   5F73 50 51 49 00 	db	"PQI",0
1931   5F77 1B          	db	27
1932   5F78 536F6E7900  	db	"Sony",0
1933   5F7D 1C          	db	28
1934   5F7E             	db	"Transcend",0
1934   5F7E 5472616E7363656E6400
1935   5F88 1D          	db	29
1936   5F89             	db	"A-DATA",0
1936   5F89 412D4441544100
1937   5F90 1F          	db	31
1938   5F91             	db	"SiliconPower",0
1938   5F91 53696C69636F6E506F77657200
1939   5F9E 27          	db	39
1940   5F9F             	db	"Verbatim",0
1940   5F9F 566572626174696D00
1941   5FA8 41          	db	65
1942   5FA9 4F 4B 49 00 	db	"OKI",0
1943   5FAD 73          	db	115
1944   5FAE             	db	"SilverHT",0
1944   5FAE 53696C766572485400
1945   5FB7 89          	db	137
1946   5FB8             	db	"L.Data",0
1946   5FB8 4C2E4461746100
1947   5FBF 00          	db	0
1948   5FC0             	db	"Generico",0
1948   5FC0 47656E657269636F00
1949   5FC9             
1950   5FC9             
1951   5FC9             ; ------------------------------------------------
1952   5FC9             ; Restore screen parameters on MSX>=2 if they're
1953   5FC9             ; not set yet
1954   5FC9             ; ------------------------------------------------
1955   5FC9             MYSETSCR: 
1956   5FC9 3A 2D 00    	ld	a,(MSXVER)
1957   5FCC B7          	or	a			; MSX1?
1958   5FCD CA 6C 00    	jp	z,INITXT		; Yes, change do screen-0
1959   5FD0             
1960   5FD0 0E 23       	ld	c,$23			; Block-2, R#3
1961   5FD2 DD 21 F5 01 	ld 	ix,REDCLK
1962   5FD6 CD 5F 01    	call	EXTROM
1963   5FD9 E6 01       	and	1
1964   5FDB 47          	ld	b,a
1965   5FDC 3A AF FC    	ld	a,(SCRMOD)
1966   5FDF B8          	cp	b
1967   5FE0 20 1C       	jr	nz,.restore
1968   5FE2 0C          	inc	c
1969   5FE3 DD 21 F5 01 	ld 	ix,REDCLK
1970   5FE7 CD 5F 01    	call	EXTROM
1971   5FEA 47          	ld	b,a
1972   5FEB 0C          	inc	c
1973   5FEC DD 21 F5 01 	ld 	ix,REDCLK
1974   5FF0 CD 5F 01    	call	EXTROM
1975   5FF3 87          	add	a,a
1976   5FF4 87          	add	a,a
1977   5FF5 87          	add	a,a
1978   5FF6 87          	add	a,a
1979   5FF7 B0          	or	b
1980   5FF8 47          	ld	b,a
1981   5FF9 3A B0 F3    	ld	a,(LINLEN)
1982   5FFC B8          	cp	b
1983   5FFD C8          	ret	z
1984   5FFE             .restore: 
1985   5FFE AF          	xor	a		; Don't displat the function keys
1986   5FFF DD 21 85 01 	ld	ix,SDFSCR
1987   6003 C3 5F 01    	jp	EXTROM
1988   6006             
1989   6006             
1990   6006             
1991   6006             ; ==========================================================================
1992   6006             strTitle: 
1993   6006             	db	"FBLabs SDHC driver "
1993   6006 46424C61627320534448432064726976657220
1994   6019             	db	"v",VER_MAIN+$30,'.',VER_SEC+$30,'.',VER_REV+$30
1994   6019 76312E302E36
1995   601F 0D 0A 00    	db	13,10,0
1996   6022             
1997   6022             strBootpaused: 
1998   6022             	db	"Paused. Press <i> to show the copyright info.",13,10,0
1998   6022 5061757365642E205072657373203C693E20746F2073686F772074686520636F
1998   6042 7079726967687420696E666F2E0D0A00
1999   6052             
2000   6052             strCopyright: 
2001   6052             	db	"Copyright (c) 2014 Fabio Belavenuto",13,10
2001   6052 436F7079726967687420286329203230313420466162696F2042656C6176656E
2001   6072 75746F0D0A
2002   6077             	db	"Licenced under CERN OHL v1.1",13,10
2002   6077 4C6963656E63656420756E646572204345524E204F484C2076312E310D0A
2003   6095             	db	"http://ohwr.org/cernohl",13,10
2003   6095 687474703A2F2F6F6877722E6F72672F6365726E6F686C0D0A
2004   60AE             	db	"PCB designed by Luciano Sturaro",13,10
2004   60AE 5043422064657369676E6564206279204C756369616E6F205374757261726F0D
2004   60CE 0A
2005   60CF             	; fall throw
2006   60CF             strCrLf: 
2007   60CF 0D 0A 00    	db	13,10,0
2008   60D2             strCartao: 
2009   60D2             	db	"Slot ",0
2009   60D2 536C6F742000
2010   60D8             strVazio: 
2011   60D8             	db	"Empty",13,10,0
2011   60D8 456D7074790D0A00
2012   60E0             strNaoIdentificado: 
2013   60E0             	db	"Unknown!",13,10,0
2013   60E0 556E6B6E6F776E210D0A00
2014   60EB             			;----------------------------------------
2015   60EB             strMr_mp_desativada: 
2016   60EB             	db	"Slot expander/Mapper/MegaRAM disabled",13,10,0
2016   60EB 536C6F7420657870616E6465722F4D61707065722F4D65676152414D20646973
2016   610B 61626C65640D0A00
2017   6113             strMapper: 
2018   6113             	db	"Slot expanded and Memory Mapper enabled",13,10,0
2018   6113 536C6F7420657870616E64656420616E64204D656D6F7279204D617070657220
2018   6133 656E61626C65640D0A00
2019   613D             strMegaram: 
2020   613D             	db	"Slot expander and MegaRAM enabled",13,10,0
2020   613D 536C6F7420657870616E64657220616E64204D65676152414D20656E61626C65
2020   615D 640D0A00
2021   6161             strSDV1: 
2022   6161             	db	"SDV1 - ",0
2022   6161 53445631202D2000
2023   6169             strSDV2: 
2024   6169             	db	"SDV2 - ",0
2024   6169 53445632202D2000
2025   6171             
2026   6171             ;-----------------------------------------------------------------------------
2027   6171             ;
2028   6171             ; End of the driver code
2029   6171             
2030   6171             DRV_END: 
2031   6171             
2032   6171 FF          	ds	3ED0h-(DRV_END-DRV_START), $FF
2033   7FD0             
2034   7FD0             
