0001   0000             ; Projeto MSX SD Mapper
0002   0000             
0003   0000             ; Copyright (c) 2014 Fabio Belavenuto
0004   0000             ; Enhanced by FRS
0005   0000             
0006   0000             ; This documentation describes Open Hardware and is licensed under the CERN OHL v. 1.1.
0007   0000             ; You may redistribute and modify this documentation under the terms of the
0008   0000             ; CERN OHL v.1.1. (http://ohwr.org/cernohl). This documentation is distributed
0009   0000             ; WITHOUT ANY EXPRESS OR IMPLIED WARRANTY, INCLUDING OF MERCHANTABILITY,
0010   0000             ; SATISFACTORY QUALITY AND FITNESS FOR A PARTICULAR PURPOSE.
0011   0000             ; Please see the CERN OHL v.1.1 for applicable conditions
0012   0000             
0013   0000             ; Technical info:
0014   0000             ; 4000h~47FFh	: SPI data transfer window (read/write)
0015   0000             ; 4800h		: Interface status and card select register (read/write)
0016   0000             ;	<read>
0017   0000             ;	b0	: 0=SD card present on slot-0
0018   0000             ;	b1	: 0=SD card present on slot-1
0019   0000             ;	b2	: 0=Write protecton enabled for SD card slot-0
0020   0000             ;	b3	: 0=Write protecton enabled for SD card slot-1
0021   0000             ;	b4	: SW0 status. 0=RAM enabled, 1=RAM disabled
0022   0000             ;	b5	: SW1 status. 0=RAM mode: MegaRAM, 1=RAM mode: Memory Mapper
0023   0000             ;	b6	: Reserved for future use. Must be masked out from readings.
0024   0000             ;	b7	: 1=SPI transfer busy. 0=No ongoing SPI transfer
0025   0000             ;	<write>
0026   0000             ;	b0	: SD card slot-0 chip-select (0=selected)
0027   0000             ;	b1	: SD card slot-1 chip-select (0=selected)
0028   0000             
0029   0000             ; 6001h		: Mode configuration register (write only)
0030   0000             ;	b0	: 0=ROM mode, SPI interface disabled, 1=SPI interface enabled
0031   0000             
0032   0000             
0033   0000             
0034   0000             	output	"driver.bin"
0035   0000             
0036   0000             ;-----------------------------------------------------------------------------
0037   0000             ;
0038   0000             ; Driver configuration constants
0039   0000             ;
0040   0000             
0041   0000             ;Driver type:
0042   0000             ;   0 for drive-based
0043   0000             ;   1 for device-based
0044   0000             
0045   0000             DRV_TYPE	equ	1
0046   0000             
0047   0000             ;Hot-plug devices support (device-based drivers only):
0048   0000             ;   0 for no hot-plug support
0049   0000             ;   1 for hot-plug support
0050   0000             
0051   0000             DRV_HOTPLUG	equ	1
0052   0000             
0053   0000             DEBUG	equ	0	;Set to 1 for debugging, 0 to normal operation
0054   0000             
0055   0000             ;Driver version
0056   0000             
0057   0000             VER_MAIN	equ	1
0058   0000             VER_SEC		equ	0
0059   0000             VER_REV		equ	6
0060   0000             
0061   0000             ;-----------------------------------------------------------------------------
0062   0000             ; SPI addresses. Check the Technical info above for the bit contents
0063   0000             
0064   0000             CHAVEIASPI	= $6001 ; Mode config register
0065   0000             PORTCFG		= $4800	; Interface status and card select register 
0066   0000             PORTSPI		= $4000	; SPI data port
0067   0000             
0068   0000             ; Comandos SPI:
0069   0000             CMD0	= 0  | $40
0070   0000             CMD1	= 1  | $40
0071   0000             CMD8	= 8  | $40
0072   0000             CMD9	= 9  | $40
0073   0000             CMD10	= 10 | $40
0074   0000             CMD12	= 12 | $40
0075   0000             CMD16	= 16 | $40
0076   0000             CMD17	= 17 | $40
0077   0000             CMD18	= 18 | $40
0078   0000             CMD24	= 24 | $40
0079   0000             CMD25	= 25 | $40
0080   0000             CMD55	= 55 | $40
0081   0000             CMD58	= 58 | $40
0082   0000             ACMD23	= 23 | $40
0083   0000             ACMD41	= 41 | $40
0084   0000             
0085   0000             ; Work area variables 
0086   0000              STRUCT WRKAREA
0087   0000~            BCSD 		ds 16	; Card Specific Data
0088   0000~            BCID1		ds 16	; Card-ID of card1
0089   0000~            BCID2		ds 16	; Card-ID of card2
0090   0000~            NUMSD		db 	; Currently selected card: 1 or 2 
0091   0000~            CARDFLAGS	db 	; Flags that indicate card-change or card error 
0092   0000~            NUMBLOCKS	db 	; Number of blocks in multi-block operations 
0093   0000~            BLOCKS1		ds 3	; 3 bytes. Size of card1, in blocks.
0094   0000~            BLOCKS2		ds 3	; 3 bytes. Size of card2, in blocks.
0095   0000~            TEMP		db	; Temporary data
0096   0000~            TRLDIR		ds 8	; R800 data transfer helper 
0097   0000              ENDS
0098   0000             
0099   0000             
0100   0000             ;-----------------------------------------------------------------------------
0101   0000             ;
0102   0000             ; Standard BIOS and work area entries
0103   0000             INITXT	= $006C		; Inicializa SCREEN0
0104   0000             CHSNS	= $009C		; Sense keyboard buffer for character
0105   0000             CHGET	= $009F		; Get character from keyboard buffer
0106   0000             CHPUT	= $00A2		; A=char
0107   0000             CLS	= $00C3		; Chamar com A=0
0108   0000             ERAFNK	= $00CC		; Erase function key display
0109   0000             SNSMAT	= $0141		; Read row of keyboard matrix
0110   0000             KILBUF	= $0156		; Clear keyboard buffer
0111   0000             EXTROM	= $015F
0112   0000             
0113   0000             ; subROM functions
0114   0000             SDFSCR	= $0185
0115   0000             REDCLK	= $01F5
0116   0000             
0117   0000             
0118   0000             ; System variables
0119   0000             MSXVER	= $002D
0120   0000             LINL40	= $F3AE		; Width
0121   0000             LINLEN	= $F3B0
0122   0000             INTFLG	= $FC9B
0123   0000             SCRMOD	= $FCAF
0124   0000             
0125   0000             
0126   0000             ;-----------------------------------------------------------------------------
0127   0000             
0128   0000             
0129   0000             	org		$4000
0130   4000             
0131   4000 FF          	ds		256, $FF		; 256 dummy bytes
0132   4100             
0133   4100             DRV_START: 
0134   4100             
0135   4100             ;-----------------------------------------------------------------------------
0136   4100             ;
0137   4100             ; Miscellaneous constants
0138   4100             ;
0139   4100             
0140   4100             ;This is a 2 byte buffer to store the address of code to be executed.
0141   4100             ;It is used by some of the kernel page 0 routines.
0142   4100             
0143   4100             CODE_ADD: 	equ	0F84Ch
0144   4100             
0145   4100             
0146   4100             ;-----------------------------------------------------------------------------
0147   4100             ;
0148   4100             ; Error codes for DEV_RW
0149   4100             ;
0150   4100             
0151   4100             ENCOMP	equ	0FFh
0152   4100             EWRERR	equ	0FEh
0153   4100             EDISK	equ	0FDh
0154   4100             ENRDY	equ	0FCh
0155   4100             EDATA	equ	0FAh
0156   4100             ERNF	equ	0F9h
0157   4100             EWPROT	equ	0F8h
0158   4100             EUFORM	equ	0F7h
0159   4100             ESEEK	equ	0F3h
0160   4100             EIFORM	equ	0F0h
0161   4100             EIDEVL	equ	0B5h
0162   4100             EIPARM	equ	08Bh
0163   4100             
0164   4100             ;-----------------------------------------------------------------------------
0165   4100             ;
0166   4100             ; Routines and information available on kernel page 0
0167   4100             ;
0168   4100             
0169   4100             ;* Get in A the current slot for page 1. Corrupts F.
0170   4100             ;  Must be called by using CALBNK to bank 0:
0171   4100             ;    xor a
0172   4100             ;    ld ix,GSLOT1
0173   4100             ;    call CALBNK
0174   4100             
0175   4100             GSLOT1	equ	402Dh
0176   4100             
0177   4100             
0178   4100             ;* This routine reads a byte from another bank.
0179   4100             ;  Must be called by using CALBNK to the desired bank,
0180   4100             ;  passing the address to be read in HL:
0181   4100             ;    ld a,<bank number>
0182   4100             ;    ld hl,<byte address>
0183   4100             ;    ld ix,RDBANK
0184   4100             ;    call CALBNK
0185   4100             
0186   4100             RDBANK	equ	403Ch
0187   4100             
0188   4100             
0189   4100             ;* This routine temporarily switches kernel main bank
0190   4100             ;  (usually bank 0, but will be 3 when running in MSX-DOS 1 mode),
0191   4100             ;  then invokes the routine whose address is at (CODE_ADD).
0192   4100             ;  It is necessary to use this routine to invoke CALBAS
0193   4100             ;  (so that kernel bank is correct in case of BASIC error)
0194   4100             ;  and to invoke DOS functions via F37Dh hook.
0195   4100             ;
0196   4100             ;  Input:  Address of code to invoke in (CODE_ADD).
0197   4100             ;          AF, BC, DE, HL, IX, IY passed to the called routine.
0198   4100             ;  Output: AF, BC, DE, HL, IX, IY returned from the called routine.
0199   4100             
0200   4100             CALLB0	equ	403Fh
0201   4100             
0202   4100             
0203   4100             ;* Call a routine in another bank.
0204   4100             ;  Must be used if the driver spawns across more than one bank.
0205   4100             ;
0206   4100             ;  Input:  A = bank number
0207   4100             ;          IX = routine address
0208   4100             ;          AF' = AF for the routine
0209   4100             ;          HL' = Ix for the routine
0210   4100             ;          BC, DE, HL, IY = input for the routine
0211   4100             ;  Output: AF, BC, DE, HL, IX, IY returned from the called routine.
0212   4100             
0213   4100             CALBNK	equ	4042h
0214   4100             
0215   4100             
0216   4100             ;* Get in IX the address of the SLTWRK entry for the slot passed in A,
0217   4100             ;  which will in turn contain a pointer to the allocated page 3
0218   4100             ;  work area for that slot (0 if no work area was allocated).
0219   4100             ;  If A=0, then it uses the slot currently switched in page 1.
0220   4100             ;  Returns A=current slot for page 1, if A=0 was passed.
0221   4100             ;  Corrupts F.
0222   4100             ;  Must be called by using CALBNK to bank 0:
0223   4100             ;    ld a,<slot number> (xor a for current page 1 slot)
0224   4100             ;    ex af,af'
0225   4100             ;    xor a
0226   4100             ;    ld ix,GWORK
0227   4100             ;    call CALBNK
0228   4100             
0229   4100             GWORK	equ	4045h
0230   4100             
0231   4100             
0232   4100             ;* This address contains one byte that tells how many banks
0233   4100             ;  form the Nextor kernel (or alternatively, the first bank
0234   4100             ;  number of the driver).
0235   4100             
0236   4100             K_SIZE	equ	40FEh
0237   4100             
0238   4100             
0239   4100             ;* This address contains one byte with the current bank number.
0240   4100             
0241   4100             CUR_BANK	equ	40FFh
0242   4100             
0243   4100             
0244   4100             ;-----------------------------------------------------------------------------
0245   4100             ;
0246   4100             ; Built-in format choice strings
0247   4100             ;
0248   4100             
0249   4100             NULL_MSG  equ     781Fh	;Null string (disk can't be formatted)
0250   4100             SING_DBL  equ     7820h ;"1-Single side / 2-Double side"
0251   4100             
0252   4100             
0253   4100             ;-----------------------------------------------------------------------------
0254   4100             ;
0255   4100             ; Driver signature
0256   4100             ;
0257   4100             	db	"NEXTOR_DRIVER",0
0257   4100 4E4558544F525F44524956455200
0258   410E             
0259   410E             
0260   410E             ;-----------------------------------------------------------------------------
0261   410E             ;
0262   410E             ; Driver flags:
0263   410E             ;    bit 0: 0 for drive-based, 1 for device-based
0264   410E             ;    bit 1: 1 for hot-plug devices supported (device-based drivers only)
0265   410E             
0266   410E 03          	db 1+(2*DRV_HOTPLUG)
0267   410F             
0268   410F             ;-----------------------------------------------------------------------------
0269   410F             ;
0270   410F             ; Reserved byte
0271   410F             ;
0272   410F 00          	db	0
0273   4110             
0274   4110             ;-----------------------------------------------------------------------------
0275   4110             ;
0276   4110             ; Driver name
0277   4110             ;
0278   4110             
0279   4110             DRV_NAME: 
0280   4110             	db	"SDMapper Driver"
0280   4110 53444D617070657220447269766572
0281   411F 20          	ds	32-($-DRV_NAME)," "
0282   4130             
0283   4130             
0284   4130             ;-----------------------------------------------------------------------------
0285   4130             ;
0286   4130             ; Jump table for the driver public routines
0287   4130             ;
0288   4130             
0289   4130             	; These routines are mandatory for all drivers
0290   4130                     ; (but probably you need to implement only DRV_INIT)
0291   4130             
0292   4130 C3 6C 41    	jp	DRV_TIMI
0293   4133 C3 D7 48    	jp	DRV_VERSION
0294   4136 C3 00 48    	jp	DRV_INIT
0295   4139 C3 DE 48    	jp	DRV_BASSTAT
0296   413C C3 E0 48    	jp	DRV_BASDEV
0297   413F C3 E2 48    	jp	DRV_EXTBIO
0298   4142 C3 E3 48    	jp	DRV_DIRECT0
0299   4145 C3 E3 48    	jp	DRV_DIRECT1
0300   4148 C3 E3 48    	jp	DRV_DIRECT2
0301   414B C3 E3 48    	jp	DRV_DIRECT3
0302   414E C3 E3 48    	jp	DRV_DIRECT4
0303   4151             
0304   4151 00          	ds	15
0305   4160             
0306   4160             	; These routines are mandatory for device-based drivers
0307   4160             
0308   4160 C3 E4 48    	jp	DEV_RW
0309   4163 C3 75 49    	jp	DEV_INFO
0310   4166 C3 F8 49    	jp	DEV_STATUS
0311   4169 C3 2C 4A    	jp	LUN_INFO
0312   416C             
0313   416C             
0314   416C             ;=====
0315   416C             ;=====  END of data that must be at fixed addresses
0316   416C             ;=====
0317   416C             
0318   416C             
0319   416C             ;-----------------------------------------------------------------------------
0320   416C             ;
0321   416C             ; Timer interrupt routine, it will be called on each timer interrupt
0322   416C             ; (at 50 or 60Hz), but only if DRV_INIT returns Cy=1 on its first execution.
0323   416C             
0324   416C             DRV_TIMI: 
0325   416C C9          	ret
0326   416D             
0327   416D             
0328   416D             ; Skips the interface r/w registers 
0329   416D FF          	ds	$4800-$, $FF
0330   4800             
0331   4800             
0332   4800             ;-----------------------------------------------------------------------------
0333   4800             ;
0334   4800             ; Driver initialization routine, it is called twice:
0335   4800             ;
0336   4800             ; 1) First execution, for information gathering.
0337   4800             ;    Input:
0338   4800             ;      A = 0
0339   4800             ;      B = number of available drives
0340   4800             ;      HL = maximum size of allocatable work area in page 3
0341   4800             ;    Output:
0342   4800             ;      A = number of required drives (for drive-based driver only)
0343   4800             ;      HL = size of required work area in page 3
0344   4800             ;      Cy = 1 if DRV_TIMI must be hooked to the timer interrupt, 0 otherwise
0345   4800             ;
0346   4800             ; 2) Second execution, for work area and hardware initialization.
0347   4800             ;    Input:
0348   4800             ;      A = 1
0349   4800             ;      B = number of allocated drives for this controller
0350   4800             ;
0351   4800             ;    The work area address can be obtained by using GWORK.
0352   4800             ;
0353   4800             ;    If first execution requests more work area than available,
0354   4800             ;    second execution will not be done and DRV_TIMI will not be hooked
0355   4800             ;    to the timer interrupt.
0356   4800             ;
0357   4800             ;    If first execution requests more drives than available,
0358   4800             ;    as many drives as possible will be allocated, and the initialization
0359   4800             ;    procedure will continue the normal way
0360   4800             ;    (for drive-based drivers only. Device-based drivers always
0361   4800             ;     get two allocated drives.)
0362   4800             
0363   4800             DRV_INIT: 
0364   4800 B7          	or	a		; Is this the 1st call? 
0365   4801 20 0F       	jr	nz,.call2
0366   4803             ; 1st call:
0367   4803 21 3A 00    	ld	hl,WRKAREA.TRLDIR ; size of work area are needed for Z80
0368   4806 3A 2D 00    	ld	a,(MSXVER)
0369   4809 FE 03       	cp	3		; MSX Turbo-R?
0370   480B 3F          	ccf
0371   480C D0          	ret	nc		; No, return with Cy off
0372   480D 21 42 00    	ld	hl,WRKAREA	; size of work area are needed for TR
0373   4810 B7          	or	a		; Clear Cy
0374   4811 C9          	ret
0375   4812             
0376   4812             
0377   4812             .call2: 
0378   4812             ; 2nd call: 
0379   4812 CD DC 5F    	call	MYSETSCR		; Set the screen mode
0380   4815 CD 72 4A    	call	pegaWorkArea		; HL=IY=Work area pointer
0381   4818             
0382   4818 11 8A 60    	ld	de,strTitle		; prints the title 
0383   481B CD 96 5E    	call	printString
0384   481E             
0385   481E CD B9 48    	call	SDMAPPERINIT		; SD-Mapper exclusive init
0386   4821             
0387   4821             .sdhcinit: 	; FBLabs SDHC Interface initialization
0388   4821 AF          	xor	a			; zera flags do cartao
0389   4822 FD 77 31    	ld	(iy+WRKAREA.CARDFLAGS), a
0390   4825             
0391   4825 3E 01       	ld	a, 1			; detectar cartao 1
0392   4827 CD 43 48    	call	.detecta
0393   482A 3E 02       	ld	a, 2			; detectar cartao 2
0394   482C CD 43 48    	call	.detecta
0395   482F 01 00 00    	ld	bc, 0
0396   4832 1E 05       	ld	e, 5
0397   4834 CD 8E 5E    	call	modoROM
0398   4837             
0399   4837 CD 68 60    	call	INSTR800HLP		; Install R800 data copy on workarea
0400   483A             
0401   483A CD 19 60    	call	INICHKSTOP		; Check if the STOP key was pressed
0402   483D             
0403   483D 11 57 61    	ld	de, strCrLf
0404   4840 C3 96 5E    	jp	printString
0405   4843             
0406   4843             .detecta: 
0407   4843 FD 77 30    	ld	(iy+WRKAREA.NUMSD), a		; processo de deteccao dos cartoes
0408   4846 11 5A 61    	ld	de, strCartao
0409   4849 CD 96 5E    	call	printString
0410   484C FD 7E 30    	ld	a, (iy+WRKAREA.NUMSD)
0411   484F C6 30       	add	'0'
0412   4851 CD A2 00    	call	CHPUT
0413   4854 3E 3A       	ld	a, ':'
0414   4856 CD A2 00    	call	CHPUT
0415   4859 3E 20       	ld	a, ' '
0416   485B CD A2 00    	call	CHPUT
0417   485E FD 4E 30    	ld	c, (iy+WRKAREA.NUMSD)
0418   4861 3A 00 48    	ld	a, (PORTCFG)		; testar se cartao esta inserido
0419   4864 A1          	and	c			; C contem 1 se cartao 1, 2 se cartao 2
0420   4865 28 09       	jr	z,.naoVazio
0421   4867 11 60 61    	ld	de, strVazio		; nao tem cartao no slot
0422   486A CD 96 5E    	call	printString
0423   486D C3 7E 48    	jp	.marcaErro
0424   4870             .naoVazio: 
0425   4870 CD E9 4A    	call	detectaCartao		; tem cartao no slot, inicializar e detectar
0426   4873 30 0C       	jr	nc,.detectou
0427   4875 CD 2A 4C    	call	desabilitaSDs
0428   4878 11 68 61    	ld	de, strNaoIdentificado
0429   487B CD 96 5E    	call	printString
0430   487E             .marcaErro: 
0431   487E C3 B6 4A    	jp	marcaErroCartao		; slot vazio ou erro de deteccao, marcar nas flags
0432   4881             .detectou: 
0433   4881 CD C1 4A    	call	calculaCIDoffset	; calculamos em IX a posicao correta do offset CID dependendo do cartao atual
0434   4884 DD 7E 0F    	ld	a,(ix+15)	; pegar byte SDV1 ou SDV2
0435   4887 11 E9 61    	ld	de, strSDV1	; e imprimir
0436   488A B7          	or	a
0437   488B 28 03       	jr	z,.pula1
0438   488D 11 F1 61    	ld	de, strSDV2
0439   4890             .pula1: 
0440   4890 CD 96 5E    	call	printString
0441   4893 3E 28       	ld	a,'('
0442   4895 CD A2 00    	call	CHPUT
0443   4898 DD 7E 00    	ld	a,(ix)		; pegar byte do fabricante
0444   489B CD E3 5E    	call	printDecToAscii	; Imprimir Manufacturer ID
0445   489E 3E 29       	ld	a,')'
0446   48A0 CD A2 00    	call	CHPUT
0447   48A3 3E 20       	ld	a,' '
0448   48A5 CD A2 00    	call	CHPUT
0449   48A8 DD 7E 00    	ld	a,(ix)		; pegar byte do fabricante
0450   48AB CD 0F 5F    	call	pegaFabricante	; achar nome do fabricante
0451   48AE EB          	ex	de,hl
0452   48AF CD 96 5E    	call	printString	; e imprimir
0453   48B2 11 57 61    	ld	de,strCrLf
0454   48B5 CD 96 5E    	call	printString
0455   48B8 C9          	ret
0456   48B9             
0457   48B9             
0458   48B9             SDMAPPERINIT: 		; This block is exclusive for the SD-Mapper
0459   48B9 11 73 61    	ld	de, strMr_mp_desativada
0460   48BC CD 86 5E    	call	modoSPI
0461   48BF 3A 00 48    	ld	a, (PORTCFG)		; testar se mapper/megaram esta ativa
0462   48C2 E6 10       	and	$10
0463   48C4 28 0E       	jr	z,.print		; desativada, pula
0464   48C6 11 9B 61    	ld	de, strMapper
0465   48C9 3A 00 48    	ld	a, (PORTCFG)		; ativa, testar se eh mapper ou megaram
0466   48CC E6 20       	and	$20
0467   48CE C2 96 5E    	jp	nz,printString
0468   48D1 11 C5 61    	ld	de, strMegaram		; Megaram ativa
0469   48D4             .print: 
0470   48D4 C3 96 5E    	jp	printString
0471   48D7             
0472   48D7             ;-----------------------------------------------------------------------------
0473   48D7             ;
0474   48D7             ; Obtain driver version
0475   48D7             ;
0476   48D7             ; Input:  -
0477   48D7             ; Output: A = Main version number
0478   48D7             ;         B = Secondary version number
0479   48D7             ;         C = Revision number
0480   48D7             
0481   48D7             DRV_VERSION: 
0482   48D7 3E 01       	ld	a, VER_MAIN
0483   48D9 06 00       	ld	b, VER_SEC
0484   48DB 0E 06       	ld	c, VER_REV
0485   48DD C9          	ret
0486   48DE             
0487   48DE             
0488   48DE             ;-----------------------------------------------------------------------------
0489   48DE             ;
0490   48DE             ; BASIC expanded statement ("CALL") handler.
0491   48DE             ; Works the expected way, except that if invoking CALBAS is needed,
0492   48DE             ; it must be done via the CALLB0 routine in kernel page 0.
0493   48DE             
0494   48DE             DRV_BASSTAT: 
0495   48DE 37          	scf
0496   48DF C9          	ret
0497   48E0             
0498   48E0             
0499   48E0             ;-----------------------------------------------------------------------------
0500   48E0             ;
0501   48E0             ; BASIC expanded device handler.
0502   48E0             ; Works the expected way, except that if invoking CALBAS is needed,
0503   48E0             ; it must be done via the CALLB0 routine in kernel page 0.
0504   48E0             
0505   48E0             DRV_BASDEV: 
0506   48E0 37          	scf
0507   48E1 C9          	ret
0508   48E2             
0509   48E2             ;-----------------------------------------------------------------------------
0510   48E2             ;
0511   48E2             ; Extended BIOS hook.
0512   48E2             ; Works the expected way, except that it must return
0513   48E2             ; D'=1 if the old hook must be called, D'=0 otherwise.
0514   48E2             ; It is entered with D'=1.
0515   48E2             
0516   48E2             DRV_EXTBIO: 
0517   48E2 C9          	ret
0518   48E3             
0519   48E3             ;-----------------------------------------------------------------------------
0520   48E3             ;
0521   48E3             ; Direct calls entry points.
0522   48E3             ; Calls to addresses 7850h, 7853h, 7856h, 7859h and 785Ch
0523   48E3             ; in kernel banks 0 and 3 will be redirected
0524   48E3             ; to DIRECT0/1/2/3/4 respectively.
0525   48E3             ; Receives all register data from the caller except IX and AF'.
0526   48E3             
0527   48E3             DRV_DIRECT0: 
0528   48E3             DRV_DIRECT1: 
0529   48E3             DRV_DIRECT2: 
0530   48E3             DRV_DIRECT3: 
0531   48E3             DRV_DIRECT4: 
0532   48E3 C9          	ret
0533   48E4             
0534   48E4             
0535   48E4             ;=====
0536   48E4             ;=====  BEGIN of DEVICE-BASED specific routines
0537   48E4             ;=====
0538   48E4             
0539   48E4             ;-----------------------------------------------------------------------------
0540   48E4             ;
0541   48E4             ; Read or write logical sectors from/to a logical unit
0542   48E4             ;
0543   48E4             ;Input:    Cy=0 to read, 1 to write
0544   48E4             ;          A = Device number, 1 to 7
0545   48E4             ;          B = Number of sectors to read or write
0546   48E4             ;          C = Logical unit number, 1 to 7
0547   48E4             ;          HL = Source or destination memory address for the transfer
0548   48E4             ;          DE = Address where the 4 byte sector number is stored.
0549   48E4             ;Output:   A = Error code (the same codes of MSX-DOS are used):
0550   48E4             ;              0: Ok
0551   48E4             ;              .IDEVL: Invalid device or LUN
0552   48E4             ;              .NRDY: Not ready
0553   48E4             ;              .DISK: General unknown disk error
0554   48E4             ;              .DATA: CRC error when reading
0555   48E4             ;              .RNF: Sector not found
0556   48E4             ;              .UFORM: Unformatted disk
0557   48E4             ;              .WPROT: Write protected media, or read-only logical unit
0558   48E4             ;              .WRERR: Write error
0559   48E4             ;              .NCOMP: Incompatible disk.
0560   48E4             ;              .SEEK: Seek error.
0561   48E4             ;          B = Number of sectors actually read (in case of error only)
0562   48E4             
0563   48E4             DEV_RW: 
0564   48E4 F5          	push	af
0565   48E6 BF FE 03    	cp	a, 3		; somente 2 dispositivos
0566   48E8 30 10       	jr	nc,.saicomerroidl
0567   48EA 0D          	dec	c		; somente 1 logical unit
0568   48EB 20 0D       	jr	nz,.saicomerroidl
0569   48ED E5          	push	hl
0570   48EE CD 8B 4A    	call	testaCartao	; verificar se cartao esta OK
0571   48F1 E1          	pop	hl
0572   48F2 30 0C       	jr	nc,.ok
0573   48F4 F1          	pop	af
0574   48F5 3E FC       	ld	a, ENRDY	; Not ready
0575   48F7             ;	ld	a, EDISK	; General unknown disk error
0576   48F7 06 00       	ld	b, 0
0577   48F9 C9          	ret
0578   48FA             .saicomerroidl: 
0579   48FA F1          	pop	af
0580   48FB 3E B5       	ld	a, EIDEVL	; error: Invalid device or LUN 
0581   48FD 06 00       	ld	b, 0
0582   48FF C9          	ret
0583   4900             .ok: 
0584   4900 FD 70 32    	ld	(iy+WRKAREA.NUMBLOCKS), b	; save the number of blocks to transfer 
0585   4903 D9          	exx
0586   4904 CD C1 4A    	call	calculaCIDoffset	; ix=CID offset 
0587   4907 DD 7E 0F    	ld	a,(ix+15)	; verificar se eh SDV1 ou SDV2
0588   490A DD 6F       	ld	ixl,a		; ixl=SDcard version
0589   490C F1          	pop	af		; a=Device number, f=read/write flag 
0590   490D D9          	exx			; hl=Source/dest Address, de=Pointer to sect#
0591   490E DD 60       	ld	ixh, b 		; ixh=Number of blocks to transfer
0592   4910 38 28       	jr	c,escrita	; Skip if it's a write operation 
0593   4912             leitura: 
0594   4912 1A          	ld	a, (de)		; 1. n. bloco
0595   4913 F5          	push	af
0596   4914 13          	inc	de
0597   4915 1A          	ld	a, (de)		; 2. n. bloco
0598   4916 F5          	push	af
0599   4917 13          	inc	de
0600   4918 1A          	ld	a, (de)		; 3. n. bloco
0601   4919 4F          	ld	c, a
0602   491A 13          	inc	de
0603   491B 1A          	ld	a, (de)		; 4. n. bloco
0604   491C 13          	inc	de
0605   491D 47          	ld	b, a
0606   491E F1          	pop	af
0607   491F 57          	ld	d, a
0608   4920 F1          	pop	af		; HL = ponteiro destino
0609   4921 5F          	ld	e, a		; BC DE = 32 bits numero do bloco
0610   4922 CD 86 5E    	call	modoSPI
0611   4925 CD D6 55    	call	LerBloco	; chamar rotina de leitura de dados
0612   4928 CD 8E 5E    	call	modoROM
0613   492B 30 0B       	jr	nc,.ok
0614   492D CD B6 4A    	call	marcaErroCartao		; ocorreu erro na leitura, marcar erro
0615   4930 FD 7E 32    	ld	a,(iy+WRKAREA.NUMBLOCKS) ; Get the number of requested blocks
0616   4933 DD 94       	sub	ixh		; subtract the number of remaining blocks
0617   4935 47          	ld	b,a		; b=number of blocks read
0618   4936             ;	ld	a, ENRDY	; Not ready
0619   4936 3E FD       	ld	a, EDISK	; General unknown disk error
0620   4938             .ok: 
0621   4938 AF          	xor	a		; tudo OK, informar ao Nextor
0622   4939 C9          	ret
0623   493A             
0624   493A             escrita: 
0625   493A CD 86 5E    	call	modoSPI
0626   493D             	; Test if the card is write protected
0627   493D FD 4E 30    	ld	c,(iy+WRKAREA.NUMSD)	; cartao atual (1 ou 2)
0628   4940 CB 21       	sla	c		; desloca para apontar para bits 2 ou 3 para cartoes 1 ou 2 respectivamente
0629   4942 CB 21       	sla	c
0630   4944 3A 00 48    	ld	a,(PORTCFG)	; testar se cartao esta protegido
0631   4947 A1          	and	c
0632   4948 28 05       	jr	z,.ok
0633   494A 3E F8       	ld	a, EWPROT	; disco protegido
0634   494C 06 00       	ld	b,0		; 0 blocks were written
0635   494E C9          	ret
0636   494F             .ok: 
0637   494F 1A          	ld	a, (de)		; 1. n. bloco
0638   4950 F5          	push	af
0639   4951 13          	inc	de
0640   4952 1A          	ld	a, (de)		; 2. n. bloco
0641   4953 F5          	push	af
0642   4954 13          	inc	de
0643   4955 1A          	ld	a, (de)		; 3. n. bloco
0644   4956 13          	inc	de
0645   4957 4F          	ld	c, a
0646   4958 1A          	ld	a, (de)		; 4. n. bloco
0647   4959 13          	inc	de
0648   495A 47          	ld	b, a
0649   495B F1          	pop	af
0650   495C 57          	ld	d, a
0651   495D F1          	pop	af		; HL = ponteiro destino
0652   495E 5F          	ld	e, a		; BC DE = 32 bits numero do bloco
0653   495F CD D8 4C    	call	GravarBloco	; chamar rotina de gravacao de dados
0654   4962 CD 8E 5E    	call	modoROM
0655   4965 30 0C       	jr	nc,.ok2
0656   4967 CD B6 4A    	call	marcaErroCartao		; ocorreu erro, marcar nas flags
0657   496A FD 7E 32    	ld	a,(iy+WRKAREA.NUMBLOCKS) ; Get the number of requested blocks
0658   496D DD 94       	sub	ixh		; subtract the number of remaining blocks
0659   496F 47          	ld	b,a		; b=number of blocks written
0660   4970 3E FE       	ld	a,EWRERR	; Write error
0661   4972 C9          	ret
0662   4973             .ok2: 
0663   4973 AF          	xor	a			; gravacao sem erros!
0664   4974 C9          	ret
0665   4975             
0666   4975             ;-----------------------------------------------------------------------------
0667   4975             ;
0668   4975             ; Device information gathering
0669   4975             ;
0670   4975             ;Input:   A = Device index, 1 to 7
0671   4975             ;         B = Information to return:
0672   4975             ;             0: Basic information
0673   4975             ;             1: Manufacturer name string
0674   4975             ;             2: Device name string
0675   4975             ;             3: Serial number string
0676   4975             ;         HL = Pointer to a buffer in RAM
0677   4975             ;Output:  A = Error code:
0678   4975             ;             0: Ok
0679   4975             ;             1: Device not available or invalid device index
0680   4975             ;             2: Information not available, or invalid information index
0681   4975             ;         When basic information is requested,
0682   4975             ;         buffer filled with the following information:
0683   4975             ;
0684   4975             ;+0 (1): Numer of logical units, from 1 to 7. 1 if the device has no logical
0685   4975             ;        units (which is functionally equivalent to having only one).
0686   4975             ;+1 (1): Device flags, always zero in Beta 2.
0687   4975             ;
0688   4975             ; The strings must be printable ASCII string (ASCII codes 32 to 126),
0689   4975             ; left justified and padded with spaces. All the strings are optional,
0690   4975             ; if not available, an error must be returned.
0691   4975             ; If a string is provided by the device in binary format, it must be reported
0692   4975             ; as an hexadecimal, upper-cased string, preceded by the prefix "0x".
0693   4975             ; The maximum length for a string is 64 characters;
0694   4975             ; if the string is actually longer, the leftmost 64 characters
0695   4975             ; should be provided.
0696   4975             ;
0697   4975             ; In the case of the serial number string, the same rules for the strings
0698   4975             ; apply, except that it must be provided right-justified,
0699   4975             ; and if it is too long, the rightmost characters must be
0700   4975             ; provided, not the leftmost.
0701   4975             
0702   4975             DEV_INFO: 
0703   4975 04          	inc	b
0704   4977 BF FE 03    	cp	a,3		; somente 2 dispositivos
0705   4979 30 07       	jr	nc,.saicomerro
0706   497B E5          	push	hl
0707   497C CD 8B 4A    	call	testaCartao	; verificar se cartao esta OK
0708   497F E1          	pop	hl
0709   4980 30 03       	jr	nc,.ok		; nao houve erro
0710   4982             .saicomerro: 
0711   4982 3E 02       	ld	a,2		; informar erro
0712   4984 C9          	ret
0713   4985             
0714   4985             .ok: 
0715   4985 10 06       	djnz	.naoBasic
0716   4987             
0717   4987             ; Basic information:
0718   4987 36 01       	ld	(hl), 1		; 1 logical unit somente
0719   4989 23          	inc	hl
0720   498A 36 00       	ld	(hl), 0		; reservado, deve ser 0
0721   498C C9          	ret			; retorna com A=0 (OK)
0722   498D             
0723   498D             .naoBasic: 
0724   498D E5          	push	hl
0725   498E CD C1 4A    	call	calculaCIDoffset	; calculamos em IX a posicao correta do offset CID dependendo do cartao atual
0726   4991 E1          	pop	hl
0727   4992             
0728   4992 10 25       	djnz	.naoManuf
0729   4994             ; Manufacturer Name:
0730   4994 E5          	push	hl		; salva ponteiro do buffer
0731   4995 06 40       	ld	b, 64		; preenche buffer com espaco
0732   4997 3E 20       	ld	a, ' '
0733   4999             .loop1: 
0734   4999 77          	ld	(hl), a
0735   499A 23          	inc	hl
0736   499B 10 FC       	djnz	.loop1
0737   499D D1          	pop	de		; recuperamos ponteiro do buffer em DE
0738   499E 3E 28       	ld	a, '('		; colocamos (xx) xxx no buffer
0739   49A0 12          	ld	(de), a
0740   49A1 13          	inc	de
0741   49A2 DD 7E 00    	ld	a, (ix)		; byte do fabricante
0742   49A5 CD 9F 5E    	call	DecToAscii
0743   49A8 3E 29       	ld	a, ')'
0744   49AA 12          	ld	(de), a
0745   49AB 13          	inc	de
0746   49AC 3E 20       	ld	a, ' '
0747   49AE 12          	ld	(de), a
0748   49AF 13          	inc	de
0749   49B0 DD 7E 00    	ld	a, (ix)		; byte do fabricante
0750   49B3 CD 0F 5F    	call	pegaFabricante	; pegar nome do fabricante em HL
0751   49B6 ED B0       	ldir			; e colocar no buffer
0752   49B8 C9          	ret
0753   49B9             
0754   49B9             .naoManuf: 
0755   49B9 10 1A       	djnz	.naoProduct
0756   49BB             ; Product Name:
0757   49BB E5          	push	hl		; guarda HL que aponta para buffer do Nextor
0758   49BC DD E5       	push	ix
0759   49BE E1          	pop	hl		; joga IX para HL
0760   49BF 16 00       	ld	d, 0
0761   49C1 1E 03       	ld	e, 3		; adiciona offset do productname em HL
0762   49C3 19          	add	hl, de
0763   49C4 D1          	pop	de		; recupera buffer do Nextor em DE
0764   49C5 01 05 00    	ld	bc, 5		; 5 caracteres
0765   49C8 ED B0       	ldir			; copia nome do produto
0766   49CA EB          	ex	de,hl		; troca DE com HL, agora HL aponta para Buffer do nextor atualizado
0767   49CB 06 3B       	ld	b, 59		; Coloca espaco no restante do buffer
0768   49CD 3E 20       	ld	a, ' '
0769   49CF             .loop2: 
0770   49CF 77          	ld	(hl), a
0771   49D0 23          	inc	hl
0772   49D1 10 FC       	djnz	.loop2
0773   49D3 AF          	xor	a		; informar sem erros
0774   49D4 C9          	ret
0775   49D5             
0776   49D5             .naoProduct: 
0777   49D5             ; Serial Number:
0778   49D5 36 30       	ld	(hl),'0'	; Coloca prefixo "0x"
0779   49D7 23          	inc	hl
0780   49D8 36 78       	ld	(hl), 'x'
0781   49DA 23          	inc	hl
0782   49DB E5          	push	hl		; guarda HL que aponta para buffer do Nextor
0783   49DC DD E5       	push	ix
0784   49DE E1          	pop	hl		; joga IX para HL
0785   49DF 16 00       	ld	d, 0
0786   49E1 1E 09       	ld	e, 9		; adiciona offset do productname em HL
0787   49E3 19          	add	hl, de
0788   49E4 D1          	pop	de		; recupera buffer do nextor em DE
0789   49E5 06 04       	ld	b, 4		; 4 bytes do serial
0790   49E7             .loop3: 
0791   49E7 7E          	ld	a, (hl)
0792   49E8 CD CF 5E    	call	HexToAscii	; converter HEXA para ASCII
0793   49EB 23          	inc	hl
0794   49EC 10 F9       	djnz	.loop3
0795   49EE 06 36       	ld	b, 54		; Coloca espaco no restante
0796   49F0 3E 20       	ld	a, ' '
0797   49F2             .loop4: 
0798   49F2 12          	ld	(de), a
0799   49F3 13          	inc	de
0800   49F4 10 FC       	djnz	.loop4
0801   49F6 AF          	xor	a		; informar sem erros
0802   49F7 C9          	ret
0803   49F8             
0804   49F8             ;-----------------------------------------------------------------------------
0805   49F8             ;
0806   49F8             ; Obtain device status
0807   49F8             ;
0808   49F8             ;Input:   A = Device index, 1 to 7
0809   49F8             ;         B = Logical unit number, 1 to 7
0810   49F8             ;             0 to return the status of the device itself.
0811   49F8             ;Output:  A = Status for the specified logical unit,
0812   49F8             ;             or for the whole device if 0 was specified:
0813   49F8             ;                0: The device or logical unit is not available, or the
0814   49F8             ;                   device or logical unit number supplied is invalid.
0815   49F8             ;                1: The device or logical unit is available and has not
0816   49F8             ;                   changed since the last status request.
0817   49F8             ;                2: The device or logical unit is available and has changed
0818   49F8             ;                   since the last status request
0819   49F8             ;                   (for devices, the device has been unplugged and a
0820   49F8             ;                    different device has been plugged which has been
0821   49F8             ;                    assigned the same device index; for logical units,
0822   49F8             ;                    the media has been changed).
0823   49F8             ;                3: The device or logical unit is available, but it is not
0824   49F8             ;                   possible to determine whether it has been changed
0825   49F8             ;                   or not since the last status request.
0826   49F8             ;
0827   49F8             ; Devices not supporting hot-plugging must always return status value 1.
0828   49F8             ; Non removable logical units may return values 0 and 1.
0829   49F8             ;
0830   49F8             ; The returned status is always relative to the previous invokation of
0831   49F8             ; DEV_STATUS itself. Please read the Driver Developer Guide for more info.
0832   49F8             
0833   49F8             DEV_STATUS: 
0834   49F9 BF FE 03    	cp	a,3		; 2 dispositivos somente
0835   49FB 30 2C       	jr	nc,.saicomerro
0836   49FD 05          	dec	b		; 1 logical unit somente
0837   49FE 20 29       	jr	nz,.saicomerro
0838   4A00 F5          	push	af
0839   4A01 CD 72 4A    	call	pegaWorkArea	; HL=IY=Work area pointer
0840   4A04 F1          	pop	af
0841   4A05 FD 77 30    	ld	(iy+WRKAREA.NUMSD),a	; salva numero do device atual (1 ou 2)
0842   4A08 4F          	ld	c,a		; c=device number
0843   4A09 CD 86 5E    	call	modoSPI
0844   4A0C 3A 00 48    	ld	a, (PORTCFG)	; testar se cartao esta inserido
0845   4A0F CD 8E 5E    	call	modoROM
0846   4A12 A1          	and	c		; C contem 1 se cartao 1, 2 se cartao 2
0847   4A13 20 11       	jr	nz,.cartaoAusente	; se slot do cartao estiver vazio, marcamos o erro nas flags
0848   4A15             	;***FixMe: Disk change detection doesn't work
0849   4A15             	; Will have to check both the hardware disk-change and the software
0850   4A15             	; disk-change reported by LUN_NFO
0851   4A15 CD 86 5E    	call	modoSPI
0852   4A18 CD E9 4A    	call	detectaCartao	; erro na deteccao do cartao, tentar re-detectar
0853   4A1B CD 8E 5E    	call	modoROM
0854   4A1E 38 06       	jr	c,.cartaoComErro	; nao conseguimos detectar, sai com erro
0855   4A20             
0856   4A20             .semMudanca: 
0857   4A20 3E 01       	ld	a, 1		; informa ao Nextor que cartao esta OK e nao mudou
0858   4A22 C9          	ret
0859   4A23             .comMudanca: 
0860   4A23 3E 02       	ld	a, 2		; informa ao Nextor que cartao esta OK e mudou
0861   4A25 C9          	ret
0862   4A26             .cartaoComErro: 
0863   4A26             .cartaoAusente: 
0864   4A26 CD B6 4A    	call	marcaErroCartao	; marcar erro do cartao nas flags
0865   4A29             .saicomerro: 
0866   4A29 3E 00       	ld	a, 0		; informa erro
0867   4A2B C9          	ret
0868   4A2C             
0869   4A2C             ;-----------------------------------------------------------------------------
0870   4A2C             ;
0871   4A2C             ; Obtain logical unit information
0872   4A2C             ;
0873   4A2C             ;Input:   A  = Device index, 1 to 7
0874   4A2C             ;         B  = Logical unit number, 1 to 7
0875   4A2C             ;         HL = Pointer to buffer in RAM.
0876   4A2C             ;Output:  A = 0: Ok, buffer filled with information.
0877   4A2C             ;             1: Error, device or logical unit not available,
0878   4A2C             ;                or device index or logical unit number invalid.
0879   4A2C             ;         On success, buffer filled with the following information:
0880   4A2C             ;
0881   4A2C             ;+0 (1): Medium type:
0882   4A2C             ;        0: Block device
0883   4A2C             ;        1: CD or DVD reader or recorder
0884   4A2C             ;        2-254: Unused. Additional codes may be defined in the future.
0885   4A2C             ;        255: Other
0886   4A2C             ;+1 (2): Sector size, 0 if this information does not apply or is
0887   4A2C             ;        not available.
0888   4A2C             ;+3 (4): Total number of available sectors.
0889   4A2C             ;        0 if this information does not apply or is not available.
0890   4A2C             ;+7 (1): Flags:
0891   4A2C             ;        bit 0: 1 if the medium is removable.
0892   4A2C             ;        bit 1: 1 if the medium is read only. A medium that can dinamically
0893   4A2C             ;               be write protected or write enabled is not considered
0894   4A2C             ;               to be read-only.
0895   4A2C             ;        bit 2: 1 if the LUN is a floppy disk drive.
0896   4A2C             ;+8 (2): Number of cylinders
0897   4A2C             ;+10 (1): Number of heads
0898   4A2C             ;+11 (1): Number of sectors per track
0899   4A2C             ;
0900   4A2C             ; Number of cylinders, heads and sectors apply to hard disks only.
0901   4A2C             ; For other types of device, these fields must be zero.
0902   4A2C             
0903   4A2C             LUN_INFO: 
0904   4A2D BF FE 03    	cp	a, 3		; somente 2 dispositivo
0905   4A2F 30 0A       	jr	nc,.saicomerro
0906   4A31 05          	dec	b		; somente 1 logical unit
0907   4A32 20 07       	jr	nz,.saicomerro
0908   4A34 E5          	push	hl
0909   4A35 CD 8B 4A    	call	testaCartao
0910   4A38 E1          	pop	hl
0911   4A39 30 03       	jr	nc,.ok		; nao tem erro com o cartao
0912   4A3B             .saicomerro: 
0913   4A3B 3E 01       	ld	a, 1		; informar erro
0914   4A3D C9          	ret
0915   4A3E             .ok: 
0916   4A3E D9          	exx	
0917   4A3F             	; ***FixMe: Will have to check disk-change, and daisy chain this as a
0918   4A3F             	; software flag so DEV_STATUS can also be notified
0919   4A3F CD 86 5E    	call	modoSPI
0920   4A42 CD E9 4A    	call	detectaCartao	; erro na deteccao do cartao, tentar re-detectar
0921   4A45 CD 8E 5E    	call	modoROM
0922   4A48 38 F1       	jr	c,.saicomerro
0923   4A4A CD D5 4A    	call	calculaBLOCOSoffset	; calcular em IX e HL o offset correto do buffer que armazena total de blocos
0924   4A4D D9          	exx			; do cartao dependendo do cartao atual solicitado
0925   4A4E AF          	xor	a
0926   4A4F 77          	ld	(hl),a		; Informar que o dispositivo eh do tipo block device
0927   4A50 23          	inc	hl
0928   4A51 77          	ld	(hl),a		; block size: 512 bytes (0200h)
0929   4A52 23          	inc	hl
0930   4A53 36 02       	ld	(hl),2
0931   4A55 23          	inc	hl
0932   4A56 DD 7E 00    	ld	a, (ix)		; copia numero de blocos total
0933   4A59 77          	ld	(hl), a
0934   4A5A 23          	inc	hl
0935   4A5B DD 7E 01    	ld	a, (ix+1)
0936   4A5E 77          	ld	(hl), a
0937   4A5F 23          	inc	hl
0938   4A60 DD 7E 02    	ld	a, (ix+2)
0939   4A63 77          	ld	(hl), a
0940   4A64 23          	inc	hl
0941   4A65 36 00       	ld	(hl),0		; The highest byte must be set to 0, as SDcards
0942   4A67             				; have 24bit total block numbers, and Nextor
0943   4A67             				; requires 32bits. 
0944   4A67 23          	inc	hl
0945   4A68 36 01       	ld	(hl),1		; flags: dispositivo R/W removivel
0946   4A6A 23          	inc	hl
0947   4A6B AF          	xor	a		; CHS = 0
0948   4A6C 77          	ld	(hl), a
0949   4A6D 23          	inc	hl
0950   4A6E 77          	ld	(hl), a
0951   4A6F 23          	inc	hl
0952   4A70 77          	ld	(hl), a
0953   4A71             ;	xor	a		; informar que dados foram preenchidos
0954   4A71 C9          	ret
0955   4A72             
0956   4A72             ;=====
0957   4A72             ;=====  END of DEVICE-BASED specific routines
0958   4A72             ;=====
0959   4A72             
0960   4A72             ;------------------------------------------------
0961   4A72             ; Rotinas auxiliares
0962   4A72             ;------------------------------------------------
0963   4A72             
0964   4A72             ;------------------------------------------------
0965   4A72             ; Pedir ao Nextor o ponteiro de dados de trabalho
0966   4A72             ; na RAM e colocar em HL e IY
0967   4A72             ; Destroi HL e IY
0968   4A72             ;------------------------------------------------
0969   4A72             pegaWorkArea: 
0970   4A72 F5          	push	af
0971   4A73 AF          	xor	a		; Pegar endereco da area de trabalho
0972   4A74 08          	ex	af,af'
0973   4A75 AF          	xor	a
0974   4A76 DD 21 45 40 	ld	ix, GWORK
0975   4A7A CD 8E 5E    	call	modoROM
0976   4A7D CD 42 40    	call	CALBNK
0977   4A80 DD 6E 00    	ld	l,(ix)		; em HL tem o ponteiro da nossa area da RAM
0978   4A83 DD 66 01    	ld	h,(ix+1)
0979   4A86 E5          	push	hl
0980   4A87 FD E1       	pop	iy		; em IY temos o mesmo ponteiro
0981   4A89 F1          	pop	af
0982   4A8A C9          	ret
0983   4A8B             
0984   4A8B             ;------------------------------------------------
0985   4A8B             ; Testa se cartao esta inserido e/ou houve erro
0986   4A8B             ; na ultima vez que foi acessado. Carry indica
0987   4A8B             ; erro
0988   4A8B             ; Destroi AF, HL, IX, C
0989   4A8B             ;------------------------------------------------
0990   4A8B             testaCartao: 
0991   4A8B F5          	push	af
0992   4A8C CD 72 4A    	call	pegaWorkArea	; HL=IY=Work area pointer
0993   4A8F F1          	pop	af
0994   4A90 FD 77 30    	ld	(iy+WRKAREA.NUMSD), a	; salva numero do device atual (1 ou 2)
0995   4A93 4F          	ld	c, a
0996   4A94 CD 86 5E    	call	modoSPI
0997   4A97 3A 00 48    	ld	a, (PORTCFG)	; testar se cartao esta inserido
0998   4A9A CD 8E 5E    	call	modoROM
0999   4A9D A1          	and	c		; C contem 1 se cartao 1, 2 se cartao 2
1000   4A9E 20 0D       	jr	nz,.saicomerro				
1001   4AA0 FD 7E 30    	ld	a, (iy+WRKAREA.NUMSD)		; conseguimos detectar, tira erro nas flags
1002   4AA3 2F          	cpl			; inverte bits para fazer o AND
1003   4AA4 4F          	ld	c, a
1004   4AA5 FD 7E 31    	ld	a, (iy+WRKAREA.CARDFLAGS)
1005   4AA8 A1          	and	c			; limpa bit
1006   4AA9 FD 77 31    	ld	(iy+WRKAREA.CARDFLAGS), a
1007   4AAC C9          	ret
1008   4AAD             .saicomerro: 
1009   4AAD FD 7E 31    	ld	a, (iy+WRKAREA.CARDFLAGS)	; marca bit de erro nas flags
1010   4AB0 B1          	or	c
1011   4AB1 FD 77 31    	ld	(iy+WRKAREA.CARDFLAGS), a
1012   4AB4 37          	scf
1013   4AB5 C9          	ret
1014   4AB6             
1015   4AB6             ;------------------------------------------------
1016   4AB6             ; Marcar bit de erro nas flags
1017   4AB6             ; Destroi AF, C
1018   4AB6             ;------------------------------------------------
1019   4AB6             marcaErroCartao: 
1020   4AB6 FD 4E 30    	ld	c, (iy+WRKAREA.NUMSD)		; cartao atual (1 ou 2)
1021   4AB9 FD 7E 31    	ld	a, (iy+WRKAREA.CARDFLAGS)	; marcar erro
1022   4ABC B1          	or	c
1023   4ABD FD 77 31    	ld	(iy+WRKAREA.CARDFLAGS), a
1024   4AC0 C9          	ret
1025   4AC1             
1026   4AC1             ;------------------------------------------------
1027   4AC1             ; Calcula offset do buffer na RAM em HL e IX para
1028   4AC1             ; os dados do CID dependendo do tipo do cartao atual
1029   4AC1             ; Destroi AF, DE, HL e IX
1030   4AC1             ;------------------------------------------------
1031   4AC1             calculaCIDoffset: 
1032   4AC1 FD E5       	push	iy		; copiamos IY para HL
1033   4AC3 E1          	pop	hl
1034   4AC4 16 00       	ld	d, 0
1035   4AC6 1E 10       	ld	e, WRKAREA.BCID1	; DE aponta para buffer BCID1
1036   4AC8 FD 7E 30    	ld	a, (iy+WRKAREA.NUMSD)	; vamos fazer IX apontar para o buffer correto
1037   4ACB 3D          	dec	a		; dependendo do cartao: BCID1 ou BCID2
1038   4ACC 28 02       	jr	z,.c1
1039   4ACE 1E 20       	ld	e, WRKAREA.BCID2	; DE aponta para buffer BCID2
1040   4AD0             .c1: 
1041   4AD0 19          	add	hl, de		; HL aponta para buffer correto
1042   4AD1 E5          	push	hl		
1043   4AD2 DD E1       	pop	ix		; vamos colocar HL em IX
1044   4AD4 C9          	ret
1045   4AD5             
1046   4AD5             ;------------------------------------------------
1047   4AD5             ; Calcula offset do buffer na RAM para os dados
1048   4AD5             ; do total de blocos dependendo do cartao atual
1049   4AD5             ; Offset fica em HL e IX
1050   4AD5             ; Destroi AF, DE, HL e IX
1051   4AD5             ;------------------------------------------------
1052   4AD5             calculaBLOCOSoffset: 
1053   4AD5 FD E5       	push	iy		; copiamos IY para HL
1054   4AD7 E1          	pop	hl
1055   4AD8 16 00       	ld	d, 0
1056   4ADA 1E 33       	ld	e, WRKAREA.BLOCKS1	; DE aponta para buffer BLOCKS1
1057   4ADC FD 7E 30    	ld	a, (iy+WRKAREA.NUMSD)	; Vamos fazer IX apontar para o buffer correto
1058   4ADF 3D          	dec	a		; dependendo do cartao: BLOCKS1 ou BLOCKS2
1059   4AE0 28 02       	jr	z,.c1
1060   4AE2 1E 36       	ld	e, WRKAREA.BLOCKS2	; DE aponta para buffer BLOCKS2
1061   4AE4             .c1: 
1062   4AE4 19          	add	hl, de		; HL aponta para buffer correto
1063   4AE5 E5          	push	hl		
1064   4AE6 DD E1       	pop	ix		; Vamos colocar HL em IX
1065   4AE8 C9          	ret
1066   4AE9             
1067   4AE9             
1068   4AE9             ;------------------------------------------------
1069   4AE9             ; Minhas funcoes para cartao SD
1070   4AE9             ;------------------------------------------------
1071   4AE9             
1072   4AE9             ;------------------------------------------------
1073   4AE9             ; Processo de inicializacao e deteccao do cartao.
1074   4AE9             ; Detecta se cartao responde, qual versao (SDV1
1075   4AE9             ; ou SDV2), faz a leitura do CSD e CID e calcula
1076   4AE9             ; o numero de blocos do cartao, colocando o CID
1077   4AE9             ; e total de blocos no buffer correto dependendo
1078   4AE9             ; do cartao 1 ou 2.
1079   4AE9             ; Retorna erro no carry. Se for 0 indica deteccao
1080   4AE9             ; com sucesso.
1081   4AE9             ; Destroi todos os registradores
1082   4AE9             ;------------------------------------------------
1083   4AE9             detectaCartao: 
1084   4AE9 CD 0B 4C    	call	iniciaSD	; manda pulsos de clock e comandos iniciais
1085   4AEC D8          	ret	c			; retorna se erro
1086   4AED CD B8 4B    	call	testaSDCV2	; tenta inicializar um cartao SDV2
1087   4AF0 D8          	ret	c
1088   4AF1 FD E5       	push	iy		; colocar em HL buffer da RAM de trabalho
1089   4AF3 E1          	pop	hl		; CSD esta no offset 0, nao precisamos somar
1090   4AF4 3E 49       	ld	a, CMD9		; ler CSD
1091   4AF6 CD D9 4B    	call	lerBlocoCxD
1092   4AF9 D8          	ret	c
1093   4AFA CD C1 4A    	call	calculaCIDoffset	; calculamos em IX e HL a posicao correta do offset CID dependendo do cartao atual
1094   4AFD 3E 4A       	ld	a, CMD10	; ler CID
1095   4AFF CD D9 4B    	call	lerBlocoCxD
1096   4B02 D8          	ret	c
1097   4B03 3E 7A       	ld	a, CMD58	; ler OCR
1098   4B05 11 00 00    	ld	de, 0
1099   4B08 CD 5C 4C    	call	SD_SEND_CMD_2_ARGS_GET_R3	; enviar comando e receber resposta tipo R3
1100   4B0B D8          	ret	c
1101   4B0C 78          	ld	a, b		; testa bit CCS do OCR que informa se cartao eh SDV1 ou SDV2
1102   4B0D E6 40       	and	$40
1103   4B0F DD 77 0F    	ld	(ix+15), a	; salva informacao da versao do SD (V1 ou V2) no byte 15 do CID
1104   4B12 CC AD 4B    	call	z,mudarTamanhoBlocoPara512	; se bit CCS do OCR for 1, eh cartao SDV2 (Block address - SDHC ou SDXD)
1105   4B15 D8          	ret	c		; e nao precisamos mudar tamanho do bloco para 512
1106   4B16 CD 2A 4C    	call	desabilitaSDs
1107   4B19             				; agora vamos calcular o total de blocos dependendo dos dados do CSD
1108   4B19 CD D5 4A    	call	calculaBLOCOSoffset	; calcular em IX e HL o offset correto do buffer que armazena total de blocos
1109   4B1C FD E5       	push	iy		; copiamos IY para HL
1110   4B1E E1          	pop	hl
1111   4B1F 16 00       	ld	d, 0
1112   4B21 1E 05       	ld	e, WRKAREA.BCSD+5
1113   4B23 19          	add	hl, de		; HL aponta para buffer BCSD+5
1114   4B24 FD 7E 00    	ld	a, (iy+WRKAREA.BCSD)
1115   4B27 E6 C0       	and	$C0		; testa versao do registro CSD
1116   4B29 28 06       	jr	z,.calculaCSD1
1117   4B2B FE 40       	cp	$40
1118   4B2D 28 54       	jr	z,.calculaCSD2
1119   4B2F 37          	scf			; versao do registro CSD nao reconhecida, informa erro na deteccao
1120   4B30 C9          	ret
1121   4B31             
1122   4B31             ; -----------------------------------
1123   4B31             ; Registro CSD versao 1, calcular da
1124   4B31             ; maneira correta para a versao 1
1125   4B31             ; -----------------------------------
1126   4B31             .calculaCSD1: 
1127   4B31 7E          	ld	a, (hl)
1128   4B32 E6 0F       	and	$0F		; isola READ_BL_LEN
1129   4B34 F5          	push	af
1130   4B35 23          	inc	hl
1131   4B36 7E          	ld	a, (hl)		; 2 primeiros bits de C_SIZE
1132   4B37 E6 03       	and	3
1133   4B39 57          	ld	d, a
1134   4B3A 23          	inc	hl
1135   4B3B 5E          	ld	e, (hl)		; 8 bits de C_SIZE (DE contem os primeiros 10 bits de C_SIZE)
1136   4B3C 23          	inc	hl
1137   4B3D 7E          	ld	a, (hl)
1138   4B3E E6 C0       	and	$C0		; 2 ultimos bits de C_SIZE
1139   4B40 87          	add	a, a		; rotaciona a esquerda
1140   4B41 CB 13       	rl	e		; rotaciona para DE
1141   4B43 CB 12       	rl	d
1142   4B45 87          	add	a, a		; mais uma rotacao
1143   4B46 CB 13       	rl	e		; rotaciona para DE
1144   4B48 CB 12       	rl	d
1145   4B4A 13          	inc	de		; agora DE contem todos os 12 bits de C_SIZE, incrementa 1
1146   4B4B 23          	inc	hl
1147   4B4C 7E          	ld	a, (hl)		; proximo byte
1148   4B4D E6 03       	and	3		; 2 bits de C_SIZE_MUL
1149   4B4F 47          	ld	b, a		; B contem os 2 bits de C_SIZE_MUL
1150   4B50 23          	inc	hl						
1151   4B51 7E          	ld	a, (hl)		; proximo byte
1152   4B52 E6 80       	and	$80		; 1 bit de C_SIZE_MUL
1153   4B54 87          	add	a, a		; rotaciona para esquerda jogando no carry
1154   4B55 CB 10       	rl	b		; rotaciona para B
1155   4B57 04          	inc	b		; agora B contem os 3 bits de C_SIZE_MUL
1156   4B58 04          	inc	b		; faz B = C_SIZE_MUL + 2
1157   4B59 F1          	pop	af		; volta em A o READ_BL_LEN
1158   4B5A 80          	add	a, b		; A = READ_BL_LEN + (C_SIZE_MUL+2)
1159   4B5B 01 00 00    	ld	bc, 0
1160   4B5E CD 77 4B    	call	.eleva2
1161   4B61 5A          	ld	e, d		; aqui temos 32 bits (BC DE) com o tamanho do cartao
1162   4B62 51          	ld	d, c		; ignoramos os 8 ultimos bits em E, fazemos BC DE => 0B CD (divide por 256)
1163   4B63 48          	ld	c, b
1164   4B64 06 00       	ld	b, 0
1165   4B66 CB 39       	srl	c		; rotacionamos a direita o C, carry = LSB (divide por 2)
1166   4B68 CB 1A       	rr	d		; rotacionamos D e E
1167   4B6A CB 1B       	rr	e		; no final BC DE contem tamanho do cartao / 512 = numero de blocos
1168   4B6C             .salvaBlocos: 
1169   4B6C DD 71 02    	ld	(ix+2), c	; colocar no buffer BLOCOS correto a quantidade de blocos
1170   4B6F DD 72 01    	ld	(ix+1), d	; que o cartao (1 ou 2) tem
1171   4B72 DD 73 00    	ld	(ix), e
1172   4B75 AF          	xor	a		; limpa carry
1173   4B76 C9          	ret
1174   4B77             
1175   4B77             .eleva2: 			; aqui temos: A = (READ_BL_LEN + (C_SIZE_MUL+2))
1176   4B77             				; BC = 0
1177   4B77             				; DE = C_SIZE
1178   4B77 CB 23       	sla	e		; rotacionamos C_SIZE por 'A' vezes
1179   4B79 CB 12       	rl	d
1180   4B7B CB 11       	rl	c
1181   4B7D CB 10       	rl	b
1182   4B7F 3D          	dec	a		; subtraimos 1
1183   4B80 20 F5       	jr	nz,.eleva2
1184   4B82 C9          	ret			; em BC DE temos o tamanho do cartao (bytes) em 32 bits
1185   4B83             
1186   4B83             ; -----------------------------------
1187   4B83             ; Registro CSD versao 2, calcular da
1188   4B83             ; maneira correta para a versao 2
1189   4B83             ; -----------------------------------
1190   4B83             .calculaCSD2: 
1191   4B83 23          	inc	hl		; HL ja aponta para BCSD+5, fazer HL apontar para BCSD+7
1192   4B84 23          	inc	hl
1193   4B85 7E          	ld	a, (hl)
1194   4B86 E6 3F       	and	$3F
1195   4B88 4F          	ld	c, a
1196   4B89 23          	inc	hl
1197   4B8A 56          	ld	d, (hl)
1198   4B8B 23          	inc	hl
1199   4B8C 5E          	ld	e, (hl)
1200   4B8D CD 99 4B    	call	.inc32		; soma 1
1201   4B90 CD A1 4B    	call	.desloca32	; multiplica por 512
1202   4B93 CD A6 4B    	call	.rotaciona24	; multiplica por 2
1203   4B96 C3 6C 4B    	jp		.salvaBlocos
1204   4B99             
1205   4B99             .inc32: 
1206   4B99 1C          	inc	e
1207   4B9A C0          	ret	nz
1208   4B9B 14          	inc	d
1209   4B9C C0          	ret	nz
1210   4B9D 0C          	inc	c
1211   4B9E C0          	ret	nz
1212   4B9F 04          	inc	b
1213   4BA0 C9          	ret
1214   4BA1             
1215   4BA1             .desloca32: 
1216   4BA1 41          	ld	b, c
1217   4BA2 4A          	ld	c, d
1218   4BA3 53          	ld	d, e
1219   4BA4 1E 00       	ld	e, 0
1220   4BA6             .rotaciona24: 
1221   4BA6 CB 22       	sla	d
1222   4BA8 CB 11       	rl	c
1223   4BAA CB 10       	rl	b
1224   4BAC C9          	ret
1225   4BAD             
1226   4BAD             ; ------------------------------------------------
1227   4BAD             ; Setar o tamanho do bloco para 512 se o cartao
1228   4BAD             ; for SDV1
1229   4BAD             ; ------------------------------------------------
1230   4BAD             mudarTamanhoBlocoPara512: 
1231   4BAD 3E 50       	ld	a, CMD16
1232   4BAF 01 00 00    	ld	bc, 0
1233   4BB2 11 00 02    	ld	de, 512
1234   4BB5 C3 47 4C    	jp	SD_SEND_CMD_GET_ERROR
1235   4BB8             
1236   4BB8             ; ------------------------------------------------
1237   4BB8             ; Tenta inicializar um cartao SDV2, se houver erro
1238   4BB8             ; o cartao deve ser SDV1
1239   4BB8             ; ------------------------------------------------
1240   4BB8             testaSDCV2: 
1241   4BB8 3E 48       	ld	a, CMD8
1242   4BBA 11 AA 01    	ld	de, $1AA
1243   4BBD CD 5C 4C    	call	SD_SEND_CMD_2_ARGS_GET_R3
1244   4BC0 21 40 4C    	ld	hl, SD_SEND_CMD1	; HL aponta para rotina correta
1245   4BC3 38 03       	jr	c,.pula		; cartao recusou CMD8, enviar comando CMD1
1246   4BC5 21 32 4C    	ld	hl, SD_SEND_ACMD41	; cartao aceitou CMD8, enviar comando ACMD41
1247   4BC8             .pula: 
1248   4BC8 01 14 00    	ld	bc, 20		; B = 0, C = 20: 5120 tentativas
1249   4BCB             .loop: 
1250   4BCB C5          	push	bc
1251   4BCC CD D8 4B    	call	.jumpHL		; chamar rotina correta em HL
1252   4BCF C1          	pop	bc
1253   4BD0 D0          	ret	nc
1254   4BD1 10 F8       	djnz	.loop
1255   4BD3 0D          	dec	c
1256   4BD4 20 F5       	jr	nz,.loop
1257   4BD6 37          	scf
1258   4BD7 C9          	ret
1259   4BD8             .jumpHL: 
1260   4BD8 E9          	jp	(hl)		; chamar rotina correta em HL
1261   4BD9             
1262   4BD9             ; ------------------------------------------------
1263   4BD9             ; Ler registro CID ou CSD, o comando vem em A
1264   4BD9             ; ------------------------------------------------
1265   4BD9             lerBlocoCxD: 
1266   4BD9 CD 42 4C    	call	SD_SEND_CMD_NO_ARGS
1267   4BDC D8          	ret	c
1268   4BDD CD B0 4C    	call	WAIT_RESP_FE
1269   4BE0 D8          	ret	c
1270   4BE1 EB          	ex	de,hl
1271   4BE2             
1272   4BE2 21 00 40    	ld	hl, PORTSPI
1273   4BE5 ED A0       > ldi		
1273   4BE7 ED A0       > ldi		
1273   4BE9 ED A0       > ldi		
1273   4BEB ED A0       > ldi		
1273   4BED ED A0       > ldi		
1273   4BEF ED A0       > ldi		
1273   4BF1 ED A0       > ldi		
1273   4BF3 ED A0       > ldi		
1273   4BF5 ED A0       > ldi		
1273   4BF7 ED A0       > ldi		
1273   4BF9 ED A0       > ldi		
1273   4BFB ED A0       > ldi		
1273   4BFD ED A0       > ldi		
1273   4BFF ED A0       > ldi		
1273   4C01 ED A0       > ldi		
1273   4C03 ED A0       > ldi		
1274   4C05 7E          	ld	a, (hl)
1275   4C06 7E          	ld	a, (hl)		; byte de resposta
1276   4C07 B7          	or	a
1277   4C08 EB          	ex	de,hl
1278   4C09 18 1F       	jr	desabilitaSDs
1279   4C0B             
1280   4C0B             ; ------------------------------------------------
1281   4C0B             ; Algoritmo para inicializar um cartao SD
1282   4C0B             ; Destroi AF, B, DE
1283   4C0B             ; ------------------------------------------------
1284   4C0B             iniciaSD: 
1285   4C0B CD 2A 4C    	call	desabilitaSDs
1286   4C0E             
1287   4C0E 06 0A       	ld	b, 10		; enviar 80 pulsos de clock com cartao desabilitado
1288   4C10             enviaClocksInicio: 
1289   4C10 3E FF       	ld	a, $FF		; manter MOSI em 1
1290   4C12 32 00 40    	ld	(PORTSPI), a
1291   4C15 10 F9       	djnz	enviaClocksInicio
1292   4C17 CD CD 4C    	call	setaSDAtual	; ativar cartao atual
1293   4C1A 06 08       	ld	b, 8		; 8 tentativas para CMD0
1294   4C1C             SD_SEND_CMD0: 
1295   4C1C 3E 40       	ld	a, CMD0		; primeiro comando: CMD0
1296   4C1E 11 00 00    	ld	de, 0
1297   4C21 C5          	push	bc
1298   4C22 CD 4F 4C    	call	SD_SEND_CMD_2_ARGS_TEST_BUSY
1299   4C25 C1          	pop	bc
1300   4C26 D0          	ret	nc			; retorna se cartao respondeu ao CMD0
1301   4C27 10 F3       	djnz	SD_SEND_CMD0
1302   4C29 37          	scf			; cartao nao respondeu ao CMD0, informar erro
1303   4C2A             	; fall throw
1304   4C2A             
1305   4C2A             ; ------------------------------------------------
1306   4C2A             ; Desabilitar (de-selecionar) todos os cartoes
1307   4C2A             ; Nao destroi registradores
1308   4C2A             ; ------------------------------------------------
1309   4C2A             desabilitaSDs: 
1310   4C2A F5          	push	af
1311   4C2B 3E FF       	ld	a, $FF		; todos os /CS em 1
1312   4C2D 32 00 48    	ld	(PORTCFG), a
1313   4C30 F1          	pop	af
1314   4C31 C9          	ret
1315   4C32             
1316   4C32             ; ------------------------------------------------
1317   4C32             ; Enviar comando ACMD41
1318   4C32             ; ------------------------------------------------
1319   4C32             SD_SEND_ACMD41: 
1320   4C32 3E 77       	ld	a, CMD55
1321   4C34 CD 42 4C    	call	SD_SEND_CMD_NO_ARGS
1322   4C37 3E 69       	ld	a, ACMD41
1323   4C39 01 00 40    	ld	bc, $4000
1324   4C3C 51          	ld	d, c
1325   4C3D 59          	ld	e, c
1326   4C3E 18 07       	jr		SD_SEND_CMD_GET_ERROR
1327   4C40             
1328   4C40             ; ------------------------------------------------
1329   4C40             ; Enviar CMD1 para cartao. Carry indica erro
1330   4C40             ; Destroi AF, BC, DE
1331   4C40             ; ------------------------------------------------
1332   4C40             SD_SEND_CMD1: 
1333   4C40 3E 41       	ld	a, CMD1
1334   4C42             SD_SEND_CMD_NO_ARGS: 
1335   4C42 01 00 00    	ld	bc, 0
1336   4C45 50          	ld	d, b
1337   4C46 59          	ld	e, c
1338   4C47             SD_SEND_CMD_GET_ERROR: 
1339   4C47 CD 75 4C    	call	SD_SEND_CMD
1340   4C4A B7          	or	a
1341   4C4B C8          	ret	z			; se A=0 nao houve erro, retornar
1342   4C4C             	; fall throw
1343   4C4C             
1344   4C4C             ; ------------------------------------------------
1345   4C4C             ; Informar erro
1346   4C4C             ; Nao destroi registradores
1347   4C4C             ; ------------------------------------------------
1348   4C4C             setaErro: 
1349   4C4C 37          	scf
1350   4C4D 18 DB       	jr		desabilitaSDs
1351   4C4F             
1352   4C4F             ; ------------------------------------------------
1353   4C4F             ; Enviar comando em A com 2 bytes de parametros
1354   4C4F             ; em DE e testar retorno BUSY
1355   4C4F             ; Retorna em A a resposta do cartao
1356   4C4F             ; Destroi AF, BC
1357   4C4F             ; ------------------------------------------------
1358   4C4F             SD_SEND_CMD_2_ARGS_TEST_BUSY: 
1359   4C4F 01 00 00    	ld	bc, 0
1360   4C52 CD 75 4C    	call	SD_SEND_CMD
1361   4C55 47          	ld	b, a
1362   4C56 E6 FE       	and	$FE		; testar bit 0 (flag BUSY)
1363   4C58 78          	ld	a, b
1364   4C59 20 F1       	jr	nz,setaErro	; BUSY em 1, informar erro
1365   4C5B C9          	ret			; sem erros
1366   4C5C             
1367   4C5C             ; ------------------------------------------------
1368   4C5C             ; Enviar comando em A com 2 bytes de parametros
1369   4C5C             ; em DE e ler resposta do tipo R3 em BC DE
1370   4C5C             ; Retorna em A a resposta do cartao
1371   4C5C             ; Destroi AF, BC, DE, HL
1372   4C5C             ; ------------------------------------------------
1373   4C5C             SD_SEND_CMD_2_ARGS_GET_R3: 
1374   4C5C CD 4F 4C    	call	SD_SEND_CMD_2_ARGS_TEST_BUSY
1375   4C5F D8          	ret	c
1376   4C60 F5          	push	af
1377   4C61 CD A1 4C    	call	WAIT_RESP_NO_FF
1378   4C64 67          	ld	h, a
1379   4C65 CD A1 4C    	call	WAIT_RESP_NO_FF
1380   4C68 6F          	ld	l, a
1381   4C69 CD A1 4C    	call	WAIT_RESP_NO_FF
1382   4C6C 57          	ld	d, a
1383   4C6D CD A1 4C    	call	WAIT_RESP_NO_FF
1384   4C70 5F          	ld	e, a
1385   4C71 44          	ld	b, h
1386   4C72 4D          	ld	c, l
1387   4C73 F1          	pop	af
1388   4C74 C9          	ret
1389   4C75             
1390   4C75             ; ------------------------------------------------
1391   4C75             ; Enviar comando em A com 4 bytes de parametros
1392   4C75             ; em BC DE e enviar CRC correto se for CMD0 ou 
1393   4C75             ; CMD8 e aguardar processamento do cartao
1394   4C75             ; Output  : A=0 if there was no error
1395   4C75             ; Modifies:  AF, B, AF'
1396   4C75             ; ------------------------------------------------
1397   4C75             SD_SEND_CMD: 
1398   4C75 08          	ex	af,af'
1399   4C76 CD CD 4C    	call	setaSDAtual
1400   4C79 08          	ex	af,af'
1401   4C7A 32 00 40    	ld	(PORTSPI), a
1402   4C7D 08          	ex	af,af'
1403   4C7E 78          	ld	a, b
1404   4C7F 32 00 40    	ld	(PORTSPI), a
1405   4C82 79          	ld	a, c
1406   4C83 32 00 40    	ld	(PORTSPI), a
1407   4C86 7A          	ld	a, d
1408   4C87 32 00 40    	ld	(PORTSPI), a
1409   4C8A 7B          	ld	a, e
1410   4C8B 32 00 40    	ld	(PORTSPI), a
1411   4C8E 08          	ex	af,af'
1412   4C8F FE 40       	cp	CMD0
1413   4C91 06 95       	ld	b, $95		; CRC para CMD0
1414   4C93 28 08       	jr	z,enviaCRC
1415   4C95 FE 48       	cp	CMD8
1416   4C97 06 87       	ld	b, $87		; CRC para CMD8
1417   4C99 28 02       	jr	z,enviaCRC
1418   4C9B 06 FF       	ld	b, $FF		; CRC dummy
1419   4C9D             enviaCRC: 
1420   4C9D 78          	ld	a, b
1421   4C9E 32 00 40    	ld	(PORTSPI), a
1422   4CA1             ;	jr	WAIT_RESP_NO_FF
1423   4CA1             
1424   4CA1             ; ------------------------------------------------
1425   4CA1             ; Esperar que resposta do cartao seja diferente
1426   4CA1             ; de $FF
1427   4CA1             ; Destroi AF, BC
1428   4CA1             ; ------------------------------------------------
1429   4CA1             WAIT_RESP_NO_FF: 
1430   4CA1 01 01 00    	ld	bc, 1		; 256 tentativas
1431   4CA4             .loop: 
1432   4CA4 3A 00 40    	ld	a, (PORTSPI)
1433   4CA7 FE FF       	cp	$FF		; testa $FF
1434   4CA9 C0          	ret	nz		; sai se nao for $FF
1435   4CAA 10 F8       	djnz	.loop
1436   4CAC 0D          	dec	c
1437   4CAD 20 F5       	jr	nz,.loop
1438   4CAF C9          	ret
1439   4CB0             
1440   4CB0             ; ------------------------------------------------
1441   4CB0             ; Esperar que resposta do cartao seja $FE
1442   4CB0             ; Destroi AF, B
1443   4CB0             ; ------------------------------------------------
1444   4CB0             WAIT_RESP_FE: 
1445   4CB0 06 0A       	ld	b, 10		; 10 tentativas
1446   4CB2             .loop: 
1447   4CB2 C5          	push	bc
1448   4CB3 CD A1 4C    	call	WAIT_RESP_NO_FF	; esperar resposta diferente de $FF
1449   4CB6 C1          	pop	bc
1450   4CB7 FE FE       	cp	$FE		; resposta  $FE ?
1451   4CB9 C8          	ret	z		; sim, retornamos com carry=0
1452   4CBA 10 F6       	djnz	.loop
1453   4CBC 37          	scf			; erro, carry=1
1454   4CBD C9          	ret
1455   4CBE             
1456   4CBE             ; ------------------------------------------------
1457   4CBE             ; Esperar que resposta do cartao seja diferente
1458   4CBE             ; de $00
1459   4CBE             ; Destroi A, BC
1460   4CBE             ; ------------------------------------------------
1461   4CBE             WAIT_RESP_NO_00: 
1462   4CBE 01 80 00    	ld	bc, 128		; 32768 tentativas
1463   4CC1             .loop: 
1464   4CC1 3A 00 40    	ld	a, (PORTSPI)
1465   4CC4 B7          	or	a
1466   4CC5 C0          	ret	nz			; se resposta for <> $00, sai
1467   4CC6 10 F9       	djnz	.loop
1468   4CC8 0D          	dec	c
1469   4CC9 20 F6       	jr	nz,.loop
1470   4CCB 37          	scf			; erro
1471   4CCC C9          	ret
1472   4CCD             
1473   4CCD             ; ------------------------------------------------
1474   4CCD             ; Ativa (seleciona) cartao atual baixando seu /CS
1475   4CCD             ; Modify: AF 
1476   4CCD             ; ------------------------------------------------
1477   4CCD             setaSDAtual: 
1478   4CCD 3A 00 40    	ld	a, (PORTSPI)	; dummy read
1479   4CD0 FD 7E 30    	ld	a, (iy+WRKAREA.NUMSD)
1480   4CD3 2F          	cpl			; inverte bits
1481   4CD4 32 00 48    	ld	(PORTCFG), a
1482   4CD7 C9          	ret
1483   4CD8             
1484   4CD8             ; ------------------------------------------------
1485   4CD8             ; Grava um bloco de 512 bytes no cartao
1486   4CD8             ; HL aponta para o inicio dos dados
1487   4CD8             ; BC e DE contem o numero do bloco (BCDE = 32 bits)
1488   4CD8             ; Modifies:  AF, BC, DE, HL, IXL
1489   4CD8             ; ------------------------------------------------
1490   4CD8             GravarBloco: 
1491   4CD8 DD 2D       	dec	ixl		; SDcard V1?
1492   4CDA FC 78 5E    	call	m,blocoParaByte	; Yes, convert blocks to bytes 
1493   4CDD CD CD 4C    	call	setaSDAtual	; selecionar cartao atual
1494   4CE0 DD 7C       	ld	a,ixh		; get Number of blocks to write
1495   4CE2 3D          	dec	a
1496   4CE3 CA A1 51    	jp	z,.umBloco	; somente um bloco, gravar usando CMD24
1497   4CE6             
1498   4CE6             ; multiplos blocos
1499   4CE6 D9          	exx
1500   4CE7 3E 77       	ld	a, CMD55	; Multiplos blocos, mandar ACMD23 com total de blocos
1501   4CE9 CD 42 4C    	call	SD_SEND_CMD_NO_ARGS
1502   4CEC 3E 57       	ld	a, ACMD23
1503   4CEE 01 00 00    	ld	bc, 0
1504   4CF1 51          	ld	d, c
1505   4CF2 DD 5C       	ld	e,ixh		; e=Number of blocks to write
1506   4CF4 CD 75 4C    	call	SD_SEND_CMD
1507   4CF7 B7          	or	a
1508   4CF8 20 57       	jr	nz,.erroEscritaBlocoR	; erro no ACMD23
1509   4CFA D9          	exx
1510   4CFB 3E 59       	ld	a, CMD25	; CMD25 = write multiple blocks
1511   4CFD CD 75 4C    	call	SD_SEND_CMD
1512   4D00 B7          	or	a
1513   4D01 20 4E       	jr	nz,.erroEscritaBlocoR	; erro
1514   4D03             
1515   4D03             	; Check for a Z80 or R800
1516   4D03 EB          	ex	de,hl
1517   4D04             ;	ld	a,20
1518   4D04 3D          	dec	a		; a=#FF
1519   4D05 ED F9       	db	#ED,#F9		; mulub a,a
1520   4D07 EB          	ex	de,hl
1521   4D08 18 52       	jr	.loopZ80	; Use the Z80 optimized loop
1522   4D0A             
1523   4D0A D9          	exx
1524   4D0B CD 7B 60    	call	GTR800LDIR
1525   4D0E D9          	exx			; hl'=Pointer to R800LDIR helper routine
1526   4D0F             .loopR800: 	; R800 optimized loop
1527   4D0F 11 00 40    	ld	de,PORTSPI
1528   4D12 3E FC       	ld	a, $FC		; mandar $FC para indicar que os proximos dados
1529   4D14 12          	ld	(de),a		; sao para gravacao
1530   4D15 CD 84 5E    	call	R800LDIR
1531   4D18 32 00 40    	ld	(PORTSPI),a	; Send a dummy 16bit CRC
1532   4D1B 32 00 40    	ld	(PORTSPI),a
1533   4D1E             ; Wait for !FFh
1534   4D1E 06 00       	ld	b,0
1535   4D20 3A E7 00    	ld	a,(#E7)
1536   4D23 4F          	ld	c,a
1537   4D24             .rwaitnoFF: 
1538   4D24 3A 00 40    	ld	a, (PORTSPI)
1539   4D27 3C          	inc	a		; a=FF?
1540   4D28 28 0B       	jr	z,.rnoFFok
1541   4D2A 10 F8       	djnz	.rwaitnoFF	; fast card wait
1542   4D2C DB E7       	in	a,(#E7)
1543   4D2E 91          	sub	c
1544   4D2F FE FA       	cp	250		; 250mS?
1545   4D31 38 F1       	jr	c,.rwaitnoFF	; slow card wait
1546   4D33 18 1C       	jr	.erroEscritaBlocoR	; resposta errada, informar erro
1547   4D35             .rnoFFok: 
1548   4D35 3D          	dec	a
1549   4D36 E6 1F       	and	$1F		; testa bits erro
1550   4D38 FE 05       	cp	5
1551   4D3A 20 15       	jr	nz,.erroEscritaBlocoR	; resposta errada, informar erro
1552   4D3C             ; Wait for !00h
1553   4D3C 06 00       	ld	b,0
1554   4D3E 3A E7 00    	ld	a,(#E7)
1555   4D41 4F          	ld	c,a
1556   4D42             .rwaitno00: 
1557   4D42 3A 00 40    	ld	a, (PORTSPI)
1558   4D45 B7          	or	a
1559   4D46 20 0D       	jr	nz,.rno00ok
1560   4D48 10 F8       	djnz	.rwaitno00	; fast card wait
1561   4D4A DB E7       	in	a,(#E7)
1562   4D4C 91          	sub	c
1563   4D4D FE FA       	cp	250		; 250mS?
1564   4D4F 38 F1       	jr	c,.rwaitno00	; slow card wait
1565   4D51             .erroEscritaBlocoR:  ; Trick to save some cycles inside the block transfer loop
1566   4D51 37          	scf
1567   4D52 C3 D0 55    	jp	terminaLeituraEscritaBloco
1568   4D55             .rno00ok: 
1569   4D55 DD 25       	dec	ixh		; nblocks=nblocks-1
1570   4D57 20 B6       	jr	nz,.loopR800
1571   4D59 C3 7B 51    	jp	.loopend
1572   4D5C             
1573   4D5C             
1574   4D5C             .loopZ80: 	; Z80 optimized loop
1575   4D5C 11 00 40    	ld	de,PORTSPI
1576   4D5F 3E FC       	ld	a, $FC		; mandar $FC para indicar que os proximos dados
1577   4D61 12          	ld	(de),a		; sao para gravacao
1578   4D62 ED A0       > ldi		
1578   4D64 ED A0       > ldi		
1578   4D66 ED A0       > ldi		
1578   4D68 ED A0       > ldi		
1578   4D6A ED A0       > ldi		
1578   4D6C ED A0       > ldi		
1578   4D6E ED A0       > ldi		
1578   4D70 ED A0       > ldi		
1578   4D72 ED A0       > ldi		
1578   4D74 ED A0       > ldi		
1578   4D76 ED A0       > ldi		
1578   4D78 ED A0       > ldi		
1578   4D7A ED A0       > ldi		
1578   4D7C ED A0       > ldi		
1578   4D7E ED A0       > ldi		
1578   4D80 ED A0       > ldi		
1578   4D82 ED A0       > ldi		
1578   4D84 ED A0       > ldi		
1578   4D86 ED A0       > ldi		
1578   4D88 ED A0       > ldi		
1578   4D8A ED A0       > ldi		
1578   4D8C ED A0       > ldi		
1578   4D8E ED A0       > ldi		
1578   4D90 ED A0       > ldi		
1578   4D92 ED A0       > ldi		
1578   4D94 ED A0       > ldi		
1578   4D96 ED A0       > ldi		
1578   4D98 ED A0       > ldi		
1578   4D9A ED A0       > ldi		
1578   4D9C ED A0       > ldi		
1578   4D9E ED A0       > ldi		
1578   4DA0 ED A0       > ldi		
1578   4DA2 ED A0       > ldi		
1578   4DA4 ED A0       > ldi		
1578   4DA6 ED A0       > ldi		
1578   4DA8 ED A0       > ldi		
1578   4DAA ED A0       > ldi		
1578   4DAC ED A0       > ldi		
1578   4DAE ED A0       > ldi		
1578   4DB0 ED A0       > ldi		
1578   4DB2 ED A0       > ldi		
1578   4DB4 ED A0       > ldi		
1578   4DB6 ED A0       > ldi		
1578   4DB8 ED A0       > ldi		
1578   4DBA ED A0       > ldi		
1578   4DBC ED A0       > ldi		
1578   4DBE ED A0       > ldi		
1578   4DC0 ED A0       > ldi		
1578   4DC2 ED A0       > ldi		
1578   4DC4 ED A0       > ldi		
1578   4DC6 ED A0       > ldi		
1578   4DC8 ED A0       > ldi		
1578   4DCA ED A0       > ldi		
1578   4DCC ED A0       > ldi		
1578   4DCE ED A0       > ldi		
1578   4DD0 ED A0       > ldi		
1578   4DD2 ED A0       > ldi		
1578   4DD4 ED A0       > ldi		
1578   4DD6 ED A0       > ldi		
1578   4DD8 ED A0       > ldi		
1578   4DDA ED A0       > ldi		
1578   4DDC ED A0       > ldi		
1578   4DDE ED A0       > ldi		
1578   4DE0 ED A0       > ldi		
1578   4DE2 ED A0       > ldi		
1578   4DE4 ED A0       > ldi		
1578   4DE6 ED A0       > ldi		
1578   4DE8 ED A0       > ldi		
1578   4DEA ED A0       > ldi		
1578   4DEC ED A0       > ldi		
1578   4DEE ED A0       > ldi		
1578   4DF0 ED A0       > ldi		
1578   4DF2 ED A0       > ldi		
1578   4DF4 ED A0       > ldi		
1578   4DF6 ED A0       > ldi		
1578   4DF8 ED A0       > ldi		
1578   4DFA ED A0       > ldi		
1578   4DFC ED A0       > ldi		
1578   4DFE ED A0       > ldi		
1578   4E00 ED A0       > ldi		
1578   4E02 ED A0       > ldi		
1578   4E04 ED A0       > ldi		
1578   4E06 ED A0       > ldi		
1578   4E08 ED A0       > ldi		
1578   4E0A ED A0       > ldi		
1578   4E0C ED A0       > ldi		
1578   4E0E ED A0       > ldi		
1578   4E10 ED A0       > ldi		
1578   4E12 ED A0       > ldi		
1578   4E14 ED A0       > ldi		
1578   4E16 ED A0       > ldi		
1578   4E18 ED A0       > ldi		
1578   4E1A ED A0       > ldi		
1578   4E1C ED A0       > ldi		
1578   4E1E ED A0       > ldi		
1578   4E20 ED A0       > ldi		
1578   4E22 ED A0       > ldi		
1578   4E24 ED A0       > ldi		
1578   4E26 ED A0       > ldi		
1578   4E28 ED A0       > ldi		
1578   4E2A ED A0       > ldi		
1578   4E2C ED A0       > ldi		
1578   4E2E ED A0       > ldi		
1578   4E30 ED A0       > ldi		
1578   4E32 ED A0       > ldi		
1578   4E34 ED A0       > ldi		
1578   4E36 ED A0       > ldi		
1578   4E38 ED A0       > ldi		
1578   4E3A ED A0       > ldi		
1578   4E3C ED A0       > ldi		
1578   4E3E ED A0       > ldi		
1578   4E40 ED A0       > ldi		
1578   4E42 ED A0       > ldi		
1578   4E44 ED A0       > ldi		
1578   4E46 ED A0       > ldi		
1578   4E48 ED A0       > ldi		
1578   4E4A ED A0       > ldi		
1578   4E4C ED A0       > ldi		
1578   4E4E ED A0       > ldi		
1578   4E50 ED A0       > ldi		
1578   4E52 ED A0       > ldi		
1578   4E54 ED A0       > ldi		
1578   4E56 ED A0       > ldi		
1578   4E58 ED A0       > ldi		
1578   4E5A ED A0       > ldi		
1578   4E5C ED A0       > ldi		
1578   4E5E ED A0       > ldi		
1578   4E60 ED A0       > ldi		
1578   4E62 ED A0       > ldi		
1578   4E64 ED A0       > ldi		
1578   4E66 ED A0       > ldi		
1578   4E68 ED A0       > ldi		
1578   4E6A ED A0       > ldi		
1578   4E6C ED A0       > ldi		
1578   4E6E ED A0       > ldi		
1578   4E70 ED A0       > ldi		
1578   4E72 ED A0       > ldi		
1578   4E74 ED A0       > ldi		
1578   4E76 ED A0       > ldi		
1578   4E78 ED A0       > ldi		
1578   4E7A ED A0       > ldi		
1578   4E7C ED A0       > ldi		
1578   4E7E ED A0       > ldi		
1578   4E80 ED A0       > ldi		
1578   4E82 ED A0       > ldi		
1578   4E84 ED A0       > ldi		
1578   4E86 ED A0       > ldi		
1578   4E88 ED A0       > ldi		
1578   4E8A ED A0       > ldi		
1578   4E8C ED A0       > ldi		
1578   4E8E ED A0       > ldi		
1578   4E90 ED A0       > ldi		
1578   4E92 ED A0       > ldi		
1578   4E94 ED A0       > ldi		
1578   4E96 ED A0       > ldi		
1578   4E98 ED A0       > ldi		
1578   4E9A ED A0       > ldi		
1578   4E9C ED A0       > ldi		
1578   4E9E ED A0       > ldi		
1578   4EA0 ED A0       > ldi		
1578   4EA2 ED A0       > ldi		
1578   4EA4 ED A0       > ldi		
1578   4EA6 ED A0       > ldi		
1578   4EA8 ED A0       > ldi		
1578   4EAA ED A0       > ldi		
1578   4EAC ED A0       > ldi		
1578   4EAE ED A0       > ldi		
1578   4EB0 ED A0       > ldi		
1578   4EB2 ED A0       > ldi		
1578   4EB4 ED A0       > ldi		
1578   4EB6 ED A0       > ldi		
1578   4EB8 ED A0       > ldi		
1578   4EBA ED A0       > ldi		
1578   4EBC ED A0       > ldi		
1578   4EBE ED A0       > ldi		
1578   4EC0 ED A0       > ldi		
1578   4EC2 ED A0       > ldi		
1578   4EC4 ED A0       > ldi		
1578   4EC6 ED A0       > ldi		
1578   4EC8 ED A0       > ldi		
1578   4ECA ED A0       > ldi		
1578   4ECC ED A0       > ldi		
1578   4ECE ED A0       > ldi		
1578   4ED0 ED A0       > ldi		
1578   4ED2 ED A0       > ldi		
1578   4ED4 ED A0       > ldi		
1578   4ED6 ED A0       > ldi		
1578   4ED8 ED A0       > ldi		
1578   4EDA ED A0       > ldi		
1578   4EDC ED A0       > ldi		
1578   4EDE ED A0       > ldi		
1578   4EE0 ED A0       > ldi		
1578   4EE2 ED A0       > ldi		
1578   4EE4 ED A0       > ldi		
1578   4EE6 ED A0       > ldi		
1578   4EE8 ED A0       > ldi		
1578   4EEA ED A0       > ldi		
1578   4EEC ED A0       > ldi		
1578   4EEE ED A0       > ldi		
1578   4EF0 ED A0       > ldi		
1578   4EF2 ED A0       > ldi		
1578   4EF4 ED A0       > ldi		
1578   4EF6 ED A0       > ldi		
1578   4EF8 ED A0       > ldi		
1578   4EFA ED A0       > ldi		
1578   4EFC ED A0       > ldi		
1578   4EFE ED A0       > ldi		
1578   4F00 ED A0       > ldi		
1578   4F02 ED A0       > ldi		
1578   4F04 ED A0       > ldi		
1578   4F06 ED A0       > ldi		
1578   4F08 ED A0       > ldi		
1578   4F0A ED A0       > ldi		
1578   4F0C ED A0       > ldi		
1578   4F0E ED A0       > ldi		
1578   4F10 ED A0       > ldi		
1578   4F12 ED A0       > ldi		
1578   4F14 ED A0       > ldi		
1578   4F16 ED A0       > ldi		
1578   4F18 ED A0       > ldi		
1578   4F1A ED A0       > ldi		
1578   4F1C ED A0       > ldi		
1578   4F1E ED A0       > ldi		
1578   4F20 ED A0       > ldi		
1578   4F22 ED A0       > ldi		
1578   4F24 ED A0       > ldi		
1578   4F26 ED A0       > ldi		
1578   4F28 ED A0       > ldi		
1578   4F2A ED A0       > ldi		
1578   4F2C ED A0       > ldi		
1578   4F2E ED A0       > ldi		
1578   4F30 ED A0       > ldi		
1578   4F32 ED A0       > ldi		
1578   4F34 ED A0       > ldi		
1578   4F36 ED A0       > ldi		
1578   4F38 ED A0       > ldi		
1578   4F3A ED A0       > ldi		
1578   4F3C ED A0       > ldi		
1578   4F3E ED A0       > ldi		
1578   4F40 ED A0       > ldi		
1578   4F42 ED A0       > ldi		
1578   4F44 ED A0       > ldi		
1578   4F46 ED A0       > ldi		
1578   4F48 ED A0       > ldi		
1578   4F4A ED A0       > ldi		
1578   4F4C ED A0       > ldi		
1578   4F4E ED A0       > ldi		
1578   4F50 ED A0       > ldi		
1578   4F52 ED A0       > ldi		
1578   4F54 ED A0       > ldi		
1578   4F56 ED A0       > ldi		
1578   4F58 ED A0       > ldi		
1578   4F5A ED A0       > ldi		
1578   4F5C ED A0       > ldi		
1578   4F5E ED A0       > ldi		
1578   4F60 ED A0       > ldi		
1578   4F62 ED A0       > ldi		
1578   4F64 ED A0       > ldi		
1578   4F66 ED A0       > ldi		
1578   4F68 ED A0       > ldi		
1578   4F6A ED A0       > ldi		
1578   4F6C ED A0       > ldi		
1578   4F6E ED A0       > ldi		
1578   4F70 ED A0       > ldi		
1578   4F72 ED A0       > ldi		
1578   4F74 ED A0       > ldi		
1578   4F76 ED A0       > ldi		
1578   4F78 ED A0       > ldi		
1578   4F7A ED A0       > ldi		
1578   4F7C ED A0       > ldi		
1578   4F7E ED A0       > ldi		
1578   4F80 ED A0       > ldi		
1578   4F82 ED A0       > ldi		
1578   4F84 ED A0       > ldi		
1578   4F86 ED A0       > ldi		
1578   4F88 ED A0       > ldi		
1578   4F8A ED A0       > ldi		
1578   4F8C ED A0       > ldi		
1578   4F8E ED A0       > ldi		
1578   4F90 ED A0       > ldi		
1578   4F92 ED A0       > ldi		
1578   4F94 ED A0       > ldi		
1578   4F96 ED A0       > ldi		
1578   4F98 ED A0       > ldi		
1578   4F9A ED A0       > ldi		
1578   4F9C ED A0       > ldi		
1578   4F9E ED A0       > ldi		
1578   4FA0 ED A0       > ldi		
1578   4FA2 ED A0       > ldi		
1578   4FA4 ED A0       > ldi		
1578   4FA6 ED A0       > ldi		
1578   4FA8 ED A0       > ldi		
1578   4FAA ED A0       > ldi		
1578   4FAC ED A0       > ldi		
1578   4FAE ED A0       > ldi		
1578   4FB0 ED A0       > ldi		
1578   4FB2 ED A0       > ldi		
1578   4FB4 ED A0       > ldi		
1578   4FB6 ED A0       > ldi		
1578   4FB8 ED A0       > ldi		
1578   4FBA ED A0       > ldi		
1578   4FBC ED A0       > ldi		
1578   4FBE ED A0       > ldi		
1578   4FC0 ED A0       > ldi		
1578   4FC2 ED A0       > ldi		
1578   4FC4 ED A0       > ldi		
1578   4FC6 ED A0       > ldi		
1578   4FC8 ED A0       > ldi		
1578   4FCA ED A0       > ldi		
1578   4FCC ED A0       > ldi		
1578   4FCE ED A0       > ldi		
1578   4FD0 ED A0       > ldi		
1578   4FD2 ED A0       > ldi		
1578   4FD4 ED A0       > ldi		
1578   4FD6 ED A0       > ldi		
1578   4FD8 ED A0       > ldi		
1578   4FDA ED A0       > ldi		
1578   4FDC ED A0       > ldi		
1578   4FDE ED A0       > ldi		
1578   4FE0 ED A0       > ldi		
1578   4FE2 ED A0       > ldi		
1578   4FE4 ED A0       > ldi		
1578   4FE6 ED A0       > ldi		
1578   4FE8 ED A0       > ldi		
1578   4FEA ED A0       > ldi		
1578   4FEC ED A0       > ldi		
1578   4FEE ED A0       > ldi		
1578   4FF0 ED A0       > ldi		
1578   4FF2 ED A0       > ldi		
1578   4FF4 ED A0       > ldi		
1578   4FF6 ED A0       > ldi		
1578   4FF8 ED A0       > ldi		
1578   4FFA ED A0       > ldi		
1578   4FFC ED A0       > ldi		
1578   4FFE ED A0       > ldi		
1578   5000 ED A0       > ldi		
1578   5002 ED A0       > ldi		
1578   5004 ED A0       > ldi		
1578   5006 ED A0       > ldi		
1578   5008 ED A0       > ldi		
1578   500A ED A0       > ldi		
1578   500C ED A0       > ldi		
1578   500E ED A0       > ldi		
1578   5010 ED A0       > ldi		
1578   5012 ED A0       > ldi		
1578   5014 ED A0       > ldi		
1578   5016 ED A0       > ldi		
1578   5018 ED A0       > ldi		
1578   501A ED A0       > ldi		
1578   501C ED A0       > ldi		
1578   501E ED A0       > ldi		
1578   5020 ED A0       > ldi		
1578   5022 ED A0       > ldi		
1578   5024 ED A0       > ldi		
1578   5026 ED A0       > ldi		
1578   5028 ED A0       > ldi		
1578   502A ED A0       > ldi		
1578   502C ED A0       > ldi		
1578   502E ED A0       > ldi		
1578   5030 ED A0       > ldi		
1578   5032 ED A0       > ldi		
1578   5034 ED A0       > ldi		
1578   5036 ED A0       > ldi		
1578   5038 ED A0       > ldi		
1578   503A ED A0       > ldi		
1578   503C ED A0       > ldi		
1578   503E ED A0       > ldi		
1578   5040 ED A0       > ldi		
1578   5042 ED A0       > ldi		
1578   5044 ED A0       > ldi		
1578   5046 ED A0       > ldi		
1578   5048 ED A0       > ldi		
1578   504A ED A0       > ldi		
1578   504C ED A0       > ldi		
1578   504E ED A0       > ldi		
1578   5050 ED A0       > ldi		
1578   5052 ED A0       > ldi		
1578   5054 ED A0       > ldi		
1578   5056 ED A0       > ldi		
1578   5058 ED A0       > ldi		
1578   505A ED A0       > ldi		
1578   505C ED A0       > ldi		
1578   505E ED A0       > ldi		
1578   5060 ED A0       > ldi		
1578   5062 ED A0       > ldi		
1578   5064 ED A0       > ldi		
1578   5066 ED A0       > ldi		
1578   5068 ED A0       > ldi		
1578   506A ED A0       > ldi		
1578   506C ED A0       > ldi		
1578   506E ED A0       > ldi		
1578   5070 ED A0       > ldi		
1578   5072 ED A0       > ldi		
1578   5074 ED A0       > ldi		
1578   5076 ED A0       > ldi		
1578   5078 ED A0       > ldi		
1578   507A ED A0       > ldi		
1578   507C ED A0       > ldi		
1578   507E ED A0       > ldi		
1578   5080 ED A0       > ldi		
1578   5082 ED A0       > ldi		
1578   5084 ED A0       > ldi		
1578   5086 ED A0       > ldi		
1578   5088 ED A0       > ldi		
1578   508A ED A0       > ldi		
1578   508C ED A0       > ldi		
1578   508E ED A0       > ldi		
1578   5090 ED A0       > ldi		
1578   5092 ED A0       > ldi		
1578   5094 ED A0       > ldi		
1578   5096 ED A0       > ldi		
1578   5098 ED A0       > ldi		
1578   509A ED A0       > ldi		
1578   509C ED A0       > ldi		
1578   509E ED A0       > ldi		
1578   50A0 ED A0       > ldi		
1578   50A2 ED A0       > ldi		
1578   50A4 ED A0       > ldi		
1578   50A6 ED A0       > ldi		
1578   50A8 ED A0       > ldi		
1578   50AA ED A0       > ldi		
1578   50AC ED A0       > ldi		
1578   50AE ED A0       > ldi		
1578   50B0 ED A0       > ldi		
1578   50B2 ED A0       > ldi		
1578   50B4 ED A0       > ldi		
1578   50B6 ED A0       > ldi		
1578   50B8 ED A0       > ldi		
1578   50BA ED A0       > ldi		
1578   50BC ED A0       > ldi		
1578   50BE ED A0       > ldi		
1578   50C0 ED A0       > ldi		
1578   50C2 ED A0       > ldi		
1578   50C4 ED A0       > ldi		
1578   50C6 ED A0       > ldi		
1578   50C8 ED A0       > ldi		
1578   50CA ED A0       > ldi		
1578   50CC ED A0       > ldi		
1578   50CE ED A0       > ldi		
1578   50D0 ED A0       > ldi		
1578   50D2 ED A0       > ldi		
1578   50D4 ED A0       > ldi		
1578   50D6 ED A0       > ldi		
1578   50D8 ED A0       > ldi		
1578   50DA ED A0       > ldi		
1578   50DC ED A0       > ldi		
1578   50DE ED A0       > ldi		
1578   50E0 ED A0       > ldi		
1578   50E2 ED A0       > ldi		
1578   50E4 ED A0       > ldi		
1578   50E6 ED A0       > ldi		
1578   50E8 ED A0       > ldi		
1578   50EA ED A0       > ldi		
1578   50EC ED A0       > ldi		
1578   50EE ED A0       > ldi		
1578   50F0 ED A0       > ldi		
1578   50F2 ED A0       > ldi		
1578   50F4 ED A0       > ldi		
1578   50F6 ED A0       > ldi		
1578   50F8 ED A0       > ldi		
1578   50FA ED A0       > ldi		
1578   50FC ED A0       > ldi		
1578   50FE ED A0       > ldi		
1578   5100 ED A0       > ldi		
1578   5102 ED A0       > ldi		
1578   5104 ED A0       > ldi		
1578   5106 ED A0       > ldi		
1578   5108 ED A0       > ldi		
1578   510A ED A0       > ldi		
1578   510C ED A0       > ldi		
1578   510E ED A0       > ldi		
1578   5110 ED A0       > ldi		
1578   5112 ED A0       > ldi		
1578   5114 ED A0       > ldi		
1578   5116 ED A0       > ldi		
1578   5118 ED A0       > ldi		
1578   511A ED A0       > ldi		
1578   511C ED A0       > ldi		
1578   511E ED A0       > ldi		
1578   5120 ED A0       > ldi		
1578   5122 ED A0       > ldi		
1578   5124 ED A0       > ldi		
1578   5126 ED A0       > ldi		
1578   5128 ED A0       > ldi		
1578   512A ED A0       > ldi		
1578   512C ED A0       > ldi		
1578   512E ED A0       > ldi		
1578   5130 ED A0       > ldi		
1578   5132 ED A0       > ldi		
1578   5134 ED A0       > ldi		
1578   5136 ED A0       > ldi		
1578   5138 ED A0       > ldi		
1578   513A ED A0       > ldi		
1578   513C ED A0       > ldi		
1578   513E ED A0       > ldi		
1578   5140 ED A0       > ldi		
1578   5142 ED A0       > ldi		
1578   5144 ED A0       > ldi		
1578   5146 ED A0       > ldi		
1578   5148 ED A0       > ldi		
1578   514A ED A0       > ldi		
1578   514C ED A0       > ldi		
1578   514E ED A0       > ldi		
1578   5150 ED A0       > ldi		
1578   5152 ED A0       > ldi		
1578   5154 ED A0       > ldi		
1578   5156 ED A0       > ldi		
1578   5158 ED A0       > ldi		
1578   515A ED A0       > ldi		
1578   515C ED A0       > ldi		
1578   515E ED A0       > ldi		
1578   5160 ED A0       > ldi		
1579   5162 32 00 40    	ld	(PORTSPI),a
1580   5165 32 00 40    	ld	(PORTSPI),a
1581   5168 CD A1 4C    	call	WAIT_RESP_NO_FF	; esperar cartao
1582   516B E6 1F       	and	$1F		; testa bits erro
1583   516D FE 05       	cp	5
1584   516F 20 2C       	jr	nz,.erroEscritaBlocoZ	; resposta errada, informar erro
1585   5171 CD BE 4C    	call	WAIT_RESP_NO_00	; esperar cartao
1586   5174 38 27       	jr	c,.erroEscritaBlocoZ
1587   5176 DD 25       	dec	ixh		; nblocks=nblocks-1
1588   5178 C2 5C 4D    	jp	nz,.loopZ80
1589   517B             .loopend: 
1590   517B 3A 00 40    	ld	a, (PORTSPI)	; acabou os blocos, fazer 2 dummy reads
1591   517E 3A 00 40    	ld	a, (PORTSPI)
1592   5181 3E FD       	ld	a, $FD		; enviar $FD para informar ao cartao que acabou os dados
1593   5183 32 00 40    	ld	(PORTSPI),a
1594   5186 3A 00 40    	ld	a, (PORTSPI)	; dummy reads
1595   5189 3A 00 40    	ld	a, (PORTSPI)
1596   518C CD BE 4C    	call	WAIT_RESP_NO_00	; esperar cartao
1597   518F C3 CF 55    	jp	.fim		; CMD25 concluido, sair informando nenhum erro
1598   5192             
1599   5192             
1600   5192             
1601   5192             .r800s: 
1602   5192 D9          	exx
1603   5193 CD 7B 60    	call	GTR800LDIR
1604   5196 D9          	exx			; hl'=Pointer to R800LDIR helper routine
1605   5197 CD 84 5E    	call	R800LDIR
1606   519A C3 B6 55    	jp	.part2s
1607   519D             
1608   519D             .erroEscritaBlocoZ:  ; Trick to save some cycles inside the block transfer loop
1609   519D 37          	scf
1610   519E C3 D0 55    	jp	terminaLeituraEscritaBloco
1611   51A1             
1612   51A1             .umBloco: 
1613   51A1 3E 58       	ld	a, CMD24	; CMD24 = Write Single Block
1614   51A3 CD 47 4C    	call	SD_SEND_CMD_GET_ERROR
1615   51A6 DA D0 55    	jp	c,terminaLeituraEscritaBloco	; erro
1616   51A9             
1617   51A9             
1618   51A9 3E FE       	ld	a, $FE		; mandar $FE para indicar que vamos mandar dados para gravacao
1619   51AB 32 00 40    	ld	(PORTSPI),a
1620   51AE             
1621   51AE             	; Check for a Z80 or R800
1622   51AE             ;	ld	a,20
1623   51AE ED F9       	db	#ED,#F9		; mulub a,a
1624   51B0 D9          	exx
1625   51B1 11 00 40    	ld	de,PORTSPI
1626   51B4 38 DC       	jr	c,.r800s	; Use LDIR for R800
1627   51B6 ED A0       > ldi
1627   51B8 ED A0       > ldi
1627   51BA ED A0       > ldi
1627   51BC ED A0       > ldi
1627   51BE ED A0       > ldi
1627   51C0 ED A0       > ldi
1627   51C2 ED A0       > ldi
1627   51C4 ED A0       > ldi
1627   51C6 ED A0       > ldi
1627   51C8 ED A0       > ldi
1627   51CA ED A0       > ldi
1627   51CC ED A0       > ldi
1627   51CE ED A0       > ldi
1627   51D0 ED A0       > ldi
1627   51D2 ED A0       > ldi
1627   51D4 ED A0       > ldi
1627   51D6 ED A0       > ldi
1627   51D8 ED A0       > ldi
1627   51DA ED A0       > ldi
1627   51DC ED A0       > ldi
1627   51DE ED A0       > ldi
1627   51E0 ED A0       > ldi
1627   51E2 ED A0       > ldi
1627   51E4 ED A0       > ldi
1627   51E6 ED A0       > ldi
1627   51E8 ED A0       > ldi
1627   51EA ED A0       > ldi
1627   51EC ED A0       > ldi
1627   51EE ED A0       > ldi
1627   51F0 ED A0       > ldi
1627   51F2 ED A0       > ldi
1627   51F4 ED A0       > ldi
1627   51F6 ED A0       > ldi
1627   51F8 ED A0       > ldi
1627   51FA ED A0       > ldi
1627   51FC ED A0       > ldi
1627   51FE ED A0       > ldi
1627   5200 ED A0       > ldi
1627   5202 ED A0       > ldi
1627   5204 ED A0       > ldi
1627   5206 ED A0       > ldi
1627   5208 ED A0       > ldi
1627   520A ED A0       > ldi
1627   520C ED A0       > ldi
1627   520E ED A0       > ldi
1627   5210 ED A0       > ldi
1627   5212 ED A0       > ldi
1627   5214 ED A0       > ldi
1627   5216 ED A0       > ldi
1627   5218 ED A0       > ldi
1627   521A ED A0       > ldi
1627   521C ED A0       > ldi
1627   521E ED A0       > ldi
1627   5220 ED A0       > ldi
1627   5222 ED A0       > ldi
1627   5224 ED A0       > ldi
1627   5226 ED A0       > ldi
1627   5228 ED A0       > ldi
1627   522A ED A0       > ldi
1627   522C ED A0       > ldi
1627   522E ED A0       > ldi
1627   5230 ED A0       > ldi
1627   5232 ED A0       > ldi
1627   5234 ED A0       > ldi
1627   5236 ED A0       > ldi
1627   5238 ED A0       > ldi
1627   523A ED A0       > ldi
1627   523C ED A0       > ldi
1627   523E ED A0       > ldi
1627   5240 ED A0       > ldi
1627   5242 ED A0       > ldi
1627   5244 ED A0       > ldi
1627   5246 ED A0       > ldi
1627   5248 ED A0       > ldi
1627   524A ED A0       > ldi
1627   524C ED A0       > ldi
1627   524E ED A0       > ldi
1627   5250 ED A0       > ldi
1627   5252 ED A0       > ldi
1627   5254 ED A0       > ldi
1627   5256 ED A0       > ldi
1627   5258 ED A0       > ldi
1627   525A ED A0       > ldi
1627   525C ED A0       > ldi
1627   525E ED A0       > ldi
1627   5260 ED A0       > ldi
1627   5262 ED A0       > ldi
1627   5264 ED A0       > ldi
1627   5266 ED A0       > ldi
1627   5268 ED A0       > ldi
1627   526A ED A0       > ldi
1627   526C ED A0       > ldi
1627   526E ED A0       > ldi
1627   5270 ED A0       > ldi
1627   5272 ED A0       > ldi
1627   5274 ED A0       > ldi
1627   5276 ED A0       > ldi
1627   5278 ED A0       > ldi
1627   527A ED A0       > ldi
1627   527C ED A0       > ldi
1627   527E ED A0       > ldi
1627   5280 ED A0       > ldi
1627   5282 ED A0       > ldi
1627   5284 ED A0       > ldi
1627   5286 ED A0       > ldi
1627   5288 ED A0       > ldi
1627   528A ED A0       > ldi
1627   528C ED A0       > ldi
1627   528E ED A0       > ldi
1627   5290 ED A0       > ldi
1627   5292 ED A0       > ldi
1627   5294 ED A0       > ldi
1627   5296 ED A0       > ldi
1627   5298 ED A0       > ldi
1627   529A ED A0       > ldi
1627   529C ED A0       > ldi
1627   529E ED A0       > ldi
1627   52A0 ED A0       > ldi
1627   52A2 ED A0       > ldi
1627   52A4 ED A0       > ldi
1627   52A6 ED A0       > ldi
1627   52A8 ED A0       > ldi
1627   52AA ED A0       > ldi
1627   52AC ED A0       > ldi
1627   52AE ED A0       > ldi
1627   52B0 ED A0       > ldi
1627   52B2 ED A0       > ldi
1627   52B4 ED A0       > ldi
1627   52B6 ED A0       > ldi
1627   52B8 ED A0       > ldi
1627   52BA ED A0       > ldi
1627   52BC ED A0       > ldi
1627   52BE ED A0       > ldi
1627   52C0 ED A0       > ldi
1627   52C2 ED A0       > ldi
1627   52C4 ED A0       > ldi
1627   52C6 ED A0       > ldi
1627   52C8 ED A0       > ldi
1627   52CA ED A0       > ldi
1627   52CC ED A0       > ldi
1627   52CE ED A0       > ldi
1627   52D0 ED A0       > ldi
1627   52D2 ED A0       > ldi
1627   52D4 ED A0       > ldi
1627   52D6 ED A0       > ldi
1627   52D8 ED A0       > ldi
1627   52DA ED A0       > ldi
1627   52DC ED A0       > ldi
1627   52DE ED A0       > ldi
1627   52E0 ED A0       > ldi
1627   52E2 ED A0       > ldi
1627   52E4 ED A0       > ldi
1627   52E6 ED A0       > ldi
1627   52E8 ED A0       > ldi
1627   52EA ED A0       > ldi
1627   52EC ED A0       > ldi
1627   52EE ED A0       > ldi
1627   52F0 ED A0       > ldi
1627   52F2 ED A0       > ldi
1627   52F4 ED A0       > ldi
1627   52F6 ED A0       > ldi
1627   52F8 ED A0       > ldi
1627   52FA ED A0       > ldi
1627   52FC ED A0       > ldi
1627   52FE ED A0       > ldi
1627   5300 ED A0       > ldi
1627   5302 ED A0       > ldi
1627   5304 ED A0       > ldi
1627   5306 ED A0       > ldi
1627   5308 ED A0       > ldi
1627   530A ED A0       > ldi
1627   530C ED A0       > ldi
1627   530E ED A0       > ldi
1627   5310 ED A0       > ldi
1627   5312 ED A0       > ldi
1627   5314 ED A0       > ldi
1627   5316 ED A0       > ldi
1627   5318 ED A0       > ldi
1627   531A ED A0       > ldi
1627   531C ED A0       > ldi
1627   531E ED A0       > ldi
1627   5320 ED A0       > ldi
1627   5322 ED A0       > ldi
1627   5324 ED A0       > ldi
1627   5326 ED A0       > ldi
1627   5328 ED A0       > ldi
1627   532A ED A0       > ldi
1627   532C ED A0       > ldi
1627   532E ED A0       > ldi
1627   5330 ED A0       > ldi
1627   5332 ED A0       > ldi
1627   5334 ED A0       > ldi
1627   5336 ED A0       > ldi
1627   5338 ED A0       > ldi
1627   533A ED A0       > ldi
1627   533C ED A0       > ldi
1627   533E ED A0       > ldi
1627   5340 ED A0       > ldi
1627   5342 ED A0       > ldi
1627   5344 ED A0       > ldi
1627   5346 ED A0       > ldi
1627   5348 ED A0       > ldi
1627   534A ED A0       > ldi
1627   534C ED A0       > ldi
1627   534E ED A0       > ldi
1627   5350 ED A0       > ldi
1627   5352 ED A0       > ldi
1627   5354 ED A0       > ldi
1627   5356 ED A0       > ldi
1627   5358 ED A0       > ldi
1627   535A ED A0       > ldi
1627   535C ED A0       > ldi
1627   535E ED A0       > ldi
1627   5360 ED A0       > ldi
1627   5362 ED A0       > ldi
1627   5364 ED A0       > ldi
1627   5366 ED A0       > ldi
1627   5368 ED A0       > ldi
1627   536A ED A0       > ldi
1627   536C ED A0       > ldi
1627   536E ED A0       > ldi
1627   5370 ED A0       > ldi
1627   5372 ED A0       > ldi
1627   5374 ED A0       > ldi
1627   5376 ED A0       > ldi
1627   5378 ED A0       > ldi
1627   537A ED A0       > ldi
1627   537C ED A0       > ldi
1627   537E ED A0       > ldi
1627   5380 ED A0       > ldi
1627   5382 ED A0       > ldi
1627   5384 ED A0       > ldi
1627   5386 ED A0       > ldi
1627   5388 ED A0       > ldi
1627   538A ED A0       > ldi
1627   538C ED A0       > ldi
1627   538E ED A0       > ldi
1627   5390 ED A0       > ldi
1627   5392 ED A0       > ldi
1627   5394 ED A0       > ldi
1627   5396 ED A0       > ldi
1627   5398 ED A0       > ldi
1627   539A ED A0       > ldi
1627   539C ED A0       > ldi
1627   539E ED A0       > ldi
1627   53A0 ED A0       > ldi
1627   53A2 ED A0       > ldi
1627   53A4 ED A0       > ldi
1627   53A6 ED A0       > ldi
1627   53A8 ED A0       > ldi
1627   53AA ED A0       > ldi
1627   53AC ED A0       > ldi
1627   53AE ED A0       > ldi
1627   53B0 ED A0       > ldi
1627   53B2 ED A0       > ldi
1627   53B4 ED A0       > ldi
1627   53B6 ED A0       > ldi
1627   53B8 ED A0       > ldi
1627   53BA ED A0       > ldi
1627   53BC ED A0       > ldi
1627   53BE ED A0       > ldi
1627   53C0 ED A0       > ldi
1627   53C2 ED A0       > ldi
1627   53C4 ED A0       > ldi
1627   53C6 ED A0       > ldi
1627   53C8 ED A0       > ldi
1627   53CA ED A0       > ldi
1627   53CC ED A0       > ldi
1627   53CE ED A0       > ldi
1627   53D0 ED A0       > ldi
1627   53D2 ED A0       > ldi
1627   53D4 ED A0       > ldi
1627   53D6 ED A0       > ldi
1627   53D8 ED A0       > ldi
1627   53DA ED A0       > ldi
1627   53DC ED A0       > ldi
1627   53DE ED A0       > ldi
1627   53E0 ED A0       > ldi
1627   53E2 ED A0       > ldi
1627   53E4 ED A0       > ldi
1627   53E6 ED A0       > ldi
1627   53E8 ED A0       > ldi
1627   53EA ED A0       > ldi
1627   53EC ED A0       > ldi
1627   53EE ED A0       > ldi
1627   53F0 ED A0       > ldi
1627   53F2 ED A0       > ldi
1627   53F4 ED A0       > ldi
1627   53F6 ED A0       > ldi
1627   53F8 ED A0       > ldi
1627   53FA ED A0       > ldi
1627   53FC ED A0       > ldi
1627   53FE ED A0       > ldi
1627   5400 ED A0       > ldi
1627   5402 ED A0       > ldi
1627   5404 ED A0       > ldi
1627   5406 ED A0       > ldi
1627   5408 ED A0       > ldi
1627   540A ED A0       > ldi
1627   540C ED A0       > ldi
1627   540E ED A0       > ldi
1627   5410 ED A0       > ldi
1627   5412 ED A0       > ldi
1627   5414 ED A0       > ldi
1627   5416 ED A0       > ldi
1627   5418 ED A0       > ldi
1627   541A ED A0       > ldi
1627   541C ED A0       > ldi
1627   541E ED A0       > ldi
1627   5420 ED A0       > ldi
1627   5422 ED A0       > ldi
1627   5424 ED A0       > ldi
1627   5426 ED A0       > ldi
1627   5428 ED A0       > ldi
1627   542A ED A0       > ldi
1627   542C ED A0       > ldi
1627   542E ED A0       > ldi
1627   5430 ED A0       > ldi
1627   5432 ED A0       > ldi
1627   5434 ED A0       > ldi
1627   5436 ED A0       > ldi
1627   5438 ED A0       > ldi
1627   543A ED A0       > ldi
1627   543C ED A0       > ldi
1627   543E ED A0       > ldi
1627   5440 ED A0       > ldi
1627   5442 ED A0       > ldi
1627   5444 ED A0       > ldi
1627   5446 ED A0       > ldi
1627   5448 ED A0       > ldi
1627   544A ED A0       > ldi
1627   544C ED A0       > ldi
1627   544E ED A0       > ldi
1627   5450 ED A0       > ldi
1627   5452 ED A0       > ldi
1627   5454 ED A0       > ldi
1627   5456 ED A0       > ldi
1627   5458 ED A0       > ldi
1627   545A ED A0       > ldi
1627   545C ED A0       > ldi
1627   545E ED A0       > ldi
1627   5460 ED A0       > ldi
1627   5462 ED A0       > ldi
1627   5464 ED A0       > ldi
1627   5466 ED A0       > ldi
1627   5468 ED A0       > ldi
1627   546A ED A0       > ldi
1627   546C ED A0       > ldi
1627   546E ED A0       > ldi
1627   5470 ED A0       > ldi
1627   5472 ED A0       > ldi
1627   5474 ED A0       > ldi
1627   5476 ED A0       > ldi
1627   5478 ED A0       > ldi
1627   547A ED A0       > ldi
1627   547C ED A0       > ldi
1627   547E ED A0       > ldi
1627   5480 ED A0       > ldi
1627   5482 ED A0       > ldi
1627   5484 ED A0       > ldi
1627   5486 ED A0       > ldi
1627   5488 ED A0       > ldi
1627   548A ED A0       > ldi
1627   548C ED A0       > ldi
1627   548E ED A0       > ldi
1627   5490 ED A0       > ldi
1627   5492 ED A0       > ldi
1627   5494 ED A0       > ldi
1627   5496 ED A0       > ldi
1627   5498 ED A0       > ldi
1627   549A ED A0       > ldi
1627   549C ED A0       > ldi
1627   549E ED A0       > ldi
1627   54A0 ED A0       > ldi
1627   54A2 ED A0       > ldi
1627   54A4 ED A0       > ldi
1627   54A6 ED A0       > ldi
1627   54A8 ED A0       > ldi
1627   54AA ED A0       > ldi
1627   54AC ED A0       > ldi
1627   54AE ED A0       > ldi
1627   54B0 ED A0       > ldi
1627   54B2 ED A0       > ldi
1627   54B4 ED A0       > ldi
1627   54B6 ED A0       > ldi
1627   54B8 ED A0       > ldi
1627   54BA ED A0       > ldi
1627   54BC ED A0       > ldi
1627   54BE ED A0       > ldi
1627   54C0 ED A0       > ldi
1627   54C2 ED A0       > ldi
1627   54C4 ED A0       > ldi
1627   54C6 ED A0       > ldi
1627   54C8 ED A0       > ldi
1627   54CA ED A0       > ldi
1627   54CC ED A0       > ldi
1627   54CE ED A0       > ldi
1627   54D0 ED A0       > ldi
1627   54D2 ED A0       > ldi
1627   54D4 ED A0       > ldi
1627   54D6 ED A0       > ldi
1627   54D8 ED A0       > ldi
1627   54DA ED A0       > ldi
1627   54DC ED A0       > ldi
1627   54DE ED A0       > ldi
1627   54E0 ED A0       > ldi
1627   54E2 ED A0       > ldi
1627   54E4 ED A0       > ldi
1627   54E6 ED A0       > ldi
1627   54E8 ED A0       > ldi
1627   54EA ED A0       > ldi
1627   54EC ED A0       > ldi
1627   54EE ED A0       > ldi
1627   54F0 ED A0       > ldi
1627   54F2 ED A0       > ldi
1627   54F4 ED A0       > ldi
1627   54F6 ED A0       > ldi
1627   54F8 ED A0       > ldi
1627   54FA ED A0       > ldi
1627   54FC ED A0       > ldi
1627   54FE ED A0       > ldi
1627   5500 ED A0       > ldi
1627   5502 ED A0       > ldi
1627   5504 ED A0       > ldi
1627   5506 ED A0       > ldi
1627   5508 ED A0       > ldi
1627   550A ED A0       > ldi
1627   550C ED A0       > ldi
1627   550E ED A0       > ldi
1627   5510 ED A0       > ldi
1627   5512 ED A0       > ldi
1627   5514 ED A0       > ldi
1627   5516 ED A0       > ldi
1627   5518 ED A0       > ldi
1627   551A ED A0       > ldi
1627   551C ED A0       > ldi
1627   551E ED A0       > ldi
1627   5520 ED A0       > ldi
1627   5522 ED A0       > ldi
1627   5524 ED A0       > ldi
1627   5526 ED A0       > ldi
1627   5528 ED A0       > ldi
1627   552A ED A0       > ldi
1627   552C ED A0       > ldi
1627   552E ED A0       > ldi
1627   5530 ED A0       > ldi
1627   5532 ED A0       > ldi
1627   5534 ED A0       > ldi
1627   5536 ED A0       > ldi
1627   5538 ED A0       > ldi
1627   553A ED A0       > ldi
1627   553C ED A0       > ldi
1627   553E ED A0       > ldi
1627   5540 ED A0       > ldi
1627   5542 ED A0       > ldi
1627   5544 ED A0       > ldi
1627   5546 ED A0       > ldi
1627   5548 ED A0       > ldi
1627   554A ED A0       > ldi
1627   554C ED A0       > ldi
1627   554E ED A0       > ldi
1627   5550 ED A0       > ldi
1627   5552 ED A0       > ldi
1627   5554 ED A0       > ldi
1627   5556 ED A0       > ldi
1627   5558 ED A0       > ldi
1627   555A ED A0       > ldi
1627   555C ED A0       > ldi
1627   555E ED A0       > ldi
1627   5560 ED A0       > ldi
1627   5562 ED A0       > ldi
1627   5564 ED A0       > ldi
1627   5566 ED A0       > ldi
1627   5568 ED A0       > ldi
1627   556A ED A0       > ldi
1627   556C ED A0       > ldi
1627   556E ED A0       > ldi
1627   5570 ED A0       > ldi
1627   5572 ED A0       > ldi
1627   5574 ED A0       > ldi
1627   5576 ED A0       > ldi
1627   5578 ED A0       > ldi
1627   557A ED A0       > ldi
1627   557C ED A0       > ldi
1627   557E ED A0       > ldi
1627   5580 ED A0       > ldi
1627   5582 ED A0       > ldi
1627   5584 ED A0       > ldi
1627   5586 ED A0       > ldi
1627   5588 ED A0       > ldi
1627   558A ED A0       > ldi
1627   558C ED A0       > ldi
1627   558E ED A0       > ldi
1627   5590 ED A0       > ldi
1627   5592 ED A0       > ldi
1627   5594 ED A0       > ldi
1627   5596 ED A0       > ldi
1627   5598 ED A0       > ldi
1627   559A ED A0       > ldi
1627   559C ED A0       > ldi
1627   559E ED A0       > ldi
1627   55A0 ED A0       > ldi
1627   55A2 ED A0       > ldi
1627   55A4 ED A0       > ldi
1627   55A6 ED A0       > ldi
1627   55A8 ED A0       > ldi
1627   55AA ED A0       > ldi
1627   55AC ED A0       > ldi
1627   55AE ED A0       > ldi
1627   55B0 ED A0       > ldi
1627   55B2 ED A0       > ldi
1627   55B4 ED A0       > ldi
1628   55B6             .part2s: 
1629   55B6 3E FF       	ld	a, $FF		; envia dummy CRC
1630   55B8 32 00 40    	ld	(PORTSPI),a
1631   55BB 32 00 40    	ld	(PORTSPI),a
1632   55BE CD A1 4C    	call	WAIT_RESP_NO_FF	; esperar cartao
1633   55C1 E6 1F       	and	$1F		; testa bits erro
1634   55C3 FE 05       	cp	5
1635   55C5 37          	scf
1636   55C6 C2 D0 55    	jp	nz,terminaLeituraEscritaBloco	; resposta errada, informar erro
1637   55C9             .esp: 
1638   55C9 CD A1 4C    	call	WAIT_RESP_NO_FF	; esperar cartao
1639   55CC B7          	or	a
1640   55CD 28 FA       	jr	z,.esp
1641   55CF             .fim: 
1642   55CF AF          	xor	a		; zera carry e informa nenhum erro
1643   55D0             terminaLeituraEscritaBloco: 
1644   55D0 F5          	push	af
1645   55D1 CD 2A 4C    	call	desabilitaSDs	; desabilitar todos os cartoes
1646   55D4 F1          	pop	af
1647   55D5 C9          	ret
1648   55D6             
1649   55D6             
1650   55D6             ; ------------------------------------------------
1651   55D6             ; Ler um bloco de 512 bytes do cartao
1652   55D6             ; HL aponta para o inicio dos dados
1653   55D6             ; BC e DE contem o numero do bloco (BCDE = 32 bits)
1654   55D6             ; Destroi AF, BC, DE, HL, IXL
1655   55D6             ; ------------------------------------------------
1656   55D6             LerBloco: 
1657   55D6 DD 2D       	dec	ixl		; SDcard V1?
1658   55D8 FC 78 5E    	call	m,blocoParaByte	; Yes, convert blocks to bytes 
1659   55DB CD CD 4C    	call	setaSDAtual
1660   55DE DD 7C       	ld	a,ixh		; get Number of blocks to write
1661   55E0 3D          	dec	a
1662   55E1 CA 58 5A    	jp	z,.umBloco	; somente um bloco, pular
1663   55E4             
1664   55E4             ; multiplos blocos
1665   55E4 3E 52       	ld	a, CMD18	; CMD18 = Read Multiple Blocks
1666   55E6 CD 47 4C    	call	SD_SEND_CMD_GET_ERROR
1667   55E9 38 E5       	jr	c,terminaLeituraEscritaBloco
1668   55EB             
1669   55EB EB          	ex	de,hl		; de=destination address
1670   55EC             	; Check for a Z80 or R800
1671   55EC             ;	ld	a,20
1672   55EC 3D          	dec	a		; a=FFh
1673   55ED ED F9       	db	#ED,#F9		; mulub a,a
1674   55EF 30 32       	jr	nc,.loopZ80	; Use the Z80 optimized loop
1675   55F1             
1676   55F1 D9          	exx
1677   55F2 CD 7B 60    	call	GTR800LDIR
1678   55F5 D9          	exx			; hl'=Pointer to R800LDIR helper routine
1679   55F6             .loopR800: 
1680   55F6 06 00       	ld	b,0
1681   55F8 3A E7 00    	ld	a,(#E7)
1682   55FB 4F          	ld	c,a
1683   55FC             .rwaitFE: 
1684   55FC 3A 00 40    	ld	a,(PORTSPI)
1685   55FF FE FE       	cp	$FE
1686   5601 28 0D       	jr	z,.rFEok
1687   5603 10 F7       	djnz	.rwaitFE	; fast card wait
1688   5605 3A E7 00    	ld	a,(#E7)
1689   5608 91          	sub	c
1690   5609 FE 64       	cp	100		; 100mS?
1691   560B 38 EF       	jr	c,.rwaitFE	; slow card wait
1692   560D 37          	scf
1693   560E 18 C0       	jr	terminaLeituraEscritaBloco
1694   5610             .rFEok: 
1695   5610 21 00 40    	ld	hl,PORTSPI
1696   5613 CD 84 5E    	call	R800LDIR
1697   5616 3A 00 40    	ld	a, (PORTSPI)	; discard 16bit CRC
1698   5619 3A 00 40    	ld	a, (PORTSPI)
1699   561C DD 25       	dec	ixh		; nblocks=nblocks-1
1700   561E 20 D6       	jr	nz,.loopR800
1701   5620 C3 45 5A    	jp	.loopend
1702   5623             
1703   5623             .loopZ80: 
1704   5623 01 00 00    	ld	bc,0
1705   5626             .zwaitFE: 
1706   5626 3A 00 40    	ld	a,(PORTSPI)
1707   5629 FE FE       	cp	$FE
1708   562B 28 0A       	jr	z,.zFEok
1709   562D 10 F7       	djnz	.zwaitFE	; fast card wait
1710   562F E3          	ex	(sp),hl
1711   5630 E3          	ex	(sp),hl
1712   5631 0D          	dec	c
1713   5632 20 F2       	jr	nz,.zwaitFE	; slow card wait
1714   5634 37          	scf
1715   5635 18 99       	jr	terminaLeituraEscritaBloco
1716   5637             .zFEok: 
1717   5637 21 00 40    	ld	hl,PORTSPI
1718   563A ED A0       > ldi
1718   563C ED A0       > ldi
1718   563E ED A0       > ldi
1718   5640 ED A0       > ldi
1718   5642 ED A0       > ldi
1718   5644 ED A0       > ldi
1718   5646 ED A0       > ldi
1718   5648 ED A0       > ldi
1718   564A ED A0       > ldi
1718   564C ED A0       > ldi
1718   564E ED A0       > ldi
1718   5650 ED A0       > ldi
1718   5652 ED A0       > ldi
1718   5654 ED A0       > ldi
1718   5656 ED A0       > ldi
1718   5658 ED A0       > ldi
1718   565A ED A0       > ldi
1718   565C ED A0       > ldi
1718   565E ED A0       > ldi
1718   5660 ED A0       > ldi
1718   5662 ED A0       > ldi
1718   5664 ED A0       > ldi
1718   5666 ED A0       > ldi
1718   5668 ED A0       > ldi
1718   566A ED A0       > ldi
1718   566C ED A0       > ldi
1718   566E ED A0       > ldi
1718   5670 ED A0       > ldi
1718   5672 ED A0       > ldi
1718   5674 ED A0       > ldi
1718   5676 ED A0       > ldi
1718   5678 ED A0       > ldi
1718   567A ED A0       > ldi
1718   567C ED A0       > ldi
1718   567E ED A0       > ldi
1718   5680 ED A0       > ldi
1718   5682 ED A0       > ldi
1718   5684 ED A0       > ldi
1718   5686 ED A0       > ldi
1718   5688 ED A0       > ldi
1718   568A ED A0       > ldi
1718   568C ED A0       > ldi
1718   568E ED A0       > ldi
1718   5690 ED A0       > ldi
1718   5692 ED A0       > ldi
1718   5694 ED A0       > ldi
1718   5696 ED A0       > ldi
1718   5698 ED A0       > ldi
1718   569A ED A0       > ldi
1718   569C ED A0       > ldi
1718   569E ED A0       > ldi
1718   56A0 ED A0       > ldi
1718   56A2 ED A0       > ldi
1718   56A4 ED A0       > ldi
1718   56A6 ED A0       > ldi
1718   56A8 ED A0       > ldi
1718   56AA ED A0       > ldi
1718   56AC ED A0       > ldi
1718   56AE ED A0       > ldi
1718   56B0 ED A0       > ldi
1718   56B2 ED A0       > ldi
1718   56B4 ED A0       > ldi
1718   56B6 ED A0       > ldi
1718   56B8 ED A0       > ldi
1718   56BA ED A0       > ldi
1718   56BC ED A0       > ldi
1718   56BE ED A0       > ldi
1718   56C0 ED A0       > ldi
1718   56C2 ED A0       > ldi
1718   56C4 ED A0       > ldi
1718   56C6 ED A0       > ldi
1718   56C8 ED A0       > ldi
1718   56CA ED A0       > ldi
1718   56CC ED A0       > ldi
1718   56CE ED A0       > ldi
1718   56D0 ED A0       > ldi
1718   56D2 ED A0       > ldi
1718   56D4 ED A0       > ldi
1718   56D6 ED A0       > ldi
1718   56D8 ED A0       > ldi
1718   56DA ED A0       > ldi
1718   56DC ED A0       > ldi
1718   56DE ED A0       > ldi
1718   56E0 ED A0       > ldi
1718   56E2 ED A0       > ldi
1718   56E4 ED A0       > ldi
1718   56E6 ED A0       > ldi
1718   56E8 ED A0       > ldi
1718   56EA ED A0       > ldi
1718   56EC ED A0       > ldi
1718   56EE ED A0       > ldi
1718   56F0 ED A0       > ldi
1718   56F2 ED A0       > ldi
1718   56F4 ED A0       > ldi
1718   56F6 ED A0       > ldi
1718   56F8 ED A0       > ldi
1718   56FA ED A0       > ldi
1718   56FC ED A0       > ldi
1718   56FE ED A0       > ldi
1718   5700 ED A0       > ldi
1718   5702 ED A0       > ldi
1718   5704 ED A0       > ldi
1718   5706 ED A0       > ldi
1718   5708 ED A0       > ldi
1718   570A ED A0       > ldi
1718   570C ED A0       > ldi
1718   570E ED A0       > ldi
1718   5710 ED A0       > ldi
1718   5712 ED A0       > ldi
1718   5714 ED A0       > ldi
1718   5716 ED A0       > ldi
1718   5718 ED A0       > ldi
1718   571A ED A0       > ldi
1718   571C ED A0       > ldi
1718   571E ED A0       > ldi
1718   5720 ED A0       > ldi
1718   5722 ED A0       > ldi
1718   5724 ED A0       > ldi
1718   5726 ED A0       > ldi
1718   5728 ED A0       > ldi
1718   572A ED A0       > ldi
1718   572C ED A0       > ldi
1718   572E ED A0       > ldi
1718   5730 ED A0       > ldi
1718   5732 ED A0       > ldi
1718   5734 ED A0       > ldi
1718   5736 ED A0       > ldi
1718   5738 ED A0       > ldi
1718   573A ED A0       > ldi
1718   573C ED A0       > ldi
1718   573E ED A0       > ldi
1718   5740 ED A0       > ldi
1718   5742 ED A0       > ldi
1718   5744 ED A0       > ldi
1718   5746 ED A0       > ldi
1718   5748 ED A0       > ldi
1718   574A ED A0       > ldi
1718   574C ED A0       > ldi
1718   574E ED A0       > ldi
1718   5750 ED A0       > ldi
1718   5752 ED A0       > ldi
1718   5754 ED A0       > ldi
1718   5756 ED A0       > ldi
1718   5758 ED A0       > ldi
1718   575A ED A0       > ldi
1718   575C ED A0       > ldi
1718   575E ED A0       > ldi
1718   5760 ED A0       > ldi
1718   5762 ED A0       > ldi
1718   5764 ED A0       > ldi
1718   5766 ED A0       > ldi
1718   5768 ED A0       > ldi
1718   576A ED A0       > ldi
1718   576C ED A0       > ldi
1718   576E ED A0       > ldi
1718   5770 ED A0       > ldi
1718   5772 ED A0       > ldi
1718   5774 ED A0       > ldi
1718   5776 ED A0       > ldi
1718   5778 ED A0       > ldi
1718   577A ED A0       > ldi
1718   577C ED A0       > ldi
1718   577E ED A0       > ldi
1718   5780 ED A0       > ldi
1718   5782 ED A0       > ldi
1718   5784 ED A0       > ldi
1718   5786 ED A0       > ldi
1718   5788 ED A0       > ldi
1718   578A ED A0       > ldi
1718   578C ED A0       > ldi
1718   578E ED A0       > ldi
1718   5790 ED A0       > ldi
1718   5792 ED A0       > ldi
1718   5794 ED A0       > ldi
1718   5796 ED A0       > ldi
1718   5798 ED A0       > ldi
1718   579A ED A0       > ldi
1718   579C ED A0       > ldi
1718   579E ED A0       > ldi
1718   57A0 ED A0       > ldi
1718   57A2 ED A0       > ldi
1718   57A4 ED A0       > ldi
1718   57A6 ED A0       > ldi
1718   57A8 ED A0       > ldi
1718   57AA ED A0       > ldi
1718   57AC ED A0       > ldi
1718   57AE ED A0       > ldi
1718   57B0 ED A0       > ldi
1718   57B2 ED A0       > ldi
1718   57B4 ED A0       > ldi
1718   57B6 ED A0       > ldi
1718   57B8 ED A0       > ldi
1718   57BA ED A0       > ldi
1718   57BC ED A0       > ldi
1718   57BE ED A0       > ldi
1718   57C0 ED A0       > ldi
1718   57C2 ED A0       > ldi
1718   57C4 ED A0       > ldi
1718   57C6 ED A0       > ldi
1718   57C8 ED A0       > ldi
1718   57CA ED A0       > ldi
1718   57CC ED A0       > ldi
1718   57CE ED A0       > ldi
1718   57D0 ED A0       > ldi
1718   57D2 ED A0       > ldi
1718   57D4 ED A0       > ldi
1718   57D6 ED A0       > ldi
1718   57D8 ED A0       > ldi
1718   57DA ED A0       > ldi
1718   57DC ED A0       > ldi
1718   57DE ED A0       > ldi
1718   57E0 ED A0       > ldi
1718   57E2 ED A0       > ldi
1718   57E4 ED A0       > ldi
1718   57E6 ED A0       > ldi
1718   57E8 ED A0       > ldi
1718   57EA ED A0       > ldi
1718   57EC ED A0       > ldi
1718   57EE ED A0       > ldi
1718   57F0 ED A0       > ldi
1718   57F2 ED A0       > ldi
1718   57F4 ED A0       > ldi
1718   57F6 ED A0       > ldi
1718   57F8 ED A0       > ldi
1718   57FA ED A0       > ldi
1718   57FC ED A0       > ldi
1718   57FE ED A0       > ldi
1718   5800 ED A0       > ldi
1718   5802 ED A0       > ldi
1718   5804 ED A0       > ldi
1718   5806 ED A0       > ldi
1718   5808 ED A0       > ldi
1718   580A ED A0       > ldi
1718   580C ED A0       > ldi
1718   580E ED A0       > ldi
1718   5810 ED A0       > ldi
1718   5812 ED A0       > ldi
1718   5814 ED A0       > ldi
1718   5816 ED A0       > ldi
1718   5818 ED A0       > ldi
1718   581A ED A0       > ldi
1718   581C ED A0       > ldi
1718   581E ED A0       > ldi
1718   5820 ED A0       > ldi
1718   5822 ED A0       > ldi
1718   5824 ED A0       > ldi
1718   5826 ED A0       > ldi
1718   5828 ED A0       > ldi
1718   582A ED A0       > ldi
1718   582C ED A0       > ldi
1718   582E ED A0       > ldi
1718   5830 ED A0       > ldi
1718   5832 ED A0       > ldi
1718   5834 ED A0       > ldi
1718   5836 ED A0       > ldi
1718   5838 ED A0       > ldi
1718   583A ED A0       > ldi
1718   583C ED A0       > ldi
1718   583E ED A0       > ldi
1718   5840 ED A0       > ldi
1718   5842 ED A0       > ldi
1718   5844 ED A0       > ldi
1718   5846 ED A0       > ldi
1718   5848 ED A0       > ldi
1718   584A ED A0       > ldi
1718   584C ED A0       > ldi
1718   584E ED A0       > ldi
1718   5850 ED A0       > ldi
1718   5852 ED A0       > ldi
1718   5854 ED A0       > ldi
1718   5856 ED A0       > ldi
1718   5858 ED A0       > ldi
1718   585A ED A0       > ldi
1718   585C ED A0       > ldi
1718   585E ED A0       > ldi
1718   5860 ED A0       > ldi
1718   5862 ED A0       > ldi
1718   5864 ED A0       > ldi
1718   5866 ED A0       > ldi
1718   5868 ED A0       > ldi
1718   586A ED A0       > ldi
1718   586C ED A0       > ldi
1718   586E ED A0       > ldi
1718   5870 ED A0       > ldi
1718   5872 ED A0       > ldi
1718   5874 ED A0       > ldi
1718   5876 ED A0       > ldi
1718   5878 ED A0       > ldi
1718   587A ED A0       > ldi
1718   587C ED A0       > ldi
1718   587E ED A0       > ldi
1718   5880 ED A0       > ldi
1718   5882 ED A0       > ldi
1718   5884 ED A0       > ldi
1718   5886 ED A0       > ldi
1718   5888 ED A0       > ldi
1718   588A ED A0       > ldi
1718   588C ED A0       > ldi
1718   588E ED A0       > ldi
1718   5890 ED A0       > ldi
1718   5892 ED A0       > ldi
1718   5894 ED A0       > ldi
1718   5896 ED A0       > ldi
1718   5898 ED A0       > ldi
1718   589A ED A0       > ldi
1718   589C ED A0       > ldi
1718   589E ED A0       > ldi
1718   58A0 ED A0       > ldi
1718   58A2 ED A0       > ldi
1718   58A4 ED A0       > ldi
1718   58A6 ED A0       > ldi
1718   58A8 ED A0       > ldi
1718   58AA ED A0       > ldi
1718   58AC ED A0       > ldi
1718   58AE ED A0       > ldi
1718   58B0 ED A0       > ldi
1718   58B2 ED A0       > ldi
1718   58B4 ED A0       > ldi
1718   58B6 ED A0       > ldi
1718   58B8 ED A0       > ldi
1718   58BA ED A0       > ldi
1718   58BC ED A0       > ldi
1718   58BE ED A0       > ldi
1718   58C0 ED A0       > ldi
1718   58C2 ED A0       > ldi
1718   58C4 ED A0       > ldi
1718   58C6 ED A0       > ldi
1718   58C8 ED A0       > ldi
1718   58CA ED A0       > ldi
1718   58CC ED A0       > ldi
1718   58CE ED A0       > ldi
1718   58D0 ED A0       > ldi
1718   58D2 ED A0       > ldi
1718   58D4 ED A0       > ldi
1718   58D6 ED A0       > ldi
1718   58D8 ED A0       > ldi
1718   58DA ED A0       > ldi
1718   58DC ED A0       > ldi
1718   58DE ED A0       > ldi
1718   58E0 ED A0       > ldi
1718   58E2 ED A0       > ldi
1718   58E4 ED A0       > ldi
1718   58E6 ED A0       > ldi
1718   58E8 ED A0       > ldi
1718   58EA ED A0       > ldi
1718   58EC ED A0       > ldi
1718   58EE ED A0       > ldi
1718   58F0 ED A0       > ldi
1718   58F2 ED A0       > ldi
1718   58F4 ED A0       > ldi
1718   58F6 ED A0       > ldi
1718   58F8 ED A0       > ldi
1718   58FA ED A0       > ldi
1718   58FC ED A0       > ldi
1718   58FE ED A0       > ldi
1718   5900 ED A0       > ldi
1718   5902 ED A0       > ldi
1718   5904 ED A0       > ldi
1718   5906 ED A0       > ldi
1718   5908 ED A0       > ldi
1718   590A ED A0       > ldi
1718   590C ED A0       > ldi
1718   590E ED A0       > ldi
1718   5910 ED A0       > ldi
1718   5912 ED A0       > ldi
1718   5914 ED A0       > ldi
1718   5916 ED A0       > ldi
1718   5918 ED A0       > ldi
1718   591A ED A0       > ldi
1718   591C ED A0       > ldi
1718   591E ED A0       > ldi
1718   5920 ED A0       > ldi
1718   5922 ED A0       > ldi
1718   5924 ED A0       > ldi
1718   5926 ED A0       > ldi
1718   5928 ED A0       > ldi
1718   592A ED A0       > ldi
1718   592C ED A0       > ldi
1718   592E ED A0       > ldi
1718   5930 ED A0       > ldi
1718   5932 ED A0       > ldi
1718   5934 ED A0       > ldi
1718   5936 ED A0       > ldi
1718   5938 ED A0       > ldi
1718   593A ED A0       > ldi
1718   593C ED A0       > ldi
1718   593E ED A0       > ldi
1718   5940 ED A0       > ldi
1718   5942 ED A0       > ldi
1718   5944 ED A0       > ldi
1718   5946 ED A0       > ldi
1718   5948 ED A0       > ldi
1718   594A ED A0       > ldi
1718   594C ED A0       > ldi
1718   594E ED A0       > ldi
1718   5950 ED A0       > ldi
1718   5952 ED A0       > ldi
1718   5954 ED A0       > ldi
1718   5956 ED A0       > ldi
1718   5958 ED A0       > ldi
1718   595A ED A0       > ldi
1718   595C ED A0       > ldi
1718   595E ED A0       > ldi
1718   5960 ED A0       > ldi
1718   5962 ED A0       > ldi
1718   5964 ED A0       > ldi
1718   5966 ED A0       > ldi
1718   5968 ED A0       > ldi
1718   596A ED A0       > ldi
1718   596C ED A0       > ldi
1718   596E ED A0       > ldi
1718   5970 ED A0       > ldi
1718   5972 ED A0       > ldi
1718   5974 ED A0       > ldi
1718   5976 ED A0       > ldi
1718   5978 ED A0       > ldi
1718   597A ED A0       > ldi
1718   597C ED A0       > ldi
1718   597E ED A0       > ldi
1718   5980 ED A0       > ldi
1718   5982 ED A0       > ldi
1718   5984 ED A0       > ldi
1718   5986 ED A0       > ldi
1718   5988 ED A0       > ldi
1718   598A ED A0       > ldi
1718   598C ED A0       > ldi
1718   598E ED A0       > ldi
1718   5990 ED A0       > ldi
1718   5992 ED A0       > ldi
1718   5994 ED A0       > ldi
1718   5996 ED A0       > ldi
1718   5998 ED A0       > ldi
1718   599A ED A0       > ldi
1718   599C ED A0       > ldi
1718   599E ED A0       > ldi
1718   59A0 ED A0       > ldi
1718   59A2 ED A0       > ldi
1718   59A4 ED A0       > ldi
1718   59A6 ED A0       > ldi
1718   59A8 ED A0       > ldi
1718   59AA ED A0       > ldi
1718   59AC ED A0       > ldi
1718   59AE ED A0       > ldi
1718   59B0 ED A0       > ldi
1718   59B2 ED A0       > ldi
1718   59B4 ED A0       > ldi
1718   59B6 ED A0       > ldi
1718   59B8 ED A0       > ldi
1718   59BA ED A0       > ldi
1718   59BC ED A0       > ldi
1718   59BE ED A0       > ldi
1718   59C0 ED A0       > ldi
1718   59C2 ED A0       > ldi
1718   59C4 ED A0       > ldi
1718   59C6 ED A0       > ldi
1718   59C8 ED A0       > ldi
1718   59CA ED A0       > ldi
1718   59CC ED A0       > ldi
1718   59CE ED A0       > ldi
1718   59D0 ED A0       > ldi
1718   59D2 ED A0       > ldi
1718   59D4 ED A0       > ldi
1718   59D6 ED A0       > ldi
1718   59D8 ED A0       > ldi
1718   59DA ED A0       > ldi
1718   59DC ED A0       > ldi
1718   59DE ED A0       > ldi
1718   59E0 ED A0       > ldi
1718   59E2 ED A0       > ldi
1718   59E4 ED A0       > ldi
1718   59E6 ED A0       > ldi
1718   59E8 ED A0       > ldi
1718   59EA ED A0       > ldi
1718   59EC ED A0       > ldi
1718   59EE ED A0       > ldi
1718   59F0 ED A0       > ldi
1718   59F2 ED A0       > ldi
1718   59F4 ED A0       > ldi
1718   59F6 ED A0       > ldi
1718   59F8 ED A0       > ldi
1718   59FA ED A0       > ldi
1718   59FC ED A0       > ldi
1718   59FE ED A0       > ldi
1718   5A00 ED A0       > ldi
1718   5A02 ED A0       > ldi
1718   5A04 ED A0       > ldi
1718   5A06 ED A0       > ldi
1718   5A08 ED A0       > ldi
1718   5A0A ED A0       > ldi
1718   5A0C ED A0       > ldi
1718   5A0E ED A0       > ldi
1718   5A10 ED A0       > ldi
1718   5A12 ED A0       > ldi
1718   5A14 ED A0       > ldi
1718   5A16 ED A0       > ldi
1718   5A18 ED A0       > ldi
1718   5A1A ED A0       > ldi
1718   5A1C ED A0       > ldi
1718   5A1E ED A0       > ldi
1718   5A20 ED A0       > ldi
1718   5A22 ED A0       > ldi
1718   5A24 ED A0       > ldi
1718   5A26 ED A0       > ldi
1718   5A28 ED A0       > ldi
1718   5A2A ED A0       > ldi
1718   5A2C ED A0       > ldi
1718   5A2E ED A0       > ldi
1718   5A30 ED A0       > ldi
1718   5A32 ED A0       > ldi
1718   5A34 ED A0       > ldi
1718   5A36 ED A0       > ldi
1718   5A38 ED A0       > ldi
1719   5A3A 3A 00 40    	ld	a, (PORTSPI)	; discard 16bit CRC
1720   5A3D 3A 00 40    	ld	a, (PORTSPI)
1721   5A40 DD 25       	dec	ixh		; nblocks=nblocks-1
1722   5A42 C2 23 56    	jp	nz,.loopZ80
1723   5A45             .loopend: 
1724   5A45 3E 4C       	ld	a, CMD12	; acabou os blocos, mandar CMD12 para cancelar leitura
1725   5A47 CD 42 4C    	call	SD_SEND_CMD_NO_ARGS
1726   5A4A C3 74 5E    	jp	.fim
1727   5A4D             
1728   5A4D             .r800s: 	
1729   5A4D D9          	exx
1730   5A4E CD 7B 60    	call	GTR800LDIR
1731   5A51 D9          	exx			; hl'=Pointer to R800LDIR helper routine
1732   5A52 CD 84 5E    	call	R800LDIR
1733   5A55 C3 6E 5E    	jp	.part2s
1734   5A58             
1735   5A58             .umBloco: 
1736   5A58 3E 51       	ld	a, CMD17	; CMD17 = Read Single Block
1737   5A5A CD 47 4C    	call	SD_SEND_CMD_GET_ERROR
1738   5A5D DA D0 55    	jp	c,terminaLeituraEscritaBloco
1739   5A60             
1740   5A60 CD B0 4C    	call	WAIT_RESP_FE
1741   5A63 DA D0 55    	jp	c,terminaLeituraEscritaBloco
1742   5A66 EB          	ex	de,hl
1743   5A67             
1744   5A67             	; Check for a Z80 or R800
1745   5A67             ;	ld	a,20
1746   5A67 ED F9       	db	#ED,#F9		; mulub a,a
1747   5A69 21 00 40    	ld	hl,PORTSPI
1748   5A6C 38 DF       	jr	c,.r800s	; Use LDIR for R800
1749   5A6E ED A0       > ldi
1749   5A70 ED A0       > ldi
1749   5A72 ED A0       > ldi
1749   5A74 ED A0       > ldi
1749   5A76 ED A0       > ldi
1749   5A78 ED A0       > ldi
1749   5A7A ED A0       > ldi
1749   5A7C ED A0       > ldi
1749   5A7E ED A0       > ldi
1749   5A80 ED A0       > ldi
1749   5A82 ED A0       > ldi
1749   5A84 ED A0       > ldi
1749   5A86 ED A0       > ldi
1749   5A88 ED A0       > ldi
1749   5A8A ED A0       > ldi
1749   5A8C ED A0       > ldi
1749   5A8E ED A0       > ldi
1749   5A90 ED A0       > ldi
1749   5A92 ED A0       > ldi
1749   5A94 ED A0       > ldi
1749   5A96 ED A0       > ldi
1749   5A98 ED A0       > ldi
1749   5A9A ED A0       > ldi
1749   5A9C ED A0       > ldi
1749   5A9E ED A0       > ldi
1749   5AA0 ED A0       > ldi
1749   5AA2 ED A0       > ldi
1749   5AA4 ED A0       > ldi
1749   5AA6 ED A0       > ldi
1749   5AA8 ED A0       > ldi
1749   5AAA ED A0       > ldi
1749   5AAC ED A0       > ldi
1749   5AAE ED A0       > ldi
1749   5AB0 ED A0       > ldi
1749   5AB2 ED A0       > ldi
1749   5AB4 ED A0       > ldi
1749   5AB6 ED A0       > ldi
1749   5AB8 ED A0       > ldi
1749   5ABA ED A0       > ldi
1749   5ABC ED A0       > ldi
1749   5ABE ED A0       > ldi
1749   5AC0 ED A0       > ldi
1749   5AC2 ED A0       > ldi
1749   5AC4 ED A0       > ldi
1749   5AC6 ED A0       > ldi
1749   5AC8 ED A0       > ldi
1749   5ACA ED A0       > ldi
1749   5ACC ED A0       > ldi
1749   5ACE ED A0       > ldi
1749   5AD0 ED A0       > ldi
1749   5AD2 ED A0       > ldi
1749   5AD4 ED A0       > ldi
1749   5AD6 ED A0       > ldi
1749   5AD8 ED A0       > ldi
1749   5ADA ED A0       > ldi
1749   5ADC ED A0       > ldi
1749   5ADE ED A0       > ldi
1749   5AE0 ED A0       > ldi
1749   5AE2 ED A0       > ldi
1749   5AE4 ED A0       > ldi
1749   5AE6 ED A0       > ldi
1749   5AE8 ED A0       > ldi
1749   5AEA ED A0       > ldi
1749   5AEC ED A0       > ldi
1749   5AEE ED A0       > ldi
1749   5AF0 ED A0       > ldi
1749   5AF2 ED A0       > ldi
1749   5AF4 ED A0       > ldi
1749   5AF6 ED A0       > ldi
1749   5AF8 ED A0       > ldi
1749   5AFA ED A0       > ldi
1749   5AFC ED A0       > ldi
1749   5AFE ED A0       > ldi
1749   5B00 ED A0       > ldi
1749   5B02 ED A0       > ldi
1749   5B04 ED A0       > ldi
1749   5B06 ED A0       > ldi
1749   5B08 ED A0       > ldi
1749   5B0A ED A0       > ldi
1749   5B0C ED A0       > ldi
1749   5B0E ED A0       > ldi
1749   5B10 ED A0       > ldi
1749   5B12 ED A0       > ldi
1749   5B14 ED A0       > ldi
1749   5B16 ED A0       > ldi
1749   5B18 ED A0       > ldi
1749   5B1A ED A0       > ldi
1749   5B1C ED A0       > ldi
1749   5B1E ED A0       > ldi
1749   5B20 ED A0       > ldi
1749   5B22 ED A0       > ldi
1749   5B24 ED A0       > ldi
1749   5B26 ED A0       > ldi
1749   5B28 ED A0       > ldi
1749   5B2A ED A0       > ldi
1749   5B2C ED A0       > ldi
1749   5B2E ED A0       > ldi
1749   5B30 ED A0       > ldi
1749   5B32 ED A0       > ldi
1749   5B34 ED A0       > ldi
1749   5B36 ED A0       > ldi
1749   5B38 ED A0       > ldi
1749   5B3A ED A0       > ldi
1749   5B3C ED A0       > ldi
1749   5B3E ED A0       > ldi
1749   5B40 ED A0       > ldi
1749   5B42 ED A0       > ldi
1749   5B44 ED A0       > ldi
1749   5B46 ED A0       > ldi
1749   5B48 ED A0       > ldi
1749   5B4A ED A0       > ldi
1749   5B4C ED A0       > ldi
1749   5B4E ED A0       > ldi
1749   5B50 ED A0       > ldi
1749   5B52 ED A0       > ldi
1749   5B54 ED A0       > ldi
1749   5B56 ED A0       > ldi
1749   5B58 ED A0       > ldi
1749   5B5A ED A0       > ldi
1749   5B5C ED A0       > ldi
1749   5B5E ED A0       > ldi
1749   5B60 ED A0       > ldi
1749   5B62 ED A0       > ldi
1749   5B64 ED A0       > ldi
1749   5B66 ED A0       > ldi
1749   5B68 ED A0       > ldi
1749   5B6A ED A0       > ldi
1749   5B6C ED A0       > ldi
1749   5B6E ED A0       > ldi
1749   5B70 ED A0       > ldi
1749   5B72 ED A0       > ldi
1749   5B74 ED A0       > ldi
1749   5B76 ED A0       > ldi
1749   5B78 ED A0       > ldi
1749   5B7A ED A0       > ldi
1749   5B7C ED A0       > ldi
1749   5B7E ED A0       > ldi
1749   5B80 ED A0       > ldi
1749   5B82 ED A0       > ldi
1749   5B84 ED A0       > ldi
1749   5B86 ED A0       > ldi
1749   5B88 ED A0       > ldi
1749   5B8A ED A0       > ldi
1749   5B8C ED A0       > ldi
1749   5B8E ED A0       > ldi
1749   5B90 ED A0       > ldi
1749   5B92 ED A0       > ldi
1749   5B94 ED A0       > ldi
1749   5B96 ED A0       > ldi
1749   5B98 ED A0       > ldi
1749   5B9A ED A0       > ldi
1749   5B9C ED A0       > ldi
1749   5B9E ED A0       > ldi
1749   5BA0 ED A0       > ldi
1749   5BA2 ED A0       > ldi
1749   5BA4 ED A0       > ldi
1749   5BA6 ED A0       > ldi
1749   5BA8 ED A0       > ldi
1749   5BAA ED A0       > ldi
1749   5BAC ED A0       > ldi
1749   5BAE ED A0       > ldi
1749   5BB0 ED A0       > ldi
1749   5BB2 ED A0       > ldi
1749   5BB4 ED A0       > ldi
1749   5BB6 ED A0       > ldi
1749   5BB8 ED A0       > ldi
1749   5BBA ED A0       > ldi
1749   5BBC ED A0       > ldi
1749   5BBE ED A0       > ldi
1749   5BC0 ED A0       > ldi
1749   5BC2 ED A0       > ldi
1749   5BC4 ED A0       > ldi
1749   5BC6 ED A0       > ldi
1749   5BC8 ED A0       > ldi
1749   5BCA ED A0       > ldi
1749   5BCC ED A0       > ldi
1749   5BCE ED A0       > ldi
1749   5BD0 ED A0       > ldi
1749   5BD2 ED A0       > ldi
1749   5BD4 ED A0       > ldi
1749   5BD6 ED A0       > ldi
1749   5BD8 ED A0       > ldi
1749   5BDA ED A0       > ldi
1749   5BDC ED A0       > ldi
1749   5BDE ED A0       > ldi
1749   5BE0 ED A0       > ldi
1749   5BE2 ED A0       > ldi
1749   5BE4 ED A0       > ldi
1749   5BE6 ED A0       > ldi
1749   5BE8 ED A0       > ldi
1749   5BEA ED A0       > ldi
1749   5BEC ED A0       > ldi
1749   5BEE ED A0       > ldi
1749   5BF0 ED A0       > ldi
1749   5BF2 ED A0       > ldi
1749   5BF4 ED A0       > ldi
1749   5BF6 ED A0       > ldi
1749   5BF8 ED A0       > ldi
1749   5BFA ED A0       > ldi
1749   5BFC ED A0       > ldi
1749   5BFE ED A0       > ldi
1749   5C00 ED A0       > ldi
1749   5C02 ED A0       > ldi
1749   5C04 ED A0       > ldi
1749   5C06 ED A0       > ldi
1749   5C08 ED A0       > ldi
1749   5C0A ED A0       > ldi
1749   5C0C ED A0       > ldi
1749   5C0E ED A0       > ldi
1749   5C10 ED A0       > ldi
1749   5C12 ED A0       > ldi
1749   5C14 ED A0       > ldi
1749   5C16 ED A0       > ldi
1749   5C18 ED A0       > ldi
1749   5C1A ED A0       > ldi
1749   5C1C ED A0       > ldi
1749   5C1E ED A0       > ldi
1749   5C20 ED A0       > ldi
1749   5C22 ED A0       > ldi
1749   5C24 ED A0       > ldi
1749   5C26 ED A0       > ldi
1749   5C28 ED A0       > ldi
1749   5C2A ED A0       > ldi
1749   5C2C ED A0       > ldi
1749   5C2E ED A0       > ldi
1749   5C30 ED A0       > ldi
1749   5C32 ED A0       > ldi
1749   5C34 ED A0       > ldi
1749   5C36 ED A0       > ldi
1749   5C38 ED A0       > ldi
1749   5C3A ED A0       > ldi
1749   5C3C ED A0       > ldi
1749   5C3E ED A0       > ldi
1749   5C40 ED A0       > ldi
1749   5C42 ED A0       > ldi
1749   5C44 ED A0       > ldi
1749   5C46 ED A0       > ldi
1749   5C48 ED A0       > ldi
1749   5C4A ED A0       > ldi
1749   5C4C ED A0       > ldi
1749   5C4E ED A0       > ldi
1749   5C50 ED A0       > ldi
1749   5C52 ED A0       > ldi
1749   5C54 ED A0       > ldi
1749   5C56 ED A0       > ldi
1749   5C58 ED A0       > ldi
1749   5C5A ED A0       > ldi
1749   5C5C ED A0       > ldi
1749   5C5E ED A0       > ldi
1749   5C60 ED A0       > ldi
1749   5C62 ED A0       > ldi
1749   5C64 ED A0       > ldi
1749   5C66 ED A0       > ldi
1749   5C68 ED A0       > ldi
1749   5C6A ED A0       > ldi
1749   5C6C ED A0       > ldi
1749   5C6E ED A0       > ldi
1749   5C70 ED A0       > ldi
1749   5C72 ED A0       > ldi
1749   5C74 ED A0       > ldi
1749   5C76 ED A0       > ldi
1749   5C78 ED A0       > ldi
1749   5C7A ED A0       > ldi
1749   5C7C ED A0       > ldi
1749   5C7E ED A0       > ldi
1749   5C80 ED A0       > ldi
1749   5C82 ED A0       > ldi
1749   5C84 ED A0       > ldi
1749   5C86 ED A0       > ldi
1749   5C88 ED A0       > ldi
1749   5C8A ED A0       > ldi
1749   5C8C ED A0       > ldi
1749   5C8E ED A0       > ldi
1749   5C90 ED A0       > ldi
1749   5C92 ED A0       > ldi
1749   5C94 ED A0       > ldi
1749   5C96 ED A0       > ldi
1749   5C98 ED A0       > ldi
1749   5C9A ED A0       > ldi
1749   5C9C ED A0       > ldi
1749   5C9E ED A0       > ldi
1749   5CA0 ED A0       > ldi
1749   5CA2 ED A0       > ldi
1749   5CA4 ED A0       > ldi
1749   5CA6 ED A0       > ldi
1749   5CA8 ED A0       > ldi
1749   5CAA ED A0       > ldi
1749   5CAC ED A0       > ldi
1749   5CAE ED A0       > ldi
1749   5CB0 ED A0       > ldi
1749   5CB2 ED A0       > ldi
1749   5CB4 ED A0       > ldi
1749   5CB6 ED A0       > ldi
1749   5CB8 ED A0       > ldi
1749   5CBA ED A0       > ldi
1749   5CBC ED A0       > ldi
1749   5CBE ED A0       > ldi
1749   5CC0 ED A0       > ldi
1749   5CC2 ED A0       > ldi
1749   5CC4 ED A0       > ldi
1749   5CC6 ED A0       > ldi
1749   5CC8 ED A0       > ldi
1749   5CCA ED A0       > ldi
1749   5CCC ED A0       > ldi
1749   5CCE ED A0       > ldi
1749   5CD0 ED A0       > ldi
1749   5CD2 ED A0       > ldi
1749   5CD4 ED A0       > ldi
1749   5CD6 ED A0       > ldi
1749   5CD8 ED A0       > ldi
1749   5CDA ED A0       > ldi
1749   5CDC ED A0       > ldi
1749   5CDE ED A0       > ldi
1749   5CE0 ED A0       > ldi
1749   5CE2 ED A0       > ldi
1749   5CE4 ED A0       > ldi
1749   5CE6 ED A0       > ldi
1749   5CE8 ED A0       > ldi
1749   5CEA ED A0       > ldi
1749   5CEC ED A0       > ldi
1749   5CEE ED A0       > ldi
1749   5CF0 ED A0       > ldi
1749   5CF2 ED A0       > ldi
1749   5CF4 ED A0       > ldi
1749   5CF6 ED A0       > ldi
1749   5CF8 ED A0       > ldi
1749   5CFA ED A0       > ldi
1749   5CFC ED A0       > ldi
1749   5CFE ED A0       > ldi
1749   5D00 ED A0       > ldi
1749   5D02 ED A0       > ldi
1749   5D04 ED A0       > ldi
1749   5D06 ED A0       > ldi
1749   5D08 ED A0       > ldi
1749   5D0A ED A0       > ldi
1749   5D0C ED A0       > ldi
1749   5D0E ED A0       > ldi
1749   5D10 ED A0       > ldi
1749   5D12 ED A0       > ldi
1749   5D14 ED A0       > ldi
1749   5D16 ED A0       > ldi
1749   5D18 ED A0       > ldi
1749   5D1A ED A0       > ldi
1749   5D1C ED A0       > ldi
1749   5D1E ED A0       > ldi
1749   5D20 ED A0       > ldi
1749   5D22 ED A0       > ldi
1749   5D24 ED A0       > ldi
1749   5D26 ED A0       > ldi
1749   5D28 ED A0       > ldi
1749   5D2A ED A0       > ldi
1749   5D2C ED A0       > ldi
1749   5D2E ED A0       > ldi
1749   5D30 ED A0       > ldi
1749   5D32 ED A0       > ldi
1749   5D34 ED A0       > ldi
1749   5D36 ED A0       > ldi
1749   5D38 ED A0       > ldi
1749   5D3A ED A0       > ldi
1749   5D3C ED A0       > ldi
1749   5D3E ED A0       > ldi
1749   5D40 ED A0       > ldi
1749   5D42 ED A0       > ldi
1749   5D44 ED A0       > ldi
1749   5D46 ED A0       > ldi
1749   5D48 ED A0       > ldi
1749   5D4A ED A0       > ldi
1749   5D4C ED A0       > ldi
1749   5D4E ED A0       > ldi
1749   5D50 ED A0       > ldi
1749   5D52 ED A0       > ldi
1749   5D54 ED A0       > ldi
1749   5D56 ED A0       > ldi
1749   5D58 ED A0       > ldi
1749   5D5A ED A0       > ldi
1749   5D5C ED A0       > ldi
1749   5D5E ED A0       > ldi
1749   5D60 ED A0       > ldi
1749   5D62 ED A0       > ldi
1749   5D64 ED A0       > ldi
1749   5D66 ED A0       > ldi
1749   5D68 ED A0       > ldi
1749   5D6A ED A0       > ldi
1749   5D6C ED A0       > ldi
1749   5D6E ED A0       > ldi
1749   5D70 ED A0       > ldi
1749   5D72 ED A0       > ldi
1749   5D74 ED A0       > ldi
1749   5D76 ED A0       > ldi
1749   5D78 ED A0       > ldi
1749   5D7A ED A0       > ldi
1749   5D7C ED A0       > ldi
1749   5D7E ED A0       > ldi
1749   5D80 ED A0       > ldi
1749   5D82 ED A0       > ldi
1749   5D84 ED A0       > ldi
1749   5D86 ED A0       > ldi
1749   5D88 ED A0       > ldi
1749   5D8A ED A0       > ldi
1749   5D8C ED A0       > ldi
1749   5D8E ED A0       > ldi
1749   5D90 ED A0       > ldi
1749   5D92 ED A0       > ldi
1749   5D94 ED A0       > ldi
1749   5D96 ED A0       > ldi
1749   5D98 ED A0       > ldi
1749   5D9A ED A0       > ldi
1749   5D9C ED A0       > ldi
1749   5D9E ED A0       > ldi
1749   5DA0 ED A0       > ldi
1749   5DA2 ED A0       > ldi
1749   5DA4 ED A0       > ldi
1749   5DA6 ED A0       > ldi
1749   5DA8 ED A0       > ldi
1749   5DAA ED A0       > ldi
1749   5DAC ED A0       > ldi
1749   5DAE ED A0       > ldi
1749   5DB0 ED A0       > ldi
1749   5DB2 ED A0       > ldi
1749   5DB4 ED A0       > ldi
1749   5DB6 ED A0       > ldi
1749   5DB8 ED A0       > ldi
1749   5DBA ED A0       > ldi
1749   5DBC ED A0       > ldi
1749   5DBE ED A0       > ldi
1749   5DC0 ED A0       > ldi
1749   5DC2 ED A0       > ldi
1749   5DC4 ED A0       > ldi
1749   5DC6 ED A0       > ldi
1749   5DC8 ED A0       > ldi
1749   5DCA ED A0       > ldi
1749   5DCC ED A0       > ldi
1749   5DCE ED A0       > ldi
1749   5DD0 ED A0       > ldi
1749   5DD2 ED A0       > ldi
1749   5DD4 ED A0       > ldi
1749   5DD6 ED A0       > ldi
1749   5DD8 ED A0       > ldi
1749   5DDA ED A0       > ldi
1749   5DDC ED A0       > ldi
1749   5DDE ED A0       > ldi
1749   5DE0 ED A0       > ldi
1749   5DE2 ED A0       > ldi
1749   5DE4 ED A0       > ldi
1749   5DE6 ED A0       > ldi
1749   5DE8 ED A0       > ldi
1749   5DEA ED A0       > ldi
1749   5DEC ED A0       > ldi
1749   5DEE ED A0       > ldi
1749   5DF0 ED A0       > ldi
1749   5DF2 ED A0       > ldi
1749   5DF4 ED A0       > ldi
1749   5DF6 ED A0       > ldi
1749   5DF8 ED A0       > ldi
1749   5DFA ED A0       > ldi
1749   5DFC ED A0       > ldi
1749   5DFE ED A0       > ldi
1749   5E00 ED A0       > ldi
1749   5E02 ED A0       > ldi
1749   5E04 ED A0       > ldi
1749   5E06 ED A0       > ldi
1749   5E08 ED A0       > ldi
1749   5E0A ED A0       > ldi
1749   5E0C ED A0       > ldi
1749   5E0E ED A0       > ldi
1749   5E10 ED A0       > ldi
1749   5E12 ED A0       > ldi
1749   5E14 ED A0       > ldi
1749   5E16 ED A0       > ldi
1749   5E18 ED A0       > ldi
1749   5E1A ED A0       > ldi
1749   5E1C ED A0       > ldi
1749   5E1E ED A0       > ldi
1749   5E20 ED A0       > ldi
1749   5E22 ED A0       > ldi
1749   5E24 ED A0       > ldi
1749   5E26 ED A0       > ldi
1749   5E28 ED A0       > ldi
1749   5E2A ED A0       > ldi
1749   5E2C ED A0       > ldi
1749   5E2E ED A0       > ldi
1749   5E30 ED A0       > ldi
1749   5E32 ED A0       > ldi
1749   5E34 ED A0       > ldi
1749   5E36 ED A0       > ldi
1749   5E38 ED A0       > ldi
1749   5E3A ED A0       > ldi
1749   5E3C ED A0       > ldi
1749   5E3E ED A0       > ldi
1749   5E40 ED A0       > ldi
1749   5E42 ED A0       > ldi
1749   5E44 ED A0       > ldi
1749   5E46 ED A0       > ldi
1749   5E48 ED A0       > ldi
1749   5E4A ED A0       > ldi
1749   5E4C ED A0       > ldi
1749   5E4E ED A0       > ldi
1749   5E50 ED A0       > ldi
1749   5E52 ED A0       > ldi
1749   5E54 ED A0       > ldi
1749   5E56 ED A0       > ldi
1749   5E58 ED A0       > ldi
1749   5E5A ED A0       > ldi
1749   5E5C ED A0       > ldi
1749   5E5E ED A0       > ldi
1749   5E60 ED A0       > ldi
1749   5E62 ED A0       > ldi
1749   5E64 ED A0       > ldi
1749   5E66 ED A0       > ldi
1749   5E68 ED A0       > ldi
1749   5E6A ED A0       > ldi
1749   5E6C ED A0       > ldi
1750   5E6E             .part2s: 
1751   5E6E 3A 00 40    	ld	a, (PORTSPI)	; discard 16bit CRC
1752   5E71 3A 00 40    	ld	a, (PORTSPI)
1753   5E74             .fim: 
1754   5E74 AF          	xor	a		; zera carry para informar leitura sem erros
1755   5E75 C3 D0 55    	jp	terminaLeituraEscritaBloco
1756   5E78             
1757   5E78             
1758   5E78             ; ------------------------------------------------
1759   5E78             ; Converte blocos para bytes. Na pratica faz
1760   5E78             ; BC DE = (BC DE) * 512
1761   5E78             ; ------------------------------------------------
1762   5E78             blocoParaByte: 
1763   5E78 41          	ld	b, c
1764   5E79 4A          	ld	c, d
1765   5E7A 53          	ld	d, e
1766   5E7B 1E 00       	ld	e, 0
1767   5E7D CB 22       	sla	d
1768   5E7F CB 11       	rl	c
1769   5E81 CB 10       	rl	b
1770   5E83 C9          	ret
1771   5E84             
1772   5E84             ; ------------------------------------------------
1773   5E84             R800LDIR: 
1774   5E84 D9          	exx
1775   5E85 E9          	jp	(hl)
1776   5E86             
1777   5E86             ; ------------------------------------------------
1778   5E86             
1779   5E86             
1780   5E86             ; ========================================================================== 
1781   5E86             ; Funcoes utilitarias
1782   5E86             ; ========================================================================== 
1783   5E86             
1784   5E86             ; ------------------------------------------------
1785   5E86             ; Chaveia para modo SPI
1786   5E86             ; ------------------------------------------------
1787   5E86             modoSPI: 
1788   5E86 F5          	push	af
1789   5E87 3E 01       	ld	a, 1
1790   5E89 32 01 60    	ld	(CHAVEIASPI), a
1791   5E8C F1          	pop	af
1792   5E8D C9          	ret
1793   5E8E             
1794   5E8E             ; ------------------------------------------------
1795   5E8E             ; Chaveia para modo ROM
1796   5E8E             ; ------------------------------------------------
1797   5E8E             modoROM: 
1798   5E8E F5          	push	af
1799   5E8F 3E 00       	ld	a, 0
1800   5E91 32 01 60    	ld	(CHAVEIASPI), a
1801   5E94 F1          	pop	af
1802   5E95 C9          	ret
1803   5E96             
1804   5E96             ; ------------------------------------------------
1805   5E96             ; Imprime string na tela apontada por DE
1806   5E96             ; Destroi todos os registradores
1807   5E96             ; ------------------------------------------------
1808   5E96             printString: 
1809   5E96 1A          	ld	a, (de)
1810   5E97 B7          	or	a
1811   5E98 C8          	ret	z
1812   5E99 CD A2 00    	call	CHPUT
1813   5E9C 13          	inc	de
1814   5E9D 18 F7       	jr	printString
1815   5E9F             
1816   5E9F             
1817   5E9F             ; ------------------------------------------------
1818   5E9F             ; Converte o byte em A para string em decimal no
1819   5E9F             ; buffer apontado por DE
1820   5E9F             ; Destroi AF, BC, HL, DE, IXL
1821   5E9F             ; ------------------------------------------------
1822   5E9F             DecToAscii: 
1823   5E9F 26 00       	ld	h, 0
1824   5EA1 6F          	ld	l, a		; copiar A para HL
1825   5EA2 FD 36 39 01 	ld	(iy+WRKAREA.TEMP),1	; flag para indicar que devemos cortar os zeros a esquerda
1826   5EA6 01 9C FF    	ld	bc, -100	; centenas
1827   5EA9 CD B7 5E    	call	.num1
1828   5EAC 0E F6       	ld	c, -10		; dezenas
1829   5EAE CD B7 5E    	call	.num1
1830   5EB1 FD 36 39 02 	ld	(iy+WRKAREA.TEMP),2	; unidade deve exibir 0 se for zero e nao corta-lo
1831   5EB5 0E FF       	ld	c, -1		; unidades
1832   5EB7             .num1: 
1833   5EB7 3E 2F       	ld	a, '0'-1
1834   5EB9             .num2: 
1835   5EB9 3C          	inc	a		; contar o valor em ascii de '0' a '9'
1836   5EBA 09          	add	hl, bc		; somar com negativo
1837   5EBB 38 FC       	jr	c,.num2		; ainda nao zeramos
1838   5EBD ED 42       	sbc	hl, bc		; retoma valor original
1839   5EBF FD 35 39    	dec	(iy+WRKAREA.TEMP)	; se flag do corte do zero indicar para nao cortar, pula
1840   5EC2 20 08       	jr	nz,.naozero
1841   5EC4 FE 30       	cp	'0'		; devemos cortar os zeros a esquerda. Eh zero?
1842   5EC6 20 04       	jr	nz,.naozero
1843   5EC8 FD 34 39    	inc	(iy+WRKAREA.TEMP)	; se for zero, nao salvamos e voltamos a flag
1844   5ECB C9          	ret
1845   5ECC             .naozero: 
1846   5ECC 12          	ld	(de), a		; eh zero ou eh outro numero, salvar
1847   5ECD 13          	inc	de		; incrementa ponteiro de destino
1848   5ECE C9          	ret
1849   5ECF             
1850   5ECF             ; ------------------------------------------------
1851   5ECF             ; Converte o byte em A para string em hexa no
1852   5ECF             ; buffer apontado por DE
1853   5ECF             ; Destroi AF, C, DE
1854   5ECF             ; ------------------------------------------------
1855   5ECF             HexToAscii: 
1856   5ECF 4F          	ld	c, a
1857   5ED0 1F          	rra
1858   5ED1 1F          	rra
1859   5ED2 1F          	rra
1860   5ED3 1F          	rra
1861   5ED4 CD D8 5E    	call	.conv
1862   5ED7 79          	ld  	a, c
1863   5ED8             .conv: 
1864   5ED8 E6 0F       	and	$0F
1865   5EDA C6 90       	add	a, $90
1866   5EDC 27          	daa
1867   5EDD CE 40       	adc	a, $40
1868   5EDF 27          	daa
1869   5EE0 12          	ld	(de), a
1870   5EE1 13          	inc	de
1871   5EE2 C9          	ret
1872   5EE3             
1873   5EE3             ; ------------------------------------------------
1874   5EE3             ; Converte o byte em A para string em decimal e
1875   5EE3             ; imprime na tela
1876   5EE3             ; Destroi AF, BC, HL, DE
1877   5EE3             ; ------------------------------------------------
1878   5EE3             printDecToAscii: 
1879   5EE3 26 00       	ld	h, 0
1880   5EE5 6F          	ld	l, a		; copiar A para HL
1881   5EE6 06 01       	ld	b, 1		; flag para indicar que devemos cortar os zeros a esquerda
1882   5EE8 11 9C FF    	ld	de, -100	; centenas
1883   5EEB CD F7 5E    	call	.num1
1884   5EEE 1E F6       	ld	e, -10		; dezenas
1885   5EF0 CD F7 5E    	call	.num1
1886   5EF3 06 02       	ld	b, 2		; unidade deve exibir 0 se for zero e nao corta-lo
1887   5EF5 1E FF       	ld	e, -1		; unidades
1888   5EF7             .num1: 
1889   5EF7 3E 2F       	ld	a, '0'-1
1890   5EF9             .num2: 
1891   5EF9 3C          	inc	a		; contar o valor em ascii de '0' a '9'
1892   5EFA 19          	add	hl, de		; somar com negativo
1893   5EFB 38 FC       	jr	c,.num2		; ainda nao zeramos
1894   5EFD ED 52       	sbc	hl, de		; retoma valor original
1895   5EFF 10 06       	djnz	.naozero	; se flag do corte do zero indicar para nao cortar, pula
1896   5F01 FE 30       	cp	'0'		; devemos cortar os zeros a esquerda. Eh zero?
1897   5F03 20 02       	jr	nz,.naozero
1898   5F05 04          	inc	b		; se for zero, nao imprimimos e voltamos a flag
1899   5F06 C9          	ret
1900   5F07             .naozero: 
1901   5F07 E5          	push	hl		; nao eh zero ou eh outro numero, imprimir
1902   5F08 C5          	push	bc
1903   5F09 CD A2 00    	call	CHPUT
1904   5F0C C1          	pop	bc
1905   5F0D E1          	pop	hl
1906   5F0E C9          	ret
1907   5F0F             
1908   5F0F             ; ------------------------------------------------
1909   5F0F             ; Procura pelo nome do fabricante em uma tabela.
1910   5F0F             ; A contem o byte do fabricante
1911   5F0F             ; Devolve HL apontando para o buffer do fabricante
1912   5F0F             ; e BC com o comprimento do texto
1913   5F0F             ; Destroi AF, BC, HL
1914   5F0F             ; ------------------------------------------------
1915   5F0F             pegaFabricante: 
1916   5F0F 4F          	ld	c, a
1917   5F10 21 31 5F    	ld	hl, tblFabricantes
1918   5F13             
1919   5F13             .loop: 
1920   5F13 7E          	ld	a, (hl)
1921   5F14 23          	inc	hl
1922   5F15 B9          	cp	c
1923   5F16 28 0C       	jr	z,.achado
1924   5F18 B7          	or	a
1925   5F19 28 09       	jr	z,.achado
1926   5F1B C5          	push	bc
1927   5F1C CD 24 5F    	call	.achado
1928   5F1F 09          	add	hl, bc
1929   5F20 23          	inc	hl
1930   5F21 C1          	pop	bc
1931   5F22 18 EF       	jr	.loop
1932   5F24             
1933   5F24             .achado: 
1934   5F24 0E 00       	ld	c, 0
1935   5F26 E5          	push	hl
1936   5F27 AF          	xor	a
1937   5F28             .loop2: 
1938   5F28 0C          	inc	c
1939   5F29 23          	inc	hl
1940   5F2A BE          	cp	(hl)
1941   5F2B 20 FB       	jr	nz,.loop2
1942   5F2D E1          	pop	hl
1943   5F2E 06 00       	ld	b, 0
1944   5F30 C9          	ret
1945   5F31             
1946   5F31             tblFabricantes: 
1947   5F31 01          	db	1
1948   5F32             	db	"Panasonic",0
1948   5F32 50616E61736F6E696300
1949   5F3C 02          	db	2
1950   5F3D             	db	"Toshiba",0
1950   5F3D 546F736869626100
1951   5F45 03          	db	3
1952   5F46             	db	"SanDisk",0
1952   5F46 53616E4469736B00
1953   5F4E 04          	db	4
1954   5F4F             	db	"SMI-S",0
1954   5F4F 534D492D5300
1955   5F55 06          	db	6
1956   5F56             	db	"Renesas",0
1956   5F56 52656E6573617300
1957   5F5E 11          	db	17
1958   5F5F             	db	"Dane-Elec",0
1958   5F5F 44616E652D456C656300
1959   5F69 13          	db	19
1960   5F6A             	db	"KingMax",0
1960   5F6A 4B696E674D617800
1961   5F72 15          	db	21
1962   5F73             	db	"Samsung",0
1962   5F73 53616D73756E6700
1963   5F7B 18          	db	24
1964   5F7C             	db	"Infineon",0
1964   5F7C 496E66696E656F6E00
1965   5F85 1A          	db	26
1966   5F86 50 51 49 00 	db	"PQI",0
1967   5F8A 1B          	db	27
1968   5F8B 536F6E7900  	db	"Sony",0
1969   5F90 1C          	db	28
1970   5F91             	db	"Transcend",0
1970   5F91 5472616E7363656E6400
1971   5F9B 1D          	db	29
1972   5F9C             	db	"A-DATA",0
1972   5F9C 412D4441544100
1973   5FA3 1F          	db	31
1974   5FA4             	db	"SiliconPower",0
1974   5FA4 53696C69636F6E506F77657200
1975   5FB1 27          	db	39
1976   5FB2             	db	"Verbatim",0
1976   5FB2 566572626174696D00
1977   5FBB 41          	db	65
1978   5FBC 4F 4B 49 00 	db	"OKI",0
1979   5FC0 73          	db	115
1980   5FC1             	db	"SilverHT",0
1980   5FC1 53696C766572485400
1981   5FCA 89          	db	137
1982   5FCB             	db	"L.Data",0
1982   5FCB 4C2E4461746100
1983   5FD2 00          	db	0
1984   5FD3             	db	"Generico",0
1984   5FD3 47656E657269636F00
1985   5FDC             
1986   5FDC             
1987   5FDC             ; ------------------------------------------------
1988   5FDC             ; Restore screen parameters on MSX>=2 if they're
1989   5FDC             ; not set yet
1990   5FDC             ; ------------------------------------------------
1991   5FDC             MYSETSCR: 
1992   5FDC 3A 2D 00    	ld	a,(MSXVER)
1993   5FDF B7          	or	a			; MSX1?
1994   5FE0 CA 6C 00    	jp	z,INITXT		; Yes, change do screen-0
1995   5FE3             
1996   5FE3 0E 23       	ld	c,$23			; Block-2, R#3
1997   5FE5 DD 21 F5 01 	ld 	ix,REDCLK
1998   5FE9 CD 5F 01    	call	EXTROM
1999   5FEC E6 01       	and	1
2000   5FEE 47          	ld	b,a
2001   5FEF 3A AF FC    	ld	a,(SCRMOD)
2002   5FF2 B8          	cp	b
2003   5FF3 20 1C       	jr	nz,.restore
2004   5FF5 0C          	inc	c
2005   5FF6 DD 21 F5 01 	ld 	ix,REDCLK
2006   5FFA CD 5F 01    	call	EXTROM
2007   5FFD 47          	ld	b,a
2008   5FFE 0C          	inc	c
2009   5FFF DD 21 F5 01 	ld 	ix,REDCLK
2010   6003 CD 5F 01    	call	EXTROM
2011   6006 87          	add	a,a
2012   6007 87          	add	a,a
2013   6008 87          	add	a,a
2014   6009 87          	add	a,a
2015   600A B0          	or	b
2016   600B 47          	ld	b,a
2017   600C 3A B0 F3    	ld	a,(LINLEN)
2018   600F B8          	cp	b
2019   6010 C8          	ret	z
2020   6011             .restore: 
2021   6011 AF          	xor	a		; Don't displat the function keys
2022   6012 DD 21 85 01 	ld	ix,SDFSCR
2023   6016 C3 5F 01    	jp	EXTROM
2024   6019             
2025   6019             ; ------------------------------------------------
2026   6019             ; Check if the STOP key was signaled on DRV_INIT
2027   6019             ; ------------------------------------------------
2028   6019             INICHKSTOP: 
2029   6019 3A 9B FC    	ld	a,(INTFLG)
2030   601C FE 04       	cp	4			; Was STOP pressed?
2031   601E C0          	ret	nz			; No, quit as fast as possible 
2032   601F             
2033   601F             	; Handle STOP to pause and read messages, and ask for the copyright info
2034   601F 11 A6 60    	ld	de,strBootpaused
2035   6022 CD 96 5E    	call	printString
2036   6025 3E 07       .wait1: 	ld	a,7
2037   6027 CD 41 01    	call	SNSMAT
2038   602A E6 10       	and	$10			; Is STOP still pressed?
2039   602C 28 F7       	jr	z,.wait1		; Wait for STOP to be released
2040   602E AF          	xor	a
2041   602F 32 9B FC    	ld	(INTFLG),a		; Clear STOP flag
2042   6032 06 00       	ld	b,0			; b=inhibit 'i' key flag
2043   6034 CD 9C 00    .wait2:  call	CHSNS
2044   6037 C4 54 60    	call	nz,.chkikey		; Wait until a key is pressed
2045   603A 3A 9B FC    	ld	a,(INTFLG)
2046   603D FE 04       	cp	4			; Was STOP pressed?
2047   603F 20 F3       	jr	nz,.wait2		; No, return
2048   6041 AF          	xor	a
2049   6042 32 9B FC    	ld	(INTFLG),a		; Clear STOP flag
2050   6045 CD 56 01    	call	KILBUF
2051   6048 06 1E       	ld	b,30			; Since the user is trying pause the
2052   604A 76          .wait3: 	halt				; boot messages, this gives him enough
2053   604B             					; time to react and pause the next
2054   604B             					; driver
2055   604B 3A 9B FC    	ld	a,(INTFLG)
2056   604E FE 04       	cp	4			; Was STOP pressed?
2057   6050 C8          	ret	z			; quit so the next driver can process it
2058   6051 10 F7       	djnz	.wait3			; The user will have the impression
2059   6053             					; that he has a perfect timing.   ;)
2060   6053 C9          	ret
2061   6054             
2062   6054             .chkikey: 
2063   6054 CB 40       	bit	0,b			; Was the copyright message shown?
2064   6056 C0          	ret	nz			; Yes, return
2065   6057 CD 9F 00    	call	CHGET
2066   605A FE 69       	cp	'i'
2067   605C 28 03       	jr	z,.showcopyright
2068   605E FE 49       	cp	'I'
2069   6060 C0          	ret	nz
2070   6061             .showcopyright: 
2071   6061 04          	inc	b			; Inhibit further presses of the i key 
2072   6062 11 D6 60    	ld	de,strCopyright
2073   6065 C3 96 5E    	jp	printString
2074   6068             
2075   6068             
2076   6068             
2077   6068             ; ------------------------------------------------
2078   6068             ; Install the R800 data transfer helper routine on WorkArea 
2079   6068             ; ------------------------------------------------
2080   6068             INSTR800HLP: 
2081   6068 3A 2D 00    	ld	a,(MSXVER)
2082   606B FE 03       	cp	3		; MSX Turbo-R?
2083   606D D8          	ret	c		; No, return
2084   606E CD 7B 60    	call	GTR800LDIR
2085   6071 EB          	ex	de,hl
2086   6072 21 83 60    	ld	hl,R800DATHLP
2087   6075 01 07 00    	ld	bc,R800DATHLP.end-R800DATHLP
2088   6078 ED B0       	ldir
2089   607A C9          	ret
2090   607B             
2091   607B             ; ------------------------------------------------
2092   607B             ; Obtain the pointer to the R800 data transfer helper routine
2093   607B             ; Input   : IY=Pointer to the WorkArea
2094   607B             ; Output  : HL=pointer to R800 data transfer helper routine 
2095   607B             ; Modifies: DE
2096   607B             ; ------------------------------------------------
2097   607B             GTR800LDIR: 
2098   607B FD E5       	push	iy
2099   607D E1          	pop	hl			; hl=WorkArea
2100   607E 11 3A 00    	ld	de,WRKAREA.TRLDIR
2101   6081 19          	add	hl,de
2102   6082 C9          	ret
2103   6083             
2104   6083             ; ------------------------------------------------
2105   6083             ; R800 data transfer routine, copied to the WorkArea
2106   6083             ; ------------------------------------------------
2107   6083             R800DATHLP: 
2108   6083 D9          	exx
2109   6084 01 00 02    	ld	bc,512
2110   6087 ED B0       	ldir
2111   6089 C9          	ret
2112   608A             .end
2113   608A              
2114   608A             
2115   608A             
2116   608A             ; ==========================================================================
2117   608A             strTitle: 
2118   608A             	db	"FBLabs SDHC driver "
2118   608A 46424C61627320534448432064726976657220
2119   609D             	db	"v",VER_MAIN+$30,'.',VER_SEC+$30,'.',VER_REV+$30
2119   609D 76312E302E36
2120   60A3 0D 0A 00    	db	13,10,0
2121   60A6             
2122   60A6             strBootpaused: 
2123   60A6             	db	"Paused. Press <i> to show the copyright info.",13,10,0
2123   60A6 5061757365642E205072657373203C693E20746F2073686F772074686520636F
2123   60C6 7079726967687420696E666F2E0D0A00
2124   60D6             
2125   60D6             strCopyright: 
2126   60D6             	db	"(c) 2014 Fabio Belavenuto",13,10
2126   60D6 286329203230313420466162696F2042656C6176656E75746F0D0A
2127   60F1             	db	"(c) 2016 FRS",13,10
2127   60F1 2863292032303136204652530D0A
2128   60FF             	db	"Licenced under CERN OHL v1.1",13,10
2128   60FF 4C6963656E63656420756E646572204345524E204F484C2076312E310D0A
2129   611D             	db	"http://ohwr.org/cernohl",13,10
2129   611D 687474703A2F2F6F6877722E6F72672F6365726E6F686C0D0A
2130   6136             	db	"PCB designed by Luciano Sturaro",13,10
2130   6136 5043422064657369676E6564206279204C756369616E6F205374757261726F0D
2130   6156 0A
2131   6157             	; fall throw
2132   6157             strCrLf: 
2133   6157 0D 0A 00    	db	13,10,0
2134   615A             strCartao: 
2135   615A             	db	"Slot ",0
2135   615A 536C6F742000
2136   6160             strVazio: 
2137   6160             	db	"Empty",13,10,0
2137   6160 456D7074790D0A00
2138   6168             strNaoIdentificado: 
2139   6168             	db	"Unknown!",13,10,0
2139   6168 556E6B6E6F776E210D0A00
2140   6173             			;----------------------------------------
2141   6173             strMr_mp_desativada: 
2142   6173             	db	"Slot expander/Mapper/MegaRAM disabled",13,10,0
2142   6173 536C6F7420657870616E6465722F4D61707065722F4D65676152414D20646973
2142   6193 61626C65640D0A00
2143   619B             strMapper: 
2144   619B             	db	"Slot expanded and Memory Mapper enabled",13,10,0
2144   619B 536C6F7420657870616E64656420616E64204D656D6F7279204D617070657220
2144   61BB 656E61626C65640D0A00
2145   61C5             strMegaram: 
2146   61C5             	db	"Slot expander and MegaRAM enabled",13,10,0
2146   61C5 536C6F7420657870616E64657220616E64204D65676152414D20656E61626C65
2146   61E5 640D0A00
2147   61E9             strSDV1: 
2148   61E9             	db	"SDV1 - ",0
2148   61E9 53445631202D2000
2149   61F1             strSDV2: 
2150   61F1             	db	"SDV2 - ",0
2150   61F1 53445632202D2000
2151   61F9             
2152   61F9             ;-----------------------------------------------------------------------------
2153   61F9             ;
2154   61F9             ; End of the driver code
2155   61F9             
2156   61F9             DRV_END: 
2157   61F9             
2158   61F9 FF          	ds	3ED0h-(DRV_END-DRV_START), $FF
2159   7FD0             
2160   7FD0             
