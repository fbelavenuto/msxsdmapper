0001   0000             ; Projeto MSX SD Mapper
0002   0000             
0003   0000             ; Copyright (c) 2014 Fabio Belavenuto
0004   0000             ; Enhanced by FRS
0005   0000             
0006   0000             ; This documentation describes Open Hardware and is licensed under the CERN OHL v. 1.1.
0007   0000             ; You may redistribute and modify this documentation under the terms of the
0008   0000             ; CERN OHL v.1.1. (http://ohwr.org/cernohl). This documentation is distributed
0009   0000             ; WITHOUT ANY EXPRESS OR IMPLIED WARRANTY, INCLUDING OF MERCHANTABILITY,
0010   0000             ; SATISFACTORY QUALITY AND FITNESS FOR A PARTICULAR PURPOSE.
0011   0000             ; Please see the CERN OHL v.1.1 for applicable conditions
0012   0000             
0013   0000             ; Technical info:
0014   0000             ; 4000h~47FFh	: SPI data transfer window (read/write)
0015   0000             ; 4800h		: Interface status and card select register (read/write)
0016   0000             ;	<read>
0017   0000             ;	b0	: 0=SD card present on slot-0
0018   0000             ;	b1	: 0=SD card present on slot-1
0019   0000             ;	b2	: 0=Write protecton enabled for SD card slot-0
0020   0000             ;	b3	: 0=Write protecton enabled for SD card slot-1
0021   0000             ;	b4	: SW0 status. 0=RAM enabled, 1=RAM disabled
0022   0000             ;	b5	: SW1 status. 0=RAM mode: MegaRAM, 1=RAM mode: Memory Mapper
0023   0000             ;	b6	: Reserved for future use. Must be masked out from readings.
0024   0000             ;	b7	: 1=SPI transfer busy. 0=No ongoing SPI transfer
0025   0000             ;	<write>
0026   0000             ;	b0	: SD card slot-0 chip-select (0=selected)
0027   0000             ;	b1	: SD card slot-1 chip-select (0=selected)
0028   0000             
0029   0000             ; 6001h		: Mode configuration register (write only)
0030   0000             ;	b0	: 0=ROM mode, SPI interface disabled, 1=SPI interface enabled
0031   0000             
0032   0000             
0033   0000             
0034   0000             	output	"driver.bin"
0035   0000             
0036   0000             ;-----------------------------------------------------------------------------
0037   0000             ;
0038   0000             ; Driver configuration constants
0039   0000             ;
0040   0000             
0041   0000             ;Driver type:
0042   0000             ;   0 for drive-based
0043   0000             ;   1 for device-based
0044   0000             
0045   0000             DRV_TYPE	equ	1
0046   0000             
0047   0000             ;Hot-plug devices support (device-based drivers only):
0048   0000             ;   0 for no hot-plug support
0049   0000             ;   1 for hot-plug support
0050   0000             
0051   0000             DRV_HOTPLUG	equ	1
0052   0000             
0053   0000             DEBUG	equ	0	;Set to 1 for debugging, 0 to normal operation
0054   0000             
0055   0000             ;Driver version
0056   0000             
0057   0000             VER_MAIN	equ	1
0058   0000             VER_SEC		equ	0
0059   0000             VER_REV		equ	6
0060   0000             
0061   0000             ;-----------------------------------------------------------------------------
0062   0000             ; SPI addresses. Check the Technical info above for the bit contents
0063   0000             
0064   0000             CHAVEIASPI	= $6001 ; Mode config register
0065   0000             PORTCFG		= $4800	; Interface status and card select register 
0066   0000             PORTSPI		= $4000	; SPI data port
0067   0000             
0068   0000             ; Comandos SPI:
0069   0000             CMD0	= 0  | $40
0070   0000             CMD1	= 1  | $40
0071   0000             CMD8	= 8  | $40
0072   0000             CMD9	= 9  | $40
0073   0000             CMD10	= 10 | $40
0074   0000             CMD12	= 12 | $40
0075   0000             CMD16	= 16 | $40
0076   0000             CMD17	= 17 | $40
0077   0000             CMD18	= 18 | $40
0078   0000             CMD24	= 24 | $40
0079   0000             CMD25	= 25 | $40
0080   0000             CMD55	= 55 | $40
0081   0000             CMD58	= 58 | $40
0082   0000             ACMD23	= 23 | $40
0083   0000             ACMD41	= 41 | $40
0084   0000             
0085   0000             ; Work area variables 
0086   0000              STRUCT WRKAREA
0087   0000~            BCSD 		ds 16	; Card Specific Data
0088   0000~            BCID1		ds 16	; Card-ID of card1
0089   0000~            BCID2		ds 16	; Card-ID of card2
0090   0000~            NUMSD		db 	; Currently selected card: 1 or 2 
0091   0000~            CARDFLAGS	db 	; Flags that indicate card-change or card error 
0092   0000~            NUMBLOCKS	db 	; Number of blocks in multi-block operations 
0093   0000~            BLOCKS1		ds 3	; 3 bytes. Size of card1, in blocks.
0094   0000~            BLOCKS2		ds 3	; 3 bytes. Size of card2, in blocks.
0095   0000~            TEMP		db	; Temporary data
0096   0000~            TRLDIR		ds 8	; R800 data transfer helper 
0097   0000              ENDS
0098   0000             
0099   0000             
0100   0000             ;-----------------------------------------------------------------------------
0101   0000             ;
0102   0000             ; Standard BIOS and work area entries
0103   0000             INITXT	= $006C		; Inicializa SCREEN0
0104   0000             CHSNS	= $009C		; Sense keyboard buffer for character
0105   0000             CHGET	= $009F		; Get character from keyboard buffer
0106   0000             CHPUT	= $00A2		; A=char
0107   0000             CLS	= $00C3		; Chamar com A=0
0108   0000             ERAFNK	= $00CC		; Erase function key display
0109   0000             SNSMAT	= $0141		; Read row of keyboard matrix
0110   0000             KILBUF	= $0156		; Clear keyboard buffer
0111   0000             EXTROM	= $015F
0112   0000             
0113   0000             ; subROM functions
0114   0000             SDFSCR	= $0185
0115   0000             REDCLK	= $01F5
0116   0000             
0117   0000             
0118   0000             ; System variables
0119   0000             MSXVER	= $002D
0120   0000             LINL40	= $F3AE		; Width
0121   0000             LINLEN	= $F3B0
0122   0000             INTFLG	= $FC9B
0123   0000             SCRMOD	= $FCAF
0124   0000             
0125   0000             
0126   0000             ;-----------------------------------------------------------------------------
0127   0000             
0128   0000             
0129   0000             	org		$4000
0130   4000             
0131   4000 FF          	ds		256, $FF		; 256 dummy bytes
0132   4100             
0133   4100             DRV_START: 
0134   4100             
0135   4100             ;-----------------------------------------------------------------------------
0136   4100             ;
0137   4100             ; Miscellaneous constants
0138   4100             ;
0139   4100             
0140   4100             ;This is a 2 byte buffer to store the address of code to be executed.
0141   4100             ;It is used by some of the kernel page 0 routines.
0142   4100             
0143   4100             CODE_ADD: 	equ	0F84Ch
0144   4100             
0145   4100             
0146   4100             ;-----------------------------------------------------------------------------
0147   4100             ;
0148   4100             ; Error codes for DEV_RW
0149   4100             ;
0150   4100             
0151   4100             ENCOMP	equ	0FFh
0152   4100             EWRERR	equ	0FEh
0153   4100             EDISK	equ	0FDh
0154   4100             ENRDY	equ	0FCh
0155   4100             EDATA	equ	0FAh
0156   4100             ERNF	equ	0F9h
0157   4100             EWPROT	equ	0F8h
0158   4100             EUFORM	equ	0F7h
0159   4100             ESEEK	equ	0F3h
0160   4100             EIFORM	equ	0F0h
0161   4100             EIDEVL	equ	0B5h
0162   4100             EIPARM	equ	08Bh
0163   4100             
0164   4100             ;-----------------------------------------------------------------------------
0165   4100             ;
0166   4100             ; Routines and information available on kernel page 0
0167   4100             ;
0168   4100             
0169   4100             ;* Get in A the current slot for page 1. Corrupts F.
0170   4100             ;  Must be called by using CALBNK to bank 0:
0171   4100             ;    xor a
0172   4100             ;    ld ix,GSLOT1
0173   4100             ;    call CALBNK
0174   4100             
0175   4100             GSLOT1	equ	402Dh
0176   4100             
0177   4100             
0178   4100             ;* This routine reads a byte from another bank.
0179   4100             ;  Must be called by using CALBNK to the desired bank,
0180   4100             ;  passing the address to be read in HL:
0181   4100             ;    ld a,<bank number>
0182   4100             ;    ld hl,<byte address>
0183   4100             ;    ld ix,RDBANK
0184   4100             ;    call CALBNK
0185   4100             
0186   4100             RDBANK	equ	403Ch
0187   4100             
0188   4100             
0189   4100             ;* This routine temporarily switches kernel main bank
0190   4100             ;  (usually bank 0, but will be 3 when running in MSX-DOS 1 mode),
0191   4100             ;  then invokes the routine whose address is at (CODE_ADD).
0192   4100             ;  It is necessary to use this routine to invoke CALBAS
0193   4100             ;  (so that kernel bank is correct in case of BASIC error)
0194   4100             ;  and to invoke DOS functions via F37Dh hook.
0195   4100             ;
0196   4100             ;  Input:  Address of code to invoke in (CODE_ADD).
0197   4100             ;          AF, BC, DE, HL, IX, IY passed to the called routine.
0198   4100             ;  Output: AF, BC, DE, HL, IX, IY returned from the called routine.
0199   4100             
0200   4100             CALLB0	equ	403Fh
0201   4100             
0202   4100             
0203   4100             ;* Call a routine in another bank.
0204   4100             ;  Must be used if the driver spawns across more than one bank.
0205   4100             ;
0206   4100             ;  Input:  A = bank number
0207   4100             ;          IX = routine address
0208   4100             ;          AF' = AF for the routine
0209   4100             ;          HL' = Ix for the routine
0210   4100             ;          BC, DE, HL, IY = input for the routine
0211   4100             ;  Output: AF, BC, DE, HL, IX, IY returned from the called routine.
0212   4100             
0213   4100             CALBNK	equ	4042h
0214   4100             
0215   4100             
0216   4100             ;* Get in IX the address of the SLTWRK entry for the slot passed in A,
0217   4100             ;  which will in turn contain a pointer to the allocated page 3
0218   4100             ;  work area for that slot (0 if no work area was allocated).
0219   4100             ;  If A=0, then it uses the slot currently switched in page 1.
0220   4100             ;  Returns A=current slot for page 1, if A=0 was passed.
0221   4100             ;  Corrupts F.
0222   4100             ;  Must be called by using CALBNK to bank 0:
0223   4100             ;    ld a,<slot number> (xor a for current page 1 slot)
0224   4100             ;    ex af,af'
0225   4100             ;    xor a
0226   4100             ;    ld ix,GWORK
0227   4100             ;    call CALBNK
0228   4100             
0229   4100             GWORK	equ	4045h
0230   4100             
0231   4100             
0232   4100             ;* This address contains one byte that tells how many banks
0233   4100             ;  form the Nextor kernel (or alternatively, the first bank
0234   4100             ;  number of the driver).
0235   4100             
0236   4100             K_SIZE	equ	40FEh
0237   4100             
0238   4100             
0239   4100             ;* This address contains one byte with the current bank number.
0240   4100             
0241   4100             CUR_BANK	equ	40FFh
0242   4100             
0243   4100             
0244   4100             ;-----------------------------------------------------------------------------
0245   4100             ;
0246   4100             ; Built-in format choice strings
0247   4100             ;
0248   4100             
0249   4100             NULL_MSG  equ     781Fh	;Null string (disk can't be formatted)
0250   4100             SING_DBL  equ     7820h ;"1-Single side / 2-Double side"
0251   4100             
0252   4100             
0253   4100             ;-----------------------------------------------------------------------------
0254   4100             ;
0255   4100             ; Driver signature
0256   4100             ;
0257   4100             	db	"NEXTOR_DRIVER",0
0257   4100 4E4558544F525F44524956455200
0258   410E             
0259   410E             
0260   410E             ;-----------------------------------------------------------------------------
0261   410E             ;
0262   410E             ; Driver flags:
0263   410E             ;    bit 0: 0 for drive-based, 1 for device-based
0264   410E             ;    bit 1: 1 for hot-plug devices supported (device-based drivers only)
0265   410E             
0266   410E 03          	db 1+(2*DRV_HOTPLUG)
0267   410F             
0268   410F             ;-----------------------------------------------------------------------------
0269   410F             ;
0270   410F             ; Reserved byte
0271   410F             ;
0272   410F 00          	db	0
0273   4110             
0274   4110             ;-----------------------------------------------------------------------------
0275   4110             ;
0276   4110             ; Driver name
0277   4110             ;
0278   4110             
0279   4110             DRV_NAME: 
0280   4110             	db	"SDMapper Driver"
0280   4110 53444D617070657220447269766572
0281   411F 20          	ds	32-($-DRV_NAME)," "
0282   4130             
0283   4130             
0284   4130             ;-----------------------------------------------------------------------------
0285   4130             ;
0286   4130             ; Jump table for the driver public routines
0287   4130             ;
0288   4130             
0289   4130             	; These routines are mandatory for all drivers
0290   4130                     ; (but probably you need to implement only DRV_INIT)
0291   4130             
0292   4130 C3 6C 41    	jp	DRV_TIMI
0293   4133 C3 D7 48    	jp	DRV_VERSION
0294   4136 C3 00 48    	jp	DRV_INIT
0295   4139 C3 DE 48    	jp	DRV_BASSTAT
0296   413C C3 E0 48    	jp	DRV_BASDEV
0297   413F C3 E2 48    	jp	DRV_EXTBIO
0298   4142 C3 E3 48    	jp	DRV_DIRECT0
0299   4145 C3 E3 48    	jp	DRV_DIRECT1
0300   4148 C3 E3 48    	jp	DRV_DIRECT2
0301   414B C3 E3 48    	jp	DRV_DIRECT3
0302   414E C3 E3 48    	jp	DRV_DIRECT4
0303   4151             
0304   4151 00          	ds	15
0305   4160             
0306   4160             	; These routines are mandatory for device-based drivers
0307   4160             
0308   4160 C3 E4 48    	jp	DEV_RW
0309   4163 C3 75 49    	jp	DEV_INFO
0310   4166 C3 F8 49    	jp	DEV_STATUS
0311   4169 C3 2C 4A    	jp	LUN_INFO
0312   416C             
0313   416C             
0314   416C             ;=====
0315   416C             ;=====  END of data that must be at fixed addresses
0316   416C             ;=====
0317   416C             
0318   416C             
0319   416C             ;-----------------------------------------------------------------------------
0320   416C             ;
0321   416C             ; Timer interrupt routine, it will be called on each timer interrupt
0322   416C             ; (at 50 or 60Hz), but only if DRV_INIT returns Cy=1 on its first execution.
0323   416C             
0324   416C             DRV_TIMI: 
0325   416C C9          	ret
0326   416D             
0327   416D             
0328   416D             ; Skips the interface r/w registers 
0329   416D FF          	ds	$4800-$, $FF
0330   4800             
0331   4800             
0332   4800             ;-----------------------------------------------------------------------------
0333   4800             ;
0334   4800             ; Driver initialization routine, it is called twice:
0335   4800             ;
0336   4800             ; 1) First execution, for information gathering.
0337   4800             ;    Input:
0338   4800             ;      A = 0
0339   4800             ;      B = number of available drives
0340   4800             ;      HL = maximum size of allocatable work area in page 3
0341   4800             ;    Output:
0342   4800             ;      A = number of required drives (for drive-based driver only)
0343   4800             ;      HL = size of required work area in page 3
0344   4800             ;      Cy = 1 if DRV_TIMI must be hooked to the timer interrupt, 0 otherwise
0345   4800             ;
0346   4800             ; 2) Second execution, for work area and hardware initialization.
0347   4800             ;    Input:
0348   4800             ;      A = 1
0349   4800             ;      B = number of allocated drives for this controller
0350   4800             ;
0351   4800             ;    The work area address can be obtained by using GWORK.
0352   4800             ;
0353   4800             ;    If first execution requests more work area than available,
0354   4800             ;    second execution will not be done and DRV_TIMI will not be hooked
0355   4800             ;    to the timer interrupt.
0356   4800             ;
0357   4800             ;    If first execution requests more drives than available,
0358   4800             ;    as many drives as possible will be allocated, and the initialization
0359   4800             ;    procedure will continue the normal way
0360   4800             ;    (for drive-based drivers only. Device-based drivers always
0361   4800             ;     get two allocated drives.)
0362   4800             
0363   4800             DRV_INIT: 
0364   4800 B7          	or	a		; Is this the 1st call? 
0365   4801 20 0F       	jr	nz,.call2
0366   4803             ; 1st call:
0367   4803 21 3A 00    	ld	hl,WRKAREA.TRLDIR ; size of work area are needed for Z80
0368   4806 3A 2D 00    	ld	a,(MSXVER)
0369   4809 FE 03       	cp	3		; MSX Turbo-R?
0370   480B 3F          	ccf
0371   480C D0          	ret	nc		; No, return with Cy off
0372   480D 21 42 00    	ld	hl,WRKAREA	; size of work area are needed for TR
0373   4810 B7          	or	a		; Clear Cy
0374   4811 C9          	ret
0375   4812             
0376   4812             
0377   4812             .call2: 
0378   4812             ; 2nd call: 
0379   4812 CD DA 5F    	call	MYSETSCR		; Set the screen mode
0380   4815 CD 72 4A    	call	pegaWorkArea		; HL=IY=Work area pointer
0381   4818             
0382   4818 11 88 60    	ld	de,strTitle		; prints the title 
0383   481B CD 94 5E    	call	printString
0384   481E             
0385   481E CD B9 48    	call	SDMAPPERINIT		; SD-Mapper exclusive init
0386   4821             
0387   4821             .sdhcinit: 	; FBLabs SDHC Interface initialization
0388   4821 AF          	xor	a			; zera flags do cartao
0389   4822 FD 77 31    	ld	(iy+WRKAREA.CARDFLAGS), a
0390   4825             
0391   4825 3E 01       	ld	a, 1			; detectar cartao 1
0392   4827 CD 43 48    	call	.detecta
0393   482A 3E 02       	ld	a, 2			; detectar cartao 2
0394   482C CD 43 48    	call	.detecta
0395   482F 01 00 00    	ld	bc, 0
0396   4832 1E 05       	ld	e, 5
0397   4834 CD 8C 5E    	call	modoROM
0398   4837             
0399   4837 CD 66 60    	call	INSTR800HLP		; Install R800 data copy on workarea
0400   483A             
0401   483A CD 17 60    	call	INICHKSTOP		; Check if the STOP key was pressed
0402   483D             
0403   483D 11 55 61    	ld	de, strCrLf
0404   4840 C3 94 5E    	jp	printString
0405   4843             
0406   4843             .detecta: 
0407   4843 FD 77 30    	ld	(iy+WRKAREA.NUMSD), a		; processo de deteccao dos cartoes
0408   4846 11 58 61    	ld	de, strCartao
0409   4849 CD 94 5E    	call	printString
0410   484C FD 7E 30    	ld	a, (iy+WRKAREA.NUMSD)
0411   484F C6 30       	add	'0'
0412   4851 CD A2 00    	call	CHPUT
0413   4854 3E 3A       	ld	a, ':'
0414   4856 CD A2 00    	call	CHPUT
0415   4859 3E 20       	ld	a, ' '
0416   485B CD A2 00    	call	CHPUT
0417   485E FD 4E 30    	ld	c, (iy+WRKAREA.NUMSD)
0418   4861 3A 00 48    	ld	a, (PORTCFG)		; testar se cartao esta inserido
0419   4864 A1          	and	c			; C contem 1 se cartao 1, 2 se cartao 2
0420   4865 28 09       	jr	z,.naoVazio
0421   4867 11 5E 61    	ld	de, strVazio		; nao tem cartao no slot
0422   486A CD 94 5E    	call	printString
0423   486D C3 7E 48    	jp	.marcaErro
0424   4870             .naoVazio: 
0425   4870 CD E9 4A    	call	detectaCartao		; tem cartao no slot, inicializar e detectar
0426   4873 30 0C       	jr	nc,.detectou
0427   4875 CD 2A 4C    	call	desabilitaSDs
0428   4878 11 66 61    	ld	de, strNaoIdentificado
0429   487B CD 94 5E    	call	printString
0430   487E             .marcaErro: 
0431   487E C3 B6 4A    	jp	marcaErroCartao		; slot vazio ou erro de deteccao, marcar nas flags
0432   4881             .detectou: 
0433   4881 CD C1 4A    	call	calculaCIDoffset	; calculamos em IX a posicao correta do offset CID dependendo do cartao atual
0434   4884 DD 7E 0F    	ld	a,(ix+15)	; pegar byte SDV1 ou SDV2
0435   4887 11 E7 61    	ld	de, strSDV1	; e imprimir
0436   488A B7          	or	a
0437   488B 28 03       	jr	z,.pula1
0438   488D 11 EF 61    	ld	de, strSDV2
0439   4890             .pula1: 
0440   4890 CD 94 5E    	call	printString
0441   4893 3E 28       	ld	a,'('
0442   4895 CD A2 00    	call	CHPUT
0443   4898 DD 7E 00    	ld	a,(ix)		; pegar byte do fabricante
0444   489B CD E1 5E    	call	printDecToAscii	; Imprimir Manufacturer ID
0445   489E 3E 29       	ld	a,')'
0446   48A0 CD A2 00    	call	CHPUT
0447   48A3 3E 20       	ld	a,' '
0448   48A5 CD A2 00    	call	CHPUT
0449   48A8 DD 7E 00    	ld	a,(ix)		; pegar byte do fabricante
0450   48AB CD 0D 5F    	call	pegaFabricante	; achar nome do fabricante
0451   48AE EB          	ex	de,hl
0452   48AF CD 94 5E    	call	printString	; e imprimir
0453   48B2 11 55 61    	ld	de,strCrLf
0454   48B5 CD 94 5E    	call	printString
0455   48B8 C9          	ret
0456   48B9             
0457   48B9             
0458   48B9             SDMAPPERINIT: 		; This block is exclusive for the SD-Mapper
0459   48B9 11 71 61    	ld	de, strMr_mp_desativada
0460   48BC CD 84 5E    	call	modoSPI
0461   48BF 3A 00 48    	ld	a, (PORTCFG)		; testar se mapper/megaram esta ativa
0462   48C2 E6 10       	and	$10
0463   48C4 28 0E       	jr	z,.print		; desativada, pula
0464   48C6 11 99 61    	ld	de, strMapper
0465   48C9 3A 00 48    	ld	a, (PORTCFG)		; ativa, testar se eh mapper ou megaram
0466   48CC E6 20       	and	$20
0467   48CE C2 94 5E    	jp	nz,printString
0468   48D1 11 C3 61    	ld	de, strMegaram		; Megaram ativa
0469   48D4             .print: 
0470   48D4 C3 94 5E    	jp	printString
0471   48D7             
0472   48D7             ;-----------------------------------------------------------------------------
0473   48D7             ;
0474   48D7             ; Obtain driver version
0475   48D7             ;
0476   48D7             ; Input:  -
0477   48D7             ; Output: A = Main version number
0478   48D7             ;         B = Secondary version number
0479   48D7             ;         C = Revision number
0480   48D7             
0481   48D7             DRV_VERSION: 
0482   48D7 3E 01       	ld	a, VER_MAIN
0483   48D9 06 00       	ld	b, VER_SEC
0484   48DB 0E 06       	ld	c, VER_REV
0485   48DD C9          	ret
0486   48DE             
0487   48DE             
0488   48DE             ;-----------------------------------------------------------------------------
0489   48DE             ;
0490   48DE             ; BASIC expanded statement ("CALL") handler.
0491   48DE             ; Works the expected way, except that if invoking CALBAS is needed,
0492   48DE             ; it must be done via the CALLB0 routine in kernel page 0.
0493   48DE             
0494   48DE             DRV_BASSTAT: 
0495   48DE 37          	scf
0496   48DF C9          	ret
0497   48E0             
0498   48E0             
0499   48E0             ;-----------------------------------------------------------------------------
0500   48E0             ;
0501   48E0             ; BASIC expanded device handler.
0502   48E0             ; Works the expected way, except that if invoking CALBAS is needed,
0503   48E0             ; it must be done via the CALLB0 routine in kernel page 0.
0504   48E0             
0505   48E0             DRV_BASDEV: 
0506   48E0 37          	scf
0507   48E1 C9          	ret
0508   48E2             
0509   48E2             ;-----------------------------------------------------------------------------
0510   48E2             ;
0511   48E2             ; Extended BIOS hook.
0512   48E2             ; Works the expected way, except that it must return
0513   48E2             ; D'=1 if the old hook must be called, D'=0 otherwise.
0514   48E2             ; It is entered with D'=1.
0515   48E2             
0516   48E2             DRV_EXTBIO: 
0517   48E2 C9          	ret
0518   48E3             
0519   48E3             ;-----------------------------------------------------------------------------
0520   48E3             ;
0521   48E3             ; Direct calls entry points.
0522   48E3             ; Calls to addresses 7850h, 7853h, 7856h, 7859h and 785Ch
0523   48E3             ; in kernel banks 0 and 3 will be redirected
0524   48E3             ; to DIRECT0/1/2/3/4 respectively.
0525   48E3             ; Receives all register data from the caller except IX and AF'.
0526   48E3             
0527   48E3             DRV_DIRECT0: 
0528   48E3             DRV_DIRECT1: 
0529   48E3             DRV_DIRECT2: 
0530   48E3             DRV_DIRECT3: 
0531   48E3             DRV_DIRECT4: 
0532   48E3 C9          	ret
0533   48E4             
0534   48E4             
0535   48E4             ;=====
0536   48E4             ;=====  BEGIN of DEVICE-BASED specific routines
0537   48E4             ;=====
0538   48E4             
0539   48E4             ;-----------------------------------------------------------------------------
0540   48E4             ;
0541   48E4             ; Read or write logical sectors from/to a logical unit
0542   48E4             ;
0543   48E4             ;Input:    Cy=0 to read, 1 to write
0544   48E4             ;          A = Device number, 1 to 7
0545   48E4             ;          B = Number of sectors to read or write
0546   48E4             ;          C = Logical unit number, 1 to 7
0547   48E4             ;          HL = Source or destination memory address for the transfer
0548   48E4             ;          DE = Address where the 4 byte sector number is stored.
0549   48E4             ;Output:   A = Error code (the same codes of MSX-DOS are used):
0550   48E4             ;              0: Ok
0551   48E4             ;              .IDEVL: Invalid device or LUN
0552   48E4             ;              .NRDY: Not ready
0553   48E4             ;              .DISK: General unknown disk error
0554   48E4             ;              .DATA: CRC error when reading
0555   48E4             ;              .RNF: Sector not found
0556   48E4             ;              .UFORM: Unformatted disk
0557   48E4             ;              .WPROT: Write protected media, or read-only logical unit
0558   48E4             ;              .WRERR: Write error
0559   48E4             ;              .NCOMP: Incompatible disk.
0560   48E4             ;              .SEEK: Seek error.
0561   48E4             ;          B = Number of sectors actually read (in case of error only)
0562   48E4             
0563   48E4             DEV_RW: 
0564   48E4 F5          	push	af
0565   48E6 BF FE 03    	cp	a, 3		; somente 2 dispositivos
0566   48E8 30 10       	jr	nc,.saicomerroidl
0567   48EA 0D          	dec	c		; somente 1 logical unit
0568   48EB 20 0D       	jr	nz,.saicomerroidl
0569   48ED E5          	push	hl
0570   48EE CD 8B 4A    	call	testaCartao	; verificar se cartao esta OK
0571   48F1 E1          	pop	hl
0572   48F2 30 0C       	jr	nc,.ok
0573   48F4 F1          	pop	af
0574   48F5 3E FC       	ld	a, ENRDY	; Not ready
0575   48F7             ;	ld	a, EDISK	; General unknown disk error
0576   48F7 06 00       	ld	b, 0
0577   48F9 C9          	ret
0578   48FA             .saicomerroidl: 
0579   48FA F1          	pop	af
0580   48FB 3E B5       	ld	a, EIDEVL	; error: Invalid device or LUN 
0581   48FD 06 00       	ld	b, 0
0582   48FF C9          	ret
0583   4900             .ok: 
0584   4900 FD 70 32    	ld	(iy+WRKAREA.NUMBLOCKS), b	; save the number of blocks to transfer 
0585   4903 D9          	exx
0586   4904 CD C1 4A    	call	calculaCIDoffset	; ix=CID offset 
0587   4907 DD 7E 0F    	ld	a,(ix+15)	; verificar se eh SDV1 ou SDV2
0588   490A DD 6F       	ld	ixl,a		; ixl=SDcard version
0589   490C F1          	pop	af		; a=Device number, f=read/write flag 
0590   490D D9          	exx			; hl=Source/dest Address, de=Pointer to sect#
0591   490E DD 60       	ld	ixh, b 		; ixh=Number of blocks to transfer
0592   4910 38 28       	jr	c,escrita	; Skip if it's a write operation 
0593   4912             leitura: 
0594   4912 1A          	ld	a, (de)		; 1. n. bloco
0595   4913 F5          	push	af
0596   4914 13          	inc	de
0597   4915 1A          	ld	a, (de)		; 2. n. bloco
0598   4916 F5          	push	af
0599   4917 13          	inc	de
0600   4918 1A          	ld	a, (de)		; 3. n. bloco
0601   4919 4F          	ld	c, a
0602   491A 13          	inc	de
0603   491B 1A          	ld	a, (de)		; 4. n. bloco
0604   491C 13          	inc	de
0605   491D 47          	ld	b, a
0606   491E F1          	pop	af
0607   491F 57          	ld	d, a
0608   4920 F1          	pop	af		; HL = ponteiro destino
0609   4921 5F          	ld	e, a		; BC DE = 32 bits numero do bloco
0610   4922 CD 84 5E    	call	modoSPI
0611   4925 CD D4 55    	call	LerBloco	; chamar rotina de leitura de dados
0612   4928 CD 8C 5E    	call	modoROM
0613   492B 30 0B       	jr	nc,.ok
0614   492D CD B6 4A    	call	marcaErroCartao		; ocorreu erro na leitura, marcar erro
0615   4930 FD 7E 32    	ld	a,(iy+WRKAREA.NUMBLOCKS) ; Get the number of requested blocks
0616   4933 DD 94       	sub	ixh		; subtract the number of remaining blocks
0617   4935 47          	ld	b,a		; b=number of blocks read
0618   4936             ;	ld	a, ENRDY	; Not ready
0619   4936 3E FD       	ld	a, EDISK	; General unknown disk error
0620   4938             .ok: 
0621   4938 AF          	xor	a		; tudo OK, informar ao Nextor
0622   4939 C9          	ret
0623   493A             
0624   493A             escrita: 
0625   493A CD 84 5E    	call	modoSPI
0626   493D             	; Test if the card is write protected
0627   493D FD 4E 30    	ld	c,(iy+WRKAREA.NUMSD)	; cartao atual (1 ou 2)
0628   4940 CB 21       	sla	c		; desloca para apontar para bits 2 ou 3 para cartoes 1 ou 2 respectivamente
0629   4942 CB 21       	sla	c
0630   4944 3A 00 48    	ld	a,(PORTCFG)	; testar se cartao esta protegido
0631   4947 A1          	and	c
0632   4948 28 05       	jr	z,.ok
0633   494A 3E F8       	ld	a, EWPROT	; disco protegido
0634   494C 06 00       	ld	b,0		; 0 blocks were written
0635   494E C9          	ret
0636   494F             .ok: 
0637   494F 1A          	ld	a, (de)		; 1. n. bloco
0638   4950 F5          	push	af
0639   4951 13          	inc	de
0640   4952 1A          	ld	a, (de)		; 2. n. bloco
0641   4953 F5          	push	af
0642   4954 13          	inc	de
0643   4955 1A          	ld	a, (de)		; 3. n. bloco
0644   4956 13          	inc	de
0645   4957 4F          	ld	c, a
0646   4958 1A          	ld	a, (de)		; 4. n. bloco
0647   4959 13          	inc	de
0648   495A 47          	ld	b, a
0649   495B F1          	pop	af
0650   495C 57          	ld	d, a
0651   495D F1          	pop	af		; HL = ponteiro destino
0652   495E 5F          	ld	e, a		; BC DE = 32 bits numero do bloco
0653   495F CD D8 4C    	call	GravarBloco	; chamar rotina de gravacao de dados
0654   4962 CD 8C 5E    	call	modoROM
0655   4965 30 0C       	jr	nc,.ok2
0656   4967 CD B6 4A    	call	marcaErroCartao		; ocorreu erro, marcar nas flags
0657   496A FD 7E 32    	ld	a,(iy+WRKAREA.NUMBLOCKS) ; Get the number of requested blocks
0658   496D DD 94       	sub	ixh		; subtract the number of remaining blocks
0659   496F 47          	ld	b,a		; b=number of blocks written
0660   4970 3E FE       	ld	a,EWRERR	; Write error
0661   4972 C9          	ret
0662   4973             .ok2: 
0663   4973 AF          	xor	a			; gravacao sem erros!
0664   4974 C9          	ret
0665   4975             
0666   4975             ;-----------------------------------------------------------------------------
0667   4975             ;
0668   4975             ; Device information gathering
0669   4975             ;
0670   4975             ;Input:   A = Device index, 1 to 7
0671   4975             ;         B = Information to return:
0672   4975             ;             0: Basic information
0673   4975             ;             1: Manufacturer name string
0674   4975             ;             2: Device name string
0675   4975             ;             3: Serial number string
0676   4975             ;         HL = Pointer to a buffer in RAM
0677   4975             ;Output:  A = Error code:
0678   4975             ;             0: Ok
0679   4975             ;             1: Device not available or invalid device index
0680   4975             ;             2: Information not available, or invalid information index
0681   4975             ;         When basic information is requested,
0682   4975             ;         buffer filled with the following information:
0683   4975             ;
0684   4975             ;+0 (1): Numer of logical units, from 1 to 7. 1 if the device has no logical
0685   4975             ;        units (which is functionally equivalent to having only one).
0686   4975             ;+1 (1): Device flags, always zero in Beta 2.
0687   4975             ;
0688   4975             ; The strings must be printable ASCII string (ASCII codes 32 to 126),
0689   4975             ; left justified and padded with spaces. All the strings are optional,
0690   4975             ; if not available, an error must be returned.
0691   4975             ; If a string is provided by the device in binary format, it must be reported
0692   4975             ; as an hexadecimal, upper-cased string, preceded by the prefix "0x".
0693   4975             ; The maximum length for a string is 64 characters;
0694   4975             ; if the string is actually longer, the leftmost 64 characters
0695   4975             ; should be provided.
0696   4975             ;
0697   4975             ; In the case of the serial number string, the same rules for the strings
0698   4975             ; apply, except that it must be provided right-justified,
0699   4975             ; and if it is too long, the rightmost characters must be
0700   4975             ; provided, not the leftmost.
0701   4975             
0702   4975             DEV_INFO: 
0703   4975 04          	inc	b
0704   4977 BF FE 03    	cp	a,3		; somente 2 dispositivos
0705   4979 30 07       	jr	nc,.saicomerro
0706   497B E5          	push	hl
0707   497C CD 8B 4A    	call	testaCartao	; verificar se cartao esta OK
0708   497F E1          	pop	hl
0709   4980 30 03       	jr	nc,.ok		; nao houve erro
0710   4982             .saicomerro: 
0711   4982 3E 02       	ld	a,2		; informar erro
0712   4984 C9          	ret
0713   4985             
0714   4985             .ok: 
0715   4985 10 06       	djnz	.naoBasic
0716   4987             
0717   4987             ; Basic information:
0718   4987 36 01       	ld	(hl), 1		; 1 logical unit somente
0719   4989 23          	inc	hl
0720   498A 36 00       	ld	(hl), 0		; reservado, deve ser 0
0721   498C C9          	ret			; retorna com A=0 (OK)
0722   498D             
0723   498D             .naoBasic: 
0724   498D E5          	push	hl
0725   498E CD C1 4A    	call	calculaCIDoffset	; calculamos em IX a posicao correta do offset CID dependendo do cartao atual
0726   4991 E1          	pop	hl
0727   4992             
0728   4992 10 25       	djnz	.naoManuf
0729   4994             ; Manufacturer Name:
0730   4994 E5          	push	hl		; salva ponteiro do buffer
0731   4995 06 40       	ld	b, 64		; preenche buffer com espaco
0732   4997 3E 20       	ld	a, ' '
0733   4999             .loop1: 
0734   4999 77          	ld	(hl), a
0735   499A 23          	inc	hl
0736   499B 10 FC       	djnz	.loop1
0737   499D D1          	pop	de		; recuperamos ponteiro do buffer em DE
0738   499E 3E 28       	ld	a, '('		; colocamos (xx) xxx no buffer
0739   49A0 12          	ld	(de), a
0740   49A1 13          	inc	de
0741   49A2 DD 7E 00    	ld	a, (ix)		; byte do fabricante
0742   49A5 CD 9D 5E    	call	DecToAscii
0743   49A8 3E 29       	ld	a, ')'
0744   49AA 12          	ld	(de), a
0745   49AB 13          	inc	de
0746   49AC 3E 20       	ld	a, ' '
0747   49AE 12          	ld	(de), a
0748   49AF 13          	inc	de
0749   49B0 DD 7E 00    	ld	a, (ix)		; byte do fabricante
0750   49B3 CD 0D 5F    	call	pegaFabricante	; pegar nome do fabricante em HL
0751   49B6 ED B0       	ldir			; e colocar no buffer
0752   49B8 C9          	ret
0753   49B9             
0754   49B9             .naoManuf: 
0755   49B9 10 1A       	djnz	.naoProduct
0756   49BB             ; Product Name:
0757   49BB E5          	push	hl		; guarda HL que aponta para buffer do Nextor
0758   49BC DD E5       	push	ix
0759   49BE E1          	pop	hl		; joga IX para HL
0760   49BF 16 00       	ld	d, 0
0761   49C1 1E 03       	ld	e, 3		; adiciona offset do productname em HL
0762   49C3 19          	add	hl, de
0763   49C4 D1          	pop	de		; recupera buffer do Nextor em DE
0764   49C5 01 05 00    	ld	bc, 5		; 5 caracteres
0765   49C8 ED B0       	ldir			; copia nome do produto
0766   49CA EB          	ex	de,hl		; troca DE com HL, agora HL aponta para Buffer do nextor atualizado
0767   49CB 06 3B       	ld	b, 59		; Coloca espaco no restante do buffer
0768   49CD 3E 20       	ld	a, ' '
0769   49CF             .loop2: 
0770   49CF 77          	ld	(hl), a
0771   49D0 23          	inc	hl
0772   49D1 10 FC       	djnz	.loop2
0773   49D3 AF          	xor	a		; informar sem erros
0774   49D4 C9          	ret
0775   49D5             
0776   49D5             .naoProduct: 
0777   49D5             ; Serial Number:
0778   49D5 36 30       	ld	(hl),'0'	; Coloca prefixo "0x"
0779   49D7 23          	inc	hl
0780   49D8 36 78       	ld	(hl), 'x'
0781   49DA 23          	inc	hl
0782   49DB E5          	push	hl		; guarda HL que aponta para buffer do Nextor
0783   49DC DD E5       	push	ix
0784   49DE E1          	pop	hl		; joga IX para HL
0785   49DF 16 00       	ld	d, 0
0786   49E1 1E 09       	ld	e, 9		; adiciona offset do productname em HL
0787   49E3 19          	add	hl, de
0788   49E4 D1          	pop	de		; recupera buffer do nextor em DE
0789   49E5 06 04       	ld	b, 4		; 4 bytes do serial
0790   49E7             .loop3: 
0791   49E7 7E          	ld	a, (hl)
0792   49E8 CD CD 5E    	call	HexToAscii	; converter HEXA para ASCII
0793   49EB 23          	inc	hl
0794   49EC 10 F9       	djnz	.loop3
0795   49EE 06 36       	ld	b, 54		; Coloca espaco no restante
0796   49F0 3E 20       	ld	a, ' '
0797   49F2             .loop4: 
0798   49F2 12          	ld	(de), a
0799   49F3 13          	inc	de
0800   49F4 10 FC       	djnz	.loop4
0801   49F6 AF          	xor	a		; informar sem erros
0802   49F7 C9          	ret
0803   49F8             
0804   49F8             ;-----------------------------------------------------------------------------
0805   49F8             ;
0806   49F8             ; Obtain device status
0807   49F8             ;
0808   49F8             ;Input:   A = Device index, 1 to 7
0809   49F8             ;         B = Logical unit number, 1 to 7
0810   49F8             ;             0 to return the status of the device itself.
0811   49F8             ;Output:  A = Status for the specified logical unit,
0812   49F8             ;             or for the whole device if 0 was specified:
0813   49F8             ;                0: The device or logical unit is not available, or the
0814   49F8             ;                   device or logical unit number supplied is invalid.
0815   49F8             ;                1: The device or logical unit is available and has not
0816   49F8             ;                   changed since the last status request.
0817   49F8             ;                2: The device or logical unit is available and has changed
0818   49F8             ;                   since the last status request
0819   49F8             ;                   (for devices, the device has been unplugged and a
0820   49F8             ;                    different device has been plugged which has been
0821   49F8             ;                    assigned the same device index; for logical units,
0822   49F8             ;                    the media has been changed).
0823   49F8             ;                3: The device or logical unit is available, but it is not
0824   49F8             ;                   possible to determine whether it has been changed
0825   49F8             ;                   or not since the last status request.
0826   49F8             ;
0827   49F8             ; Devices not supporting hot-plugging must always return status value 1.
0828   49F8             ; Non removable logical units may return values 0 and 1.
0829   49F8             ;
0830   49F8             ; The returned status is always relative to the previous invokation of
0831   49F8             ; DEV_STATUS itself. Please read the Driver Developer Guide for more info.
0832   49F8             
0833   49F8             DEV_STATUS: 
0834   49F9 BF FE 03    	cp	a,3		; 2 dispositivos somente
0835   49FB 30 2C       	jr	nc,.saicomerro
0836   49FD 05          	dec	b		; 1 logical unit somente
0837   49FE 20 29       	jr	nz,.saicomerro
0838   4A00 F5          	push	af
0839   4A01 CD 72 4A    	call	pegaWorkArea	; HL=IY=Work area pointer
0840   4A04 F1          	pop	af
0841   4A05 FD 77 30    	ld	(iy+WRKAREA.NUMSD),a	; salva numero do device atual (1 ou 2)
0842   4A08 4F          	ld	c,a		; c=device number
0843   4A09 CD 84 5E    	call	modoSPI
0844   4A0C 3A 00 48    	ld	a, (PORTCFG)	; testar se cartao esta inserido
0845   4A0F CD 8C 5E    	call	modoROM
0846   4A12 A1          	and	c		; C contem 1 se cartao 1, 2 se cartao 2
0847   4A13 20 11       	jr	nz,.cartaoAusente	; se slot do cartao estiver vazio, marcamos o erro nas flags
0848   4A15             	;***FixMe: Disk change detection doesn't work
0849   4A15             	; Will have to check both the hardware disk-change and the software
0850   4A15             	; disk-change reported by LUN_NFO
0851   4A15 CD 84 5E    	call	modoSPI
0852   4A18 CD E9 4A    	call	detectaCartao	; erro na deteccao do cartao, tentar re-detectar
0853   4A1B CD 8C 5E    	call	modoROM
0854   4A1E 38 06       	jr	c,.cartaoComErro	; nao conseguimos detectar, sai com erro
0855   4A20             
0856   4A20             .semMudanca: 
0857   4A20 3E 01       	ld	a, 1		; informa ao Nextor que cartao esta OK e nao mudou
0858   4A22 C9          	ret
0859   4A23             .comMudanca: 
0860   4A23 3E 02       	ld	a, 2		; informa ao Nextor que cartao esta OK e mudou
0861   4A25 C9          	ret
0862   4A26             .cartaoComErro: 
0863   4A26             .cartaoAusente: 
0864   4A26 CD B6 4A    	call	marcaErroCartao	; marcar erro do cartao nas flags
0865   4A29             .saicomerro: 
0866   4A29 3E 00       	ld	a, 0		; informa erro
0867   4A2B C9          	ret
0868   4A2C             
0869   4A2C             ;-----------------------------------------------------------------------------
0870   4A2C             ;
0871   4A2C             ; Obtain logical unit information
0872   4A2C             ;
0873   4A2C             ;Input:   A  = Device index, 1 to 7
0874   4A2C             ;         B  = Logical unit number, 1 to 7
0875   4A2C             ;         HL = Pointer to buffer in RAM.
0876   4A2C             ;Output:  A = 0: Ok, buffer filled with information.
0877   4A2C             ;             1: Error, device or logical unit not available,
0878   4A2C             ;                or device index or logical unit number invalid.
0879   4A2C             ;         On success, buffer filled with the following information:
0880   4A2C             ;
0881   4A2C             ;+0 (1): Medium type:
0882   4A2C             ;        0: Block device
0883   4A2C             ;        1: CD or DVD reader or recorder
0884   4A2C             ;        2-254: Unused. Additional codes may be defined in the future.
0885   4A2C             ;        255: Other
0886   4A2C             ;+1 (2): Sector size, 0 if this information does not apply or is
0887   4A2C             ;        not available.
0888   4A2C             ;+3 (4): Total number of available sectors.
0889   4A2C             ;        0 if this information does not apply or is not available.
0890   4A2C             ;+7 (1): Flags:
0891   4A2C             ;        bit 0: 1 if the medium is removable.
0892   4A2C             ;        bit 1: 1 if the medium is read only. A medium that can dinamically
0893   4A2C             ;               be write protected or write enabled is not considered
0894   4A2C             ;               to be read-only.
0895   4A2C             ;        bit 2: 1 if the LUN is a floppy disk drive.
0896   4A2C             ;+8 (2): Number of cylinders
0897   4A2C             ;+10 (1): Number of heads
0898   4A2C             ;+11 (1): Number of sectors per track
0899   4A2C             ;
0900   4A2C             ; Number of cylinders, heads and sectors apply to hard disks only.
0901   4A2C             ; For other types of device, these fields must be zero.
0902   4A2C             
0903   4A2C             LUN_INFO: 
0904   4A2D BF FE 03    	cp	a, 3		; somente 2 dispositivo
0905   4A2F 30 0A       	jr	nc,.saicomerro
0906   4A31 05          	dec	b		; somente 1 logical unit
0907   4A32 20 07       	jr	nz,.saicomerro
0908   4A34 E5          	push	hl
0909   4A35 CD 8B 4A    	call	testaCartao
0910   4A38 E1          	pop	hl
0911   4A39 30 03       	jr	nc,.ok		; nao tem erro com o cartao
0912   4A3B             .saicomerro: 
0913   4A3B 3E 01       	ld	a, 1		; informar erro
0914   4A3D C9          	ret
0915   4A3E             .ok: 
0916   4A3E D9          	exx	
0917   4A3F             	; ***FixMe: Will have to check disk-change, and daisy chain this as a
0918   4A3F             	; software flag so DEV_STATUS can also be notified
0919   4A3F CD 84 5E    	call	modoSPI
0920   4A42 CD E9 4A    	call	detectaCartao	; erro na deteccao do cartao, tentar re-detectar
0921   4A45 CD 8C 5E    	call	modoROM
0922   4A48 38 F1       	jr	c,.saicomerro
0923   4A4A CD D5 4A    	call	calculaBLOCOSoffset	; calcular em IX e HL o offset correto do buffer que armazena total de blocos
0924   4A4D D9          	exx			; do cartao dependendo do cartao atual solicitado
0925   4A4E AF          	xor	a
0926   4A4F 77          	ld	(hl),a		; Informar que o dispositivo eh do tipo block device
0927   4A50 23          	inc	hl
0928   4A51 77          	ld	(hl),a		; block size: 512 bytes (0200h)
0929   4A52 23          	inc	hl
0930   4A53 36 02       	ld	(hl),2
0931   4A55 23          	inc	hl
0932   4A56 DD 7E 00    	ld	a, (ix)		; copia numero de blocos total
0933   4A59 77          	ld	(hl), a
0934   4A5A 23          	inc	hl
0935   4A5B DD 7E 01    	ld	a, (ix+1)
0936   4A5E 77          	ld	(hl), a
0937   4A5F 23          	inc	hl
0938   4A60 DD 7E 02    	ld	a, (ix+2)
0939   4A63 77          	ld	(hl), a
0940   4A64 23          	inc	hl
0941   4A65 36 00       	ld	(hl),0		; The highest byte must be set to 0, as SDcards
0942   4A67             				; have 24bit total block numbers, and Nextor
0943   4A67             				; requires 32bits. 
0944   4A67 23          	inc	hl
0945   4A68 36 01       	ld	(hl),1		; flags: dispositivo R/W removivel
0946   4A6A 23          	inc	hl
0947   4A6B AF          	xor	a		; CHS = 0
0948   4A6C 77          	ld	(hl), a
0949   4A6D 23          	inc	hl
0950   4A6E 77          	ld	(hl), a
0951   4A6F 23          	inc	hl
0952   4A70 77          	ld	(hl), a
0953   4A71             ;	xor	a		; informar que dados foram preenchidos
0954   4A71 C9          	ret
0955   4A72             
0956   4A72             ;=====
0957   4A72             ;=====  END of DEVICE-BASED specific routines
0958   4A72             ;=====
0959   4A72             
0960   4A72             ;------------------------------------------------
0961   4A72             ; Rotinas auxiliares
0962   4A72             ;------------------------------------------------
0963   4A72             
0964   4A72             ;------------------------------------------------
0965   4A72             ; Pedir ao Nextor o ponteiro de dados de trabalho
0966   4A72             ; na RAM e colocar em HL e IY
0967   4A72             ; Destroi HL e IY
0968   4A72             ;------------------------------------------------
0969   4A72             pegaWorkArea: 
0970   4A72 F5          	push	af
0971   4A73 AF          	xor	a		; Pegar endereco da area de trabalho
0972   4A74 08          	ex	af,af'
0973   4A75 AF          	xor	a
0974   4A76 DD 21 45 40 	ld	ix, GWORK
0975   4A7A CD 8C 5E    	call	modoROM
0976   4A7D CD 42 40    	call	CALBNK
0977   4A80 DD 6E 00    	ld	l,(ix)		; em HL tem o ponteiro da nossa area da RAM
0978   4A83 DD 66 01    	ld	h,(ix+1)
0979   4A86 E5          	push	hl
0980   4A87 FD E1       	pop	iy		; em IY temos o mesmo ponteiro
0981   4A89 F1          	pop	af
0982   4A8A C9          	ret
0983   4A8B             
0984   4A8B             ;------------------------------------------------
0985   4A8B             ; Testa se cartao esta inserido e/ou houve erro
0986   4A8B             ; na ultima vez que foi acessado. Carry indica
0987   4A8B             ; erro
0988   4A8B             ; Destroi AF, HL, IX, C
0989   4A8B             ;------------------------------------------------
0990   4A8B             testaCartao: 
0991   4A8B F5          	push	af
0992   4A8C CD 72 4A    	call	pegaWorkArea	; HL=IY=Work area pointer
0993   4A8F F1          	pop	af
0994   4A90 FD 77 30    	ld	(iy+WRKAREA.NUMSD), a	; salva numero do device atual (1 ou 2)
0995   4A93 4F          	ld	c, a
0996   4A94 CD 84 5E    	call	modoSPI
0997   4A97 3A 00 48    	ld	a, (PORTCFG)	; testar se cartao esta inserido
0998   4A9A CD 8C 5E    	call	modoROM
0999   4A9D A1          	and	c		; C contem 1 se cartao 1, 2 se cartao 2
1000   4A9E 20 0D       	jr	nz,.saicomerro				
1001   4AA0 FD 7E 30    	ld	a, (iy+WRKAREA.NUMSD)		; conseguimos detectar, tira erro nas flags
1002   4AA3 2F          	cpl			; inverte bits para fazer o AND
1003   4AA4 4F          	ld	c, a
1004   4AA5 FD 7E 31    	ld	a, (iy+WRKAREA.CARDFLAGS)
1005   4AA8 A1          	and	c			; limpa bit
1006   4AA9 FD 77 31    	ld	(iy+WRKAREA.CARDFLAGS), a
1007   4AAC C9          	ret
1008   4AAD             .saicomerro: 
1009   4AAD FD 7E 31    	ld	a, (iy+WRKAREA.CARDFLAGS)	; marca bit de erro nas flags
1010   4AB0 B1          	or	c
1011   4AB1 FD 77 31    	ld	(iy+WRKAREA.CARDFLAGS), a
1012   4AB4 37          	scf
1013   4AB5 C9          	ret
1014   4AB6             
1015   4AB6             ;------------------------------------------------
1016   4AB6             ; Marcar bit de erro nas flags
1017   4AB6             ; Destroi AF, C
1018   4AB6             ;------------------------------------------------
1019   4AB6             marcaErroCartao: 
1020   4AB6 FD 4E 30    	ld	c, (iy+WRKAREA.NUMSD)		; cartao atual (1 ou 2)
1021   4AB9 FD 7E 31    	ld	a, (iy+WRKAREA.CARDFLAGS)	; marcar erro
1022   4ABC B1          	or	c
1023   4ABD FD 77 31    	ld	(iy+WRKAREA.CARDFLAGS), a
1024   4AC0 C9          	ret
1025   4AC1             
1026   4AC1             ;------------------------------------------------
1027   4AC1             ; Calcula offset do buffer na RAM em HL e IX para
1028   4AC1             ; os dados do CID dependendo do tipo do cartao atual
1029   4AC1             ; Destroi AF, DE, HL e IX
1030   4AC1             ;------------------------------------------------
1031   4AC1             calculaCIDoffset: 
1032   4AC1 FD E5       	push	iy		; copiamos IY para HL
1033   4AC3 E1          	pop	hl
1034   4AC4 16 00       	ld	d, 0
1035   4AC6 1E 10       	ld	e, WRKAREA.BCID1	; DE aponta para buffer BCID1
1036   4AC8 FD 7E 30    	ld	a, (iy+WRKAREA.NUMSD)	; vamos fazer IX apontar para o buffer correto
1037   4ACB 3D          	dec	a		; dependendo do cartao: BCID1 ou BCID2
1038   4ACC 28 02       	jr	z,.c1
1039   4ACE 1E 20       	ld	e, WRKAREA.BCID2	; DE aponta para buffer BCID2
1040   4AD0             .c1: 
1041   4AD0 19          	add	hl, de		; HL aponta para buffer correto
1042   4AD1 E5          	push	hl		
1043   4AD2 DD E1       	pop	ix		; vamos colocar HL em IX
1044   4AD4 C9          	ret
1045   4AD5             
1046   4AD5             ;------------------------------------------------
1047   4AD5             ; Calcula offset do buffer na RAM para os dados
1048   4AD5             ; do total de blocos dependendo do cartao atual
1049   4AD5             ; Offset fica em HL e IX
1050   4AD5             ; Destroi AF, DE, HL e IX
1051   4AD5             ;------------------------------------------------
1052   4AD5             calculaBLOCOSoffset: 
1053   4AD5 FD E5       	push	iy		; copiamos IY para HL
1054   4AD7 E1          	pop	hl
1055   4AD8 16 00       	ld	d, 0
1056   4ADA 1E 33       	ld	e, WRKAREA.BLOCKS1	; DE aponta para buffer BLOCKS1
1057   4ADC FD 7E 30    	ld	a, (iy+WRKAREA.NUMSD)	; Vamos fazer IX apontar para o buffer correto
1058   4ADF 3D          	dec	a		; dependendo do cartao: BLOCKS1 ou BLOCKS2
1059   4AE0 28 02       	jr	z,.c1
1060   4AE2 1E 36       	ld	e, WRKAREA.BLOCKS2	; DE aponta para buffer BLOCKS2
1061   4AE4             .c1: 
1062   4AE4 19          	add	hl, de		; HL aponta para buffer correto
1063   4AE5 E5          	push	hl		
1064   4AE6 DD E1       	pop	ix		; Vamos colocar HL em IX
1065   4AE8 C9          	ret
1066   4AE9             
1067   4AE9             
1068   4AE9             ;------------------------------------------------
1069   4AE9             ; Minhas funcoes para cartao SD
1070   4AE9             ;------------------------------------------------
1071   4AE9             
1072   4AE9             ;------------------------------------------------
1073   4AE9             ; Processo de inicializacao e deteccao do cartao.
1074   4AE9             ; Detecta se cartao responde, qual versao (SDV1
1075   4AE9             ; ou SDV2), faz a leitura do CSD e CID e calcula
1076   4AE9             ; o numero de blocos do cartao, colocando o CID
1077   4AE9             ; e total de blocos no buffer correto dependendo
1078   4AE9             ; do cartao 1 ou 2.
1079   4AE9             ; Retorna erro no carry. Se for 0 indica deteccao
1080   4AE9             ; com sucesso.
1081   4AE9             ; Destroi todos os registradores
1082   4AE9             ;------------------------------------------------
1083   4AE9             detectaCartao: 
1084   4AE9 CD 0B 4C    	call	iniciaSD	; manda pulsos de clock e comandos iniciais
1085   4AEC D8          	ret	c			; retorna se erro
1086   4AED CD B8 4B    	call	testaSDCV2	; tenta inicializar um cartao SDV2
1087   4AF0 D8          	ret	c
1088   4AF1 FD E5       	push	iy		; colocar em HL buffer da RAM de trabalho
1089   4AF3 E1          	pop	hl		; CSD esta no offset 0, nao precisamos somar
1090   4AF4 3E 49       	ld	a, CMD9		; ler CSD
1091   4AF6 CD D9 4B    	call	lerBlocoCxD
1092   4AF9 D8          	ret	c
1093   4AFA CD C1 4A    	call	calculaCIDoffset	; calculamos em IX e HL a posicao correta do offset CID dependendo do cartao atual
1094   4AFD 3E 4A       	ld	a, CMD10	; ler CID
1095   4AFF CD D9 4B    	call	lerBlocoCxD
1096   4B02 D8          	ret	c
1097   4B03 3E 7A       	ld	a, CMD58	; ler OCR
1098   4B05 11 00 00    	ld	de, 0
1099   4B08 CD 5C 4C    	call	SD_SEND_CMD_2_ARGS_GET_R3	; enviar comando e receber resposta tipo R3
1100   4B0B D8          	ret	c
1101   4B0C 78          	ld	a, b		; testa bit CCS do OCR que informa se cartao eh SDV1 ou SDV2
1102   4B0D E6 40       	and	$40
1103   4B0F DD 77 0F    	ld	(ix+15), a	; salva informacao da versao do SD (V1 ou V2) no byte 15 do CID
1104   4B12 CC AD 4B    	call	z,mudarTamanhoBlocoPara512	; se bit CCS do OCR for 1, eh cartao SDV2 (Block address - SDHC ou SDXD)
1105   4B15 D8          	ret	c		; e nao precisamos mudar tamanho do bloco para 512
1106   4B16 CD 2A 4C    	call	desabilitaSDs
1107   4B19             				; agora vamos calcular o total de blocos dependendo dos dados do CSD
1108   4B19 CD D5 4A    	call	calculaBLOCOSoffset	; calcular em IX e HL o offset correto do buffer que armazena total de blocos
1109   4B1C FD E5       	push	iy		; copiamos IY para HL
1110   4B1E E1          	pop	hl
1111   4B1F 16 00       	ld	d, 0
1112   4B21 1E 05       	ld	e, WRKAREA.BCSD+5
1113   4B23 19          	add	hl, de		; HL aponta para buffer BCSD+5
1114   4B24 FD 7E 00    	ld	a, (iy+WRKAREA.BCSD)
1115   4B27 E6 C0       	and	$C0		; testa versao do registro CSD
1116   4B29 28 06       	jr	z,.calculaCSD1
1117   4B2B FE 40       	cp	$40
1118   4B2D 28 54       	jr	z,.calculaCSD2
1119   4B2F 37          	scf			; versao do registro CSD nao reconhecida, informa erro na deteccao
1120   4B30 C9          	ret
1121   4B31             
1122   4B31             ; -----------------------------------
1123   4B31             ; Registro CSD versao 1, calcular da
1124   4B31             ; maneira correta para a versao 1
1125   4B31             ; -----------------------------------
1126   4B31             .calculaCSD1: 
1127   4B31 7E          	ld	a, (hl)
1128   4B32 E6 0F       	and	$0F		; isola READ_BL_LEN
1129   4B34 F5          	push	af
1130   4B35 23          	inc	hl
1131   4B36 7E          	ld	a, (hl)		; 2 primeiros bits de C_SIZE
1132   4B37 E6 03       	and	3
1133   4B39 57          	ld	d, a
1134   4B3A 23          	inc	hl
1135   4B3B 5E          	ld	e, (hl)		; 8 bits de C_SIZE (DE contem os primeiros 10 bits de C_SIZE)
1136   4B3C 23          	inc	hl
1137   4B3D 7E          	ld	a, (hl)
1138   4B3E E6 C0       	and	$C0		; 2 ultimos bits de C_SIZE
1139   4B40 87          	add	a, a		; rotaciona a esquerda
1140   4B41 CB 13       	rl	e		; rotaciona para DE
1141   4B43 CB 12       	rl	d
1142   4B45 87          	add	a, a		; mais uma rotacao
1143   4B46 CB 13       	rl	e		; rotaciona para DE
1144   4B48 CB 12       	rl	d
1145   4B4A 13          	inc	de		; agora DE contem todos os 12 bits de C_SIZE, incrementa 1
1146   4B4B 23          	inc	hl
1147   4B4C 7E          	ld	a, (hl)		; proximo byte
1148   4B4D E6 03       	and	3		; 2 bits de C_SIZE_MUL
1149   4B4F 47          	ld	b, a		; B contem os 2 bits de C_SIZE_MUL
1150   4B50 23          	inc	hl						
1151   4B51 7E          	ld	a, (hl)		; proximo byte
1152   4B52 E6 80       	and	$80		; 1 bit de C_SIZE_MUL
1153   4B54 87          	add	a, a		; rotaciona para esquerda jogando no carry
1154   4B55 CB 10       	rl	b		; rotaciona para B
1155   4B57 04          	inc	b		; agora B contem os 3 bits de C_SIZE_MUL
1156   4B58 04          	inc	b		; faz B = C_SIZE_MUL + 2
1157   4B59 F1          	pop	af		; volta em A o READ_BL_LEN
1158   4B5A 80          	add	a, b		; A = READ_BL_LEN + (C_SIZE_MUL+2)
1159   4B5B 01 00 00    	ld	bc, 0
1160   4B5E CD 77 4B    	call	.eleva2
1161   4B61 5A          	ld	e, d		; aqui temos 32 bits (BC DE) com o tamanho do cartao
1162   4B62 51          	ld	d, c		; ignoramos os 8 ultimos bits em E, fazemos BC DE => 0B CD (divide por 256)
1163   4B63 48          	ld	c, b
1164   4B64 06 00       	ld	b, 0
1165   4B66 CB 39       	srl	c		; rotacionamos a direita o C, carry = LSB (divide por 2)
1166   4B68 CB 1A       	rr	d		; rotacionamos D e E
1167   4B6A CB 1B       	rr	e		; no final BC DE contem tamanho do cartao / 512 = numero de blocos
1168   4B6C             .salvaBlocos: 
1169   4B6C DD 71 02    	ld	(ix+2), c	; colocar no buffer BLOCOS correto a quantidade de blocos
1170   4B6F DD 72 01    	ld	(ix+1), d	; que o cartao (1 ou 2) tem
1171   4B72 DD 73 00    	ld	(ix), e
1172   4B75 AF          	xor	a		; limpa carry
1173   4B76 C9          	ret
1174   4B77             
1175   4B77             .eleva2: 			; aqui temos: A = (READ_BL_LEN + (C_SIZE_MUL+2))
1176   4B77             				; BC = 0
1177   4B77             				; DE = C_SIZE
1178   4B77 CB 23       	sla	e		; rotacionamos C_SIZE por 'A' vezes
1179   4B79 CB 12       	rl	d
1180   4B7B CB 11       	rl	c
1181   4B7D CB 10       	rl	b
1182   4B7F 3D          	dec	a		; subtraimos 1
1183   4B80 20 F5       	jr	nz,.eleva2
1184   4B82 C9          	ret			; em BC DE temos o tamanho do cartao (bytes) em 32 bits
1185   4B83             
1186   4B83             ; -----------------------------------
1187   4B83             ; Registro CSD versao 2, calcular da
1188   4B83             ; maneira correta para a versao 2
1189   4B83             ; -----------------------------------
1190   4B83             .calculaCSD2: 
1191   4B83 23          	inc	hl		; HL ja aponta para BCSD+5, fazer HL apontar para BCSD+7
1192   4B84 23          	inc	hl
1193   4B85 7E          	ld	a, (hl)
1194   4B86 E6 3F       	and	$3F
1195   4B88 4F          	ld	c, a
1196   4B89 23          	inc	hl
1197   4B8A 56          	ld	d, (hl)
1198   4B8B 23          	inc	hl
1199   4B8C 5E          	ld	e, (hl)
1200   4B8D CD 99 4B    	call	.inc32		; soma 1
1201   4B90 CD A1 4B    	call	.desloca32	; multiplica por 512
1202   4B93 CD A6 4B    	call	.rotaciona24	; multiplica por 2
1203   4B96 C3 6C 4B    	jp		.salvaBlocos
1204   4B99             
1205   4B99             .inc32: 
1206   4B99 1C          	inc	e
1207   4B9A C0          	ret	nz
1208   4B9B 14          	inc	d
1209   4B9C C0          	ret	nz
1210   4B9D 0C          	inc	c
1211   4B9E C0          	ret	nz
1212   4B9F 04          	inc	b
1213   4BA0 C9          	ret
1214   4BA1             
1215   4BA1             .desloca32: 
1216   4BA1 41          	ld	b, c
1217   4BA2 4A          	ld	c, d
1218   4BA3 53          	ld	d, e
1219   4BA4 1E 00       	ld	e, 0
1220   4BA6             .rotaciona24: 
1221   4BA6 CB 22       	sla	d
1222   4BA8 CB 11       	rl	c
1223   4BAA CB 10       	rl	b
1224   4BAC C9          	ret
1225   4BAD             
1226   4BAD             ; ------------------------------------------------
1227   4BAD             ; Setar o tamanho do bloco para 512 se o cartao
1228   4BAD             ; for SDV1
1229   4BAD             ; ------------------------------------------------
1230   4BAD             mudarTamanhoBlocoPara512: 
1231   4BAD 3E 50       	ld	a, CMD16
1232   4BAF 01 00 00    	ld	bc, 0
1233   4BB2 11 00 02    	ld	de, 512
1234   4BB5 C3 47 4C    	jp	SD_SEND_CMD_GET_ERROR
1235   4BB8             
1236   4BB8             ; ------------------------------------------------
1237   4BB8             ; Tenta inicializar um cartao SDV2, se houver erro
1238   4BB8             ; o cartao deve ser SDV1
1239   4BB8             ; ------------------------------------------------
1240   4BB8             testaSDCV2: 
1241   4BB8 3E 48       	ld	a, CMD8
1242   4BBA 11 AA 01    	ld	de, $1AA
1243   4BBD CD 5C 4C    	call	SD_SEND_CMD_2_ARGS_GET_R3
1244   4BC0 21 40 4C    	ld	hl, SD_SEND_CMD1	; HL aponta para rotina correta
1245   4BC3 38 03       	jr	c,.pula		; cartao recusou CMD8, enviar comando CMD1
1246   4BC5 21 32 4C    	ld	hl, SD_SEND_ACMD41	; cartao aceitou CMD8, enviar comando ACMD41
1247   4BC8             .pula: 
1248   4BC8 01 14 00    	ld	bc, 20		; B = 0, C = 20: 5120 tentativas
1249   4BCB             .loop: 
1250   4BCB C5          	push	bc
1251   4BCC CD D8 4B    	call	.jumpHL		; chamar rotina correta em HL
1252   4BCF C1          	pop	bc
1253   4BD0 D0          	ret	nc
1254   4BD1 10 F8       	djnz	.loop
1255   4BD3 0D          	dec	c
1256   4BD4 20 F5       	jr	nz,.loop
1257   4BD6 37          	scf
1258   4BD7 C9          	ret
1259   4BD8             .jumpHL: 
1260   4BD8 E9          	jp	(hl)		; chamar rotina correta em HL
1261   4BD9             
1262   4BD9             ; ------------------------------------------------
1263   4BD9             ; Ler registro CID ou CSD, o comando vem em A
1264   4BD9             ; ------------------------------------------------
1265   4BD9             lerBlocoCxD: 
1266   4BD9 CD 42 4C    	call	SD_SEND_CMD_NO_ARGS
1267   4BDC D8          	ret	c
1268   4BDD CD B0 4C    	call	WAIT_RESP_FE
1269   4BE0 D8          	ret	c
1270   4BE1 EB          	ex	de,hl
1271   4BE2             
1272   4BE2 21 00 40    	ld	hl, PORTSPI
1273   4BE5 ED A0       > ldi		
1273   4BE7 ED A0       > ldi		
1273   4BE9 ED A0       > ldi		
1273   4BEB ED A0       > ldi		
1273   4BED ED A0       > ldi		
1273   4BEF ED A0       > ldi		
1273   4BF1 ED A0       > ldi		
1273   4BF3 ED A0       > ldi		
1273   4BF5 ED A0       > ldi		
1273   4BF7 ED A0       > ldi		
1273   4BF9 ED A0       > ldi		
1273   4BFB ED A0       > ldi		
1273   4BFD ED A0       > ldi		
1273   4BFF ED A0       > ldi		
1273   4C01 ED A0       > ldi		
1273   4C03 ED A0       > ldi		
1274   4C05 7E          	ld	a, (hl)
1275   4C06 7E          	ld	a, (hl)		; byte de resposta
1276   4C07 B7          	or	a
1277   4C08 EB          	ex	de,hl
1278   4C09 18 1F       	jr	desabilitaSDs
1279   4C0B             
1280   4C0B             ; ------------------------------------------------
1281   4C0B             ; Algoritmo para inicializar um cartao SD
1282   4C0B             ; Destroi AF, B, DE
1283   4C0B             ; ------------------------------------------------
1284   4C0B             iniciaSD: 
1285   4C0B CD 2A 4C    	call	desabilitaSDs
1286   4C0E             
1287   4C0E 06 0A       	ld	b, 10		; enviar 80 pulsos de clock com cartao desabilitado
1288   4C10             enviaClocksInicio: 
1289   4C10 3E FF       	ld	a, $FF		; manter MOSI em 1
1290   4C12 32 00 40    	ld	(PORTSPI), a
1291   4C15 10 F9       	djnz	enviaClocksInicio
1292   4C17 CD CD 4C    	call	setaSDAtual	; ativar cartao atual
1293   4C1A 06 08       	ld	b, 8		; 8 tentativas para CMD0
1294   4C1C             SD_SEND_CMD0: 
1295   4C1C 3E 40       	ld	a, CMD0		; primeiro comando: CMD0
1296   4C1E 11 00 00    	ld	de, 0
1297   4C21 C5          	push	bc
1298   4C22 CD 4F 4C    	call	SD_SEND_CMD_2_ARGS_TEST_BUSY
1299   4C25 C1          	pop	bc
1300   4C26 D0          	ret	nc			; retorna se cartao respondeu ao CMD0
1301   4C27 10 F3       	djnz	SD_SEND_CMD0
1302   4C29 37          	scf			; cartao nao respondeu ao CMD0, informar erro
1303   4C2A             	; fall throw
1304   4C2A             
1305   4C2A             ; ------------------------------------------------
1306   4C2A             ; Desabilitar (de-selecionar) todos os cartoes
1307   4C2A             ; Nao destroi registradores
1308   4C2A             ; ------------------------------------------------
1309   4C2A             desabilitaSDs: 
1310   4C2A F5          	push	af
1311   4C2B 3E FF       	ld	a, $FF		; todos os /CS em 1
1312   4C2D 32 00 48    	ld	(PORTCFG), a
1313   4C30 F1          	pop	af
1314   4C31 C9          	ret
1315   4C32             
1316   4C32             ; ------------------------------------------------
1317   4C32             ; Enviar comando ACMD41
1318   4C32             ; ------------------------------------------------
1319   4C32             SD_SEND_ACMD41: 
1320   4C32 3E 77       	ld	a, CMD55
1321   4C34 CD 42 4C    	call	SD_SEND_CMD_NO_ARGS
1322   4C37 3E 69       	ld	a, ACMD41
1323   4C39 01 00 40    	ld	bc, $4000
1324   4C3C 51          	ld	d, c
1325   4C3D 59          	ld	e, c
1326   4C3E 18 07       	jr		SD_SEND_CMD_GET_ERROR
1327   4C40             
1328   4C40             ; ------------------------------------------------
1329   4C40             ; Enviar CMD1 para cartao. Carry indica erro
1330   4C40             ; Destroi AF, BC, DE
1331   4C40             ; ------------------------------------------------
1332   4C40             SD_SEND_CMD1: 
1333   4C40 3E 41       	ld	a, CMD1
1334   4C42             SD_SEND_CMD_NO_ARGS: 
1335   4C42 01 00 00    	ld	bc, 0
1336   4C45 50          	ld	d, b
1337   4C46 59          	ld	e, c
1338   4C47             SD_SEND_CMD_GET_ERROR: 
1339   4C47 CD 75 4C    	call	SD_SEND_CMD
1340   4C4A B7          	or	a
1341   4C4B C8          	ret	z			; se A=0 nao houve erro, retornar
1342   4C4C             	; fall throw
1343   4C4C             
1344   4C4C             ; ------------------------------------------------
1345   4C4C             ; Informar erro
1346   4C4C             ; Nao destroi registradores
1347   4C4C             ; ------------------------------------------------
1348   4C4C             setaErro: 
1349   4C4C 37          	scf
1350   4C4D 18 DB       	jr		desabilitaSDs
1351   4C4F             
1352   4C4F             ; ------------------------------------------------
1353   4C4F             ; Enviar comando em A com 2 bytes de parametros
1354   4C4F             ; em DE e testar retorno BUSY
1355   4C4F             ; Retorna em A a resposta do cartao
1356   4C4F             ; Destroi AF, BC
1357   4C4F             ; ------------------------------------------------
1358   4C4F             SD_SEND_CMD_2_ARGS_TEST_BUSY: 
1359   4C4F 01 00 00    	ld	bc, 0
1360   4C52 CD 75 4C    	call	SD_SEND_CMD
1361   4C55 47          	ld	b, a
1362   4C56 E6 FE       	and	$FE		; testar bit 0 (flag BUSY)
1363   4C58 78          	ld	a, b
1364   4C59 20 F1       	jr	nz,setaErro	; BUSY em 1, informar erro
1365   4C5B C9          	ret			; sem erros
1366   4C5C             
1367   4C5C             ; ------------------------------------------------
1368   4C5C             ; Enviar comando em A com 2 bytes de parametros
1369   4C5C             ; em DE e ler resposta do tipo R3 em BC DE
1370   4C5C             ; Retorna em A a resposta do cartao
1371   4C5C             ; Destroi AF, BC, DE, HL
1372   4C5C             ; ------------------------------------------------
1373   4C5C             SD_SEND_CMD_2_ARGS_GET_R3: 
1374   4C5C CD 4F 4C    	call	SD_SEND_CMD_2_ARGS_TEST_BUSY
1375   4C5F D8          	ret	c
1376   4C60 F5          	push	af
1377   4C61 CD A1 4C    	call	WAIT_RESP_NO_FF
1378   4C64 67          	ld	h, a
1379   4C65 CD A1 4C    	call	WAIT_RESP_NO_FF
1380   4C68 6F          	ld	l, a
1381   4C69 CD A1 4C    	call	WAIT_RESP_NO_FF
1382   4C6C 57          	ld	d, a
1383   4C6D CD A1 4C    	call	WAIT_RESP_NO_FF
1384   4C70 5F          	ld	e, a
1385   4C71 44          	ld	b, h
1386   4C72 4D          	ld	c, l
1387   4C73 F1          	pop	af
1388   4C74 C9          	ret
1389   4C75             
1390   4C75             ; ------------------------------------------------
1391   4C75             ; Enviar comando em A com 4 bytes de parametros
1392   4C75             ; em BC DE e enviar CRC correto se for CMD0 ou 
1393   4C75             ; CMD8 e aguardar processamento do cartao
1394   4C75             ; Output  : A=0 if there was no error
1395   4C75             ; Modifies:  AF, B, AF'
1396   4C75             ; ------------------------------------------------
1397   4C75             SD_SEND_CMD: 
1398   4C75 08          	ex	af,af'
1399   4C76 CD CD 4C    	call	setaSDAtual
1400   4C79 08          	ex	af,af'
1401   4C7A 32 00 40    	ld	(PORTSPI), a
1402   4C7D 08          	ex	af,af'
1403   4C7E 78          	ld	a, b
1404   4C7F 32 00 40    	ld	(PORTSPI), a
1405   4C82 79          	ld	a, c
1406   4C83 32 00 40    	ld	(PORTSPI), a
1407   4C86 7A          	ld	a, d
1408   4C87 32 00 40    	ld	(PORTSPI), a
1409   4C8A 7B          	ld	a, e
1410   4C8B 32 00 40    	ld	(PORTSPI), a
1411   4C8E 08          	ex	af,af'
1412   4C8F FE 40       	cp	CMD0
1413   4C91 06 95       	ld	b, $95		; CRC para CMD0
1414   4C93 28 08       	jr	z,enviaCRC
1415   4C95 FE 48       	cp	CMD8
1416   4C97 06 87       	ld	b, $87		; CRC para CMD8
1417   4C99 28 02       	jr	z,enviaCRC
1418   4C9B 06 FF       	ld	b, $FF		; CRC dummy
1419   4C9D             enviaCRC: 
1420   4C9D 78          	ld	a, b
1421   4C9E 32 00 40    	ld	(PORTSPI), a
1422   4CA1             ;	jr	WAIT_RESP_NO_FF
1423   4CA1             
1424   4CA1             ; ------------------------------------------------
1425   4CA1             ; Esperar que resposta do cartao seja diferente
1426   4CA1             ; de $FF
1427   4CA1             ; Destroi AF, BC
1428   4CA1             ; ------------------------------------------------
1429   4CA1             WAIT_RESP_NO_FF: 
1430   4CA1 01 01 00    	ld	bc, 1		; 256 tentativas
1431   4CA4             .loop: 
1432   4CA4 3A 00 40    	ld	a, (PORTSPI)
1433   4CA7 FE FF       	cp	$FF		; testa $FF
1434   4CA9 C0          	ret	nz		; sai se nao for $FF
1435   4CAA 10 F8       	djnz	.loop
1436   4CAC 0D          	dec	c
1437   4CAD 20 F5       	jr	nz,.loop
1438   4CAF C9          	ret
1439   4CB0             
1440   4CB0             ; ------------------------------------------------
1441   4CB0             ; Esperar que resposta do cartao seja $FE
1442   4CB0             ; Destroi AF, B
1443   4CB0             ; ------------------------------------------------
1444   4CB0             WAIT_RESP_FE: 
1445   4CB0 06 0A       	ld	b, 10		; 10 tentativas
1446   4CB2             .loop: 
1447   4CB2 C5          	push	bc
1448   4CB3 CD A1 4C    	call	WAIT_RESP_NO_FF	; esperar resposta diferente de $FF
1449   4CB6 C1          	pop	bc
1450   4CB7 FE FE       	cp	$FE		; resposta  $FE ?
1451   4CB9 C8          	ret	z		; sim, retornamos com carry=0
1452   4CBA 10 F6       	djnz	.loop
1453   4CBC 37          	scf			; erro, carry=1
1454   4CBD C9          	ret
1455   4CBE             
1456   4CBE             ; ------------------------------------------------
1457   4CBE             ; Esperar que resposta do cartao seja diferente
1458   4CBE             ; de $00
1459   4CBE             ; Destroi A, BC
1460   4CBE             ; ------------------------------------------------
1461   4CBE             WAIT_RESP_NO_00: 
1462   4CBE 01 80 00    	ld	bc, 128		; 32768 tentativas
1463   4CC1             .loop: 
1464   4CC1 3A 00 40    	ld	a, (PORTSPI)
1465   4CC4 B7          	or	a
1466   4CC5 C0          	ret	nz			; se resposta for <> $00, sai
1467   4CC6 10 F9       	djnz	.loop
1468   4CC8 0D          	dec	c
1469   4CC9 20 F6       	jr	nz,.loop
1470   4CCB 37          	scf			; erro
1471   4CCC C9          	ret
1472   4CCD             
1473   4CCD             ; ------------------------------------------------
1474   4CCD             ; Ativa (seleciona) cartao atual baixando seu /CS
1475   4CCD             ; Modify: AF 
1476   4CCD             ; ------------------------------------------------
1477   4CCD             setaSDAtual: 
1478   4CCD 3A 00 40    	ld	a, (PORTSPI)	; dummy read
1479   4CD0 FD 7E 30    	ld	a, (iy+WRKAREA.NUMSD)
1480   4CD3 2F          	cpl			; inverte bits
1481   4CD4 32 00 48    	ld	(PORTCFG), a
1482   4CD7 C9          	ret
1483   4CD8             
1484   4CD8             ; ------------------------------------------------
1485   4CD8             ; Grava um bloco de 512 bytes no cartao
1486   4CD8             ; HL aponta para o inicio dos dados
1487   4CD8             ; BC e DE contem o numero do bloco (BCDE = 32 bits)
1488   4CD8             ; Modifies:  AF, BC, DE, HL, IXL
1489   4CD8             ; ------------------------------------------------
1490   4CD8             GravarBloco: 
1491   4CD8 DD 2D       	dec	ixl		; SDcard V1?
1492   4CDA FC 76 5E    	call	m,blocoParaByte	; Yes, convert blocks to bytes 
1493   4CDD CD CD 4C    	call	setaSDAtual	; selecionar cartao atual
1494   4CE0 DD 7C       	ld	a,ixh		; get Number of blocks to write
1495   4CE2 3D          	dec	a
1496   4CE3 CA 9F 51    	jp	z,.umBloco	; somente um bloco, gravar usando CMD24
1497   4CE6             
1498   4CE6             ; multiplos blocos
1499   4CE6 D9          	exx
1500   4CE7 3E 77       	ld	a, CMD55	; Multiplos blocos, mandar ACMD23 com total de blocos
1501   4CE9 CD 42 4C    	call	SD_SEND_CMD_NO_ARGS
1502   4CEC 3E 57       	ld	a, ACMD23
1503   4CEE 01 00 00    	ld	bc, 0
1504   4CF1 51          	ld	d, c
1505   4CF2 DD 5C       	ld	e,ixh		; e=Number of blocks to write
1506   4CF4 CD 75 4C    	call	SD_SEND_CMD
1507   4CF7 B7          	or	a
1508   4CF8 20 55       	jr	nz,.erroEscritaBlocoR	; erro no ACMD23
1509   4CFA D9          	exx
1510   4CFB 3E 59       	ld	a, CMD25	; CMD25 = write multiple blocks
1511   4CFD CD 75 4C    	call	SD_SEND_CMD
1512   4D00 B7          	or	a
1513   4D01 20 4C       	jr	nz,.erroEscritaBlocoR	; erro
1514   4D03             
1515   4D03             	; Check for a Z80 or R800
1516   4D03 EB          	ex	de,hl
1517   4D04             ;	ld	a,20
1518   4D04 3D          	dec	a		; a=#FF
1519   4D05 ED F9       	db	#ED,#F9		; mulub a,a
1520   4D07 EB          	ex	de,hl
1521   4D08 30 50       	jr	nc,.loopZ80	; Use the Z80 optimized loop
1522   4D0A             
1523   4D0A D9          	exx
1524   4D0B CD 79 60    	call	GTR800LDIR
1525   4D0E D9          	exx			; hl'=Pointer to R800LDIR helper routine
1526   4D0F             .loopR800: 	; R800 optimized loop
1527   4D0F 11 00 40    	ld	de,PORTSPI
1528   4D12 3E FC       	ld	a, $FC		; mandar $FC para indicar que os proximos dados
1529   4D14 12          	ld	(de),a		; sao para gravacao
1530   4D15 CD 82 5E    	call	R800LDIR
1531   4D18 32 00 40    	ld	(PORTSPI),a	; Send a dummy 16bit CRC
1532   4D1B 32 00 40    	ld	(PORTSPI),a
1533   4D1E             ; Wait for !FFh
1534   4D1E 06 05       	ld	b,5		; 5*5ms = 250ms
1535   4D20             .rwaitnoFFext: 
1536   4D20 DB E7       	in	a,(#E7)
1537   4D22 4F          	ld	c,a
1538   4D23             .rwaitnoFF: 
1539   4D23 3A 00 40    	ld	a,(PORTSPI)
1540   4D26 FE FF       	cp	$FF		; a=FF?
1541   4D28 20 0B       	jr	nz,.rnoFFok
1542   4D2A DB E7       	in	a,(#E7)
1543   4D2C 91          	sub	c
1544   4D2D FE 32       	cp	50		; 50mS?
1545   4D2F 38 F2       	jr	c,.rwaitnoFF	; wait 50ms
1546   4D31 10 F0       	djnz	.rwaitnoFF	; x50ms wait
1547   4D33 18 1A       	jr	.erroEscritaBlocoR	; error: timeout
1548   4D35             .rnoFFok: 
1549   4D35 E6 1F       	and	$1F		; testa bits erro
1550   4D37 FE 05       	cp	5
1551   4D39 20 14       	jr	nz,.erroEscritaBlocoR	; resposta errada, informar erro
1552   4D3B             ; Wait for !00h
1553   4D3B 06 05       	ld	b,5		; 5*50ms = 250ms
1554   4D3D             .rwaitno00ext: 
1555   4D3D DB E7       	in	a,(#E7)
1556   4D3F 4F          	ld	c,a
1557   4D40             .rwaitno00: 
1558   4D40 3A 00 40    	ld	a,(PORTSPI)
1559   4D43 B7          	or	a
1560   4D44 20 0D       	jr	nz,.rno00ok
1561   4D46 DB E7       	in	a,(#E7)
1562   4D48 91          	sub	c
1563   4D49 FE 32       	cp	50		; 50ms
1564   4D4B 38 F3       	jr	c,.rwaitno00	; wait 50ms
1565   4D4D 10 EE       	djnz	.rwaitno00ext	; x50 ms wait
1566   4D4F             .erroEscritaBlocoR:  ; Trick to save some cycles inside the block transfer loop
1567   4D4F 37          	scf
1568   4D50 C3 CE 55    	jp	terminaLeituraEscritaBloco
1569   4D53             .rno00ok: 
1570   4D53 DD 25       	dec	ixh		; nblocks=nblocks-1
1571   4D55 20 B8       	jr	nz,.loopR800
1572   4D57 C3 79 51    	jp	.loopend
1573   4D5A             
1574   4D5A             
1575   4D5A             .loopZ80: 	; Z80 optimized loop
1576   4D5A 11 00 40    	ld	de,PORTSPI
1577   4D5D 3E FC       	ld	a, $FC		; mandar $FC para indicar que os proximos dados
1578   4D5F 12          	ld	(de),a		; sao para gravacao
1579   4D60 ED A0       > ldi		
1579   4D62 ED A0       > ldi		
1579   4D64 ED A0       > ldi		
1579   4D66 ED A0       > ldi		
1579   4D68 ED A0       > ldi		
1579   4D6A ED A0       > ldi		
1579   4D6C ED A0       > ldi		
1579   4D6E ED A0       > ldi		
1579   4D70 ED A0       > ldi		
1579   4D72 ED A0       > ldi		
1579   4D74 ED A0       > ldi		
1579   4D76 ED A0       > ldi		
1579   4D78 ED A0       > ldi		
1579   4D7A ED A0       > ldi		
1579   4D7C ED A0       > ldi		
1579   4D7E ED A0       > ldi		
1579   4D80 ED A0       > ldi		
1579   4D82 ED A0       > ldi		
1579   4D84 ED A0       > ldi		
1579   4D86 ED A0       > ldi		
1579   4D88 ED A0       > ldi		
1579   4D8A ED A0       > ldi		
1579   4D8C ED A0       > ldi		
1579   4D8E ED A0       > ldi		
1579   4D90 ED A0       > ldi		
1579   4D92 ED A0       > ldi		
1579   4D94 ED A0       > ldi		
1579   4D96 ED A0       > ldi		
1579   4D98 ED A0       > ldi		
1579   4D9A ED A0       > ldi		
1579   4D9C ED A0       > ldi		
1579   4D9E ED A0       > ldi		
1579   4DA0 ED A0       > ldi		
1579   4DA2 ED A0       > ldi		
1579   4DA4 ED A0       > ldi		
1579   4DA6 ED A0       > ldi		
1579   4DA8 ED A0       > ldi		
1579   4DAA ED A0       > ldi		
1579   4DAC ED A0       > ldi		
1579   4DAE ED A0       > ldi		
1579   4DB0 ED A0       > ldi		
1579   4DB2 ED A0       > ldi		
1579   4DB4 ED A0       > ldi		
1579   4DB6 ED A0       > ldi		
1579   4DB8 ED A0       > ldi		
1579   4DBA ED A0       > ldi		
1579   4DBC ED A0       > ldi		
1579   4DBE ED A0       > ldi		
1579   4DC0 ED A0       > ldi		
1579   4DC2 ED A0       > ldi		
1579   4DC4 ED A0       > ldi		
1579   4DC6 ED A0       > ldi		
1579   4DC8 ED A0       > ldi		
1579   4DCA ED A0       > ldi		
1579   4DCC ED A0       > ldi		
1579   4DCE ED A0       > ldi		
1579   4DD0 ED A0       > ldi		
1579   4DD2 ED A0       > ldi		
1579   4DD4 ED A0       > ldi		
1579   4DD6 ED A0       > ldi		
1579   4DD8 ED A0       > ldi		
1579   4DDA ED A0       > ldi		
1579   4DDC ED A0       > ldi		
1579   4DDE ED A0       > ldi		
1579   4DE0 ED A0       > ldi		
1579   4DE2 ED A0       > ldi		
1579   4DE4 ED A0       > ldi		
1579   4DE6 ED A0       > ldi		
1579   4DE8 ED A0       > ldi		
1579   4DEA ED A0       > ldi		
1579   4DEC ED A0       > ldi		
1579   4DEE ED A0       > ldi		
1579   4DF0 ED A0       > ldi		
1579   4DF2 ED A0       > ldi		
1579   4DF4 ED A0       > ldi		
1579   4DF6 ED A0       > ldi		
1579   4DF8 ED A0       > ldi		
1579   4DFA ED A0       > ldi		
1579   4DFC ED A0       > ldi		
1579   4DFE ED A0       > ldi		
1579   4E00 ED A0       > ldi		
1579   4E02 ED A0       > ldi		
1579   4E04 ED A0       > ldi		
1579   4E06 ED A0       > ldi		
1579   4E08 ED A0       > ldi		
1579   4E0A ED A0       > ldi		
1579   4E0C ED A0       > ldi		
1579   4E0E ED A0       > ldi		
1579   4E10 ED A0       > ldi		
1579   4E12 ED A0       > ldi		
1579   4E14 ED A0       > ldi		
1579   4E16 ED A0       > ldi		
1579   4E18 ED A0       > ldi		
1579   4E1A ED A0       > ldi		
1579   4E1C ED A0       > ldi		
1579   4E1E ED A0       > ldi		
1579   4E20 ED A0       > ldi		
1579   4E22 ED A0       > ldi		
1579   4E24 ED A0       > ldi		
1579   4E26 ED A0       > ldi		
1579   4E28 ED A0       > ldi		
1579   4E2A ED A0       > ldi		
1579   4E2C ED A0       > ldi		
1579   4E2E ED A0       > ldi		
1579   4E30 ED A0       > ldi		
1579   4E32 ED A0       > ldi		
1579   4E34 ED A0       > ldi		
1579   4E36 ED A0       > ldi		
1579   4E38 ED A0       > ldi		
1579   4E3A ED A0       > ldi		
1579   4E3C ED A0       > ldi		
1579   4E3E ED A0       > ldi		
1579   4E40 ED A0       > ldi		
1579   4E42 ED A0       > ldi		
1579   4E44 ED A0       > ldi		
1579   4E46 ED A0       > ldi		
1579   4E48 ED A0       > ldi		
1579   4E4A ED A0       > ldi		
1579   4E4C ED A0       > ldi		
1579   4E4E ED A0       > ldi		
1579   4E50 ED A0       > ldi		
1579   4E52 ED A0       > ldi		
1579   4E54 ED A0       > ldi		
1579   4E56 ED A0       > ldi		
1579   4E58 ED A0       > ldi		
1579   4E5A ED A0       > ldi		
1579   4E5C ED A0       > ldi		
1579   4E5E ED A0       > ldi		
1579   4E60 ED A0       > ldi		
1579   4E62 ED A0       > ldi		
1579   4E64 ED A0       > ldi		
1579   4E66 ED A0       > ldi		
1579   4E68 ED A0       > ldi		
1579   4E6A ED A0       > ldi		
1579   4E6C ED A0       > ldi		
1579   4E6E ED A0       > ldi		
1579   4E70 ED A0       > ldi		
1579   4E72 ED A0       > ldi		
1579   4E74 ED A0       > ldi		
1579   4E76 ED A0       > ldi		
1579   4E78 ED A0       > ldi		
1579   4E7A ED A0       > ldi		
1579   4E7C ED A0       > ldi		
1579   4E7E ED A0       > ldi		
1579   4E80 ED A0       > ldi		
1579   4E82 ED A0       > ldi		
1579   4E84 ED A0       > ldi		
1579   4E86 ED A0       > ldi		
1579   4E88 ED A0       > ldi		
1579   4E8A ED A0       > ldi		
1579   4E8C ED A0       > ldi		
1579   4E8E ED A0       > ldi		
1579   4E90 ED A0       > ldi		
1579   4E92 ED A0       > ldi		
1579   4E94 ED A0       > ldi		
1579   4E96 ED A0       > ldi		
1579   4E98 ED A0       > ldi		
1579   4E9A ED A0       > ldi		
1579   4E9C ED A0       > ldi		
1579   4E9E ED A0       > ldi		
1579   4EA0 ED A0       > ldi		
1579   4EA2 ED A0       > ldi		
1579   4EA4 ED A0       > ldi		
1579   4EA6 ED A0       > ldi		
1579   4EA8 ED A0       > ldi		
1579   4EAA ED A0       > ldi		
1579   4EAC ED A0       > ldi		
1579   4EAE ED A0       > ldi		
1579   4EB0 ED A0       > ldi		
1579   4EB2 ED A0       > ldi		
1579   4EB4 ED A0       > ldi		
1579   4EB6 ED A0       > ldi		
1579   4EB8 ED A0       > ldi		
1579   4EBA ED A0       > ldi		
1579   4EBC ED A0       > ldi		
1579   4EBE ED A0       > ldi		
1579   4EC0 ED A0       > ldi		
1579   4EC2 ED A0       > ldi		
1579   4EC4 ED A0       > ldi		
1579   4EC6 ED A0       > ldi		
1579   4EC8 ED A0       > ldi		
1579   4ECA ED A0       > ldi		
1579   4ECC ED A0       > ldi		
1579   4ECE ED A0       > ldi		
1579   4ED0 ED A0       > ldi		
1579   4ED2 ED A0       > ldi		
1579   4ED4 ED A0       > ldi		
1579   4ED6 ED A0       > ldi		
1579   4ED8 ED A0       > ldi		
1579   4EDA ED A0       > ldi		
1579   4EDC ED A0       > ldi		
1579   4EDE ED A0       > ldi		
1579   4EE0 ED A0       > ldi		
1579   4EE2 ED A0       > ldi		
1579   4EE4 ED A0       > ldi		
1579   4EE6 ED A0       > ldi		
1579   4EE8 ED A0       > ldi		
1579   4EEA ED A0       > ldi		
1579   4EEC ED A0       > ldi		
1579   4EEE ED A0       > ldi		
1579   4EF0 ED A0       > ldi		
1579   4EF2 ED A0       > ldi		
1579   4EF4 ED A0       > ldi		
1579   4EF6 ED A0       > ldi		
1579   4EF8 ED A0       > ldi		
1579   4EFA ED A0       > ldi		
1579   4EFC ED A0       > ldi		
1579   4EFE ED A0       > ldi		
1579   4F00 ED A0       > ldi		
1579   4F02 ED A0       > ldi		
1579   4F04 ED A0       > ldi		
1579   4F06 ED A0       > ldi		
1579   4F08 ED A0       > ldi		
1579   4F0A ED A0       > ldi		
1579   4F0C ED A0       > ldi		
1579   4F0E ED A0       > ldi		
1579   4F10 ED A0       > ldi		
1579   4F12 ED A0       > ldi		
1579   4F14 ED A0       > ldi		
1579   4F16 ED A0       > ldi		
1579   4F18 ED A0       > ldi		
1579   4F1A ED A0       > ldi		
1579   4F1C ED A0       > ldi		
1579   4F1E ED A0       > ldi		
1579   4F20 ED A0       > ldi		
1579   4F22 ED A0       > ldi		
1579   4F24 ED A0       > ldi		
1579   4F26 ED A0       > ldi		
1579   4F28 ED A0       > ldi		
1579   4F2A ED A0       > ldi		
1579   4F2C ED A0       > ldi		
1579   4F2E ED A0       > ldi		
1579   4F30 ED A0       > ldi		
1579   4F32 ED A0       > ldi		
1579   4F34 ED A0       > ldi		
1579   4F36 ED A0       > ldi		
1579   4F38 ED A0       > ldi		
1579   4F3A ED A0       > ldi		
1579   4F3C ED A0       > ldi		
1579   4F3E ED A0       > ldi		
1579   4F40 ED A0       > ldi		
1579   4F42 ED A0       > ldi		
1579   4F44 ED A0       > ldi		
1579   4F46 ED A0       > ldi		
1579   4F48 ED A0       > ldi		
1579   4F4A ED A0       > ldi		
1579   4F4C ED A0       > ldi		
1579   4F4E ED A0       > ldi		
1579   4F50 ED A0       > ldi		
1579   4F52 ED A0       > ldi		
1579   4F54 ED A0       > ldi		
1579   4F56 ED A0       > ldi		
1579   4F58 ED A0       > ldi		
1579   4F5A ED A0       > ldi		
1579   4F5C ED A0       > ldi		
1579   4F5E ED A0       > ldi		
1579   4F60 ED A0       > ldi		
1579   4F62 ED A0       > ldi		
1579   4F64 ED A0       > ldi		
1579   4F66 ED A0       > ldi		
1579   4F68 ED A0       > ldi		
1579   4F6A ED A0       > ldi		
1579   4F6C ED A0       > ldi		
1579   4F6E ED A0       > ldi		
1579   4F70 ED A0       > ldi		
1579   4F72 ED A0       > ldi		
1579   4F74 ED A0       > ldi		
1579   4F76 ED A0       > ldi		
1579   4F78 ED A0       > ldi		
1579   4F7A ED A0       > ldi		
1579   4F7C ED A0       > ldi		
1579   4F7E ED A0       > ldi		
1579   4F80 ED A0       > ldi		
1579   4F82 ED A0       > ldi		
1579   4F84 ED A0       > ldi		
1579   4F86 ED A0       > ldi		
1579   4F88 ED A0       > ldi		
1579   4F8A ED A0       > ldi		
1579   4F8C ED A0       > ldi		
1579   4F8E ED A0       > ldi		
1579   4F90 ED A0       > ldi		
1579   4F92 ED A0       > ldi		
1579   4F94 ED A0       > ldi		
1579   4F96 ED A0       > ldi		
1579   4F98 ED A0       > ldi		
1579   4F9A ED A0       > ldi		
1579   4F9C ED A0       > ldi		
1579   4F9E ED A0       > ldi		
1579   4FA0 ED A0       > ldi		
1579   4FA2 ED A0       > ldi		
1579   4FA4 ED A0       > ldi		
1579   4FA6 ED A0       > ldi		
1579   4FA8 ED A0       > ldi		
1579   4FAA ED A0       > ldi		
1579   4FAC ED A0       > ldi		
1579   4FAE ED A0       > ldi		
1579   4FB0 ED A0       > ldi		
1579   4FB2 ED A0       > ldi		
1579   4FB4 ED A0       > ldi		
1579   4FB6 ED A0       > ldi		
1579   4FB8 ED A0       > ldi		
1579   4FBA ED A0       > ldi		
1579   4FBC ED A0       > ldi		
1579   4FBE ED A0       > ldi		
1579   4FC0 ED A0       > ldi		
1579   4FC2 ED A0       > ldi		
1579   4FC4 ED A0       > ldi		
1579   4FC6 ED A0       > ldi		
1579   4FC8 ED A0       > ldi		
1579   4FCA ED A0       > ldi		
1579   4FCC ED A0       > ldi		
1579   4FCE ED A0       > ldi		
1579   4FD0 ED A0       > ldi		
1579   4FD2 ED A0       > ldi		
1579   4FD4 ED A0       > ldi		
1579   4FD6 ED A0       > ldi		
1579   4FD8 ED A0       > ldi		
1579   4FDA ED A0       > ldi		
1579   4FDC ED A0       > ldi		
1579   4FDE ED A0       > ldi		
1579   4FE0 ED A0       > ldi		
1579   4FE2 ED A0       > ldi		
1579   4FE4 ED A0       > ldi		
1579   4FE6 ED A0       > ldi		
1579   4FE8 ED A0       > ldi		
1579   4FEA ED A0       > ldi		
1579   4FEC ED A0       > ldi		
1579   4FEE ED A0       > ldi		
1579   4FF0 ED A0       > ldi		
1579   4FF2 ED A0       > ldi		
1579   4FF4 ED A0       > ldi		
1579   4FF6 ED A0       > ldi		
1579   4FF8 ED A0       > ldi		
1579   4FFA ED A0       > ldi		
1579   4FFC ED A0       > ldi		
1579   4FFE ED A0       > ldi		
1579   5000 ED A0       > ldi		
1579   5002 ED A0       > ldi		
1579   5004 ED A0       > ldi		
1579   5006 ED A0       > ldi		
1579   5008 ED A0       > ldi		
1579   500A ED A0       > ldi		
1579   500C ED A0       > ldi		
1579   500E ED A0       > ldi		
1579   5010 ED A0       > ldi		
1579   5012 ED A0       > ldi		
1579   5014 ED A0       > ldi		
1579   5016 ED A0       > ldi		
1579   5018 ED A0       > ldi		
1579   501A ED A0       > ldi		
1579   501C ED A0       > ldi		
1579   501E ED A0       > ldi		
1579   5020 ED A0       > ldi		
1579   5022 ED A0       > ldi		
1579   5024 ED A0       > ldi		
1579   5026 ED A0       > ldi		
1579   5028 ED A0       > ldi		
1579   502A ED A0       > ldi		
1579   502C ED A0       > ldi		
1579   502E ED A0       > ldi		
1579   5030 ED A0       > ldi		
1579   5032 ED A0       > ldi		
1579   5034 ED A0       > ldi		
1579   5036 ED A0       > ldi		
1579   5038 ED A0       > ldi		
1579   503A ED A0       > ldi		
1579   503C ED A0       > ldi		
1579   503E ED A0       > ldi		
1579   5040 ED A0       > ldi		
1579   5042 ED A0       > ldi		
1579   5044 ED A0       > ldi		
1579   5046 ED A0       > ldi		
1579   5048 ED A0       > ldi		
1579   504A ED A0       > ldi		
1579   504C ED A0       > ldi		
1579   504E ED A0       > ldi		
1579   5050 ED A0       > ldi		
1579   5052 ED A0       > ldi		
1579   5054 ED A0       > ldi		
1579   5056 ED A0       > ldi		
1579   5058 ED A0       > ldi		
1579   505A ED A0       > ldi		
1579   505C ED A0       > ldi		
1579   505E ED A0       > ldi		
1579   5060 ED A0       > ldi		
1579   5062 ED A0       > ldi		
1579   5064 ED A0       > ldi		
1579   5066 ED A0       > ldi		
1579   5068 ED A0       > ldi		
1579   506A ED A0       > ldi		
1579   506C ED A0       > ldi		
1579   506E ED A0       > ldi		
1579   5070 ED A0       > ldi		
1579   5072 ED A0       > ldi		
1579   5074 ED A0       > ldi		
1579   5076 ED A0       > ldi		
1579   5078 ED A0       > ldi		
1579   507A ED A0       > ldi		
1579   507C ED A0       > ldi		
1579   507E ED A0       > ldi		
1579   5080 ED A0       > ldi		
1579   5082 ED A0       > ldi		
1579   5084 ED A0       > ldi		
1579   5086 ED A0       > ldi		
1579   5088 ED A0       > ldi		
1579   508A ED A0       > ldi		
1579   508C ED A0       > ldi		
1579   508E ED A0       > ldi		
1579   5090 ED A0       > ldi		
1579   5092 ED A0       > ldi		
1579   5094 ED A0       > ldi		
1579   5096 ED A0       > ldi		
1579   5098 ED A0       > ldi		
1579   509A ED A0       > ldi		
1579   509C ED A0       > ldi		
1579   509E ED A0       > ldi		
1579   50A0 ED A0       > ldi		
1579   50A2 ED A0       > ldi		
1579   50A4 ED A0       > ldi		
1579   50A6 ED A0       > ldi		
1579   50A8 ED A0       > ldi		
1579   50AA ED A0       > ldi		
1579   50AC ED A0       > ldi		
1579   50AE ED A0       > ldi		
1579   50B0 ED A0       > ldi		
1579   50B2 ED A0       > ldi		
1579   50B4 ED A0       > ldi		
1579   50B6 ED A0       > ldi		
1579   50B8 ED A0       > ldi		
1579   50BA ED A0       > ldi		
1579   50BC ED A0       > ldi		
1579   50BE ED A0       > ldi		
1579   50C0 ED A0       > ldi		
1579   50C2 ED A0       > ldi		
1579   50C4 ED A0       > ldi		
1579   50C6 ED A0       > ldi		
1579   50C8 ED A0       > ldi		
1579   50CA ED A0       > ldi		
1579   50CC ED A0       > ldi		
1579   50CE ED A0       > ldi		
1579   50D0 ED A0       > ldi		
1579   50D2 ED A0       > ldi		
1579   50D4 ED A0       > ldi		
1579   50D6 ED A0       > ldi		
1579   50D8 ED A0       > ldi		
1579   50DA ED A0       > ldi		
1579   50DC ED A0       > ldi		
1579   50DE ED A0       > ldi		
1579   50E0 ED A0       > ldi		
1579   50E2 ED A0       > ldi		
1579   50E4 ED A0       > ldi		
1579   50E6 ED A0       > ldi		
1579   50E8 ED A0       > ldi		
1579   50EA ED A0       > ldi		
1579   50EC ED A0       > ldi		
1579   50EE ED A0       > ldi		
1579   50F0 ED A0       > ldi		
1579   50F2 ED A0       > ldi		
1579   50F4 ED A0       > ldi		
1579   50F6 ED A0       > ldi		
1579   50F8 ED A0       > ldi		
1579   50FA ED A0       > ldi		
1579   50FC ED A0       > ldi		
1579   50FE ED A0       > ldi		
1579   5100 ED A0       > ldi		
1579   5102 ED A0       > ldi		
1579   5104 ED A0       > ldi		
1579   5106 ED A0       > ldi		
1579   5108 ED A0       > ldi		
1579   510A ED A0       > ldi		
1579   510C ED A0       > ldi		
1579   510E ED A0       > ldi		
1579   5110 ED A0       > ldi		
1579   5112 ED A0       > ldi		
1579   5114 ED A0       > ldi		
1579   5116 ED A0       > ldi		
1579   5118 ED A0       > ldi		
1579   511A ED A0       > ldi		
1579   511C ED A0       > ldi		
1579   511E ED A0       > ldi		
1579   5120 ED A0       > ldi		
1579   5122 ED A0       > ldi		
1579   5124 ED A0       > ldi		
1579   5126 ED A0       > ldi		
1579   5128 ED A0       > ldi		
1579   512A ED A0       > ldi		
1579   512C ED A0       > ldi		
1579   512E ED A0       > ldi		
1579   5130 ED A0       > ldi		
1579   5132 ED A0       > ldi		
1579   5134 ED A0       > ldi		
1579   5136 ED A0       > ldi		
1579   5138 ED A0       > ldi		
1579   513A ED A0       > ldi		
1579   513C ED A0       > ldi		
1579   513E ED A0       > ldi		
1579   5140 ED A0       > ldi		
1579   5142 ED A0       > ldi		
1579   5144 ED A0       > ldi		
1579   5146 ED A0       > ldi		
1579   5148 ED A0       > ldi		
1579   514A ED A0       > ldi		
1579   514C ED A0       > ldi		
1579   514E ED A0       > ldi		
1579   5150 ED A0       > ldi		
1579   5152 ED A0       > ldi		
1579   5154 ED A0       > ldi		
1579   5156 ED A0       > ldi		
1579   5158 ED A0       > ldi		
1579   515A ED A0       > ldi		
1579   515C ED A0       > ldi		
1579   515E ED A0       > ldi		
1580   5160 32 00 40    	ld	(PORTSPI),a	; Send a dummy 16bit CRC
1581   5163 32 00 40    	ld	(PORTSPI),a
1582   5166 CD A1 4C    	call	WAIT_RESP_NO_FF	; esperar cartao
1583   5169 E6 1F       	and	$1F		; testa bits erro
1584   516B FE 05       	cp	5
1585   516D 20 2C       	jr	nz,.erroEscritaBlocoZ	; resposta errada, informar erro
1586   516F CD BE 4C    	call	WAIT_RESP_NO_00	; esperar cartao
1587   5172 38 27       	jr	c,.erroEscritaBlocoZ
1588   5174 DD 25       	dec	ixh		; nblocks=nblocks-1
1589   5176 C2 5A 4D    	jp	nz,.loopZ80
1590   5179             .loopend: 
1591   5179 3A 00 40    	ld	a, (PORTSPI)	; acabou os blocos, fazer 2 dummy reads
1592   517C 3A 00 40    	ld	a, (PORTSPI)
1593   517F 3E FD       	ld	a, $FD		; enviar $FD para informar ao cartao que acabou os dados
1594   5181 32 00 40    	ld	(PORTSPI),a
1595   5184 3A 00 40    	ld	a, (PORTSPI)	; dummy reads
1596   5187 3A 00 40    	ld	a, (PORTSPI)
1597   518A CD BE 4C    	call	WAIT_RESP_NO_00	; esperar cartao
1598   518D C3 CD 55    	jp	.fim		; CMD25 concluido, sair informando nenhum erro
1599   5190             
1600   5190             
1601   5190             
1602   5190             .r800s: 
1603   5190 D9          	exx
1604   5191 CD 79 60    	call	GTR800LDIR
1605   5194 D9          	exx			; hl'=Pointer to R800LDIR helper routine
1606   5195 CD 82 5E    	call	R800LDIR
1607   5198 C3 B4 55    	jp	.part2s
1608   519B             
1609   519B             .erroEscritaBlocoZ:  ; Trick to save some cycles inside the block transfer loop
1610   519B 37          	scf
1611   519C C3 CE 55    	jp	terminaLeituraEscritaBloco
1612   519F             
1613   519F             .umBloco: 
1614   519F 3E 58       	ld	a, CMD24	; CMD24 = Write Single Block
1615   51A1 CD 47 4C    	call	SD_SEND_CMD_GET_ERROR
1616   51A4 DA CE 55    	jp	c,terminaLeituraEscritaBloco	; erro
1617   51A7             
1618   51A7             
1619   51A7 3E FE       	ld	a, $FE		; mandar $FE para indicar que vamos mandar dados para gravacao
1620   51A9 32 00 40    	ld	(PORTSPI),a
1621   51AC             
1622   51AC             	; Check for a Z80 or R800
1623   51AC             ;	ld	a,20
1624   51AC ED F9       	db	#ED,#F9		; mulub a,a
1625   51AE D9          	exx
1626   51AF 11 00 40    	ld	de,PORTSPI
1627   51B2 38 DC       	jr	c,.r800s	; Use LDIR for R800
1628   51B4 ED A0       > ldi
1628   51B6 ED A0       > ldi
1628   51B8 ED A0       > ldi
1628   51BA ED A0       > ldi
1628   51BC ED A0       > ldi
1628   51BE ED A0       > ldi
1628   51C0 ED A0       > ldi
1628   51C2 ED A0       > ldi
1628   51C4 ED A0       > ldi
1628   51C6 ED A0       > ldi
1628   51C8 ED A0       > ldi
1628   51CA ED A0       > ldi
1628   51CC ED A0       > ldi
1628   51CE ED A0       > ldi
1628   51D0 ED A0       > ldi
1628   51D2 ED A0       > ldi
1628   51D4 ED A0       > ldi
1628   51D6 ED A0       > ldi
1628   51D8 ED A0       > ldi
1628   51DA ED A0       > ldi
1628   51DC ED A0       > ldi
1628   51DE ED A0       > ldi
1628   51E0 ED A0       > ldi
1628   51E2 ED A0       > ldi
1628   51E4 ED A0       > ldi
1628   51E6 ED A0       > ldi
1628   51E8 ED A0       > ldi
1628   51EA ED A0       > ldi
1628   51EC ED A0       > ldi
1628   51EE ED A0       > ldi
1628   51F0 ED A0       > ldi
1628   51F2 ED A0       > ldi
1628   51F4 ED A0       > ldi
1628   51F6 ED A0       > ldi
1628   51F8 ED A0       > ldi
1628   51FA ED A0       > ldi
1628   51FC ED A0       > ldi
1628   51FE ED A0       > ldi
1628   5200 ED A0       > ldi
1628   5202 ED A0       > ldi
1628   5204 ED A0       > ldi
1628   5206 ED A0       > ldi
1628   5208 ED A0       > ldi
1628   520A ED A0       > ldi
1628   520C ED A0       > ldi
1628   520E ED A0       > ldi
1628   5210 ED A0       > ldi
1628   5212 ED A0       > ldi
1628   5214 ED A0       > ldi
1628   5216 ED A0       > ldi
1628   5218 ED A0       > ldi
1628   521A ED A0       > ldi
1628   521C ED A0       > ldi
1628   521E ED A0       > ldi
1628   5220 ED A0       > ldi
1628   5222 ED A0       > ldi
1628   5224 ED A0       > ldi
1628   5226 ED A0       > ldi
1628   5228 ED A0       > ldi
1628   522A ED A0       > ldi
1628   522C ED A0       > ldi
1628   522E ED A0       > ldi
1628   5230 ED A0       > ldi
1628   5232 ED A0       > ldi
1628   5234 ED A0       > ldi
1628   5236 ED A0       > ldi
1628   5238 ED A0       > ldi
1628   523A ED A0       > ldi
1628   523C ED A0       > ldi
1628   523E ED A0       > ldi
1628   5240 ED A0       > ldi
1628   5242 ED A0       > ldi
1628   5244 ED A0       > ldi
1628   5246 ED A0       > ldi
1628   5248 ED A0       > ldi
1628   524A ED A0       > ldi
1628   524C ED A0       > ldi
1628   524E ED A0       > ldi
1628   5250 ED A0       > ldi
1628   5252 ED A0       > ldi
1628   5254 ED A0       > ldi
1628   5256 ED A0       > ldi
1628   5258 ED A0       > ldi
1628   525A ED A0       > ldi
1628   525C ED A0       > ldi
1628   525E ED A0       > ldi
1628   5260 ED A0       > ldi
1628   5262 ED A0       > ldi
1628   5264 ED A0       > ldi
1628   5266 ED A0       > ldi
1628   5268 ED A0       > ldi
1628   526A ED A0       > ldi
1628   526C ED A0       > ldi
1628   526E ED A0       > ldi
1628   5270 ED A0       > ldi
1628   5272 ED A0       > ldi
1628   5274 ED A0       > ldi
1628   5276 ED A0       > ldi
1628   5278 ED A0       > ldi
1628   527A ED A0       > ldi
1628   527C ED A0       > ldi
1628   527E ED A0       > ldi
1628   5280 ED A0       > ldi
1628   5282 ED A0       > ldi
1628   5284 ED A0       > ldi
1628   5286 ED A0       > ldi
1628   5288 ED A0       > ldi
1628   528A ED A0       > ldi
1628   528C ED A0       > ldi
1628   528E ED A0       > ldi
1628   5290 ED A0       > ldi
1628   5292 ED A0       > ldi
1628   5294 ED A0       > ldi
1628   5296 ED A0       > ldi
1628   5298 ED A0       > ldi
1628   529A ED A0       > ldi
1628   529C ED A0       > ldi
1628   529E ED A0       > ldi
1628   52A0 ED A0       > ldi
1628   52A2 ED A0       > ldi
1628   52A4 ED A0       > ldi
1628   52A6 ED A0       > ldi
1628   52A8 ED A0       > ldi
1628   52AA ED A0       > ldi
1628   52AC ED A0       > ldi
1628   52AE ED A0       > ldi
1628   52B0 ED A0       > ldi
1628   52B2 ED A0       > ldi
1628   52B4 ED A0       > ldi
1628   52B6 ED A0       > ldi
1628   52B8 ED A0       > ldi
1628   52BA ED A0       > ldi
1628   52BC ED A0       > ldi
1628   52BE ED A0       > ldi
1628   52C0 ED A0       > ldi
1628   52C2 ED A0       > ldi
1628   52C4 ED A0       > ldi
1628   52C6 ED A0       > ldi
1628   52C8 ED A0       > ldi
1628   52CA ED A0       > ldi
1628   52CC ED A0       > ldi
1628   52CE ED A0       > ldi
1628   52D0 ED A0       > ldi
1628   52D2 ED A0       > ldi
1628   52D4 ED A0       > ldi
1628   52D6 ED A0       > ldi
1628   52D8 ED A0       > ldi
1628   52DA ED A0       > ldi
1628   52DC ED A0       > ldi
1628   52DE ED A0       > ldi
1628   52E0 ED A0       > ldi
1628   52E2 ED A0       > ldi
1628   52E4 ED A0       > ldi
1628   52E6 ED A0       > ldi
1628   52E8 ED A0       > ldi
1628   52EA ED A0       > ldi
1628   52EC ED A0       > ldi
1628   52EE ED A0       > ldi
1628   52F0 ED A0       > ldi
1628   52F2 ED A0       > ldi
1628   52F4 ED A0       > ldi
1628   52F6 ED A0       > ldi
1628   52F8 ED A0       > ldi
1628   52FA ED A0       > ldi
1628   52FC ED A0       > ldi
1628   52FE ED A0       > ldi
1628   5300 ED A0       > ldi
1628   5302 ED A0       > ldi
1628   5304 ED A0       > ldi
1628   5306 ED A0       > ldi
1628   5308 ED A0       > ldi
1628   530A ED A0       > ldi
1628   530C ED A0       > ldi
1628   530E ED A0       > ldi
1628   5310 ED A0       > ldi
1628   5312 ED A0       > ldi
1628   5314 ED A0       > ldi
1628   5316 ED A0       > ldi
1628   5318 ED A0       > ldi
1628   531A ED A0       > ldi
1628   531C ED A0       > ldi
1628   531E ED A0       > ldi
1628   5320 ED A0       > ldi
1628   5322 ED A0       > ldi
1628   5324 ED A0       > ldi
1628   5326 ED A0       > ldi
1628   5328 ED A0       > ldi
1628   532A ED A0       > ldi
1628   532C ED A0       > ldi
1628   532E ED A0       > ldi
1628   5330 ED A0       > ldi
1628   5332 ED A0       > ldi
1628   5334 ED A0       > ldi
1628   5336 ED A0       > ldi
1628   5338 ED A0       > ldi
1628   533A ED A0       > ldi
1628   533C ED A0       > ldi
1628   533E ED A0       > ldi
1628   5340 ED A0       > ldi
1628   5342 ED A0       > ldi
1628   5344 ED A0       > ldi
1628   5346 ED A0       > ldi
1628   5348 ED A0       > ldi
1628   534A ED A0       > ldi
1628   534C ED A0       > ldi
1628   534E ED A0       > ldi
1628   5350 ED A0       > ldi
1628   5352 ED A0       > ldi
1628   5354 ED A0       > ldi
1628   5356 ED A0       > ldi
1628   5358 ED A0       > ldi
1628   535A ED A0       > ldi
1628   535C ED A0       > ldi
1628   535E ED A0       > ldi
1628   5360 ED A0       > ldi
1628   5362 ED A0       > ldi
1628   5364 ED A0       > ldi
1628   5366 ED A0       > ldi
1628   5368 ED A0       > ldi
1628   536A ED A0       > ldi
1628   536C ED A0       > ldi
1628   536E ED A0       > ldi
1628   5370 ED A0       > ldi
1628   5372 ED A0       > ldi
1628   5374 ED A0       > ldi
1628   5376 ED A0       > ldi
1628   5378 ED A0       > ldi
1628   537A ED A0       > ldi
1628   537C ED A0       > ldi
1628   537E ED A0       > ldi
1628   5380 ED A0       > ldi
1628   5382 ED A0       > ldi
1628   5384 ED A0       > ldi
1628   5386 ED A0       > ldi
1628   5388 ED A0       > ldi
1628   538A ED A0       > ldi
1628   538C ED A0       > ldi
1628   538E ED A0       > ldi
1628   5390 ED A0       > ldi
1628   5392 ED A0       > ldi
1628   5394 ED A0       > ldi
1628   5396 ED A0       > ldi
1628   5398 ED A0       > ldi
1628   539A ED A0       > ldi
1628   539C ED A0       > ldi
1628   539E ED A0       > ldi
1628   53A0 ED A0       > ldi
1628   53A2 ED A0       > ldi
1628   53A4 ED A0       > ldi
1628   53A6 ED A0       > ldi
1628   53A8 ED A0       > ldi
1628   53AA ED A0       > ldi
1628   53AC ED A0       > ldi
1628   53AE ED A0       > ldi
1628   53B0 ED A0       > ldi
1628   53B2 ED A0       > ldi
1628   53B4 ED A0       > ldi
1628   53B6 ED A0       > ldi
1628   53B8 ED A0       > ldi
1628   53BA ED A0       > ldi
1628   53BC ED A0       > ldi
1628   53BE ED A0       > ldi
1628   53C0 ED A0       > ldi
1628   53C2 ED A0       > ldi
1628   53C4 ED A0       > ldi
1628   53C6 ED A0       > ldi
1628   53C8 ED A0       > ldi
1628   53CA ED A0       > ldi
1628   53CC ED A0       > ldi
1628   53CE ED A0       > ldi
1628   53D0 ED A0       > ldi
1628   53D2 ED A0       > ldi
1628   53D4 ED A0       > ldi
1628   53D6 ED A0       > ldi
1628   53D8 ED A0       > ldi
1628   53DA ED A0       > ldi
1628   53DC ED A0       > ldi
1628   53DE ED A0       > ldi
1628   53E0 ED A0       > ldi
1628   53E2 ED A0       > ldi
1628   53E4 ED A0       > ldi
1628   53E6 ED A0       > ldi
1628   53E8 ED A0       > ldi
1628   53EA ED A0       > ldi
1628   53EC ED A0       > ldi
1628   53EE ED A0       > ldi
1628   53F0 ED A0       > ldi
1628   53F2 ED A0       > ldi
1628   53F4 ED A0       > ldi
1628   53F6 ED A0       > ldi
1628   53F8 ED A0       > ldi
1628   53FA ED A0       > ldi
1628   53FC ED A0       > ldi
1628   53FE ED A0       > ldi
1628   5400 ED A0       > ldi
1628   5402 ED A0       > ldi
1628   5404 ED A0       > ldi
1628   5406 ED A0       > ldi
1628   5408 ED A0       > ldi
1628   540A ED A0       > ldi
1628   540C ED A0       > ldi
1628   540E ED A0       > ldi
1628   5410 ED A0       > ldi
1628   5412 ED A0       > ldi
1628   5414 ED A0       > ldi
1628   5416 ED A0       > ldi
1628   5418 ED A0       > ldi
1628   541A ED A0       > ldi
1628   541C ED A0       > ldi
1628   541E ED A0       > ldi
1628   5420 ED A0       > ldi
1628   5422 ED A0       > ldi
1628   5424 ED A0       > ldi
1628   5426 ED A0       > ldi
1628   5428 ED A0       > ldi
1628   542A ED A0       > ldi
1628   542C ED A0       > ldi
1628   542E ED A0       > ldi
1628   5430 ED A0       > ldi
1628   5432 ED A0       > ldi
1628   5434 ED A0       > ldi
1628   5436 ED A0       > ldi
1628   5438 ED A0       > ldi
1628   543A ED A0       > ldi
1628   543C ED A0       > ldi
1628   543E ED A0       > ldi
1628   5440 ED A0       > ldi
1628   5442 ED A0       > ldi
1628   5444 ED A0       > ldi
1628   5446 ED A0       > ldi
1628   5448 ED A0       > ldi
1628   544A ED A0       > ldi
1628   544C ED A0       > ldi
1628   544E ED A0       > ldi
1628   5450 ED A0       > ldi
1628   5452 ED A0       > ldi
1628   5454 ED A0       > ldi
1628   5456 ED A0       > ldi
1628   5458 ED A0       > ldi
1628   545A ED A0       > ldi
1628   545C ED A0       > ldi
1628   545E ED A0       > ldi
1628   5460 ED A0       > ldi
1628   5462 ED A0       > ldi
1628   5464 ED A0       > ldi
1628   5466 ED A0       > ldi
1628   5468 ED A0       > ldi
1628   546A ED A0       > ldi
1628   546C ED A0       > ldi
1628   546E ED A0       > ldi
1628   5470 ED A0       > ldi
1628   5472 ED A0       > ldi
1628   5474 ED A0       > ldi
1628   5476 ED A0       > ldi
1628   5478 ED A0       > ldi
1628   547A ED A0       > ldi
1628   547C ED A0       > ldi
1628   547E ED A0       > ldi
1628   5480 ED A0       > ldi
1628   5482 ED A0       > ldi
1628   5484 ED A0       > ldi
1628   5486 ED A0       > ldi
1628   5488 ED A0       > ldi
1628   548A ED A0       > ldi
1628   548C ED A0       > ldi
1628   548E ED A0       > ldi
1628   5490 ED A0       > ldi
1628   5492 ED A0       > ldi
1628   5494 ED A0       > ldi
1628   5496 ED A0       > ldi
1628   5498 ED A0       > ldi
1628   549A ED A0       > ldi
1628   549C ED A0       > ldi
1628   549E ED A0       > ldi
1628   54A0 ED A0       > ldi
1628   54A2 ED A0       > ldi
1628   54A4 ED A0       > ldi
1628   54A6 ED A0       > ldi
1628   54A8 ED A0       > ldi
1628   54AA ED A0       > ldi
1628   54AC ED A0       > ldi
1628   54AE ED A0       > ldi
1628   54B0 ED A0       > ldi
1628   54B2 ED A0       > ldi
1628   54B4 ED A0       > ldi
1628   54B6 ED A0       > ldi
1628   54B8 ED A0       > ldi
1628   54BA ED A0       > ldi
1628   54BC ED A0       > ldi
1628   54BE ED A0       > ldi
1628   54C0 ED A0       > ldi
1628   54C2 ED A0       > ldi
1628   54C4 ED A0       > ldi
1628   54C6 ED A0       > ldi
1628   54C8 ED A0       > ldi
1628   54CA ED A0       > ldi
1628   54CC ED A0       > ldi
1628   54CE ED A0       > ldi
1628   54D0 ED A0       > ldi
1628   54D2 ED A0       > ldi
1628   54D4 ED A0       > ldi
1628   54D6 ED A0       > ldi
1628   54D8 ED A0       > ldi
1628   54DA ED A0       > ldi
1628   54DC ED A0       > ldi
1628   54DE ED A0       > ldi
1628   54E0 ED A0       > ldi
1628   54E2 ED A0       > ldi
1628   54E4 ED A0       > ldi
1628   54E6 ED A0       > ldi
1628   54E8 ED A0       > ldi
1628   54EA ED A0       > ldi
1628   54EC ED A0       > ldi
1628   54EE ED A0       > ldi
1628   54F0 ED A0       > ldi
1628   54F2 ED A0       > ldi
1628   54F4 ED A0       > ldi
1628   54F6 ED A0       > ldi
1628   54F8 ED A0       > ldi
1628   54FA ED A0       > ldi
1628   54FC ED A0       > ldi
1628   54FE ED A0       > ldi
1628   5500 ED A0       > ldi
1628   5502 ED A0       > ldi
1628   5504 ED A0       > ldi
1628   5506 ED A0       > ldi
1628   5508 ED A0       > ldi
1628   550A ED A0       > ldi
1628   550C ED A0       > ldi
1628   550E ED A0       > ldi
1628   5510 ED A0       > ldi
1628   5512 ED A0       > ldi
1628   5514 ED A0       > ldi
1628   5516 ED A0       > ldi
1628   5518 ED A0       > ldi
1628   551A ED A0       > ldi
1628   551C ED A0       > ldi
1628   551E ED A0       > ldi
1628   5520 ED A0       > ldi
1628   5522 ED A0       > ldi
1628   5524 ED A0       > ldi
1628   5526 ED A0       > ldi
1628   5528 ED A0       > ldi
1628   552A ED A0       > ldi
1628   552C ED A0       > ldi
1628   552E ED A0       > ldi
1628   5530 ED A0       > ldi
1628   5532 ED A0       > ldi
1628   5534 ED A0       > ldi
1628   5536 ED A0       > ldi
1628   5538 ED A0       > ldi
1628   553A ED A0       > ldi
1628   553C ED A0       > ldi
1628   553E ED A0       > ldi
1628   5540 ED A0       > ldi
1628   5542 ED A0       > ldi
1628   5544 ED A0       > ldi
1628   5546 ED A0       > ldi
1628   5548 ED A0       > ldi
1628   554A ED A0       > ldi
1628   554C ED A0       > ldi
1628   554E ED A0       > ldi
1628   5550 ED A0       > ldi
1628   5552 ED A0       > ldi
1628   5554 ED A0       > ldi
1628   5556 ED A0       > ldi
1628   5558 ED A0       > ldi
1628   555A ED A0       > ldi
1628   555C ED A0       > ldi
1628   555E ED A0       > ldi
1628   5560 ED A0       > ldi
1628   5562 ED A0       > ldi
1628   5564 ED A0       > ldi
1628   5566 ED A0       > ldi
1628   5568 ED A0       > ldi
1628   556A ED A0       > ldi
1628   556C ED A0       > ldi
1628   556E ED A0       > ldi
1628   5570 ED A0       > ldi
1628   5572 ED A0       > ldi
1628   5574 ED A0       > ldi
1628   5576 ED A0       > ldi
1628   5578 ED A0       > ldi
1628   557A ED A0       > ldi
1628   557C ED A0       > ldi
1628   557E ED A0       > ldi
1628   5580 ED A0       > ldi
1628   5582 ED A0       > ldi
1628   5584 ED A0       > ldi
1628   5586 ED A0       > ldi
1628   5588 ED A0       > ldi
1628   558A ED A0       > ldi
1628   558C ED A0       > ldi
1628   558E ED A0       > ldi
1628   5590 ED A0       > ldi
1628   5592 ED A0       > ldi
1628   5594 ED A0       > ldi
1628   5596 ED A0       > ldi
1628   5598 ED A0       > ldi
1628   559A ED A0       > ldi
1628   559C ED A0       > ldi
1628   559E ED A0       > ldi
1628   55A0 ED A0       > ldi
1628   55A2 ED A0       > ldi
1628   55A4 ED A0       > ldi
1628   55A6 ED A0       > ldi
1628   55A8 ED A0       > ldi
1628   55AA ED A0       > ldi
1628   55AC ED A0       > ldi
1628   55AE ED A0       > ldi
1628   55B0 ED A0       > ldi
1628   55B2 ED A0       > ldi
1629   55B4             .part2s: 
1630   55B4 3E FF       	ld	a, $FF		; envia dummy CRC
1631   55B6 32 00 40    	ld	(PORTSPI),a
1632   55B9 32 00 40    	ld	(PORTSPI),a
1633   55BC CD A1 4C    	call	WAIT_RESP_NO_FF	; esperar cartao
1634   55BF E6 1F       	and	$1F		; testa bits erro
1635   55C1 FE 05       	cp	5
1636   55C3 37          	scf
1637   55C4 C2 CE 55    	jp	nz,terminaLeituraEscritaBloco	; resposta errada, informar erro
1638   55C7             .esp: 
1639   55C7 CD A1 4C    	call	WAIT_RESP_NO_FF	; esperar cartao
1640   55CA B7          	or	a
1641   55CB 28 FA       	jr	z,.esp
1642   55CD             .fim: 
1643   55CD AF          	xor	a		; zera carry e informa nenhum erro
1644   55CE             terminaLeituraEscritaBloco: 
1645   55CE F5          	push	af
1646   55CF CD 2A 4C    	call	desabilitaSDs	; desabilitar todos os cartoes
1647   55D2 F1          	pop	af
1648   55D3 C9          	ret
1649   55D4             
1650   55D4             
1651   55D4             ; ------------------------------------------------
1652   55D4             ; Ler um bloco de 512 bytes do cartao
1653   55D4             ; HL aponta para o inicio dos dados
1654   55D4             ; BC e DE contem o numero do bloco (BCDE = 32 bits)
1655   55D4             ; Destroi AF, BC, DE, HL, IXL
1656   55D4             ; ------------------------------------------------
1657   55D4             LerBloco: 
1658   55D4 DD 2D       	dec	ixl		; SDcard V1?
1659   55D6 FC 76 5E    	call	m,blocoParaByte	; Yes, convert blocks to bytes 
1660   55D9 CD CD 4C    	call	setaSDAtual
1661   55DC DD 7C       	ld	a,ixh		; get Number of blocks to write
1662   55DE 3D          	dec	a
1663   55DF CA 56 5A    	jp	z,.umBloco	; somente um bloco, pular
1664   55E2             
1665   55E2             ; multiplos blocos
1666   55E2 3E 52       	ld	a, CMD18	; CMD18 = Read Multiple Blocks
1667   55E4 CD 47 4C    	call	SD_SEND_CMD_GET_ERROR
1668   55E7 38 E5       	jr	c,terminaLeituraEscritaBloco
1669   55E9             
1670   55E9 EB          	ex	de,hl		; de=destination address
1671   55EA             	; Check for a Z80 or R800
1672   55EA             ;	ld	a,20
1673   55EA 3D          	dec	a		; a=FFh
1674   55EB ED F9       	db	#ED,#F9		; mulub a,a
1675   55ED 30 32       	jr	nc,.loopZ80	; Use the Z80 optimized loop
1676   55EF             
1677   55EF D9          	exx
1678   55F0 CD 79 60    	call	GTR800LDIR
1679   55F3 D9          	exx			; hl'=Pointer to R800LDIR helper routine
1680   55F4             .loopR800: 
1681   55F4 06 00       	ld	b,0
1682   55F6 3A E7 00    	ld	a,(#E7)
1683   55F9 4F          	ld	c,a
1684   55FA             .rwaitFE: 
1685   55FA 3A 00 40    	ld	a,(PORTSPI)
1686   55FD FE FE       	cp	$FE
1687   55FF 28 0D       	jr	z,.rFEok
1688   5601 10 F7       	djnz	.rwaitFE	; fast card wait
1689   5603 3A E7 00    	ld	a,(#E7)
1690   5606 91          	sub	c
1691   5607 FE 64       	cp	100		; 100mS?
1692   5609 38 EF       	jr	c,.rwaitFE	; slow card wait
1693   560B 37          	scf
1694   560C 18 C0       	jr	terminaLeituraEscritaBloco
1695   560E             .rFEok: 
1696   560E 21 00 40    	ld	hl,PORTSPI
1697   5611 CD 82 5E    	call	R800LDIR
1698   5614 3A 00 40    	ld	a, (PORTSPI)	; discard 16bit CRC
1699   5617 3A 00 40    	ld	a, (PORTSPI)
1700   561A DD 25       	dec	ixh		; nblocks=nblocks-1
1701   561C 20 D6       	jr	nz,.loopR800
1702   561E C3 43 5A    	jp	.loopend
1703   5621             
1704   5621             .loopZ80: 
1705   5621 01 00 00    	ld	bc,0
1706   5624             .zwaitFE: 
1707   5624 3A 00 40    	ld	a,(PORTSPI)
1708   5627 FE FE       	cp	$FE
1709   5629 28 0A       	jr	z,.zFEok
1710   562B 10 F7       	djnz	.zwaitFE	; fast card wait
1711   562D E3          	ex	(sp),hl
1712   562E E3          	ex	(sp),hl
1713   562F 0D          	dec	c
1714   5630 20 F2       	jr	nz,.zwaitFE	; slow card wait
1715   5632 37          	scf
1716   5633 18 99       	jr	terminaLeituraEscritaBloco
1717   5635             .zFEok: 
1718   5635 21 00 40    	ld	hl,PORTSPI
1719   5638 ED A0       > ldi
1719   563A ED A0       > ldi
1719   563C ED A0       > ldi
1719   563E ED A0       > ldi
1719   5640 ED A0       > ldi
1719   5642 ED A0       > ldi
1719   5644 ED A0       > ldi
1719   5646 ED A0       > ldi
1719   5648 ED A0       > ldi
1719   564A ED A0       > ldi
1719   564C ED A0       > ldi
1719   564E ED A0       > ldi
1719   5650 ED A0       > ldi
1719   5652 ED A0       > ldi
1719   5654 ED A0       > ldi
1719   5656 ED A0       > ldi
1719   5658 ED A0       > ldi
1719   565A ED A0       > ldi
1719   565C ED A0       > ldi
1719   565E ED A0       > ldi
1719   5660 ED A0       > ldi
1719   5662 ED A0       > ldi
1719   5664 ED A0       > ldi
1719   5666 ED A0       > ldi
1719   5668 ED A0       > ldi
1719   566A ED A0       > ldi
1719   566C ED A0       > ldi
1719   566E ED A0       > ldi
1719   5670 ED A0       > ldi
1719   5672 ED A0       > ldi
1719   5674 ED A0       > ldi
1719   5676 ED A0       > ldi
1719   5678 ED A0       > ldi
1719   567A ED A0       > ldi
1719   567C ED A0       > ldi
1719   567E ED A0       > ldi
1719   5680 ED A0       > ldi
1719   5682 ED A0       > ldi
1719   5684 ED A0       > ldi
1719   5686 ED A0       > ldi
1719   5688 ED A0       > ldi
1719   568A ED A0       > ldi
1719   568C ED A0       > ldi
1719   568E ED A0       > ldi
1719   5690 ED A0       > ldi
1719   5692 ED A0       > ldi
1719   5694 ED A0       > ldi
1719   5696 ED A0       > ldi
1719   5698 ED A0       > ldi
1719   569A ED A0       > ldi
1719   569C ED A0       > ldi
1719   569E ED A0       > ldi
1719   56A0 ED A0       > ldi
1719   56A2 ED A0       > ldi
1719   56A4 ED A0       > ldi
1719   56A6 ED A0       > ldi
1719   56A8 ED A0       > ldi
1719   56AA ED A0       > ldi
1719   56AC ED A0       > ldi
1719   56AE ED A0       > ldi
1719   56B0 ED A0       > ldi
1719   56B2 ED A0       > ldi
1719   56B4 ED A0       > ldi
1719   56B6 ED A0       > ldi
1719   56B8 ED A0       > ldi
1719   56BA ED A0       > ldi
1719   56BC ED A0       > ldi
1719   56BE ED A0       > ldi
1719   56C0 ED A0       > ldi
1719   56C2 ED A0       > ldi
1719   56C4 ED A0       > ldi
1719   56C6 ED A0       > ldi
1719   56C8 ED A0       > ldi
1719   56CA ED A0       > ldi
1719   56CC ED A0       > ldi
1719   56CE ED A0       > ldi
1719   56D0 ED A0       > ldi
1719   56D2 ED A0       > ldi
1719   56D4 ED A0       > ldi
1719   56D6 ED A0       > ldi
1719   56D8 ED A0       > ldi
1719   56DA ED A0       > ldi
1719   56DC ED A0       > ldi
1719   56DE ED A0       > ldi
1719   56E0 ED A0       > ldi
1719   56E2 ED A0       > ldi
1719   56E4 ED A0       > ldi
1719   56E6 ED A0       > ldi
1719   56E8 ED A0       > ldi
1719   56EA ED A0       > ldi
1719   56EC ED A0       > ldi
1719   56EE ED A0       > ldi
1719   56F0 ED A0       > ldi
1719   56F2 ED A0       > ldi
1719   56F4 ED A0       > ldi
1719   56F6 ED A0       > ldi
1719   56F8 ED A0       > ldi
1719   56FA ED A0       > ldi
1719   56FC ED A0       > ldi
1719   56FE ED A0       > ldi
1719   5700 ED A0       > ldi
1719   5702 ED A0       > ldi
1719   5704 ED A0       > ldi
1719   5706 ED A0       > ldi
1719   5708 ED A0       > ldi
1719   570A ED A0       > ldi
1719   570C ED A0       > ldi
1719   570E ED A0       > ldi
1719   5710 ED A0       > ldi
1719   5712 ED A0       > ldi
1719   5714 ED A0       > ldi
1719   5716 ED A0       > ldi
1719   5718 ED A0       > ldi
1719   571A ED A0       > ldi
1719   571C ED A0       > ldi
1719   571E ED A0       > ldi
1719   5720 ED A0       > ldi
1719   5722 ED A0       > ldi
1719   5724 ED A0       > ldi
1719   5726 ED A0       > ldi
1719   5728 ED A0       > ldi
1719   572A ED A0       > ldi
1719   572C ED A0       > ldi
1719   572E ED A0       > ldi
1719   5730 ED A0       > ldi
1719   5732 ED A0       > ldi
1719   5734 ED A0       > ldi
1719   5736 ED A0       > ldi
1719   5738 ED A0       > ldi
1719   573A ED A0       > ldi
1719   573C ED A0       > ldi
1719   573E ED A0       > ldi
1719   5740 ED A0       > ldi
1719   5742 ED A0       > ldi
1719   5744 ED A0       > ldi
1719   5746 ED A0       > ldi
1719   5748 ED A0       > ldi
1719   574A ED A0       > ldi
1719   574C ED A0       > ldi
1719   574E ED A0       > ldi
1719   5750 ED A0       > ldi
1719   5752 ED A0       > ldi
1719   5754 ED A0       > ldi
1719   5756 ED A0       > ldi
1719   5758 ED A0       > ldi
1719   575A ED A0       > ldi
1719   575C ED A0       > ldi
1719   575E ED A0       > ldi
1719   5760 ED A0       > ldi
1719   5762 ED A0       > ldi
1719   5764 ED A0       > ldi
1719   5766 ED A0       > ldi
1719   5768 ED A0       > ldi
1719   576A ED A0       > ldi
1719   576C ED A0       > ldi
1719   576E ED A0       > ldi
1719   5770 ED A0       > ldi
1719   5772 ED A0       > ldi
1719   5774 ED A0       > ldi
1719   5776 ED A0       > ldi
1719   5778 ED A0       > ldi
1719   577A ED A0       > ldi
1719   577C ED A0       > ldi
1719   577E ED A0       > ldi
1719   5780 ED A0       > ldi
1719   5782 ED A0       > ldi
1719   5784 ED A0       > ldi
1719   5786 ED A0       > ldi
1719   5788 ED A0       > ldi
1719   578A ED A0       > ldi
1719   578C ED A0       > ldi
1719   578E ED A0       > ldi
1719   5790 ED A0       > ldi
1719   5792 ED A0       > ldi
1719   5794 ED A0       > ldi
1719   5796 ED A0       > ldi
1719   5798 ED A0       > ldi
1719   579A ED A0       > ldi
1719   579C ED A0       > ldi
1719   579E ED A0       > ldi
1719   57A0 ED A0       > ldi
1719   57A2 ED A0       > ldi
1719   57A4 ED A0       > ldi
1719   57A6 ED A0       > ldi
1719   57A8 ED A0       > ldi
1719   57AA ED A0       > ldi
1719   57AC ED A0       > ldi
1719   57AE ED A0       > ldi
1719   57B0 ED A0       > ldi
1719   57B2 ED A0       > ldi
1719   57B4 ED A0       > ldi
1719   57B6 ED A0       > ldi
1719   57B8 ED A0       > ldi
1719   57BA ED A0       > ldi
1719   57BC ED A0       > ldi
1719   57BE ED A0       > ldi
1719   57C0 ED A0       > ldi
1719   57C2 ED A0       > ldi
1719   57C4 ED A0       > ldi
1719   57C6 ED A0       > ldi
1719   57C8 ED A0       > ldi
1719   57CA ED A0       > ldi
1719   57CC ED A0       > ldi
1719   57CE ED A0       > ldi
1719   57D0 ED A0       > ldi
1719   57D2 ED A0       > ldi
1719   57D4 ED A0       > ldi
1719   57D6 ED A0       > ldi
1719   57D8 ED A0       > ldi
1719   57DA ED A0       > ldi
1719   57DC ED A0       > ldi
1719   57DE ED A0       > ldi
1719   57E0 ED A0       > ldi
1719   57E2 ED A0       > ldi
1719   57E4 ED A0       > ldi
1719   57E6 ED A0       > ldi
1719   57E8 ED A0       > ldi
1719   57EA ED A0       > ldi
1719   57EC ED A0       > ldi
1719   57EE ED A0       > ldi
1719   57F0 ED A0       > ldi
1719   57F2 ED A0       > ldi
1719   57F4 ED A0       > ldi
1719   57F6 ED A0       > ldi
1719   57F8 ED A0       > ldi
1719   57FA ED A0       > ldi
1719   57FC ED A0       > ldi
1719   57FE ED A0       > ldi
1719   5800 ED A0       > ldi
1719   5802 ED A0       > ldi
1719   5804 ED A0       > ldi
1719   5806 ED A0       > ldi
1719   5808 ED A0       > ldi
1719   580A ED A0       > ldi
1719   580C ED A0       > ldi
1719   580E ED A0       > ldi
1719   5810 ED A0       > ldi
1719   5812 ED A0       > ldi
1719   5814 ED A0       > ldi
1719   5816 ED A0       > ldi
1719   5818 ED A0       > ldi
1719   581A ED A0       > ldi
1719   581C ED A0       > ldi
1719   581E ED A0       > ldi
1719   5820 ED A0       > ldi
1719   5822 ED A0       > ldi
1719   5824 ED A0       > ldi
1719   5826 ED A0       > ldi
1719   5828 ED A0       > ldi
1719   582A ED A0       > ldi
1719   582C ED A0       > ldi
1719   582E ED A0       > ldi
1719   5830 ED A0       > ldi
1719   5832 ED A0       > ldi
1719   5834 ED A0       > ldi
1719   5836 ED A0       > ldi
1719   5838 ED A0       > ldi
1719   583A ED A0       > ldi
1719   583C ED A0       > ldi
1719   583E ED A0       > ldi
1719   5840 ED A0       > ldi
1719   5842 ED A0       > ldi
1719   5844 ED A0       > ldi
1719   5846 ED A0       > ldi
1719   5848 ED A0       > ldi
1719   584A ED A0       > ldi
1719   584C ED A0       > ldi
1719   584E ED A0       > ldi
1719   5850 ED A0       > ldi
1719   5852 ED A0       > ldi
1719   5854 ED A0       > ldi
1719   5856 ED A0       > ldi
1719   5858 ED A0       > ldi
1719   585A ED A0       > ldi
1719   585C ED A0       > ldi
1719   585E ED A0       > ldi
1719   5860 ED A0       > ldi
1719   5862 ED A0       > ldi
1719   5864 ED A0       > ldi
1719   5866 ED A0       > ldi
1719   5868 ED A0       > ldi
1719   586A ED A0       > ldi
1719   586C ED A0       > ldi
1719   586E ED A0       > ldi
1719   5870 ED A0       > ldi
1719   5872 ED A0       > ldi
1719   5874 ED A0       > ldi
1719   5876 ED A0       > ldi
1719   5878 ED A0       > ldi
1719   587A ED A0       > ldi
1719   587C ED A0       > ldi
1719   587E ED A0       > ldi
1719   5880 ED A0       > ldi
1719   5882 ED A0       > ldi
1719   5884 ED A0       > ldi
1719   5886 ED A0       > ldi
1719   5888 ED A0       > ldi
1719   588A ED A0       > ldi
1719   588C ED A0       > ldi
1719   588E ED A0       > ldi
1719   5890 ED A0       > ldi
1719   5892 ED A0       > ldi
1719   5894 ED A0       > ldi
1719   5896 ED A0       > ldi
1719   5898 ED A0       > ldi
1719   589A ED A0       > ldi
1719   589C ED A0       > ldi
1719   589E ED A0       > ldi
1719   58A0 ED A0       > ldi
1719   58A2 ED A0       > ldi
1719   58A4 ED A0       > ldi
1719   58A6 ED A0       > ldi
1719   58A8 ED A0       > ldi
1719   58AA ED A0       > ldi
1719   58AC ED A0       > ldi
1719   58AE ED A0       > ldi
1719   58B0 ED A0       > ldi
1719   58B2 ED A0       > ldi
1719   58B4 ED A0       > ldi
1719   58B6 ED A0       > ldi
1719   58B8 ED A0       > ldi
1719   58BA ED A0       > ldi
1719   58BC ED A0       > ldi
1719   58BE ED A0       > ldi
1719   58C0 ED A0       > ldi
1719   58C2 ED A0       > ldi
1719   58C4 ED A0       > ldi
1719   58C6 ED A0       > ldi
1719   58C8 ED A0       > ldi
1719   58CA ED A0       > ldi
1719   58CC ED A0       > ldi
1719   58CE ED A0       > ldi
1719   58D0 ED A0       > ldi
1719   58D2 ED A0       > ldi
1719   58D4 ED A0       > ldi
1719   58D6 ED A0       > ldi
1719   58D8 ED A0       > ldi
1719   58DA ED A0       > ldi
1719   58DC ED A0       > ldi
1719   58DE ED A0       > ldi
1719   58E0 ED A0       > ldi
1719   58E2 ED A0       > ldi
1719   58E4 ED A0       > ldi
1719   58E6 ED A0       > ldi
1719   58E8 ED A0       > ldi
1719   58EA ED A0       > ldi
1719   58EC ED A0       > ldi
1719   58EE ED A0       > ldi
1719   58F0 ED A0       > ldi
1719   58F2 ED A0       > ldi
1719   58F4 ED A0       > ldi
1719   58F6 ED A0       > ldi
1719   58F8 ED A0       > ldi
1719   58FA ED A0       > ldi
1719   58FC ED A0       > ldi
1719   58FE ED A0       > ldi
1719   5900 ED A0       > ldi
1719   5902 ED A0       > ldi
1719   5904 ED A0       > ldi
1719   5906 ED A0       > ldi
1719   5908 ED A0       > ldi
1719   590A ED A0       > ldi
1719   590C ED A0       > ldi
1719   590E ED A0       > ldi
1719   5910 ED A0       > ldi
1719   5912 ED A0       > ldi
1719   5914 ED A0       > ldi
1719   5916 ED A0       > ldi
1719   5918 ED A0       > ldi
1719   591A ED A0       > ldi
1719   591C ED A0       > ldi
1719   591E ED A0       > ldi
1719   5920 ED A0       > ldi
1719   5922 ED A0       > ldi
1719   5924 ED A0       > ldi
1719   5926 ED A0       > ldi
1719   5928 ED A0       > ldi
1719   592A ED A0       > ldi
1719   592C ED A0       > ldi
1719   592E ED A0       > ldi
1719   5930 ED A0       > ldi
1719   5932 ED A0       > ldi
1719   5934 ED A0       > ldi
1719   5936 ED A0       > ldi
1719   5938 ED A0       > ldi
1719   593A ED A0       > ldi
1719   593C ED A0       > ldi
1719   593E ED A0       > ldi
1719   5940 ED A0       > ldi
1719   5942 ED A0       > ldi
1719   5944 ED A0       > ldi
1719   5946 ED A0       > ldi
1719   5948 ED A0       > ldi
1719   594A ED A0       > ldi
1719   594C ED A0       > ldi
1719   594E ED A0       > ldi
1719   5950 ED A0       > ldi
1719   5952 ED A0       > ldi
1719   5954 ED A0       > ldi
1719   5956 ED A0       > ldi
1719   5958 ED A0       > ldi
1719   595A ED A0       > ldi
1719   595C ED A0       > ldi
1719   595E ED A0       > ldi
1719   5960 ED A0       > ldi
1719   5962 ED A0       > ldi
1719   5964 ED A0       > ldi
1719   5966 ED A0       > ldi
1719   5968 ED A0       > ldi
1719   596A ED A0       > ldi
1719   596C ED A0       > ldi
1719   596E ED A0       > ldi
1719   5970 ED A0       > ldi
1719   5972 ED A0       > ldi
1719   5974 ED A0       > ldi
1719   5976 ED A0       > ldi
1719   5978 ED A0       > ldi
1719   597A ED A0       > ldi
1719   597C ED A0       > ldi
1719   597E ED A0       > ldi
1719   5980 ED A0       > ldi
1719   5982 ED A0       > ldi
1719   5984 ED A0       > ldi
1719   5986 ED A0       > ldi
1719   5988 ED A0       > ldi
1719   598A ED A0       > ldi
1719   598C ED A0       > ldi
1719   598E ED A0       > ldi
1719   5990 ED A0       > ldi
1719   5992 ED A0       > ldi
1719   5994 ED A0       > ldi
1719   5996 ED A0       > ldi
1719   5998 ED A0       > ldi
1719   599A ED A0       > ldi
1719   599C ED A0       > ldi
1719   599E ED A0       > ldi
1719   59A0 ED A0       > ldi
1719   59A2 ED A0       > ldi
1719   59A4 ED A0       > ldi
1719   59A6 ED A0       > ldi
1719   59A8 ED A0       > ldi
1719   59AA ED A0       > ldi
1719   59AC ED A0       > ldi
1719   59AE ED A0       > ldi
1719   59B0 ED A0       > ldi
1719   59B2 ED A0       > ldi
1719   59B4 ED A0       > ldi
1719   59B6 ED A0       > ldi
1719   59B8 ED A0       > ldi
1719   59BA ED A0       > ldi
1719   59BC ED A0       > ldi
1719   59BE ED A0       > ldi
1719   59C0 ED A0       > ldi
1719   59C2 ED A0       > ldi
1719   59C4 ED A0       > ldi
1719   59C6 ED A0       > ldi
1719   59C8 ED A0       > ldi
1719   59CA ED A0       > ldi
1719   59CC ED A0       > ldi
1719   59CE ED A0       > ldi
1719   59D0 ED A0       > ldi
1719   59D2 ED A0       > ldi
1719   59D4 ED A0       > ldi
1719   59D6 ED A0       > ldi
1719   59D8 ED A0       > ldi
1719   59DA ED A0       > ldi
1719   59DC ED A0       > ldi
1719   59DE ED A0       > ldi
1719   59E0 ED A0       > ldi
1719   59E2 ED A0       > ldi
1719   59E4 ED A0       > ldi
1719   59E6 ED A0       > ldi
1719   59E8 ED A0       > ldi
1719   59EA ED A0       > ldi
1719   59EC ED A0       > ldi
1719   59EE ED A0       > ldi
1719   59F0 ED A0       > ldi
1719   59F2 ED A0       > ldi
1719   59F4 ED A0       > ldi
1719   59F6 ED A0       > ldi
1719   59F8 ED A0       > ldi
1719   59FA ED A0       > ldi
1719   59FC ED A0       > ldi
1719   59FE ED A0       > ldi
1719   5A00 ED A0       > ldi
1719   5A02 ED A0       > ldi
1719   5A04 ED A0       > ldi
1719   5A06 ED A0       > ldi
1719   5A08 ED A0       > ldi
1719   5A0A ED A0       > ldi
1719   5A0C ED A0       > ldi
1719   5A0E ED A0       > ldi
1719   5A10 ED A0       > ldi
1719   5A12 ED A0       > ldi
1719   5A14 ED A0       > ldi
1719   5A16 ED A0       > ldi
1719   5A18 ED A0       > ldi
1719   5A1A ED A0       > ldi
1719   5A1C ED A0       > ldi
1719   5A1E ED A0       > ldi
1719   5A20 ED A0       > ldi
1719   5A22 ED A0       > ldi
1719   5A24 ED A0       > ldi
1719   5A26 ED A0       > ldi
1719   5A28 ED A0       > ldi
1719   5A2A ED A0       > ldi
1719   5A2C ED A0       > ldi
1719   5A2E ED A0       > ldi
1719   5A30 ED A0       > ldi
1719   5A32 ED A0       > ldi
1719   5A34 ED A0       > ldi
1719   5A36 ED A0       > ldi
1720   5A38 3A 00 40    	ld	a, (PORTSPI)	; discard 16bit CRC
1721   5A3B 3A 00 40    	ld	a, (PORTSPI)
1722   5A3E DD 25       	dec	ixh		; nblocks=nblocks-1
1723   5A40 C2 21 56    	jp	nz,.loopZ80
1724   5A43             .loopend: 
1725   5A43 3E 4C       	ld	a, CMD12	; acabou os blocos, mandar CMD12 para cancelar leitura
1726   5A45 CD 42 4C    	call	SD_SEND_CMD_NO_ARGS
1727   5A48 C3 72 5E    	jp	.fim
1728   5A4B             
1729   5A4B             .r800s: 	
1730   5A4B D9          	exx
1731   5A4C CD 79 60    	call	GTR800LDIR
1732   5A4F D9          	exx			; hl'=Pointer to R800LDIR helper routine
1733   5A50 CD 82 5E    	call	R800LDIR
1734   5A53 C3 6C 5E    	jp	.part2s
1735   5A56             
1736   5A56             .umBloco: 
1737   5A56 3E 51       	ld	a, CMD17	; CMD17 = Read Single Block
1738   5A58 CD 47 4C    	call	SD_SEND_CMD_GET_ERROR
1739   5A5B DA CE 55    	jp	c,terminaLeituraEscritaBloco
1740   5A5E             
1741   5A5E CD B0 4C    	call	WAIT_RESP_FE
1742   5A61 DA CE 55    	jp	c,terminaLeituraEscritaBloco
1743   5A64 EB          	ex	de,hl
1744   5A65             
1745   5A65             	; Check for a Z80 or R800
1746   5A65             ;	ld	a,20
1747   5A65 ED F9       	db	#ED,#F9		; mulub a,a
1748   5A67 21 00 40    	ld	hl,PORTSPI
1749   5A6A 38 DF       	jr	c,.r800s	; Use LDIR for R800
1750   5A6C ED A0       > ldi
1750   5A6E ED A0       > ldi
1750   5A70 ED A0       > ldi
1750   5A72 ED A0       > ldi
1750   5A74 ED A0       > ldi
1750   5A76 ED A0       > ldi
1750   5A78 ED A0       > ldi
1750   5A7A ED A0       > ldi
1750   5A7C ED A0       > ldi
1750   5A7E ED A0       > ldi
1750   5A80 ED A0       > ldi
1750   5A82 ED A0       > ldi
1750   5A84 ED A0       > ldi
1750   5A86 ED A0       > ldi
1750   5A88 ED A0       > ldi
1750   5A8A ED A0       > ldi
1750   5A8C ED A0       > ldi
1750   5A8E ED A0       > ldi
1750   5A90 ED A0       > ldi
1750   5A92 ED A0       > ldi
1750   5A94 ED A0       > ldi
1750   5A96 ED A0       > ldi
1750   5A98 ED A0       > ldi
1750   5A9A ED A0       > ldi
1750   5A9C ED A0       > ldi
1750   5A9E ED A0       > ldi
1750   5AA0 ED A0       > ldi
1750   5AA2 ED A0       > ldi
1750   5AA4 ED A0       > ldi
1750   5AA6 ED A0       > ldi
1750   5AA8 ED A0       > ldi
1750   5AAA ED A0       > ldi
1750   5AAC ED A0       > ldi
1750   5AAE ED A0       > ldi
1750   5AB0 ED A0       > ldi
1750   5AB2 ED A0       > ldi
1750   5AB4 ED A0       > ldi
1750   5AB6 ED A0       > ldi
1750   5AB8 ED A0       > ldi
1750   5ABA ED A0       > ldi
1750   5ABC ED A0       > ldi
1750   5ABE ED A0       > ldi
1750   5AC0 ED A0       > ldi
1750   5AC2 ED A0       > ldi
1750   5AC4 ED A0       > ldi
1750   5AC6 ED A0       > ldi
1750   5AC8 ED A0       > ldi
1750   5ACA ED A0       > ldi
1750   5ACC ED A0       > ldi
1750   5ACE ED A0       > ldi
1750   5AD0 ED A0       > ldi
1750   5AD2 ED A0       > ldi
1750   5AD4 ED A0       > ldi
1750   5AD6 ED A0       > ldi
1750   5AD8 ED A0       > ldi
1750   5ADA ED A0       > ldi
1750   5ADC ED A0       > ldi
1750   5ADE ED A0       > ldi
1750   5AE0 ED A0       > ldi
1750   5AE2 ED A0       > ldi
1750   5AE4 ED A0       > ldi
1750   5AE6 ED A0       > ldi
1750   5AE8 ED A0       > ldi
1750   5AEA ED A0       > ldi
1750   5AEC ED A0       > ldi
1750   5AEE ED A0       > ldi
1750   5AF0 ED A0       > ldi
1750   5AF2 ED A0       > ldi
1750   5AF4 ED A0       > ldi
1750   5AF6 ED A0       > ldi
1750   5AF8 ED A0       > ldi
1750   5AFA ED A0       > ldi
1750   5AFC ED A0       > ldi
1750   5AFE ED A0       > ldi
1750   5B00 ED A0       > ldi
1750   5B02 ED A0       > ldi
1750   5B04 ED A0       > ldi
1750   5B06 ED A0       > ldi
1750   5B08 ED A0       > ldi
1750   5B0A ED A0       > ldi
1750   5B0C ED A0       > ldi
1750   5B0E ED A0       > ldi
1750   5B10 ED A0       > ldi
1750   5B12 ED A0       > ldi
1750   5B14 ED A0       > ldi
1750   5B16 ED A0       > ldi
1750   5B18 ED A0       > ldi
1750   5B1A ED A0       > ldi
1750   5B1C ED A0       > ldi
1750   5B1E ED A0       > ldi
1750   5B20 ED A0       > ldi
1750   5B22 ED A0       > ldi
1750   5B24 ED A0       > ldi
1750   5B26 ED A0       > ldi
1750   5B28 ED A0       > ldi
1750   5B2A ED A0       > ldi
1750   5B2C ED A0       > ldi
1750   5B2E ED A0       > ldi
1750   5B30 ED A0       > ldi
1750   5B32 ED A0       > ldi
1750   5B34 ED A0       > ldi
1750   5B36 ED A0       > ldi
1750   5B38 ED A0       > ldi
1750   5B3A ED A0       > ldi
1750   5B3C ED A0       > ldi
1750   5B3E ED A0       > ldi
1750   5B40 ED A0       > ldi
1750   5B42 ED A0       > ldi
1750   5B44 ED A0       > ldi
1750   5B46 ED A0       > ldi
1750   5B48 ED A0       > ldi
1750   5B4A ED A0       > ldi
1750   5B4C ED A0       > ldi
1750   5B4E ED A0       > ldi
1750   5B50 ED A0       > ldi
1750   5B52 ED A0       > ldi
1750   5B54 ED A0       > ldi
1750   5B56 ED A0       > ldi
1750   5B58 ED A0       > ldi
1750   5B5A ED A0       > ldi
1750   5B5C ED A0       > ldi
1750   5B5E ED A0       > ldi
1750   5B60 ED A0       > ldi
1750   5B62 ED A0       > ldi
1750   5B64 ED A0       > ldi
1750   5B66 ED A0       > ldi
1750   5B68 ED A0       > ldi
1750   5B6A ED A0       > ldi
1750   5B6C ED A0       > ldi
1750   5B6E ED A0       > ldi
1750   5B70 ED A0       > ldi
1750   5B72 ED A0       > ldi
1750   5B74 ED A0       > ldi
1750   5B76 ED A0       > ldi
1750   5B78 ED A0       > ldi
1750   5B7A ED A0       > ldi
1750   5B7C ED A0       > ldi
1750   5B7E ED A0       > ldi
1750   5B80 ED A0       > ldi
1750   5B82 ED A0       > ldi
1750   5B84 ED A0       > ldi
1750   5B86 ED A0       > ldi
1750   5B88 ED A0       > ldi
1750   5B8A ED A0       > ldi
1750   5B8C ED A0       > ldi
1750   5B8E ED A0       > ldi
1750   5B90 ED A0       > ldi
1750   5B92 ED A0       > ldi
1750   5B94 ED A0       > ldi
1750   5B96 ED A0       > ldi
1750   5B98 ED A0       > ldi
1750   5B9A ED A0       > ldi
1750   5B9C ED A0       > ldi
1750   5B9E ED A0       > ldi
1750   5BA0 ED A0       > ldi
1750   5BA2 ED A0       > ldi
1750   5BA4 ED A0       > ldi
1750   5BA6 ED A0       > ldi
1750   5BA8 ED A0       > ldi
1750   5BAA ED A0       > ldi
1750   5BAC ED A0       > ldi
1750   5BAE ED A0       > ldi
1750   5BB0 ED A0       > ldi
1750   5BB2 ED A0       > ldi
1750   5BB4 ED A0       > ldi
1750   5BB6 ED A0       > ldi
1750   5BB8 ED A0       > ldi
1750   5BBA ED A0       > ldi
1750   5BBC ED A0       > ldi
1750   5BBE ED A0       > ldi
1750   5BC0 ED A0       > ldi
1750   5BC2 ED A0       > ldi
1750   5BC4 ED A0       > ldi
1750   5BC6 ED A0       > ldi
1750   5BC8 ED A0       > ldi
1750   5BCA ED A0       > ldi
1750   5BCC ED A0       > ldi
1750   5BCE ED A0       > ldi
1750   5BD0 ED A0       > ldi
1750   5BD2 ED A0       > ldi
1750   5BD4 ED A0       > ldi
1750   5BD6 ED A0       > ldi
1750   5BD8 ED A0       > ldi
1750   5BDA ED A0       > ldi
1750   5BDC ED A0       > ldi
1750   5BDE ED A0       > ldi
1750   5BE0 ED A0       > ldi
1750   5BE2 ED A0       > ldi
1750   5BE4 ED A0       > ldi
1750   5BE6 ED A0       > ldi
1750   5BE8 ED A0       > ldi
1750   5BEA ED A0       > ldi
1750   5BEC ED A0       > ldi
1750   5BEE ED A0       > ldi
1750   5BF0 ED A0       > ldi
1750   5BF2 ED A0       > ldi
1750   5BF4 ED A0       > ldi
1750   5BF6 ED A0       > ldi
1750   5BF8 ED A0       > ldi
1750   5BFA ED A0       > ldi
1750   5BFC ED A0       > ldi
1750   5BFE ED A0       > ldi
1750   5C00 ED A0       > ldi
1750   5C02 ED A0       > ldi
1750   5C04 ED A0       > ldi
1750   5C06 ED A0       > ldi
1750   5C08 ED A0       > ldi
1750   5C0A ED A0       > ldi
1750   5C0C ED A0       > ldi
1750   5C0E ED A0       > ldi
1750   5C10 ED A0       > ldi
1750   5C12 ED A0       > ldi
1750   5C14 ED A0       > ldi
1750   5C16 ED A0       > ldi
1750   5C18 ED A0       > ldi
1750   5C1A ED A0       > ldi
1750   5C1C ED A0       > ldi
1750   5C1E ED A0       > ldi
1750   5C20 ED A0       > ldi
1750   5C22 ED A0       > ldi
1750   5C24 ED A0       > ldi
1750   5C26 ED A0       > ldi
1750   5C28 ED A0       > ldi
1750   5C2A ED A0       > ldi
1750   5C2C ED A0       > ldi
1750   5C2E ED A0       > ldi
1750   5C30 ED A0       > ldi
1750   5C32 ED A0       > ldi
1750   5C34 ED A0       > ldi
1750   5C36 ED A0       > ldi
1750   5C38 ED A0       > ldi
1750   5C3A ED A0       > ldi
1750   5C3C ED A0       > ldi
1750   5C3E ED A0       > ldi
1750   5C40 ED A0       > ldi
1750   5C42 ED A0       > ldi
1750   5C44 ED A0       > ldi
1750   5C46 ED A0       > ldi
1750   5C48 ED A0       > ldi
1750   5C4A ED A0       > ldi
1750   5C4C ED A0       > ldi
1750   5C4E ED A0       > ldi
1750   5C50 ED A0       > ldi
1750   5C52 ED A0       > ldi
1750   5C54 ED A0       > ldi
1750   5C56 ED A0       > ldi
1750   5C58 ED A0       > ldi
1750   5C5A ED A0       > ldi
1750   5C5C ED A0       > ldi
1750   5C5E ED A0       > ldi
1750   5C60 ED A0       > ldi
1750   5C62 ED A0       > ldi
1750   5C64 ED A0       > ldi
1750   5C66 ED A0       > ldi
1750   5C68 ED A0       > ldi
1750   5C6A ED A0       > ldi
1750   5C6C ED A0       > ldi
1750   5C6E ED A0       > ldi
1750   5C70 ED A0       > ldi
1750   5C72 ED A0       > ldi
1750   5C74 ED A0       > ldi
1750   5C76 ED A0       > ldi
1750   5C78 ED A0       > ldi
1750   5C7A ED A0       > ldi
1750   5C7C ED A0       > ldi
1750   5C7E ED A0       > ldi
1750   5C80 ED A0       > ldi
1750   5C82 ED A0       > ldi
1750   5C84 ED A0       > ldi
1750   5C86 ED A0       > ldi
1750   5C88 ED A0       > ldi
1750   5C8A ED A0       > ldi
1750   5C8C ED A0       > ldi
1750   5C8E ED A0       > ldi
1750   5C90 ED A0       > ldi
1750   5C92 ED A0       > ldi
1750   5C94 ED A0       > ldi
1750   5C96 ED A0       > ldi
1750   5C98 ED A0       > ldi
1750   5C9A ED A0       > ldi
1750   5C9C ED A0       > ldi
1750   5C9E ED A0       > ldi
1750   5CA0 ED A0       > ldi
1750   5CA2 ED A0       > ldi
1750   5CA4 ED A0       > ldi
1750   5CA6 ED A0       > ldi
1750   5CA8 ED A0       > ldi
1750   5CAA ED A0       > ldi
1750   5CAC ED A0       > ldi
1750   5CAE ED A0       > ldi
1750   5CB0 ED A0       > ldi
1750   5CB2 ED A0       > ldi
1750   5CB4 ED A0       > ldi
1750   5CB6 ED A0       > ldi
1750   5CB8 ED A0       > ldi
1750   5CBA ED A0       > ldi
1750   5CBC ED A0       > ldi
1750   5CBE ED A0       > ldi
1750   5CC0 ED A0       > ldi
1750   5CC2 ED A0       > ldi
1750   5CC4 ED A0       > ldi
1750   5CC6 ED A0       > ldi
1750   5CC8 ED A0       > ldi
1750   5CCA ED A0       > ldi
1750   5CCC ED A0       > ldi
1750   5CCE ED A0       > ldi
1750   5CD0 ED A0       > ldi
1750   5CD2 ED A0       > ldi
1750   5CD4 ED A0       > ldi
1750   5CD6 ED A0       > ldi
1750   5CD8 ED A0       > ldi
1750   5CDA ED A0       > ldi
1750   5CDC ED A0       > ldi
1750   5CDE ED A0       > ldi
1750   5CE0 ED A0       > ldi
1750   5CE2 ED A0       > ldi
1750   5CE4 ED A0       > ldi
1750   5CE6 ED A0       > ldi
1750   5CE8 ED A0       > ldi
1750   5CEA ED A0       > ldi
1750   5CEC ED A0       > ldi
1750   5CEE ED A0       > ldi
1750   5CF0 ED A0       > ldi
1750   5CF2 ED A0       > ldi
1750   5CF4 ED A0       > ldi
1750   5CF6 ED A0       > ldi
1750   5CF8 ED A0       > ldi
1750   5CFA ED A0       > ldi
1750   5CFC ED A0       > ldi
1750   5CFE ED A0       > ldi
1750   5D00 ED A0       > ldi
1750   5D02 ED A0       > ldi
1750   5D04 ED A0       > ldi
1750   5D06 ED A0       > ldi
1750   5D08 ED A0       > ldi
1750   5D0A ED A0       > ldi
1750   5D0C ED A0       > ldi
1750   5D0E ED A0       > ldi
1750   5D10 ED A0       > ldi
1750   5D12 ED A0       > ldi
1750   5D14 ED A0       > ldi
1750   5D16 ED A0       > ldi
1750   5D18 ED A0       > ldi
1750   5D1A ED A0       > ldi
1750   5D1C ED A0       > ldi
1750   5D1E ED A0       > ldi
1750   5D20 ED A0       > ldi
1750   5D22 ED A0       > ldi
1750   5D24 ED A0       > ldi
1750   5D26 ED A0       > ldi
1750   5D28 ED A0       > ldi
1750   5D2A ED A0       > ldi
1750   5D2C ED A0       > ldi
1750   5D2E ED A0       > ldi
1750   5D30 ED A0       > ldi
1750   5D32 ED A0       > ldi
1750   5D34 ED A0       > ldi
1750   5D36 ED A0       > ldi
1750   5D38 ED A0       > ldi
1750   5D3A ED A0       > ldi
1750   5D3C ED A0       > ldi
1750   5D3E ED A0       > ldi
1750   5D40 ED A0       > ldi
1750   5D42 ED A0       > ldi
1750   5D44 ED A0       > ldi
1750   5D46 ED A0       > ldi
1750   5D48 ED A0       > ldi
1750   5D4A ED A0       > ldi
1750   5D4C ED A0       > ldi
1750   5D4E ED A0       > ldi
1750   5D50 ED A0       > ldi
1750   5D52 ED A0       > ldi
1750   5D54 ED A0       > ldi
1750   5D56 ED A0       > ldi
1750   5D58 ED A0       > ldi
1750   5D5A ED A0       > ldi
1750   5D5C ED A0       > ldi
1750   5D5E ED A0       > ldi
1750   5D60 ED A0       > ldi
1750   5D62 ED A0       > ldi
1750   5D64 ED A0       > ldi
1750   5D66 ED A0       > ldi
1750   5D68 ED A0       > ldi
1750   5D6A ED A0       > ldi
1750   5D6C ED A0       > ldi
1750   5D6E ED A0       > ldi
1750   5D70 ED A0       > ldi
1750   5D72 ED A0       > ldi
1750   5D74 ED A0       > ldi
1750   5D76 ED A0       > ldi
1750   5D78 ED A0       > ldi
1750   5D7A ED A0       > ldi
1750   5D7C ED A0       > ldi
1750   5D7E ED A0       > ldi
1750   5D80 ED A0       > ldi
1750   5D82 ED A0       > ldi
1750   5D84 ED A0       > ldi
1750   5D86 ED A0       > ldi
1750   5D88 ED A0       > ldi
1750   5D8A ED A0       > ldi
1750   5D8C ED A0       > ldi
1750   5D8E ED A0       > ldi
1750   5D90 ED A0       > ldi
1750   5D92 ED A0       > ldi
1750   5D94 ED A0       > ldi
1750   5D96 ED A0       > ldi
1750   5D98 ED A0       > ldi
1750   5D9A ED A0       > ldi
1750   5D9C ED A0       > ldi
1750   5D9E ED A0       > ldi
1750   5DA0 ED A0       > ldi
1750   5DA2 ED A0       > ldi
1750   5DA4 ED A0       > ldi
1750   5DA6 ED A0       > ldi
1750   5DA8 ED A0       > ldi
1750   5DAA ED A0       > ldi
1750   5DAC ED A0       > ldi
1750   5DAE ED A0       > ldi
1750   5DB0 ED A0       > ldi
1750   5DB2 ED A0       > ldi
1750   5DB4 ED A0       > ldi
1750   5DB6 ED A0       > ldi
1750   5DB8 ED A0       > ldi
1750   5DBA ED A0       > ldi
1750   5DBC ED A0       > ldi
1750   5DBE ED A0       > ldi
1750   5DC0 ED A0       > ldi
1750   5DC2 ED A0       > ldi
1750   5DC4 ED A0       > ldi
1750   5DC6 ED A0       > ldi
1750   5DC8 ED A0       > ldi
1750   5DCA ED A0       > ldi
1750   5DCC ED A0       > ldi
1750   5DCE ED A0       > ldi
1750   5DD0 ED A0       > ldi
1750   5DD2 ED A0       > ldi
1750   5DD4 ED A0       > ldi
1750   5DD6 ED A0       > ldi
1750   5DD8 ED A0       > ldi
1750   5DDA ED A0       > ldi
1750   5DDC ED A0       > ldi
1750   5DDE ED A0       > ldi
1750   5DE0 ED A0       > ldi
1750   5DE2 ED A0       > ldi
1750   5DE4 ED A0       > ldi
1750   5DE6 ED A0       > ldi
1750   5DE8 ED A0       > ldi
1750   5DEA ED A0       > ldi
1750   5DEC ED A0       > ldi
1750   5DEE ED A0       > ldi
1750   5DF0 ED A0       > ldi
1750   5DF2 ED A0       > ldi
1750   5DF4 ED A0       > ldi
1750   5DF6 ED A0       > ldi
1750   5DF8 ED A0       > ldi
1750   5DFA ED A0       > ldi
1750   5DFC ED A0       > ldi
1750   5DFE ED A0       > ldi
1750   5E00 ED A0       > ldi
1750   5E02 ED A0       > ldi
1750   5E04 ED A0       > ldi
1750   5E06 ED A0       > ldi
1750   5E08 ED A0       > ldi
1750   5E0A ED A0       > ldi
1750   5E0C ED A0       > ldi
1750   5E0E ED A0       > ldi
1750   5E10 ED A0       > ldi
1750   5E12 ED A0       > ldi
1750   5E14 ED A0       > ldi
1750   5E16 ED A0       > ldi
1750   5E18 ED A0       > ldi
1750   5E1A ED A0       > ldi
1750   5E1C ED A0       > ldi
1750   5E1E ED A0       > ldi
1750   5E20 ED A0       > ldi
1750   5E22 ED A0       > ldi
1750   5E24 ED A0       > ldi
1750   5E26 ED A0       > ldi
1750   5E28 ED A0       > ldi
1750   5E2A ED A0       > ldi
1750   5E2C ED A0       > ldi
1750   5E2E ED A0       > ldi
1750   5E30 ED A0       > ldi
1750   5E32 ED A0       > ldi
1750   5E34 ED A0       > ldi
1750   5E36 ED A0       > ldi
1750   5E38 ED A0       > ldi
1750   5E3A ED A0       > ldi
1750   5E3C ED A0       > ldi
1750   5E3E ED A0       > ldi
1750   5E40 ED A0       > ldi
1750   5E42 ED A0       > ldi
1750   5E44 ED A0       > ldi
1750   5E46 ED A0       > ldi
1750   5E48 ED A0       > ldi
1750   5E4A ED A0       > ldi
1750   5E4C ED A0       > ldi
1750   5E4E ED A0       > ldi
1750   5E50 ED A0       > ldi
1750   5E52 ED A0       > ldi
1750   5E54 ED A0       > ldi
1750   5E56 ED A0       > ldi
1750   5E58 ED A0       > ldi
1750   5E5A ED A0       > ldi
1750   5E5C ED A0       > ldi
1750   5E5E ED A0       > ldi
1750   5E60 ED A0       > ldi
1750   5E62 ED A0       > ldi
1750   5E64 ED A0       > ldi
1750   5E66 ED A0       > ldi
1750   5E68 ED A0       > ldi
1750   5E6A ED A0       > ldi
1751   5E6C             .part2s: 
1752   5E6C 3A 00 40    	ld	a, (PORTSPI)	; discard 16bit CRC
1753   5E6F 3A 00 40    	ld	a, (PORTSPI)
1754   5E72             .fim: 
1755   5E72 AF          	xor	a		; zera carry para informar leitura sem erros
1756   5E73 C3 CE 55    	jp	terminaLeituraEscritaBloco
1757   5E76             
1758   5E76             
1759   5E76             ; ------------------------------------------------
1760   5E76             ; Converte blocos para bytes. Na pratica faz
1761   5E76             ; BC DE = (BC DE) * 512
1762   5E76             ; ------------------------------------------------
1763   5E76             blocoParaByte: 
1764   5E76 41          	ld	b, c
1765   5E77 4A          	ld	c, d
1766   5E78 53          	ld	d, e
1767   5E79 1E 00       	ld	e, 0
1768   5E7B CB 22       	sla	d
1769   5E7D CB 11       	rl	c
1770   5E7F CB 10       	rl	b
1771   5E81 C9          	ret
1772   5E82             
1773   5E82             ; ------------------------------------------------
1774   5E82             R800LDIR: 
1775   5E82 D9          	exx
1776   5E83 E9          	jp	(hl)
1777   5E84             
1778   5E84             ; ------------------------------------------------
1779   5E84             
1780   5E84             
1781   5E84             ; ========================================================================== 
1782   5E84             ; Funcoes utilitarias
1783   5E84             ; ========================================================================== 
1784   5E84             
1785   5E84             ; ------------------------------------------------
1786   5E84             ; Chaveia para modo SPI
1787   5E84             ; ------------------------------------------------
1788   5E84             modoSPI: 
1789   5E84 F5          	push	af
1790   5E85 3E 01       	ld	a, 1
1791   5E87 32 01 60    	ld	(CHAVEIASPI), a
1792   5E8A F1          	pop	af
1793   5E8B C9          	ret
1794   5E8C             
1795   5E8C             ; ------------------------------------------------
1796   5E8C             ; Chaveia para modo ROM
1797   5E8C             ; ------------------------------------------------
1798   5E8C             modoROM: 
1799   5E8C F5          	push	af
1800   5E8D 3E 00       	ld	a, 0
1801   5E8F 32 01 60    	ld	(CHAVEIASPI), a
1802   5E92 F1          	pop	af
1803   5E93 C9          	ret
1804   5E94             
1805   5E94             ; ------------------------------------------------
1806   5E94             ; Imprime string na tela apontada por DE
1807   5E94             ; Destroi todos os registradores
1808   5E94             ; ------------------------------------------------
1809   5E94             printString: 
1810   5E94 1A          	ld	a, (de)
1811   5E95 B7          	or	a
1812   5E96 C8          	ret	z
1813   5E97 CD A2 00    	call	CHPUT
1814   5E9A 13          	inc	de
1815   5E9B 18 F7       	jr	printString
1816   5E9D             
1817   5E9D             
1818   5E9D             ; ------------------------------------------------
1819   5E9D             ; Converte o byte em A para string em decimal no
1820   5E9D             ; buffer apontado por DE
1821   5E9D             ; Destroi AF, BC, HL, DE, IXL
1822   5E9D             ; ------------------------------------------------
1823   5E9D             DecToAscii: 
1824   5E9D 26 00       	ld	h, 0
1825   5E9F 6F          	ld	l, a		; copiar A para HL
1826   5EA0 FD 36 39 01 	ld	(iy+WRKAREA.TEMP),1	; flag para indicar que devemos cortar os zeros a esquerda
1827   5EA4 01 9C FF    	ld	bc, -100	; centenas
1828   5EA7 CD B5 5E    	call	.num1
1829   5EAA 0E F6       	ld	c, -10		; dezenas
1830   5EAC CD B5 5E    	call	.num1
1831   5EAF FD 36 39 02 	ld	(iy+WRKAREA.TEMP),2	; unidade deve exibir 0 se for zero e nao corta-lo
1832   5EB3 0E FF       	ld	c, -1		; unidades
1833   5EB5             .num1: 
1834   5EB5 3E 2F       	ld	a, '0'-1
1835   5EB7             .num2: 
1836   5EB7 3C          	inc	a		; contar o valor em ascii de '0' a '9'
1837   5EB8 09          	add	hl, bc		; somar com negativo
1838   5EB9 38 FC       	jr	c,.num2		; ainda nao zeramos
1839   5EBB ED 42       	sbc	hl, bc		; retoma valor original
1840   5EBD FD 35 39    	dec	(iy+WRKAREA.TEMP)	; se flag do corte do zero indicar para nao cortar, pula
1841   5EC0 20 08       	jr	nz,.naozero
1842   5EC2 FE 30       	cp	'0'		; devemos cortar os zeros a esquerda. Eh zero?
1843   5EC4 20 04       	jr	nz,.naozero
1844   5EC6 FD 34 39    	inc	(iy+WRKAREA.TEMP)	; se for zero, nao salvamos e voltamos a flag
1845   5EC9 C9          	ret
1846   5ECA             .naozero: 
1847   5ECA 12          	ld	(de), a		; eh zero ou eh outro numero, salvar
1848   5ECB 13          	inc	de		; incrementa ponteiro de destino
1849   5ECC C9          	ret
1850   5ECD             
1851   5ECD             ; ------------------------------------------------
1852   5ECD             ; Converte o byte em A para string em hexa no
1853   5ECD             ; buffer apontado por DE
1854   5ECD             ; Destroi AF, C, DE
1855   5ECD             ; ------------------------------------------------
1856   5ECD             HexToAscii: 
1857   5ECD 4F          	ld	c, a
1858   5ECE 1F          	rra
1859   5ECF 1F          	rra
1860   5ED0 1F          	rra
1861   5ED1 1F          	rra
1862   5ED2 CD D6 5E    	call	.conv
1863   5ED5 79          	ld  	a, c
1864   5ED6             .conv: 
1865   5ED6 E6 0F       	and	$0F
1866   5ED8 C6 90       	add	a, $90
1867   5EDA 27          	daa
1868   5EDB CE 40       	adc	a, $40
1869   5EDD 27          	daa
1870   5EDE 12          	ld	(de), a
1871   5EDF 13          	inc	de
1872   5EE0 C9          	ret
1873   5EE1             
1874   5EE1             ; ------------------------------------------------
1875   5EE1             ; Converte o byte em A para string em decimal e
1876   5EE1             ; imprime na tela
1877   5EE1             ; Destroi AF, BC, HL, DE
1878   5EE1             ; ------------------------------------------------
1879   5EE1             printDecToAscii: 
1880   5EE1 26 00       	ld	h, 0
1881   5EE3 6F          	ld	l, a		; copiar A para HL
1882   5EE4 06 01       	ld	b, 1		; flag para indicar que devemos cortar os zeros a esquerda
1883   5EE6 11 9C FF    	ld	de, -100	; centenas
1884   5EE9 CD F5 5E    	call	.num1
1885   5EEC 1E F6       	ld	e, -10		; dezenas
1886   5EEE CD F5 5E    	call	.num1
1887   5EF1 06 02       	ld	b, 2		; unidade deve exibir 0 se for zero e nao corta-lo
1888   5EF3 1E FF       	ld	e, -1		; unidades
1889   5EF5             .num1: 
1890   5EF5 3E 2F       	ld	a, '0'-1
1891   5EF7             .num2: 
1892   5EF7 3C          	inc	a		; contar o valor em ascii de '0' a '9'
1893   5EF8 19          	add	hl, de		; somar com negativo
1894   5EF9 38 FC       	jr	c,.num2		; ainda nao zeramos
1895   5EFB ED 52       	sbc	hl, de		; retoma valor original
1896   5EFD 10 06       	djnz	.naozero	; se flag do corte do zero indicar para nao cortar, pula
1897   5EFF FE 30       	cp	'0'		; devemos cortar os zeros a esquerda. Eh zero?
1898   5F01 20 02       	jr	nz,.naozero
1899   5F03 04          	inc	b		; se for zero, nao imprimimos e voltamos a flag
1900   5F04 C9          	ret
1901   5F05             .naozero: 
1902   5F05 E5          	push	hl		; nao eh zero ou eh outro numero, imprimir
1903   5F06 C5          	push	bc
1904   5F07 CD A2 00    	call	CHPUT
1905   5F0A C1          	pop	bc
1906   5F0B E1          	pop	hl
1907   5F0C C9          	ret
1908   5F0D             
1909   5F0D             ; ------------------------------------------------
1910   5F0D             ; Procura pelo nome do fabricante em uma tabela.
1911   5F0D             ; A contem o byte do fabricante
1912   5F0D             ; Devolve HL apontando para o buffer do fabricante
1913   5F0D             ; e BC com o comprimento do texto
1914   5F0D             ; Destroi AF, BC, HL
1915   5F0D             ; ------------------------------------------------
1916   5F0D             pegaFabricante: 
1917   5F0D 4F          	ld	c, a
1918   5F0E 21 2F 5F    	ld	hl, tblFabricantes
1919   5F11             
1920   5F11             .loop: 
1921   5F11 7E          	ld	a, (hl)
1922   5F12 23          	inc	hl
1923   5F13 B9          	cp	c
1924   5F14 28 0C       	jr	z,.achado
1925   5F16 B7          	or	a
1926   5F17 28 09       	jr	z,.achado
1927   5F19 C5          	push	bc
1928   5F1A CD 22 5F    	call	.achado
1929   5F1D 09          	add	hl, bc
1930   5F1E 23          	inc	hl
1931   5F1F C1          	pop	bc
1932   5F20 18 EF       	jr	.loop
1933   5F22             
1934   5F22             .achado: 
1935   5F22 0E 00       	ld	c, 0
1936   5F24 E5          	push	hl
1937   5F25 AF          	xor	a
1938   5F26             .loop2: 
1939   5F26 0C          	inc	c
1940   5F27 23          	inc	hl
1941   5F28 BE          	cp	(hl)
1942   5F29 20 FB       	jr	nz,.loop2
1943   5F2B E1          	pop	hl
1944   5F2C 06 00       	ld	b, 0
1945   5F2E C9          	ret
1946   5F2F             
1947   5F2F             tblFabricantes: 
1948   5F2F 01          	db	1
1949   5F30             	db	"Panasonic",0
1949   5F30 50616E61736F6E696300
1950   5F3A 02          	db	2
1951   5F3B             	db	"Toshiba",0
1951   5F3B 546F736869626100
1952   5F43 03          	db	3
1953   5F44             	db	"SanDisk",0
1953   5F44 53616E4469736B00
1954   5F4C 04          	db	4
1955   5F4D             	db	"SMI-S",0
1955   5F4D 534D492D5300
1956   5F53 06          	db	6
1957   5F54             	db	"Renesas",0
1957   5F54 52656E6573617300
1958   5F5C 11          	db	17
1959   5F5D             	db	"Dane-Elec",0
1959   5F5D 44616E652D456C656300
1960   5F67 13          	db	19
1961   5F68             	db	"KingMax",0
1961   5F68 4B696E674D617800
1962   5F70 15          	db	21
1963   5F71             	db	"Samsung",0
1963   5F71 53616D73756E6700
1964   5F79 18          	db	24
1965   5F7A             	db	"Infineon",0
1965   5F7A 496E66696E656F6E00
1966   5F83 1A          	db	26
1967   5F84 50 51 49 00 	db	"PQI",0
1968   5F88 1B          	db	27
1969   5F89 536F6E7900  	db	"Sony",0
1970   5F8E 1C          	db	28
1971   5F8F             	db	"Transcend",0
1971   5F8F 5472616E7363656E6400
1972   5F99 1D          	db	29
1973   5F9A             	db	"A-DATA",0
1973   5F9A 412D4441544100
1974   5FA1 1F          	db	31
1975   5FA2             	db	"SiliconPower",0
1975   5FA2 53696C69636F6E506F77657200
1976   5FAF 27          	db	39
1977   5FB0             	db	"Verbatim",0
1977   5FB0 566572626174696D00
1978   5FB9 41          	db	65
1979   5FBA 4F 4B 49 00 	db	"OKI",0
1980   5FBE 73          	db	115
1981   5FBF             	db	"SilverHT",0
1981   5FBF 53696C766572485400
1982   5FC8 89          	db	137
1983   5FC9             	db	"L.Data",0
1983   5FC9 4C2E4461746100
1984   5FD0 00          	db	0
1985   5FD1             	db	"Generico",0
1985   5FD1 47656E657269636F00
1986   5FDA             
1987   5FDA             
1988   5FDA             ; ------------------------------------------------
1989   5FDA             ; Restore screen parameters on MSX>=2 if they're
1990   5FDA             ; not set yet
1991   5FDA             ; ------------------------------------------------
1992   5FDA             MYSETSCR: 
1993   5FDA 3A 2D 00    	ld	a,(MSXVER)
1994   5FDD B7          	or	a			; MSX1?
1995   5FDE CA 6C 00    	jp	z,INITXT		; Yes, change do screen-0
1996   5FE1             
1997   5FE1 0E 23       	ld	c,$23			; Block-2, R#3
1998   5FE3 DD 21 F5 01 	ld 	ix,REDCLK
1999   5FE7 CD 5F 01    	call	EXTROM
2000   5FEA E6 01       	and	1
2001   5FEC 47          	ld	b,a
2002   5FED 3A AF FC    	ld	a,(SCRMOD)
2003   5FF0 B8          	cp	b
2004   5FF1 20 1C       	jr	nz,.restore
2005   5FF3 0C          	inc	c
2006   5FF4 DD 21 F5 01 	ld 	ix,REDCLK
2007   5FF8 CD 5F 01    	call	EXTROM
2008   5FFB 47          	ld	b,a
2009   5FFC 0C          	inc	c
2010   5FFD DD 21 F5 01 	ld 	ix,REDCLK
2011   6001 CD 5F 01    	call	EXTROM
2012   6004 87          	add	a,a
2013   6005 87          	add	a,a
2014   6006 87          	add	a,a
2015   6007 87          	add	a,a
2016   6008 B0          	or	b
2017   6009 47          	ld	b,a
2018   600A 3A B0 F3    	ld	a,(LINLEN)
2019   600D B8          	cp	b
2020   600E C8          	ret	z
2021   600F             .restore: 
2022   600F AF          	xor	a		; Don't displat the function keys
2023   6010 DD 21 85 01 	ld	ix,SDFSCR
2024   6014 C3 5F 01    	jp	EXTROM
2025   6017             
2026   6017             ; ------------------------------------------------
2027   6017             ; Check if the STOP key was signaled on DRV_INIT
2028   6017             ; ------------------------------------------------
2029   6017             INICHKSTOP: 
2030   6017 3A 9B FC    	ld	a,(INTFLG)
2031   601A FE 04       	cp	4			; Was STOP pressed?
2032   601C C0          	ret	nz			; No, quit as fast as possible 
2033   601D             
2034   601D             	; Handle STOP to pause and read messages, and ask for the copyright info
2035   601D 11 A4 60    	ld	de,strBootpaused
2036   6020 CD 94 5E    	call	printString
2037   6023 3E 07       .wait1: 	ld	a,7
2038   6025 CD 41 01    	call	SNSMAT
2039   6028 E6 10       	and	$10			; Is STOP still pressed?
2040   602A 28 F7       	jr	z,.wait1		; Wait for STOP to be released
2041   602C AF          	xor	a
2042   602D 32 9B FC    	ld	(INTFLG),a		; Clear STOP flag
2043   6030 06 00       	ld	b,0			; b=inhibit 'i' key flag
2044   6032 CD 9C 00    .wait2:  call	CHSNS
2045   6035 C4 52 60    	call	nz,.chkikey		; Wait until a key is pressed
2046   6038 3A 9B FC    	ld	a,(INTFLG)
2047   603B FE 04       	cp	4			; Was STOP pressed?
2048   603D 20 F3       	jr	nz,.wait2		; No, return
2049   603F AF          	xor	a
2050   6040 32 9B FC    	ld	(INTFLG),a		; Clear STOP flag
2051   6043 CD 56 01    	call	KILBUF
2052   6046 06 1E       	ld	b,30			; Since the user is trying pause the
2053   6048 76          .wait3: 	halt				; boot messages, this gives him enough
2054   6049             					; time to react and pause the next
2055   6049             					; driver
2056   6049 3A 9B FC    	ld	a,(INTFLG)
2057   604C FE 04       	cp	4			; Was STOP pressed?
2058   604E C8          	ret	z			; quit so the next driver can process it
2059   604F 10 F7       	djnz	.wait3			; The user will have the impression
2060   6051             					; that he has a perfect timing.   ;)
2061   6051 C9          	ret
2062   6052             
2063   6052             .chkikey: 
2064   6052 CB 40       	bit	0,b			; Was the copyright message shown?
2065   6054 C0          	ret	nz			; Yes, return
2066   6055 CD 9F 00    	call	CHGET
2067   6058 FE 69       	cp	'i'
2068   605A 28 03       	jr	z,.showcopyright
2069   605C FE 49       	cp	'I'
2070   605E C0          	ret	nz
2071   605F             .showcopyright: 
2072   605F 04          	inc	b			; Inhibit further presses of the i key 
2073   6060 11 D4 60    	ld	de,strCopyright
2074   6063 C3 94 5E    	jp	printString
2075   6066             
2076   6066             
2077   6066             
2078   6066             ; ------------------------------------------------
2079   6066             ; Install the R800 data transfer helper routine on WorkArea 
2080   6066             ; ------------------------------------------------
2081   6066             INSTR800HLP: 
2082   6066 3A 2D 00    	ld	a,(MSXVER)
2083   6069 FE 03       	cp	3		; MSX Turbo-R?
2084   606B D8          	ret	c		; No, return
2085   606C CD 79 60    	call	GTR800LDIR
2086   606F EB          	ex	de,hl
2087   6070 21 81 60    	ld	hl,R800DATHLP
2088   6073 01 07 00    	ld	bc,R800DATHLP.end-R800DATHLP
2089   6076 ED B0       	ldir
2090   6078 C9          	ret
2091   6079             
2092   6079             ; ------------------------------------------------
2093   6079             ; Obtain the pointer to the R800 data transfer helper routine
2094   6079             ; Input   : IY=Pointer to the WorkArea
2095   6079             ; Output  : HL=pointer to R800 data transfer helper routine 
2096   6079             ; Modifies: DE
2097   6079             ; ------------------------------------------------
2098   6079             GTR800LDIR: 
2099   6079 FD E5       	push	iy
2100   607B E1          	pop	hl			; hl=WorkArea
2101   607C 11 3A 00    	ld	de,WRKAREA.TRLDIR
2102   607F 19          	add	hl,de
2103   6080 C9          	ret
2104   6081             
2105   6081             ; ------------------------------------------------
2106   6081             ; R800 data transfer routine, copied to the WorkArea
2107   6081             ; ------------------------------------------------
2108   6081             R800DATHLP: 
2109   6081 D9          	exx
2110   6082 01 00 02    	ld	bc,512
2111   6085 ED B0       	ldir
2112   6087 C9          	ret
2113   6088             .end
2114   6088              
2115   6088             
2116   6088             
2117   6088             ; ==========================================================================
2118   6088             strTitle: 
2119   6088             	db	"FBLabs SDHC driver "
2119   6088 46424C61627320534448432064726976657220
2120   609B             	db	"v",VER_MAIN+$30,'.',VER_SEC+$30,'.',VER_REV+$30
2120   609B 76312E302E36
2121   60A1 0D 0A 00    	db	13,10,0
2122   60A4             
2123   60A4             strBootpaused: 
2124   60A4             	db	"Paused. Press <i> to show the copyright info.",13,10,0
2124   60A4 5061757365642E205072657373203C693E20746F2073686F772074686520636F
2124   60C4 7079726967687420696E666F2E0D0A00
2125   60D4             
2126   60D4             strCopyright: 
2127   60D4             	db	"(c) 2014 Fabio Belavenuto",13,10
2127   60D4 286329203230313420466162696F2042656C6176656E75746F0D0A
2128   60EF             	db	"(c) 2016 FRS",13,10
2128   60EF 2863292032303136204652530D0A
2129   60FD             	db	"Licensed under CERN OHL v1.1",13,10
2129   60FD 4C6963656E73656420756E646572204345524E204F484C2076312E310D0A
2130   611B             	db	"http://ohwr.org/cernohl",13,10
2130   611B 687474703A2F2F6F6877722E6F72672F6365726E6F686C0D0A
2131   6134             	db	"PCB designed by Luciano Sturaro",13,10
2131   6134 5043422064657369676E6564206279204C756369616E6F205374757261726F0D
2131   6154 0A
2132   6155             	; fall throw
2133   6155             strCrLf: 
2134   6155 0D 0A 00    	db	13,10,0
2135   6158             strCartao: 
2136   6158             	db	"Slot ",0
2136   6158 536C6F742000
2137   615E             strVazio: 
2138   615E             	db	"Empty",13,10,0
2138   615E 456D7074790D0A00
2139   6166             strNaoIdentificado: 
2140   6166             	db	"Unknown!",13,10,0
2140   6166 556E6B6E6F776E210D0A00
2141   6171             			;----------------------------------------
2142   6171             strMr_mp_desativada: 
2143   6171             	db	"Slot expander/Mapper/MegaRAM disabled",13,10,0
2143   6171 536C6F7420657870616E6465722F4D61707065722F4D65676152414D20646973
2143   6191 61626C65640D0A00
2144   6199             strMapper: 
2145   6199             	db	"Slot expanded and Memory Mapper enabled",13,10,0
2145   6199 536C6F7420657870616E64656420616E64204D656D6F7279204D617070657220
2145   61B9 656E61626C65640D0A00
2146   61C3             strMegaram: 
2147   61C3             	db	"Slot expander and MegaRAM enabled",13,10,0
2147   61C3 536C6F7420657870616E64657220616E64204D65676152414D20656E61626C65
2147   61E3 640D0A00
2148   61E7             strSDV1: 
2149   61E7             	db	"SDV1 - ",0
2149   61E7 53445631202D2000
2150   61EF             strSDV2: 
2151   61EF             	db	"SDV2 - ",0
2151   61EF 53445632202D2000
2152   61F7             
2153   61F7             ;-----------------------------------------------------------------------------
2154   61F7             ;
2155   61F7             ; End of the driver code
2156   61F7             
2157   61F7             DRV_END: 
2158   61F7             
2159   61F7 FF          	ds	3ED0h-(DRV_END-DRV_START), $FF
2160   7FD0             
2161   7FD0             
