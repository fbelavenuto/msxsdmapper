0001   0000             ; Projeto MSX SD Mapper
0002   0000             
0003   0000             ; Copyright (c) 2014 Fabio Belavenuto
0004   0000             ; Enhanced by FRS
0005   0000             
0006   0000             ; This documentation describes Open Hardware and is licensed under the CERN OHL v. 1.1.
0007   0000             ; You may redistribute and modify this documentation under the terms of the
0008   0000             ; CERN OHL v.1.1. (http://ohwr.org/cernohl). This documentation is distributed
0009   0000             ; WITHOUT ANY EXPRESS OR IMPLIED WARRANTY, INCLUDING OF MERCHANTABILITY,
0010   0000             ; SATISFACTORY QUALITY AND FITNESS FOR A PARTICULAR PURPOSE.
0011   0000             ; Please see the CERN OHL v.1.1 for applicable conditions
0012   0000             
0013   0000             ; Technical info:
0014   0000             ; 4000h~47FFh	: SPI data transfer window (read/write)
0015   0000             ; 4800h		: Interface status and card select register (read/write)
0016   0000             ;	<read>
0017   0000             ;	b0	: 0=SD card present on slot-0
0018   0000             ;	b1	: 0=SD card present on slot-1
0019   0000             ;	b2	: 0=Write protecton enabled for SD card slot-0
0020   0000             ;	b3	: 0=Write protecton enabled for SD card slot-1
0021   0000             ;	b4	: SW0 status. 0=RAM enabled, 1=RAM disabled
0022   0000             ;	b5	: SW1 status. 0=RAM mode: MegaRAM, 1=RAM mode: Memory Mapper
0023   0000             ;	b6	: Reserved for future use. Must be masked out from readings.
0024   0000             ;	b7	: 1=SPI transfer busy. 0=No ongoing SPI transfer
0025   0000             ;	<write>
0026   0000             ;	b0	: SD card slot-0 chip-select (0=selected)
0027   0000             ;	b1	: SD card slot-1 chip-select (0=selected)
0028   0000             
0029   0000             ; 6001h		: Mode configuration register (write only)
0030   0000             ;	b0	: 0=ROM mode, SPI interface disabled, 1=SPI interface enabled
0031   0000             
0032   0000             
0033   0000             
0034   0000             	output	"driver.bin"
0035   0000             
0036   0000             ;-----------------------------------------------------------------------------
0037   0000             ;
0038   0000             ; Driver configuration constants
0039   0000             ;
0040   0000             
0041   0000             ;Driver type:
0042   0000             ;   0 for drive-based
0043   0000             ;   1 for device-based
0044   0000             
0045   0000             DRV_TYPE	equ	1
0046   0000             
0047   0000             ;Hot-plug devices support (device-based drivers only):
0048   0000             ;   0 for no hot-plug support
0049   0000             ;   1 for hot-plug support
0050   0000             
0051   0000             DRV_HOTPLUG	equ	0
0052   0000             
0053   0000             DEBUG	equ	0	;Set to 1 for debugging, 0 to normal operation
0054   0000             
0055   0000             ;Driver version
0056   0000             
0057   0000             VER_MAIN	equ	1
0058   0000             VER_SEC		equ	0
0059   0000             VER_REV		equ	5
0060   0000             
0061   0000             ;-----------------------------------------------------------------------------
0062   0000             ; Enderecos SPI
0063   0000             
0064   0000             CHAVEIASPI	= $6001
0065   0000             PORTCFG		= $4800
0066   0000             PORTSPI		= $4000
0067   0000             
0068   0000             ; Comandos SPI:
0069   0000             CMD0	= 0  | $40
0070   0000             CMD1	= 1  | $40
0071   0000             CMD8	= 8  | $40
0072   0000             CMD9	= 9  | $40
0073   0000             CMD10	= 10 | $40
0074   0000             CMD12	= 12 | $40
0075   0000             CMD16	= 16 | $40
0076   0000             CMD17	= 17 | $40
0077   0000             CMD18	= 18 | $40
0078   0000             CMD24	= 24 | $40
0079   0000             CMD25	= 25 | $40
0080   0000             CMD55	= 55 | $40
0081   0000             CMD58	= 58 | $40
0082   0000             ACMD23	= 23 | $40
0083   0000             ACMD41	= 41 | $40
0084   0000             
0085   0000             ; Offsets da area de trabalho
0086   0000             
0087   0000             BCSD 		= 0
0088   0000             BCID1		= 16
0089   0000             BCID2		= 32
0090   0000             NUMSD		= 48	; 1 se cartao 1, 2 se cartao 2
0091   0000             FLAGSCARTAO	= 49	; Flag indicando se houve mudanca ou erro de cartao
0092   0000             NUMBLOCOS	= 50	; 1 byte
0093   0000             TEMP		= 52	; 1 byte
0094   0000             BLOCOS1		= 56	; 3 bytes
0095   0000             BLOCOS2		= 60	; 3 bytes
0096   0000             
0097   0000             
0098   0000             
0099   0000             ;-----------------------------------------------------------------------------
0100   0000             ;
0101   0000             ; Standard BIOS and work area entries
0102   0000             INITXT	= $006C		; Inicializa SCREEN0
0103   0000             CHSNS	= $009C		; Sense keyboard buffer for character
0104   0000             CHGET	= $009F		; Get character from keyboard buffer
0105   0000             CHPUT	= $00A2		; A=char
0106   0000             CLS	= $00C3		; Chamar com A=0
0107   0000             ERAFNK	= $00CC		; Erase function key display
0108   0000             SNSMAT	= $0141		; Read row of keyboard matrix
0109   0000             KILBUF	= $0156		; Clear keyboard buffer
0110   0000             EXTROM	= $015F
0111   0000             
0112   0000             ; subROM functions
0113   0000             SDFSCR	= $0185
0114   0000             REDCLK	= $01F5
0115   0000             
0116   0000             
0117   0000             ; System variables
0118   0000             MSXVER	= $002D
0119   0000             LINL40	= $F3AE		; Width
0120   0000             LINLEN	= $F3B0
0121   0000             INTFLG	= $FC9B
0122   0000             SCRMOD	= $FCAF
0123   0000             
0124   0000             
0125   0000             ;-----------------------------------------------------------------------------
0126   0000             
0127   0000             
0128   0000             	org		$4000
0129   4000             
0130   4000 FF          	ds		256, $FF		; 256 dummy bytes
0131   4100             
0132   4100             DRV_START: 
0133   4100             
0134   4100             ;-----------------------------------------------------------------------------
0135   4100             ;
0136   4100             ; Miscellaneous constants
0137   4100             ;
0138   4100             
0139   4100             ;This is a 2 byte buffer to store the address of code to be executed.
0140   4100             ;It is used by some of the kernel page 0 routines.
0141   4100             
0142   4100             CODE_ADD: 	equ	0F84Ch
0143   4100             
0144   4100             
0145   4100             ;-----------------------------------------------------------------------------
0146   4100             ;
0147   4100             ; Error codes for DEV_RW
0148   4100             ;
0149   4100             
0150   4100             ENCOMP	equ	0FFh
0151   4100             EWRERR	equ	0FEh
0152   4100             EDISK	equ	0FDh
0153   4100             ENRDY	equ	0FCh
0154   4100             EDATA	equ	0FAh
0155   4100             ERNF	equ	0F9h
0156   4100             EWPROT	equ	0F8h
0157   4100             EUFORM	equ	0F7h
0158   4100             ESEEK	equ	0F3h
0159   4100             EIFORM	equ	0F0h
0160   4100             EIDEVL	equ	0B5h
0161   4100             EIPARM	equ	08Bh
0162   4100             
0163   4100             ;-----------------------------------------------------------------------------
0164   4100             ;
0165   4100             ; Routines and information available on kernel page 0
0166   4100             ;
0167   4100             
0168   4100             ;* Get in A the current slot for page 1. Corrupts F.
0169   4100             ;  Must be called by using CALBNK to bank 0:
0170   4100             ;    xor a
0171   4100             ;    ld ix,GSLOT1
0172   4100             ;    call CALBNK
0173   4100             
0174   4100             GSLOT1	equ	402Dh
0175   4100             
0176   4100             
0177   4100             ;* This routine reads a byte from another bank.
0178   4100             ;  Must be called by using CALBNK to the desired bank,
0179   4100             ;  passing the address to be read in HL:
0180   4100             ;    ld a,<bank number>
0181   4100             ;    ld hl,<byte address>
0182   4100             ;    ld ix,RDBANK
0183   4100             ;    call CALBNK
0184   4100             
0185   4100             RDBANK	equ	403Ch
0186   4100             
0187   4100             
0188   4100             ;* This routine temporarily switches kernel main bank
0189   4100             ;  (usually bank 0, but will be 3 when running in MSX-DOS 1 mode),
0190   4100             ;  then invokes the routine whose address is at (CODE_ADD).
0191   4100             ;  It is necessary to use this routine to invoke CALBAS
0192   4100             ;  (so that kernel bank is correct in case of BASIC error)
0193   4100             ;  and to invoke DOS functions via F37Dh hook.
0194   4100             ;
0195   4100             ;  Input:  Address of code to invoke in (CODE_ADD).
0196   4100             ;          AF, BC, DE, HL, IX, IY passed to the called routine.
0197   4100             ;  Output: AF, BC, DE, HL, IX, IY returned from the called routine.
0198   4100             
0199   4100             CALLB0	equ	403Fh
0200   4100             
0201   4100             
0202   4100             ;* Call a routine in another bank.
0203   4100             ;  Must be used if the driver spawns across more than one bank.
0204   4100             ;
0205   4100             ;  Input:  A = bank number
0206   4100             ;          IX = routine address
0207   4100             ;          AF' = AF for the routine
0208   4100             ;          HL' = Ix for the routine
0209   4100             ;          BC, DE, HL, IY = input for the routine
0210   4100             ;  Output: AF, BC, DE, HL, IX, IY returned from the called routine.
0211   4100             
0212   4100             CALBNK	equ	4042h
0213   4100             
0214   4100             
0215   4100             ;* Get in IX the address of the SLTWRK entry for the slot passed in A,
0216   4100             ;  which will in turn contain a pointer to the allocated page 3
0217   4100             ;  work area for that slot (0 if no work area was allocated).
0218   4100             ;  If A=0, then it uses the slot currently switched in page 1.
0219   4100             ;  Returns A=current slot for page 1, if A=0 was passed.
0220   4100             ;  Corrupts F.
0221   4100             ;  Must be called by using CALBNK to bank 0:
0222   4100             ;    ld a,<slot number> (xor a for current page 1 slot)
0223   4100             ;    ex af,af'
0224   4100             ;    xor a
0225   4100             ;    ld ix,GWORK
0226   4100             ;    call CALBNK
0227   4100             
0228   4100             GWORK	equ	4045h
0229   4100             
0230   4100             
0231   4100             ;* This address contains one byte that tells how many banks
0232   4100             ;  form the Nextor kernel (or alternatively, the first bank
0233   4100             ;  number of the driver).
0234   4100             
0235   4100             K_SIZE	equ	40FEh
0236   4100             
0237   4100             
0238   4100             ;* This address contains one byte with the current bank number.
0239   4100             
0240   4100             CUR_BANK	equ	40FFh
0241   4100             
0242   4100             
0243   4100             ;-----------------------------------------------------------------------------
0244   4100             ;
0245   4100             ; Built-in format choice strings
0246   4100             ;
0247   4100             
0248   4100             NULL_MSG  equ     781Fh	;Null string (disk can't be formatted)
0249   4100             SING_DBL  equ     7820h ;"1-Single side / 2-Double side"
0250   4100             
0251   4100             
0252   4100             ;-----------------------------------------------------------------------------
0253   4100             ;
0254   4100             ; Driver signature
0255   4100             ;
0256   4100             	db	"NEXTOR_DRIVER",0
0256   4100 4E4558544F525F44524956455200
0257   410E             
0258   410E             
0259   410E             ;-----------------------------------------------------------------------------
0260   410E             ;
0261   410E             ; Driver flags:
0262   410E             ;    bit 0: 0 for drive-based, 1 for device-based
0263   410E             ;    bit 1: 1 for hot-plug devices supported (device-based drivers only)
0264   410E             
0265   410E 01          	db 1+(2*DRV_HOTPLUG)
0266   410F             
0267   410F             ;-----------------------------------------------------------------------------
0268   410F             ;
0269   410F             ; Reserved byte
0270   410F             ;
0271   410F 00          	db	0
0272   4110             
0273   4110             ;-----------------------------------------------------------------------------
0274   4110             ;
0275   4110             ; Driver name
0276   4110             ;
0277   4110             
0278   4110             DRV_NAME: 
0279   4110             	db	"SDMapper Driver"
0279   4110 53444D617070657220447269766572
0280   411F 20          	ds	32-($-DRV_NAME)," "
0281   4130             
0282   4130             
0283   4130             ;-----------------------------------------------------------------------------
0284   4130             ;
0285   4130             ; Jump table for the driver public routines
0286   4130             ;
0287   4130             
0288   4130             	; These routines are mandatory for all drivers
0289   4130                     ; (but probably you need to implement only DRV_INIT)
0290   4130             
0291   4130 C3 6C 41    	jp	DRV_TIMI
0292   4133 C3 4F 49    	jp	DRV_VERSION
0293   4136 C3 00 48    	jp	DRV_INIT
0294   4139 C3 56 49    	jp	DRV_BASSTAT
0295   413C C3 58 49    	jp	DRV_BASDEV
0296   413F C3 5A 49    	jp	DRV_EXTBIO
0297   4142 C3 5B 49    	jp	DRV_DIRECT0
0298   4145 C3 5B 49    	jp	DRV_DIRECT1
0299   4148 C3 5B 49    	jp	DRV_DIRECT2
0300   414B C3 5B 49    	jp	DRV_DIRECT3
0301   414E C3 5B 49    	jp	DRV_DIRECT4
0302   4151             
0303   4151 00          	ds	15
0304   4160             
0305   4160             	; These routines are mandatory for device-based drivers
0306   4160             
0307   4160 C3 5C 49    	jp	DEV_RW
0308   4163 C3 D9 49    	jp	DEV_INFO
0309   4166 C3 5F 4A    	jp	DEV_STATUS
0310   4169 C3 A5 4A    	jp	LUN_INFO
0311   416C             
0312   416C             
0313   416C             ;=====
0314   416C             ;=====  END of data that must be at fixed addresses
0315   416C             ;=====
0316   416C             
0317   416C             
0318   416C             ;-----------------------------------------------------------------------------
0319   416C             ;
0320   416C             ; Timer interrupt routine, it will be called on each timer interrupt
0321   416C             ; (at 50 or 60Hz), but only if DRV_INIT returns Cy=1 on its first execution.
0322   416C             
0323   416C             DRV_TIMI: 
0324   416C C9          	ret
0325   416D             
0326   416D             
0327   416D             ; Skips the interface r/w registers 
0328   416D FF          	ds	$4800-$, $FF
0329   4800             
0330   4800             
0331   4800             ;-----------------------------------------------------------------------------
0332   4800             ;
0333   4800             ; Driver initialization routine, it is called twice:
0334   4800             ;
0335   4800             ; 1) First execution, for information gathering.
0336   4800             ;    Input:
0337   4800             ;      A = 0
0338   4800             ;      B = number of available drives
0339   4800             ;      HL = maximum size of allocatable work area in page 3
0340   4800             ;    Output:
0341   4800             ;      A = number of required drives (for drive-based driver only)
0342   4800             ;      HL = size of required work area in page 3
0343   4800             ;      Cy = 1 if DRV_TIMI must be hooked to the timer interrupt, 0 otherwise
0344   4800             ;
0345   4800             ; 2) Second execution, for work area and hardware initialization.
0346   4800             ;    Input:
0347   4800             ;      A = 1
0348   4800             ;      B = number of allocated drives for this controller
0349   4800             ;
0350   4800             ;    The work area address can be obtained by using GWORK.
0351   4800             ;
0352   4800             ;    If first execution requests more work area than available,
0353   4800             ;    second execution will not be done and DRV_TIMI will not be hooked
0354   4800             ;    to the timer interrupt.
0355   4800             ;
0356   4800             ;    If first execution requests more drives than available,
0357   4800             ;    as many drives as possible will be allocated, and the initialization
0358   4800             ;    procedure will continue the normal way
0359   4800             ;    (for drive-based drivers only. Device-based drivers always
0360   4800             ;     get two allocated drives.)
0361   4800             
0362   4800             DRV_INIT: 
0363   4800 B7          	or	a		; Is this the 1st call? 
0364   4801 21 40 00    	ld	hl, 64		; 64 bytes of work area is needed 
0365   4804 C8          	ret	z		; Yes, return
0366   4805             
0367   4805             ; 2nd call: 
0368   4805 CD 14 49    	call	MYSETSCR
0369   4808 CD E4 4A    	call	pegaWorkArea		; HL=IY=Work area pointer
0370   480B 11 CA 5F    	ld	de,strTitle		; prints the title 
0371   480E CD 84 5E    	call	printString
0372   4811             
0373   4811 CD F6 48    	call	SDMAPPERINIT		; SD-Mapper exclusive init
0374   4814             
0375   4814             SDHCDEVINIT: 	; FBLabs SDHC Interface initialization
0376   4814 AF          	xor	a			; zera flags do cartao
0377   4815 FD 77 31    	ld	(iy+FLAGSCARTAO), a
0378   4818 3E 01       	ld	a, 1			; detectar cartao 1
0379   481A CD 80 48    	call	.detecta
0380   481D 3E 02       	ld	a, 2			; detectar cartao 2
0381   481F CD 80 48    	call	.detecta
0382   4822 01 00 00    	ld	bc, 0
0383   4825 1E 05       	ld	e, 5
0384   4827 CD 7C 5E    	call	modoROM
0385   482A             
0386   482A             .chkStop:  ; Check if the STOP key was signaled
0387   482A 3A 9B FC    	ld	a,(INTFLG)
0388   482D FE 04       	cp	4			; Was STOP pressed?
0389   482F 20 35       	jr	nz,.end			; No, quit as fast as possible 
0390   4831             
0391   4831             	; Handle STOP to pause and read messages, and ask for the copyright info
0392   4831 11 E6 5F    	ld	de,strBootpaused
0393   4834 CD 84 5E    	call	printString
0394   4837 3E 07       .wait1: 	ld	a,7
0395   4839 CD 41 01    	call	SNSMAT
0396   483C E6 10       	and	$10			; Is STOP still pressed?
0397   483E 28 F7       	jr	z,.wait1		; Wait for STOP to be released
0398   4840 AF          	xor	a
0399   4841 32 9B FC    	ld	(INTFLG),a		; Clear STOP flag
0400   4844 06 00       	ld	b,0			; b=inhibit 'i' key flag
0401   4846 CD 9C 00    .wait2:  call	CHSNS
0402   4849 C4 6C 48    	call	nz,.chkikey		; Wait until a key is pressed
0403   484C 3A 9B FC    	ld	a,(INTFLG)
0404   484F FE 04       	cp	4			; Was STOP pressed?
0405   4851 20 F3       	jr	nz,.wait2		; No, return
0406   4853 AF          	xor	a
0407   4854 32 9B FC    	ld	(INTFLG),a		; Clear STOP flag
0408   4857 CD 56 01    	call	KILBUF
0409   485A 06 1E       	ld	b,30			; Since the user is trying pause the
0410   485C 76          .wait3: 	halt				; boot messages, this gives him enough
0411   485D             					; time to react and pause the next
0412   485D             					; driver
0413   485D 3A 9B FC    	ld	a,(INTFLG)
0414   4860 FE 04       	cp	4			; Was STOP pressed?
0415   4862 28 02       	jr	z,.end			; quit so the next driver can process it
0416   4864 10 F6       	djnz	.wait3			; The user will have the impression
0417   4866             					; that he has a perfect timing.   ;)
0418   4866             
0419   4866             
0420   4866             .end
0421   4866 11 93 60     	ld	de, strCrLf
0422   4869 C3 84 5E    	jp	printString
0423   486C             
0424   486C             .chkikey: 
0425   486C CB 40       	bit	0,b			; Was the copyright message shown?
0426   486E C0          	ret	nz			; Yes, return
0427   486F CD 9F 00    	call	CHGET
0428   4872 FE 69       	cp	'i'
0429   4874 28 03       	jr	z,.showcopyright
0430   4876 FE 49       	cp	'I'
0431   4878 C0          	ret	nz
0432   4879             .showcopyright: 
0433   4879 04          	inc	b			; Inhibit further presses of the i key 
0434   487A 11 16 60    	ld	de,strCopyright
0435   487D C3 84 5E    	jp	printString
0436   4880             
0437   4880             .detecta: 
0438   4880 FD 77 30    	ld	(iy+NUMSD), a		; processo de deteccao dos cartoes
0439   4883 11 96 60    	ld	de, strCartao
0440   4886 CD 84 5E    	call	printString
0441   4889 FD 7E 30    	ld	a, (iy+NUMSD)
0442   488C C6 30       	add	'0'
0443   488E CD A2 00    	call	CHPUT
0444   4891 3E 3A       	ld	a, ':'
0445   4893 CD A2 00    	call	CHPUT
0446   4896 3E 20       	ld	a, ' '
0447   4898 CD A2 00    	call	CHPUT
0448   489B FD 4E 30    	ld	c, (iy+NUMSD)
0449   489E 3A 00 48    	ld	a, (PORTCFG)		; testar se cartao esta inserido
0450   48A1 A1          	and	c			; C contem 1 se cartao 1, 2 se cartao 2
0451   48A2 28 09       	jr	z,.naoVazio
0452   48A4 11 9C 60    	ld	de, strVazio		; nao tem cartao no slot
0453   48A7 CD 84 5E    	call	printString
0454   48AA C3 BB 48    	jp	.marcaErro
0455   48AD             .naoVazio: 
0456   48AD CD 6A 4B    	call	detectaCartao		; tem cartao no slot, inicializar e detectar
0457   48B0 30 0C       	jr	nc,.detectou
0458   48B2 CD AD 4C    	call	desabilitaSDs
0459   48B5 11 A4 60    	ld	de, strNaoIdentificado
0460   48B8 CD 84 5E    	call	printString
0461   48BB             .marcaErro: 
0462   48BB C3 25 4B    	jp	marcaErroCartao		; slot vazio ou erro de deteccao, marcar nas flags
0463   48BE             .detectou: 
0464   48BE CD 42 4B    	call	calculaCIDoffset	; calculamos em IX a posicao correta do offset CID dependendo do cartao atual
0465   48C1 DD 7E 0F    	ld	a,(ix+15)	; pegar byte SDV1 ou SDV2
0466   48C4 11 25 61    	ld	de, strSDV1	; e imprimir
0467   48C7 B7          	or	a
0468   48C8 28 03       	jr	z,.pula1
0469   48CA 11 2D 61    	ld	de, strSDV2
0470   48CD             .pula1: 
0471   48CD CD 84 5E    	call	printString
0472   48D0 3E 28       	ld	a,'('
0473   48D2 CD A2 00    	call	CHPUT
0474   48D5 DD 7E 00    	ld	a,(ix)		; pegar byte do fabricante
0475   48D8 CD D1 5E    	call	printDecToAscii	; Imprimir Manufacturer ID
0476   48DB 3E 29       	ld	a,')'
0477   48DD CD A2 00    	call	CHPUT
0478   48E0 3E 20       	ld	a,' '
0479   48E2 CD A2 00    	call	CHPUT
0480   48E5 DD 7E 00    	ld	a,(ix)		; pegar byte do fabricante
0481   48E8 CD FD 5E    	call	pegaFabricante	; achar nome do fabricante
0482   48EB EB          	ex	de,hl
0483   48EC CD 84 5E    	call	printString	; e imprimir
0484   48EF 11 93 60    	ld	de,strCrLf
0485   48F2 CD 84 5E    	call	printString
0486   48F5 C9          	ret
0487   48F6             
0488   48F6             
0489   48F6             SDMAPPERINIT: 		; This block is exclusive for the SD-Mapper
0490   48F6 11 AF 60    	ld	de, strMr_mp_desativada
0491   48F9 CD 74 5E    	call	modoSPI
0492   48FC 3A 00 48    	ld	a, (PORTCFG)		; testar se mapper/megaram esta ativa
0493   48FF E6 10       	and	$10
0494   4901 28 0E       	jr	z,.print		; desativada, pula
0495   4903 11 D7 60    	ld	de, strMapper
0496   4906 3A 00 48    	ld	a, (PORTCFG)		; ativa, testar se eh mapper ou megaram
0497   4909 E6 20       	and	$20
0498   490B C2 84 5E    	jp	nz,printString
0499   490E 11 01 61    	ld	de, strMegaram		; Megaram ativa
0500   4911             .print: 
0501   4911 C3 84 5E    	jp	printString
0502   4914             
0503   4914             MYSETSCR: 	; Restore screen parameters on MSX>=2 if they're not set yet
0504   4914 3A 2D 00    	ld	a,(MSXVER)
0505   4917 B7          	or	a			; MSX1?
0506   4918 C8          	ret	z			; Yes, return
0507   4919             
0508   4919 0E 23       	ld	c,$23			; Block-2, R#3
0509   491B DD 21 F5 01 	ld 	ix,REDCLK
0510   491F CD 5F 01    	call	EXTROM
0511   4922 E6 01       	and	1
0512   4924 47          	ld	b,a
0513   4925 3A AF FC    	ld	a,(SCRMOD)
0514   4928 B8          	cp	b
0515   4929 20 1C       	jr	nz,.restore
0516   492B 0C          	inc	c
0517   492C DD 21 F5 01 	ld 	ix,REDCLK
0518   4930 CD 5F 01    	call	EXTROM
0519   4933 47          	ld	b,a
0520   4934 0C          	inc	c
0521   4935 DD 21 F5 01 	ld 	ix,REDCLK
0522   4939 CD 5F 01    	call	EXTROM
0523   493C 87          	add	a,a
0524   493D 87          	add	a,a
0525   493E 87          	add	a,a
0526   493F 87          	add	a,a
0527   4940 B0          	or	b
0528   4941 47          	ld	b,a
0529   4942 3A B0 F3    	ld	a,(LINLEN)
0530   4945 B8          	cp	b
0531   4946 C8          	ret	z
0532   4947             .restore: 
0533   4947 AF          	xor	a		; Don't displat the function keys
0534   4948 DD 21 85 01 	ld	ix,SDFSCR
0535   494C C3 5F 01    	jp	EXTROM
0536   494F             
0537   494F             ;-----------------------------------------------------------------------------
0538   494F             ;
0539   494F             ; Obtain driver version
0540   494F             ;
0541   494F             ; Input:  -
0542   494F             ; Output: A = Main version number
0543   494F             ;         B = Secondary version number
0544   494F             ;         C = Revision number
0545   494F             
0546   494F             DRV_VERSION: 
0547   494F 3E 01       	ld	a, VER_MAIN
0548   4951 06 00       	ld	b, VER_SEC
0549   4953 0E 05       	ld	c, VER_REV
0550   4955 C9          	ret
0551   4956             
0552   4956             
0553   4956             ;-----------------------------------------------------------------------------
0554   4956             ;
0555   4956             ; BASIC expanded statement ("CALL") handler.
0556   4956             ; Works the expected way, except that if invoking CALBAS is needed,
0557   4956             ; it must be done via the CALLB0 routine in kernel page 0.
0558   4956             
0559   4956             DRV_BASSTAT: 
0560   4956 37          	scf
0561   4957 C9          	ret
0562   4958             
0563   4958             
0564   4958             ;-----------------------------------------------------------------------------
0565   4958             ;
0566   4958             ; BASIC expanded device handler.
0567   4958             ; Works the expected way, except that if invoking CALBAS is needed,
0568   4958             ; it must be done via the CALLB0 routine in kernel page 0.
0569   4958             
0570   4958             DRV_BASDEV: 
0571   4958 37          	scf
0572   4959 C9          	ret
0573   495A             
0574   495A             ;-----------------------------------------------------------------------------
0575   495A             ;
0576   495A             ; Extended BIOS hook.
0577   495A             ; Works the expected way, except that it must return
0578   495A             ; D'=1 if the old hook must be called, D'=0 otherwise.
0579   495A             ; It is entered with D'=1.
0580   495A             
0581   495A             DRV_EXTBIO: 
0582   495A C9          	ret
0583   495B             
0584   495B             ;-----------------------------------------------------------------------------
0585   495B             ;
0586   495B             ; Direct calls entry points.
0587   495B             ; Calls to addresses 7850h, 7853h, 7856h, 7859h and 785Ch
0588   495B             ; in kernel banks 0 and 3 will be redirected
0589   495B             ; to DIRECT0/1/2/3/4 respectively.
0590   495B             ; Receives all register data from the caller except IX and AF'.
0591   495B             
0592   495B             DRV_DIRECT0: 
0593   495B             DRV_DIRECT1: 
0594   495B             DRV_DIRECT2: 
0595   495B             DRV_DIRECT3: 
0596   495B             DRV_DIRECT4: 
0597   495B C9          	ret
0598   495C             
0599   495C             
0600   495C             ;=====
0601   495C             ;=====  BEGIN of DEVICE-BASED specific routines
0602   495C             ;=====
0603   495C             
0604   495C             ;-----------------------------------------------------------------------------
0605   495C             ;
0606   495C             ; Read or write logical sectors from/to a logical unit
0607   495C             ;
0608   495C             ;Input:    Cy=0 to read, 1 to write
0609   495C             ;          A = Device number, 1 to 7
0610   495C             ;          B = Number of sectors to read or write
0611   495C             ;          C = Logical unit number, 1 to 7
0612   495C             ;          HL = Source or destination memory address for the transfer
0613   495C             ;          DE = Address where the 4 byte sector number is stored.
0614   495C             ;Output:   A = Error code (the same codes of MSX-DOS are used):
0615   495C             ;              0: Ok
0616   495C             ;              .IDEVL: Invalid device or LUN
0617   495C             ;              .NRDY: Not ready
0618   495C             ;              .DISK: General unknown disk error
0619   495C             ;              .DATA: CRC error when reading
0620   495C             ;              .RNF: Sector not found
0621   495C             ;              .UFORM: Unformatted disk
0622   495C             ;              .WPROT: Write protected media, or read-only logical unit
0623   495C             ;              .WRERR: Write error
0624   495C             ;              .NCOMP: Incompatible disk.
0625   495C             ;              .SEEK: Seek error.
0626   495C             ;          B = Number of sectors actually read (in case of error only)
0627   495C             
0628   495C             DEV_RW: 
0629   495C F5          	push	af
0630   495E BF FE 03    	cp	a, 3		; somente 2 dispositivos
0631   4960 30 10       	jr	nc,.saicomerroidl
0632   4962 0D          	dec	c		; somente 1 logical unit
0633   4963 20 0D       	jr	nz,.saicomerroidl
0634   4965 E5          	push	hl
0635   4966 CD FD 4A    	call	testaCartao	; verificar se cartao esta OK
0636   4969 E1          	pop	hl
0637   496A 30 0C       	jr	nc,.ok
0638   496C F1          	pop	af		; retira AF guardado no inicio
0639   496D 3E FC       	ld	a, ENRDY	; Not ready
0640   496F             ;	ld	a, EDISK	; General unknown disk error
0641   496F 06 00       	ld	b, 0
0642   4971 C9          	ret
0643   4972             .saicomerroidl: 
0644   4972 F1          	pop	af		; retira AF guardado no inicio
0645   4973 3E B5       	ld	a, EIDEVL	; informar erro
0646   4975 06 00       	ld	b, 0
0647   4977 C9          	ret
0648   4978             .ok: 
0649   4978 FD 70 32    	ld	(iy+NUMBLOCOS), b	; guarda numero de blocos para ler/gravar
0650   497B E5          	push	hl
0651   497C D5          	push	de
0652   497D CD 42 4B    	call	calculaCIDoffset	; calculamos em IX a posicao correta do offset CID dependendo do cartao atual
0653   4980 D1          	pop	de
0654   4981 E1          	pop	hl
0655   4982 F1          	pop	af		; retira AF guardado no inicio, para saber se eh leitura ou escrita
0656   4983 38 25       	jr	c,escrita	; se for escrita pulamos
0657   4985             leitura: 
0658   4985 1A          	ld	a, (de)		; 1. n. bloco
0659   4986 F5          	push	af
0660   4987 13          	inc	de
0661   4988 1A          	ld	a, (de)		; 2. n. bloco
0662   4989 F5          	push	af
0663   498A 13          	inc	de
0664   498B 1A          	ld	a, (de)		; 3. n. bloco
0665   498C 4F          	ld	c, a
0666   498D 13          	inc	de
0667   498E 1A          	ld	a, (de)		; 4. n. bloco
0668   498F 13          	inc	de
0669   4990 47          	ld	b, a
0670   4991 F1          	pop	af
0671   4992 57          	ld	d, a
0672   4993 F1          	pop	af		; HL = ponteiro destino
0673   4994 5F          	ld	e, a		; BC DE = 32 bits numero do bloco
0674   4995 CD 74 5E    	call	modoSPI
0675   4998 CD 09 56    	call	LerBloco	; chamar rotina de leitura de dados
0676   499B CD 7C 5E    	call	modoROM
0677   499E 30 08       	jr	nc,.ok
0678   49A0 CD 25 4B    	call	marcaErroCartao		; ocorreu erro na leitura, marcar erro
0679   49A3             ;	ld	a, ENRDY	; Not ready
0680   49A3 3E FD       	ld	a, EDISK	; General unknown disk error
0681   49A5 06 00       	ld	b, 0		; informar que lemos 0 blocos
0682   49A7 C9          	ret
0683   49A8             .ok: 
0684   49A8 AF          	xor	a		; tudo OK, informar ao Nextor
0685   49A9 C9          	ret
0686   49AA             
0687   49AA             escrita: 
0688   49AA CD 30 4B    	call	testaWP		; testar se cartao esta protegido contra escrita
0689   49AD 28 05       	jr	z,.ok
0690   49AF 3E F8       	ld	a, EWPROT	; disco protegido
0691   49B1 06 00       	ld	b, 0
0692   49B3 C9          	ret
0693   49B4             .ok: 
0694   49B4 1A          	ld	a, (de)		; 1. n. bloco
0695   49B5 F5          	push	af
0696   49B6 13          	inc	de
0697   49B7 1A          	ld	a, (de)		; 2. n. bloco
0698   49B8 F5          	push	af
0699   49B9 13          	inc	de
0700   49BA 1A          	ld	a, (de)		; 3. n. bloco
0701   49BB 13          	inc	de
0702   49BC 4F          	ld	c, a
0703   49BD 1A          	ld	a, (de)		; 4. n. bloco
0704   49BE 13          	inc	de
0705   49BF 47          	ld	b, a
0706   49C0 F1          	pop	af
0707   49C1 57          	ld	d, a
0708   49C2 F1          	pop	af		; HL = ponteiro destino
0709   49C3 5F          	ld	e, a		; BC DE = 32 bits numero do bloco
0710   49C4 CD 74 5E    	call	modoSPI
0711   49C7 CD 61 4D    	call	GravarBloco	; chamar rotina de gravacao de dados
0712   49CA CD 7C 5E    	call	modoROM
0713   49CD 30 08       	jr	nc,.ok2
0714   49CF CD 25 4B    	call	marcaErroCartao		; ocorreu erro, marcar nas flags
0715   49D2 3E FE       	ld	a,EWRERR	; Write error
0716   49D4 06 00       	ld	b,0
0717   49D6 C9          	ret
0718   49D7             .ok2: 
0719   49D7 AF          	xor	a			; gravacao sem erros!
0720   49D8 C9          	ret
0721   49D9             
0722   49D9             ;-----------------------------------------------------------------------------
0723   49D9             ;
0724   49D9             ; Device information gathering
0725   49D9             ;
0726   49D9             ;Input:   A = Device index, 1 to 7
0727   49D9             ;         B = Information to return:
0728   49D9             ;             0: Basic information
0729   49D9             ;             1: Manufacturer name string
0730   49D9             ;             2: Device name string
0731   49D9             ;             3: Serial number string
0732   49D9             ;         HL = Pointer to a buffer in RAM
0733   49D9             ;Output:  A = Error code:
0734   49D9             ;             0: Ok
0735   49D9             ;             1: Device not available or invalid device index
0736   49D9             ;             2: Information not available, or invalid information index
0737   49D9             ;         When basic information is requested,
0738   49D9             ;         buffer filled with the following information:
0739   49D9             ;
0740   49D9             ;+0 (1): Numer of logical units, from 1 to 7. 1 if the device has no logical
0741   49D9             ;        units (which is functionally equivalent to having only one).
0742   49D9             ;+1 (1): Device flags, always zero in Beta 2.
0743   49D9             ;
0744   49D9             ; The strings must be printable ASCII string (ASCII codes 32 to 126),
0745   49D9             ; left justified and padded with spaces. All the strings are optional,
0746   49D9             ; if not available, an error must be returned.
0747   49D9             ; If a string is provided by the device in binary format, it must be reported
0748   49D9             ; as an hexadecimal, upper-cased string, preceded by the prefix "0x".
0749   49D9             ; The maximum length for a string is 64 characters;
0750   49D9             ; if the string is actually longer, the leftmost 64 characters
0751   49D9             ; should be provided.
0752   49D9             ;
0753   49D9             ; In the case of the serial number string, the same rules for the strings
0754   49D9             ; apply, except that it must be provided right-justified,
0755   49D9             ; and if it is too long, the rightmost characters must be
0756   49D9             ; provided, not the leftmost.
0757   49D9             
0758   49D9             DEV_INFO: 
0759   49D9 04          	inc	b
0760   49DB BF FE 03    	cp	a,3		; somente 2 dispositivos
0761   49DD 30 07       	jr	nc,.saicomerro
0762   49DF E5          	push	hl
0763   49E0 CD FD 4A    	call	testaCartao	; verificar se cartao esta OK
0764   49E3 E1          	pop	hl
0765   49E4 30 03       	jr	nc,.ok		; nao houve erro
0766   49E6             .saicomerro: 
0767   49E6 3E 01       	ld	a, 1		; informar erro
0768   49E8 C9          	ret
0769   49E9             
0770   49E9             .ok: 
0771   49E9 10 07       	djnz	.naoBasic
0772   49EB             ; Basic information:
0773   49EB 3E 01       	ld	a,1		; 1 logical unit somente
0774   49ED 77          	ld	(hl), a
0775   49EE AF          	xor	a		; reservado, deve ser 0
0776   49EF 23          	inc	hl
0777   49F0 77          	ld	(hl), a
0778   49F1 C9          	ret			; retorna com A=0 (OK)
0779   49F2             
0780   49F2             .naoBasic: 
0781   49F2 E5          	push	hl
0782   49F3 CD 42 4B    	call	calculaCIDoffset	; calculamos em IX a posicao correta do offset CID dependendo do cartao atual
0783   49F6 E1          	pop	hl
0784   49F7 10 25       	djnz	.naoManuf
0785   49F9             ; Manufacturer Name:
0786   49F9 E5          	push	hl		; salva ponteiro do buffer
0787   49FA 06 40       	ld	b, 64		; preenche buffer com espaco
0788   49FC 3E 20       	ld	a, ' '
0789   49FE             .loop1: 
0790   49FE 77          	ld	(hl), a
0791   49FF 23          	inc	hl
0792   4A00 10 FC       	djnz	.loop1
0793   4A02 D1          	pop	de		; recuperamos ponteiro do buffer em DE
0794   4A03 3E 28       	ld	a, '('		; colocamos (xx) xxx no buffer
0795   4A05 12          	ld	(de), a
0796   4A06 13          	inc	de
0797   4A07 DD 7E 00    	ld	a, (ix)		; byte do fabricante
0798   4A0A CD 8D 5E    	call	DecToAscii
0799   4A0D 3E 29       	ld	a, ')'
0800   4A0F 12          	ld	(de), a
0801   4A10 13          	inc	de
0802   4A11 3E 20       	ld	a, ' '
0803   4A13 12          	ld	(de), a
0804   4A14 13          	inc	de
0805   4A15 DD 7E 00    	ld	a, (ix)		; byte do fabricante
0806   4A18 CD FD 5E    	call	pegaFabricante	; pegar nome do fabricante em HL
0807   4A1B ED B0       	ldir			; e colocar no buffer
0808   4A1D C9          	ret
0809   4A1E             
0810   4A1E             .naoManuf: 
0811   4A1E 10 1A       	djnz	.naoProduct
0812   4A20             ; Product Name:
0813   4A20 E5          	push	hl		; guarda HL que aponta para buffer do Nextor
0814   4A21 DD E5       	push	ix
0815   4A23 E1          	pop	hl		; joga IX para HL
0816   4A24 16 00       	ld	d, 0
0817   4A26 1E 03       	ld	e, 3		; adiciona offset do productname em HL
0818   4A28 19          	add	hl, de
0819   4A29 D1          	pop	de		; recupera buffer do Nextor em DE
0820   4A2A 01 05 00    	ld	bc, 5		; 5 caracteres
0821   4A2D ED B0       	ldir			; copia nome do produto
0822   4A2F EB          	ex	de,hl		; troca DE com HL, agora HL aponta para Buffer do nextor atualizado
0823   4A30 06 3B       	ld	b, 59		; Coloca espaco no restante do buffer
0824   4A32 3E 20       	ld	a, ' '
0825   4A34             .loop2: 
0826   4A34 77          	ld	(hl), a
0827   4A35 23          	inc	hl
0828   4A36 10 FC       	djnz	.loop2
0829   4A38 AF          	xor	a		; informar sem erros
0830   4A39 C9          	ret
0831   4A3A             
0832   4A3A             .naoProduct: 
0833   4A3A             ; Serial:
0834   4A3A 3E 30       	ld	a, '0'		; Coloca prefixo "0x"
0835   4A3C 77          	ld	(hl), a
0836   4A3D 23          	inc	hl
0837   4A3E 3E 78       	ld	a, 'x'
0838   4A40 77          	ld	(hl), a
0839   4A41 23          	inc	hl
0840   4A42 E5          	push	hl		; guarda HL que aponta para buffer do Nextor
0841   4A43 DD E5       	push	ix
0842   4A45 E1          	pop	hl		; joga IX para HL
0843   4A46 16 00       	ld	d, 0
0844   4A48 1E 09       	ld	e, 9		; adiciona offset do productname em HL
0845   4A4A 19          	add	hl, de
0846   4A4B D1          	pop	de		; recupera buffer do nextor em DE
0847   4A4C 06 04       	ld	b, 4		; 4 bytes do serial
0848   4A4E             .loop3: 
0849   4A4E 7E          	ld	a, (hl)
0850   4A4F CD BD 5E    	call	HexToAscii	; converter HEXA para ASCII
0851   4A52 23          	inc	hl
0852   4A53 10 F9       	djnz	.loop3
0853   4A55 06 36       	ld	b, 54		; Coloca espaco no restante
0854   4A57 3E 20       	ld	a, ' '
0855   4A59             .loop4: 
0856   4A59 12          	ld	(de), a
0857   4A5A 13          	inc	de
0858   4A5B 10 FC       	djnz	.loop4
0859   4A5D AF          	xor	a		; informar sem erros
0860   4A5E C9          	ret
0861   4A5F             
0862   4A5F             ;-----------------------------------------------------------------------------
0863   4A5F             ;
0864   4A5F             ; Obtain device status
0865   4A5F             ;
0866   4A5F             ;Input:   A = Device index, 1 to 7
0867   4A5F             ;         B = Logical unit number, 1 to 7
0868   4A5F             ;             0 to return the status of the device itself.
0869   4A5F             ;Output:  A = Status for the specified logical unit,
0870   4A5F             ;             or for the whole device if 0 was specified:
0871   4A5F             ;                0: The device or logical unit is not available, or the
0872   4A5F             ;                   device or logical unit number supplied is invalid.
0873   4A5F             ;                1: The device or logical unit is available and has not
0874   4A5F             ;                   changed since the last status request.
0875   4A5F             ;                2: The device or logical unit is available and has changed
0876   4A5F             ;                   since the last status request
0877   4A5F             ;                   (for devices, the device has been unplugged and a
0878   4A5F             ;                    different device has been plugged which has been
0879   4A5F             ;                    assigned the same device index; for logical units,
0880   4A5F             ;                    the media has been changed).
0881   4A5F             ;                3: The device or logical unit is available, but it is not
0882   4A5F             ;                   possible to determine whether it has been changed
0883   4A5F             ;                   or not since the last status request.
0884   4A5F             ;
0885   4A5F             ; Devices not supporting hot-plugging must always return status value 1.
0886   4A5F             ; Non removable logical units may return values 0 and 1.
0887   4A5F             ;
0888   4A5F             ; The returned status is always relative to the previous invokation of
0889   4A5F             ; DEV_STATUS itself. Please read the Driver Developer Guide for more info.
0890   4A5F             
0891   4A5F             DEV_STATUS: 
0892   4A60 BF FE 03    	cp	a,3		; 2 dispositivos somente
0893   4A62 30 3E       	jr	nc,.saicomerro
0894   4A64 05          	dec	b		; 1 logical unit somente
0895   4A65 20 3B       	jr	nz,.saicomerro
0896   4A67             
0897   4A67 F5          	push	af
0898   4A68 CD E4 4A    	call	pegaWorkArea	; HL=IY=Work area pointer
0899   4A6B F1          	pop	af
0900   4A6C FD 77 30    	ld	(iy+NUMSD),a	; salva numero do device atual (1 ou 2)
0901   4A6F 4F          	ld	c,a		; c=device number
0902   4A70 CD 74 5E    	call	modoSPI
0903   4A73 3A 00 48    	ld	a, (PORTCFG)	; testar se cartao esta inserido
0904   4A76 CD 7C 5E    	call	modoROM
0905   4A79 A1          	and	c		; C contem 1 se cartao 1, 2 se cartao 2
0906   4A7A 20 23       	jr	nz,.cartaoComErro	; se slot do cartao estiver vazio, marcamos o erro nas flags
0907   4A7C FD 7E 31    	ld	a, (iy+FLAGSCARTAO)	; testar bit de erro do cartao nas flags
0908   4A7F A1          	and	c
0909   4A80 28 1A       	jr	z,.semMudanca	; cartao nao marcado com erro, pula
0910   4A82 CD 74 5E    	call	modoSPI
0911   4A85 CD 6A 4B    	call	detectaCartao	; erro na deteccao do cartao, tentar re-detectar
0912   4A88 CD 7C 5E    	call	modoROM
0913   4A8B 38 12       	jr	c,.cartaoComErro	; nao conseguimos detectar, sai com erro
0914   4A8D FD 7E 30    	ld	a, (iy+NUMSD)		; conseguimos detectar, tira erro nas flags
0915   4A90 2F          	cpl			; inverte bits para fazer o AND
0916   4A91 4F          	ld	c, a
0917   4A92 FD 7E 31    	ld	a, (iy+FLAGSCARTAO)
0918   4A95 A1          	and	c			; limpa bit
0919   4A96 FD 77 31    	ld	(iy+FLAGSCARTAO), a
0920   4A99             .comMudanca: 
0921   4A99 3E 02       	ld	a, 2		; informa ao Nextor que cartao esta OK e mudou
0922   4A9B C9          	ret
0923   4A9C             .semMudanca: 
0924   4A9C 3E 01       	ld	a, 1		; informa ao Nextor que cartao esta OK e nao mudou
0925   4A9E C9          	ret
0926   4A9F             .cartaoComErro: 
0927   4A9F CD 25 4B    	call	marcaErroCartao	; marcar erro do cartao nas flags
0928   4AA2             .saicomerro: 
0929   4AA2 3E 00       	ld	a, 0		; informa erro
0930   4AA4 C9          	ret
0931   4AA5             
0932   4AA5             ;-----------------------------------------------------------------------------
0933   4AA5             ;
0934   4AA5             ; Obtain logical unit information
0935   4AA5             ;
0936   4AA5             ;Input:   A  = Device index, 1 to 7
0937   4AA5             ;         B  = Logical unit number, 1 to 7
0938   4AA5             ;         HL = Pointer to buffer in RAM.
0939   4AA5             ;Output:  A = 0: Ok, buffer filled with information.
0940   4AA5             ;             1: Error, device or logical unit not available,
0941   4AA5             ;                or device index or logical unit number invalid.
0942   4AA5             ;         On success, buffer filled with the following information:
0943   4AA5             ;
0944   4AA5             ;+0 (1): Medium type:
0945   4AA5             ;        0: Block device
0946   4AA5             ;        1: CD or DVD reader or recorder
0947   4AA5             ;        2-254: Unused. Additional codes may be defined in the future.
0948   4AA5             ;        255: Other
0949   4AA5             ;+1 (2): Sector size, 0 if this information does not apply or is
0950   4AA5             ;        not available.
0951   4AA5             ;+3 (4): Total number of available sectors.
0952   4AA5             ;        0 if this information does not apply or is not available.
0953   4AA5             ;+7 (1): Flags:
0954   4AA5             ;        bit 0: 1 if the medium is removable.
0955   4AA5             ;        bit 1: 1 if the medium is read only. A medium that can dinamically
0956   4AA5             ;               be write protected or write enabled is not considered
0957   4AA5             ;               to be read-only.
0958   4AA5             ;        bit 2: 1 if the LUN is a floppy disk drive.
0959   4AA5             ;+8 (2): Number of cylinders
0960   4AA5             ;+10 (1): Number of heads
0961   4AA5             ;+11 (1): Number of sectors per track
0962   4AA5             ;
0963   4AA5             ; Number of cylinders, heads and sectors apply to hard disks only.
0964   4AA5             ; For other types of device, these fields must be zero.
0965   4AA5             
0966   4AA5             LUN_INFO: 
0967   4AA6 BF FE 03    	cp	a, 3		; somente 2 dispositivo
0968   4AA8 30 0A       	jr	nc,.saicomerro
0969   4AAA 05          	dec	b		; somente 1 logical unit
0970   4AAB 20 07       	jr	nz,.saicomerro
0971   4AAD E5          	push	hl
0972   4AAE CD FD 4A    	call	testaCartao
0973   4AB1 E1          	pop	hl
0974   4AB2 30 03       	jr	nc,.ok		; nao tem erro com o cartao
0975   4AB4             .saicomerro: 
0976   4AB4 3E 01       	ld	a, 1		; informar erro
0977   4AB6 C9          	ret
0978   4AB7             .ok: 
0979   4AB7 E5          	push	hl
0980   4AB8 CD 56 4B    	call	calculaBLOCOSoffset	; calcular em IX e HL o offset correto do buffer que armazena total de blocos
0981   4ABB E1          	pop	hl		; do cartao dependendo do cartao atual solicitado
0982   4ABC AF          	xor	a
0983   4ABD 77          	ld	(hl), a		; Informar que o dispositivo eh do tipo block device
0984   4ABE 23          	inc	hl
0985   4ABF 77          	ld	(hl), a		; tamanho de um bloco = 512 bytes (coloca $00, $02 que  $200 = 512)
0986   4AC0 23          	inc	hl
0987   4AC1 3E 02       	ld	a, 2
0988   4AC3 77          	ld	(hl), a
0989   4AC4 23          	inc	hl
0990   4AC5 DD 7E 00    	ld	a, (ix)		; copia numero de blocos total
0991   4AC8 77          	ld	(hl), a
0992   4AC9 23          	inc	hl
0993   4ACA DD 7E 01    	ld	a, (ix+1)
0994   4ACD 77          	ld	(hl), a
0995   4ACE 23          	inc	hl
0996   4ACF DD 7E 02    	ld	a, (ix+2)
0997   4AD2 77          	ld	(hl), a
0998   4AD3 23          	inc	hl
0999   4AD4 AF          	xor	a		; cartoes SD tem total de blocos em 24 bits, mas o Nextor pede numero de
1000   4AD5 77          	ld	(hl), a 	; 32 bits, entao coloca 0 no MSB
1001   4AD6 23          	inc	hl
1002   4AD7 3E 01       	ld	a, 1		; flags: dispositivo R/W removivel
1003   4AD9 77          	ld	(hl), a
1004   4ADA 23          	inc	hl
1005   4ADB AF          	xor	a		; CHS = 0
1006   4ADC 77          	ld	(hl), a
1007   4ADD 23          	inc	hl
1008   4ADE 77          	ld	(hl), a
1009   4ADF 23          	inc	hl
1010   4AE0 77          	ld	(hl), a
1011   4AE1 23          	inc	hl
1012   4AE2 AF          	xor	a		; informar que dados foram preenchidos
1013   4AE3 C9          	ret
1014   4AE4             
1015   4AE4             ;=====
1016   4AE4             ;=====  END of DEVICE-BASED specific routines
1017   4AE4             ;=====
1018   4AE4             
1019   4AE4             ;------------------------------------------------
1020   4AE4             ; Rotinas auxiliares
1021   4AE4             ;------------------------------------------------
1022   4AE4             
1023   4AE4             ;------------------------------------------------
1024   4AE4             ; Pedir ao Nextor o ponteiro de dados de trabalho
1025   4AE4             ; na RAM e colocar em HL e IY
1026   4AE4             ; Destroi HL e IY
1027   4AE4             ;------------------------------------------------
1028   4AE4             pegaWorkArea: 
1029   4AE4 F5          	push	af
1030   4AE5 AF          	xor	a		; Pegar endereco da area de trabalho
1031   4AE6 08          	ex	af,af'
1032   4AE7 AF          	xor	a
1033   4AE8 DD 21 45 40 	ld	ix, GWORK
1034   4AEC CD 7C 5E    	call	modoROM
1035   4AEF CD 42 40    	call	CALBNK
1036   4AF2 DD 6E 00    	ld	l,(ix)		; em HL tem o ponteiro da nossa area da RAM
1037   4AF5 DD 66 01    	ld	h,(ix+1)
1038   4AF8 E5          	push	hl
1039   4AF9 FD E1       	pop	iy		; em IY temos o mesmo ponteiro
1040   4AFB F1          	pop	af
1041   4AFC C9          	ret
1042   4AFD             
1043   4AFD             ;------------------------------------------------
1044   4AFD             ; Testa se cartao esta inserido e/ou houve erro
1045   4AFD             ; na ultima vez que foi acessado. Carry indica
1046   4AFD             ; erro
1047   4AFD             ; Destroi AF, HL, IX, C
1048   4AFD             ;------------------------------------------------
1049   4AFD             testaCartao: 
1050   4AFD F5          	push	af
1051   4AFE CD E4 4A    	call	pegaWorkArea	; HL=IY=Work area pointer
1052   4B01 F1          	pop	af
1053   4B02 FD 77 30    	ld	(iy+NUMSD), a	; salva numero do device atual (1 ou 2)
1054   4B05 4F          	ld	c, a
1055   4B06 CD 74 5E    	call	modoSPI
1056   4B09 3A 00 48    	ld	a, (PORTCFG)	; testar se cartao esta inserido
1057   4B0C CD 7C 5E    	call	modoROM
1058   4B0F A1          	and	c		; C contem 1 se cartao 1, 2 se cartao 2
1059   4B10 20 0A       	jr	nz,.saicomerro				
1060   4B12 FD 7E 31    	ld	a, (iy+FLAGSCARTAO)	; testar bit de erro do cartao nas flags
1061   4B15 A1          	and	c
1062   4B16 28 02       	jr	z,.ok
1063   4B18 37          	scf			; indica erro
1064   4B19 C9          	ret
1065   4B1A             .ok: 
1066   4B1A AF          	xor	a		; zera carry indicando sem erro
1067   4B1B C9          	ret
1068   4B1C             .saicomerro: 
1069   4B1C FD 7E 31    	ld	a, (iy+FLAGSCARTAO)	; marca bit de erro nas flags
1070   4B1F B1          	or	c
1071   4B20 FD 77 31    	ld	(iy+FLAGSCARTAO), a
1072   4B23 37          	scf
1073   4B24 C9          	ret
1074   4B25             
1075   4B25             ;------------------------------------------------
1076   4B25             ; Marcar bit de erro nas flags
1077   4B25             ; Destroi AF, C
1078   4B25             ;------------------------------------------------
1079   4B25             marcaErroCartao: 
1080   4B25 FD 4E 30    	ld	c, (iy+NUMSD)		; cartao atual (1 ou 2)
1081   4B28 FD 7E 31    	ld	a, (iy+FLAGSCARTAO)	; marcar erro
1082   4B2B B1          	or	c
1083   4B2C FD 77 31    	ld	(iy+FLAGSCARTAO), a
1084   4B2F C9          	ret
1085   4B30             
1086   4B30             ;------------------------------------------------
1087   4B30             ; Testar se cartao atual esta protegido contra
1088   4B30             ; gravacao, A=0 se protegido
1089   4B30             ; Destroi AF, C
1090   4B30             ;------------------------------------------------
1091   4B30             testaWP: 
1092   4B30 FD 4E 30    	ld	c, (iy+NUMSD)	; cartao atual (1 ou 2)
1093   4B33 CB 01       	rlc	c		; desloca para apontar para bits 2 ou 3 para cartoes 1 ou 2 respectivamente
1094   4B35 CB 01       	rlc	c
1095   4B37 CD 74 5E    	call	modoSPI
1096   4B3A 3A 00 48    	ld	a, (PORTCFG)	; testar se cartao esta protegido
1097   4B3D CD 7C 5E    	call	modoROM
1098   4B40 A1          	and	c
1099   4B41 C9          	ret			; se A for 0 cartao esta protegido
1100   4B42             
1101   4B42             ;------------------------------------------------
1102   4B42             ; Calcula offset do buffer na RAM em HL e IX para
1103   4B42             ; os dados do CID dependendo do cartao atual
1104   4B42             ; Destroi AF, DE, HL e IX
1105   4B42             ;------------------------------------------------
1106   4B42             calculaCIDoffset: 
1107   4B42 FD E5       	push	iy		; copiamos IY para HL
1108   4B44 E1          	pop	hl
1109   4B45 16 00       	ld	d, 0
1110   4B47 1E 10       	ld	e, BCID1	; DE aponta para buffer BCID1
1111   4B49 FD 7E 30    	ld	a, (iy+NUMSD)	; vamos fazer IX apontar para o buffer correto
1112   4B4C 3D          	dec	a		; dependendo do cartao: BCID1 ou BCID2
1113   4B4D 28 02       	jr	z,.c1
1114   4B4F 1E 20       	ld	e, BCID2	; DE aponta para buffer BCID2
1115   4B51             .c1: 
1116   4B51 19          	add	hl, de		; HL aponta para buffer correto
1117   4B52 E5          	push	hl		
1118   4B53 DD E1       	pop	ix		; vamos colocar HL em IX
1119   4B55 C9          	ret
1120   4B56             
1121   4B56             ;------------------------------------------------
1122   4B56             ; Calcula offset do buffer na RAM para os dados
1123   4B56             ; do total de blocos dependendo do cartao atual
1124   4B56             ; Offset fica em HL e IX
1125   4B56             ; Destroi AF, DE, HL e IX
1126   4B56             ;------------------------------------------------
1127   4B56             calculaBLOCOSoffset: 
1128   4B56 FD E5       	push	iy		; copiamos IY para HL
1129   4B58 E1          	pop	hl
1130   4B59 16 00       	ld	d, 0
1131   4B5B 1E 38       	ld	e, BLOCOS1	; DE aponta para buffer BLOCOS1
1132   4B5D FD 7E 30    	ld	a, (iy+NUMSD)	; Vamos fazer IX apontar para o buffer correto
1133   4B60 3D          	dec	a		; dependendo do cartao: BLOCOS1 ou BLOCOS2
1134   4B61 28 02       	jr	z,.c1
1135   4B63 1E 3C       	ld	e, BLOCOS2	; DE aponta para buffer BLOCOS2
1136   4B65             .c1: 
1137   4B65 19          	add	hl, de		; HL aponta para buffer correto
1138   4B66 E5          	push	hl		
1139   4B67 DD E1       	pop	ix		; Vamos colocar HL em IX
1140   4B69 C9          	ret
1141   4B6A             
1142   4B6A             
1143   4B6A             ;------------------------------------------------
1144   4B6A             ; Minhas funcoes para cartao SD
1145   4B6A             ;------------------------------------------------
1146   4B6A             
1147   4B6A             ;------------------------------------------------
1148   4B6A             ; Processo de inicializacao e deteccao do cartao.
1149   4B6A             ; Detecta se cartao responde, qual versao (SDV1
1150   4B6A             ; ou SDV2), faz a leitura do CSD e CID e calcula
1151   4B6A             ; o numero de blocos do cartao, colocando o CID
1152   4B6A             ; e total de blocos no buffer correto dependendo
1153   4B6A             ; do cartao 1 ou 2.
1154   4B6A             ; Retorna erro no carry. Se for 0 indica deteccao
1155   4B6A             ; com sucesso.
1156   4B6A             ; Destroi todos os registradores
1157   4B6A             ;------------------------------------------------
1158   4B6A             detectaCartao: 
1159   4B6A CD 8E 4C    	call	iniciaSD	; manda pulsos de clock e comandos iniciais
1160   4B6D D8          	ret	c			; retorna se erro
1161   4B6E CD 39 4C    	call	testaSDCV2	; tenta inicializar um cartao SDV2
1162   4B71 D8          	ret	c
1163   4B72 FD E5       	push	iy		; colocar em HL buffer da RAM de trabalho
1164   4B74 E1          	pop	hl		; CSD esta no offset 0, nao precisamos somar
1165   4B75 3E 49       	ld	a, CMD9		; ler CSD
1166   4B77 CD 5A 4C    	call	lerBlocoCxD
1167   4B7A D8          	ret	c
1168   4B7B CD 42 4B    	call	calculaCIDoffset	; calculamos em IX e HL a posicao correta do offset CID dependendo do cartao atual
1169   4B7E 3E 4A       	ld	a, CMD10	; ler CID
1170   4B80 CD 5A 4C    	call	lerBlocoCxD
1171   4B83 D8          	ret	c
1172   4B84 3E 7A       	ld	a, CMD58	; ler OCR
1173   4B86 11 00 00    	ld	de, 0
1174   4B89 CD DF 4C    	call	SD_SEND_CMD_2_ARGS_GET_R3	; enviar comando e receber resposta tipo R3
1175   4B8C D8          	ret	c
1176   4B8D 78          	ld	a, b		; testa bit CCS do OCR que informa se cartao eh SDV1 ou SDV2
1177   4B8E E6 40       	and	$40
1178   4B90 DD 77 0F    	ld	(ix+15), a	; salva informacao da versao do SD (V1 ou V2) no byte 15 do CID
1179   4B93 CC 2E 4C    	call	z,mudarTamanhoBlocoPara512	; se bit CCS do OCR for 1, eh cartao SDV2 (Block address - SDHC ou SDXD)
1180   4B96 D8          	ret	c		; e nao precisamos mudar tamanho do bloco para 512
1181   4B97 CD AD 4C    	call	desabilitaSDs
1182   4B9A             				; agora vamos calcular o total de blocos dependendo dos dados do CSD
1183   4B9A CD 56 4B    	call	calculaBLOCOSoffset	; calcular em IX e HL o offset correto do buffer que armazena total de blocos
1184   4B9D FD E5       	push	iy		; copiamos IY para HL
1185   4B9F E1          	pop	hl
1186   4BA0 16 00       	ld	d, 0
1187   4BA2 1E 05       	ld	e, BCSD+5
1188   4BA4 19          	add	hl, de		; HL aponta para buffer BCSD+5
1189   4BA5 FD 7E 00    	ld	a, (iy+BCSD)
1190   4BA8 E6 C0       	and	$C0		; testa versao do registro CSD
1191   4BAA 28 06       	jr	z,.calculaCSD1
1192   4BAC FE 40       	cp	$40
1193   4BAE 28 54       	jr	z,.calculaCSD2
1194   4BB0 37          	scf			; versao do registro CSD nao reconhecida, informa erro na deteccao
1195   4BB1 C9          	ret
1196   4BB2             
1197   4BB2             ; -----------------------------------
1198   4BB2             ; Registro CSD versao 1, calcular da
1199   4BB2             ; maneira correta para a versao 1
1200   4BB2             ; -----------------------------------
1201   4BB2             .calculaCSD1: 
1202   4BB2 7E          	ld	a, (hl)
1203   4BB3 E6 0F       	and	$0F		; isola READ_BL_LEN
1204   4BB5 F5          	push	af
1205   4BB6 23          	inc	hl
1206   4BB7 7E          	ld	a, (hl)		; 2 primeiros bits de C_SIZE
1207   4BB8 E6 03       	and	3
1208   4BBA 57          	ld	d, a
1209   4BBB 23          	inc	hl
1210   4BBC 5E          	ld	e, (hl)		; 8 bits de C_SIZE (DE contem os primeiros 10 bits de C_SIZE)
1211   4BBD 23          	inc	hl
1212   4BBE 7E          	ld	a, (hl)
1213   4BBF E6 C0       	and	$C0		; 2 ultimos bits de C_SIZE
1214   4BC1 87          	add	a, a		; rotaciona a esquerda
1215   4BC2 CB 13       	rl	e		; rotaciona para DE
1216   4BC4 CB 12       	rl	d
1217   4BC6 87          	add	a, a		; mais uma rotacao
1218   4BC7 CB 13       	rl	e		; rotaciona para DE
1219   4BC9 CB 12       	rl	d
1220   4BCB 13          	inc	de		; agora DE contem todos os 12 bits de C_SIZE, incrementa 1
1221   4BCC 23          	inc	hl
1222   4BCD 7E          	ld	a, (hl)		; proximo byte
1223   4BCE E6 03       	and	3		; 2 bits de C_SIZE_MUL
1224   4BD0 47          	ld	b, a		; B contem os 2 bits de C_SIZE_MUL
1225   4BD1 23          	inc	hl						
1226   4BD2 7E          	ld	a, (hl)		; proximo byte
1227   4BD3 E6 80       	and	$80		; 1 bit de C_SIZE_MUL
1228   4BD5 87          	add	a, a		; rotaciona para esquerda jogando no carry
1229   4BD6 CB 10       	rl	b		; rotaciona para B
1230   4BD8 04          	inc	b		; agora B contem os 3 bits de C_SIZE_MUL
1231   4BD9 04          	inc	b		; faz B = C_SIZE_MUL + 2
1232   4BDA F1          	pop	af		; volta em A o READ_BL_LEN
1233   4BDB 80          	add	a, b		; A = READ_BL_LEN + (C_SIZE_MUL+2)
1234   4BDC 01 00 00    	ld	bc, 0
1235   4BDF CD F8 4B    	call	.eleva2
1236   4BE2 5A          	ld	e, d		; aqui temos 32 bits (BC DE) com o tamanho do cartao
1237   4BE3 51          	ld	d, c		; ignoramos os 8 ultimos bits em E, fazemos BC DE => 0B CD (divide por 256)
1238   4BE4 48          	ld	c, b
1239   4BE5 06 00       	ld	b, 0
1240   4BE7 CB 39       	srl	c		; rotacionamos a direita o C, carry = LSB (divide por 2)
1241   4BE9 CB 1A       	rr	d		; rotacionamos D e E
1242   4BEB CB 1B       	rr	e		; no final BC DE contem tamanho do cartao / 512 = numero de blocos
1243   4BED             .salvaBlocos: 
1244   4BED DD 71 02    	ld	(ix+2), c	; colocar no buffer BLOCOS correto a quantidade de blocos
1245   4BF0 DD 72 01    	ld	(ix+1), d	; que o cartao (1 ou 2) tem
1246   4BF3 DD 73 00    	ld	(ix), e
1247   4BF6 AF          	xor	a		; limpa carry
1248   4BF7 C9          	ret
1249   4BF8             
1250   4BF8             .eleva2: 			; aqui temos: A = (READ_BL_LEN + (C_SIZE_MUL+2))
1251   4BF8             				; BC = 0
1252   4BF8             				; DE = C_SIZE
1253   4BF8 CB 23       	sla	e		; rotacionamos C_SIZE por 'A' vezes
1254   4BFA CB 12       	rl	d
1255   4BFC CB 11       	rl	c
1256   4BFE CB 10       	rl	b
1257   4C00 3D          	dec	a		; subtraimos 1
1258   4C01 20 F5       	jr	nz,.eleva2
1259   4C03 C9          	ret			; em BC DE temos o tamanho do cartao (bytes) em 32 bits
1260   4C04             
1261   4C04             ; -----------------------------------
1262   4C04             ; Registro CSD versao 2, calcular da
1263   4C04             ; maneira correta para a versao 2
1264   4C04             ; -----------------------------------
1265   4C04             .calculaCSD2: 
1266   4C04 23          	inc	hl		; HL ja aponta para BCSD+5, fazer HL apontar para BCSD+7
1267   4C05 23          	inc	hl
1268   4C06 7E          	ld	a, (hl)
1269   4C07 E6 3F       	and	$3F
1270   4C09 4F          	ld	c, a
1271   4C0A 23          	inc	hl
1272   4C0B 56          	ld	d, (hl)
1273   4C0C 23          	inc	hl
1274   4C0D 5E          	ld	e, (hl)
1275   4C0E CD 1A 4C    	call	.inc32		; soma 1
1276   4C11 CD 22 4C    	call	.desloca32	; multiplica por 512
1277   4C14 CD 27 4C    	call	.rotaciona24	; multiplica por 2
1278   4C17 C3 ED 4B    	jp		.salvaBlocos
1279   4C1A             
1280   4C1A             .inc32: 
1281   4C1A 1C          	inc	e
1282   4C1B C0          	ret	nz
1283   4C1C 14          	inc	d
1284   4C1D C0          	ret	nz
1285   4C1E 0C          	inc	c
1286   4C1F C0          	ret	nz
1287   4C20 04          	inc	b
1288   4C21 C9          	ret
1289   4C22             
1290   4C22             .desloca32: 
1291   4C22 41          	ld	b, c
1292   4C23 4A          	ld	c, d
1293   4C24 53          	ld	d, e
1294   4C25 1E 00       	ld	e, 0
1295   4C27             .rotaciona24: 
1296   4C27 CB 22       	sla	d
1297   4C29 CB 11       	rl	c
1298   4C2B CB 10       	rl	b
1299   4C2D C9          	ret
1300   4C2E             
1301   4C2E             ; ------------------------------------------------
1302   4C2E             ; Setar o tamanho do bloco para 512 se o cartao
1303   4C2E             ; for SDV1
1304   4C2E             ; ------------------------------------------------
1305   4C2E             mudarTamanhoBlocoPara512: 
1306   4C2E 3E 50       	ld	a, CMD16
1307   4C30 01 00 00    	ld	bc, 0
1308   4C33 11 00 02    	ld	de, 512
1309   4C36 C3 CA 4C    	jp	SD_SEND_CMD_GET_ERROR
1310   4C39             
1311   4C39             ; ------------------------------------------------
1312   4C39             ; Tenta inicializar um cartao SDV2, se houver erro
1313   4C39             ; o cartao deve ser SDV1
1314   4C39             ; ------------------------------------------------
1315   4C39             testaSDCV2: 
1316   4C39 3E 48       	ld	a, CMD8
1317   4C3B 11 AA 01    	ld	de, $1AA
1318   4C3E CD DF 4C    	call	SD_SEND_CMD_2_ARGS_GET_R3
1319   4C41 21 C3 4C    	ld	hl, SD_SEND_CMD1	; HL aponta para rotina correta
1320   4C44 38 03       	jr	c,.pula		; cartao recusou CMD8, enviar comando CMD1
1321   4C46 21 B5 4C    	ld	hl, SD_SEND_ACMD41	; cartao aceitou CMD8, enviar comando ACMD41
1322   4C49             .pula: 
1323   4C49 01 14 00    	ld	bc, 20		; B = 0, C = 20: 5120 tentativas
1324   4C4C             .loop: 
1325   4C4C C5          	push	bc
1326   4C4D CD 59 4C    	call	.jumpHL		; chamar rotina correta em HL
1327   4C50 C1          	pop	bc
1328   4C51 D0          	ret	nc
1329   4C52 10 F8       	djnz	.loop
1330   4C54 0D          	dec	c
1331   4C55 20 F5       	jr	nz,.loop
1332   4C57 37          	scf
1333   4C58 C9          	ret
1334   4C59             .jumpHL: 
1335   4C59 E9          	jp	(hl)		; chamar rotina correta em HL
1336   4C5A             
1337   4C5A             ; ------------------------------------------------
1338   4C5A             ; Ler registro CID ou CSD, o comando vem em A
1339   4C5A             ; ------------------------------------------------
1340   4C5A             lerBlocoCxD: 
1341   4C5A CD C5 4C    	call	SD_SEND_CMD_NO_ARGS
1342   4C5D D8          	ret	c
1343   4C5E CD 28 4D    	call	WAIT_RESP_FE
1344   4C61 D8          	ret	c
1345   4C62 11 00 40    	ld	de, PORTSPI
1346   4C65 EB          	ex	de,hl
1347   4C66 ED A0       > ldi	
1347   4C68 ED A0       > ldi	
1347   4C6A ED A0       > ldi	
1347   4C6C ED A0       > ldi	
1347   4C6E ED A0       > ldi	
1347   4C70 ED A0       > ldi	
1347   4C72 ED A0       > ldi	
1347   4C74 ED A0       > ldi	
1347   4C76 ED A0       > ldi	
1347   4C78 ED A0       > ldi	
1347   4C7A ED A0       > ldi	
1347   4C7C ED A0       > ldi	
1347   4C7E ED A0       > ldi	
1347   4C80 ED A0       > ldi	
1347   4C82 ED A0       > ldi	
1347   4C84 ED A0       > ldi	
1348   4C86 00          	nop
1349   4C87 7E          	ld	a, (hl)
1350   4C88 00          	nop
1351   4C89 7E          	ld	a, (hl)		; byte de resposta
1352   4C8A B7          	or	a
1353   4C8B EB          	ex	de,hl
1354   4C8C 18 1F       	jr		desabilitaSDs
1355   4C8E             
1356   4C8E             ; ------------------------------------------------
1357   4C8E             ; Algoritmo para inicializar um cartao SD
1358   4C8E             ; Destroi AF, B, DE
1359   4C8E             ; ------------------------------------------------
1360   4C8E             iniciaSD: 
1361   4C8E CD AD 4C    	call	desabilitaSDs
1362   4C91             
1363   4C91 06 0A       	ld	b, 10		; enviar 80 pulsos de clock com cartao desabilitado
1364   4C93             enviaClocksInicio: 
1365   4C93 3E FF       	ld	a, $FF		; manter MOSI em 1
1366   4C95 32 00 40    	ld	(PORTSPI), a
1367   4C98 10 F9       	djnz	enviaClocksInicio
1368   4C9A CD 54 4D    	call	setaSDAtual	; ativar cartao atual
1369   4C9D 06 08       	ld	b, 8		; 8 tentativas para CMD0
1370   4C9F             SD_SEND_CMD0: 
1371   4C9F 3E 40       	ld	a, CMD0		; primeiro comando: CMD0
1372   4CA1 11 00 00    	ld	de, 0
1373   4CA4 C5          	push	bc
1374   4CA5 CD D2 4C    	call	SD_SEND_CMD_2_ARGS_TEST_BUSY
1375   4CA8 C1          	pop	bc
1376   4CA9 D0          	ret	nc			; retorna se cartao respondeu ao CMD0
1377   4CAA 10 F3       	djnz	SD_SEND_CMD0
1378   4CAC 37          	scf			; cartao nao respondeu ao CMD0, informar erro
1379   4CAD             	; fall throw
1380   4CAD             
1381   4CAD             ; ------------------------------------------------
1382   4CAD             ; Desabilitar (de-selecionar) todos os cartoes
1383   4CAD             ; Nao destroi registradores
1384   4CAD             ; ------------------------------------------------
1385   4CAD             desabilitaSDs: 
1386   4CAD F5          	push	af
1387   4CAE 3E FF       	ld	a, $FF		; todos os /CS em 1
1388   4CB0 32 00 48    	ld	(PORTCFG), a
1389   4CB3 F1          	pop	af
1390   4CB4 C9          	ret
1391   4CB5             
1392   4CB5             ; ------------------------------------------------
1393   4CB5             ; Enviar comando ACMD41
1394   4CB5             ; ------------------------------------------------
1395   4CB5             SD_SEND_ACMD41: 
1396   4CB5 3E 77       	ld	a, CMD55
1397   4CB7 CD C5 4C    	call	SD_SEND_CMD_NO_ARGS
1398   4CBA 3E 69       	ld	a, ACMD41
1399   4CBC 01 00 40    	ld	bc, $4000
1400   4CBF 51          	ld	d, c
1401   4CC0 59          	ld	e, c
1402   4CC1 18 07       	jr		SD_SEND_CMD_GET_ERROR
1403   4CC3             
1404   4CC3             ; ------------------------------------------------
1405   4CC3             ; Enviar CMD1 para cartao. Carry indica erro
1406   4CC3             ; Destroi AF, BC, DE
1407   4CC3             ; ------------------------------------------------
1408   4CC3             SD_SEND_CMD1: 
1409   4CC3 3E 41       	ld	a, CMD1
1410   4CC5             SD_SEND_CMD_NO_ARGS: 
1411   4CC5 01 00 00    	ld	bc, 0
1412   4CC8 50          	ld	d, b
1413   4CC9 59          	ld	e, c
1414   4CCA             SD_SEND_CMD_GET_ERROR: 
1415   4CCA CD F8 4C    	call	SD_SEND_CMD
1416   4CCD B7          	or	a
1417   4CCE C8          	ret	z			; se A=0 nao houve erro, retornar
1418   4CCF             	; fall throw
1419   4CCF             
1420   4CCF             ; ------------------------------------------------
1421   4CCF             ; Informar erro
1422   4CCF             ; Nao destroi registradores
1423   4CCF             ; ------------------------------------------------
1424   4CCF             setaErro: 
1425   4CCF 37          	scf
1426   4CD0 18 DB       	jr		desabilitaSDs
1427   4CD2             
1428   4CD2             ; ------------------------------------------------
1429   4CD2             ; Enviar comando em A com 2 bytes de parametros
1430   4CD2             ; em DE e testar retorno BUSY
1431   4CD2             ; Retorna em A a resposta do cartao
1432   4CD2             ; Destroi AF, BC
1433   4CD2             ; ------------------------------------------------
1434   4CD2             SD_SEND_CMD_2_ARGS_TEST_BUSY: 
1435   4CD2 01 00 00    	ld	bc, 0
1436   4CD5 CD F8 4C    	call	SD_SEND_CMD
1437   4CD8 47          	ld	b, a
1438   4CD9 E6 FE       	and	$FE		; testar bit 0 (flag BUSY)
1439   4CDB 78          	ld	a, b
1440   4CDC 20 F1       	jr	nz,setaErro	; BUSY em 1, informar erro
1441   4CDE C9          	ret			; sem erros
1442   4CDF             
1443   4CDF             ; ------------------------------------------------
1444   4CDF             ; Enviar comando em A com 2 bytes de parametros
1445   4CDF             ; em DE e ler resposta do tipo R3 em BC DE
1446   4CDF             ; Retorna em A a resposta do cartao
1447   4CDF             ; Destroi AF, BC, DE, HL
1448   4CDF             ; ------------------------------------------------
1449   4CDF             SD_SEND_CMD_2_ARGS_GET_R3: 
1450   4CDF CD D2 4C    	call	SD_SEND_CMD_2_ARGS_TEST_BUSY
1451   4CE2 D8          	ret	c
1452   4CE3 F5          	push	af
1453   4CE4 CD 36 4D    	call	WAIT_RESP_NO_FF
1454   4CE7 67          	ld	h, a
1455   4CE8 CD 36 4D    	call	WAIT_RESP_NO_FF
1456   4CEB 6F          	ld	l, a
1457   4CEC CD 36 4D    	call	WAIT_RESP_NO_FF
1458   4CEF 57          	ld	d, a
1459   4CF0 CD 36 4D    	call	WAIT_RESP_NO_FF
1460   4CF3 5F          	ld	e, a
1461   4CF4 44          	ld	b, h
1462   4CF5 4D          	ld	c, l
1463   4CF6 F1          	pop	af
1464   4CF7 C9          	ret
1465   4CF8             
1466   4CF8             ; ------------------------------------------------
1467   4CF8             ; Enviar comando em A com 4 bytes de parametros
1468   4CF8             ; em BC DE e enviar CRC correto se for CMD0 ou 
1469   4CF8             ; CMD8 e aguardar processamento do cartao
1470   4CF8             ; Destroi AF, BC
1471   4CF8             ; ------------------------------------------------
1472   4CF8             SD_SEND_CMD: 
1473   4CF8 CD 54 4D    	call	setaSDAtual
1474   4CFB 32 00 40    	ld	(PORTSPI), a
1475   4CFE F5          	push	af
1476   4CFF 78          	ld	a, b
1477   4D00 00          	nop
1478   4D01 32 00 40    	ld	(PORTSPI), a
1479   4D04 79          	ld	a, c
1480   4D05 00          	nop
1481   4D06 32 00 40    	ld	(PORTSPI), a
1482   4D09 7A          	ld	a, d
1483   4D0A 00          	nop
1484   4D0B 32 00 40    	ld	(PORTSPI), a
1485   4D0E 7B          	ld	a, e
1486   4D0F 00          	nop
1487   4D10 32 00 40    	ld	(PORTSPI), a
1488   4D13 F1          	pop	af
1489   4D14 FE 40       	cp	CMD0
1490   4D16 06 95       	ld	b, $95		; CRC para CMD0
1491   4D18 28 08       	jr	z,enviaCRC
1492   4D1A FE 48       	cp	CMD8
1493   4D1C 06 87       	ld	b, $87		; CRC para CMD8
1494   4D1E 28 02       	jr	z,enviaCRC
1495   4D20 06 FF       	ld	b, $FF		; CRC dummy
1496   4D22             enviaCRC: 
1497   4D22 78          	ld	a, b
1498   4D23 32 00 40    	ld	(PORTSPI), a
1499   4D26 18 0E       	jr	WAIT_RESP_NO_FF
1500   4D28             
1501   4D28             ; ------------------------------------------------
1502   4D28             ; Esperar que resposta do cartao seja $FE
1503   4D28             ; Destroi AF, B
1504   4D28             ; ------------------------------------------------
1505   4D28             WAIT_RESP_FE: 
1506   4D28 06 0A       	ld	b, 10		; 10 tentativas
1507   4D2A             .loop: 
1508   4D2A C5          	push	bc
1509   4D2B CD 36 4D    	call	WAIT_RESP_NO_FF	; esperar resposta diferente de $FF
1510   4D2E C1          	pop	bc
1511   4D2F FE FE       	cp	$FE		; resposta  $FE ?
1512   4D31 C8          	ret	z		; sim, retornamos com carry=0
1513   4D32 10 F6       	djnz	.loop
1514   4D34 37          	scf			; erro, carry=1
1515   4D35 C9          	ret
1516   4D36             
1517   4D36             ; ------------------------------------------------
1518   4D36             ; Esperar que resposta do cartao seja diferente
1519   4D36             ; de $FF
1520   4D36             ; Destroi AF, BC
1521   4D36             ; ------------------------------------------------
1522   4D36             WAIT_RESP_NO_FF: 
1523   4D36 01 01 00    	ld	bc, 1		; 256 tentativas
1524   4D39             .loop: 
1525   4D39 3A 00 40    	ld	a, (PORTSPI)
1526   4D3C FE FF       	cp	$FF		; testa $FF
1527   4D3E C0          	ret		nz		; sai se nao for $FF
1528   4D3F 10 F8       	djnz	.loop
1529   4D41 0D          	dec	c
1530   4D42 20 F5       	jr	nz,.loop
1531   4D44 C9          	ret
1532   4D45             
1533   4D45             ; ------------------------------------------------
1534   4D45             ; Esperar que resposta do cartao seja diferente
1535   4D45             ; de $00
1536   4D45             ; Destroi A, BC
1537   4D45             ; ------------------------------------------------
1538   4D45             WAIT_RESP_NO_00: 
1539   4D45 01 80 00    	ld	bc, 128		; 32768 tentativas
1540   4D48             .loop: 
1541   4D48 3A 00 40    	ld	a, (PORTSPI)
1542   4D4B B7          	or	a
1543   4D4C C0          	ret	nz			; se resposta for <> $00, sai
1544   4D4D 10 F9       	djnz	.loop
1545   4D4F 0D          	dec	c
1546   4D50 20 F6       	jr	nz,.loop
1547   4D52 37          	scf			; erro
1548   4D53 C9          	ret
1549   4D54             
1550   4D54             ; ------------------------------------------------
1551   4D54             ; Ativa (seleciona) cartao atual baixando seu /CS
1552   4D54             ; Nao destroi registradores
1553   4D54             ; ------------------------------------------------
1554   4D54             setaSDAtual: 
1555   4D54 F5          	push	af
1556   4D55 3A 00 40    	ld	a, (PORTSPI)	; dummy read
1557   4D58 FD 7E 30    	ld	a, (iy+NUMSD)
1558   4D5B 2F          	cpl			; inverte bits
1559   4D5C 32 00 48    	ld	(PORTCFG), a
1560   4D5F F1          	pop	af
1561   4D60 C9          	ret
1562   4D61             
1563   4D61             
1564   4D61             ; ------------------------------------------------
1565   4D61             ; Grava um bloco de 512 bytes no cartao
1566   4D61             ; HL aponta para o inicio dos dados
1567   4D61             ; BC e DE contem o numero do bloco (BCDE = 32 bits)
1568   4D61             ; Destroi AF, BC, DE, HL
1569   4D61             ; ------------------------------------------------
1570   4D61             GravarBloco: 
1571   4D61 DD 7E 0F    	ld	a, (ix+15)	; verificar se eh SDV1 ou SDV2
1572   4D64 B7          	or	a
1573   4D65 CC 68 5E    	call	z,blocoParaByte		; se for SDV1 coverter blocos para bytes
1574   4D68 CD 54 4D    	call	setaSDAtual	; selecionar cartao atual
1575   4D6B FD 7E 32    	ld	a, (iy+NUMBLOCOS)	; testar se Nextor quer gravar 1 ou mais blocos
1576   4D6E 3D          	dec	a
1577   4D6F CA D6 51    	jp	z,.umBloco	; somente um bloco, gravar usando CMD24
1578   4D72             
1579   4D72             ; multiplos blocos
1580   4D72 C5          	push	bc
1581   4D73 D5          	push	de
1582   4D74 3E 77       	ld	a, CMD55	; Multiplos blocos, mandar ACMD23 com total de blocos
1583   4D76 CD C5 4C    	call	SD_SEND_CMD_NO_ARGS
1584   4D79 3E 57       	ld	a, ACMD23
1585   4D7B 01 00 00    	ld	bc, 0
1586   4D7E 51          	ld	d, c
1587   4D7F FD 5E 32    	ld	e, (iy+NUMBLOCOS)	; parametro = total de blocos a gravar
1588   4D82 CD CA 4C    	call	SD_SEND_CMD_GET_ERROR
1589   4D85 D1          	pop	de
1590   4D86 C1          	pop	bc
1591   4D87 DA DD 51    	jp	c,.erro		; erro no ACMD23
1592   4D8A 3E 59       	ld	a, CMD25	; comando CMD25 = write multiple blocks
1593   4D8C CD CA 4C    	call	SD_SEND_CMD_GET_ERROR
1594   4D8F DA DD 51    	jp	c,.erro		; erro
1595   4D92             .loop: 
1596   4D92 3E FC       	ld	a, $FC		; mandar $FC para indicar que os proximos dados sao
1597   4D94 32 00 40    	ld	(PORTSPI),a	; dados para gravacao
1598   4D97 11 00 40    	ld	de, PORTSPI
1599   4D9A ED A0       > ldi		
1599   4D9C ED A0       > ldi		
1599   4D9E ED A0       > ldi		
1599   4DA0 ED A0       > ldi		
1599   4DA2 ED A0       > ldi		
1599   4DA4 ED A0       > ldi		
1599   4DA6 ED A0       > ldi		
1599   4DA8 ED A0       > ldi		
1599   4DAA ED A0       > ldi		
1599   4DAC ED A0       > ldi		
1599   4DAE ED A0       > ldi		
1599   4DB0 ED A0       > ldi		
1599   4DB2 ED A0       > ldi		
1599   4DB4 ED A0       > ldi		
1599   4DB6 ED A0       > ldi		
1599   4DB8 ED A0       > ldi		
1599   4DBA ED A0       > ldi		
1599   4DBC ED A0       > ldi		
1599   4DBE ED A0       > ldi		
1599   4DC0 ED A0       > ldi		
1599   4DC2 ED A0       > ldi		
1599   4DC4 ED A0       > ldi		
1599   4DC6 ED A0       > ldi		
1599   4DC8 ED A0       > ldi		
1599   4DCA ED A0       > ldi		
1599   4DCC ED A0       > ldi		
1599   4DCE ED A0       > ldi		
1599   4DD0 ED A0       > ldi		
1599   4DD2 ED A0       > ldi		
1599   4DD4 ED A0       > ldi		
1599   4DD6 ED A0       > ldi		
1599   4DD8 ED A0       > ldi		
1599   4DDA ED A0       > ldi		
1599   4DDC ED A0       > ldi		
1599   4DDE ED A0       > ldi		
1599   4DE0 ED A0       > ldi		
1599   4DE2 ED A0       > ldi		
1599   4DE4 ED A0       > ldi		
1599   4DE6 ED A0       > ldi		
1599   4DE8 ED A0       > ldi		
1599   4DEA ED A0       > ldi		
1599   4DEC ED A0       > ldi		
1599   4DEE ED A0       > ldi		
1599   4DF0 ED A0       > ldi		
1599   4DF2 ED A0       > ldi		
1599   4DF4 ED A0       > ldi		
1599   4DF6 ED A0       > ldi		
1599   4DF8 ED A0       > ldi		
1599   4DFA ED A0       > ldi		
1599   4DFC ED A0       > ldi		
1599   4DFE ED A0       > ldi		
1599   4E00 ED A0       > ldi		
1599   4E02 ED A0       > ldi		
1599   4E04 ED A0       > ldi		
1599   4E06 ED A0       > ldi		
1599   4E08 ED A0       > ldi		
1599   4E0A ED A0       > ldi		
1599   4E0C ED A0       > ldi		
1599   4E0E ED A0       > ldi		
1599   4E10 ED A0       > ldi		
1599   4E12 ED A0       > ldi		
1599   4E14 ED A0       > ldi		
1599   4E16 ED A0       > ldi		
1599   4E18 ED A0       > ldi		
1599   4E1A ED A0       > ldi		
1599   4E1C ED A0       > ldi		
1599   4E1E ED A0       > ldi		
1599   4E20 ED A0       > ldi		
1599   4E22 ED A0       > ldi		
1599   4E24 ED A0       > ldi		
1599   4E26 ED A0       > ldi		
1599   4E28 ED A0       > ldi		
1599   4E2A ED A0       > ldi		
1599   4E2C ED A0       > ldi		
1599   4E2E ED A0       > ldi		
1599   4E30 ED A0       > ldi		
1599   4E32 ED A0       > ldi		
1599   4E34 ED A0       > ldi		
1599   4E36 ED A0       > ldi		
1599   4E38 ED A0       > ldi		
1599   4E3A ED A0       > ldi		
1599   4E3C ED A0       > ldi		
1599   4E3E ED A0       > ldi		
1599   4E40 ED A0       > ldi		
1599   4E42 ED A0       > ldi		
1599   4E44 ED A0       > ldi		
1599   4E46 ED A0       > ldi		
1599   4E48 ED A0       > ldi		
1599   4E4A ED A0       > ldi		
1599   4E4C ED A0       > ldi		
1599   4E4E ED A0       > ldi		
1599   4E50 ED A0       > ldi		
1599   4E52 ED A0       > ldi		
1599   4E54 ED A0       > ldi		
1599   4E56 ED A0       > ldi		
1599   4E58 ED A0       > ldi		
1599   4E5A ED A0       > ldi		
1599   4E5C ED A0       > ldi		
1599   4E5E ED A0       > ldi		
1599   4E60 ED A0       > ldi		
1599   4E62 ED A0       > ldi		
1599   4E64 ED A0       > ldi		
1599   4E66 ED A0       > ldi		
1599   4E68 ED A0       > ldi		
1599   4E6A ED A0       > ldi		
1599   4E6C ED A0       > ldi		
1599   4E6E ED A0       > ldi		
1599   4E70 ED A0       > ldi		
1599   4E72 ED A0       > ldi		
1599   4E74 ED A0       > ldi		
1599   4E76 ED A0       > ldi		
1599   4E78 ED A0       > ldi		
1599   4E7A ED A0       > ldi		
1599   4E7C ED A0       > ldi		
1599   4E7E ED A0       > ldi		
1599   4E80 ED A0       > ldi		
1599   4E82 ED A0       > ldi		
1599   4E84 ED A0       > ldi		
1599   4E86 ED A0       > ldi		
1599   4E88 ED A0       > ldi		
1599   4E8A ED A0       > ldi		
1599   4E8C ED A0       > ldi		
1599   4E8E ED A0       > ldi		
1599   4E90 ED A0       > ldi		
1599   4E92 ED A0       > ldi		
1599   4E94 ED A0       > ldi		
1599   4E96 ED A0       > ldi		
1599   4E98 ED A0       > ldi		
1599   4E9A ED A0       > ldi		
1599   4E9C ED A0       > ldi		
1599   4E9E ED A0       > ldi		
1599   4EA0 ED A0       > ldi		
1599   4EA2 ED A0       > ldi		
1599   4EA4 ED A0       > ldi		
1599   4EA6 ED A0       > ldi		
1599   4EA8 ED A0       > ldi		
1599   4EAA ED A0       > ldi		
1599   4EAC ED A0       > ldi		
1599   4EAE ED A0       > ldi		
1599   4EB0 ED A0       > ldi		
1599   4EB2 ED A0       > ldi		
1599   4EB4 ED A0       > ldi		
1599   4EB6 ED A0       > ldi		
1599   4EB8 ED A0       > ldi		
1599   4EBA ED A0       > ldi		
1599   4EBC ED A0       > ldi		
1599   4EBE ED A0       > ldi		
1599   4EC0 ED A0       > ldi		
1599   4EC2 ED A0       > ldi		
1599   4EC4 ED A0       > ldi		
1599   4EC6 ED A0       > ldi		
1599   4EC8 ED A0       > ldi		
1599   4ECA ED A0       > ldi		
1599   4ECC ED A0       > ldi		
1599   4ECE ED A0       > ldi		
1599   4ED0 ED A0       > ldi		
1599   4ED2 ED A0       > ldi		
1599   4ED4 ED A0       > ldi		
1599   4ED6 ED A0       > ldi		
1599   4ED8 ED A0       > ldi		
1599   4EDA ED A0       > ldi		
1599   4EDC ED A0       > ldi		
1599   4EDE ED A0       > ldi		
1599   4EE0 ED A0       > ldi		
1599   4EE2 ED A0       > ldi		
1599   4EE4 ED A0       > ldi		
1599   4EE6 ED A0       > ldi		
1599   4EE8 ED A0       > ldi		
1599   4EEA ED A0       > ldi		
1599   4EEC ED A0       > ldi		
1599   4EEE ED A0       > ldi		
1599   4EF0 ED A0       > ldi		
1599   4EF2 ED A0       > ldi		
1599   4EF4 ED A0       > ldi		
1599   4EF6 ED A0       > ldi		
1599   4EF8 ED A0       > ldi		
1599   4EFA ED A0       > ldi		
1599   4EFC ED A0       > ldi		
1599   4EFE ED A0       > ldi		
1599   4F00 ED A0       > ldi		
1599   4F02 ED A0       > ldi		
1599   4F04 ED A0       > ldi		
1599   4F06 ED A0       > ldi		
1599   4F08 ED A0       > ldi		
1599   4F0A ED A0       > ldi		
1599   4F0C ED A0       > ldi		
1599   4F0E ED A0       > ldi		
1599   4F10 ED A0       > ldi		
1599   4F12 ED A0       > ldi		
1599   4F14 ED A0       > ldi		
1599   4F16 ED A0       > ldi		
1599   4F18 ED A0       > ldi		
1599   4F1A ED A0       > ldi		
1599   4F1C ED A0       > ldi		
1599   4F1E ED A0       > ldi		
1599   4F20 ED A0       > ldi		
1599   4F22 ED A0       > ldi		
1599   4F24 ED A0       > ldi		
1599   4F26 ED A0       > ldi		
1599   4F28 ED A0       > ldi		
1599   4F2A ED A0       > ldi		
1599   4F2C ED A0       > ldi		
1599   4F2E ED A0       > ldi		
1599   4F30 ED A0       > ldi		
1599   4F32 ED A0       > ldi		
1599   4F34 ED A0       > ldi		
1599   4F36 ED A0       > ldi		
1599   4F38 ED A0       > ldi		
1599   4F3A ED A0       > ldi		
1599   4F3C ED A0       > ldi		
1599   4F3E ED A0       > ldi		
1599   4F40 ED A0       > ldi		
1599   4F42 ED A0       > ldi		
1599   4F44 ED A0       > ldi		
1599   4F46 ED A0       > ldi		
1599   4F48 ED A0       > ldi		
1599   4F4A ED A0       > ldi		
1599   4F4C ED A0       > ldi		
1599   4F4E ED A0       > ldi		
1599   4F50 ED A0       > ldi		
1599   4F52 ED A0       > ldi		
1599   4F54 ED A0       > ldi		
1599   4F56 ED A0       > ldi		
1599   4F58 ED A0       > ldi		
1599   4F5A ED A0       > ldi		
1599   4F5C ED A0       > ldi		
1599   4F5E ED A0       > ldi		
1599   4F60 ED A0       > ldi		
1599   4F62 ED A0       > ldi		
1599   4F64 ED A0       > ldi		
1599   4F66 ED A0       > ldi		
1599   4F68 ED A0       > ldi		
1599   4F6A ED A0       > ldi		
1599   4F6C ED A0       > ldi		
1599   4F6E ED A0       > ldi		
1599   4F70 ED A0       > ldi		
1599   4F72 ED A0       > ldi		
1599   4F74 ED A0       > ldi		
1599   4F76 ED A0       > ldi		
1599   4F78 ED A0       > ldi		
1599   4F7A ED A0       > ldi		
1599   4F7C ED A0       > ldi		
1599   4F7E ED A0       > ldi		
1599   4F80 ED A0       > ldi		
1599   4F82 ED A0       > ldi		
1599   4F84 ED A0       > ldi		
1599   4F86 ED A0       > ldi		
1599   4F88 ED A0       > ldi		
1599   4F8A ED A0       > ldi		
1599   4F8C ED A0       > ldi		
1599   4F8E ED A0       > ldi		
1599   4F90 ED A0       > ldi		
1599   4F92 ED A0       > ldi		
1599   4F94 ED A0       > ldi		
1599   4F96 ED A0       > ldi		
1599   4F98 ED A0       > ldi		
1599   4F9A ED A0       > ldi		
1599   4F9C ED A0       > ldi		
1599   4F9E ED A0       > ldi		
1599   4FA0 ED A0       > ldi		
1599   4FA2 ED A0       > ldi		
1599   4FA4 ED A0       > ldi		
1599   4FA6 ED A0       > ldi		
1599   4FA8 ED A0       > ldi		
1599   4FAA ED A0       > ldi		
1599   4FAC ED A0       > ldi		
1599   4FAE ED A0       > ldi		
1599   4FB0 ED A0       > ldi		
1599   4FB2 ED A0       > ldi		
1599   4FB4 ED A0       > ldi		
1599   4FB6 ED A0       > ldi		
1599   4FB8 ED A0       > ldi		
1599   4FBA ED A0       > ldi		
1599   4FBC ED A0       > ldi		
1599   4FBE ED A0       > ldi		
1599   4FC0 ED A0       > ldi		
1599   4FC2 ED A0       > ldi		
1599   4FC4 ED A0       > ldi		
1599   4FC6 ED A0       > ldi		
1599   4FC8 ED A0       > ldi		
1599   4FCA ED A0       > ldi		
1599   4FCC ED A0       > ldi		
1599   4FCE ED A0       > ldi		
1599   4FD0 ED A0       > ldi		
1599   4FD2 ED A0       > ldi		
1599   4FD4 ED A0       > ldi		
1599   4FD6 ED A0       > ldi		
1599   4FD8 ED A0       > ldi		
1599   4FDA ED A0       > ldi		
1599   4FDC ED A0       > ldi		
1599   4FDE ED A0       > ldi		
1599   4FE0 ED A0       > ldi		
1599   4FE2 ED A0       > ldi		
1599   4FE4 ED A0       > ldi		
1599   4FE6 ED A0       > ldi		
1599   4FE8 ED A0       > ldi		
1599   4FEA ED A0       > ldi		
1599   4FEC ED A0       > ldi		
1599   4FEE ED A0       > ldi		
1599   4FF0 ED A0       > ldi		
1599   4FF2 ED A0       > ldi		
1599   4FF4 ED A0       > ldi		
1599   4FF6 ED A0       > ldi		
1599   4FF8 ED A0       > ldi		
1599   4FFA ED A0       > ldi		
1599   4FFC ED A0       > ldi		
1599   4FFE ED A0       > ldi		
1599   5000 ED A0       > ldi		
1599   5002 ED A0       > ldi		
1599   5004 ED A0       > ldi		
1599   5006 ED A0       > ldi		
1599   5008 ED A0       > ldi		
1599   500A ED A0       > ldi		
1599   500C ED A0       > ldi		
1599   500E ED A0       > ldi		
1599   5010 ED A0       > ldi		
1599   5012 ED A0       > ldi		
1599   5014 ED A0       > ldi		
1599   5016 ED A0       > ldi		
1599   5018 ED A0       > ldi		
1599   501A ED A0       > ldi		
1599   501C ED A0       > ldi		
1599   501E ED A0       > ldi		
1599   5020 ED A0       > ldi		
1599   5022 ED A0       > ldi		
1599   5024 ED A0       > ldi		
1599   5026 ED A0       > ldi		
1599   5028 ED A0       > ldi		
1599   502A ED A0       > ldi		
1599   502C ED A0       > ldi		
1599   502E ED A0       > ldi		
1599   5030 ED A0       > ldi		
1599   5032 ED A0       > ldi		
1599   5034 ED A0       > ldi		
1599   5036 ED A0       > ldi		
1599   5038 ED A0       > ldi		
1599   503A ED A0       > ldi		
1599   503C ED A0       > ldi		
1599   503E ED A0       > ldi		
1599   5040 ED A0       > ldi		
1599   5042 ED A0       > ldi		
1599   5044 ED A0       > ldi		
1599   5046 ED A0       > ldi		
1599   5048 ED A0       > ldi		
1599   504A ED A0       > ldi		
1599   504C ED A0       > ldi		
1599   504E ED A0       > ldi		
1599   5050 ED A0       > ldi		
1599   5052 ED A0       > ldi		
1599   5054 ED A0       > ldi		
1599   5056 ED A0       > ldi		
1599   5058 ED A0       > ldi		
1599   505A ED A0       > ldi		
1599   505C ED A0       > ldi		
1599   505E ED A0       > ldi		
1599   5060 ED A0       > ldi		
1599   5062 ED A0       > ldi		
1599   5064 ED A0       > ldi		
1599   5066 ED A0       > ldi		
1599   5068 ED A0       > ldi		
1599   506A ED A0       > ldi		
1599   506C ED A0       > ldi		
1599   506E ED A0       > ldi		
1599   5070 ED A0       > ldi		
1599   5072 ED A0       > ldi		
1599   5074 ED A0       > ldi		
1599   5076 ED A0       > ldi		
1599   5078 ED A0       > ldi		
1599   507A ED A0       > ldi		
1599   507C ED A0       > ldi		
1599   507E ED A0       > ldi		
1599   5080 ED A0       > ldi		
1599   5082 ED A0       > ldi		
1599   5084 ED A0       > ldi		
1599   5086 ED A0       > ldi		
1599   5088 ED A0       > ldi		
1599   508A ED A0       > ldi		
1599   508C ED A0       > ldi		
1599   508E ED A0       > ldi		
1599   5090 ED A0       > ldi		
1599   5092 ED A0       > ldi		
1599   5094 ED A0       > ldi		
1599   5096 ED A0       > ldi		
1599   5098 ED A0       > ldi		
1599   509A ED A0       > ldi		
1599   509C ED A0       > ldi		
1599   509E ED A0       > ldi		
1599   50A0 ED A0       > ldi		
1599   50A2 ED A0       > ldi		
1599   50A4 ED A0       > ldi		
1599   50A6 ED A0       > ldi		
1599   50A8 ED A0       > ldi		
1599   50AA ED A0       > ldi		
1599   50AC ED A0       > ldi		
1599   50AE ED A0       > ldi		
1599   50B0 ED A0       > ldi		
1599   50B2 ED A0       > ldi		
1599   50B4 ED A0       > ldi		
1599   50B6 ED A0       > ldi		
1599   50B8 ED A0       > ldi		
1599   50BA ED A0       > ldi		
1599   50BC ED A0       > ldi		
1599   50BE ED A0       > ldi		
1599   50C0 ED A0       > ldi		
1599   50C2 ED A0       > ldi		
1599   50C4 ED A0       > ldi		
1599   50C6 ED A0       > ldi		
1599   50C8 ED A0       > ldi		
1599   50CA ED A0       > ldi		
1599   50CC ED A0       > ldi		
1599   50CE ED A0       > ldi		
1599   50D0 ED A0       > ldi		
1599   50D2 ED A0       > ldi		
1599   50D4 ED A0       > ldi		
1599   50D6 ED A0       > ldi		
1599   50D8 ED A0       > ldi		
1599   50DA ED A0       > ldi		
1599   50DC ED A0       > ldi		
1599   50DE ED A0       > ldi		
1599   50E0 ED A0       > ldi		
1599   50E2 ED A0       > ldi		
1599   50E4 ED A0       > ldi		
1599   50E6 ED A0       > ldi		
1599   50E8 ED A0       > ldi		
1599   50EA ED A0       > ldi		
1599   50EC ED A0       > ldi		
1599   50EE ED A0       > ldi		
1599   50F0 ED A0       > ldi		
1599   50F2 ED A0       > ldi		
1599   50F4 ED A0       > ldi		
1599   50F6 ED A0       > ldi		
1599   50F8 ED A0       > ldi		
1599   50FA ED A0       > ldi		
1599   50FC ED A0       > ldi		
1599   50FE ED A0       > ldi		
1599   5100 ED A0       > ldi		
1599   5102 ED A0       > ldi		
1599   5104 ED A0       > ldi		
1599   5106 ED A0       > ldi		
1599   5108 ED A0       > ldi		
1599   510A ED A0       > ldi		
1599   510C ED A0       > ldi		
1599   510E ED A0       > ldi		
1599   5110 ED A0       > ldi		
1599   5112 ED A0       > ldi		
1599   5114 ED A0       > ldi		
1599   5116 ED A0       > ldi		
1599   5118 ED A0       > ldi		
1599   511A ED A0       > ldi		
1599   511C ED A0       > ldi		
1599   511E ED A0       > ldi		
1599   5120 ED A0       > ldi		
1599   5122 ED A0       > ldi		
1599   5124 ED A0       > ldi		
1599   5126 ED A0       > ldi		
1599   5128 ED A0       > ldi		
1599   512A ED A0       > ldi		
1599   512C ED A0       > ldi		
1599   512E ED A0       > ldi		
1599   5130 ED A0       > ldi		
1599   5132 ED A0       > ldi		
1599   5134 ED A0       > ldi		
1599   5136 ED A0       > ldi		
1599   5138 ED A0       > ldi		
1599   513A ED A0       > ldi		
1599   513C ED A0       > ldi		
1599   513E ED A0       > ldi		
1599   5140 ED A0       > ldi		
1599   5142 ED A0       > ldi		
1599   5144 ED A0       > ldi		
1599   5146 ED A0       > ldi		
1599   5148 ED A0       > ldi		
1599   514A ED A0       > ldi		
1599   514C ED A0       > ldi		
1599   514E ED A0       > ldi		
1599   5150 ED A0       > ldi		
1599   5152 ED A0       > ldi		
1599   5154 ED A0       > ldi		
1599   5156 ED A0       > ldi		
1599   5158 ED A0       > ldi		
1599   515A ED A0       > ldi		
1599   515C ED A0       > ldi		
1599   515E ED A0       > ldi		
1599   5160 ED A0       > ldi		
1599   5162 ED A0       > ldi		
1599   5164 ED A0       > ldi		
1599   5166 ED A0       > ldi		
1599   5168 ED A0       > ldi		
1599   516A ED A0       > ldi		
1599   516C ED A0       > ldi		
1599   516E ED A0       > ldi		
1599   5170 ED A0       > ldi		
1599   5172 ED A0       > ldi		
1599   5174 ED A0       > ldi		
1599   5176 ED A0       > ldi		
1599   5178 ED A0       > ldi		
1599   517A ED A0       > ldi		
1599   517C ED A0       > ldi		
1599   517E ED A0       > ldi		
1599   5180 ED A0       > ldi		
1599   5182 ED A0       > ldi		
1599   5184 ED A0       > ldi		
1599   5186 ED A0       > ldi		
1599   5188 ED A0       > ldi		
1599   518A ED A0       > ldi		
1599   518C ED A0       > ldi		
1599   518E ED A0       > ldi		
1599   5190 ED A0       > ldi		
1599   5192 ED A0       > ldi		
1599   5194 ED A0       > ldi		
1599   5196 ED A0       > ldi		
1599   5198 ED A0       > ldi		
1600   519A 3E FF       	ld	a, $FF		; envia dummy CRC
1601   519C 32 00 40    	ld	(PORTSPI),a
1602   519F 00          	nop
1603   51A0 32 00 40    	ld	(PORTSPI),a
1604   51A3 CD 36 4D    	call	WAIT_RESP_NO_FF	; esperar cartao
1605   51A6 E6 1F       	and	$1F		; testa bits erro
1606   51A8 FE 05       	cp	5
1607   51AA 20 31       	jr	nz,.erro	; resposta errada, informar erro
1608   51AC CD 45 4D    	call	WAIT_RESP_NO_00	; esperar cartao
1609   51AF 38 2C       	jr	c,.erro
1610   51B1 FD 7E 32    	ld	a, (iy+NUMBLOCOS)	; testar se tem mais blocos para gravar
1611   51B4 3D          	dec	a
1612   51B5 FD 77 32    	ld	(iy+NUMBLOCOS), a
1613   51B8 C2 92 4D    	jp	nz,.loop
1614   51BB 3A 00 40    	ld	a, (PORTSPI)	; acabou os blocos, fazer 2 dummy reads
1615   51BE 00          	nop
1616   51BF 3A 00 40    	ld	a, (PORTSPI)
1617   51C2 3E FD       	ld	a, $FD		; enviar $FD para informar ao cartao que acabou os dados
1618   51C4 32 00 40    	ld	(PORTSPI),a
1619   51C7 00          	nop
1620   51C8 00          	nop
1621   51C9 3A 00 40    	ld	a, (PORTSPI)	; dummy reads
1622   51CC 00          	nop
1623   51CD 3A 00 40    	ld	a, (PORTSPI)
1624   51D0 CD 45 4D    	call	WAIT_RESP_NO_00	; esperar cartao
1625   51D3 C3 02 56    	jp	.fim		; CMD25 concluido, sair informando nenhum erro
1626   51D6             
1627   51D6             .umBloco: 
1628   51D6 3E 58       	ld	a, CMD24	; gravar somente um bloco com comando CMD24 = Write Single Block
1629   51D8 CD CA 4C    	call	SD_SEND_CMD_GET_ERROR
1630   51DB 30 04       	jr	nc,.ok
1631   51DD             .erro: 
1632   51DD 37          	scf			; informar erro
1633   51DE C3 03 56    	jp	terminaLeituraEscritaBloco
1634   51E1             .ok: 
1635   51E1 3E FE       	ld	a, $FE		; mandar $FE para indicar que vamos mandar dados para gravacao
1636   51E3 32 00 40    	ld	(PORTSPI),a
1637   51E6 11 00 40    	ld	de, PORTSPI
1638   51E9 ED A0       > ldi
1638   51EB ED A0       > ldi
1638   51ED ED A0       > ldi
1638   51EF ED A0       > ldi
1638   51F1 ED A0       > ldi
1638   51F3 ED A0       > ldi
1638   51F5 ED A0       > ldi
1638   51F7 ED A0       > ldi
1638   51F9 ED A0       > ldi
1638   51FB ED A0       > ldi
1638   51FD ED A0       > ldi
1638   51FF ED A0       > ldi
1638   5201 ED A0       > ldi
1638   5203 ED A0       > ldi
1638   5205 ED A0       > ldi
1638   5207 ED A0       > ldi
1638   5209 ED A0       > ldi
1638   520B ED A0       > ldi
1638   520D ED A0       > ldi
1638   520F ED A0       > ldi
1638   5211 ED A0       > ldi
1638   5213 ED A0       > ldi
1638   5215 ED A0       > ldi
1638   5217 ED A0       > ldi
1638   5219 ED A0       > ldi
1638   521B ED A0       > ldi
1638   521D ED A0       > ldi
1638   521F ED A0       > ldi
1638   5221 ED A0       > ldi
1638   5223 ED A0       > ldi
1638   5225 ED A0       > ldi
1638   5227 ED A0       > ldi
1638   5229 ED A0       > ldi
1638   522B ED A0       > ldi
1638   522D ED A0       > ldi
1638   522F ED A0       > ldi
1638   5231 ED A0       > ldi
1638   5233 ED A0       > ldi
1638   5235 ED A0       > ldi
1638   5237 ED A0       > ldi
1638   5239 ED A0       > ldi
1638   523B ED A0       > ldi
1638   523D ED A0       > ldi
1638   523F ED A0       > ldi
1638   5241 ED A0       > ldi
1638   5243 ED A0       > ldi
1638   5245 ED A0       > ldi
1638   5247 ED A0       > ldi
1638   5249 ED A0       > ldi
1638   524B ED A0       > ldi
1638   524D ED A0       > ldi
1638   524F ED A0       > ldi
1638   5251 ED A0       > ldi
1638   5253 ED A0       > ldi
1638   5255 ED A0       > ldi
1638   5257 ED A0       > ldi
1638   5259 ED A0       > ldi
1638   525B ED A0       > ldi
1638   525D ED A0       > ldi
1638   525F ED A0       > ldi
1638   5261 ED A0       > ldi
1638   5263 ED A0       > ldi
1638   5265 ED A0       > ldi
1638   5267 ED A0       > ldi
1638   5269 ED A0       > ldi
1638   526B ED A0       > ldi
1638   526D ED A0       > ldi
1638   526F ED A0       > ldi
1638   5271 ED A0       > ldi
1638   5273 ED A0       > ldi
1638   5275 ED A0       > ldi
1638   5277 ED A0       > ldi
1638   5279 ED A0       > ldi
1638   527B ED A0       > ldi
1638   527D ED A0       > ldi
1638   527F ED A0       > ldi
1638   5281 ED A0       > ldi
1638   5283 ED A0       > ldi
1638   5285 ED A0       > ldi
1638   5287 ED A0       > ldi
1638   5289 ED A0       > ldi
1638   528B ED A0       > ldi
1638   528D ED A0       > ldi
1638   528F ED A0       > ldi
1638   5291 ED A0       > ldi
1638   5293 ED A0       > ldi
1638   5295 ED A0       > ldi
1638   5297 ED A0       > ldi
1638   5299 ED A0       > ldi
1638   529B ED A0       > ldi
1638   529D ED A0       > ldi
1638   529F ED A0       > ldi
1638   52A1 ED A0       > ldi
1638   52A3 ED A0       > ldi
1638   52A5 ED A0       > ldi
1638   52A7 ED A0       > ldi
1638   52A9 ED A0       > ldi
1638   52AB ED A0       > ldi
1638   52AD ED A0       > ldi
1638   52AF ED A0       > ldi
1638   52B1 ED A0       > ldi
1638   52B3 ED A0       > ldi
1638   52B5 ED A0       > ldi
1638   52B7 ED A0       > ldi
1638   52B9 ED A0       > ldi
1638   52BB ED A0       > ldi
1638   52BD ED A0       > ldi
1638   52BF ED A0       > ldi
1638   52C1 ED A0       > ldi
1638   52C3 ED A0       > ldi
1638   52C5 ED A0       > ldi
1638   52C7 ED A0       > ldi
1638   52C9 ED A0       > ldi
1638   52CB ED A0       > ldi
1638   52CD ED A0       > ldi
1638   52CF ED A0       > ldi
1638   52D1 ED A0       > ldi
1638   52D3 ED A0       > ldi
1638   52D5 ED A0       > ldi
1638   52D7 ED A0       > ldi
1638   52D9 ED A0       > ldi
1638   52DB ED A0       > ldi
1638   52DD ED A0       > ldi
1638   52DF ED A0       > ldi
1638   52E1 ED A0       > ldi
1638   52E3 ED A0       > ldi
1638   52E5 ED A0       > ldi
1638   52E7 ED A0       > ldi
1638   52E9 ED A0       > ldi
1638   52EB ED A0       > ldi
1638   52ED ED A0       > ldi
1638   52EF ED A0       > ldi
1638   52F1 ED A0       > ldi
1638   52F3 ED A0       > ldi
1638   52F5 ED A0       > ldi
1638   52F7 ED A0       > ldi
1638   52F9 ED A0       > ldi
1638   52FB ED A0       > ldi
1638   52FD ED A0       > ldi
1638   52FF ED A0       > ldi
1638   5301 ED A0       > ldi
1638   5303 ED A0       > ldi
1638   5305 ED A0       > ldi
1638   5307 ED A0       > ldi
1638   5309 ED A0       > ldi
1638   530B ED A0       > ldi
1638   530D ED A0       > ldi
1638   530F ED A0       > ldi
1638   5311 ED A0       > ldi
1638   5313 ED A0       > ldi
1638   5315 ED A0       > ldi
1638   5317 ED A0       > ldi
1638   5319 ED A0       > ldi
1638   531B ED A0       > ldi
1638   531D ED A0       > ldi
1638   531F ED A0       > ldi
1638   5321 ED A0       > ldi
1638   5323 ED A0       > ldi
1638   5325 ED A0       > ldi
1638   5327 ED A0       > ldi
1638   5329 ED A0       > ldi
1638   532B ED A0       > ldi
1638   532D ED A0       > ldi
1638   532F ED A0       > ldi
1638   5331 ED A0       > ldi
1638   5333 ED A0       > ldi
1638   5335 ED A0       > ldi
1638   5337 ED A0       > ldi
1638   5339 ED A0       > ldi
1638   533B ED A0       > ldi
1638   533D ED A0       > ldi
1638   533F ED A0       > ldi
1638   5341 ED A0       > ldi
1638   5343 ED A0       > ldi
1638   5345 ED A0       > ldi
1638   5347 ED A0       > ldi
1638   5349 ED A0       > ldi
1638   534B ED A0       > ldi
1638   534D ED A0       > ldi
1638   534F ED A0       > ldi
1638   5351 ED A0       > ldi
1638   5353 ED A0       > ldi
1638   5355 ED A0       > ldi
1638   5357 ED A0       > ldi
1638   5359 ED A0       > ldi
1638   535B ED A0       > ldi
1638   535D ED A0       > ldi
1638   535F ED A0       > ldi
1638   5361 ED A0       > ldi
1638   5363 ED A0       > ldi
1638   5365 ED A0       > ldi
1638   5367 ED A0       > ldi
1638   5369 ED A0       > ldi
1638   536B ED A0       > ldi
1638   536D ED A0       > ldi
1638   536F ED A0       > ldi
1638   5371 ED A0       > ldi
1638   5373 ED A0       > ldi
1638   5375 ED A0       > ldi
1638   5377 ED A0       > ldi
1638   5379 ED A0       > ldi
1638   537B ED A0       > ldi
1638   537D ED A0       > ldi
1638   537F ED A0       > ldi
1638   5381 ED A0       > ldi
1638   5383 ED A0       > ldi
1638   5385 ED A0       > ldi
1638   5387 ED A0       > ldi
1638   5389 ED A0       > ldi
1638   538B ED A0       > ldi
1638   538D ED A0       > ldi
1638   538F ED A0       > ldi
1638   5391 ED A0       > ldi
1638   5393 ED A0       > ldi
1638   5395 ED A0       > ldi
1638   5397 ED A0       > ldi
1638   5399 ED A0       > ldi
1638   539B ED A0       > ldi
1638   539D ED A0       > ldi
1638   539F ED A0       > ldi
1638   53A1 ED A0       > ldi
1638   53A3 ED A0       > ldi
1638   53A5 ED A0       > ldi
1638   53A7 ED A0       > ldi
1638   53A9 ED A0       > ldi
1638   53AB ED A0       > ldi
1638   53AD ED A0       > ldi
1638   53AF ED A0       > ldi
1638   53B1 ED A0       > ldi
1638   53B3 ED A0       > ldi
1638   53B5 ED A0       > ldi
1638   53B7 ED A0       > ldi
1638   53B9 ED A0       > ldi
1638   53BB ED A0       > ldi
1638   53BD ED A0       > ldi
1638   53BF ED A0       > ldi
1638   53C1 ED A0       > ldi
1638   53C3 ED A0       > ldi
1638   53C5 ED A0       > ldi
1638   53C7 ED A0       > ldi
1638   53C9 ED A0       > ldi
1638   53CB ED A0       > ldi
1638   53CD ED A0       > ldi
1638   53CF ED A0       > ldi
1638   53D1 ED A0       > ldi
1638   53D3 ED A0       > ldi
1638   53D5 ED A0       > ldi
1638   53D7 ED A0       > ldi
1638   53D9 ED A0       > ldi
1638   53DB ED A0       > ldi
1638   53DD ED A0       > ldi
1638   53DF ED A0       > ldi
1638   53E1 ED A0       > ldi
1638   53E3 ED A0       > ldi
1638   53E5 ED A0       > ldi
1638   53E7 ED A0       > ldi
1638   53E9 ED A0       > ldi
1638   53EB ED A0       > ldi
1638   53ED ED A0       > ldi
1638   53EF ED A0       > ldi
1638   53F1 ED A0       > ldi
1638   53F3 ED A0       > ldi
1638   53F5 ED A0       > ldi
1638   53F7 ED A0       > ldi
1638   53F9 ED A0       > ldi
1638   53FB ED A0       > ldi
1638   53FD ED A0       > ldi
1638   53FF ED A0       > ldi
1638   5401 ED A0       > ldi
1638   5403 ED A0       > ldi
1638   5405 ED A0       > ldi
1638   5407 ED A0       > ldi
1638   5409 ED A0       > ldi
1638   540B ED A0       > ldi
1638   540D ED A0       > ldi
1638   540F ED A0       > ldi
1638   5411 ED A0       > ldi
1638   5413 ED A0       > ldi
1638   5415 ED A0       > ldi
1638   5417 ED A0       > ldi
1638   5419 ED A0       > ldi
1638   541B ED A0       > ldi
1638   541D ED A0       > ldi
1638   541F ED A0       > ldi
1638   5421 ED A0       > ldi
1638   5423 ED A0       > ldi
1638   5425 ED A0       > ldi
1638   5427 ED A0       > ldi
1638   5429 ED A0       > ldi
1638   542B ED A0       > ldi
1638   542D ED A0       > ldi
1638   542F ED A0       > ldi
1638   5431 ED A0       > ldi
1638   5433 ED A0       > ldi
1638   5435 ED A0       > ldi
1638   5437 ED A0       > ldi
1638   5439 ED A0       > ldi
1638   543B ED A0       > ldi
1638   543D ED A0       > ldi
1638   543F ED A0       > ldi
1638   5441 ED A0       > ldi
1638   5443 ED A0       > ldi
1638   5445 ED A0       > ldi
1638   5447 ED A0       > ldi
1638   5449 ED A0       > ldi
1638   544B ED A0       > ldi
1638   544D ED A0       > ldi
1638   544F ED A0       > ldi
1638   5451 ED A0       > ldi
1638   5453 ED A0       > ldi
1638   5455 ED A0       > ldi
1638   5457 ED A0       > ldi
1638   5459 ED A0       > ldi
1638   545B ED A0       > ldi
1638   545D ED A0       > ldi
1638   545F ED A0       > ldi
1638   5461 ED A0       > ldi
1638   5463 ED A0       > ldi
1638   5465 ED A0       > ldi
1638   5467 ED A0       > ldi
1638   5469 ED A0       > ldi
1638   546B ED A0       > ldi
1638   546D ED A0       > ldi
1638   546F ED A0       > ldi
1638   5471 ED A0       > ldi
1638   5473 ED A0       > ldi
1638   5475 ED A0       > ldi
1638   5477 ED A0       > ldi
1638   5479 ED A0       > ldi
1638   547B ED A0       > ldi
1638   547D ED A0       > ldi
1638   547F ED A0       > ldi
1638   5481 ED A0       > ldi
1638   5483 ED A0       > ldi
1638   5485 ED A0       > ldi
1638   5487 ED A0       > ldi
1638   5489 ED A0       > ldi
1638   548B ED A0       > ldi
1638   548D ED A0       > ldi
1638   548F ED A0       > ldi
1638   5491 ED A0       > ldi
1638   5493 ED A0       > ldi
1638   5495 ED A0       > ldi
1638   5497 ED A0       > ldi
1638   5499 ED A0       > ldi
1638   549B ED A0       > ldi
1638   549D ED A0       > ldi
1638   549F ED A0       > ldi
1638   54A1 ED A0       > ldi
1638   54A3 ED A0       > ldi
1638   54A5 ED A0       > ldi
1638   54A7 ED A0       > ldi
1638   54A9 ED A0       > ldi
1638   54AB ED A0       > ldi
1638   54AD ED A0       > ldi
1638   54AF ED A0       > ldi
1638   54B1 ED A0       > ldi
1638   54B3 ED A0       > ldi
1638   54B5 ED A0       > ldi
1638   54B7 ED A0       > ldi
1638   54B9 ED A0       > ldi
1638   54BB ED A0       > ldi
1638   54BD ED A0       > ldi
1638   54BF ED A0       > ldi
1638   54C1 ED A0       > ldi
1638   54C3 ED A0       > ldi
1638   54C5 ED A0       > ldi
1638   54C7 ED A0       > ldi
1638   54C9 ED A0       > ldi
1638   54CB ED A0       > ldi
1638   54CD ED A0       > ldi
1638   54CF ED A0       > ldi
1638   54D1 ED A0       > ldi
1638   54D3 ED A0       > ldi
1638   54D5 ED A0       > ldi
1638   54D7 ED A0       > ldi
1638   54D9 ED A0       > ldi
1638   54DB ED A0       > ldi
1638   54DD ED A0       > ldi
1638   54DF ED A0       > ldi
1638   54E1 ED A0       > ldi
1638   54E3 ED A0       > ldi
1638   54E5 ED A0       > ldi
1638   54E7 ED A0       > ldi
1638   54E9 ED A0       > ldi
1638   54EB ED A0       > ldi
1638   54ED ED A0       > ldi
1638   54EF ED A0       > ldi
1638   54F1 ED A0       > ldi
1638   54F3 ED A0       > ldi
1638   54F5 ED A0       > ldi
1638   54F7 ED A0       > ldi
1638   54F9 ED A0       > ldi
1638   54FB ED A0       > ldi
1638   54FD ED A0       > ldi
1638   54FF ED A0       > ldi
1638   5501 ED A0       > ldi
1638   5503 ED A0       > ldi
1638   5505 ED A0       > ldi
1638   5507 ED A0       > ldi
1638   5509 ED A0       > ldi
1638   550B ED A0       > ldi
1638   550D ED A0       > ldi
1638   550F ED A0       > ldi
1638   5511 ED A0       > ldi
1638   5513 ED A0       > ldi
1638   5515 ED A0       > ldi
1638   5517 ED A0       > ldi
1638   5519 ED A0       > ldi
1638   551B ED A0       > ldi
1638   551D ED A0       > ldi
1638   551F ED A0       > ldi
1638   5521 ED A0       > ldi
1638   5523 ED A0       > ldi
1638   5525 ED A0       > ldi
1638   5527 ED A0       > ldi
1638   5529 ED A0       > ldi
1638   552B ED A0       > ldi
1638   552D ED A0       > ldi
1638   552F ED A0       > ldi
1638   5531 ED A0       > ldi
1638   5533 ED A0       > ldi
1638   5535 ED A0       > ldi
1638   5537 ED A0       > ldi
1638   5539 ED A0       > ldi
1638   553B ED A0       > ldi
1638   553D ED A0       > ldi
1638   553F ED A0       > ldi
1638   5541 ED A0       > ldi
1638   5543 ED A0       > ldi
1638   5545 ED A0       > ldi
1638   5547 ED A0       > ldi
1638   5549 ED A0       > ldi
1638   554B ED A0       > ldi
1638   554D ED A0       > ldi
1638   554F ED A0       > ldi
1638   5551 ED A0       > ldi
1638   5553 ED A0       > ldi
1638   5555 ED A0       > ldi
1638   5557 ED A0       > ldi
1638   5559 ED A0       > ldi
1638   555B ED A0       > ldi
1638   555D ED A0       > ldi
1638   555F ED A0       > ldi
1638   5561 ED A0       > ldi
1638   5563 ED A0       > ldi
1638   5565 ED A0       > ldi
1638   5567 ED A0       > ldi
1638   5569 ED A0       > ldi
1638   556B ED A0       > ldi
1638   556D ED A0       > ldi
1638   556F ED A0       > ldi
1638   5571 ED A0       > ldi
1638   5573 ED A0       > ldi
1638   5575 ED A0       > ldi
1638   5577 ED A0       > ldi
1638   5579 ED A0       > ldi
1638   557B ED A0       > ldi
1638   557D ED A0       > ldi
1638   557F ED A0       > ldi
1638   5581 ED A0       > ldi
1638   5583 ED A0       > ldi
1638   5585 ED A0       > ldi
1638   5587 ED A0       > ldi
1638   5589 ED A0       > ldi
1638   558B ED A0       > ldi
1638   558D ED A0       > ldi
1638   558F ED A0       > ldi
1638   5591 ED A0       > ldi
1638   5593 ED A0       > ldi
1638   5595 ED A0       > ldi
1638   5597 ED A0       > ldi
1638   5599 ED A0       > ldi
1638   559B ED A0       > ldi
1638   559D ED A0       > ldi
1638   559F ED A0       > ldi
1638   55A1 ED A0       > ldi
1638   55A3 ED A0       > ldi
1638   55A5 ED A0       > ldi
1638   55A7 ED A0       > ldi
1638   55A9 ED A0       > ldi
1638   55AB ED A0       > ldi
1638   55AD ED A0       > ldi
1638   55AF ED A0       > ldi
1638   55B1 ED A0       > ldi
1638   55B3 ED A0       > ldi
1638   55B5 ED A0       > ldi
1638   55B7 ED A0       > ldi
1638   55B9 ED A0       > ldi
1638   55BB ED A0       > ldi
1638   55BD ED A0       > ldi
1638   55BF ED A0       > ldi
1638   55C1 ED A0       > ldi
1638   55C3 ED A0       > ldi
1638   55C5 ED A0       > ldi
1638   55C7 ED A0       > ldi
1638   55C9 ED A0       > ldi
1638   55CB ED A0       > ldi
1638   55CD ED A0       > ldi
1638   55CF ED A0       > ldi
1638   55D1 ED A0       > ldi
1638   55D3 ED A0       > ldi
1638   55D5 ED A0       > ldi
1638   55D7 ED A0       > ldi
1638   55D9 ED A0       > ldi
1638   55DB ED A0       > ldi
1638   55DD ED A0       > ldi
1638   55DF ED A0       > ldi
1638   55E1 ED A0       > ldi
1638   55E3 ED A0       > ldi
1638   55E5 ED A0       > ldi
1638   55E7 ED A0       > ldi
1639   55E9 3E FF       	ld	a, $FF		; envia dummy CRC
1640   55EB 32 00 40    	ld	(PORTSPI),a
1641   55EE 00          	nop
1642   55EF 32 00 40    	ld	(PORTSPI),a
1643   55F2 CD 36 4D    	call	WAIT_RESP_NO_FF	; esperar cartao
1644   55F5 E6 1F       	and	$1F		; testa bits erro
1645   55F7 FE 05       	cp	5
1646   55F9 C2 DD 51    	jp	nz,.erro	; resposta errada, informar erro
1647   55FC             .esp: 
1648   55FC CD 36 4D    	call	WAIT_RESP_NO_FF	; esperar cartao
1649   55FF B7          	or	a
1650   5600 28 FA       	jr	z,.esp
1651   5602             .fim: 
1652   5602 AF          	xor	a		; zera carry e informa nenhum erro
1653   5603             terminaLeituraEscritaBloco: 
1654   5603 F5          	push	af
1655   5604 CD AD 4C    	call	desabilitaSDs	; desabilitar todos os cartoes
1656   5607 F1          	pop	af
1657   5608 C9          	ret
1658   5609             
1659   5609             ; ------------------------------------------------
1660   5609             ; Ler um bloco de 512 bytes do cartao
1661   5609             ; HL aponta para o inicio dos dados
1662   5609             ; BC e DE contem o numero do bloco (BCDE = 32 bits)
1663   5609             ; Destroi AF, BC, DE, HL
1664   5609             ; ------------------------------------------------
1665   5609             LerBloco: 
1666   5609 DD 7E 0F    	ld	a, (ix+15)	; verificar se eh SDV1 ou SDV2
1667   560C B7          	or	a
1668   560D CC 68 5E    	call	z,blocoParaByte	; se for SDV1 coverter blocos para bytes
1669   5610 CD 54 4D    	call	setaSDAtual
1670   5613 FD 7E 32    	ld	a, (iy+NUMBLOCOS)	; testar se Nextor quer ler um ou mais blocos
1671   5616 3D          	dec	a
1672   5617 CA 47 5A    	jp	z,.umBloco	; somente um bloco, pular
1673   561A             
1674   561A             ; multiplos blocos
1675   561A 3E 52       	ld	a, CMD18	; ler multiplos blocos com CMD18 = Read Multiple Blocks
1676   561C CD CA 4C    	call	SD_SEND_CMD_GET_ERROR
1677   561F DA 4E 5A    	jp	c,.erro
1678   5622             .loop: 
1679   5622 CD 28 4D    	call	WAIT_RESP_FE
1680   5625 DA 4E 5A    	jp	c,.erro
1681   5628 11 00 40    	ld	de, PORTSPI
1682   562B EB          	ex	de,hl
1683   562C ED A0       > ldi
1683   562E ED A0       > ldi
1683   5630 ED A0       > ldi
1683   5632 ED A0       > ldi
1683   5634 ED A0       > ldi
1683   5636 ED A0       > ldi
1683   5638 ED A0       > ldi
1683   563A ED A0       > ldi
1683   563C ED A0       > ldi
1683   563E ED A0       > ldi
1683   5640 ED A0       > ldi
1683   5642 ED A0       > ldi
1683   5644 ED A0       > ldi
1683   5646 ED A0       > ldi
1683   5648 ED A0       > ldi
1683   564A ED A0       > ldi
1683   564C ED A0       > ldi
1683   564E ED A0       > ldi
1683   5650 ED A0       > ldi
1683   5652 ED A0       > ldi
1683   5654 ED A0       > ldi
1683   5656 ED A0       > ldi
1683   5658 ED A0       > ldi
1683   565A ED A0       > ldi
1683   565C ED A0       > ldi
1683   565E ED A0       > ldi
1683   5660 ED A0       > ldi
1683   5662 ED A0       > ldi
1683   5664 ED A0       > ldi
1683   5666 ED A0       > ldi
1683   5668 ED A0       > ldi
1683   566A ED A0       > ldi
1683   566C ED A0       > ldi
1683   566E ED A0       > ldi
1683   5670 ED A0       > ldi
1683   5672 ED A0       > ldi
1683   5674 ED A0       > ldi
1683   5676 ED A0       > ldi
1683   5678 ED A0       > ldi
1683   567A ED A0       > ldi
1683   567C ED A0       > ldi
1683   567E ED A0       > ldi
1683   5680 ED A0       > ldi
1683   5682 ED A0       > ldi
1683   5684 ED A0       > ldi
1683   5686 ED A0       > ldi
1683   5688 ED A0       > ldi
1683   568A ED A0       > ldi
1683   568C ED A0       > ldi
1683   568E ED A0       > ldi
1683   5690 ED A0       > ldi
1683   5692 ED A0       > ldi
1683   5694 ED A0       > ldi
1683   5696 ED A0       > ldi
1683   5698 ED A0       > ldi
1683   569A ED A0       > ldi
1683   569C ED A0       > ldi
1683   569E ED A0       > ldi
1683   56A0 ED A0       > ldi
1683   56A2 ED A0       > ldi
1683   56A4 ED A0       > ldi
1683   56A6 ED A0       > ldi
1683   56A8 ED A0       > ldi
1683   56AA ED A0       > ldi
1683   56AC ED A0       > ldi
1683   56AE ED A0       > ldi
1683   56B0 ED A0       > ldi
1683   56B2 ED A0       > ldi
1683   56B4 ED A0       > ldi
1683   56B6 ED A0       > ldi
1683   56B8 ED A0       > ldi
1683   56BA ED A0       > ldi
1683   56BC ED A0       > ldi
1683   56BE ED A0       > ldi
1683   56C0 ED A0       > ldi
1683   56C2 ED A0       > ldi
1683   56C4 ED A0       > ldi
1683   56C6 ED A0       > ldi
1683   56C8 ED A0       > ldi
1683   56CA ED A0       > ldi
1683   56CC ED A0       > ldi
1683   56CE ED A0       > ldi
1683   56D0 ED A0       > ldi
1683   56D2 ED A0       > ldi
1683   56D4 ED A0       > ldi
1683   56D6 ED A0       > ldi
1683   56D8 ED A0       > ldi
1683   56DA ED A0       > ldi
1683   56DC ED A0       > ldi
1683   56DE ED A0       > ldi
1683   56E0 ED A0       > ldi
1683   56E2 ED A0       > ldi
1683   56E4 ED A0       > ldi
1683   56E6 ED A0       > ldi
1683   56E8 ED A0       > ldi
1683   56EA ED A0       > ldi
1683   56EC ED A0       > ldi
1683   56EE ED A0       > ldi
1683   56F0 ED A0       > ldi
1683   56F2 ED A0       > ldi
1683   56F4 ED A0       > ldi
1683   56F6 ED A0       > ldi
1683   56F8 ED A0       > ldi
1683   56FA ED A0       > ldi
1683   56FC ED A0       > ldi
1683   56FE ED A0       > ldi
1683   5700 ED A0       > ldi
1683   5702 ED A0       > ldi
1683   5704 ED A0       > ldi
1683   5706 ED A0       > ldi
1683   5708 ED A0       > ldi
1683   570A ED A0       > ldi
1683   570C ED A0       > ldi
1683   570E ED A0       > ldi
1683   5710 ED A0       > ldi
1683   5712 ED A0       > ldi
1683   5714 ED A0       > ldi
1683   5716 ED A0       > ldi
1683   5718 ED A0       > ldi
1683   571A ED A0       > ldi
1683   571C ED A0       > ldi
1683   571E ED A0       > ldi
1683   5720 ED A0       > ldi
1683   5722 ED A0       > ldi
1683   5724 ED A0       > ldi
1683   5726 ED A0       > ldi
1683   5728 ED A0       > ldi
1683   572A ED A0       > ldi
1683   572C ED A0       > ldi
1683   572E ED A0       > ldi
1683   5730 ED A0       > ldi
1683   5732 ED A0       > ldi
1683   5734 ED A0       > ldi
1683   5736 ED A0       > ldi
1683   5738 ED A0       > ldi
1683   573A ED A0       > ldi
1683   573C ED A0       > ldi
1683   573E ED A0       > ldi
1683   5740 ED A0       > ldi
1683   5742 ED A0       > ldi
1683   5744 ED A0       > ldi
1683   5746 ED A0       > ldi
1683   5748 ED A0       > ldi
1683   574A ED A0       > ldi
1683   574C ED A0       > ldi
1683   574E ED A0       > ldi
1683   5750 ED A0       > ldi
1683   5752 ED A0       > ldi
1683   5754 ED A0       > ldi
1683   5756 ED A0       > ldi
1683   5758 ED A0       > ldi
1683   575A ED A0       > ldi
1683   575C ED A0       > ldi
1683   575E ED A0       > ldi
1683   5760 ED A0       > ldi
1683   5762 ED A0       > ldi
1683   5764 ED A0       > ldi
1683   5766 ED A0       > ldi
1683   5768 ED A0       > ldi
1683   576A ED A0       > ldi
1683   576C ED A0       > ldi
1683   576E ED A0       > ldi
1683   5770 ED A0       > ldi
1683   5772 ED A0       > ldi
1683   5774 ED A0       > ldi
1683   5776 ED A0       > ldi
1683   5778 ED A0       > ldi
1683   577A ED A0       > ldi
1683   577C ED A0       > ldi
1683   577E ED A0       > ldi
1683   5780 ED A0       > ldi
1683   5782 ED A0       > ldi
1683   5784 ED A0       > ldi
1683   5786 ED A0       > ldi
1683   5788 ED A0       > ldi
1683   578A ED A0       > ldi
1683   578C ED A0       > ldi
1683   578E ED A0       > ldi
1683   5790 ED A0       > ldi
1683   5792 ED A0       > ldi
1683   5794 ED A0       > ldi
1683   5796 ED A0       > ldi
1683   5798 ED A0       > ldi
1683   579A ED A0       > ldi
1683   579C ED A0       > ldi
1683   579E ED A0       > ldi
1683   57A0 ED A0       > ldi
1683   57A2 ED A0       > ldi
1683   57A4 ED A0       > ldi
1683   57A6 ED A0       > ldi
1683   57A8 ED A0       > ldi
1683   57AA ED A0       > ldi
1683   57AC ED A0       > ldi
1683   57AE ED A0       > ldi
1683   57B0 ED A0       > ldi
1683   57B2 ED A0       > ldi
1683   57B4 ED A0       > ldi
1683   57B6 ED A0       > ldi
1683   57B8 ED A0       > ldi
1683   57BA ED A0       > ldi
1683   57BC ED A0       > ldi
1683   57BE ED A0       > ldi
1683   57C0 ED A0       > ldi
1683   57C2 ED A0       > ldi
1683   57C4 ED A0       > ldi
1683   57C6 ED A0       > ldi
1683   57C8 ED A0       > ldi
1683   57CA ED A0       > ldi
1683   57CC ED A0       > ldi
1683   57CE ED A0       > ldi
1683   57D0 ED A0       > ldi
1683   57D2 ED A0       > ldi
1683   57D4 ED A0       > ldi
1683   57D6 ED A0       > ldi
1683   57D8 ED A0       > ldi
1683   57DA ED A0       > ldi
1683   57DC ED A0       > ldi
1683   57DE ED A0       > ldi
1683   57E0 ED A0       > ldi
1683   57E2 ED A0       > ldi
1683   57E4 ED A0       > ldi
1683   57E6 ED A0       > ldi
1683   57E8 ED A0       > ldi
1683   57EA ED A0       > ldi
1683   57EC ED A0       > ldi
1683   57EE ED A0       > ldi
1683   57F0 ED A0       > ldi
1683   57F2 ED A0       > ldi
1683   57F4 ED A0       > ldi
1683   57F6 ED A0       > ldi
1683   57F8 ED A0       > ldi
1683   57FA ED A0       > ldi
1683   57FC ED A0       > ldi
1683   57FE ED A0       > ldi
1683   5800 ED A0       > ldi
1683   5802 ED A0       > ldi
1683   5804 ED A0       > ldi
1683   5806 ED A0       > ldi
1683   5808 ED A0       > ldi
1683   580A ED A0       > ldi
1683   580C ED A0       > ldi
1683   580E ED A0       > ldi
1683   5810 ED A0       > ldi
1683   5812 ED A0       > ldi
1683   5814 ED A0       > ldi
1683   5816 ED A0       > ldi
1683   5818 ED A0       > ldi
1683   581A ED A0       > ldi
1683   581C ED A0       > ldi
1683   581E ED A0       > ldi
1683   5820 ED A0       > ldi
1683   5822 ED A0       > ldi
1683   5824 ED A0       > ldi
1683   5826 ED A0       > ldi
1683   5828 ED A0       > ldi
1683   582A ED A0       > ldi
1683   582C ED A0       > ldi
1683   582E ED A0       > ldi
1683   5830 ED A0       > ldi
1683   5832 ED A0       > ldi
1683   5834 ED A0       > ldi
1683   5836 ED A0       > ldi
1683   5838 ED A0       > ldi
1683   583A ED A0       > ldi
1683   583C ED A0       > ldi
1683   583E ED A0       > ldi
1683   5840 ED A0       > ldi
1683   5842 ED A0       > ldi
1683   5844 ED A0       > ldi
1683   5846 ED A0       > ldi
1683   5848 ED A0       > ldi
1683   584A ED A0       > ldi
1683   584C ED A0       > ldi
1683   584E ED A0       > ldi
1683   5850 ED A0       > ldi
1683   5852 ED A0       > ldi
1683   5854 ED A0       > ldi
1683   5856 ED A0       > ldi
1683   5858 ED A0       > ldi
1683   585A ED A0       > ldi
1683   585C ED A0       > ldi
1683   585E ED A0       > ldi
1683   5860 ED A0       > ldi
1683   5862 ED A0       > ldi
1683   5864 ED A0       > ldi
1683   5866 ED A0       > ldi
1683   5868 ED A0       > ldi
1683   586A ED A0       > ldi
1683   586C ED A0       > ldi
1683   586E ED A0       > ldi
1683   5870 ED A0       > ldi
1683   5872 ED A0       > ldi
1683   5874 ED A0       > ldi
1683   5876 ED A0       > ldi
1683   5878 ED A0       > ldi
1683   587A ED A0       > ldi
1683   587C ED A0       > ldi
1683   587E ED A0       > ldi
1683   5880 ED A0       > ldi
1683   5882 ED A0       > ldi
1683   5884 ED A0       > ldi
1683   5886 ED A0       > ldi
1683   5888 ED A0       > ldi
1683   588A ED A0       > ldi
1683   588C ED A0       > ldi
1683   588E ED A0       > ldi
1683   5890 ED A0       > ldi
1683   5892 ED A0       > ldi
1683   5894 ED A0       > ldi
1683   5896 ED A0       > ldi
1683   5898 ED A0       > ldi
1683   589A ED A0       > ldi
1683   589C ED A0       > ldi
1683   589E ED A0       > ldi
1683   58A0 ED A0       > ldi
1683   58A2 ED A0       > ldi
1683   58A4 ED A0       > ldi
1683   58A6 ED A0       > ldi
1683   58A8 ED A0       > ldi
1683   58AA ED A0       > ldi
1683   58AC ED A0       > ldi
1683   58AE ED A0       > ldi
1683   58B0 ED A0       > ldi
1683   58B2 ED A0       > ldi
1683   58B4 ED A0       > ldi
1683   58B6 ED A0       > ldi
1683   58B8 ED A0       > ldi
1683   58BA ED A0       > ldi
1683   58BC ED A0       > ldi
1683   58BE ED A0       > ldi
1683   58C0 ED A0       > ldi
1683   58C2 ED A0       > ldi
1683   58C4 ED A0       > ldi
1683   58C6 ED A0       > ldi
1683   58C8 ED A0       > ldi
1683   58CA ED A0       > ldi
1683   58CC ED A0       > ldi
1683   58CE ED A0       > ldi
1683   58D0 ED A0       > ldi
1683   58D2 ED A0       > ldi
1683   58D4 ED A0       > ldi
1683   58D6 ED A0       > ldi
1683   58D8 ED A0       > ldi
1683   58DA ED A0       > ldi
1683   58DC ED A0       > ldi
1683   58DE ED A0       > ldi
1683   58E0 ED A0       > ldi
1683   58E2 ED A0       > ldi
1683   58E4 ED A0       > ldi
1683   58E6 ED A0       > ldi
1683   58E8 ED A0       > ldi
1683   58EA ED A0       > ldi
1683   58EC ED A0       > ldi
1683   58EE ED A0       > ldi
1683   58F0 ED A0       > ldi
1683   58F2 ED A0       > ldi
1683   58F4 ED A0       > ldi
1683   58F6 ED A0       > ldi
1683   58F8 ED A0       > ldi
1683   58FA ED A0       > ldi
1683   58FC ED A0       > ldi
1683   58FE ED A0       > ldi
1683   5900 ED A0       > ldi
1683   5902 ED A0       > ldi
1683   5904 ED A0       > ldi
1683   5906 ED A0       > ldi
1683   5908 ED A0       > ldi
1683   590A ED A0       > ldi
1683   590C ED A0       > ldi
1683   590E ED A0       > ldi
1683   5910 ED A0       > ldi
1683   5912 ED A0       > ldi
1683   5914 ED A0       > ldi
1683   5916 ED A0       > ldi
1683   5918 ED A0       > ldi
1683   591A ED A0       > ldi
1683   591C ED A0       > ldi
1683   591E ED A0       > ldi
1683   5920 ED A0       > ldi
1683   5922 ED A0       > ldi
1683   5924 ED A0       > ldi
1683   5926 ED A0       > ldi
1683   5928 ED A0       > ldi
1683   592A ED A0       > ldi
1683   592C ED A0       > ldi
1683   592E ED A0       > ldi
1683   5930 ED A0       > ldi
1683   5932 ED A0       > ldi
1683   5934 ED A0       > ldi
1683   5936 ED A0       > ldi
1683   5938 ED A0       > ldi
1683   593A ED A0       > ldi
1683   593C ED A0       > ldi
1683   593E ED A0       > ldi
1683   5940 ED A0       > ldi
1683   5942 ED A0       > ldi
1683   5944 ED A0       > ldi
1683   5946 ED A0       > ldi
1683   5948 ED A0       > ldi
1683   594A ED A0       > ldi
1683   594C ED A0       > ldi
1683   594E ED A0       > ldi
1683   5950 ED A0       > ldi
1683   5952 ED A0       > ldi
1683   5954 ED A0       > ldi
1683   5956 ED A0       > ldi
1683   5958 ED A0       > ldi
1683   595A ED A0       > ldi
1683   595C ED A0       > ldi
1683   595E ED A0       > ldi
1683   5960 ED A0       > ldi
1683   5962 ED A0       > ldi
1683   5964 ED A0       > ldi
1683   5966 ED A0       > ldi
1683   5968 ED A0       > ldi
1683   596A ED A0       > ldi
1683   596C ED A0       > ldi
1683   596E ED A0       > ldi
1683   5970 ED A0       > ldi
1683   5972 ED A0       > ldi
1683   5974 ED A0       > ldi
1683   5976 ED A0       > ldi
1683   5978 ED A0       > ldi
1683   597A ED A0       > ldi
1683   597C ED A0       > ldi
1683   597E ED A0       > ldi
1683   5980 ED A0       > ldi
1683   5982 ED A0       > ldi
1683   5984 ED A0       > ldi
1683   5986 ED A0       > ldi
1683   5988 ED A0       > ldi
1683   598A ED A0       > ldi
1683   598C ED A0       > ldi
1683   598E ED A0       > ldi
1683   5990 ED A0       > ldi
1683   5992 ED A0       > ldi
1683   5994 ED A0       > ldi
1683   5996 ED A0       > ldi
1683   5998 ED A0       > ldi
1683   599A ED A0       > ldi
1683   599C ED A0       > ldi
1683   599E ED A0       > ldi
1683   59A0 ED A0       > ldi
1683   59A2 ED A0       > ldi
1683   59A4 ED A0       > ldi
1683   59A6 ED A0       > ldi
1683   59A8 ED A0       > ldi
1683   59AA ED A0       > ldi
1683   59AC ED A0       > ldi
1683   59AE ED A0       > ldi
1683   59B0 ED A0       > ldi
1683   59B2 ED A0       > ldi
1683   59B4 ED A0       > ldi
1683   59B6 ED A0       > ldi
1683   59B8 ED A0       > ldi
1683   59BA ED A0       > ldi
1683   59BC ED A0       > ldi
1683   59BE ED A0       > ldi
1683   59C0 ED A0       > ldi
1683   59C2 ED A0       > ldi
1683   59C4 ED A0       > ldi
1683   59C6 ED A0       > ldi
1683   59C8 ED A0       > ldi
1683   59CA ED A0       > ldi
1683   59CC ED A0       > ldi
1683   59CE ED A0       > ldi
1683   59D0 ED A0       > ldi
1683   59D2 ED A0       > ldi
1683   59D4 ED A0       > ldi
1683   59D6 ED A0       > ldi
1683   59D8 ED A0       > ldi
1683   59DA ED A0       > ldi
1683   59DC ED A0       > ldi
1683   59DE ED A0       > ldi
1683   59E0 ED A0       > ldi
1683   59E2 ED A0       > ldi
1683   59E4 ED A0       > ldi
1683   59E6 ED A0       > ldi
1683   59E8 ED A0       > ldi
1683   59EA ED A0       > ldi
1683   59EC ED A0       > ldi
1683   59EE ED A0       > ldi
1683   59F0 ED A0       > ldi
1683   59F2 ED A0       > ldi
1683   59F4 ED A0       > ldi
1683   59F6 ED A0       > ldi
1683   59F8 ED A0       > ldi
1683   59FA ED A0       > ldi
1683   59FC ED A0       > ldi
1683   59FE ED A0       > ldi
1683   5A00 ED A0       > ldi
1683   5A02 ED A0       > ldi
1683   5A04 ED A0       > ldi
1683   5A06 ED A0       > ldi
1683   5A08 ED A0       > ldi
1683   5A0A ED A0       > ldi
1683   5A0C ED A0       > ldi
1683   5A0E ED A0       > ldi
1683   5A10 ED A0       > ldi
1683   5A12 ED A0       > ldi
1683   5A14 ED A0       > ldi
1683   5A16 ED A0       > ldi
1683   5A18 ED A0       > ldi
1683   5A1A ED A0       > ldi
1683   5A1C ED A0       > ldi
1683   5A1E ED A0       > ldi
1683   5A20 ED A0       > ldi
1683   5A22 ED A0       > ldi
1683   5A24 ED A0       > ldi
1683   5A26 ED A0       > ldi
1683   5A28 ED A0       > ldi
1683   5A2A ED A0       > ldi
1684   5A2C EB          	ex	de,hl
1685   5A2D 00          	nop
1686   5A2E 3A 00 40    	ld	a, (PORTSPI)	; descarta CRC
1687   5A31 00          	nop
1688   5A32 3A 00 40    	ld	a, (PORTSPI)
1689   5A35 FD 7E 32    	ld	a, (iy+NUMBLOCOS)	; testar se tem mais blocos para ler
1690   5A38 3D          	dec	a
1691   5A39 FD 77 32    	ld	(iy+NUMBLOCOS), a
1692   5A3C C2 22 56    	jp	nz,.loop
1693   5A3F 3E 4C       	ld	a, CMD12	; acabou os blocos, mandar CMD12 para cancelar leitura
1694   5A41 CD C5 4C    	call	SD_SEND_CMD_NO_ARGS
1695   5A44 C3 64 5E    	jp		.fim
1696   5A47             
1697   5A47             .umBloco: 
1698   5A47 3E 51       	ld	a, CMD17	; ler somente um bloco com CMD17 = Read Single Block
1699   5A49 CD CA 4C    	call	SD_SEND_CMD_GET_ERROR
1700   5A4C 30 04       	jr	nc,.ok
1701   5A4E             .erro: 
1702   5A4E 37          	scf
1703   5A4F C3 03 56    	jp		terminaLeituraEscritaBloco
1704   5A52             .ok: 
1705   5A52 CD 28 4D    	call	WAIT_RESP_FE
1706   5A55 38 F7       	jr	c,.erro
1707   5A57 11 00 40    	ld	de, PORTSPI
1708   5A5A EB          	ex	de,hl
1709   5A5B ED A0       > ldi
1709   5A5D ED A0       > ldi
1709   5A5F ED A0       > ldi
1709   5A61 ED A0       > ldi
1709   5A63 ED A0       > ldi
1709   5A65 ED A0       > ldi
1709   5A67 ED A0       > ldi
1709   5A69 ED A0       > ldi
1709   5A6B ED A0       > ldi
1709   5A6D ED A0       > ldi
1709   5A6F ED A0       > ldi
1709   5A71 ED A0       > ldi
1709   5A73 ED A0       > ldi
1709   5A75 ED A0       > ldi
1709   5A77 ED A0       > ldi
1709   5A79 ED A0       > ldi
1709   5A7B ED A0       > ldi
1709   5A7D ED A0       > ldi
1709   5A7F ED A0       > ldi
1709   5A81 ED A0       > ldi
1709   5A83 ED A0       > ldi
1709   5A85 ED A0       > ldi
1709   5A87 ED A0       > ldi
1709   5A89 ED A0       > ldi
1709   5A8B ED A0       > ldi
1709   5A8D ED A0       > ldi
1709   5A8F ED A0       > ldi
1709   5A91 ED A0       > ldi
1709   5A93 ED A0       > ldi
1709   5A95 ED A0       > ldi
1709   5A97 ED A0       > ldi
1709   5A99 ED A0       > ldi
1709   5A9B ED A0       > ldi
1709   5A9D ED A0       > ldi
1709   5A9F ED A0       > ldi
1709   5AA1 ED A0       > ldi
1709   5AA3 ED A0       > ldi
1709   5AA5 ED A0       > ldi
1709   5AA7 ED A0       > ldi
1709   5AA9 ED A0       > ldi
1709   5AAB ED A0       > ldi
1709   5AAD ED A0       > ldi
1709   5AAF ED A0       > ldi
1709   5AB1 ED A0       > ldi
1709   5AB3 ED A0       > ldi
1709   5AB5 ED A0       > ldi
1709   5AB7 ED A0       > ldi
1709   5AB9 ED A0       > ldi
1709   5ABB ED A0       > ldi
1709   5ABD ED A0       > ldi
1709   5ABF ED A0       > ldi
1709   5AC1 ED A0       > ldi
1709   5AC3 ED A0       > ldi
1709   5AC5 ED A0       > ldi
1709   5AC7 ED A0       > ldi
1709   5AC9 ED A0       > ldi
1709   5ACB ED A0       > ldi
1709   5ACD ED A0       > ldi
1709   5ACF ED A0       > ldi
1709   5AD1 ED A0       > ldi
1709   5AD3 ED A0       > ldi
1709   5AD5 ED A0       > ldi
1709   5AD7 ED A0       > ldi
1709   5AD9 ED A0       > ldi
1709   5ADB ED A0       > ldi
1709   5ADD ED A0       > ldi
1709   5ADF ED A0       > ldi
1709   5AE1 ED A0       > ldi
1709   5AE3 ED A0       > ldi
1709   5AE5 ED A0       > ldi
1709   5AE7 ED A0       > ldi
1709   5AE9 ED A0       > ldi
1709   5AEB ED A0       > ldi
1709   5AED ED A0       > ldi
1709   5AEF ED A0       > ldi
1709   5AF1 ED A0       > ldi
1709   5AF3 ED A0       > ldi
1709   5AF5 ED A0       > ldi
1709   5AF7 ED A0       > ldi
1709   5AF9 ED A0       > ldi
1709   5AFB ED A0       > ldi
1709   5AFD ED A0       > ldi
1709   5AFF ED A0       > ldi
1709   5B01 ED A0       > ldi
1709   5B03 ED A0       > ldi
1709   5B05 ED A0       > ldi
1709   5B07 ED A0       > ldi
1709   5B09 ED A0       > ldi
1709   5B0B ED A0       > ldi
1709   5B0D ED A0       > ldi
1709   5B0F ED A0       > ldi
1709   5B11 ED A0       > ldi
1709   5B13 ED A0       > ldi
1709   5B15 ED A0       > ldi
1709   5B17 ED A0       > ldi
1709   5B19 ED A0       > ldi
1709   5B1B ED A0       > ldi
1709   5B1D ED A0       > ldi
1709   5B1F ED A0       > ldi
1709   5B21 ED A0       > ldi
1709   5B23 ED A0       > ldi
1709   5B25 ED A0       > ldi
1709   5B27 ED A0       > ldi
1709   5B29 ED A0       > ldi
1709   5B2B ED A0       > ldi
1709   5B2D ED A0       > ldi
1709   5B2F ED A0       > ldi
1709   5B31 ED A0       > ldi
1709   5B33 ED A0       > ldi
1709   5B35 ED A0       > ldi
1709   5B37 ED A0       > ldi
1709   5B39 ED A0       > ldi
1709   5B3B ED A0       > ldi
1709   5B3D ED A0       > ldi
1709   5B3F ED A0       > ldi
1709   5B41 ED A0       > ldi
1709   5B43 ED A0       > ldi
1709   5B45 ED A0       > ldi
1709   5B47 ED A0       > ldi
1709   5B49 ED A0       > ldi
1709   5B4B ED A0       > ldi
1709   5B4D ED A0       > ldi
1709   5B4F ED A0       > ldi
1709   5B51 ED A0       > ldi
1709   5B53 ED A0       > ldi
1709   5B55 ED A0       > ldi
1709   5B57 ED A0       > ldi
1709   5B59 ED A0       > ldi
1709   5B5B ED A0       > ldi
1709   5B5D ED A0       > ldi
1709   5B5F ED A0       > ldi
1709   5B61 ED A0       > ldi
1709   5B63 ED A0       > ldi
1709   5B65 ED A0       > ldi
1709   5B67 ED A0       > ldi
1709   5B69 ED A0       > ldi
1709   5B6B ED A0       > ldi
1709   5B6D ED A0       > ldi
1709   5B6F ED A0       > ldi
1709   5B71 ED A0       > ldi
1709   5B73 ED A0       > ldi
1709   5B75 ED A0       > ldi
1709   5B77 ED A0       > ldi
1709   5B79 ED A0       > ldi
1709   5B7B ED A0       > ldi
1709   5B7D ED A0       > ldi
1709   5B7F ED A0       > ldi
1709   5B81 ED A0       > ldi
1709   5B83 ED A0       > ldi
1709   5B85 ED A0       > ldi
1709   5B87 ED A0       > ldi
1709   5B89 ED A0       > ldi
1709   5B8B ED A0       > ldi
1709   5B8D ED A0       > ldi
1709   5B8F ED A0       > ldi
1709   5B91 ED A0       > ldi
1709   5B93 ED A0       > ldi
1709   5B95 ED A0       > ldi
1709   5B97 ED A0       > ldi
1709   5B99 ED A0       > ldi
1709   5B9B ED A0       > ldi
1709   5B9D ED A0       > ldi
1709   5B9F ED A0       > ldi
1709   5BA1 ED A0       > ldi
1709   5BA3 ED A0       > ldi
1709   5BA5 ED A0       > ldi
1709   5BA7 ED A0       > ldi
1709   5BA9 ED A0       > ldi
1709   5BAB ED A0       > ldi
1709   5BAD ED A0       > ldi
1709   5BAF ED A0       > ldi
1709   5BB1 ED A0       > ldi
1709   5BB3 ED A0       > ldi
1709   5BB5 ED A0       > ldi
1709   5BB7 ED A0       > ldi
1709   5BB9 ED A0       > ldi
1709   5BBB ED A0       > ldi
1709   5BBD ED A0       > ldi
1709   5BBF ED A0       > ldi
1709   5BC1 ED A0       > ldi
1709   5BC3 ED A0       > ldi
1709   5BC5 ED A0       > ldi
1709   5BC7 ED A0       > ldi
1709   5BC9 ED A0       > ldi
1709   5BCB ED A0       > ldi
1709   5BCD ED A0       > ldi
1709   5BCF ED A0       > ldi
1709   5BD1 ED A0       > ldi
1709   5BD3 ED A0       > ldi
1709   5BD5 ED A0       > ldi
1709   5BD7 ED A0       > ldi
1709   5BD9 ED A0       > ldi
1709   5BDB ED A0       > ldi
1709   5BDD ED A0       > ldi
1709   5BDF ED A0       > ldi
1709   5BE1 ED A0       > ldi
1709   5BE3 ED A0       > ldi
1709   5BE5 ED A0       > ldi
1709   5BE7 ED A0       > ldi
1709   5BE9 ED A0       > ldi
1709   5BEB ED A0       > ldi
1709   5BED ED A0       > ldi
1709   5BEF ED A0       > ldi
1709   5BF1 ED A0       > ldi
1709   5BF3 ED A0       > ldi
1709   5BF5 ED A0       > ldi
1709   5BF7 ED A0       > ldi
1709   5BF9 ED A0       > ldi
1709   5BFB ED A0       > ldi
1709   5BFD ED A0       > ldi
1709   5BFF ED A0       > ldi
1709   5C01 ED A0       > ldi
1709   5C03 ED A0       > ldi
1709   5C05 ED A0       > ldi
1709   5C07 ED A0       > ldi
1709   5C09 ED A0       > ldi
1709   5C0B ED A0       > ldi
1709   5C0D ED A0       > ldi
1709   5C0F ED A0       > ldi
1709   5C11 ED A0       > ldi
1709   5C13 ED A0       > ldi
1709   5C15 ED A0       > ldi
1709   5C17 ED A0       > ldi
1709   5C19 ED A0       > ldi
1709   5C1B ED A0       > ldi
1709   5C1D ED A0       > ldi
1709   5C1F ED A0       > ldi
1709   5C21 ED A0       > ldi
1709   5C23 ED A0       > ldi
1709   5C25 ED A0       > ldi
1709   5C27 ED A0       > ldi
1709   5C29 ED A0       > ldi
1709   5C2B ED A0       > ldi
1709   5C2D ED A0       > ldi
1709   5C2F ED A0       > ldi
1709   5C31 ED A0       > ldi
1709   5C33 ED A0       > ldi
1709   5C35 ED A0       > ldi
1709   5C37 ED A0       > ldi
1709   5C39 ED A0       > ldi
1709   5C3B ED A0       > ldi
1709   5C3D ED A0       > ldi
1709   5C3F ED A0       > ldi
1709   5C41 ED A0       > ldi
1709   5C43 ED A0       > ldi
1709   5C45 ED A0       > ldi
1709   5C47 ED A0       > ldi
1709   5C49 ED A0       > ldi
1709   5C4B ED A0       > ldi
1709   5C4D ED A0       > ldi
1709   5C4F ED A0       > ldi
1709   5C51 ED A0       > ldi
1709   5C53 ED A0       > ldi
1709   5C55 ED A0       > ldi
1709   5C57 ED A0       > ldi
1709   5C59 ED A0       > ldi
1709   5C5B ED A0       > ldi
1709   5C5D ED A0       > ldi
1709   5C5F ED A0       > ldi
1709   5C61 ED A0       > ldi
1709   5C63 ED A0       > ldi
1709   5C65 ED A0       > ldi
1709   5C67 ED A0       > ldi
1709   5C69 ED A0       > ldi
1709   5C6B ED A0       > ldi
1709   5C6D ED A0       > ldi
1709   5C6F ED A0       > ldi
1709   5C71 ED A0       > ldi
1709   5C73 ED A0       > ldi
1709   5C75 ED A0       > ldi
1709   5C77 ED A0       > ldi
1709   5C79 ED A0       > ldi
1709   5C7B ED A0       > ldi
1709   5C7D ED A0       > ldi
1709   5C7F ED A0       > ldi
1709   5C81 ED A0       > ldi
1709   5C83 ED A0       > ldi
1709   5C85 ED A0       > ldi
1709   5C87 ED A0       > ldi
1709   5C89 ED A0       > ldi
1709   5C8B ED A0       > ldi
1709   5C8D ED A0       > ldi
1709   5C8F ED A0       > ldi
1709   5C91 ED A0       > ldi
1709   5C93 ED A0       > ldi
1709   5C95 ED A0       > ldi
1709   5C97 ED A0       > ldi
1709   5C99 ED A0       > ldi
1709   5C9B ED A0       > ldi
1709   5C9D ED A0       > ldi
1709   5C9F ED A0       > ldi
1709   5CA1 ED A0       > ldi
1709   5CA3 ED A0       > ldi
1709   5CA5 ED A0       > ldi
1709   5CA7 ED A0       > ldi
1709   5CA9 ED A0       > ldi
1709   5CAB ED A0       > ldi
1709   5CAD ED A0       > ldi
1709   5CAF ED A0       > ldi
1709   5CB1 ED A0       > ldi
1709   5CB3 ED A0       > ldi
1709   5CB5 ED A0       > ldi
1709   5CB7 ED A0       > ldi
1709   5CB9 ED A0       > ldi
1709   5CBB ED A0       > ldi
1709   5CBD ED A0       > ldi
1709   5CBF ED A0       > ldi
1709   5CC1 ED A0       > ldi
1709   5CC3 ED A0       > ldi
1709   5CC5 ED A0       > ldi
1709   5CC7 ED A0       > ldi
1709   5CC9 ED A0       > ldi
1709   5CCB ED A0       > ldi
1709   5CCD ED A0       > ldi
1709   5CCF ED A0       > ldi
1709   5CD1 ED A0       > ldi
1709   5CD3 ED A0       > ldi
1709   5CD5 ED A0       > ldi
1709   5CD7 ED A0       > ldi
1709   5CD9 ED A0       > ldi
1709   5CDB ED A0       > ldi
1709   5CDD ED A0       > ldi
1709   5CDF ED A0       > ldi
1709   5CE1 ED A0       > ldi
1709   5CE3 ED A0       > ldi
1709   5CE5 ED A0       > ldi
1709   5CE7 ED A0       > ldi
1709   5CE9 ED A0       > ldi
1709   5CEB ED A0       > ldi
1709   5CED ED A0       > ldi
1709   5CEF ED A0       > ldi
1709   5CF1 ED A0       > ldi
1709   5CF3 ED A0       > ldi
1709   5CF5 ED A0       > ldi
1709   5CF7 ED A0       > ldi
1709   5CF9 ED A0       > ldi
1709   5CFB ED A0       > ldi
1709   5CFD ED A0       > ldi
1709   5CFF ED A0       > ldi
1709   5D01 ED A0       > ldi
1709   5D03 ED A0       > ldi
1709   5D05 ED A0       > ldi
1709   5D07 ED A0       > ldi
1709   5D09 ED A0       > ldi
1709   5D0B ED A0       > ldi
1709   5D0D ED A0       > ldi
1709   5D0F ED A0       > ldi
1709   5D11 ED A0       > ldi
1709   5D13 ED A0       > ldi
1709   5D15 ED A0       > ldi
1709   5D17 ED A0       > ldi
1709   5D19 ED A0       > ldi
1709   5D1B ED A0       > ldi
1709   5D1D ED A0       > ldi
1709   5D1F ED A0       > ldi
1709   5D21 ED A0       > ldi
1709   5D23 ED A0       > ldi
1709   5D25 ED A0       > ldi
1709   5D27 ED A0       > ldi
1709   5D29 ED A0       > ldi
1709   5D2B ED A0       > ldi
1709   5D2D ED A0       > ldi
1709   5D2F ED A0       > ldi
1709   5D31 ED A0       > ldi
1709   5D33 ED A0       > ldi
1709   5D35 ED A0       > ldi
1709   5D37 ED A0       > ldi
1709   5D39 ED A0       > ldi
1709   5D3B ED A0       > ldi
1709   5D3D ED A0       > ldi
1709   5D3F ED A0       > ldi
1709   5D41 ED A0       > ldi
1709   5D43 ED A0       > ldi
1709   5D45 ED A0       > ldi
1709   5D47 ED A0       > ldi
1709   5D49 ED A0       > ldi
1709   5D4B ED A0       > ldi
1709   5D4D ED A0       > ldi
1709   5D4F ED A0       > ldi
1709   5D51 ED A0       > ldi
1709   5D53 ED A0       > ldi
1709   5D55 ED A0       > ldi
1709   5D57 ED A0       > ldi
1709   5D59 ED A0       > ldi
1709   5D5B ED A0       > ldi
1709   5D5D ED A0       > ldi
1709   5D5F ED A0       > ldi
1709   5D61 ED A0       > ldi
1709   5D63 ED A0       > ldi
1709   5D65 ED A0       > ldi
1709   5D67 ED A0       > ldi
1709   5D69 ED A0       > ldi
1709   5D6B ED A0       > ldi
1709   5D6D ED A0       > ldi
1709   5D6F ED A0       > ldi
1709   5D71 ED A0       > ldi
1709   5D73 ED A0       > ldi
1709   5D75 ED A0       > ldi
1709   5D77 ED A0       > ldi
1709   5D79 ED A0       > ldi
1709   5D7B ED A0       > ldi
1709   5D7D ED A0       > ldi
1709   5D7F ED A0       > ldi
1709   5D81 ED A0       > ldi
1709   5D83 ED A0       > ldi
1709   5D85 ED A0       > ldi
1709   5D87 ED A0       > ldi
1709   5D89 ED A0       > ldi
1709   5D8B ED A0       > ldi
1709   5D8D ED A0       > ldi
1709   5D8F ED A0       > ldi
1709   5D91 ED A0       > ldi
1709   5D93 ED A0       > ldi
1709   5D95 ED A0       > ldi
1709   5D97 ED A0       > ldi
1709   5D99 ED A0       > ldi
1709   5D9B ED A0       > ldi
1709   5D9D ED A0       > ldi
1709   5D9F ED A0       > ldi
1709   5DA1 ED A0       > ldi
1709   5DA3 ED A0       > ldi
1709   5DA5 ED A0       > ldi
1709   5DA7 ED A0       > ldi
1709   5DA9 ED A0       > ldi
1709   5DAB ED A0       > ldi
1709   5DAD ED A0       > ldi
1709   5DAF ED A0       > ldi
1709   5DB1 ED A0       > ldi
1709   5DB3 ED A0       > ldi
1709   5DB5 ED A0       > ldi
1709   5DB7 ED A0       > ldi
1709   5DB9 ED A0       > ldi
1709   5DBB ED A0       > ldi
1709   5DBD ED A0       > ldi
1709   5DBF ED A0       > ldi
1709   5DC1 ED A0       > ldi
1709   5DC3 ED A0       > ldi
1709   5DC5 ED A0       > ldi
1709   5DC7 ED A0       > ldi
1709   5DC9 ED A0       > ldi
1709   5DCB ED A0       > ldi
1709   5DCD ED A0       > ldi
1709   5DCF ED A0       > ldi
1709   5DD1 ED A0       > ldi
1709   5DD3 ED A0       > ldi
1709   5DD5 ED A0       > ldi
1709   5DD7 ED A0       > ldi
1709   5DD9 ED A0       > ldi
1709   5DDB ED A0       > ldi
1709   5DDD ED A0       > ldi
1709   5DDF ED A0       > ldi
1709   5DE1 ED A0       > ldi
1709   5DE3 ED A0       > ldi
1709   5DE5 ED A0       > ldi
1709   5DE7 ED A0       > ldi
1709   5DE9 ED A0       > ldi
1709   5DEB ED A0       > ldi
1709   5DED ED A0       > ldi
1709   5DEF ED A0       > ldi
1709   5DF1 ED A0       > ldi
1709   5DF3 ED A0       > ldi
1709   5DF5 ED A0       > ldi
1709   5DF7 ED A0       > ldi
1709   5DF9 ED A0       > ldi
1709   5DFB ED A0       > ldi
1709   5DFD ED A0       > ldi
1709   5DFF ED A0       > ldi
1709   5E01 ED A0       > ldi
1709   5E03 ED A0       > ldi
1709   5E05 ED A0       > ldi
1709   5E07 ED A0       > ldi
1709   5E09 ED A0       > ldi
1709   5E0B ED A0       > ldi
1709   5E0D ED A0       > ldi
1709   5E0F ED A0       > ldi
1709   5E11 ED A0       > ldi
1709   5E13 ED A0       > ldi
1709   5E15 ED A0       > ldi
1709   5E17 ED A0       > ldi
1709   5E19 ED A0       > ldi
1709   5E1B ED A0       > ldi
1709   5E1D ED A0       > ldi
1709   5E1F ED A0       > ldi
1709   5E21 ED A0       > ldi
1709   5E23 ED A0       > ldi
1709   5E25 ED A0       > ldi
1709   5E27 ED A0       > ldi
1709   5E29 ED A0       > ldi
1709   5E2B ED A0       > ldi
1709   5E2D ED A0       > ldi
1709   5E2F ED A0       > ldi
1709   5E31 ED A0       > ldi
1709   5E33 ED A0       > ldi
1709   5E35 ED A0       > ldi
1709   5E37 ED A0       > ldi
1709   5E39 ED A0       > ldi
1709   5E3B ED A0       > ldi
1709   5E3D ED A0       > ldi
1709   5E3F ED A0       > ldi
1709   5E41 ED A0       > ldi
1709   5E43 ED A0       > ldi
1709   5E45 ED A0       > ldi
1709   5E47 ED A0       > ldi
1709   5E49 ED A0       > ldi
1709   5E4B ED A0       > ldi
1709   5E4D ED A0       > ldi
1709   5E4F ED A0       > ldi
1709   5E51 ED A0       > ldi
1709   5E53 ED A0       > ldi
1709   5E55 ED A0       > ldi
1709   5E57 ED A0       > ldi
1709   5E59 ED A0       > ldi
1710   5E5B EB          	ex	de,hl
1711   5E5C 00          	nop
1712   5E5D 3A 00 40    	ld	a, (PORTSPI)	; descarta CRC
1713   5E60 00          	nop
1714   5E61 3A 00 40    	ld	a, (PORTSPI)
1715   5E64             .fim: 
1716   5E64 AF          	xor	a		; zera carry para informar leitura sem erros
1717   5E65 C3 03 56    	jp		terminaLeituraEscritaBloco
1718   5E68             
1719   5E68             ; ------------------------------------------------
1720   5E68             ; Converte blocos para bytes. Na pratica faz
1721   5E68             ; BC DE = (BC DE) * 512
1722   5E68             ; ------------------------------------------------
1723   5E68             blocoParaByte: 
1724   5E68 41          	ld	b, c
1725   5E69 4A          	ld	c, d
1726   5E6A 53          	ld	d, e
1727   5E6B 1E 00       	ld	e, 0
1728   5E6D CB 22       	sla	d
1729   5E6F CB 11       	rl	c
1730   5E71 CB 10       	rl	b
1731   5E73 C9          	ret
1732   5E74             
1733   5E74             ; ------------------------------------------------
1734   5E74             ; Funcoes utilitarias
1735   5E74             ; ------------------------------------------------
1736   5E74             
1737   5E74             ; ------------------------------------------------
1738   5E74             ; Chaveia para modo SPI
1739   5E74             ; ------------------------------------------------
1740   5E74             modoSPI: 
1741   5E74 F5          	push	af
1742   5E75 3E 01       	ld	a, 1
1743   5E77 32 01 60    	ld	(CHAVEIASPI), a
1744   5E7A F1          	pop	af
1745   5E7B C9          	ret
1746   5E7C             
1747   5E7C             ; ------------------------------------------------
1748   5E7C             ; Chaveia para modo ROM
1749   5E7C             ; ------------------------------------------------
1750   5E7C             modoROM: 
1751   5E7C F5          	push	af
1752   5E7D 3E 00       	ld	a, 0
1753   5E7F 32 01 60    	ld	(CHAVEIASPI), a
1754   5E82 F1          	pop	af
1755   5E83 C9          	ret
1756   5E84             
1757   5E84             ; ------------------------------------------------
1758   5E84             ; Imprime string na tela apontada por DE
1759   5E84             ; Destroi todos os registradores
1760   5E84             ; ------------------------------------------------
1761   5E84             printString: 
1762   5E84 1A          	ld	a, (de)
1763   5E85 B7          	or	a
1764   5E86 C8          	ret	z
1765   5E87 CD A2 00    	call	CHPUT
1766   5E8A 13          	inc	de
1767   5E8B 18 F7       	jr	printString
1768   5E8D             
1769   5E8D             
1770   5E8D             ; ------------------------------------------------
1771   5E8D             ; Converte o byte em A para string em decimal no
1772   5E8D             ; buffer apontado por DE
1773   5E8D             ; Destroi AF, BC, HL, DE
1774   5E8D             ; ------------------------------------------------
1775   5E8D             DecToAscii: 
1776   5E8D 26 00       	ld	h, 0
1777   5E8F 6F          	ld	l, a		; copiar A para HL
1778   5E90 FD 36 34 01 	ld	(iy+TEMP), 1	; flag para indicar que devemos cortar os zeros a esquerda
1779   5E94 01 9C FF    	ld	bc, -100	; centenas
1780   5E97 CD A5 5E    	call	.num1
1781   5E9A 0E F6       	ld	c, -10		; dezenas
1782   5E9C CD A5 5E    	call	.num1
1783   5E9F FD 36 34 02 	ld	(iy+TEMP), 2	; unidade deve exibir 0 se for zero e nao corta-lo
1784   5EA3 0E FF       	ld	c, -1		; unidades
1785   5EA5             .num1: 
1786   5EA5 3E 2F       	ld	a, '0'-1
1787   5EA7             .num2: 
1788   5EA7 3C          	inc	a		; contar o valor em ascii de '0' a '9'
1789   5EA8 09          	add	hl, bc		; somar com negativo
1790   5EA9 38 FC       	jr	c,.num2		; ainda nao zeramos
1791   5EAB ED 42       	sbc	hl, bc		; retoma valor original
1792   5EAD FD 35 34    	dec	(iy+TEMP)	; se flag do corte do zero indicar para nao cortar, pula
1793   5EB0 20 08       	jr	nz,.naozero
1794   5EB2 FE 30       	cp	'0'		; devemos cortar os zeros a esquerda. Eh zero?
1795   5EB4 20 04       	jr	nz,.naozero
1796   5EB6 FD 34 34    	inc	(iy+TEMP)	; se for zero, nao salvamos e voltamos a flag
1797   5EB9 C9          	ret
1798   5EBA             .naozero: 
1799   5EBA 12          	ld	(de), a		; eh zero ou eh outro numero, salvar
1800   5EBB 13          	inc	de		; incrementa ponteiro de destino
1801   5EBC C9          	ret
1802   5EBD             
1803   5EBD             ; ------------------------------------------------
1804   5EBD             ; Converte o byte em A para string em hexa no
1805   5EBD             ; buffer apontado por DE
1806   5EBD             ; Destroi AF, C, DE
1807   5EBD             ; ------------------------------------------------
1808   5EBD             HexToAscii: 
1809   5EBD 4F          	ld	c, a
1810   5EBE 1F          	rra
1811   5EBF 1F          	rra
1812   5EC0 1F          	rra
1813   5EC1 1F          	rra
1814   5EC2 CD C6 5E    	call	.conv
1815   5EC5 79          	ld  	a, c
1816   5EC6             .conv: 
1817   5EC6 E6 0F       	and	$0F
1818   5EC8 C6 90       	add	a, $90
1819   5ECA 27          	daa
1820   5ECB CE 40       	adc	a, $40
1821   5ECD 27          	daa
1822   5ECE 12          	ld	(de), a
1823   5ECF 13          	inc	de
1824   5ED0 C9          	ret
1825   5ED1             
1826   5ED1             ; ------------------------------------------------
1827   5ED1             ; Converte o byte em A para string em decimal e
1828   5ED1             ; imprime na tela
1829   5ED1             ; Destroi AF, BC, HL, DE
1830   5ED1             ; ------------------------------------------------
1831   5ED1             printDecToAscii: 
1832   5ED1 26 00       	ld	h, 0
1833   5ED3 6F          	ld	l, a		; copiar A para HL
1834   5ED4 06 01       	ld	b, 1		; flag para indicar que devemos cortar os zeros a esquerda
1835   5ED6 11 9C FF    	ld	de, -100	; centenas
1836   5ED9 CD E5 5E    	call	.num1
1837   5EDC 1E F6       	ld	e, -10		; dezenas
1838   5EDE CD E5 5E    	call	.num1
1839   5EE1 06 02       	ld	b, 2		; unidade deve exibir 0 se for zero e nao corta-lo
1840   5EE3 1E FF       	ld	e, -1		; unidades
1841   5EE5             .num1: 
1842   5EE5 3E 2F       	ld	a, '0'-1
1843   5EE7             .num2: 
1844   5EE7 3C          	inc	a		; contar o valor em ascii de '0' a '9'
1845   5EE8 19          	add	hl, de		; somar com negativo
1846   5EE9 38 FC       	jr	c,.num2		; ainda nao zeramos
1847   5EEB ED 52       	sbc	hl, de		; retoma valor original
1848   5EED 10 06       	djnz	.naozero	; se flag do corte do zero indicar para nao cortar, pula
1849   5EEF FE 30       	cp	'0'		; devemos cortar os zeros a esquerda. Eh zero?
1850   5EF1 20 02       	jr	nz,.naozero
1851   5EF3 04          	inc	b		; se for zero, nao imprimimos e voltamos a flag
1852   5EF4 C9          	ret
1853   5EF5             .naozero: 
1854   5EF5 E5          	push	hl		; nao eh zero ou eh outro numero, imprimir
1855   5EF6 C5          	push	bc
1856   5EF7 CD A2 00    	call	CHPUT
1857   5EFA C1          	pop	bc
1858   5EFB E1          	pop	hl
1859   5EFC C9          	ret
1860   5EFD             
1861   5EFD             ; ------------------------------------------------
1862   5EFD             ; Procura pelo nome do fabricante em uma tabela.
1863   5EFD             ; A contem o byte do fabricante
1864   5EFD             ; Devolve HL apontando para o buffer do fabricante
1865   5EFD             ; e BC com o comprimento do texto
1866   5EFD             ; Destroi AF, BC, HL
1867   5EFD             ; ------------------------------------------------
1868   5EFD             pegaFabricante: 
1869   5EFD 4F          	ld	c, a
1870   5EFE 21 1F 5F    	ld	hl, tblFabricantes
1871   5F01             
1872   5F01             .loop: 
1873   5F01 7E          	ld	a, (hl)
1874   5F02 23          	inc	hl
1875   5F03 B9          	cp	c
1876   5F04 28 0C       	jr	z,.achado
1877   5F06 B7          	or	a
1878   5F07 28 09       	jr	z,.achado
1879   5F09 C5          	push	bc
1880   5F0A CD 12 5F    	call	.achado
1881   5F0D 09          	add	hl, bc
1882   5F0E 23          	inc	hl
1883   5F0F C1          	pop	bc
1884   5F10 18 EF       	jr	.loop
1885   5F12             
1886   5F12             .achado: 
1887   5F12 0E 00       	ld	c, 0
1888   5F14 E5          	push	hl
1889   5F15 AF          	xor	a
1890   5F16             .loop2: 
1891   5F16 0C          	inc	c
1892   5F17 23          	inc	hl
1893   5F18 BE          	cp	(hl)
1894   5F19 20 FB       	jr	nz,.loop2
1895   5F1B E1          	pop	hl
1896   5F1C 06 00       	ld	b, 0
1897   5F1E C9          	ret
1898   5F1F             
1899   5F1F             ; ---------------------------------------------------------------------------
1900   5F1F             tblFabricantes: 
1901   5F1F 01          	db	1
1902   5F20             	db	"Panasonic",0
1902   5F20 50616E61736F6E696300
1903   5F2A 02          	db	2
1904   5F2B             	db	"Toshiba",0
1904   5F2B 546F736869626100
1905   5F33 03          	db	3
1906   5F34             	db	"SanDisk",0
1906   5F34 53616E4469736B00
1907   5F3C 04          	db	4
1908   5F3D             	db	"SMI-S",0
1908   5F3D 534D492D5300
1909   5F43 06          	db	6
1910   5F44             	db	"Renesas",0
1910   5F44 52656E6573617300
1911   5F4C 11          	db	17
1912   5F4D             	db	"Dane-Elec",0
1912   5F4D 44616E652D456C656300
1913   5F57 13          	db	19
1914   5F58             	db	"KingMax",0
1914   5F58 4B696E674D617800
1915   5F60 15          	db	21
1916   5F61             	db	"Samsung",0
1916   5F61 53616D73756E6700
1917   5F69 18          	db	24
1918   5F6A             	db	"Infineon",0
1918   5F6A 496E66696E656F6E00
1919   5F73 1A          	db	26
1920   5F74 50 51 49 00 	db	"PQI",0
1921   5F78 1B          	db	27
1922   5F79 536F6E7900  	db	"Sony",0
1923   5F7E 1C          	db	28
1924   5F7F             	db	"Transcend",0
1924   5F7F 5472616E7363656E6400
1925   5F89 1D          	db	29
1926   5F8A             	db	"A-DATA",0
1926   5F8A 412D4441544100
1927   5F91 1F          	db	31
1928   5F92             	db	"SiliconPower",0
1928   5F92 53696C69636F6E506F77657200
1929   5F9F 27          	db	39
1930   5FA0             	db	"Verbatim",0
1930   5FA0 566572626174696D00
1931   5FA9 41          	db	65
1932   5FAA 4F 4B 49 00 	db	"OKI",0
1933   5FAE 73          	db	115
1934   5FAF             	db	"SilverHT",0
1934   5FAF 53696C766572485400
1935   5FB8 89          	db	137
1936   5FB9             	db	"L.Data",0
1936   5FB9 4C2E4461746100
1937   5FC0 00          	db	0
1938   5FC1             	db	"Generico",0
1938   5FC1 47656E657269636F00
1939   5FCA             
1940   5FCA             ; ------------------------------------------------
1941   5FCA             strTitle: 
1942   5FCA             	db	"FBLabs SDHC driver "
1942   5FCA 46424C61627320534448432064726976657220
1943   5FDD             	db	"v",VER_MAIN+$30,'.',VER_SEC+$30,'.',VER_REV+$30
1943   5FDD 76312E302E35
1944   5FE3 0D 0A 00    	db	13,10,0
1945   5FE6             
1946   5FE6             strBootpaused: 
1947   5FE6             	db	"Paused. Press <i> to show the copyright info.",13,10,0
1947   5FE6 5061757365642E205072657373203C693E20746F2073686F772074686520636F
1947   6006 7079726967687420696E666F2E0D0A00
1948   6016             
1949   6016             strCopyright: 
1950   6016             	db	"Copyright (c) 2014 Fabio Belavenuto",13,10
1950   6016 436F7079726967687420286329203230313420466162696F2042656C6176656E
1950   6036 75746F0D0A
1951   603B             	db	"Licenced under CERN OHL v1.1",13,10
1951   603B 4C6963656E63656420756E646572204345524E204F484C2076312E310D0A
1952   6059             	db	"http://ohwr.org/cernohl",13,10
1952   6059 687474703A2F2F6F6877722E6F72672F6365726E6F686C0D0A
1953   6072             	db	"PCB designed by Luciano Sturaro",13,10
1953   6072 5043422064657369676E6564206279204C756369616E6F205374757261726F0D
1953   6092 0A
1954   6093             	; fall throw
1955   6093             strCrLf: 
1956   6093 0D 0A 00    	db	13,10,0
1957   6096             strCartao: 
1958   6096             	db	"Slot ",0
1958   6096 536C6F742000
1959   609C             strVazio: 
1960   609C             	db	"Empty",13,10,0
1960   609C 456D7074790D0A00
1961   60A4             strNaoIdentificado: 
1962   60A4             	db	"Unknown!",13,10,0
1962   60A4 556E6B6E6F776E210D0A00
1963   60AF             			;----------------------------------------
1964   60AF             strMr_mp_desativada: 
1965   60AF             	db	"Slot expander/Mapper/MegaRAM disabled",13,10,0
1965   60AF 536C6F7420657870616E6465722F4D61707065722F4D65676152414D20646973
1965   60CF 61626C65640D0A00
1966   60D7             strMapper: 
1967   60D7             	db	"Slot expanded and Memory Mapper enabled",13,10,0
1967   60D7 536C6F7420657870616E64656420616E64204D656D6F7279204D617070657220
1967   60F7 656E61626C65640D0A00
1968   6101             strMegaram: 
1969   6101             	db	"Slot expander and MegaRAM enabled",13,10,0
1969   6101 536C6F7420657870616E64657220616E64204D65676152414D20656E61626C65
1969   6121 640D0A00
1970   6125             strSDV1: 
1971   6125             	db	"SDV1 - ",0
1971   6125 53445631202D2000
1972   612D             strSDV2: 
1973   612D             	db	"SDV2 - ",0
1973   612D 53445632202D2000
1974   6135             
1975   6135             ;-----------------------------------------------------------------------------
1976   6135             ;
1977   6135             ; End of the driver code
1978   6135             
1979   6135             DRV_END: 
1980   6135             
1981   6135 FF          	ds	3ED0h-(DRV_END-DRV_START), $FF
1982   7FD0             
1983   7FD0             
